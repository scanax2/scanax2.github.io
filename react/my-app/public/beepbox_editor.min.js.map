{"version":3,"sources":["../../../jummbox-main/synth/SynthConfig.ts","../../../jummbox-main/editor/EditorConfig.ts","../../../jummbox-main/node_modules/imperative-html/src/elements-base.ts","../../../jummbox-main/node_modules/imperative-html/src/elements-strict.ts","../../../jummbox-main/editor/ColorConfig.ts","../../../jummbox-main/editor/style.ts","../../../jummbox-main/editor/BarScrollBar.ts","../../../jummbox-main/synth/FFT.ts","../../../jummbox-main/synth/Deque.ts","../../../jummbox-main/synth/filtering.ts","../../../jummbox-main/synth/synth.ts","../../../jummbox-main/editor/Change.ts","../../../jummbox-main/editor/changes.ts","../../../jummbox-main/editor/BeatsPerBarPrompt.ts","../../../jummbox-main/editor/ChannelSettingsPrompt.ts","../../../jummbox-main/editor/CustomChipPrompt.ts","../../../jummbox-main/editor/FilterEditor.ts","../../../jummbox-main/editor/CustomFilterPrompt.ts","../../../jummbox-main/editor/ArrayBufferWriter.ts","../../../jummbox-main/editor/Midi.ts","../../../jummbox-main/editor/ExportPrompt.ts","../../../jummbox-main/editor/Layout.ts","../../../jummbox-main/editor/HarmonicsEditor.ts","../../../jummbox-main/editor/HTMLWrapper.ts","../../../jummbox-main/editor/ArrayBufferReader.ts","../../../jummbox-main/editor/ImportPrompt.ts","../../../jummbox-main/editor/LayoutPrompt.ts","../../../jummbox-main/editor/EnvelopeEditor.ts","../../../jummbox-main/editor/FadeInOutEditor.ts","../../../jummbox-main/editor/LimiterPrompt.ts","../../../jummbox-main/editor/LoopEditor.ts","../../../jummbox-main/editor/MoveNotesSidewaysPrompt.ts","../../../jummbox-main/editor/MuteEditor.ts","../../../jummbox-main/editor/OctaveScrollBar.ts","../../../jummbox-main/editor/MidiInput.ts","../../../jummbox-main/editor/KeyboardLayout.ts","../../../jummbox-main/editor/PatternEditor.ts","../../../jummbox-main/editor/Piano.ts","../../../jummbox-main/editor/SongDurationPrompt.ts","../../../jummbox-main/editor/SongRecovery.ts","../../../jummbox-main/editor/SongRecoveryPrompt.ts","../../../jummbox-main/editor/RecordingSetupPrompt.ts","../../../jummbox-main/editor/SpectrumEditor.ts","../../../jummbox-main/editor/ThemePrompt.ts","../../../jummbox-main/editor/TipPrompt.ts","../../../jummbox-main/editor/TrackEditor.ts","../../../jummbox-main/editor/SongEditor.ts","../../../jummbox-main/editor/SongPerformance.ts","../../../jummbox-main/editor/Selection.ts","../../../jummbox-main/editor/Preferences.ts","../../../jummbox-main/editor/ChangeNotifier.ts","../../../jummbox-main/editor/SongDocument.ts","../../../jummbox-main/editor/main.ts"],"names":["Config","centerWave","wave","sum","i","length","average","performIntegral","push","Float32Array","centerAndNormalizeWave","magn","Math","abs","magnAvg","cumulative","newWave","getDrumWave","index","inverseRealFourierTransform","scaleElementsByFactor","chipNoises","samples","chipNoiseLength","drumBuffer","newBuffer","random","drawNoiseSpectrum","sqrt","Error","waveLength","lowOctave","highOctave","lowPower","highPower","overallSlope","lowIndex","pow","highIndex","min","retroWave","combinedAmplitude","lerped","log2","amplitude","radians","PI","cos","sin","generateSquareWave","phaseWidth","sineWaveLength","centerPoint","generateSawWave","inverse","getArpeggioPitchIndex","pitchCount","useFastTwoNoteArp","arpeggio","arpeggioPattern","arpeggioPatterns","toNameMap","array","dictionary","value","name","result","effectsIncludeTransition","effects","effectsIncludeChord","effectsIncludePitchShift","effectsIncludeDetune","effectsIncludeVibrato","effectsIncludeNoteFilter","effectsIncludeDistortion","effectsIncludeBitcrusher","effectsIncludePanning","effectsIncludeChorus","effectsIncludeEcho","effectsIncludeReverb","thresholdVal","kneeVal","ratioVal","attackVal","releaseVal","scales","realName","flags","keys","isWhiteKey","basePitch","blackKeyNameParents","tempoMin","tempoMax","echoDelayRange","echoDelayStepTicks","echoSustainRange","echoShelfHz","echoShelfGain","reverbShelfHz","reverbShelfGain","reverbRange","reverbDelayBufferSize","reverbDelayBufferMask","beatsPerBarMin","beatsPerBarMax","barCountMin","barCountMax","instrumentCountMin","layeredInstrumentCountMax","patternInstrumentCountMax","partsPerBeat","ticksPerPart","ticksPerArpeggio","rhythms","stepsPerBeat","roundUpThresholds","instrumentTypeNames","instrumentTypeHasSpecialInterval","chipBaseExpression","fmBaseExpression","noiseBaseExpression","spectrumBaseExpression","drumsetBaseExpression","harmonicsBaseExpression","pwmBaseExpression","pickedStringBaseExpression","distortionBaseVolume","bitcrusherBaseVolume","rawChipWaves","expression","chipWaves","raw","newArray","Array","Object","assign","key","rawChipToIntegrated","pitchFilterMult","isSoft","filterFreqStep","filterFreqRange","filterFreqReferenceSetting","filterFreqReferenceHz","filterFreqMaxHz","filterFreqMinHz","filterGainRange","filterGainCenter","filterGainStep","filterMaxPoints","filterTypeNames","filterMorphCount","filterSimpleCutRange","filterSimplePeakRange","fadeInRange","fadeOutTicks","fadeOutNeutral","drumsetFadeOutTicks","transitions","isSeamless","continues","slides","slideTicks","includeAdjacentPatterns","vibratos","type","delayTicks","vibratoTypes","periodsSeconds","period","arpSpeedScale","unisons","voices","spread","offset","sign","effectNames","effectOrder","noteSizeMax","volumeRange","volumeLogScale","panCenter","panMax","panDelaySecondsMax","chorusRange","chorusPeriodSeconds","chorusDelayRange","chorusDelayOffsets","chorusPhaseOffsets","chorusMaxDelay","concat","reduce","x","y","max","chords","customInterval","arpeggiates","strumParts","singleTone","maxChordSize","operatorCount","maxPitchOrOperatorCount","algorithms","carrierCount","associatedCarrier","modulatedBy","operatorCarrierInterval","operatorAmplitudeMax","operatorFrequencies","mult","hzOffset","amplitudeSign","envelopes","speed","feedbacks","indices","spectrumNoiseLength","spectrumBasePitch","spectrumControlPoints","spectrumControlPointsPerOctave","spectrumControlPointBits","spectrumMax","harmonicsControlPoints","harmonicsRendered","harmonicsRenderedForPickedString","harmonicsControlPointBits","harmonicsMax","harmonicsWavelength","pulseWidthRange","pulseWidthStepPower","pitchChannelCountMin","pitchChannelCountMax","noiseChannelCountMin","noiseChannelCountMax","modChannelCountMin","modChannelCountMax","noiseInterval","pitchesPerOctave","drumCount","pitchOctaves","modCount","maxPitch","maximumTonesPerChannel","justIntonationSemitones","map","pitchShiftRange","pitchShiftCenter","detuneCenter","detuneMax","detuneMin","songDetuneMin","songDetuneMax","sineWaveMask","sineWave","generateSineWave","pickedStringDispersionCenterFreq","pickedStringDispersionFreqScale","pickedStringDispersionFreqMult","pickedStringShelfHz","distortionRange","stringSustainRange","stringDecayRate","bitcrusherFreqRange","bitcrusherOctaveStep","bitcrusherQuantizationRange","maxEnvelopeCount","defaultAutomationRange","instrumentAutomationTargets","computeIndex","displayName","interleave","isFilter","maxCount","effect","compatibleInstruments","operatorWaves","asin","generateTriWave","drive","generateTrapezoidWave","pwmOperatorWaves","barEditorHeight","modulators","pianoName","maxRawVol","newNoteVol","forSong","convertRealFactor","associatedEffect","promptName","promptDesc","ceil","round","isMobile","test","navigator","userAgent","prettyNumber","toFixed","replace","EditorConfig","[object Object]","presetValue","categoryIndex","presetIndex","presetCategories","presets","program","category","preset","generalMidi","midiProgram","presetName","version","versionDisplayName","releaseNotesURL","isOnMac","platform","ctrlSymbol","ctrlName","customType","settings","eqFilter","transition","fadeInSeconds","chord","unison","cutoffHz","linearGain","vibrato","isNoise","filterCutoffHz","filterResonance","filterEnvelope","algorithm","feedbackType","feedbackAmplitude","operators","frequency","target","envelope","customChipWave","noteFilter","reverb","harmonics","stringSustain","feedbackEnvelope","midiSubharmonicOctaves","interval","bitcrusherOctave","bitcrusherQuantization","distortion","pulseWidth","chorus","spectrum","pulseEnvelope","drums","pitchShiftSemitones","applyElementArgs","element","args","args_1","__values","args_1_1","next","done","arg","Node","appendChild","document","createTextNode","isArray","Symbol","iterator","__spread","constructor","Element","_d","e_2","_e","setAttribute","join","console","warn","tagName","_f","e_3","_g","styleKey","style","setProperty","removeAttribute","svgNS","HTML","_i","arguments","createRange","createContextualFragment","SVG","fragment","createDocumentFragment","svgParser","DOMParser","parseFromString","documentElement","firstChild","importNode","name_1","createElement","_c","split","name_2","createElementNS","snakeCaseName","ColorConfig","this","colorLookup","clear","song","channel","getComputedStyle","_styleElement","getPropertyValue","trim","base","getChannelColor","regex","secondaryChannel","getComputed","exec","primaryChannel","secondaryNote","primaryNote","pitchChannelCount","pitchChannels","noiseChannelCount","noiseChannels","modChannels","has","get","pitchSecondaryChannelHue","pitchSecondaryChannelHueScale","pitchSecondaryChannelSat","pitchSecondaryChannelSatScale","pitchSecondaryChannelLum","pitchSecondaryChannelLumScale","pitchPrimaryChannelHue","pitchPrimaryChannelHueScale","pitchPrimaryChannelSat","pitchPrimaryChannelSatScale","pitchPrimaryChannelLum","pitchPrimaryChannelLumScale","pitchSecondaryNoteHue","pitchSecondaryNoteHueScale","pitchSecondaryNoteSat","pitchSecondaryNoteSatScale","pitchSecondaryNoteLum","pitchSecondaryNoteLumScale","pitchPrimaryNoteHue","pitchPrimaryNoteHueScale","pitchPrimaryNoteSat","pitchPrimaryNoteSatScale","pitchPrimaryNoteLum","pitchPrimaryNoteLumScale","newChannelColors","floor","set","noiseSecondaryChannelHue","noiseSecondaryChannelHueScale","noiseSecondaryChannelSat","noiseSecondaryChannelSatScale","noiseSecondaryChannelLum","noiseSecondaryChannelLumScale","noisePrimaryChannelHue","noisePrimaryChannelHueScale","noisePrimaryChannelSat","noisePrimaryChannelSatScale","noisePrimaryChannelLum","noisePrimaryChannelLumScale","noiseSecondaryNoteHue","noiseSecondaryNoteHueScale","noiseSecondaryNoteSat","noiseSecondaryNoteSatScale","noiseSecondaryNoteLum","noiseSecondaryNoteLumScale","noisePrimaryNoteHue","noisePrimaryNoteHueScale","noisePrimaryNoteSat","noisePrimaryNoteSatScale","noisePrimaryNoteLum","noisePrimaryNoteLumScale","modSecondaryChannelHue","modSecondaryChannelHueScale","modSecondaryChannelSat","modSecondaryChannelSatScale","modSecondaryChannelLum","modSecondaryChannelLumScale","modPrimaryChannelHue","modPrimaryChannelHueScale","modPrimaryChannelSat","modPrimaryChannelSatScale","modPrimaryChannelLum","modPrimaryChannelLumScale","modSecondaryNoteHue","modSecondaryNoteHueScale","modSecondaryNoteSat","modSecondaryNoteSatScale","modSecondaryNoteLum","modSecondaryNoteLumScale","modPrimaryNoteHue","modPrimaryNoteHueScale","modPrimaryNoteSat","modPrimaryNoteSatScale","modPrimaryNoteLum","modPrimaryNoteLumScale","theme","themes","undefined","textContent","themeColor","querySelector","resetColors","Map","dark classic","dark competition","light classic","jummbox classic","forest","canyon","midnight","jummbox light","beachcombing","roe","moonlight","autumn","fruit","sunset","toxic","violet verdant","portal","fusion","nebula","roe light","energized","neapolitan","mono","pageMargin","editorBackground","hoverPreview","playhead","primaryText","secondaryText","invertedText","textSelection","boxSelectionFill","loopAccent","linkAccent","uiWidgetBackground","uiWidgetFocus","pitchBackground","tonic","fifthNote","whitePianoKey","blackPianoKey","useColorFormula","trackEditorBgPitch","trackEditorBgPitchDim","trackEditorBgNoise","trackEditorBgNoiseDim","trackEditorBgMod","trackEditorBgModDim","multiplicativeModSlider","overwritingModSlider","indicatorPrimary","indicatorSecondary","select2OptGroup","inputBoxOutline","muteButtonNormal","muteButtonMod","modLabelPrimary","modLabelSecondaryText","modLabelPrimaryText","disabledNotePrimary","disabledNoteSecondary","head","scrollBarTest","body","div","clientWidth","classList","add","removeChild","BarScrollBar","_doc","_trackContainer","_editorWidth","_editorHeight","_playhead","rect","fill","width","height","_notches","svg","pointer-events","_handle","_handleHighlight","stroke","stroke-width","_leftHighlight","path","_rightHighlight","_renderedPlayhead","_svg","container","class","_mouseX","_mouseDown","_mouseOver","_dragging","_renderedNotchCount","_renderedScrollBarPos","animatePlayhead","_notchSpace","synth","_onScroll","event","barScrollPos","scrollLeft","getBarWidth","_whenMouseOver","_updatePreview","_whenMouseOut","_whenMousePressed","preventDefault","boundingRect","getBoundingClientRect","clientX","pageX","left","trackVisibleBars","_dragStart","_whenTouchPressed","touches","_whenMouseMoved","_whenCursorMoved","_whenTouchMoved","_whenCursorReleased","notifier","changed","barCount","center","addEventListener","capture","passive","showleftHighlight","showRightHighlight","showHandleHighlight","visibility","resized","lineHeight","channelScrollPos","getChannelCount","trackVisibleChannels","String","scrollTop","getChannelHeight","factor","countBits","n","isPowerOf2","log","fullArrayLength","totalPasses","pass","subStride","midSubStride","stride","radiansIncrement","cosIncrement","sinIncrement","oscillatorMultiplier","startIndex","startIndexA","midIndexA","startIndexB","midIndexB","stopIndex","realStartA","imagStartB","c","s","cPrev","sPrev","indexA0","indexA1","indexB0","indexB1","real0","real1","imag0","imag1","tempA","tempB","cTemp","sTemp","index1","index2","index3","imag2","imag3","bitCount","finalShift","j","temp","reverseIndexBits","Deque","_capacity","_buffer","_mask","_offset","_count","_expandCapacity","popFront","popBack","oldBuffer","size","FilterCoefficients","a","b","order","cornerRadiansPerSample","g","tan","a0","shelfLinearGain","sqrtGain","delay","peakLinearGain","alpha","feedback","bandWidthScale","bandWidth","FrequencyResponse","real","imag","denom","filter","radiansPerSample","analyzeComplex","realZ1","imagZ1","realNum","imagNum","realDenom","imagDenom","realZ","imagZ","imagTemp","atan2","DynamicBiquadFilter","a1","a2","b0","b1","b2","a1Delta","a2Delta","b0Delta","b1Delta","b2Delta","output1","output2","useMultiplicativeInputCoefficients","start","end","deltaRate","epsilon","clamp","val","validateRange","base64IntToCharCode","base64CharCodeToInt","BitFieldReader","source","_bits","_readIndex","charCodeAt","minValue","minBits","numBits","readLongTail","read","BitFieldWriter","_index","writeLongTail","write","other","buffer","makeNotePin","time","Note","pitch","fadeout","pitches","pins","continuesLastPattern","longestFlatIntervalDuration","mainInterval","pinIndex","pinA","pinB","duration","loudestSize","pin","newNote","part","endPinIndex","Pattern","notes","instruments","note","clone","isModChannel","noteArray","instrument","mod","volumeCap","getVolumeCapForSetting","modFilterTypes","pointArray","useVol","tick","rhythm","pitchBend","volume","forMod","noteObject","points","patternObject","patternInstruments","importedPartsPerBeat","isNoiseChannel","instrumentCount","getMaxInstrumentsPerPatternForChannel","maxNoteCount","beatsPerBar","k","indexOf","startInterval","pointObject","lowestPitch","highestPitch","splice","Operator","waveform","reset","SpectrumWave","hash","isHarmonic","markCustomWaveDirty","hashMult","Synth","fittingPowerOfTwo","point","SpectrumWaveState","_hash","lowestOctave","pitchTweak","controlPointToOctave","value1","value2","octave1","octave2","HarmonicsWave","HarmonicsWaveState","instrumentType","_generatedForType","combinedControlPointAmplitude","harmonicIndex","harmonicFreq","controlValue","normalizedValue","performIntegralOld","FilterControlPoint","freq","gain","freqSetting","gainSetting","getHzFromSettingValue","hz","getSettingValueFromHz","peakMult","power","neutral","interpolatedPower","sampleRate","freqMult","getHz","getLinearGain","lowPass2ndOrderButterworth","highPass2ndOrderButterworth","peak2ndOrder","octave","gainPow","freqRelativeTo8khz","warpedFreq","warpedOctave","distanceFromCenter","freqLoudness","FilterSettings","controlPoints","controlPointCount","controlPoint","filterArray","filterObject","getRoundedSettingValueFromHz","getRoundedSettingValueFromLinearGain","filterA","filterB","pos","lerpedFilter","filtersCanMorph","legacyCutoffSetting","legacyResonanceSetting","legacyEnv","legacyFilterMaxRadians","legacyFilterMax","resonant","firstOrder","cutoffAtMax","legacyFilterCutoffRange","envDecays","standardSampleRate","legacyHz","legacyRadians","extraOctaves","targetRadians","curvedHz","finalHz","finalRadians","legacyFilter","lowPass1stOrderSimplified","response","analyze","legacyFilterGainAtNewRadians","magnitude","logGain","convertedGain","addPoint","intendedGain","invertedGain","curvedRadians","legacyFilterGain","lowPass2ndOrderSimplified","allowFirstOrder","EnvelopeSettings","envelopeObject","Instrument","chipWave","chipNoise","eqFilterType","eqFilterSimpleCut","eqFilterSimplePeak","noteFilterType","noteFilterSimpleCut","noteFilterSimplePeak","eqSubFilters","noteSubFilters","fadeIn","fadeOut","envelopeCount","pitchShift","detune","vibratoDepth","vibratoSpeed","vibratoDelay","vibratoType","pan","panDelay","arpeggioSpeed","fastTwoNoteArp","legacyTieOver","clicklessTransition","aliases","bitcrusherFreq","echoSustain","echoDelay","LFOtime","nextLFOtime","arpTime","customChipWaveIntegral","harmonicsWave","drumsetEnvelopes","drumsetSpectrumWaves","modInstruments","invalidModulators","spectrumWave","wavePrev","legacySettings","forceSimpleFilter","filterCutoff","legacyFilterEnv","legacyPulseEnv","legacyOperatorEnvelopes","operatorEnvelopes","legacyFeedbackEnv","noCarriersControlledByNoteSize","allCarriersControlledByNoteSize","noteSizeControlsSomethingElse","addEnvelope","convertLegacySettings","instrumentObject","toJsonObject","eqSimpleCut","eqSimplePeak","getChord","detuneToCents","fadeInSettingToSeconds","fadeOutSettingToTicks","getDrumsetEnvelope","operatorArray","operator","Float64Array","useSlowerRhythm","legacyGlobalReverb","setTypeAndReset","legacyEffectsNames","transitionProperty","binary","seamless","sudden","hard","smooth","soft","slide","cross fade","hard fade","medium fade","soft fade","secondsToFadeInSetting","ticksToFadeOutSetting","chordProperty","legacyChordNames","harmony","unisonProperty","legacyChorusNames","union","fifths","octaves","centsToDetune","vibratoProperty","legacyVibratoNames","vibrato light","vibrato delayed","vibrato heavy","isNaN","findIndex","legacyEnvelopeNames","custom","steady","pluck 1","pluck 2","pluck 3","getEnvelope","drum","legacyWaveNames","triangle","square","pulse wide","pulse narrow","sawtooth","double saw","double pulse","spiky","plateau","operatorObject","fromJsonObject","filterCutoffMaxHz","filterCutoffRange","filterResonanceRange","LN2","legacyToCutoff","legacyToEnvelope","filterNames","oldFilterNames","sustain sharp","sustain medium","sustain soft","decay sharp","envelopeArray","tempEnvelope","makeEmpty","supportsEnvelopeTarget","envelopeSettings","automationTarget","useControlPointCount","envelopeIndex","Channel","patterns","bars","muted","Song","string","channels","limitDecay","limitRise","compressionThreshold","limitThreshold","compressionRatio","limitRatio","masterGain","inVolumeCap","outVolumeCap","getNewNoteVolume","isMod","modChannel","modInstrument","vol","tempoIndex","tempo","getVolumeCap","modulator","cap","modSetting","filterType","fromBase64String","initToDefault","modChannelCount","layeredInstruments","channelIndex","andResetChannels","scale","loopStart","loopLength","patternsPerChannel","title","pattern","bar","bits","_variant","_latestJummBoxVersion","encodedSongTitle","encodeURIComponent","encodedChannelName","usingSubFilterBitfield","harmonicsBits","encodeBase64","o","spectrumBits","neededBits","shapeBits","bitsPerNoteSize","getNeededBits","maxInstrumentsPerPattern","getMaxInstrumentsPerPattern","getChannelIsNoise","getChannelIsMod","neededInstrumentCountBits","neededInstrumentIndexBits","neededModInstrumentIndexBits","getMaxInstrumentsPerChannel","instrumentIndex","modFilter","status","octaveOffset","lastPitch","recentPitches","recentShapes","curPart","writePartDuration","writePinCount","shapePart","startPitch","currentPitch","pitchBends","nextPitch","shapeString","fromCharCode","apply","shapeIndex","unshift","pop","allPitches","pitchIndex","pitchIter","writePitchInterval","stringLength","lengthBase64","digits","prototype","maxApplyArgs","slice","legacyIndex","compressed","charIndex","JSON","parse","substring","fromBeepBox","fromJummBox","_latestBeepboxVersion","_oldestBeepboxVersion","_oldestJummBoxVersion","beforeTwo","beforeThree","beforeFour","beforeFive","beforeSix","beforeSeven","beforeEight","beforeNine","legacySettingsCache","command","instrumentChannelIterator","instrumentIndexIterator","useSlowerArpSpeed","songNameLength","decodeURIComponent","channelCount","instrumentsPerChannel","instrumentsFlagBits","legacyWaves","typeCheck","originalControlPointCount","originalSubfilterControlPointCount","_envelopeFromLegacyIndex","legacyEffects","legacyEnvelopes","originalValue","nextValue","restoreLimiterDefaults","channelNameLength","byteCount","subStringLength","bitStringLength","largerChords","recentPitchBitLength","recentPitchLength","bitStringLengthLength","songReverbChannel","songReverbInstrument","songReverbIndex","forNoteFilter","detuneScaleNotes","newPattern","newNotes","noteCount","useOldShape","shape","pinCount","readPinCount","initialSize","bendCount","pinObj","readLegacyPartDuration","readPartDuration","readPitchInterval","intervalIter","shift","isBackwards","restLength","patternIndex","lowestPart","chn","enableIntro","loopCount","enableOutro","channelArray","instrumentArray","patternArray","sequenceArray","l","channelObject","sequence","format","_format","introBars","loopBars","ticksPerBeat","beatsPerMinute","jsonObject","oldScaleNames","romani :)","romani :(","enigma","scaleName","letter","charAt","toUpperCase","symbol","toLowerCase","C","D","E","F","G","A","B","#","♯","♭","maxInstruments","maxPatterns","maxBars","newPitchChannels","newNoiseChannels","newModChannels","instrumentObjects","maxValue","clz32","PickedString","delayLine","allPassG","allPassGDelta","shelfA1","shelfA1Delta","shelfB0","shelfB0Delta","shelfB1","shelfB1Delta","delayIndex","allPassSample","allPassPrevInput","shelfSample","shelfPrevInput","fractionalDelaySample","prevDelayLength","delayResetOffset","instrumentState","tone","stringIndex","roundedSamplesPerTick","stringDecayStart","stringDecayEnd","allPassCenter","samplesPerSecond","shelfRadians","decayCurveStart","decayCurveEnd","phaseDeltaStart","phaseDeltas","phaseDeltaScale","phaseDeltaScales","phaseDeltaEnd","radiansPerSampleStart","radiansPerSampleEnd","centerHarmonicStart","centerHarmonicEnd","allPassRadiansStart","allPassRadiansEnd","decayRateStart","decayRateEnd","shelfGainStart","shelfGainEnd","expressionDecayStart","expressionDecayEnd","tempFilterStartCoefficients","allPass1stOrderInvertPhaseAbove","tempFrequencyResponse","allPassGStart","allPassPhaseDelayStart","angle","tempFilterEndCoefficients","allPassGEnd","allPassPhaseDelayEnd","highShelf1stOrder","shelfA1Start","shelfB0Start","shelfB1Start","shelfPhaseDelayStart","shelfA1End","shelfB0End","shelfB1End","shelfPhaseDelayEnd","periodLengthStart","periodLengthEnd","minBufferLength","delayLength","delayLengthEnd","delayLengthDelta","pitchChanged","reinitializeImpulse","likelyMaximumLength","frequencyFromPitch","newDelayLine","oldDelayBufferMask","startCopyingFromIndex","delayBufferMask","startImpulseFrom","startZerosFrom","stopZerosAt","impulseWave","impulseWaveLength","impulsePhaseDelta","fadeDuration","startImpulseFromSample","stopImpulseAt","stopImpulseAtSample","impulsePhase","prevWaveIntegral","impulsePhaseInt","nextWaveIntegral","phaseRatio","sample","combinedFade","curvedFade","EnvelopeComputer","noteSecondsStart","noteSecondsEnd","noteTicksStart","noteTicksEnd","noteSizeStart","noteSizeEnd","prevNoteSize","nextNoteSize","_noteSizeFinal","prevNoteSecondsStart","prevNoteSecondsEnd","prevNoteTicksStart","prevNoteTicksEnd","_prevNoteSizeFinal","prevSlideStart","prevSlideEnd","nextSlideStart","nextSlideEnd","prevSlideRatioStart","prevSlideRatioEnd","nextSlideRatioStart","nextSlideRatioEnd","envelopeStarts","envelopeEnds","_modifiedEnvelopeIndices","_modifiedEnvelopeCount","lowpassCutoffDecayVolumeCompensation","currentPart","tickTimeStart","secondsPerTick","getTransition","atNoteStart","forceContinueAtStart","tickTimeEnd","beatsPerTick","beatTimeStart","beatTimeEnd","passedEndOfNote","getEndPinIndex","startPin","endPin","startPinTick","endPinTick","ratioStart","ratioEnd","noteStartTick","noteStartPart","noteEndTick","noteEndPart","maximumSlideTicks","prevNote","nextNote","forceContinueAtEnd","usedNoteSize","targetIndex","envelopeStart","computeEnvelope","envelopeEnd","filterSettings","tmpNoteFilterStart","getLowpassCutoffDecayVolumeCompensation","beats","noteSize","noteSizeToVolumeMult","attack","Tone","chordSize","drumsetPitch","prevNotePitchIndex","nextNotePitchIndex","freshlyAllocated","isOnLastTick","ticksSinceReleased","liveInputSamplesHeld","lastInterval","noiseSample","stringSustainStart","stringSustainEnd","phases","expressionDelta","operatorExpressions","operatorExpressionDeltas","prevPitchExpressions","prevVibrato","prevStringDecay","pulseWidthDelta","pickedStrings","noteFilters","noteFilterCount","initialNoteFilterInput1","initialNoteFilterInput2","specialIntervalExpressionMult","feedbackOutputs","feedbackMult","feedbackDelta","stereoVolumeLStart","stereoVolumeRStart","stereoVolumeLDelta","stereoVolumeRDelta","stereoDelayStart","stereoDelayEnd","stereoDelayDelta","customVolumeStart","customVolumeEnd","filterResonanceStart","filterResonanceDelta","isFirstOrder","envelopeComputer","resetOutput","pickedString","InstrumentState","awake","computed","tonesAddedInThisTick","flushingDelayLines","deactivateAfterThisTick","attentuationProgress","flushedSamples","activeTones","activeModTones","releasedTones","liveInputTones","synthesizer","noisePitchFilterMult","volumeScale","eqFilterVolume","eqFilterVolumeDelta","mixVolume","mixVolumeDelta","delayInputMult","delayInputMultDelta","distortionDelta","distortionDrive","distortionDriveDelta","distortionFractionalInput1","distortionFractionalInput2","distortionFractionalInput3","distortionPrevInput","distortionNextOutput","bitcrusherPrevInput","bitcrusherCurrentOutput","bitcrusherPhase","bitcrusherPhaseDelta","bitcrusherPhaseDeltaScale","bitcrusherScale","bitcrusherScaleScale","bitcrusherFoldLevel","bitcrusherFoldLevelScale","eqFilters","eqFilterCount","initialEqFilterInput1","initialEqFilterInput2","panningDelayLine","panningDelayPos","panningVolumeL","panningVolumeR","panningVolumeDeltaL","panningVolumeDeltaR","panningOffsetL","panningOffsetR","panningOffsetDeltaL","panningOffsetDeltaR","chorusDelayLineL","chorusDelayLineR","chorusDelayLineDirty","chorusDelayPos","chorusPhase","chorusVoiceMult","chorusVoiceMultDelta","chorusCombinedMult","chorusCombinedMultDelta","echoDelayLineL","echoDelayLineR","echoDelayLineDirty","echoDelayPos","echoDelayOffsetStart","echoDelayOffsetEnd","echoDelayOffsetRatio","echoDelayOffsetRatioDelta","echoMult","echoMultDelta","echoShelfA1","echoShelfB0","echoShelfB1","echoShelfSampleL","echoShelfSampleR","echoShelfPrevInputL","echoShelfPrevInputR","reverbDelayLine","reverbDelayLineDirty","reverbDelayPos","reverbMult","reverbMultDelta","reverbShelfA1","reverbShelfB0","reverbShelfB1","reverbShelfSample0","reverbShelfSample1","reverbShelfSample2","reverbShelfSample3","reverbShelfPrevInput0","reverbShelfPrevInput1","reverbShelfPrevInput2","reverbShelfPrevInput3","samplesPerTick","panningDelayBufferSize","chorusDelayBufferSize","safeEchoDelaySteps","safeEchoDelayBufferSize","newDelayLineL","newDelayLineR","oldMask","deactivate","getInstrumentSynthFunction","allocateNecessaryBuffers","updateWaves","usesDistortion","usesBitcrusher","usesPanning","usesChorus","usesEcho","usesReverb","useDistortionStart","useDistortionEnd","isModActive","getModValue","distortionSliderStart","distortionSliderEnd","distortionStart","distortionEnd","distortionDriveStart","distortionDriveEnd","freqSettingStart","freqSettingEnd","quantizationSettingStart","quantizationSettingEnd","freqStart","freqEnd","scaleStart","scaleEnd","foldLevelStart","foldLevelEnd","eqFilterSettingsStart","eqFilterSettingsEnd","startPoint","startSimpleFreq","startSimpleGain","endSimpleFreq","endSimpleGain","filterChanges","convertLegacySettingsForSynth","endPoint","toCoefficients","loadCoefficientsWithGradient","getVolumeCompensationMult","eqFilterSettings","tmpEqFilterStart","tmpEqFilterEnd","mainInstrumentVolume","instrumentVolumeToVolumeMult","mixVolumeEnd","startVal","endVal","eqFilterVolumeStart","eqFilterVolumeEnd","delayInputMultStart","delayInputMultEnd","usePanStart","usePanEnd","panStart","panEnd","volumeStartL","volumeStartR","volumeEndL","volumeEndR","maxDelaySamples","usePanDelayStart","usePanDelayEnd","delayStart","delayEnd","delayStartL","delayStartR","delayEndL","delayEndR","useChorusStart","useChorusEnd","chorusStart","chorusEnd","chorusCombinedMultStart","chorusCombinedMultEnd","maxEchoMult","averageEchoDelaySeconds","useEchoSustainStart","useEchoSustainEnd","echoMultStart","echoMultEnd","useEchoDelayStart","useEchoDelayEnd","ignoreTicks","tmpEchoDelayOffsetStart","tmpEchoDelayOffsetEnd","maxReverbMult","useReverbStart","useReverbEnd","reverbStart","reverbEnd","totalDelaySamples","attenuationThreshold","halfLifeMult","delayDuration","attenuationPerSecond","averageMult","averageReverbDelaySeconds","progressInTick","progressAtEndOfTick","getCustomWave","_drumsetIndexToSpectrumOctave","drumsetIndexReferenceDelta","ChannelState","singleSeamlessInstrument","preferLowerLatency","anticipatePoorPerformance","liveInputDuration","liveInputStarted","liveInputPitches","liveInputChannel","liveInputInstruments","loopRepeatCount","enableMetronome","countInMetronome","renderingSong","wantToSkip","playheadInternal","prevBar","nextBar","beat","isAtStartOfTick","isAtEndOfTick","tickSampleCountdown","modValues","modInsValues","nextModValues","nextModInsValues","isPlayingSong","isRecording","liveInputEndTime","browserAutomaticallyClearsAudioBuffer","tempDrumSetControlPoint","tonePool","tempMatchedPitchTones","startedMetronome","metronomeSamplesRemaining","metronomeAmplitude","metronomePrevAmplitude","metronomeFilter","limit","tempMonoInstrumentSampleBuffer","audioCtx","scriptNode","audioProcessCallback","audioProcessingEvent","outputBuffer","outputDataL","getChannelData","outputDataR","tmp_splitted","window","location","href","deactivateAudio","performance","now","synthesize","computeDelayBufferSizes","setSong","channelState","resetAllEffects","syncSongState","getSamplesPerTick","tmpNoteFilterEnd","dummyArray","latestModTimes","latestModInsTimes","currentBar","getPattern","instrumentIdx","latestPinParts","latestPinValues","partsInBar","findPartsInBar","pinIdx","transitionLength","toNextBarLength","deltaVolume","setModValue","usedInstruments","tgtPattern","eqFilterParam","noteFilterParam","modulatorAdjust","tgtInstrument","tgtInstrumentList","str","playing","recording","remainder","loop","startBar","endBar","hasTempoMods","hasNextBarMods","prevTempo","latestTempoPin","latestTempoValue","ended","totalSamples","foundMod","find","sort","getSamplesPerTickSpecificBPM","tickLength","prevPinTempo","currPinTempo","bpmScalar","getSamplesPerBar","getTotalBars","useLoopCount","panningDelayBufferMask","chorusDelayBufferMask","bufferSize","latencyHint","AudioContext","webkitAudioContext","createScriptProcessor","createJavaScriptNode","onaudioprocess","channelCountMode","channelInterpretation","connect","destination","resume","disconnect","close","activateAudio","computeLatestModValues","warmUpSynthesizer","play","freeAllTones","volumeStart","volumeEnd","setting","nextVal","channelIdx","resetEffects","snapToBar","oldBar","outputBufferLength","playSong","getNextBar","pause","skippedBars","firstSkippedBufferIndex","bufferIndex","samplesLeftInBuffer","samplesLeftInTick","runLength","runEnd","determineCurrentActiveTones","count","playModTone","barVisited","includes","skipBar","determineLiveInputTones","tonesPlayedInThisInstrument","getFadeOutTicks","freeReleasedTone","shouldFadeOutFast","computeTone","compute","playTone","effectsSynth","startRatio","endRatio","ticksIntoBar","partTimeTickStart","partTimeTickEnd","partTimeStart","partTimeEnd","useVibratoSpeed","midBeat","periods","samplesPerPeriod","tempAmplitude","sampleL","sampleR","absL","absR","limitRange","limitTarget","limitedVolume","useArpeggioSpeed","Number","isInteger","isFinite","pushBack","pushFront","toneIndex","freeTone","remove","toneList","toneCount","newTone","releaseTone","moveTonesIntoOrderedTempMatchedList","clearTempMatchedPitchTones","otherPattern","otherNote","forceContinue","otherInstrument","otherTransition","firstNote","secondNote","firstNoteInterval","notePitches","getCurrentPart","currentTick","prevNotes","nextNotes","fillCount","modToneCount","newInstrumentIndex","sourceInstrumentState","destInstrumentState","prevNoteForThisInstrument","nextNoteForThisInstrument","oldTone","partsPerBar","tonesInPrevNote","tonesInNextNote","prevPattern","lastNote","patternForcesContinueAtStart","adjacentNotesHaveMatchingPitches","chordOfCompatibleInstrument","adjacentPatternHasCompatibleInstrumentTransition","nextPattern","nextPatternForcesContinueAtStart","strumOffsetParts","prevNoteForThisTone","noteForThisTone","nextNoteForThisTone","clearEnvelopes","released","getTicksIntoBar","modSynth","chordExpression","computeChordExpression","intervalScale","secondsPerPart","sampleTime","beatsPerPart","specialIntervalMult","toneIsOnLastTick","intervalStart","intervalEnd","fadeExpressionStart","fadeExpressionEnd","chordExpressionStart","chordExpressionEnd","expressionReferencePitch","baseExpression","pitchDamping","getOperatorWave","startTicksSinceReleased","endTicksSinceReleased","pinStart","pinEnd","noteTicksPassedTickStart","noteTicksPassedTickEnd","pinRatioStart","pinRatioEnd","noteLengthTicks","tmpNoteFilter","noteFilterSettingsStart","noteFilterSettingsEnd","computeEnvelopes","intervalDiff","chordSizeDiff","pitchShiftScalarStart","pitchShiftScalarEnd","modDetuneStart","modDetuneEnd","vibratoAmplitudeStart","vibratoAmplitudeEnd","vibratoStart","POSITIVE_INFINITY","getLFOAmplitude","ticksUntilVibratoStart","lfoEnd","vibratoDepthEnvelopeEnd","vibratoEnd","ticksUntilVibratoEnd","getFadeInSeconds","pickMainInterval","noteFilterExpression","noteAllFreqsEnvelopeStart","noteAllFreqsEnvelopeEnd","noteFreqEnvelopeStart","noteFreqEnvelopeEnd","notePeakEnvelopeStart","notePeakEnvelopeEnd","noteFilterSettings","drumsetFilterEnvelope","drumsetFilterEnvelopeStart","drumsetFilterEnvelopeEnd","sineExpressionBoost","totalCarrierExpression","arpeggioInterval","associatedCarrierIndex","pitchStart","pitchEnd","baseFreqStart","baseFreqEnd","targetFreqStart","targetFreqEnd","freqEnvelopeStart","freqEnvelopeEnd","amplitudeStart","amplitudeEnd","amplitudeCurveStart","operatorAmplitudeCurve","amplitudeCurveEnd","expressionStart","expressionEnd","pitchExpressionStart","pitchExpressionEnd","useFeedbackAmplitudeStart","useFeedbackAmplitudeEnd","feedbackAmplitudeStart","feedbackAmplitudeEnd","feedbackStart","feedbackEnd","basePhaseDeltaScale","intervalOffset","endPitch","settingsExpressionMult","basePulseWidth","pulseWidthModStart","pulseWidthModEnd","pulseWidthStart","pulseWidthEnd","useSustainStart","useSustainEnd","startFreq","voiceCountExpression","unisonEnvelopeStart","unisonEnvelopeEnd","unisonAStart","unisonAEnd","unisonBStart","unisonBEnd","sustainEnvelopeStart","sustainEnvelopeEnd","update","secondsIntoBar","vibratoPeriodSeconds","fingerprint","fmSynthFunctionCache","synthSource","line","fmSourceTemplate","outputs","operatorLine","operatorSourceTemplate","modulatorNumber","feedbackIndices","Function","chipSynth","harmonicsSynth","pulseWidthSynth","pickedStringSynth","noiseSynth","spectrumSynth","drumsetSynth","data","unisonSign","phaseDeltaA","phaseDeltaB","phaseDeltaScaleA","phaseDeltaScaleB","phaseA","phaseB","filters","filterCount","initialFilterInput1","initialFilterInput2","applyFilters","prevWaveIntegralA","prevWaveIntegralB","phaseAInt","phaseBInt","indexA","indexB","phaseRatioA","phaseRatioB","sampleIndex","waveA","waveB","inputSample","nextWaveIntegralA","nextWaveIntegralB","output","sanitizeFilters","voiceCount","pickedStringFunction","pickedStringFunctionCache","pickedStringSource","sampleList","voice","lines","usesEqFilter","signature","effectsFunction","effectsFunctionCache","effectsSource","usesDelays","phaseDelta","phase","sawPhaseA","sawPhaseB","pulseWave","t","phaseMask","pitchRelativefilter","findRandomZeroCrossing","phaseInt","waveSample","getDrumsetWave","referenceDelta","stereoBufferIndex","dotTarget","lerpEndRatio","lerpFilters","indexPrev","attemptsRemaining","indexNext","waveNext","innerIndexNext","innerWaveNext","slope","instrumentVolume","volumeMult","seconds","ticks","lower","upper","cents","getBeatsPerMinute","beatsPerSecond","partsPerSecond","tickPerSecond","lastIndex","mask","input1","input2","Change","_noop","UndoableChange","reversed","super","_reversed","_doneForwards","_doForwards","_doBackwards","ChangeGroup","change","isNoop","_didSomething","ChangeSequence","changes","_changes","redo","undo","patternsContainSameInstruments","pattern1Instruments","pattern2Instruments","pattern2Has1Instruments","every","pattern1Has2Instruments","discardInvalidPatternInstruments","uniqueInstruments","Set","unionOfUsedNotes","removeRedundantPins","projectNoteIntoBar","oldNote","timeOffset","newNoteLength","newPinTime","nextPin","nextPinTime","ratio","prevPin","prevPinTime","offsetInterval","pitchIdx","joinedWithPrevNote","newIntervalOffset","newTimeOffset","tempPin","transformedPin","ChangeMoveAndOverflowNotes","doc","newBeatsPerBar","partsToMove","oldChannel","newChannel","oldPartsPerBar","newPartsPerBar","oldPattern","oldBarStart","absoluteNoteStart","absoluteNoteEnd","barStartPart","removeDuplicatePatterns","append","ChangeReplacePatterns","ChangePins","_note","_oldStart","_oldEnd","_newStart","_newEnd","_oldPins","_newPins","_oldPitches","_newPitches","_oldContinuesLastPattern","_newContinuesLastPattern","firstInterval","firstTime","ChangeCustomWave","oldArray","getCurrentInstrument","comparisonResult","ChangePreset","newValue","valueToPreset","clearInvalidEnvelopeTargets","tempVolume","tempPan","tempPanDelay","ChangeRandomGeneratedInstrument","selectWeightedRandom","entries","total","entry","weight","item","selectCurvedDistribution","peak","PotentialFilterPoint","chance","minFreq","maxFreq","centerHz","centerGain","applyFilterPoints","potentialPoints","usedFreqs","potentialPoint","midFreq","normalize","spectrumGenerators","current","generator","harmonicGenerators","ChangeTransition","ChangeToggleEffects","toggleFlag","useInstrument","oldValue","wasSelected","ChangePatternNumbers","startChannel","getCurrentPattern","viewedInstrument","ChangeBarCount","atBeginning","diff","ChangeInsertBars","newLength","ChangeDeleteBars","ChangeLimiterSettings","ChangeChannelOrder","selectionMin","selectionMax","ChangeChannelCount","newPitchChannelCount","newNoiseChannelCount","newModChannelCount","newChannels","changeGroup","newCount","oldCount","newStart","oldStart","pickRandomPresetValue","oldPitchCount","ChangeAddChannel","addedChannelIndex","recalcChannelNames","ChangeRemoveChannel","minIndex","maxIndex","oldMax","ChangeModChannel","ChangeChannelBar","newBar","silently","selection","scrollToSelectedPattern","ChangeUnison","ChangeChord","ChangeVibrato","ChangeVibratoDepth","unsetMod","ChangeVibratoSpeed","ChangeVibratoDelay","ChangeVibratoType","ChangeArpeggioSpeed","ChangeFastTwoNoteArp","ChangeClicklessTransition","ChangeAliasing","ChangeSpectrum","ChangeHarmonics","ChangeDrumsetEnvelope","drumIndex","ChangeInstrumentSlider","_instrument","ChangePulseWidth","ChangePitchShift","ChangeDetune","ChangeDistortion","ChangeBitcrusherFreq","ChangeBitcrusherQuantization","ChangeStringSustain","ChangeEQFilterType","ChangeNoteFilterType","ChangeEQFilterSimpleCut","ChangeEQFilterSimplePeak","ChangeNoteFilterSimpleCut","ChangeNoteFilterSimplePeak","ChangeFilterAddPoint","isNoteFilter","deletion","_envelopeTargetsAdd","_envelopeIndicesAdd","_envelopeTargetsRemove","_envelopeIndicesRemove","_instrumentNextPreset","_instrumentPrevPreset","_filterSettings","_point","ChangeFilterMovePoint","oldFreq","newFreq","oldGain","newGain","_oldFreq","_newFreq","_oldGain","_newGain","ChangeFilterSettings","oldSettings","useNoteFilter","subFilters","oldSubFilters","_oldSettings","_useNoteFilter","_subFilters","_oldSubFilters","ChangeFadeInOut","_oldFadeIn","_oldFadeOut","_newFadeIn","_newFadeOut","ChangeAlgorithm","ChangeFeedbackType","ChangeOperatorWaveform","operatorIndex","ChangeOperatorPulseWidth","ChangeOperatorFrequency","ChangeOperatorAmplitude","ChangeFeedbackAmplitude","ChangeAddChannelInstrument","ChangeRemoveChannelInstrument","removedIndex","ChangeViewInstrument","ChangeInstrumentsFlags","newLayeredInstruments","newPatternInstruments","oldLayeredInstruments","oldPatternInstruments","ChangeKey","ChangeLoop","oldLength","ChangePitchAdded","_pitch","ChangeOctave","ChangeRhythm","ChangePaste","selectionStart","selectionEnd","oldPartDuration","ChangeNoteTruncate","noteInsertionIndex","noteStart","noteEnd","ChangeNoteLength","ChangePasteInstrument","instrumentCopy","ChangeSetPatternInstruments","ChangeModInstrument","ChangeModSetting","text","tgtChannel","startsWith","substr","record","ChangeModFilter","ChangePatternsPerChannel","channelBars","channelPatterns","ChangeEnsurePatternExists","_patternOldNotes","_oldPatternInstruments","_bar","_channelIndex","_oldPatternCount","_newPatternCount","_newPatternInstruments","recentPatternInstruments","firstEmptyUnusedIndex","firstUnusedIndex","used","barIndex","_patternIndex","ChangePinTime","shiftedTime","originalTime","skipStart","skipEnd","setPin","oldPin","_finishSetup","ChangePitchBend","bendStart","bendEnd","bendTo","direction","stop","setStart","setEnd","prevInterval","prevSize","persist","ChangePatternRhythm","minDivision","changeRhythm","oldTime","thresholds","beatStart","newTime","threshold","ChangeNoteAdded","ChangeRhythmNote","ChangeMoveNotesSideways","beatsToMove","strategy","originalBarCount","originalLoopStart","originalLoopLength","firstBarIsEmpty","ChangeBeatsPerBar","noteIndex","ChangeTempo","ChangeScale","ChangeDetectKey","keyWeights","bestKey","bestKeyWeight","keyWeight","absoluteDiff","ChangeTranspose","eligiblePresetValues","setDefaultInstruments","nameToPresetValue","ChangeSong","newHash","ChangePatternSelection","resetBoxSelection","prefs","defaultScale","ChangeValidateTrackSelection","removeExtraSparseChannels","maxLength","sparsestIndex","mostZeroes","zeroes","combinedChannels","comparePatternNotes","newPatterns","foundMatchingPattern","newPatternIndex","ChangeEchoDelay","ChangeEchoSustain","ChangeChorus","ChangeReverb","_pattern","truncStart","truncEnd","pushLastPin","skipNote","force","copy","ChangeSplitNotesAtSelection","patternSelectionStart","patternSelectionEnd","ChangeTransposeNote","upward","ignoreScale","foundMatch","patternSelectionActive","ChangeTrackSelection","newX0","newX1","newY0","newY1","boxSelectionX0","boxSelectionX1","boxSelectionY0","boxSelectionY1","newEnd","_oldActive","_newActive","ChangeDragSelectedNotes","parts","transpose","oldEnd","draggedNotes","notesOutsideScale","ChangeDuplicateSelectedReusedPatterns","barStart","barWidth","channelStart","channelHeight","reusablePatterns","currentPatternIndex","isUsedElsewhere","bar2","copiedPattern","ChangePatternScale","scaleMap","newPitches","newPins","transformedPitch","transformedInterval","ChangeVolume","ChangeSongTitle","ChangeChannelName","muteEditorChannel","ChangePan","ChangePanDelay","ChangeSizeBend","bendPart","bendSize","bendInterval","uniformSize","inserted","ChangeChipWave","ChangeNoiseWave","ChangeAddEnvelope","ChangeRemoveEnvelope","ChangeSetEnvelopeTarget","oldTarget","oldIndex","ChangeSetEnvelopeType","button","span","h2","input","br","select","option","BeatsPerBarPrompt","_beatsStepper","step","_conversionStrategySelect","_cancelButton","_okayButton","_close","cleanUp","removeEventListener","_saveChanges","_validateKey","_validateNumber","_whenKeyPressed","keyCode","localStorage","setItem","prompt","_validate","lastStrategy","getItem","setTimeout","focus","charCode","which","label","ChannelSettingsPrompt","_patternsStepper","_pitchChannelStepper","_drumChannelStepper","_modChannelStepper","_layeredInstrumentsBox","_patternInstrumentsBox","group","checked","CustomChipPromptCanvas","_mouseY","_lastIndex","_lastAmp","chipData","startingChipData","_undoHistoryState","_changeQueue","_fill","_ticks","_subticks","_blocks","viewBox","preserveAspectRatio","_storeChange","sameCheck","render","stopPropagation","right","clientY","pageY","top","bottom","offsetParent","col","amp","lowest","highest","startingAmp","endingAmp","medAmp","children","CustomChipPrompt","_songEditor","customChipCanvas","_playButton","_togglePlay","togglePlay","updatePlayButton","whenKeyPressed","goToPrevBar","goToNextBar","innerText","FilterEditor","larger","_responsePath","_indicators","_controlPointPath","_dottedLinePath","stroke-dasharray","_highlight","circle","r","selfUndoSettings","selfUndoHistoryPos","_label","coordText","_pointRadius","_larger","_touchMode","_mouseDragging","_addingPoint","_deletingPoint","_addedType","_selectedIndex","_freqStart","_gainStart","_dragChange","_subfilterIndex","_renderedSelectedIndex","_renderedPointCount","_renderedPointTypes","_renderedPointFreqs","_renderedPointGains","_updatePath","_whenCursorPressed","_updateCursor","lastChangeWas","stringify","subFilter","parsedFilter","setProspectiveChange","_xToFreq","_yToGain","nearestDistance","distance","_freqToX","_gainToY","_findNearestFreqSlot","freqDelta","gainDelta","targetFreq","ignoreIndex","roundedFreq","lowerFreq","upperFreq","tryingLower","foundConflict","currentFreq","cx","cy","radius","reverse","display","controlPointPath","dottedLinePath","pointX","pointY","_circlePath","responsePath","useHistory","firstFilter","jumpIndex","swapToSubfilter","savedFilter","swapToSettings","newIndex","tmp","currFilter","activeMods","displayMods","targetSettings","pointTypes","pointFreqs","pointGains","p","CustomFilterPrompt","filterData","startingFilterData","_filterButtons","_filterButtonContainer","_filterContainer","_editorTitle","_filterCopyButton","d","_filterPasteButton","_filterCopyPasteContainer","_filterCoordinateText","_setSubfilter","doSwap","filterEditor","_copyFilterSettings","filterCopy","_pasteFilterSettings","newIdx","shiftKey","swapSubfilterIndices","resetToInitial","saveSettings","colors","insertBefore","innerHTML","newButton","newSubButton","transfer","dest","ArrayBuffer","nextOffset","leftBytes","byteLength","wordSizes","wordSize","transferWith","ViewClass","Uint8Array","Uint16Array","view_source","view_dest","byteOffset","ArrayBufferWriter","initialCapacity","_writeIndex","_fileSize","_arrayBuffer","_data","DataView","numBytes","setUint32","_addBytes","setUint8","setUint16","setInt8","startWriting","writeUint8","writeMidiVariableLength","defaultMidiExpression","defaultMidiPitchBend","analogousDrumMap","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","69","70","73","74","midiVolumeToVolumeMult","volumeMultToMidiVolume","midiExpressionToVolumeMult","volumeMultToMidiExpression","lerp","low","high","save","blob","msSaveOrOpenBlob","anchor","download","url","URL","createObjectURL","revokeObjectURL","dispatchEvent","MouseEvent","ExportPrompt","outputStarted","_fileName","maxlength","autofocus","_computedSamplesLabel","Text","_enableIntro","_loopDropDown","_enableOutro","_formatSelect","_exportButton","_outputProgressBar","_outputProgressLabel","_outputProgressContainer","_validateFileName","_export","_exportTo","_exportToMidi","_exportToJson","_exportToHtml","disabled","lastExportFormat","samplesToTime","getTotalSamples","rawSeconds","use","deleteChars","cursorPos","setSelectionRange","samplesPerChunk","currentFrame","currentChunk","samplesInChunk","sampleFrames","tempSamplesL","tempSamplesR","recordedSamplesL","recordedSamplesR","totalChunks","thenExportTo","_exportToWavFinish","_exportToMp3Finish","_synthesize","introIter","sampleCount","arrayBuffer","bytesPerSample","range","valL","valR","setInt16","Blob","whenEncoderIsAvailable","sampleBlockSize","mp3encoder","Mp3Encoder","mp3Data","Int16Array","leftChunk","subarray","rightChunk","mp3buf","encodeBuffer","flush","script","src","onload","midiTicksPerBeat","midiTicksPerPart","microsecondsPerBeat","secondsPerMinute","midiTicksPerBar","pitchBendRange","unrolledBars","loopIndex","tracks","isMeta","midiChannel","isDrumset","midiChannelCounter","foundADrumset","writer","writeUint32","writeUint16","track","trackStartIndex","getWriteIndex","prevTime","barStartTime","writeEventTime","writeControlEvent","message","writeMidi7Bits","writeMidiAscii","writeUint24","isMinor","numSharps","writeInt8","parseInt","channelName","prevInstrumentIndex","writeInstrumentSettings","instrumentProgram","midiChipInstruments","instrumentPan","prevPitchBend","prevExpression","shouldResetExpressionAndPitchBend","channelRoot","usesArpeggio","polyphony","error","noteStartTime","pinTime","pinSize","pinInterval","prevPitches","nextPitches","velocity","pitchOffset","maxPitchOffset","minPitchOffset","nextPinSize","nextPinInterval","midiTick","midiTickTime","linearSize","noteStarting","drumsetMap","midiTicksSinceBeat","midiTicksPerArpeggio","noteEndTime","rewriteUint32","toCompactArrayBuffer","jsonString","fileContents","toBase64String","Layout","layout","_layoutMap","small","long","tall","wide","HarmonicsEditor","_octaves","_fifths","_curve","_lastControlPoints","_lastControlPointContainer","_freqPrev","_ampPrev","_change","_renderedPath","_renderedFifths","_yToAmp","controlPointToHeight","xPos","lastHeight","showFifth","InputBox","_getChange","_value","_oldValue","_whenInput","_whenChange","Slider","midTick","ArrayBufferReader","getUint32","readUint8","getUint16","getUint8","getInt8","nextByte","skipBytes","ImportPrompt","_fileInput","accept","_whenFileSelected","file","files","extension","lastIndexOf","reader","FileReader","goBackToStart","readAsText","_parseMidiFile","readAsArrayBuffer","headerReader","hasMore","chunkType","readUint32","chunkLength","getReaderForNextBytes","trackReader","nextEventMidiTick","readMidiVariableLength","runningStatus","fileFormat","readUint16","currentIndependentTrackIndex","currentTrackIndices","independentTracks","trackIndex","channelRPNMSB","channelRPNLSB","pitchBendRangeMSB","pitchBendRangeLSB","currentInstrumentProgram","currentInstrumentVolumes","currentInstrumentPans","noteEvents","pitchBendEvents","noteSizeEvents","currentMidiTick","MAX_VALUE","anyTrackHasMore","eventStatus","peakUint8","eventType","eventChannel","foundTrackEndEvent","readMidi7Bits","on","volumeMultToInstrumentVolume","volumeMultToNoteSize","lsb","readUint24","numerator","denominatorExponent","readInt8","songTotalBars","quantizeMidiTickToPart","channelPresetValue","midiProgramToPresetValue","channelPreset","isDrumsetChannel","channelBasePitch","midiIntervalScale","channelMaxPitch","currentVelocity","currentProgram","currentInstrumentVolume","currentInstrumentPan","heldPitches","prevEventPart","setInstrumentVolume","noteEventIndex","noteEvent","nextEventPart","MAX_SAFE_INTEGER","drumFreqs","minDuration","maxDuration","heldPitch","currentMidiInterval","currentMidiNoteSize","pitchBendEventIndex","noteSizeEventIndex","updateCurrentMidiInterval","updateCurrentMidiNoteSize","instrumentByProgram","prevEventMidiTick","pitchSum","createdNote","barStartMidiTick","barEndMidiTick","noteStartMidiTick","noteEndMidiTick","shiftedHeldPitch","initialBeepBoxPitch","heldPitchOffset","firstPin","potentialPins","keyPitch","keySize","prevPinIndex","prevPartPitch","prevPartSize","noteRelativePart","lastPart","partPitch","partSize","nearestPitch","pitchIsNearInteger","pitchCrossedInteger","nearestSize","sizeIsNearInteger","sizeCrossedInteger","currentPin","addPin","addPinAtIndex","furthestIntervalDistance","addIntervalPin","addIntervalPinAtIndex","potentialIndex","potentialPin","interpolatedInterval","furthestSizeDistance","addSizePin","addSizePinAtIndex","interpolatedSize","toBePinned","lastToBePinned","minPitch","notePin","shiftedPitch","averagePitch","compactChannels","bestChannelIndexA","bestChannelIndexB","fewestConflicts","fewestGaps","channelIndexA","channelIndexB","channelA","channelB","conflicts","gaps","channelAInstrumentCount","channelAPatternCount","some","form","LayoutPrompt","_form","_confirm","elements","setLayout","EnvelopeEditor","_rows","_targetSelects","_envelopeSelects","_deleteButtons","_renderedEnvelopeCount","_renderedEqFilterCount","_renderedNoteFilterCount","_renderedEffects","_onChange","targetSelectIndex","envelopeSelectIndex","combinedValue","selectedIndex","_onClick","menu","optionIndex","childElementCount","hidden","targetSelect","interleaved","_makeOption","envelopeSelect","deleteButton","row","_updateTargetOptionVisibility","_renderedInstrumentType","FadeInOutEditor","_fadeCurve","_controlCurve","_mouseXStart","_draggingFadeIn","_renderedFadeIn","_renderedFadeOut","_xToFadeIn","_xToFadeOut","dottedLineX","_fadeOutToX","fadeInX","_fadeInToX","fadeOutX","fadePath","LimiterCanvas","lim","_boostCurve","_boostDot","_midCurve","_limitCurve","_limitDot","_label0","font-size","_label1","_label2","_inLabel","_outLabel","_xAxisLabel","_yAxisLabel","transform","_inVolumeBg","_outVolumeBg","_inVolumeBar","_inVolumeCap","_outVolumeBar","_outVolumeCap","_stop1","stop-color","_stop2","_stop3","_gradient","linearGradient","id","gradientUnits","_defs","defs","_limiterPrompt","historicInCap","historicOutCap","lastValue","currentSubpathIdx","lastSubpathIdx","subPaths","limiterRatio","limitRatioSlider","compressorRatio","compressionRatioSlider","limiterThreshold","limitThresholdSlider","compressorThreshold","compressionThresholdSlider","LimiterPrompt","limiterCanvas","limitDecaySlider","limitRiseSlider","masterGainSlider","inVolumeHistoricTimer","inVolumeHistoricCap","outVolumeHistoricTimer","outVolumeHistoricCap","_resetButton","_volumeUpdate","animateVolume","requestAnimationFrame","_whenInputFavorLimitThreshold","_updateLimiter","startingLimitRatio","startingCompressionRatio","startingLimitThreshold","startingCompressionThreshold","startingLimitDecay","startingLimitRise","startingMasterGain","_resetDefaults","LoopEditor","_startMode","_endMode","_bothMode","_loop","_barWidth","_cursor","mode","_clientStartX","_clientStartY","_startedScrolling","_draggingHorizontally","_renderedLoopStart","_renderedLoopStop","_renderedBarCount","_renderedBarWidth","_updateCursorStatus","_whenTouchReleased","_render","_documentChanged","watch","middle","endPoints","_findEndPoints","jumpIntoLoop","autoFollow","showHighlight","highlightStart","highlightStop","loopStop","editorWidth","MoveNotesSidewaysPrompt","MuteEditor","_editor","_cornerFiller","_buttons","_channelCounts","_channelNameDisplay","color","_channelNameInput","_channelDropDown","_renderedChannelCount","_renderedPitchChannels","_renderedNoiseChannels","_renderedModChannels","_renderedChannelHeight","_channelDropDownChannel","_channelDropDownOpen","_channelDropDownLastState","_channelNameInputWhenInput","_channelNameInputClicked","_channelNameInputHide","_channelDropDownClick","_channelDropDownGetOpenedPosition","_channelDropDownBlur","options","_channelDropDownHandler","shouldSolo","insertChannel","refocusStage","_onMouseMove","_onMouseLeave","enableChannelMuting","channelCountText","muteButton","muteContainer","marginTop","marginBottom","fontSize","OctaveScrollBar","_piano","_notchHeight","_octaveCount","_octaveHeight","_upHighlight","_downHighlight","_renderedBarBottom","_renderedVisibleOctaveCount","_barBottom","_barHeight","visibleOctaveCount","getVisibleOctaveCount","scrollableOctaves","canReplaceLastChange","currentOctave","getBaseVisibleOctave","forceRender","showUpHighlight","showDownHighlight","toString","MidiInputHandler","_takeMidiHandlerFocus","_handleStateChange","port","state","_registerMidiInput","_unregisterMidiInput","midiInput","_onMidiMessage","clearAllPitches","enableMidi","isDrum","addPerformedPitch","removePerformedPitch","registerMidiAccessHandler","requestMIDIAccess","midiAccess","inputs","forEach","e","KeyboardLayout","_possiblyPlayingPitchesFromKeyboard","_onWindowBlur","keyboardLayout","forcedKey","scaleIndices","flag","_pianoAtC","_pianoAtA","keyOffset","pressed","code","handleKey","keyPosToPitch","PatternCursor","valid","curNote","curIndex","exactPart","nearPinIndex","PatternEditor","_interactive","_barOffset","controlMode","shiftMode","_svgNoteBackground","patternUnits","_svgDrumBackground","_svgModBackground","_svgBackground","_svgNoteContainer","_svgPlayhead","_selectionRect","fill-opacity","_svgPreview","modDragValueLabel","text-anchor","contenteditable","dominant-baseline","_defaultModBorder","_backgroundPitchRows","_backgroundDrumRow","_backgroundModRow","_modDragValueLabelLeft","_modDragValueLabelTop","_modDragValueLabelWidth","editingModLabel","_modDragStartValue","_modDragLowerBound","_modDragUpperBound","_pitchHeight","_mouseHorizontal","_usingTouch","_copiedPinChannels","_mouseYStart","_touchTime","_shiftHeld","_dragConfirmed","_draggingStartOfSelection","_draggingEndOfSelection","_draggingSelectionContents","_dragTime","_dragPitch","_dragSize","_dragVisible","_changePatternSelection","_lastChangeWasPatternSelection","_stashCursorPinVols","_playheadX","_octaveOffset","_renderedWidth","_renderedHeight","_renderedBeatWidth","_renderedPitchHeight","_renderedDrums","_renderedMod","_renderedRhythm","_renderedPitchChannelCount","_renderedNoiseChannelCount","_renderedModChannelCount","_followPlayheadBar","_validateModDragLabelInput","converted","presValue","xOffset","_partWidth","_modDragNote","_modDragPin","_modDragSetting","resetCopiedPins","maxDivision","_getMaxDivision","_animatePlayhead","timestamp","notifyWatchers","playheadBar","modPlayhead","currentPatternIsDirty","_redrawNotePatterns","ctrlKey","continuousState","_setPatternSelection","_copyPins","enableNotePreview","setTemporaryPitches","rectangle","rhythmStepsPerBeat","_getMinDivision","foundNote","_findMousePitch","_pitchToPixelHeight","_pitchBorder","mousePitch","leftSide","rightSide","intervalRatio","arc","bendHeight","minInterval","maxInterval","bestDistance","pinDistance","_snapToPitch","nearest","defaultLength","_copiedPins","fullBeats","modMouse","division","forceStart","forceEnd","maxHeight","maxFoundHeight","pixelY","_pitchCount","guess","topPitch","bottomPitch","topRange","bottomRange","discardChanges","getSelection","sel","removeAllRanges","selectAllChildren","stopEditingModLabel","maintainLiveInput","_cursorAtStartOfSelection","_cursorAtEndOfSelection","_cursorIsInSelection","_updateSelection","dx","dy","_snapToMinDivision","notesInScale","pitchRatio","draggedParts","draggedTranspose","backwards","directLength","blessedLength","theNote","shiftedPin","dragFactorSlow","dragFactorFast","dragSign","dragCounts","sizeRatio","alwaysFineNoteVol","pathString","_drawNote","clientHeight","getVisiblePitchCount","beatWidth","node","cloneNode","parentNode","replaceChild","makeEmptyReplacementElement","showChannels","pattern2","notePath","displayNumberedChords","colorPrimary","colorSecondary","indicatorOffset","arrowHeight","arrowPath","arrow","oscillatorLabel","svgElement","showSize","totalWidth","endOffset","prevSide","nextSide","prevHeight","nextHeight","nextSize","Piano","_pianoContainer","_drumContainer","_modContainer","_preview","_pianoKeys","_pianoLabels","_modFirstLabels","_modSecondLabels","_modCountLabels","_modCountRects","_playedPitch","_renderedScale","_renderedKey","_renderedPitchCount","_renderedLiveInputPitches","_updateCursorPitch","_playLiveInput","_whenMouseReleased","_releaseLiveInput","_onAnimationFrame","liveInputChanged","liveInputPitchCount","pitchesAreTemporary","showLetters","firstRow","secondRow","useFirstColor","useSecondColor","usingSecondRow","usingMod","instrumentVal","channelVal","instrumentsLength","insText","filterVal","firstLabel","secondLabel","modCountLabel","modCountRect","scaleFactor","parentElement","getComputedTextLength","squeeze","pianoLabel","pianoKey","pitchNameIndex","background","getPitchName","firstRowText","secondRowText","countText","countRect","firstRowSVG","countSVG","secondRowSVG","flexRow1","flexRow2","flexContainer","modKey","_cursorPitch","pitchHeight","child","scaleIndex","baseVisibleOctave","shiftDir","SongDurationPrompt","_barsStepper","_positionSelect","lastPosition","versionPrefix","keyToVersion","versionToKey","generateUid","compareSongs","versions","compareVersions","SongRecovery","_song","songs","songsByUid","itemKey","uid","songData","newName","Date","clearTimeout","_saveVersionTimeoutHandle","alert","getAllRecoveredSongs","currentSong","newWork","mostRecentTime","work","newVersion","newKey","minSpan","spanMult","indexToDiscard","currentTime","newerTime","removeItem","leastImportantSong","leastImportance","maximumSongCount","timeScale","iframe","SongRecoveryPrompt","_songContainer","versionMenu","toLocaleString","player","RecordingSetupPrompt","_keyboardMode","_keyboardLayout","_keyboardLayoutPreview","_enableMidi","_showRecordButton","_snapRecordedNotesToRhythm","_ignorePerformedNotesNotInScale","_metronomeCountIn","_metronomeWhileRecording","pressControlForShortcuts","showRecordButton","snapRecordedNotesToRhythm","ignorePerformedNotesNotInScale","metronomeCountIn","metronomeWhileRecording","_renderKeyboardLayoutPreview","rowLengths","rowIndex","spacer","colIndex","scalePitch","border","SpectrumEditor","_spectrumIndex","_arrow","ThemePrompt","_themeSelect","lastTheme","setTheme","colorTheme","_previewTheme","h3","TipPrompt","_closeButton","modNum","pList","Box","_x","_y","_text","font-family","font-weight","_rect","_renderedIndex","_renderedDim","_renderedSelected","_renderedColor","dim","selected","TrackEditor","_barDropDown","_boxContainer","_barNumberContainer","_boxHighlight","_barEditorPath","_select","_grid","_barNumbers","_mouseStartBar","_mouseStartChannel","_mouseBar","_mouseChannel","_mousePressed","_channelHeight","_renderedPatternCount","_barDropDownBar","_lastScrollTime","_barDropDownGetOpenedPosition","_barDropDownHandler","moveBarOffset","insertBars","_barScrollBar","deleteBars","_whenSelectChanged","setPattern","_whenSelectPressed","_updateSelectPos","_whenSelectMoved","_dragBoxSelection","_whenSelectReleased","_updateMousePos","setTrackSelection","selectionUpdated","setChannelBar","up","patternCount","determinedCursorType","overTrackEditor","changeBarScrollPos","tip","lastChild","selectedPattern","box","setSize","pathLeft","editorHeight","setIndex","boxSelectionActive","boxSelectionBar","boxSelectionChannel","boxSelectionWidth","boxSelectionHeight","optgroup","canvas","buildOptions","items","buildPresetOptions","idSet","randomGroup","foundAny","moveViolin2","moveFlute2","moveGrandPiano2","setSelectedValue","stringValue","$","trigger","CustomChipCanvas","mouseDown","ctx","getContext","continuousEdit","lastX","lowerBound","upperBound","progress","lastY","fillStyle","fillRect","getComputedChannelColor","_onMouseDown","_onMouseUp","redrawCanvas","SongEditor","_pausePlayer","_patternEditorPrev","_patternEditor","_patternEditorNext","_trackEditor","_muteEditor","_loopEditor","_octaveScrollBar","_pauseButton","_recordButton","_stopButton","_prevBarButton","_nextBarButton","_volumeSlider","_outVolumeBarBg","_volumeBarContainer","_volumeBarBox","_fileMenu","_editMenu","_optionsMenu","_scaleSelect","_keySelect","_tempoSlider","_tempoStepper","_chorusSlider","_chorusRow","onclick","_openPrompt","_reverbSlider","_reverbRow","_echoSustainSlider","_echoSustainRow","_echoDelaySlider","_echoDelayRow","_rhythmSelect","_pitchedPresetSelect","_drumPresetSelect","_algorithmSelect","_algorithmSelectRow","_instrumentButtons","_instrumentAddButton","_instrumentRemoveButton","_instrumentsButtonBar","_instrumentsButtonRow","_instrumentVolumeSlider","_instrumentVolumeSliderInputBox","_instrumentVolumeSliderTip","_instrumentVolumeSliderRow","_panSlider","_panDropdown","_toggleDropdownMenu","_panSliderInputBox","_panSliderRow","tabindex","_panDelaySlider","_panDelayRow","_panDropdownGroup","_chipWaveSelect","_chipNoiseSelect","_chipWaveSelectRow","_chipNoiseSelectRow","_fadeInOutEditor","_fadeInOutRow","_transitionSelect","_transitionDropdown","_transitionRow","_clicklessTransitionBox","_clicklessTransitionRow","_transitionDropdownGroup","_effectsSelect","_eqFilterSimpleButton","_switchEQFilterType","_eqFilterAdvancedButton","_eqFilterTypeRow","_eqFilterEditor","_eqFilterZoom","_eqFilterRow","_eqFilterSimpleCutSlider","_eqFilterSimpleCutRow","_eqFilterSimplePeakSlider","_eqFilterSimplePeakRow","_noteFilterSimpleButton","_switchNoteFilterType","_noteFilterAdvancedButton","_noteFilterTypeRow","_noteFilterEditor","_noteFilterZoom","_noteFilterRow","_noteFilterSimpleCutSlider","_noteFilterSimpleCutRow","_noteFilterSimplePeakSlider","_noteFilterSimplePeakRow","_pulseWidthSlider","_pulseWidthRow","_pitchShiftSlider","_pitchShiftTonicMarkers","_pitchShiftFifthMarkers","_pitchShiftMarkerContainer","_pitchShiftRow","_detuneSlider","_detuneSliderInputBox","_detuneSliderRow","_distortionSlider","_distortionRow","_aliasingBox","_aliasingRow","_bitcrusherQuantizationSlider","_bitcrusherQuantizationRow","_bitcrusherFreqSlider","_bitcrusherFreqRow","_stringSustainSlider","_stringSustainRow","_unisonSelect","_unisonSelectRow","_chordSelect","_chordDropdown","_chordSelectRow","_arpeggioSpeedSlider","_arpeggioSpeedRow","_twoNoteArpBox","_twoNoteArpRow","_chordDropdownGroup","_vibratoSelect","_vibratoDropdown","_vibratoSelectRow","_vibratoDepthSlider","_vibratoDepthRow","_vibratoSpeedSlider","_vibratoSpeedRow","_vibratoDelaySlider","_vibratoDelayRow","_vibratoTypeSelect","_vibratoTypeSelectRow","_vibratoDropdownGroup","_phaseModGroup","_feedbackTypeSelect","_feedbackRow1","_spectrumEditor","_spectrumRow","_harmonicsEditor","_harmonicsRow","_envelopeEditor","_drumsetGroup","_modulatorGroup","_instrumentCopyButton","_instrumentPasteButton","_customWaveDrawCanvas","_customWavePresetDrop","header","buildHeaderedOptions","_customWaveZoom","_customWaveDraw","_songTitleInputBox","_feedbackAmplitudeSlider","_feedbackRow2","_addEnvelopeButton","_customInstrumentSettingsGroup","_instrumentCopyGroup","_instrumentSettingsTextRow","_instrumentTypeSelectRow","_instrumentSettingsGroup","_usedPatternIndicator","fill-rule","_usedInstrumentIndicator","_jumpToModIndicator","_promptContainer","_zoomInButton","_zoomOutButton","_patternEditorRow","_patternArea","_trackVisibleArea","_trackAndMuteContainer","_trackArea","_menuArea","_songSettingsArea","margin-right","_instrumentSettingsArea","_settingsArea","mainLayer","tabIndex","_wasPlaying","_currentPromptName","_highlightedInstrumentIndex","_renderedInstrumentCount","_renderedIsPlaying","_renderedIsRecording","_renderedShowRecordButton","_renderedCtrlHeld","_ctrlHeld","_deactivatedInstruments","_operatorRows","_operatorAmplitudeSliders","_operatorFrequencySelects","_operatorDropdowns","_operatorWaveformSelects","_operatorWaveformHints","_operatorWaveformPulsewidthSliders","_operatorDropdownRows","_operatorDropdownGroups","_drumsetSpectrumEditors","_drumsetEnvelopeSelects","_showModSliders","_newShowModSliders","_modSliderValues","_hasActiveModSliders","_openPanDropdown","_openVibratoDropdown","_openChordDropdown","_openTransitionDropdown","_openOperatorDropdowns","lastOutVolumeCap","_deactivate","HTMLElement","_changeSong","HTMLInputElement","fetch","then","res","_clearSong","_fetchSong","exportedBuffer","_exportCurrentToMidi","base64","_arrayBufferToBase64","preventScroll","_onFocusIn","_refocusStageNotEditing","whenUpdated","trackBounds","determineInvalidModulators","activeElement","showScrollBar","displayVolumeBar","getFullScreen","targetBeatWidth","minBeatWidth","maxBeatWidth","patternEditorWidth","flexShrink","optionCommands","autoPlay","displayBrowserUrl","wasActive","contains","effectFlag","updateValue","_usageCheck","parent","hide","_modChannelBoxes","channelList","_modInstrumentBoxes","instrumentList","_modSetBoxes","settingList","unusedSettingList","tgtInstrumentTypes","anyInstrumentAdvancedEQ","anyInstrumentSimpleEQ","anyInstrumentAdvancedNote","anyInstrumentSimpleNote","anyInstrumentArps","anyInstrumentPitchShifts","anyInstrumentDetunes","anyInstrumentVibratos","anyInstrumentNoteFilters","anyInstrumentDistorts","anyInstrumentBitcrushes","anyInstrumentPans","anyInstrumentChorus","anyInstrumentEchoes","anyInstrumentReverbs","allInstrumentNoteFilters","allInstrumentDetunes","allInstrumentVibratos","allInstrumentDistorts","allInstrumentBitcrushes","allInstrumentPans","allInstrumentChorus","allInstrumentEchoes","allInstrumentReverbs","instrumentCandidates","_whenSetModSetting","_modTargetIndicators","tmpCount","dotCount","isSimple","_modFilterBoxes","dotList","useName","chordIndex","hasAttribute","_renderInstrumentBar","show","isCarrier","operatorName","marker","_setPrompt","goToBar","addedEffect","envButtonRect","instSettingsRect","settingsRect","addedEnvelope","scrollHeight","pointerEvents","opacity","_disableCtrlContextMenu","_tempoStepperCaptureNumberKeys","metaKey","handleKeyEvent","_toggleRecord","needControlForShortcuts","getModifierState","canPlayNotes","movePlayheadToMouse","_copyInstrument","deleteChannel","selectChannel","selectAll","duplicatePatterns","snapToStart","altKey","visibleOctaves","reload","muteChannels","nextEmpty","nextUnused","soloChannels","pasteNumbers","_pasteInstrument","pasteNotes","panningEffectIndex","_copyTextToClipboard","_randomGenerated","_randomPreset","swapChannels","scrollToEndOfSelection","nextDigit","instrumentDigits","_whenKeyReleased","onKeyUp","_whenPrevBarPressed","_whenNextBarPressed","_animate","_modSliderUpdate","isFilterModActive","_animateVolume","_setVolumeSlider","setVolume","_whenSetTempo","_whenSetScale","forceScale","_whenSetKey","_whenSetRhythm","forceRhythm","_refocus","selfRef","_whenSetPitchedPreset","_setPreset","_whenSetDrumPreset","_whenSetFeedbackType","_whenSetAlgorithm","_whenSelectInstrument","selectInstrument","_whenSetModChannel","previouslyUnset","setModChannel","setModInstrument","_whenSetModInstrument","invalidIndex","selectedOptions","setModSetting","_whenClickModTarget","_whenClickJumpToModTarget","modChannelIdx","patternIdx","modInstrumentIdx","_whenSetModFilter","setModFilter","_whenSetChipWave","_whenSetNoiseWave","_whenSetTransition","_whenSetEffects","_whenSetVibrato","_whenSetVibratoType","_whenSetUnison","_whenSetChord","_addNewEnvelope","_zoomIn","_zoomOut","_fileMenuHandler","share","open","_editMenuHandler","_optionsMenuHandler","toggleDisplayBrowserUrl","_customWavePresetHandler","customWaveArray","MIN_VALUE","arrayPoint","arrayStep","operatorNumber","frequencySelect","amplitudeSlider","waveformSelect","waveformDropdown","waveformDropdownHint","waveformPulsewidthSlider","waveformDropdownRow","waveformDropdownGroup","spectrumEditor","_modNameRows","_modSetRows","_modFilterRows","modChannelBox","modInstrumentBox","modNameRow","modSetBox","modFilterBox","modSetRow","modFilterRow","modTarget","thisRef","bind","autoPlayOption","screen","availWidth","layoutOption","bytes","len","btoa","isIntro","isOutro","loops","dropdown","submenu","anyModActive","isAnyModActive","updateModSlider","editor","slider","currentVal","_getSliderForModSetting","anySliderActive","openPrompt","changePos","maxInstrumentsPerChannel","instrumentButton","oldButton","instrumentUsed","patternUsed","modUsed","lowestSelX","highestSelX","lowestSelY","highestSelY","nav","clipboard","writeText","catch","textField","succeeded","execCommand","toSimple","SongPerformance","_channelIsDrum","_channelOctave","_songKey","_pitchesAreTemporary","_recentlyAddedPitches","_songLengthWhenRecordingStarted","_playheadPart","_playheadPattern","_pitchesChanged","_lastNote","_recordingChange","_updateRecordedNotes","_lastBarHasPatterns","startRecording","_getCurrentPlayheadPart","abortRecording","oldPart","oldPlayheadPart","newPart","dirty","startPart","endPart","addedAlreadyReleasedPitch","erasePatternInBar","recentPitch","recentIndex","Selection","_changeTranspose","_changeTrack","_changeInstrument","_changeReorder","x0","x1","y0","y1","json","hasRedoHistory","digit","forInstrument","forRhythms","parsed","insertIndex","_eachSelectedChannel","_eachSelectedPattern","handledPatterns","_eachSelectedBar","patternCopy","from","patternNumber","cloneNotes","channelCopy","selectionCopy","partDuration","channelCopies","copiedPartDuration","fillSelection","pasteHeight","pasteChannel","patternCopies","copiedBars","pasteWidth","usedPatterns","pasteBar","copiedPatternIndex","reusedIndex","instrumentsCopy","_parseCopiedInstrumentArray","existingPattern","_patternIndexIsUnused","removedPattern","allChannels","anyMuted","anyUnmuted","invert","alreadySoloed","currentChannel","soloPattern","matchesSoloPattern","shouldBeMuted","scaleFlags","oldScaleFlags","newScaleValue","newScaleFlags","oldScale","newScale","largerToSmaller","smallerScale","largerScale","roles","bestScore","bestIndexMap","stack","indexMap","score","sparsePitchMap","smallerScalePitch","largerScalePitch","sparseIndex","fullPitchMap","oldLow","newLow","oldHigh","newHigh","nearestPitchDistance","newPitch","generateScaleMap","possibleSectionBoundaries","channelSectionMin","channelSectionMax","nextBoundary","newSelectionMin","newSelectionMax","maxLayers","Preferences","defaultVisibleOctaves","instrumentCopyPaste","ChangeNotifier","_watchers","_dirty","watcher","SongDocument","_recovery","_recentChange","_sequenceNumber","_lastSequenceNumber","_stateShouldBePushed","_recordedNewSong","_waitingToUpdateState","_whenHistoryStateChanged","history","_resetSongRecoveryUid","canUndo","sequenceNumber","recoveryUid","_recoveryUid","toJSON","_replaceState","_pushState","forgetLastChange","_getHistoryState","_getHash","fromJSON","_cleanDocument","_validateDocState","highlightedPattern","_updateHistoryState","saveVersion","sessionStorage","songString","_calcVolume","eventName","observedAttributes","currentIndex","oldestIndex","_maximumUndoHistory","newSong","_back","commit","_forward","barOffset","innerWidth","getMobileLayout","squashed","getElementById","className","getElementsByClassName","select2","dropdownAutoWidth","siblings","toggle","css","groups","each","v","autoplay","scrollRestoration","serviceWorker","register","updateViaCache","scope"],"mappings":"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CAAErB,eAAkB,UAAWqB,SAAY,CAAC,EAAG,EAAG,EAAG,EAAG,IAAK,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,KAAO,CAAErB,eAAkB,UAAWqB,SAAY,CAAC,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,KAAO,CAAErB,eAAkB,UAAWqB,SAAY,CAAC,EAAG,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,KAAO,CAAErB,eAAkB,UAAWqB,SAAY,CAAC,EAAG,EAAG,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,KAAO,CAAErB,eAAkB,UAAWqB,SAAY,CAAC,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,KAAO,CAAErB,eAAkB,UAAWqB,SAAY,CAAC,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,KAAO,CAAErB,eAAkB,UAAWqB,SAAY,CAAC,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,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","sourcesContent":["/*!\r\nCopyright (c) 2012-2022 John Nesky and contributing authors\r\n\r\nPermission is hereby granted, free of charge, to any person obtaining a copy of \r\nthis software and associated documentation files (the \"Software\"), to deal in \r\nthe Software without restriction, including without limitation the rights to \r\nuse, copy, modify, merge, publish, distribute, sublicense, and/or sell copies \r\nof the Software, and to permit persons to whom the Software is furnished to do \r\nso, subject to the following conditions:\r\n\r\nThe above copyright notice and this permission notice shall be included in all \r\ncopies or substantial portions of the Software.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR \r\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, \r\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE \r\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER \r\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, \r\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE \r\nSOFTWARE.\r\n*/\r\n\r\nexport interface Dictionary<T> {\r\n    [K: string]: T;\r\n}\r\n\r\nexport interface DictionaryArray<T> extends ReadonlyArray<T> {\r\n    dictionary: Dictionary<T>;\r\n}\r\n\r\nexport const enum FilterType {\r\n    lowPass,\r\n    highPass,\r\n    peak,\r\n    length,\r\n}\r\n\r\nexport const enum EnvelopeType {\r\n    noteSize,\r\n    none,\r\n    punch,\r\n    flare,\r\n    twang,\r\n    swell,\r\n    tremolo,\r\n    tremolo2,\r\n    decay,\r\n}\r\n\r\nexport const enum InstrumentType {\r\n    chip,\r\n    fm,\r\n    noise,\r\n    spectrum,\r\n    drumset,\r\n    harmonics,\r\n    pwm,\r\n    pickedString,\r\n    customChipWave,\r\n    mod,\r\n    length,\r\n}\r\n\r\nexport const enum DropdownID {\r\n    Vibrato = 0,\r\n    Pan = 1,\r\n    Chord = 2,\r\n    Transition = 3,\r\n    FM = 4,\r\n\r\n}\r\n\r\nexport const enum EffectType {\r\n    reverb,\r\n    chorus,\r\n    panning,\r\n    distortion,\r\n    bitcrusher,\r\n    noteFilter,\r\n    echo,\r\n    pitchShift,\r\n    detune,\r\n    vibrato,\r\n    transition,\r\n    chord,\r\n    // If you add more, you'll also have to extend the bitfield used in Base64 which currently uses two six-bit characters.\r\n    length,\r\n}\r\n\r\nexport const enum EnvelopeComputeIndex {\r\n    noteVolume,\r\n    noteFilterAllFreqs,\r\n    pulseWidth,\r\n    stringSustain,\r\n    unison,\r\n    operatorFrequency0, operatorFrequency1, operatorFrequency2, operatorFrequency3,\r\n    operatorAmplitude0, operatorAmplitude1, operatorAmplitude2, operatorAmplitude3,\r\n    feedbackAmplitude,\r\n    pitchShift,\r\n    detune,\r\n    vibratoDepth,\r\n    noteFilterFreq0, noteFilterFreq1, noteFilterFreq2, noteFilterFreq3, noteFilterFreq4, noteFilterFreq5, noteFilterFreq6, noteFilterFreq7,\r\n    noteFilterGain0, noteFilterGain1, noteFilterGain2, noteFilterGain3, noteFilterGain4, noteFilterGain5, noteFilterGain6, noteFilterGain7,\r\n    length,\r\n}\r\n\r\n/*\r\nexport const enum InstrumentAutomationIndex {\r\n    mixVolume,\r\n    eqFilterAllFreqs,\r\n    eqFilterFreq0, eqFilterFreq1, eqFilterFreq2, eqFilterFreq3, eqFilterFreq4, eqFilterFreq5, eqFilterFreq6, eqFilterFreq7,\r\n    eqFilterGain0, eqFilterGain1, eqFilterGain2, eqFilterGain3, eqFilterGain4, eqFilterGain5, eqFilterGain6, eqFilterGain7,\r\n    distortion,\r\n    bitcrusherQuantization,\r\n    bitcrusherFrequency,\r\n    panning,\r\n    chorus,\r\n    echoSustain,\r\n    //echoDelay, // Wait until tick settings can be computed once for multiple run lengths.\r\n    reverb,\r\n    length,\r\n}\r\n*/\r\n\r\nexport interface BeepBoxOption {\r\n    readonly index: number;\r\n    readonly name: string;\r\n}\r\n\r\nexport interface Scale extends BeepBoxOption {\r\n    readonly flags: ReadonlyArray<boolean>;\r\n    readonly realName: string;\r\n}\r\n\r\nexport interface Key extends BeepBoxOption {\r\n    readonly isWhiteKey: boolean;\r\n    readonly basePitch: number;\r\n}\r\n\r\nexport interface Rhythm extends BeepBoxOption {\r\n    readonly stepsPerBeat: number;\r\n    readonly roundUpThresholds: number[] | null;\r\n}\r\n\r\nexport interface ChipWave extends BeepBoxOption {\r\n    readonly expression: number;\r\n    samples: Float32Array;\r\n}\r\n\r\nexport interface OperatorWave extends BeepBoxOption {\r\n    samples: Float32Array;\r\n}\r\n\r\nexport interface ChipNoise extends BeepBoxOption {\r\n    readonly expression: number;\r\n    readonly basePitch: number;\r\n    readonly pitchFilterMult: number;\r\n    readonly isSoft: boolean;\r\n    samples: Float32Array | null;\r\n}\r\n\r\nexport interface Transition extends BeepBoxOption {\r\n    readonly isSeamless: boolean;\r\n    readonly continues: boolean;\r\n    readonly slides: boolean;\r\n    readonly slideTicks: number;\r\n    readonly includeAdjacentPatterns: boolean;\r\n}\r\n\r\nexport interface Vibrato extends BeepBoxOption {\r\n    readonly amplitude: number;\r\n    readonly type: number;\r\n    readonly delayTicks: number;\r\n}\r\n\r\nexport interface VibratoType extends BeepBoxOption {\r\n    readonly periodsSeconds: number[];\r\n    readonly period: number;\r\n}\r\n\r\nexport interface Unison extends BeepBoxOption {\r\n    readonly voices: number;\r\n    readonly spread: number;\r\n    readonly offset: number;\r\n    readonly expression: number;\r\n    readonly sign: number;\r\n}\r\n\r\nexport interface Modulator extends BeepBoxOption {\r\n    readonly name: string; // name that shows up in song editor UI\r\n    readonly pianoName: string; // short name that shows up in mod piano UI\r\n    readonly maxRawVol: number; // raw\r\n    readonly newNoteVol: number; // raw\r\n    readonly forSong: boolean; // true - setting is song scope\r\n    convertRealFactor: number; // offset that needs to be applied to get a \"real\" number display of value, for UI purposes\r\n    readonly associatedEffect: EffectType; // effect that should be enabled for this modulator to work properly. If unused, set to EffectType.length.\r\n    readonly promptName: string; // long-as-needed name that shows up in tip prompt\r\n    readonly promptDesc: string[]; // paragraph(s) describing how to use this mod\r\n\r\n}\r\n\r\nexport interface Chord extends BeepBoxOption {\r\n    readonly customInterval: boolean;\r\n    readonly arpeggiates: boolean;\r\n    readonly strumParts: number;\r\n    readonly singleTone: boolean;\r\n}\r\n\r\nexport interface Algorithm extends BeepBoxOption {\r\n    readonly carrierCount: number;\r\n    readonly associatedCarrier: ReadonlyArray<number>;\r\n    readonly modulatedBy: ReadonlyArray<ReadonlyArray<number>>;\r\n}\r\n\r\nexport interface OperatorFrequency extends BeepBoxOption {\r\n    readonly mult: number;\r\n    readonly hzOffset: number;\r\n    readonly amplitudeSign: number;\r\n}\r\n\r\nexport interface Feedback extends BeepBoxOption {\r\n    readonly indices: ReadonlyArray<ReadonlyArray<number>>;\r\n}\r\n\r\nexport interface Envelope extends BeepBoxOption {\r\n    readonly type: EnvelopeType;\r\n    readonly speed: number;\r\n}\r\n\r\nexport interface AutomationTarget extends BeepBoxOption {\r\n    readonly computeIndex: EnvelopeComputeIndex /*| InstrumentAutomationIndex*/ | null;\r\n    readonly displayName: string;\r\n    //readonly perNote: boolean; // Whether to compute envelopes on a per-note basis.\r\n    readonly interleave: boolean; // Whether to interleave this target with the next one in the menu.\r\n    readonly isFilter: boolean; // Filters have a variable maxCount in practice.\r\n    //readonly range: number | null; // set if automation is allowed.\r\n    readonly maxCount: number;\r\n    readonly effect: EffectType | null;\r\n    readonly compatibleInstruments: InstrumentType[] | null;\r\n}\r\n\r\nexport class Config {\r\n    // Params for post-processing compressor\r\n    public static thresholdVal: number = -10;\r\n    public static kneeVal: number = 40;\r\n    public static ratioVal: number = 12;\r\n    public static attackVal: number = 0;\r\n    public static releaseVal: number = 0.25;\r\n\r\n    public static readonly scales: DictionaryArray<Scale> = toNameMap([\r\n\r\n        //   C     Db      D     Eb      E      F     F#      G     Ab      A     Bb      B      C\r\n        { name: \"Free\", realName: \"chromatic\", flags: [true, true, true, true, true, true, true, true, true, true, true, true] }, // Free\r\n        { name: \"Major\", realName: \"ionian\", flags: [true, false, true, false, true, true, false, true, false, true, false, true] }, // Major\r\n        { name: \"Minor\", realName: \"aeolian\", flags: [true, false, true, true, false, true, false, true, true, false, true, false] }, // Minor\r\n        { name: \"Mixolydian\", realName: \"mixolydian\", flags: [true, false, true, false, true, true, false, true, false, true, true, false] }, // Mixolydian\r\n        { name: \"Lydian\", realName: \"lydian\", flags: [true, false, true, false, true, false, true, true, false, true, false, true] }, // Lydian\r\n        { name: \"Dorian\", realName: \"dorian\", flags: [true, false, true, true, false, true, false, true, false, true, true, false] }, // Dorian\r\n        { name: \"Phrygian\", realName: \"phrygian\", flags: [true, true, false, true, false, true, false, true, true, false, true, false] }, // Phrygian\r\n        { name: \"Locrian\", realName: \"locrian\", flags: [true, true, false, true, false, true, true, false, true, false, true, false] }, // Locrian\r\n        { name: \"Lydian Dominant\", realName: \"lydian dominant\", flags: [true, false, true, false, true, false, true, true, false, true, true, false] }, // Lydian Dominant\r\n        { name: \"Phrygian Dominant\", realName: \"phrygian dominant\", flags: [true, true, false, false, true, true, false, true, true, false, true, false] }, // Phrygian Dominant\r\n        { name: \"Harmonic Major\", realName: \"harmonic major\", flags: [true, false, true, false, true, true, false, true, true, false, false, true] }, // Harmonic Major\r\n        { name: \"Harmonic Minor\", realName: \"harmonic minor\", flags: [true, false, true, true, false, true, false, true, true, false, false, true] }, // Harmonic Minor\r\n        { name: \"Melodic Minor\", realName: \"melodic minor\", flags: [true, false, true, true, false, true, false, true, false, true, false, true] }, // Melodic Minor\r\n        { name: \"Blues\", realName: \"blues\", flags: [true, false, false, true, false, true, true, true, false, false, true, false] }, // Blues\r\n        { name: \"Altered\", realName: \"altered\", flags: [true, true, false, true, true, false, true, false, true, false, true, false] }, // Altered\r\n        { name: \"Major Pentatonic\", realName: \"major pentatonic\", flags: [true, false, true, false, true, false, false, true, false, true, false, false] }, // Major Pentatonic\r\n        { name: \"Minor Pentatonic\", realName: \"minor pentatonic\", flags: [true, false, false, true, false, true, false, true, false, false, true, false] }, // Minor Pentatonic\r\n        { name: \"Whole Tone\", realName: \"whole tone\", flags: [true, false, true, false, true, false, true, false, true, false, true, false] }, // Whole Tone\r\n        { name: \"Octatonic\", realName: \"octatonic\", flags: [true, false, true, true, false, true, true, false, true, true, false, true] }, // Octatonic\r\n        { name: \"Hexatonic\", realName: \"hexatonic\", flags: [true, false, false, true, true, false, false, true, true, false, false, true] }, // Hexatonic\r\n\r\n\r\n    ]);\r\n    public static readonly keys: DictionaryArray<Key> = toNameMap([\r\n        { name: \"C\", isWhiteKey: true, basePitch: 12 }, // C0 has index 12 on the MIDI scale. C7 is 96, and C9 is 120. C10 is barely in the audible range.\r\n        { name: \"C♯\", isWhiteKey: false, basePitch: 13 },\r\n        { name: \"D\", isWhiteKey: true, basePitch: 14 },\r\n        { name: \"D♯\", isWhiteKey: false, basePitch: 15 },\r\n        { name: \"E\", isWhiteKey: true, basePitch: 16 },\r\n        { name: \"F\", isWhiteKey: true, basePitch: 17 },\r\n        { name: \"F♯\", isWhiteKey: false, basePitch: 18 },\r\n        { name: \"G\", isWhiteKey: true, basePitch: 19 },\r\n        { name: \"G♯\", isWhiteKey: false, basePitch: 20 },\r\n        { name: \"A\", isWhiteKey: true, basePitch: 21 },\r\n        { name: \"A♯\", isWhiteKey: false, basePitch: 22 },\r\n        { name: \"B\", isWhiteKey: true, basePitch: 23 },\r\n    ]);\r\n    public static readonly blackKeyNameParents: ReadonlyArray<number> = [-1, 1, -1, 1, -1, 1, -1, -1, 1, -1, 1, -1];\r\n    public static readonly tempoMin: number = 30;\r\n    public static readonly tempoMax: number = 320;\r\n    public static readonly echoDelayRange: number = 24;\r\n    public static readonly echoDelayStepTicks: number = 4;\r\n    public static readonly echoSustainRange: number = 8;\r\n    public static readonly echoShelfHz: number = 4000.0; // The cutoff freq of the shelf filter that is used to decay echoes.\r\n    public static readonly echoShelfGain: number = Math.pow(2.0, -0.5);\r\n    public static readonly reverbShelfHz: number = 8000.0; // The cutoff freq of the shelf filter that is used to decay reverb.\r\n    public static readonly reverbShelfGain: number = Math.pow(2.0, -1.5);\r\n    public static readonly reverbRange: number = 32;\r\n    public static readonly reverbDelayBufferSize: number = 16384; // TODO: Compute a buffer size based on sample rate.\r\n    public static readonly reverbDelayBufferMask: number = Config.reverbDelayBufferSize - 1; // TODO: Compute a buffer size based on sample rate.\r\n    public static readonly beatsPerBarMin: number = 3;\r\n    public static readonly beatsPerBarMax: number = 16;\r\n    public static readonly barCountMin: number = 1;\r\n    public static readonly barCountMax: number = 256;\r\n    public static readonly instrumentCountMin: number = 1;\r\n    public static readonly layeredInstrumentCountMax: number = 4;\r\n    public static readonly patternInstrumentCountMax: number = 10;\r\n    public static readonly partsPerBeat: number = 24;\r\n    public static readonly ticksPerPart: number = 2;\r\n    public static readonly ticksPerArpeggio: number = 3;\r\n    public static readonly arpeggioPatterns: ReadonlyArray<ReadonlyArray<number>> = [[0], [0, 1], [0, 1, 2, 1], [0, 1, 2, 3], [0, 1, 2, 3, 4], [0, 1, 2, 3, 4, 5], [0, 1, 2, 3, 4, 5, 6], [0, 1, 2, 3, 4, 5, 6, 7]];\r\n    public static readonly rhythms: DictionaryArray<Rhythm> = toNameMap([\r\n        { name: \"÷3 (triplets)\", stepsPerBeat: 3, /*ticksPerArpeggio: 4, arpeggioPatterns: [[0], [0, 0, 1, 1], [0, 1, 2, 1], [0, 1, 2, 3]]*/ roundUpThresholds: [/*0*/ 5, /*8*/ 12, /*16*/ 18 /*24*/] },\r\n        { name: \"÷4 (standard)\", stepsPerBeat: 4, /*ticksPerArpeggio: 3, arpeggioPatterns: [[0], [0, 0, 1, 1], [0, 1, 2, 1], [0, 1, 2, 3]]*/ roundUpThresholds: [/*0*/ 3, /*6*/ 9, /*12*/ 17, /*18*/ 21 /*24*/] },\r\n        { name: \"÷6\", stepsPerBeat: 6, /*ticksPerArpeggio: 4, arpeggioPatterns: [[0], [0, 1], [0, 1, 2, 1], [0, 1, 2, 3]]*/ roundUpThresholds: null },\r\n        { name: \"÷8\", stepsPerBeat: 8, /*ticksPerArpeggio: 3, arpeggioPatterns: [[0], [0, 1], [0, 1, 2, 1], [0, 1, 2, 3]]*/ roundUpThresholds: null },\r\n        { name: \"freehand\", stepsPerBeat: 24, /*ticksPerArpeggio: 3, arpeggioPatterns: [[0], [0, 1], [0, 1, 2, 1], [0, 1, 2, 3]]*/ roundUpThresholds: null },\r\n    ]);\r\n\r\n    public static readonly instrumentTypeNames: ReadonlyArray<string> = [\"chip\", \"FM\", \"noise\", \"spectrum\", \"drumset\", \"harmonics\", \"PWM\", \"Picked String\", \"custom chip\", \"mod\"];\r\n    public static readonly instrumentTypeHasSpecialInterval: ReadonlyArray<boolean> = [true, true, false, false, false, true, false, false, false];\r\n    public static readonly chipBaseExpression: number = 0.03375; // Doubled by unison feature, but affected by expression adjustments per unison setting and wave shape.\r\n    public static readonly fmBaseExpression: number = 0.03;\r\n    public static readonly noiseBaseExpression: number = 0.19;\r\n    public static readonly spectrumBaseExpression: number = 0.3; // Spectrum can be in pitch or noise channels, the expression is doubled for noise.\r\n    public static readonly drumsetBaseExpression: number = 0.45; // Drums tend to be loud but brief!\r\n    public static readonly harmonicsBaseExpression: number = 0.025;\r\n    public static readonly pwmBaseExpression: number = 0.04725; // It's actually closer to half of this, the synthesized pulse amplitude range is only .5 to -.5, but also note that the fundamental sine partial amplitude of a square wave is 4/π times the measured square wave amplitude.\r\n    public static readonly pickedStringBaseExpression: number = 0.025; // Same as harmonics.\r\n    public static readonly distortionBaseVolume: number = 0.011; // Distortion is not affected by pitchDamping, which otherwise approximately halves expression for notes around the middle of the range.\r\n    public static readonly bitcrusherBaseVolume: number = 0.010; // Also not affected by pitchDamping, used when bit crushing is maxed out (aka \"1-bit\" output).\r\n\r\n    public static readonly rawChipWaves: DictionaryArray<ChipWave> = toNameMap([\r\n        { name: \"rounded\", expression: 0.94, samples: centerWave([0.0, 0.2, 0.4, 0.5, 0.6, 0.7, 0.8, 0.85, 0.9, 0.95, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.95, 0.9, 0.85, 0.8, 0.7, 0.6, 0.5, 0.4, 0.2, 0.0, -0.2, -0.4, -0.5, -0.6, -0.7, -0.8, -0.85, -0.9, -0.95, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -0.95, -0.9, -0.85, -0.8, -0.7, -0.6, -0.5, -0.4, -0.2]) },\r\n        { name: \"triangle\", expression: 1.0, samples: centerWave([1.0 / 15.0, 3.0 / 15.0, 5.0 / 15.0, 7.0 / 15.0, 9.0 / 15.0, 11.0 / 15.0, 13.0 / 15.0, 15.0 / 15.0, 15.0 / 15.0, 13.0 / 15.0, 11.0 / 15.0, 9.0 / 15.0, 7.0 / 15.0, 5.0 / 15.0, 3.0 / 15.0, 1.0 / 15.0, -1.0 / 15.0, -3.0 / 15.0, -5.0 / 15.0, -7.0 / 15.0, -9.0 / 15.0, -11.0 / 15.0, -13.0 / 15.0, -15.0 / 15.0, -15.0 / 15.0, -13.0 / 15.0, -11.0 / 15.0, -9.0 / 15.0, -7.0 / 15.0, -5.0 / 15.0, -3.0 / 15.0, -1.0 / 15.0]) },\r\n        { name: \"square\", expression: 0.5, samples: centerWave([1.0, -1.0]) },\r\n        { name: \"1/4 pulse\", expression: 0.5, samples: centerWave([1.0, -1.0, -1.0, -1.0]) },\r\n        { name: \"1/8 pulse\", expression: 0.5, samples: centerWave([1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0]) },\r\n        { name: \"sawtooth\", expression: 0.65, samples: centerWave([1.0 / 31.0, 3.0 / 31.0, 5.0 / 31.0, 7.0 / 31.0, 9.0 / 31.0, 11.0 / 31.0, 13.0 / 31.0, 15.0 / 31.0, 17.0 / 31.0, 19.0 / 31.0, 21.0 / 31.0, 23.0 / 31.0, 25.0 / 31.0, 27.0 / 31.0, 29.0 / 31.0, 31.0 / 31.0, -31.0 / 31.0, -29.0 / 31.0, -27.0 / 31.0, -25.0 / 31.0, -23.0 / 31.0, -21.0 / 31.0, -19.0 / 31.0, -17.0 / 31.0, -15.0 / 31.0, -13.0 / 31.0, -11.0 / 31.0, -9.0 / 31.0, -7.0 / 31.0, -5.0 / 31.0, -3.0 / 31.0, -1.0 / 31.0]) },\r\n        { name: \"double saw\", expression: 0.5, samples: centerWave([0.0, -0.2, -0.4, -0.6, -0.8, -1.0, 1.0, -0.8, -0.6, -0.4, -0.2, 1.0, 0.8, 0.6, 0.4, 0.2]) },\r\n        { name: \"double pulse\", expression: 0.4, samples: centerWave([1.0, 1.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0, 1.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0, -1.0]) },\r\n        { name: \"spiky\", expression: 0.4, samples: centerWave([1.0, -1.0, 1.0, -1.0, 1.0, 0.0]) },\r\n        { name: \"sine\", expression: 0.88, samples: centerAndNormalizeWave([8.0, 9.0, 11.0, 12.0, 13.0, 14.0, 15.0, 15.0, 15.0, 15.0, 14.0, 14.0, 13.0, 11.0, 10.0, 9.0, 7.0, 6.0, 4.0, 3.0, 2.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 1.0, 2.0, 4.0, 5.0, 6.0]) },\r\n        { name: \"flute\", expression: 0.8, samples: centerAndNormalizeWave([3.0, 4.0, 6.0, 8.0, 10.0, 11.0, 13.0, 14.0, 15.0, 15.0, 14.0, 13.0, 11.0, 8.0, 5.0, 3.0]) },\r\n        { name: \"harp\", expression: 0.8, samples: centerAndNormalizeWave([0.0, 3.0, 3.0, 3.0, 4.0, 5.0, 5.0, 6.0, 7.0, 8.0, 9.0, 11.0, 11.0, 13.0, 13.0, 15.0, 15.0, 14.0, 12.0, 11.0, 10.0, 9.0, 8.0, 7.0, 7.0, 5.0, 4.0, 3.0, 2.0, 1.0, 0.0, 0.0]) },\r\n        { name: \"sharp clarinet\", expression: 0.38, samples: centerAndNormalizeWave([0.0, 0.0, 0.0, 1.0, 1.0, 8.0, 8.0, 9.0, 9.0, 9.0, 8.0, 8.0, 8.0, 8.0, 8.0, 9.0, 9.0, 7.0, 9.0, 9.0, 10.0, 4.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]) },\r\n        { name: \"soft clarinet\", expression: 0.45, samples: centerAndNormalizeWave([0.0, 1.0, 5.0, 8.0, 9.0, 9.0, 9.0, 9.0, 9.0, 9.0, 9.0, 11.0, 11.0, 12.0, 13.0, 12.0, 10.0, 9.0, 7.0, 6.0, 4.0, 3.0, 3.0, 3.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0]) },\r\n        { name: \"alto sax\", expression: 0.3, samples: centerAndNormalizeWave([5.0, 5.0, 6.0, 4.0, 3.0, 6.0, 8.0, 7.0, 2.0, 1.0, 5.0, 6.0, 5.0, 4.0, 5.0, 7.0, 9.0, 11.0, 13.0, 14.0, 14.0, 14.0, 14.0, 13.0, 10.0, 8.0, 7.0, 7.0, 4.0, 3.0, 4.0, 2.0]) },\r\n        { name: \"bassoon\", expression: 0.35, samples: centerAndNormalizeWave([9.0, 9.0, 7.0, 6.0, 5.0, 4.0, 4.0, 4.0, 4.0, 5.0, 7.0, 8.0, 9.0, 10.0, 11.0, 13.0, 13.0, 11.0, 10.0, 9.0, 7.0, 6.0, 4.0, 2.0, 1.0, 1.0, 1.0, 2.0, 2.0, 5.0, 11.0, 14.0]) },\r\n        { name: \"trumpet\", expression: 0.22, samples: centerAndNormalizeWave([10.0, 11.0, 8.0, 6.0, 5.0, 5.0, 5.0, 6.0, 7.0, 7.0, 7.0, 7.0, 6.0, 6.0, 7.0, 7.0, 7.0, 7.0, 7.0, 6.0, 6.0, 6.0, 6.0, 6.0, 6.0, 6.0, 6.0, 7.0, 8.0, 9.0, 11.0, 14.0]) },\r\n        { name: \"electric guitar\", expression: 0.2, samples: centerAndNormalizeWave([11.0, 12.0, 12.0, 10.0, 6.0, 6.0, 8.0, 0.0, 2.0, 4.0, 8.0, 10.0, 9.0, 10.0, 1.0, 7.0, 11.0, 3.0, 6.0, 6.0, 8.0, 13.0, 14.0, 2.0, 0.0, 12.0, 8.0, 4.0, 13.0, 11.0, 10.0, 13.0]) },\r\n        { name: \"organ\", expression: 0.2, samples: centerAndNormalizeWave([11.0, 10.0, 12.0, 11.0, 14.0, 7.0, 5.0, 5.0, 12.0, 10.0, 10.0, 9.0, 12.0, 6.0, 4.0, 5.0, 13.0, 12.0, 12.0, 10.0, 12.0, 5.0, 2.0, 2.0, 8.0, 6.0, 6.0, 5.0, 8.0, 3.0, 2.0, 1.0]) },\r\n        { name: \"pan flute\", expression: 0.35, samples: centerAndNormalizeWave([1.0, 4.0, 7.0, 6.0, 7.0, 9.0, 7.0, 7.0, 11.0, 12.0, 13.0, 15.0, 13.0, 11.0, 11.0, 12.0, 13.0, 10.0, 7.0, 5.0, 3.0, 6.0, 10.0, 7.0, 3.0, 3.0, 1.0, 0.0, 1.0, 0.0, 1.0, 0.0]) },\r\n        { name: \"glitch\", expression: 0.5, samples: centerWave([1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -1.0, -1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0, -1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0, -1.0, -1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0, -1.0, -1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0, -1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -1.0, -1.0]) },\r\n    ]);\r\n    public static readonly chipWaves: DictionaryArray<ChipWave> = rawChipToIntegrated(Config.rawChipWaves);\r\n    // Noise waves have too many samples to write by hand, they're generated on-demand by getDrumWave instead.\r\n    public static readonly chipNoises: DictionaryArray<ChipNoise> = toNameMap([\r\n        { name: \"retro\", expression: 0.25, basePitch: 69, pitchFilterMult: 1024.0, isSoft: false, samples: null },\r\n        { name: \"white\", expression: 1.0, basePitch: 69, pitchFilterMult: 8.0, isSoft: true, samples: null },\r\n        // The \"clang\" and \"buzz\" noises are based on similar noises in the modded beepbox! :D\r\n        { name: \"clang\", expression: 0.4, basePitch: 69, pitchFilterMult: 1024.0, isSoft: false, samples: null },\r\n        { name: \"buzz\", expression: 0.3, basePitch: 69, pitchFilterMult: 1024.0, isSoft: false, samples: null },\r\n        { name: \"hollow\", expression: 1.5, basePitch: 96, pitchFilterMult: 1.0, isSoft: true, samples: null },\r\n        { name: \"shine\", expression: 1.0, basePitch: 69, pitchFilterMult: 1024.0, isSoft: false, samples: null },\r\n        { name: \"deep\", expression: 1.5, basePitch: 120, pitchFilterMult: 1024.0, isSoft: true, samples: null },\r\n        { name: \"cutter\", expression: 0.005, basePitch: 96, pitchFilterMult: 1024.0, isSoft: false, samples: null },\r\n        { name: \"metallic\", expression: 1.0, basePitch: 96, pitchFilterMult: 1024.0, isSoft: false, samples: null },\r\n    ]);\r\n\r\n    public static readonly filterFreqStep: number = 1.0 / 4.0;\r\n    public static readonly filterFreqRange: number = 34;\r\n    public static readonly filterFreqReferenceSetting: number = 28;\r\n    public static readonly filterFreqReferenceHz: number = 8000.0;\r\n    public static readonly filterFreqMaxHz: number = Config.filterFreqReferenceHz * Math.pow(2.0, Config.filterFreqStep * (Config.filterFreqRange - 1 - Config.filterFreqReferenceSetting)); // ~19khz\r\n    public static readonly filterFreqMinHz: number = 8.0;\r\n    public static readonly filterGainRange: number = 15;\r\n    public static readonly filterGainCenter: number = 7;\r\n    public static readonly filterGainStep: number = 1.0 / 2.0;\r\n    public static readonly filterMaxPoints: number = 8;\r\n    public static readonly filterTypeNames: ReadonlyArray<string> = [\"low-pass\", \"high-pass\", \"peak\"]; // See FilterType enum above.\r\n    public static readonly filterMorphCount: number = 10; // Number of filter shapes allowed for modulating between. Counts the 0/default position.\r\n\r\n    public static readonly filterSimpleCutRange: number = 11;\r\n    public static readonly filterSimplePeakRange: number = 8;\r\n\r\n    public static readonly fadeInRange: number = 10;\r\n    public static readonly fadeOutTicks: ReadonlyArray<number> = [-24, -12, -6, -3, -1, 6, 12, 24, 48, 72, 96];\r\n    public static readonly fadeOutNeutral: number = 4;\r\n    public static readonly drumsetFadeOutTicks: number = 48;\r\n    public static readonly transitions: DictionaryArray<Transition> = toNameMap([\r\n        { name: \"normal\", isSeamless: false, continues: false, slides: false, slideTicks: 3, includeAdjacentPatterns: false },\r\n        { name: \"interrupt\", isSeamless: true, continues: false, slides: false, slideTicks: 3, includeAdjacentPatterns: true },\r\n        { name: \"continue\", isSeamless: true, continues: true, slides: false, slideTicks: 3, includeAdjacentPatterns: true },\r\n        { name: \"slide\", isSeamless: true, continues: false, slides: true, slideTicks: 3, includeAdjacentPatterns: true },\r\n        { name: \"slide in pattern\", isSeamless: true, continues: false, slides: true, slideTicks: 3, includeAdjacentPatterns: false },\r\n    ]);\r\n    public static readonly vibratos: DictionaryArray<Vibrato> = toNameMap([\r\n        { name: \"none\", amplitude: 0.0, type: 0, delayTicks: 0 },\r\n        { name: \"light\", amplitude: 0.15, type: 0, delayTicks: 0 },\r\n        { name: \"delayed\", amplitude: 0.3, type: 0, delayTicks: 37 }, // It will fade in over the previous two ticks.\r\n        { name: \"heavy\", amplitude: 0.45, type: 0, delayTicks: 0 },\r\n        { name: \"shaky\", amplitude: 0.1, type: 1, delayTicks: 0 },\r\n    ]);\r\n    public static readonly vibratoTypes: DictionaryArray<VibratoType> = toNameMap([\r\n        { name: \"normal\", periodsSeconds: [0.14], period: 0.14 },\r\n        { name: \"shaky\", periodsSeconds: [0.11, 1.618 * 0.11, 3 * 0.11], period: 266.97 }, // LCM of all periods\r\n    ]);\r\n    // This array is more or less a linear step by 0.1 but there's a bit of range added at the start to hit specific ratios, and the end starts to grow faster.\r\n    //                                                             0       1      2    3     4      5    6    7      8     9   10   11 12   13   14   15   16   17   18   19   20   21 22   23   24   25   26   27   28   29   30   31 32   33   34   35   36   37   38    39  40   41 42    43   44   45   46 47   48 49 50\r\n    public static readonly arpSpeedScale: ReadonlyArray<number> = [0, 0.0625, 0.125, 0.2, 0.25, 1 / 3, 0.4, 0.5, 2 / 3, 0.75, 0.8, 0.9, 1, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 2, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 3, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8, 3.9, 4, 4.15, 4.3, 4.5, 4.8, 5, 5.5, 6, 8];\r\n\r\n    public static readonly unisons: DictionaryArray<Unison> = toNameMap([\r\n        { name: \"none\", voices: 1, spread: 0.0, offset: 0.0, expression: 1.4, sign: 1.0 },\r\n        { name: \"shimmer\", voices: 2, spread: 0.018, offset: 0.0, expression: 0.8, sign: 1.0 },\r\n        { name: \"hum\", voices: 2, spread: 0.045, offset: 0.0, expression: 1.0, sign: 1.0 },\r\n        { name: \"honky tonk\", voices: 2, spread: 0.09, offset: 0.0, expression: 1.0, sign: 1.0 },\r\n        { name: \"dissonant\", voices: 2, spread: 0.25, offset: 0.0, expression: 0.9, sign: 1.0 },\r\n        { name: \"fifth\", voices: 2, spread: 3.5, offset: 3.5, expression: 0.9, sign: 1.0 },\r\n        { name: \"octave\", voices: 2, spread: 6.0, offset: 6.0, expression: 0.8, sign: 1.0 },\r\n        { name: \"bowed\", voices: 2, spread: 0.02, offset: 0.0, expression: 1.0, sign: -1.0 },\r\n        { name: \"piano\", voices: 2, spread: 0.01, offset: 0.0, expression: 1.0, sign: 0.7 },\r\n        { name: \"warbled\", voices: 2, spread: 0.25, offset: 0.05, expression: 0.9, sign: -0.8 },\r\n    ]);\r\n    public static readonly effectNames: ReadonlyArray<string> = [\"reverb\", \"chorus\", \"panning\", \"distortion\", \"bitcrusher\", \"note filter\", \"echo\", \"pitch shift\", \"detune\", \"vibrato\", \"transition type\", \"chord type\"];\r\n    public static readonly effectOrder: ReadonlyArray<EffectType> = [EffectType.panning, EffectType.transition, EffectType.chord, EffectType.pitchShift, EffectType.detune, EffectType.vibrato, EffectType.noteFilter, EffectType.distortion, EffectType.bitcrusher, EffectType.chorus, EffectType.echo, EffectType.reverb];\r\n    public static readonly noteSizeMax: number = 6;\r\n    public static readonly volumeRange: number = 50;\r\n    // Beepbox's old volume scale used factor -0.5 and was [0~7] had roughly value 6 = 0.125 power. This new value is chosen to have -21 be the same,\r\n    // given that the new scale is [-25~25]. This is such that conversion between the scales is roughly equivalent by satisfying (0.5*6 = 0.1428*21)\t\r\n    public static readonly volumeLogScale: number = 0.1428;\r\n    public static readonly panCenter: number = 50;\r\n    public static readonly panMax: number = Config.panCenter * 2;\r\n    public static readonly panDelaySecondsMax: number = 0.001;\r\n    public static readonly chorusRange: number = 8;\r\n    public static readonly chorusPeriodSeconds: number = 2.0;\r\n    public static readonly chorusDelayRange: number = 0.0034;\r\n    public static readonly chorusDelayOffsets: ReadonlyArray<ReadonlyArray<number>> = [[1.51, 2.10, 3.35], [1.47, 2.15, 3.25]];\r\n    public static readonly chorusPhaseOffsets: ReadonlyArray<ReadonlyArray<number>> = [[0.0, 2.1, 4.2], [3.2, 5.3, 1.0]];\r\n    public static readonly chorusMaxDelay: number = Config.chorusDelayRange * (1.0 + Config.chorusDelayOffsets[0].concat(Config.chorusDelayOffsets[1]).reduce((x, y) => Math.max(x, y)));\r\n    public static readonly chords: DictionaryArray<Chord> = toNameMap([\r\n        { name: \"simultaneous\", customInterval: false, arpeggiates: false, strumParts: 0, singleTone: false },\r\n        { name: \"strum\", customInterval: false, arpeggiates: false, strumParts: 1, singleTone: false },\r\n        { name: \"arpeggio\", customInterval: false, arpeggiates: true, strumParts: 0, singleTone: true },\r\n        { name: \"custom interval\", customInterval: true, arpeggiates: false, strumParts: 0, singleTone: true },\r\n    ]);\r\n    public static readonly maxChordSize: number = 9;\r\n    public static readonly operatorCount: number = 4;\r\n\tpublic static readonly maxPitchOrOperatorCount: number = Math.max(Config.maxChordSize, Config.operatorCount);\r\n    public static readonly algorithms: DictionaryArray<Algorithm> = toNameMap([\r\n        { name: \"1←(2 3 4)\", carrierCount: 1, associatedCarrier: [1, 1, 1, 1], modulatedBy: [[2, 3, 4], [], [], []] },\r\n        { name: \"1←(2 3←4)\", carrierCount: 1, associatedCarrier: [1, 1, 1, 1], modulatedBy: [[2, 3], [], [4], []] },\r\n        { name: \"1←2←(3 4)\", carrierCount: 1, associatedCarrier: [1, 1, 1, 1], modulatedBy: [[2], [3, 4], [], []] },\r\n        { name: \"1←(2 3)←4\", carrierCount: 1, associatedCarrier: [1, 1, 1, 1], modulatedBy: [[2, 3], [4], [4], []] },\r\n        { name: \"1←2←3←4\", carrierCount: 1, associatedCarrier: [1, 1, 1, 1], modulatedBy: [[2], [3], [4], []] },\r\n        { name: \"1←3 2←4\", carrierCount: 2, associatedCarrier: [1, 2, 1, 2], modulatedBy: [[3], [4], [], []] },\r\n        { name: \"1 2←(3 4)\", carrierCount: 2, associatedCarrier: [1, 2, 2, 2], modulatedBy: [[], [3, 4], [], []] },\r\n        { name: \"1 2←3←4\", carrierCount: 2, associatedCarrier: [1, 2, 2, 2], modulatedBy: [[], [3], [4], []] },\r\n        { name: \"(1 2)←3←4\", carrierCount: 2, associatedCarrier: [1, 2, 2, 2], modulatedBy: [[3], [3], [4], []] },\r\n        { name: \"(1 2)←(3 4)\", carrierCount: 2, associatedCarrier: [1, 2, 2, 2], modulatedBy: [[3, 4], [3, 4], [], []] },\r\n        { name: \"1 2 3←4\", carrierCount: 3, associatedCarrier: [1, 2, 3, 3], modulatedBy: [[], [], [4], []] },\r\n        { name: \"(1 2 3)←4\", carrierCount: 3, associatedCarrier: [1, 2, 3, 3], modulatedBy: [[4], [4], [4], []] },\r\n        { name: \"1 2 3 4\", carrierCount: 4, associatedCarrier: [1, 2, 3, 4], modulatedBy: [[], [], [], []] },\r\n    ]);\r\n    public static readonly operatorCarrierInterval: ReadonlyArray<number> = [0.0, 0.04, -0.073, 0.091];\r\n    public static readonly operatorAmplitudeMax: number = 15;\r\n    public static readonly operatorFrequencies: DictionaryArray<OperatorFrequency> = toNameMap([\r\n        { name: \"1×\", mult: 1.0, hzOffset: 0.0, amplitudeSign: 1.0 },\r\n        { name: \"~1×\", mult: 1.0, hzOffset: 1.5, amplitudeSign: -1.0 },\r\n        { name: \"2×\", mult: 2.0, hzOffset: 0.0, amplitudeSign: 1.0 },\r\n        { name: \"~2×\", mult: 2.0, hzOffset: -1.3, amplitudeSign: -1.0 },\r\n        { name: \"3×\", mult: 3.0, hzOffset: 0.0, amplitudeSign: 1.0 },\r\n        { name: \"4×\", mult: 4.0, hzOffset: 0.0, amplitudeSign: 1.0 },\r\n        { name: \"5×\", mult: 5.0, hzOffset: 0.0, amplitudeSign: 1.0 },\r\n        { name: \"6×\", mult: 6.0, hzOffset: 0.0, amplitudeSign: 1.0 },\r\n        { name: \"7×\", mult: 7.0, hzOffset: 0.0, amplitudeSign: 1.0 },\r\n        { name: \"8×\", mult: 8.0, hzOffset: 0.0, amplitudeSign: 1.0 },\r\n        { name: \"9×\", mult: 9.0, hzOffset: 0.0, amplitudeSign: 1.0 },\r\n        { name: \"11×\", mult: 11.0, hzOffset: 0.0, amplitudeSign: 1.0 },\r\n        { name: \"13×\", mult: 13.0, hzOffset: 0.0, amplitudeSign: 1.0 },\r\n        { name: \"16×\", mult: 16.0, hzOffset: 0.0, amplitudeSign: 1.0 },\r\n        { name: \"20×\", mult: 20.0, hzOffset: 0.0, amplitudeSign: 1.0 },\r\n    ]);\r\n    public static readonly envelopes: DictionaryArray<Envelope> = toNameMap([\r\n        { name: \"none\", type: EnvelopeType.none, speed: 0.0 },\r\n        { name: \"note size\", type: EnvelopeType.noteSize, speed: 0.0 },\r\n        { name: \"punch\", type: EnvelopeType.punch, speed: 0.0 },\r\n        { name: \"flare 1\", type: EnvelopeType.flare, speed: 32.0 },\r\n        { name: \"flare 2\", type: EnvelopeType.flare, speed: 8.0 },\r\n        { name: \"flare 3\", type: EnvelopeType.flare, speed: 2.0 },\r\n        { name: \"twang 1\", type: EnvelopeType.twang, speed: 32.0 },\r\n        { name: \"twang 2\", type: EnvelopeType.twang, speed: 8.0 },\r\n        { name: \"twang 3\", type: EnvelopeType.twang, speed: 2.0 },\r\n        { name: \"swell 1\", type: EnvelopeType.swell, speed: 32.0 },\r\n        { name: \"swell 2\", type: EnvelopeType.swell, speed: 8.0 },\r\n        { name: \"swell 3\", type: EnvelopeType.swell, speed: 2.0 },\r\n        { name: \"tremolo1\", type: EnvelopeType.tremolo, speed: 4.0 },\r\n        { name: \"tremolo2\", type: EnvelopeType.tremolo, speed: 2.0 },\r\n        { name: \"tremolo3\", type: EnvelopeType.tremolo, speed: 1.0 },\r\n        { name: \"tremolo4\", type: EnvelopeType.tremolo2, speed: 4.0 },\r\n        { name: \"tremolo5\", type: EnvelopeType.tremolo2, speed: 2.0 },\r\n        { name: \"tremolo6\", type: EnvelopeType.tremolo2, speed: 1.0 },\r\n        { name: \"decay 1\", type: EnvelopeType.decay, speed: 10.0 },\r\n        { name: \"decay 2\", type: EnvelopeType.decay, speed: 7.0 },\r\n        { name: \"decay 3\", type: EnvelopeType.decay, speed: 4.0 },\r\n    ]);\r\n    public static readonly feedbacks: DictionaryArray<Feedback> = toNameMap([\r\n        { name: \"1⟲\", indices: [[1], [], [], []] },\r\n        { name: \"2⟲\", indices: [[], [2], [], []] },\r\n        { name: \"3⟲\", indices: [[], [], [3], []] },\r\n        { name: \"4⟲\", indices: [[], [], [], [4]] },\r\n        { name: \"1⟲ 2⟲\", indices: [[1], [2], [], []] },\r\n        { name: \"3⟲ 4⟲\", indices: [[], [], [3], [4]] },\r\n        { name: \"1⟲ 2⟲ 3⟲\", indices: [[1], [2], [3], []] },\r\n        { name: \"2⟲ 3⟲ 4⟲\", indices: [[], [2], [3], [4]] },\r\n        { name: \"1⟲ 2⟲ 3⟲ 4⟲\", indices: [[1], [2], [3], [4]] },\r\n        { name: \"1→2\", indices: [[], [1], [], []] },\r\n        { name: \"1→3\", indices: [[], [], [1], []] },\r\n        { name: \"1→4\", indices: [[], [], [], [1]] },\r\n        { name: \"2→3\", indices: [[], [], [2], []] },\r\n        { name: \"2→4\", indices: [[], [], [], [2]] },\r\n        { name: \"3→4\", indices: [[], [], [], [3]] },\r\n        { name: \"1→3 2→4\", indices: [[], [], [1], [2]] },\r\n        { name: \"1→4 2→3\", indices: [[], [], [2], [1]] },\r\n        { name: \"1→2→3→4\", indices: [[], [1], [2], [3]] },\r\n    ]);\r\n    public static readonly chipNoiseLength: number = 1 << 15; // 32768\r\n    public static readonly spectrumNoiseLength: number = 1 << 15; // 32768\r\n    public static readonly spectrumBasePitch: number = 24;\r\n    public static readonly spectrumControlPoints: number = 30;\r\n    public static readonly spectrumControlPointsPerOctave: number = 7;\r\n    public static readonly spectrumControlPointBits: number = 3;\r\n    public static readonly spectrumMax: number = (1 << Config.spectrumControlPointBits) - 1;\r\n    public static readonly harmonicsControlPoints: number = 28;\r\n    public static readonly harmonicsRendered: number = 64;\r\n    public static readonly harmonicsRenderedForPickedString: number = 1 << 8; // 256\r\n    public static readonly harmonicsControlPointBits: number = 3;\r\n    public static readonly harmonicsMax: number = (1 << Config.harmonicsControlPointBits) - 1;\r\n    public static readonly harmonicsWavelength: number = 1 << 11; // 2048\r\n    public static readonly pulseWidthRange: number = 50;\r\n    public static readonly pulseWidthStepPower: number = 0.5;\r\n    public static readonly pitchChannelCountMin: number = 1;\r\n    public static readonly pitchChannelCountMax: number = 40;\r\n    public static readonly noiseChannelCountMin: number = 0;\r\n    public static readonly noiseChannelCountMax: number = 16;\r\n    public static readonly modChannelCountMin: number = 0;\r\n    public static readonly modChannelCountMax: number = 12;\r\n    public static readonly noiseInterval: number = 6;\r\n    public static readonly pitchesPerOctave: number = 12; // TODO: Use this for converting pitch to frequency.\r\n    public static readonly drumCount: number = 12;\r\n    public static readonly pitchOctaves: number = 8;\r\n    public static readonly modCount: number = 6;\r\n    public static readonly maxPitch: number = Config.pitchOctaves * Config.pitchesPerOctave;\r\n    public static readonly maximumTonesPerChannel: number = Config.maxChordSize * 2;\r\n    public static readonly justIntonationSemitones: number[] = [1.0 / 2.0, 8.0 / 15.0, 9.0 / 16.0, 3.0 / 5.0, 5.0 / 8.0, 2.0 / 3.0, 32.0 / 45.0, 3.0 / 4.0, 4.0 / 5.0, 5.0 / 6.0, 8.0 / 9.0, 15.0 / 16.0, 1.0, 16.0 / 15.0, 9.0 / 8.0, 6.0 / 5.0, 5.0 / 4.0, 4.0 / 3.0, 45.0 / 32.0, 3.0 / 2.0, 8.0 / 5.0, 5.0 / 3.0, 16.0 / 9.0, 15.0 / 8.0, 2.0].map(x => Math.log2(x) * Config.pitchesPerOctave);\r\n    public static readonly pitchShiftRange: number = Config.justIntonationSemitones.length;\r\n    public static readonly pitchShiftCenter: number = Config.pitchShiftRange >> 1;\r\n    public static readonly detuneCenter: number = 200;\r\n    public static readonly detuneMax: number = 400;\r\n    public static readonly detuneMin: number = 0;\r\n    public static readonly songDetuneMin: number = 0;\r\n    public static readonly songDetuneMax: number = 500;\r\n    public static readonly sineWaveLength: number = 1 << 8; // 256\r\n    public static readonly sineWaveMask: number = Config.sineWaveLength - 1;\r\n    public static readonly sineWave: Float32Array = generateSineWave();\r\n\r\n    // Picked strings have an all-pass filter with a corner frequency based on the tone fundamental frequency, in order to add a slight inharmonicity. (Which is important for distortion.)\r\n    public static readonly pickedStringDispersionCenterFreq: number = 6000.0; // The tone fundamental freq is pulled toward this freq for computing the all-pass corner freq.\r\n    public static readonly pickedStringDispersionFreqScale: number = 0.3; // The tone fundamental freq freq moves this much toward the center freq for computing the all-pass corner freq.\r\n    public static readonly pickedStringDispersionFreqMult: number = 4.0; // The all-pass corner freq is based on this times the adjusted tone fundamental freq.\r\n    public static readonly pickedStringShelfHz: number = 4000.0; // The cutoff freq of the shelf filter that is used to decay the high frequency energy in the picked string.\r\n\r\n    public static readonly distortionRange: number = 8;\r\n    public static readonly stringSustainRange: number = 15;\r\n    public static readonly stringDecayRate: number = 0.12;\r\n    public static readonly bitcrusherFreqRange: number = 14;\r\n    public static readonly bitcrusherOctaveStep: number = 0.5;\r\n    public static readonly bitcrusherQuantizationRange: number = 8;\r\n\r\n    public static readonly maxEnvelopeCount: number = 12;\r\n    public static readonly defaultAutomationRange: number = 13;\r\n    public static readonly instrumentAutomationTargets: DictionaryArray<AutomationTarget> = toNameMap([\r\n        { name: \"none\", computeIndex: null, displayName: \"none\",             /*perNote: false,*/ interleave: false, isFilter: false, /*range: 0,                              */    maxCount: 1, effect: null, compatibleInstruments: null },\r\n        { name: \"noteVolume\", computeIndex: EnvelopeComputeIndex.noteVolume, displayName: \"note volume\",      /*perNote:  true,*/ interleave: false, isFilter: false, /*range: Config.volumeRange,             */    maxCount: 1, effect: null, compatibleInstruments: null },\r\n        { name: \"pulseWidth\", computeIndex: EnvelopeComputeIndex.pulseWidth, displayName: \"pulse width\",      /*perNote:  true,*/ interleave: false, isFilter: false, /*range: Config.pulseWidthRange,         */    maxCount: 1, effect: null, compatibleInstruments: [InstrumentType.pwm] },\r\n        { name: \"stringSustain\", computeIndex: EnvelopeComputeIndex.stringSustain, displayName: \"sustain\",          /*perNote:  true,*/ interleave: false, isFilter: false, /*range: Config.stringSustainRange,      */    maxCount: 1, effect: null, compatibleInstruments: [InstrumentType.pickedString] },\r\n        { name: \"unison\", computeIndex: EnvelopeComputeIndex.unison, displayName: \"unison\",           /*perNote:  true,*/ interleave: false, isFilter: false, /*range: Config.defaultAutomationRange,  */    maxCount: 1, effect: null, compatibleInstruments: [InstrumentType.chip, InstrumentType.harmonics, InstrumentType.pickedString] },\r\n        { name: \"operatorFrequency\", computeIndex: EnvelopeComputeIndex.operatorFrequency0, displayName: \"fm# freq\",         /*perNote:  true,*/ interleave: true, isFilter: false, /*range: Config.defaultAutomationRange,  */    maxCount: Config.operatorCount, effect: null, compatibleInstruments: [InstrumentType.fm] },\r\n        { name: \"operatorAmplitude\", computeIndex: EnvelopeComputeIndex.operatorAmplitude0, displayName: \"fm# volume\",       /*perNote:  true,*/ interleave: false, isFilter: false, /*range: Config.operatorAmplitudeMax + 1,*/    maxCount: Config.operatorCount, effect: null, compatibleInstruments: [InstrumentType.fm] },\r\n        { name: \"feedbackAmplitude\", computeIndex: EnvelopeComputeIndex.feedbackAmplitude, displayName: \"fm feedback\",      /*perNote:  true,*/ interleave: false, isFilter: false, /*range: Config.operatorAmplitudeMax + 1,*/    maxCount: 1, effect: null, compatibleInstruments: [InstrumentType.fm] },\r\n        { name: \"pitchShift\", computeIndex: EnvelopeComputeIndex.pitchShift, displayName: \"pitch shift\",      /*perNote:  true,*/ interleave: false, isFilter: false, /*range: Config.pitchShiftRange,         */    maxCount: 1, effect: EffectType.pitchShift, compatibleInstruments: null },\r\n        { name: \"detune\", computeIndex: EnvelopeComputeIndex.detune, displayName: \"detune\",           /*perNote:  true,*/ interleave: false, isFilter: false, /*range: Config.detuneMax + 1,           */    maxCount: 1, effect: EffectType.detune, compatibleInstruments: null },\r\n        { name: \"vibratoDepth\", computeIndex: EnvelopeComputeIndex.vibratoDepth, displayName: \"vibrato range\",    /*perNote:  true,*/ interleave: false, isFilter: false, /*range: Config.defaultAutomationRange,  */    maxCount: 1, effect: EffectType.vibrato, compatibleInstruments: null },\r\n        { name: \"noteFilterAllFreqs\", computeIndex: EnvelopeComputeIndex.noteFilterAllFreqs, displayName: \"n. filter freqs\",  /*perNote:  true,*/ interleave: false, isFilter: true, /*range: null,                           */    maxCount: 1, effect: EffectType.noteFilter, compatibleInstruments: null },\r\n        { name: \"noteFilterFreq\", computeIndex: EnvelopeComputeIndex.noteFilterFreq0, displayName: \"n. filter # freq\", /*perNote:  true,*/ interleave: false/*true*/, isFilter: true, /*range: Config.filterFreqRange,     */        maxCount: Config.filterMaxPoints, effect: EffectType.noteFilter, compatibleInstruments: null },\r\n        // Controlling filter gain is less obvious and intuitive than controlling filter freq, so to avoid confusion I've disabled it for now...\r\n        //{name: \"noteFilterGain\",         computeIndex:       EnvelopeComputeIndex.noteFilterGain0,        displayName: \"n. filter # vol\",  /*perNote:  true,*/ interleave: false, isFilter:  true, range: Config.filterGainRange,             maxCount: Config.filterMaxPoints, effect: EffectType.noteFilter, compatibleInstruments: null},\r\n        /*\r\n        {name: \"distortion\",             computeIndex: InstrumentAutomationIndex.distortion,             displayName: \"distortion\",       perNote: false, interleave: false, isFilter: false, range: Config.distortionRange,             maxCount: 1,    effect: EffectType.distortion,   compatibleInstruments: null},\r\n        {name: \"bitcrusherQuantization\", computeIndex: InstrumentAutomationIndex.bitcrusherQuantization, displayName: \"bit crush\",        perNote: false, interleave: false, isFilter: false, range: Config.bitcrusherQuantizationRange, maxCount: 1,    effect: EffectType.bitcrusher,   compatibleInstruments: null},\r\n        {name: \"bitcrusherFrequency\",    computeIndex: InstrumentAutomationIndex.bitcrusherFrequency,    displayName: \"freq crush\",       perNote: false, interleave: false, isFilter: false, range: Config.bitcrusherFreqRange,         maxCount: 1,    effect: EffectType.bitcrusher,   compatibleInstruments: null},\r\n        {name: \"eqFilterAllFreqs\",       computeIndex: InstrumentAutomationIndex.eqFilterAllFreqs,       displayName: \"eq filter freqs\",  perNote: false, interleave: false, isFilter:  true, range: null,                               maxCount: 1,    effect: null,                    compatibleInstruments: null},\r\n        {name: \"eqFilterFreq\",           computeIndex: InstrumentAutomationIndex.eqFilterFreq0,          displayName: \"eq filter # freq\", perNote: false, interleave:  true, isFilter:  true, range: Config.filterFreqRange,             maxCount: Config.filterMaxPoints, effect: null,  compatibleInstruments: null},\r\n        {name: \"eqFilterGain\",           computeIndex: InstrumentAutomationIndex.eqFilterGain0,          displayName: \"eq filter # vol\",  perNote: false, interleave: false, isFilter:  true, range: Config.filterGainRange,             maxCount: Config.filterMaxPoints, effect: null,  compatibleInstruments: null},\r\n        {name: \"panning\",                computeIndex: InstrumentAutomationIndex.panning,                displayName: \"panning\",          perNote: false, interleave: false, isFilter: false, range: Config.panMax + 1,                  maxCount: 1,    effect: EffectType.panning,      compatibleInstruments: null},\r\n        {name: \"chorus\",                 computeIndex: InstrumentAutomationIndex.chorus,                 displayName: \"chorus\",           perNote: false, interleave: false, isFilter: false, range: Config.chorusRange,                 maxCount: 1,    effect: EffectType.chorus,       compatibleInstruments: null},\r\n        {name: \"echoSustain\",            computeIndex: InstrumentAutomationIndex.echoSustain,            displayName: \"echo\",             perNote: false, interleave: false, isFilter: false, range: Config.echoSustainRange,            maxCount: 1,    effect: EffectType.echo,         compatibleInstruments: null},\r\n        {name: \"echoDelay\",              computeIndex: InstrumentAutomationIndex.echoDelay,              displayName: \"echo delay\",       perNote: false, interleave: false, isFilter: false, range: Config.echoDelayRange,              maxCount: 1,    effect: EffectType.echo,         compatibleInstruments: null}, // wait until after we're computing a tick's settings for multiple run lengths.\r\n        {name: \"reverb\",                 computeIndex: InstrumentAutomationIndex.reverb,                 displayName: \"reverb\",           perNote: false, interleave: false, isFilter: false, range: Config.reverbRange,                 maxCount: 1,    effect: EffectType.reverb,       compatibleInstruments: null},\r\n        {name: \"mixVolume\",              computeIndex: InstrumentAutomationIndex.mixVolume,              displayName: \"mix volume\",       perNote: false, interleave: false, isFilter: false, range: Config.volumeRange,                 maxCount: 1,    effect: null,                    compatibleInstruments: null},\r\n        {name: \"envelope#\",              computeIndex: null,                                             displayName: \"envelope\",         perNote: false, interleave: false, isFilter: false, range: Config.defaultAutomationRange,      maxCount: Config.maxEnvelopeCount, effect: null, compatibleInstruments: null}, // maxCount special case for envelopes to be allowed to target earlier ones.\r\n        */\r\n    ]);\r\n    public static readonly operatorWaves: DictionaryArray<OperatorWave> = toNameMap([\r\n        { name: \"sine\", samples: Config.sineWave },\r\n        { name: \"triangle\", samples: generateTriWave() },\r\n        { name: \"sawtooth\", samples: generateSawWave() },\r\n        { name: \"pulse width\", samples: generateSquareWave() },\r\n        { name: \"ramp\", samples: generateSawWave(true) },\r\n        { name: \"trapezoid\", samples: generateTrapezoidWave(2) },\r\n    ]);\r\n    public static readonly pwmOperatorWaves: DictionaryArray<OperatorWave> = toNameMap([\r\n        { name: \"1%\", samples: generateSquareWave(0.01) },\r\n        { name: \"5%\", samples: generateSquareWave(0.05) },\r\n        { name: \"12.5%\", samples: generateSquareWave(0.125) },\r\n        { name: \"25%\", samples: generateSquareWave(0.25) },\r\n        { name: \"33%\", samples: generateSquareWave(1 / 3) },\r\n        { name: \"50%\", samples: generateSquareWave(0.5) },\r\n        { name: \"66%\", samples: generateSquareWave(2 / 3) },\r\n        { name: \"75%\", samples: generateSquareWave(0.75) },\r\n        { name: \"87.5%\", samples: generateSquareWave(0.875) },\r\n        { name: \"95%\", samples: generateSquareWave(0.95) },\r\n        { name: \"99%\", samples: generateSquareWave(0.99) },\r\n    ]);\r\n\r\n\r\n    // Height of the small editor column for inserting/deleting rows, in pixels.\r\n    public static readonly barEditorHeight: number = 10;\r\n\r\n    // Careful about changing index ordering for this. Index is stored in URL/JSON etc.\r\n    public static readonly modulators: DictionaryArray<Modulator> = toNameMap([\r\n        { name: \"none\", pianoName: \"None\", maxRawVol: 6, newNoteVol: 6, forSong: true, convertRealFactor: 0, associatedEffect: EffectType.length,\r\n            promptName: \"No Mod Setting\", promptDesc: [ \"No setting has been chosen yet, so this modulator will have no effect. Try choosing a setting with the dropdown, then click this '?' again for more info.\", \"[$LO - $HI]\" ] },\r\n        { name: \"song volume\", pianoName: \"Volume\", maxRawVol: 100, newNoteVol: 100, forSong: true, convertRealFactor: 0, associatedEffect: EffectType.length,\r\n            promptName: \"Song Volume\", promptDesc: [ \"This setting affects the overall volume of the song, just like the main volume slider.\", \"At $HI, the volume will be unchanged from default, and it will get gradually quieter down to $LO.\", \"[MULTIPLICATIVE] [$LO - $HI] [%]\" ] },\r\n        { name: \"tempo\", pianoName: \"Tempo\", maxRawVol: Config.tempoMax - Config.tempoMin, newNoteVol: Math.ceil((Config.tempoMax - Config.tempoMin) / 2), forSong: true, convertRealFactor: Config.tempoMin, associatedEffect: EffectType.length,\r\n            promptName: \"Song Tempo\", promptDesc: [ \"This setting controls the speed your song plays at, just like the tempo slider.\", \"When you first make a note for this setting, it will default to your current tempo. Raising it speeds up the song, up to $HI BPM, and lowering it slows it down, to a minimum of $LO BPM.\", \"Note that you can make a 'swing' effect by rapidly changing between two tempo values.\", \"[OVERWRITING] [$LO - $HI] [BPM]\" ] },\r\n        { name: \"song reverb\", pianoName: \"Reverb\", maxRawVol: Config.reverbRange * 2, newNoteVol: Config.reverbRange, forSong: true, convertRealFactor: -Config.reverbRange, associatedEffect: EffectType.length,\r\n            promptName: \"Song Reverb\", promptDesc: [ \"This setting affects the overall reverb of your song. It works by multiplying existing reverb for instruments, so those with no reverb set will be unaffected.\", \"At $MID, all instruments' reverb will be unchanged from default. This increases up to double the reverb value at $HI, or down to no reverb at $LO.\", \"[MULTIPLICATIVE] [$LO - $HI]\" ] },\r\n        { name: \"next bar\", pianoName: \"Next Bar\", maxRawVol: 1, newNoteVol: 1, forSong: true, convertRealFactor: 0, associatedEffect: EffectType.length,\r\n            promptName: \"Go To Next Bar\", promptDesc: [ \"This setting functions a little different from most. Wherever a note is placed, the song will jump immediately to the next bar when it is encountered.\", \"This jump happens at the very start of the note, so the length of a next-bar note is irrelevant. Also, the note can be value 0 or 1, but the value is also irrelevant - wherever you place a note, the song will jump.\", \"You can make mixed-meter songs or intro sections by cutting off unneeded beats with a next-bar modulator.\", \"[$LO - $HI]\" ] },\r\n        { name: \"note volume\", pianoName: \"Note Vol.\", maxRawVol: Config.volumeRange, newNoteVol: Math.ceil(Config.volumeRange / 2), forSong: false, convertRealFactor: Math.ceil(-Config.volumeRange / 2.0), associatedEffect: EffectType.length,\r\n            promptName: \"Note Volume\", promptDesc: [ \"This setting affects the volume of your instrument as if its note size had been scaled.\", \"At $MID, an instrument's volume will be unchanged from default. This means you can still use the volume sliders to mix the base volume of instruments. The volume gradually increases up to $HI, or decreases down to mute at $LO.\", \"This setting was the default for volume modulation in JummBox for a long time. Due to some new effects like distortion and bitcrush, note volume doesn't always allow fine volume control. Also, this modulator affects the value of FM modulator waves instead of just carriers. This can distort the sound which may be useful, but also may be undesirable. In those cases, use the 'mix volume' modulator instead, which will always just scale the volume with no added effects.\", \"For display purposes, this mod will show up on the instrument volume slider, as long as there is not also an active 'mix volume' modulator anyhow. However, as mentioned, it works more like changing note volume.\", \"[MULTIPLICATIVE] [$LO - $HI]\" ] },\r\n        { name: \"pan\", pianoName: \"Pan\", maxRawVol: Config.panMax, newNoteVol: Math.ceil(Config.panMax / 2), forSong: false, convertRealFactor: 0, associatedEffect: EffectType.panning,\r\n            promptName: \"Instrument Panning\", promptDesc: [ \"This setting controls the panning of your instrument, just like the panning slider.\", \"At $LO, your instrument will sound like it is coming fully from the left-ear side. At $MID it will be right in the middle, and at $HI, it will sound like it's on the right.\", \"[OVERWRITING] [$LO - $HI] [L-R]\" ] },\r\n        { name: \"reverb\", pianoName: \"Reverb\", maxRawVol: Config.reverbRange, newNoteVol: 0, forSong: false, convertRealFactor: 0, associatedEffect: EffectType.reverb,\r\n            promptName: \"Instrument Reverb\", promptDesc: [ \"This setting controls the reverb of your insturment, just like the reverb slider.\", \"At $LO, your instrument will have no reverb. At $HI, it will be at maximum.\", \"[OVERWRITING] [$LO - $HI]\"] },\r\n        { name: \"distortion\", pianoName: \"Distortion\", maxRawVol: Config.distortionRange-1, newNoteVol: 0, forSong: false, convertRealFactor: 0, associatedEffect: EffectType.distortion,\r\n            promptName: \"Instrument Distortion\", promptDesc: [ \"This setting controls the amount of distortion for your instrument, just like the distortion slider.\", \"At $LO, your instrument will have no distortion. At $HI, it will be at maximum.\", \"[OVERWRITING] [$LO - $HI]\" ] },\r\n        { name: \"fm slider 1\", pianoName: \"FM 1\", maxRawVol: 15, newNoteVol: 15, forSong: false, convertRealFactor: 0, associatedEffect: EffectType.length,\r\n            promptName: \"FM Slider 1\", promptDesc: [ \"This setting affects the strength of the first FM slider, just like the corresponding slider on your instrument.\", \"It works in a multiplicative way, so at $HI your slider will sound the same is its default value, and at $LO it will sound like it has been moved all the way to the left.\", \"For the full range of control with this mod, move your underlying slider all the way to the right.\", \"[MULTIPLICATIVE] [$LO - $HI] [%]\"] },\r\n        { name: \"fm slider 2\", pianoName: \"FM 2\", maxRawVol: 15, newNoteVol: 15, forSong: false, convertRealFactor: 0, associatedEffect: EffectType.length,\r\n            promptName: \"FM Slider 2\", promptDesc: [\"This setting affects the strength of the second FM slider, just like the corresponding slider on your instrument.\", \"It works in a multiplicative way, so at $HI your slider will sound the same is its default value, and at $LO it will sound like it has been moved all the way to the left.\", \"For the full range of control with this mod, move your underlying slider all the way to the right.\", \"[MULTIPLICATIVE] [$LO - $HI] [%]\" ] },\r\n        { name: \"fm slider 3\", pianoName: \"FM 3\", maxRawVol: 15, newNoteVol: 15, forSong: false, convertRealFactor: 0, associatedEffect: EffectType.length,\r\n            promptName: \"FM Slider 3\", promptDesc: [\"This setting affects the strength of the third FM slider, just like the corresponding slider on your instrument.\", \"It works in a multiplicative way, so at $HI your slider will sound the same is its default value, and at $LO it will sound like it has been moved all the way to the left.\", \"For the full range of control with this mod, move your underlying slider all the way to the right.\", \"[MULTIPLICATIVE] [$LO - $HI] [%]\" ] },\r\n        { name: \"fm slider 4\", pianoName: \"FM 4\", maxRawVol: 15, newNoteVol: 15, forSong: false, convertRealFactor: 0, associatedEffect: EffectType.length,\r\n            promptName: \"FM Slider 4\", promptDesc: [\"This setting affects the strength of the fourth FM slider, just like the corresponding slider on your instrument.\", \"It works in a multiplicative way, so at $HI your slider will sound the same is its default value, and at $LO it will sound like it has been moved all the way to the left.\", \"For the full range of control with this mod, move your underlying slider all the way to the right.\", \"[MULTIPLICATIVE] [$LO - $HI] [%]\"] },\r\n        { name: \"fm feedback\", pianoName: \"FM Feedback\", maxRawVol: 15, newNoteVol: 15, forSong: false, convertRealFactor: 0, associatedEffect: EffectType.length,\r\n            promptName: \"FM Feedback\", promptDesc: [\"This setting affects the strength of the FM feedback slider, just like the corresponding slider on your instrument.\", \"It works in a multiplicative way, so at $HI your slider will sound the same is its default value, and at $LO it will sound like it has been moved all the way to the left.\", \"For the full range of control with this mod, move your underlying slider all the way to the right.\", \"[MULTIPLICATIVE] [$LO - $HI] [%]\"] },\r\n        { name: \"pulse width\", pianoName: \"Pulse Width\", maxRawVol: Config.pulseWidthRange, newNoteVol: Config.pulseWidthRange, forSong: false, convertRealFactor: 0, associatedEffect: EffectType.length,\r\n            promptName: \"Pulse Width\", promptDesc: [\"This setting controls the width of this instrument's pulse wave, just like the pulse width slider.\", \"At $HI, your instrument will sound like a pure square wave (on 50% of the time). It will gradually sound narrower down to $LO, where it will be inaudible (as it is on 0% of the time).\", \"Changing pulse width randomly between a few values is a common strategy in chiptune music to lend some personality to a lead instrument.\", \"[OVERWRITING] [$LO - $HI] [%Duty]\"] },\r\n        { name: \"detune\", pianoName: \"Detune\", maxRawVol: Config.detuneMax - Config.detuneMin, newNoteVol: Config.detuneCenter, forSong: false, convertRealFactor: -Config.detuneCenter, associatedEffect: EffectType.detune,\r\n            promptName: \"Instrument Detune\", promptDesc: [\"This setting controls the detune for this instrument, just like the detune slider.\", \"At $MID, your instrument will have no detune applied. Each tick corresponds to one cent, or one-hundredth of a pitch. Thus, each change of 100 ticks corresponds to one half-step of detune, up to two half-steps up at $HI, or two half-steps down at $LO.\", \"[OVERWRITING] [$LO - $HI] [cents]\"] },\r\n        { name: \"vibrato depth\", pianoName: \"Vibrato Depth\", maxRawVol: 50, newNoteVol: 0, forSong: false, convertRealFactor: 0, associatedEffect: EffectType.vibrato,\r\n            promptName: \"Vibrato Depth\", promptDesc: [\"This setting controls the amount that your pitch moves up and down by during vibrato, just like the vibrato depth slider.\", \"At $LO, your instrument will have no vibrato depth so its vibrato would be inaudible. This increases up to $HI, where an extreme pitch change will be noticeable.\", \"[OVERWRITING] [$LO - $HI] [pitch ÷25]\"] },\r\n        { name: \"song detune\", pianoName: \"Detune\", maxRawVol: Config.songDetuneMax - Config.songDetuneMin, newNoteVol: Math.ceil((Config.songDetuneMax - Config.songDetuneMin) / 2), forSong: true, convertRealFactor: -250, associatedEffect: EffectType.length,\r\n            promptName: \"Song Detune\", promptDesc: [\"This setting controls the overall detune of the entire song. There is no associated slider.\", \"At $MID, your song will have no extra detune applied and sound unchanged from default. Each tick corresponds to four cents, or four hundredths of a pitch. Thus, each change of 25 ticks corresponds to one half-step of detune, up to 10 half-steps up at $HI, or 10 half-steps down at $LO.\", \"[MULTIPLICATIVE] [$LO - $HI] [cents x4]\"] },\r\n        { name: \"vibrato speed\", pianoName: \"Vibrato Speed\", maxRawVol: 30, newNoteVol: 0, forSong: false, convertRealFactor: 0, associatedEffect: EffectType.vibrato,\r\n            promptName: \"Vibrato Speed\", promptDesc: [\"This setting controls the speed your instrument will vibrato at, just like the slider.\", \"A setting of $LO means there will be no oscillation, and vibrato will be disabled. Higher settings will increase the speed, up to a dramatic trill at the max value, $HI.\", \"[OVERWRITING] [$LO - $HI]\"] },\r\n        { name: \"vibrato delay\", pianoName: \"Vibrato Delay\", maxRawVol: 50, newNoteVol: 0, forSong: false, convertRealFactor: 0, associatedEffect: EffectType.vibrato,\r\n            promptName: \"Vibrato Delay\", promptDesc: [\"This setting controls the amount of time vibrato will be held off for before triggering for every new note, just like the slider.\", \"A setting of $LO means there will be no delay. A setting of 24 corresponds to one full beat of delay. As a sole exception to this scale, setting delay to $HI will completely disable vibrato (as if it had infinite delay).\", \"[OVERWRITING] [$LO - $HI] [beats ÷24]\"] },\r\n        { name: \"arp speed\", pianoName: \"Arp Speed\", maxRawVol: 50, newNoteVol: 10, forSong: false, convertRealFactor: 0, associatedEffect: EffectType.chord,\r\n            promptName: \"Arpeggio Speed\", promptDesc: [\"This setting controls the speed at which your instrument's chords arpeggiate, just like the arpeggio speed slider.\", \"Each setting corresponds to a different speed, from the slowest to the fastest. The speeds are listed below.\",\r\n                \"[0-4]: x0, x1/16, x⅛, x⅕, x¼,\", \"[5-9]: x⅓, x⅖, x½, x⅔, x¾,\", \"[10-14]: x⅘, x0.9, x1, x1.1, x1.2,\", \"[15-19]: x1.3, x1.4, x1.5, x1.6, x1.7,\", \"[20-24]: x1.8, x1.9, x2, x2.1, x2.2,\", \"[25-29]: x2.3, x2.4, x2.5, x2.6, x2.7,\", \"[30-34]: x2.8, x2.9, x3, x3.1, x3.2,\", \"[35-39]: x3.3, x3.4, x3.5, x3.6, x3.7,\" ,\"[40-44]: x3.8, x3.9, x4, x4.15, x4.3,\", \"[45-50]: x4.5, x4.8, x5, x5.5, x6, x8\", \"[OVERWRITING] [$LO - $HI]\"] },\r\n        { name: \"pan delay\", pianoName: \"Pan Delay\", maxRawVol: 20, newNoteVol: 10, forSong: false, convertRealFactor: 0, associatedEffect: EffectType.panning,\r\n            promptName: \"Panning Delay\", promptDesc: [\"This setting controls the delay applied to panning for your instrument, just like the pan delay slider.\", \"With more delay, the panning effect will generally be more pronounced. $MID is the default value, whereas $LO will remove any delay at all. No delay can be desirable for chiptune songs.\", \"[OVERWRITING] [$LO - $HI]\"] },\r\n        { name: \"reset arp\", pianoName: \"Reset Arp\", maxRawVol: 1, newNoteVol: 1, forSong: false, convertRealFactor: 0, associatedEffect: EffectType.chord,\r\n            promptName: \"Reset Arpeggio\", promptDesc: [\"This setting functions a little different from most. Wherever a note is placed, the arpeggio of this instrument will reset at the very start of that note. This is most noticeable with lower arpeggio speeds. The lengths and values of notes for this setting don't matter, just the note start times.\", \"This mod can be used to sync up your apreggios so that they always sound the same, even if you are using an odd-ratio arpeggio speed or modulating arpeggio speed.\", \"[$LO - $HI]\"] },\r\n        { name: \"eq filter\", pianoName: \"EQFlt\", maxRawVol: 10, newNoteVol: 0, forSong: false, convertRealFactor: 0, associatedEffect: EffectType.length,\r\n            promptName: \"EQ Filter\", promptDesc: [\"This setting controls a few separate things for your instrument's EQ filter.\", \"When the option 'morph' is selected, your modulator values will indicate a sub-filter index of your EQ filter to 'morph' to over time. For example, a change from 0 to 1 means your main filter (default) will morph to sub-filter 1 over the specified duration. You can shape the main filter and sub-filters in the large filter editor ('+' button). If your two filters' number, type, and order of filter dots all match up, the morph will happen smoothly and you'll be able to hear them changing. If they do not match up, the filters will simply jump between each other.\", \"Note that filters will morph based on endpoints in the pattern editor. So, if you specify a morph from sub-filter 1 to 4 but do not specifically drag in new endpoints for 2 and 3, it will morph directly between 1 and 4 without going through the others.\", \"If you target Dot X or Dot Y, you can finely tune the coordinates of a single dot for your filter. The number of available dots to choose is dependent on your main filter's dot count.\", \"[OVERWRITING] [$LO - $HI]\"] },\r\n        { name: \"note filter\", pianoName: \"N.Flt\", maxRawVol: 10, newNoteVol: 0, forSong: false, convertRealFactor: 0, associatedEffect: EffectType.noteFilter,\r\n            promptName: \"Note Filter\", promptDesc: [\"This setting controls a few separate things for your instrument's note filter.\", \"When the option 'morph' is selected, your modulator values will indicate a sub-filter index of your note filter to 'morph' to over time. For example, a change from 0 to 1 means your main filter (default) will morph to sub-filter 1 over the specified duration. You can shape the main filter and sub-filters in the large filter editor ('+' button). If your two filters' number, type, and order of filter dots all match up, the morph will happen smoothly and you'll be able to hear them changing. If they do not match up, the filters will simply jump between each other.\", \"Note that filters will morph based on endpoints in the pattern editor. So, if you specify a morph from sub-filter 1 to 4 but do not specifically drag in new endpoints for 2 and 3, it will morph directly between 1 and 4 without going through the others.\", \"If you target Dot X or Dot Y, you can finely tune the coordinates of a single dot for your filter. The number of available dots to choose is dependent on your main filter's dot count.\", \"[OVERWRITING] [$LO - $HI]\"] },\r\n        { name: \"bit crush\", pianoName: \"Bitcrush\", maxRawVol: Config.bitcrusherQuantizationRange-1, newNoteVol: Math.round(Config.bitcrusherQuantizationRange / 2), forSong: false, convertRealFactor: 0, associatedEffect: EffectType.bitcrusher,\r\n            promptName: \"Instrument Bit Crush\", promptDesc: [\"This setting controls the bit crush of your instrument, just like the bit crush slider.\", \"At a value of $LO, no bit crush will be applied. This increases and the bit crush effect gets more noticeable up to the max value, $HI.\", \"[OVERWRITING] [$LO - $HI]\"] },\r\n        { name: \"freq crush\", pianoName: \"Freq Crush\", maxRawVol: Config.bitcrusherFreqRange-1, newNoteVol: Math.round(Config.bitcrusherFreqRange / 2), forSong: false, convertRealFactor: 0, associatedEffect: EffectType.bitcrusher,\r\n            promptName: \"Instrument Frequency Crush\", promptDesc: [\"This setting controls the frequency crush of your instrument, just like the freq crush slider.\", \"At a value of $LO, no frequency crush will be applied. This increases and the frequency crush effect gets more noticeable up to the max value, $HI.\", \"[OVERWRITING] [$LO - $HI]\"] },\r\n        { name: \"echo\", pianoName: \"Echo\", maxRawVol: Config.echoSustainRange-1, newNoteVol: 0, forSong: false, convertRealFactor: 0, associatedEffect: EffectType.echo,\r\n            promptName: \"Instrument Echo Sustain\", promptDesc: [\"This setting controls the echo sustain (echo loudness) of your instrument, just like the echo slider.\", \"At $LO, your instrument will have no echo sustain and echo will not be audible. Echo sustain increases and the echo effect gets more noticeable up to the max value, $HI.\", \"[OVERWRITING] [$LO - $HI]\"] },\r\n        { name: \"echo delay\", pianoName: \"Echo Delay\", maxRawVol: Config.echoDelayRange, newNoteVol: 0, forSong: false, convertRealFactor: 0, associatedEffect: EffectType.length,\r\n            promptName: \"Instrument Echo Delay\", promptDesc: [\"This setting controls the echo delay of your instrument, just like the echo delay slider.\", \"At $LO, your instrument will have very little echo delay, and this increases up to 2 beats of delay at $HI.\", \"[OVERWRITING] [$LO - $HI] [~beats ÷12]\" ]\r\n        }, // Disabled via associatedEffect and manually in list build in SongEditor, enable and set back to echo after fixing bugginess!\r\n        { name: \"chorus\", pianoName: \"Chorus\", maxRawVol: Config.chorusRange, newNoteVol: 0, forSong: false, convertRealFactor: 0, associatedEffect: EffectType.chorus,\r\n            promptName: \"Instrument Chorus\", promptDesc: [\"This setting controls the chorus strength of your instrument, just like the chorus slider.\", \"At $LO, the chorus effect will be disabled. The strength of the chorus effect increases up to the max value, $HI.\", \"[OVERWRITING] [$LO - $HI]\"] },\r\n        { name: \"eq filt cut\", pianoName: \"EQFlt Cut\", maxRawVol: Config.filterSimpleCutRange - 1, newNoteVol: Config.filterSimpleCutRange - 1, forSong: false, convertRealFactor: 0, associatedEffect: EffectType.length,\r\n            promptName: \"EQ Filter Cutoff Frequency\", promptDesc: [\"This setting controls the filter cut position of your instrument, just like the filter cut slider.\", \"This setting is roughly analagous to the horizontal position of a single low-pass dot on the advanced filter editor. At lower values, a wider range of frequencies is cut off.\", \"[OVERWRITING] [$LO - $HI]\"] },\r\n        { name: \"eq filt peak\", pianoName: \"EQFlt Peak\", maxRawVol: Config.filterSimplePeakRange - 1, newNoteVol: 0, forSong: false, convertRealFactor: 0, associatedEffect: EffectType.length,\r\n            promptName: \"EQ Filter Peak Gain\", promptDesc: [\"This setting controls the filter peak position of your instrument, just like the filter peak slider.\", \"This setting is roughly analagous to the vertical position of a single low-pass dot on the advanced filter editor. At lower values, the cutoff frequency will not be emphasized, and at higher values you will hear emphasis on the cutoff frequency.\", \"[OVERWRITING] [$LO - $HI]\"] },\r\n        { name: \"note filt cut\", pianoName: \"N.Flt Cut\", maxRawVol: Config.filterSimpleCutRange - 1, newNoteVol: Config.filterSimpleCutRange - 1, forSong: false, convertRealFactor: 0, associatedEffect: EffectType.noteFilter,\r\n            promptName: \"Note Filter Cutoff Frequency\", promptDesc: [\"This setting controls the filter cut position of your instrument, just like the filter cut slider.\", \"This setting is roughly analagous to the horizontal position of a single low-pass dot on the advanced filter editor. At lower values, a wider range of frequencies is cut off.\", \"[OVERWRITING] [$LO - $HI]\"] },\r\n        { name: \"note filt peak\", pianoName: \"N.Flt Peak\", maxRawVol: Config.filterSimplePeakRange - 1, newNoteVol: 0, forSong: false, convertRealFactor: 0, associatedEffect: EffectType.noteFilter,\r\n            promptName: \"Note Filter Peak Gain\", promptDesc: [\"This setting controls the filter peak position of your instrument, just like the filter peak slider.\", \"This setting is roughly analagous to the vertical position of a single low-pass dot on the advanced filter editor. At lower values, the cutoff frequency will not be emphasized, and at higher values you will hear emphasis on the cutoff frequency.\", \"[OVERWRITING] [$LO - $HI]\"] },\r\n        { name: \"pitch shift\", pianoName: \"Pitch Shift\", maxRawVol: Config.pitchShiftRange - 1, newNoteVol: Config.pitchShiftCenter, forSong: false, convertRealFactor: -Config.pitchShiftCenter, associatedEffect: EffectType.pitchShift,\r\n            promptName: \"Pitch Shift\", promptDesc: [\"This setting controls the pitch offset of your instrument, just like the pitch shift slider.\", \"At $MID your instrument will have no pitch shift. This increases as you decrease toward $LO pitches (half-steps) at the low end, or increases towards +$HI pitches at the high end.\", \"[OVERWRITING] [$LO - $HI] [pitch]\"] },\r\n        { name: \"sustain\", pianoName: \"Sustain\", maxRawVol: Config.stringSustainRange - 1, newNoteVol: 0, forSong: false, convertRealFactor: 0, associatedEffect: EffectType.length,\r\n            promptName: \"Picked String Sustain\", promptDesc: [\"This setting controls the sustain of your picked string instrument, just like the sustain slider.\", \"At $LO, your instrument will have minimum sustain and sound 'plucky'. This increases to a more held sound as your modulator approaches the maximum, $HI.\", \"[OVERWRITING] [$LO - $HI]\"] },\r\n        { name: \"mix volume\", pianoName: \"Mix Vol.\", maxRawVol: Config.volumeRange, newNoteVol: Math.ceil(Config.volumeRange / 2), forSong: false, convertRealFactor: Math.ceil(-Config.volumeRange / 2.0), associatedEffect: EffectType.length,\r\n            promptName: \"Mix Volume\", promptDesc: [\"This setting affects the volume of your instrument as if its volume slider had been moved.\", \"At $MID, an instrument's volume will be unchanged from default. This means you can still use the volume sliders to mix the base volume of instruments, since this setting and the default value work multiplicatively. The volume gradually increases up to $HI, or decreases down to mute at $LO.\", \"Unlike the 'note volume' setting, mix volume is very straightforward and simply affects the resultant instrument volume after all effects are applied.\", \"[MULTIPLICATIVE] [$LO - $HI]\"] },\r\n    ]);\r\n}\r\n\r\nfunction centerWave(wave: Array<number>): Float32Array {\r\n    let sum: number = 0.0;\r\n    for (let i: number = 0; i < wave.length; i++) sum += wave[i];\r\n    const average: number = sum / wave.length;\r\n    for (let i: number = 0; i < wave.length; i++) wave[i] -= average;\r\n    performIntegral(wave);\r\n    // The first sample should be zero, and we'll duplicate it at the end for easier interpolation.\r\n    wave.push(0);\r\n    return new Float32Array(wave);\r\n}\r\nfunction centerAndNormalizeWave(wave: Array<number>): Float32Array {\r\n    let magn: number = 0.0;\r\n\r\n    centerWave(wave);\r\n\r\n    // Going to length-1 because an extra 0 sample is added on the end as part of centerWave, which shouldn't impact magnitude calculation.\r\n    for (let i: number = 0; i < wave.length - 1; i++) {\r\n        magn += Math.abs(wave[i]);\r\n    }\r\n    const magnAvg: number = magn / (wave.length - 1);\r\n\r\n    for (let i: number = 0; i < wave.length - 1; i++) {\r\n        wave[i] = wave[i] / magnAvg;\r\n    }\r\n\r\n    return new Float32Array(wave);\r\n\r\n}\r\nexport function performIntegral(wave: { length: number, [index: number]: number }): Float32Array {\r\n    // Perform the integral on the wave. The synth function will perform the derivative to get the original wave back but with antialiasing.\r\n    let cumulative: number = 0.0;\r\n    let newWave: Float32Array = new Float32Array(wave.length);\r\n    for (let i: number = 0; i < wave.length; i++) {\r\n        newWave[i] = cumulative;\r\n        cumulative += wave[i];\r\n    }\r\n\r\n    return newWave;\r\n}\r\nexport function performIntegralOld(wave: { length: number, [index: number]: number }): void {\r\n\t// Old ver used in harmonics/picked string instruments, manipulates wave in place.\r\n\tlet cumulative: number = 0.0;\r\n\tfor (let i: number = 0; i < wave.length; i++) {\r\n\t\tconst temp = wave[i];\r\n\t\twave[i] = cumulative;\r\n\t\tcumulative += temp;\r\n\t}\r\n}\r\n\r\nexport function getPulseWidthRatio(pulseWidth: number): number {\r\n    // BeepBox formula for reference\r\n    //return Math.pow(0.5, (Config.pulseWidthRange - 1 - pulseWidth) * Config.pulseWidthStepPower) * 0.5;\r\n\r\n    return pulseWidth / (Config.pulseWidthRange * 2);\r\n}\r\n\r\n\r\n// The function arguments will be defined in FFT.ts, but I want\r\n// SynthConfig.ts to be at the top of the compiled JS so I won't directly\r\n// depend on FFT here. synth.ts will take care of importing FFT.ts.\r\n//function inverseRealFourierTransform(array: {length: number, [index: number]: number}, fullArrayLength: number): void;\r\n//function scaleElementsByFactor(array: {length: number, [index: number]: number}, factor: number): void;\r\nexport function getDrumWave(index: number, inverseRealFourierTransform: Function | null, scaleElementsByFactor: Function | null): Float32Array {\r\n    let wave: Float32Array | null = Config.chipNoises[index].samples;\r\n    if (wave == null) {\r\n        wave = new Float32Array(Config.chipNoiseLength + 1);\r\n        Config.chipNoises[index].samples = wave;\r\n\r\n        if (index == 0) {\r\n            // The \"retro\" drum uses a \"Linear Feedback Shift Register\" similar to the NES noise channel.\r\n            let drumBuffer: number = 1;\r\n            for (let i: number = 0; i < Config.chipNoiseLength; i++) {\r\n                wave[i] = (drumBuffer & 1) * 2.0 - 1.0;\r\n                let newBuffer: number = drumBuffer >> 1;\r\n                if (((drumBuffer + newBuffer) & 1) == 1) {\r\n                    newBuffer += 1 << 14;\r\n                }\r\n                drumBuffer = newBuffer;\r\n            }\r\n        } else if (index == 1) {\r\n            // White noise is just random values for each sample.\r\n            for (let i: number = 0; i < Config.chipNoiseLength; i++) {\r\n                wave[i] = Math.random() * 2.0 - 1.0;\r\n            }\r\n        } else if (index == 2) {\r\n            // The \"clang\" noise wave is based on a similar noise wave in the modded beepbox made by DAzombieRE.\r\n            let drumBuffer: number = 1;\r\n            for (let i: number = 0; i < Config.chipNoiseLength; i++) {\r\n                wave[i] = (drumBuffer & 1) * 2.0 - 1.0;\r\n                let newBuffer: number = drumBuffer >> 1;\r\n                if (((drumBuffer + newBuffer) & 1) == 1) {\r\n                    newBuffer += 2 << 14;\r\n                }\r\n                drumBuffer = newBuffer;\r\n            }\r\n        } else if (index == 3) {\r\n            // The \"buzz\" noise wave is based on a similar noise wave in the modded beepbox made by DAzombieRE.\r\n            let drumBuffer: number = 1;\r\n            for (let i: number = 0; i < Config.chipNoiseLength; i++) {\r\n                wave[i] = (drumBuffer & 1) * 2.0 - 1.0;\r\n                let newBuffer: number = drumBuffer >> 1;\r\n                if (((drumBuffer + newBuffer) & 1) == 1) {\r\n                    newBuffer += 10 << 2;\r\n                }\r\n                drumBuffer = newBuffer;\r\n            }\r\n        } else if (index == 4) {\r\n            // \"hollow\" drums, designed in frequency space and then converted via FFT:\r\n            drawNoiseSpectrum(wave, Config.chipNoiseLength, 10, 11, 1, 1, 0);\r\n            drawNoiseSpectrum(wave, Config.chipNoiseLength, 11, 14, .6578, .6578, 0);\r\n            inverseRealFourierTransform!(wave, Config.chipNoiseLength);\r\n            scaleElementsByFactor!(wave, 1.0 / Math.sqrt(Config.chipNoiseLength));\r\n        } else if (index == 5) {\r\n            // \"Shine\" drums from modbox!\r\n            var drumBuffer = 1;\r\n            for (var i = 0; i < Config.chipNoiseLength; i++) {\r\n                wave[i] = (drumBuffer & 1) * 2.0 - 1.0;\r\n                var newBuffer = drumBuffer >> 1;\r\n                if (((drumBuffer + newBuffer) & 1) == 1) {\r\n                    newBuffer += 10 << 2;\r\n                }\r\n                drumBuffer = newBuffer;\r\n            }\r\n        } else if (index == 6) {\r\n            // \"Deep\" drums from modbox!\r\n            drawNoiseSpectrum(wave, Config.chipNoiseLength, 1, 10, 1, 1, 0);\r\n            drawNoiseSpectrum(wave, Config.chipNoiseLength, 20, 14, -2, -2, 0);\r\n            inverseRealFourierTransform!(wave, Config.chipNoiseLength);\r\n            scaleElementsByFactor!(wave, 1.0 / Math.sqrt(Config.chipNoiseLength));\r\n        } else if (index == 7) {\r\n            // \"Cutter\" drums from modbox!\r\n            var drumBuffer = 1;\r\n            for (var i = 0; i < Config.chipNoiseLength; i++) {\r\n                wave[i] = (drumBuffer & 1) * 4.0 * (Math.random() * 14 + 1);\r\n                var newBuffer = drumBuffer >> 1;\r\n                if (((drumBuffer + newBuffer) & 1) == 1) {\r\n                    newBuffer += 15 << 2;\r\n                }\r\n                drumBuffer = newBuffer;\r\n            }\r\n        } else if (index == 8) {\r\n            // \"Metallic\" drums from modbox!\r\n            var drumBuffer = 1;\r\n            for (var i = 0; i < 32768; i++) {\r\n                wave[i] = (drumBuffer & 1) / 2.0 + 0.5;\r\n                var newBuffer = drumBuffer >> 1;\r\n                if (((drumBuffer + newBuffer) & 1) == 1) {\r\n                    newBuffer -= 10 << 2;\r\n                }\r\n                drumBuffer = newBuffer;\r\n            }\r\n        } else {\r\n            throw new Error(\"Unrecognized drum index: \" + index);\r\n        }\r\n\r\n        wave[Config.chipNoiseLength] = wave[0];\r\n    }\r\n\r\n    return wave;\r\n}\r\n\r\nexport function drawNoiseSpectrum(wave: Float32Array, waveLength: number, lowOctave: number, highOctave: number, lowPower: number, highPower: number, overallSlope: number): number {\r\n    const referenceOctave: number = 11;\r\n    const referenceIndex: number = 1 << referenceOctave;\r\n    const lowIndex: number = Math.pow(2, lowOctave) | 0;\r\n    const highIndex: number = Math.min(waveLength >> 1, Math.pow(2, highOctave) | 0);\r\n    const retroWave: Float32Array = getDrumWave(0, null, null);\r\n    let combinedAmplitude: number = 0.0;\r\n    for (let i: number = lowIndex; i < highIndex; i++) {\r\n\r\n        let lerped: number = lowPower + (highPower - lowPower) * (Math.log2(i) - lowOctave) / (highOctave - lowOctave);\r\n        let amplitude: number = Math.pow(2, (lerped - 1) * 7 + 1) * lerped;\r\n\r\n        amplitude *= Math.pow(i / referenceIndex, overallSlope);\r\n\r\n        combinedAmplitude += amplitude;\r\n\r\n        // Add two different sources of psuedo-randomness to the noise\r\n        // (individually they aren't random enough) but in a deterministic\r\n        // way so that live spectrum editing doesn't result in audible pops.\r\n        // Multiply all the sine wave amplitudes by 1 or -1 based on the\r\n        // LFSR retro wave (effectively random), and also rotate the phase\r\n        // of each sine wave based on the golden angle to disrupt the symmetry.\r\n        amplitude *= retroWave[i];\r\n        const radians: number = 0.61803398875 * i * i * Math.PI * 2.0;\r\n\r\n        wave[i] = Math.cos(radians) * amplitude;\r\n        wave[waveLength - i] = Math.sin(radians) * amplitude;\r\n    }\r\n\r\n    return combinedAmplitude;\r\n}\r\n\r\nfunction generateSineWave(): Float32Array {\r\n    const wave: Float32Array = new Float32Array(Config.sineWaveLength + 1);\r\n    for (let i: number = 0; i < Config.sineWaveLength + 1; i++) {\r\n        wave[i] = Math.sin(i * Math.PI * 2.0 / Config.sineWaveLength);\r\n    }\r\n    return wave;\r\n}\r\n\r\nfunction generateTriWave(): Float32Array {\r\n    const wave: Float32Array = new Float32Array(Config.sineWaveLength + 1);\r\n    for (let i: number = 0; i < Config.sineWaveLength + 1; i++) {\r\n        wave[i] = Math.asin(Math.sin(i * Math.PI * 2.0 / Config.sineWaveLength)) / (Math.PI / 2);\r\n    }\r\n    return wave;\r\n}\r\n\r\nfunction generateTrapezoidWave(drive: number = 2): Float32Array {\r\n    const wave: Float32Array = new Float32Array(Config.sineWaveLength + 1);\r\n    for (let i: number = 0; i < Config.sineWaveLength + 1; i++) {\r\n        wave[i] = Math.max(-1.0, Math.min(1.0, Math.asin(Math.sin(i * Math.PI * 2.0 / Config.sineWaveLength)) * drive));\r\n    }\r\n    return wave;\r\n}\r\n\r\nfunction generateSquareWave(phaseWidth: number = 0): Float32Array {\r\n    const wave: Float32Array = new Float32Array(Config.sineWaveLength + 1);\r\n    const centerPoint: number = Config.sineWaveLength / 4;\r\n    for (let i: number = 0; i < Config.sineWaveLength + 1; i++) {\r\n        wave[i] = +((Math.abs(i - centerPoint) < phaseWidth * Config.sineWaveLength / 2)\r\n            || ((Math.abs(i - Config.sineWaveLength - centerPoint) < phaseWidth * Config.sineWaveLength / 2))) * 2 - 1;\r\n    }\r\n    return wave;\r\n}\r\n\r\nfunction generateSawWave(inverse: boolean = false): Float32Array {\r\n    const wave: Float32Array = new Float32Array(Config.sineWaveLength + 1);\r\n    for (let i: number = 0; i < Config.sineWaveLength + 1; i++) {\r\n        wave[i] = ((i + (Config.sineWaveLength / 4.0)) * 2.0 / Config.sineWaveLength) % 2 - 1;\r\n        wave[i] = inverse ? -wave[i] : wave[i];\r\n    }\r\n    return wave;\r\n}\r\n\r\nexport function getArpeggioPitchIndex(pitchCount: number, useFastTwoNoteArp: boolean, arpeggio: number): number {\r\n    let arpeggioPattern: ReadonlyArray<number> = Config.arpeggioPatterns[pitchCount - 1];\r\n    if (arpeggioPattern != null) {\r\n        if (pitchCount == 2 && useFastTwoNoteArp == false) {\r\n            arpeggioPattern = [0, 0, 1, 1];\r\n        }\r\n        return arpeggioPattern[arpeggio % arpeggioPattern.length];\r\n    } else {\r\n        return arpeggio % pitchCount;\r\n    }\r\n}\r\n\r\n// Pardon the messy type casting. This allows accessing array members by numerical index or string name.\r\nexport function toNameMap<T extends BeepBoxOption>(array: Array<Pick<T, Exclude<keyof T, \"index\">>>): DictionaryArray<T> {\r\n    const dictionary: Dictionary<T> = {};\r\n    for (let i: number = 0; i < array.length; i++) {\r\n        const value: any = array[i];\r\n        value.index = i;\r\n        dictionary[value.name] = <T>value;\r\n    }\r\n    const result: DictionaryArray<T> = <DictionaryArray<T>><any>array;\r\n    result.dictionary = dictionary;\r\n    return result;\r\n}\r\n\r\nexport function effectsIncludeTransition(effects: number): boolean {\r\n    return (effects & (1 << EffectType.transition)) != 0;\r\n}\r\nexport function effectsIncludeChord(effects: number): boolean {\r\n    return (effects & (1 << EffectType.chord)) != 0;\r\n}\r\nexport function effectsIncludePitchShift(effects: number): boolean {\r\n    return (effects & (1 << EffectType.pitchShift)) != 0;\r\n}\r\nexport function effectsIncludeDetune(effects: number): boolean {\r\n    return (effects & (1 << EffectType.detune)) != 0;\r\n}\r\nexport function effectsIncludeVibrato(effects: number): boolean {\r\n    return (effects & (1 << EffectType.vibrato)) != 0;\r\n}\r\nexport function effectsIncludeNoteFilter(effects: number): boolean {\r\n    return (effects & (1 << EffectType.noteFilter)) != 0;\r\n}\r\nexport function effectsIncludeDistortion(effects: number): boolean {\r\n    return (effects & (1 << EffectType.distortion)) != 0;\r\n}\r\nexport function effectsIncludeBitcrusher(effects: number): boolean {\r\n    return (effects & (1 << EffectType.bitcrusher)) != 0;\r\n}\r\nexport function effectsIncludePanning(effects: number): boolean {\r\n    return (effects & (1 << EffectType.panning)) != 0;\r\n}\r\nexport function effectsIncludeChorus(effects: number): boolean {\r\n    return (effects & (1 << EffectType.chorus)) != 0;\r\n}\r\nexport function effectsIncludeEcho(effects: number): boolean {\r\n    return (effects & (1 << EffectType.echo)) != 0;\r\n}\r\nexport function effectsIncludeReverb(effects: number): boolean {\r\n    return (effects & (1 << EffectType.reverb)) != 0;\r\n}\r\nexport function rawChipToIntegrated(raw: DictionaryArray<ChipWave>): DictionaryArray<ChipWave> {\r\n    const newArray: Array<ChipWave> = new Array<ChipWave>(raw.length);\r\n    const dictionary: Dictionary<ChipWave> = {};\r\n    for (let i: number = 0; i < newArray.length; i++) {\r\n        newArray[i] = Object.assign([], raw[i]);\r\n        const value: any = newArray[i];\r\n        value.index = i;\r\n        dictionary[value.name] = <ChipWave>value;\r\n    }\r\n    for (let key in dictionary) {\r\n        dictionary[key].samples = performIntegral(dictionary[key].samples);\r\n    }\r\n    const result: DictionaryArray<ChipWave> = <DictionaryArray<ChipWave>><any>newArray;\r\n    result.dictionary = dictionary;\r\n    return result;\r\n}","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { DictionaryArray, BeepBoxOption, InstrumentType, toNameMap } from \"../synth/SynthConfig\";\r\n\r\nexport interface PresetCategory extends BeepBoxOption {\r\n    readonly presets: DictionaryArray<Preset>;\r\n}\r\n\r\nexport interface Preset extends BeepBoxOption {\r\n    readonly isNoise?: boolean;\r\n    readonly isMod?: boolean;\r\n    readonly generalMidi?: boolean;\r\n    readonly midiProgram?: number;\r\n    readonly midiSubharmonicOctaves?: number;\r\n    readonly customType?: InstrumentType;\r\n    readonly settings?: any;\r\n}\r\n\r\nexport const isMobile: boolean = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|android|ipad|playbook|silk/i.test(navigator.userAgent);\r\n\r\nexport function prettyNumber(value: number): string {\r\n    return value.toFixed(2).replace(/\\.?0*$/, \"\");\r\n}\r\n\r\nexport class EditorConfig {\r\n    public static readonly version: string = \"2.5\"; // Not using patch versions in display right now, maybe someday.\r\n    public static readonly versionDisplayName: string = \"JummBox \" + EditorConfig.version;\r\n\r\n    public static readonly releaseNotesURL: string = \"https://jummbus.bitbucket.io/patch_notes/\" + EditorConfig.version + \".html\";\r\n\r\n    public static readonly isOnMac: boolean = /^Mac/i.test(navigator.platform) || /Mac OS X/i.test(navigator.userAgent) || /^(iPhone|iPad|iPod)/i.test(navigator.platform) || /(iPhone|iPad|iPod)/i.test(navigator.userAgent);\r\n    public static readonly ctrlSymbol: string = EditorConfig.isOnMac ? \"⌘\" : \"Ctrl+\";\r\n    public static readonly ctrlName: string = EditorConfig.isOnMac ? \"command\" : \"control\";\r\n\r\n    public static readonly presetCategories: DictionaryArray<PresetCategory> = toNameMap([\r\n        {\r\n            name: \"Custom Instruments\", presets: <DictionaryArray<Preset>>toNameMap([\r\n                { name: \"chip wave\", customType: InstrumentType.chip },\r\n                { name: \"FM (expert)\", customType: InstrumentType.fm },\r\n                { name: \"basic noise\", customType: InstrumentType.noise },\r\n                { name: \"spectrum\", customType: InstrumentType.spectrum },\r\n                { name: \"drumset\", customType: InstrumentType.drumset },\r\n                { name: \"harmonics\", customType: InstrumentType.harmonics },\r\n                { name: \"pulse width\", customType: InstrumentType.pwm },\r\n                { name: \"picked string\", customType: InstrumentType.pickedString },\r\n                { name: \"custom chip\", customType: InstrumentType.customChipWave },\r\n            ])\r\n        },\r\n        {\r\n            name: \"Retro Presets\", presets: <DictionaryArray<Preset>>toNameMap([\r\n                { name: \"square wave\", midiProgram: 80, settings: { \"type\": \"chip\", \"eqFilter\": [], \"effects\": [\"aliasing\"], \"transition\": \"interrupt\", \"fadeInSeconds\": 0, \"fadeOutTicks\": -1, \"chord\": \"arpeggio\", \"wave\": \"square\", \"unison\": \"none\", \"envelopes\": [] } },\r\n                { name: \"triangle wave\", midiProgram: 71, settings: { \"type\": \"chip\", \"eqFilter\": [], \"effects\": [\"aliasing\"], \"transition\": \"interrupt\", \"fadeInSeconds\": 0, \"fadeOutTicks\": -1, \"chord\": \"arpeggio\", \"wave\": \"triangle\", \"unison\": \"none\", \"envelopes\": [] } },\r\n                { name: \"square lead\", midiProgram: 80, generalMidi: true, settings: { \"type\": \"chip\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 8000, \"linearGain\": 0.3536 }], \"effects\": [\"aliasing\"], \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": -3, \"chord\": \"simultaneous\", \"wave\": \"square\", \"unison\": \"hum\", \"envelopes\": [] } },\r\n                { name: \"sawtooth lead 1\", midiProgram: 81, generalMidi: true, settings: { \"type\": \"chip\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 4000, \"linearGain\": 0.5 }], \"effects\": [\"aliasing\"], \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": -3, \"chord\": \"simultaneous\", \"wave\": \"sawtooth\", \"unison\": \"shimmer\", \"envelopes\": [] } },\r\n                { name: \"sawtooth lead 2\", midiProgram: 81, settings: { \"type\": \"chip\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 6727.17, \"linearGain\": 1 }], \"effects\": [\"vibrato\", \"aliasing\"], \"vibrato\": \"light\", \"transition\": \"normal\", \"fadeInSeconds\": 0.0125, \"fadeOutTicks\": 72, \"chord\": \"simultaneous\", \"wave\": \"sawtooth\", \"unison\": \"hum\", \"envelopes\": [] } },\r\n                { name: \"chip noise\", midiProgram: 116, isNoise: true, settings: { \"type\": \"noise\", \"transition\": \"hard\", \"effects\": [\"aliasing\"], \"chord\": \"arpeggio\", \"filterCutoffHz\": 4000, \"filterResonance\": 0, \"filterEnvelope\": \"steady\", \"wave\": \"retro\" } },\r\n                { name: \"FM twang\", midiProgram: 32, settings: { \"type\": \"FM\", \"eqFilter\": [], \"effects\": [], \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": -3, \"chord\": \"simultaneous\", \"algorithm\": \"1←(2 3 4)\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 0, \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 15 }, { \"frequency\": \"1×\", \"amplitude\": 15 }, { \"frequency\": \"1×\", \"amplitude\": 0 }, { \"frequency\": \"1×\", \"amplitude\": 0 }], \"envelopes\": [{ \"target\": \"operatorAmplitude\", \"envelope\": \"twang 2\", \"index\": 1 }] } },\r\n                { name: \"FM bass\", midiProgram: 36, settings: { \"type\": \"FM\", \"eqFilter\": [], \"effects\": [], \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": -3, \"chord\": \"custom interval\", \"algorithm\": \"1←(2 3←4)\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 0, \"operators\": [{ \"frequency\": \"2×\", \"amplitude\": 11 }, { \"frequency\": \"1×\", \"amplitude\": 7 }, { \"frequency\": \"1×\", \"amplitude\": 9 }, { \"frequency\": \"20×\", \"amplitude\": 3 }], \"envelopes\": [{ \"target\": \"operatorAmplitude\", \"envelope\": \"twang 2\", \"index\": 1 }, { \"target\": \"operatorAmplitude\", \"envelope\": \"twang 3\", \"index\": 2 }, { \"target\": \"operatorAmplitude\", \"envelope\": \"twang 2\", \"index\": 3 }] } },\r\n                { name: \"FM flute\", midiProgram: 73, settings: { \"type\": \"FM\", \"eqFilter\": [], \"effects\": [], \"transition\": \"normal\", \"fadeInSeconds\": 0.0263, \"fadeOutTicks\": -3, \"chord\": \"simultaneous\", \"algorithm\": \"1←(2 3 4)\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 0, \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 15 }, { \"frequency\": \"1×\", \"amplitude\": 6 }, { \"frequency\": \"1×\", \"amplitude\": 0 }, { \"frequency\": \"1×\", \"amplitude\": 0 }], \"envelopes\": [{ \"target\": \"operatorAmplitude\", \"envelope\": \"twang 2\", \"index\": 1 }] } },\r\n                { name: \"FM organ\", midiProgram: 16, settings: { \"type\": \"FM\", \"eqFilter\": [], \"effects\": [\"vibrato\"], \"vibrato\": \"delayed\", \"transition\": \"normal\", \"fadeInSeconds\": 0.0263, \"fadeOutTicks\": -3, \"chord\": \"custom interval\", \"algorithm\": \"1←3 2←4\", \"feedbackType\": \"1⟲ 2⟲\", \"feedbackAmplitude\": 0, \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 14 }, { \"frequency\": \"2×\", \"amplitude\": 14 }, { \"frequency\": \"1×\", \"amplitude\": 11 }, { \"frequency\": \"2×\", \"amplitude\": 11 }], \"envelopes\": [] } },\r\n                { name: \"NES Pulse\", midiProgram: 80, settings: { \"type\": \"custom chip\", \"effects\": [\"aliasing\"], \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": -3, \"chord\": \"arpeggio\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 8000, \"linearGain\": 0.5 }], \"unison\": \"none\", \"vibrato\": \"none\", \"envelopes\": [], \"customChipWave\": [-24, -24, -24, -24, -23, -23, -23, -23, -22, -22, -22, -22, -21, -21, -21, -21, -20, -20, -20, -20, -19, -19, -19, -19, -18, -18, -18, -18, -17, -17, -17, -17, 24, 24, 24, 24, 23, 23, 23, 23, 22, 22, 22, 22, 21, 21, 21, 21, 20, 20, 20, 20, 19, 19, 19, 19, 18, 18, 18, 18, 17, 17, 17, 17] } },\r\n                { name: \"Gameboy Pulse\", midiProgram: 80, settings: { \"type\": \"custom chip\", \"effects\": [\"aliasing\"], \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": -3, \"chord\": \"arpeggio\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 8000, \"linearGain\": 0.5 }], \"unison\": \"none\", \"envelopes\": [], \"customChipWave\": [-24, -20, -17, -15, -13, -13, -11, -11, -11, -9, -9, -9, -9, -7, -7, -7, -7, -7, -5, -5, -5, -5, -5, -5, -3, -3, -3, -3, -3, -3, -3, -3, 24, 20, 17, 15, 13, 13, 11, 11, 11, 9, 9, 9, 9, 7, 7, 7, 7, 7, 5, 5, 5, 5, 5, 5, 3, 3, 3, 3, 3, 3, 3, 3] } },\r\n                { name: \"VRC6 Sawtooth\", midiProgram: 81, settings: { \"type\": \"custom chip\", \"effects\": [\"aliasing\"], \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": -3, \"chord\": \"arpeggio\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 8000, \"linearGain\": 0.5 }], \"unison\": \"none\", \"envelopes\": [], \"customChipWave\": [-24, -20, -16, -13, -10, -8, -6, -5, -4, -4, 0, 0, 0, 0, 4, 4, 4, 4, 4, 4, 8, 8, 8, 8, 8, 8, 8, 8, 12, 12, 12, 12, 12, 12, 12, 12, 16, 16, 16, 16, 16, 16, 16, 16, 20, 20, 20, 20, 20, 20, 20, 20, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24] } },\r\n                { name: \"Atari Square\", midiProgram: 80, settings: { \"type\": \"custom chip\", \"effects\": [\"aliasing\"], \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": -3, \"chord\": \"arpeggio\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 4000, \"linearGain\": 0.5 }], \"unison\": \"none\", \"envelopes\": [], \"customChipWave\": [-24, -24, -24, -23, -23, -23, -22, -22, -22, -21, -21, -21, -20, -20, -20, -19, -19, -19, -18, -18, -18, -17, -17, -17, -16, -16, -16, -15, -15, -15, -14, -14, -14, -13, -13, -13, 24, 24, 24, 23, 23, 23, 22, 22, 22, 21, 21, 21, 20, 20, 20, 19, 19, 19, 18, 18, 18, 17, 17, 17, 16, 16, 15, 15] } },\r\n                { name: \"Atari Bass\", midiProgram: 36, settings: { \"type\": \"custom chip\", \"effects\": [\"aliasing\"], \"transition\": \"interrupt\", \"fadeInSeconds\": 0, \"fadeOutTicks\": -3, \"chord\": \"arpeggio\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 4000, \"linearGain\": 0.5 }], \"unison\": \"none\", \"envelopes\": [], \"customChipWave\": [-24, -24, -24, -24, -24, -24, -24, -24, -24, 24, 24, 24, 24, 24, 24, -24, -24, -24, 24, 24, 24, -24, -24, -24, 24, 24, 24, -24, -24, -24, 24, 24, -24, -24, -24, -24, -24, -24, -24, -24, -24, 24, 24, 24, 24, 24, 24, -24, -24, 24, 24, 24, 24, 24, -24, -24, -24, -24, 24, 24, -24, -24, 24, 24] } },\r\n                { name: \"Sunsoft Bass\", midiProgram: 36, settings: { \"type\": \"custom chip\", \"effects\": [\"aliasing\"], \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": -3, \"chord\": \"arpeggio\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 4000, \"linearGain\": 0.5 }], \"unison\": \"none\", \"envelopes\": [], \"customChipWave\": [24, 24, 15, 15, 9, 9, -4, -4, 0, 0, -13, -13, -19, -19, -24, -24, -24, -24, -10, -10, 0, 0, -7, -7, -7, -7, 0, 0, 6, 6, -4, -4, 3, 3, -4, -4, 3, 3, 3, 3, 9, 9, 15, 15, 15, 15, 6, 6, -4, -4, -4, -4, -4, -4, -4, -4, -4, -4, 3, 3, 12, 12, 24, 24] } },\r\n\r\n            ])\r\n        },\r\n        {\r\n            name: \"Keyboard Presets\", presets: <DictionaryArray<Preset>>toNameMap([\r\n                { name: \"grand piano 1\", midiProgram: 0, generalMidi: true, settings: { \"type\": \"Picked String\", \"eqFilter\": [{ \"type\": \"high-pass\", \"cutoffHz\": 148.65, \"linearGain\": 0.7071 }, { \"type\": \"peak\", \"cutoffHz\": 2000, \"linearGain\": 2.8284 }], \"effects\": [\"note filter\", \"reverb\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 8000, \"linearGain\": 0.125 }], \"reverb\": 67, \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": 48, \"chord\": \"simultaneous\", \"harmonics\": [100, 100, 86, 86, 86, 71, 71, 71, 0, 86, 71, 71, 71, 57, 57, 71, 57, 14, 57, 57, 57, 57, 57, 57, 57, 57, 29, 57], \"unison\": \"piano\", \"stringSustain\": 79, \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"note size\" }] } },\r\n                { name: \"bright piano\", midiProgram: 1, generalMidi: true, settings: { \"type\": \"Picked String\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 1681.79, \"linearGain\": 0.7071 }, { \"type\": \"high-pass\", \"cutoffHz\": 148.65, \"linearGain\": 0.5 }, { \"type\": \"peak\", \"cutoffHz\": 3363.59, \"linearGain\": 1.4142 }], \"effects\": [\"reverb\"], \"reverb\": 33, \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": 24, \"chord\": \"simultaneous\", \"harmonics\": [100, 100, 86, 86, 71, 71, 0, 71, 71, 71, 71, 71, 71, 14, 57, 57, 57, 57, 57, 57, 29, 57, 57, 57, 57, 57, 57, 57], \"unison\": \"piano\", \"stringSustain\": 86, \"envelopes\": [] } },\r\n                { name: \"electric grand\", midiProgram: 2, generalMidi: true, settings: { \"type\": \"chip\", \"eqFilter\": [], \"effects\": [\"note filter\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 2378.41, \"linearGain\": 0.5 }], \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": 48, \"chord\": \"simultaneous\", \"wave\": \"1/8 pulse\", \"unison\": \"shimmer\", \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"twang 3\" }] } },\r\n                { name: \"honky-tonk piano\", midiProgram: 3, generalMidi: true, settings: { \"type\": \"Picked String\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 5656.85, \"linearGain\": 0.3536 }], \"effects\": [\"reverb\"], \"reverb\": 33, \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": 48, \"chord\": \"simultaneous\", \"harmonics\": [100, 100, 86, 71, 86, 71, 43, 71, 43, 43, 57, 57, 57, 29, 57, 57, 57, 57, 57, 57, 43, 57, 57, 57, 43, 43, 43, 43], \"unison\": \"honky tonk\", \"stringSustain\": 71, \"envelopes\": [] } },\r\n                { name: \"electric piano 1\", midiProgram: 4, generalMidi: true, settings: { \"type\": \"harmonics\", \"eqFilter\": [], \"effects\": [\"note filter\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 3363.59, \"linearGain\": 0.5 }], \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": -3, \"chord\": \"simultaneous\", \"harmonics\": [86, 100, 100, 71, 71, 57, 57, 43, 43, 43, 29, 29, 29, 14, 14, 14, 0, 0, 0, 0, 0, 57, 0, 0, 0, 0, 0, 0], \"unison\": \"none\", \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"twang 2\" }] } },\r\n                { name: \"electric piano 2\", midiProgram: 5, generalMidi: true, settings: { \"type\": \"FM\", \"eqFilter\": [], \"effects\": [\"note filter\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 13454.34, \"linearGain\": 0.25 }], \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": 48, \"chord\": \"simultaneous\", \"algorithm\": \"1←3 2←4\", \"feedbackType\": \"1⟲ 2⟲\", \"feedbackAmplitude\": 0, \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 12 }, { \"frequency\": \"1×\", \"amplitude\": 6 }, { \"frequency\": \"1×\", \"amplitude\": 9 }, { \"frequency\": \"16×\", \"amplitude\": 6 }], \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"twang 3\" }, { \"target\": \"operatorAmplitude\", \"envelope\": \"twang 3\", \"index\": 3 }] } },\r\n                { name: \"harpsichord\", midiProgram: 6, generalMidi: true, settings: { \"type\": \"Picked String\", \"eqFilter\": [{ \"type\": \"high-pass\", \"cutoffHz\": 250, \"linearGain\": 0.3536 }, { \"type\": \"peak\", \"cutoffHz\": 11313.71, \"linearGain\": 2.8284 }], \"effects\": [\"reverb\"], \"reverb\": 33, \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": 24, \"chord\": \"simultaneous\", \"harmonics\": [100, 100, 100, 86, 57, 86, 86, 86, 86, 57, 57, 71, 71, 86, 86, 71, 71, 86, 86, 71, 71, 71, 71, 71, 71, 71, 71, 71], \"unison\": \"none\", \"stringSustain\": 79, \"envelopes\": [] } },\r\n                { name: \"clavinet\", midiProgram: 7, generalMidi: true, settings: { \"type\": \"FM\", \"eqFilter\": [], \"effects\": [\"note filter\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 19027.31, \"linearGain\": 0.3536 }], \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": -3, \"chord\": \"simultaneous\", \"algorithm\": \"1←(2 3 4)\", \"feedbackType\": \"3⟲\", \"feedbackAmplitude\": 6, \"operators\": [{ \"frequency\": \"3×\", \"amplitude\": 15 }, { \"frequency\": \"~1×\", \"amplitude\": 6 }, { \"frequency\": \"8×\", \"amplitude\": 4 }, { \"frequency\": \"1×\", \"amplitude\": 0 }], \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"twang 2\" }, { \"target\": \"feedbackAmplitude\", \"envelope\": \"twang 2\" }] } },\r\n                { name: \"dulcimer\", midiProgram: 15, generalMidi: true, settings: { \"type\": \"Picked String\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 8000, \"linearGain\": 0.3536 }], \"effects\": [\"reverb\"], \"reverb\": 33, \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": 48, \"chord\": \"strum\", \"harmonics\": [100, 100, 100, 86, 100, 86, 57, 100, 100, 86, 100, 86, 100, 86, 100, 71, 57, 71, 71, 100, 86, 71, 86, 86, 100, 86, 86, 86], \"unison\": \"piano\", \"stringSustain\": 79, \"envelopes\": [] } },\r\n                { name: \"grand piano 2\", midiProgram: 0, generalMidi: true, settings: { \"type\": \"harmonics\", \"eqFilter\": [{ \"type\": \"high-pass\", \"cutoffHz\": 148.65, \"linearGain\": 0.7071 }, { \"type\": \"peak\", \"cutoffHz\": 2000, \"linearGain\": 2.8284 }], \"effects\": [\"note filter\", \"reverb\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 8000, \"linearGain\": 0.125 }], \"reverb\": 67, \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": 48, \"chord\": \"simultaneous\", \"harmonics\": [100, 86, 86, 86, 86, 71, 71, 57, 0, 57, 29, 43, 57, 57, 57, 43, 43, 0, 29, 43, 43, 43, 43, 43, 43, 29, 0, 29], \"unison\": \"piano\", \"stringSustain\": 79, \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"note size\" }] } },\r\n\r\n            ])\r\n        },\r\n        {\r\n            name: \"Idiophone Presets\", presets: <DictionaryArray<Preset>>toNameMap([\r\n                { name: \"celesta\", midiProgram: 8, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"strum\", \"filterCutoffHz\": 5657, \"filterResonance\": 14, \"filterEnvelope\": \"twang 2\", \"vibrato\": \"none\", \"algorithm\": \"(1 2)←(3 4)\", \"feedbackType\": \"1⟲ 2⟲\", \"feedbackAmplitude\": 0, \"feedbackEnvelope\": \"steady\", \"operators\": [{ \"frequency\": \"~1×\", \"amplitude\": 11, \"envelope\": \"custom\" }, { \"frequency\": \"8×\", \"amplitude\": 6, \"envelope\": \"custom\" }, { \"frequency\": \"20×\", \"amplitude\": 3, \"envelope\": \"twang 1\" }, { \"frequency\": \"3×\", \"amplitude\": 1, \"envelope\": \"twang 2\" }] } },\r\n                { name: \"glockenspiel\", midiProgram: 9, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"strum\", \"filterCutoffHz\": 5657, \"filterResonance\": 14, \"filterEnvelope\": \"twang 2\", \"vibrato\": \"none\", \"algorithm\": \"(1 2 3)←4\", \"feedbackType\": \"1⟲ 2⟲ 3⟲\", \"feedbackAmplitude\": 2, \"feedbackEnvelope\": \"decay 1\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 7, \"envelope\": \"custom\" }, { \"frequency\": \"5×\", \"amplitude\": 11, \"envelope\": \"custom\" }, { \"frequency\": \"8×\", \"amplitude\": 7, \"envelope\": \"custom\" }, { \"frequency\": \"20×\", \"amplitude\": 2, \"envelope\": \"twang 1\" }] } },\r\n                { name: \"music box 1\", midiProgram: 10, generalMidi: true, settings: { \"type\": \"Picked String\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 4756.83, \"linearGain\": 0.5 }], \"effects\": [\"reverb\"], \"reverb\": 33, \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": 48, \"chord\": \"strum\", \"harmonics\": [100, 0, 0, 100, 0, 0, 0, 0, 0, 0, 100, 0, 0, 0, 0, 0, 0, 0, 0, 86, 0, 0, 0, 0, 0, 0, 71, 0], \"unison\": \"none\", \"stringSustain\": 64, \"envelopes\": [] } },\r\n                { name: \"music box 2\", midiProgram: 10, settings: { \"type\": \"Picked String\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 2828.43, \"linearGain\": 0.7071 }], \"effects\": [\"reverb\"], \"reverb\": 33, \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": 48, \"chord\": \"strum\", \"harmonics\": [100, 57, 57, 0, 0, 0, 0, 0, 0, 57, 0, 0, 0, 0, 0, 0, 0, 0, 0, 43, 0, 0, 0, 0, 0, 0, 0, 0], \"unison\": \"none\", \"stringSustain\": 29, \"envelopes\": [] } },\r\n                { name: \"vibraphone\", midiProgram: 11, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"harmony\", \"filterCutoffHz\": 2828, \"filterResonance\": 14, \"filterEnvelope\": \"twang 2\", \"vibrato\": \"none\", \"algorithm\": \"1 2 3 4\", \"feedbackType\": \"1→2→3→4\", \"feedbackAmplitude\": 3, \"feedbackEnvelope\": \"twang 1\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 9, \"envelope\": \"custom\" }, { \"frequency\": \"~1×\", \"amplitude\": 9, \"envelope\": \"custom\" }, { \"frequency\": \"9×\", \"amplitude\": 3, \"envelope\": \"custom\" }, { \"frequency\": \"4×\", \"amplitude\": 9, \"envelope\": \"custom\" }] } },\r\n                { name: \"marimba\", midiProgram: 12, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"strum\", \"filterCutoffHz\": 2000, \"filterResonance\": 29, \"filterEnvelope\": \"decay 1\", \"vibrato\": \"none\", \"algorithm\": \"1 2←(3 4)\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 0, \"feedbackEnvelope\": \"steady\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 10, \"envelope\": \"custom\" }, { \"frequency\": \"4×\", \"amplitude\": 6, \"envelope\": \"custom\" }, { \"frequency\": \"13×\", \"amplitude\": 6, \"envelope\": \"twang 1\" }, { \"frequency\": \"1×\", \"amplitude\": 0, \"envelope\": \"steady\" }] } },\r\n                { name: \"kalimba\", midiProgram: 108, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"strum\", \"filterCutoffHz\": 2828, \"filterResonance\": 14, \"filterEnvelope\": \"decay 1\", \"vibrato\": \"none\", \"algorithm\": \"1←(2 3 4)\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 0, \"feedbackEnvelope\": \"steady\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 11, \"envelope\": \"custom\" }, { \"frequency\": \"5×\", \"amplitude\": 3, \"envelope\": \"twang 2\" }, { \"frequency\": \"20×\", \"amplitude\": 3, \"envelope\": \"twang 1\" }, { \"frequency\": \"1×\", \"amplitude\": 0, \"envelope\": \"steady\" }] } },\r\n                { name: \"xylophone\", midiProgram: 13, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"hard\", \"chord\": \"strum\", \"filterCutoffHz\": 2000, \"filterResonance\": 14, \"filterEnvelope\": \"twang 1\", \"vibrato\": \"none\", \"algorithm\": \"(1 2 3)←4\", \"feedbackType\": \"1⟲ 2⟲ 3⟲\", \"feedbackAmplitude\": 0, \"feedbackEnvelope\": \"steady\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 9, \"envelope\": \"custom\" }, { \"frequency\": \"6×\", \"amplitude\": 9, \"envelope\": \"custom\" }, { \"frequency\": \"11×\", \"amplitude\": 9, \"envelope\": \"custom\" }, { \"frequency\": \"20×\", \"amplitude\": 6, \"envelope\": \"twang 1\" }] } },\r\n                { name: \"tubular bell\", midiProgram: 14, generalMidi: true, midiSubharmonicOctaves: 1, settings: { \"type\": \"Picked String\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 4000, \"linearGain\": 0.5 }, { \"type\": \"high-pass\", \"cutoffHz\": 105.11, \"linearGain\": 0.3536 }], \"effects\": [\"reverb\"], \"reverb\": 33, \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": 96, \"chord\": \"strum\", \"harmonics\": [43, 71, 0, 100, 0, 100, 0, 86, 0, 0, 86, 0, 14, 71, 14, 14, 57, 14, 14, 43, 14, 14, 43, 14, 14, 43, 14, 14], \"unison\": \"shimmer\", \"stringSustain\": 86, \"envelopes\": [] } },\r\n                { name: \"bell synth\", midiProgram: 14, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"strum\", \"filterCutoffHz\": 2000, \"filterResonance\": 29, \"filterEnvelope\": \"twang 3\", \"vibrato\": \"none\", \"algorithm\": \"1←(2 3 4)\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 0, \"feedbackEnvelope\": \"steady\", \"operators\": [{ \"frequency\": \"~2×\", \"amplitude\": 10, \"envelope\": \"custom\" }, { \"frequency\": \"7×\", \"amplitude\": 6, \"envelope\": \"twang 3\" }, { \"frequency\": \"20×\", \"amplitude\": 1, \"envelope\": \"twang 1\" }, { \"frequency\": \"1×\", \"amplitude\": 0, \"envelope\": \"steady\" }] } },\r\n                { name: \"rain drop\", midiProgram: 96, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"strum\", \"filterCutoffHz\": 4000, \"filterResonance\": 14, \"filterEnvelope\": \"twang 1\", \"vibrato\": \"none\", \"algorithm\": \"(1 2)←(3 4)\", \"feedbackType\": \"1⟲ 2⟲\", \"feedbackAmplitude\": 0, \"feedbackEnvelope\": \"steady\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 12, \"envelope\": \"custom\" }, { \"frequency\": \"6×\", \"amplitude\": 4, \"envelope\": \"custom\" }, { \"frequency\": \"20×\", \"amplitude\": 3, \"envelope\": \"twang 1\" }, { \"frequency\": \"1×\", \"amplitude\": 6, \"envelope\": \"tremolo1\" }] } },\r\n                { name: \"crystal\", midiProgram: 98, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"harmony\", \"filterCutoffHz\": 2828, \"filterResonance\": 14, \"filterEnvelope\": \"twang 2\", \"vibrato\": \"delayed\", \"algorithm\": \"1 2 3 4\", \"feedbackType\": \"1⟲ 2⟲ 3⟲ 4⟲\", \"feedbackAmplitude\": 4, \"feedbackEnvelope\": \"twang 1\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 10, \"envelope\": \"custom\" }, { \"frequency\": \"3×\", \"amplitude\": 7, \"envelope\": \"custom\" }, { \"frequency\": \"6×\", \"amplitude\": 4, \"envelope\": \"custom\" }, { \"frequency\": \"13×\", \"amplitude\": 4, \"envelope\": \"custom\" }] } },\r\n                { name: \"tinkle bell\", midiProgram: 112, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"hard\", \"chord\": \"strum\", \"filterCutoffHz\": 2828, \"filterResonance\": 14, \"filterEnvelope\": \"twang 2\", \"vibrato\": \"none\", \"algorithm\": \"1 2 3 4\", \"feedbackType\": \"1→2→3→4\", \"feedbackAmplitude\": 5, \"feedbackEnvelope\": \"twang 3\", \"operators\": [{ \"frequency\": \"~2×\", \"amplitude\": 7, \"envelope\": \"custom\" }, { \"frequency\": \"5×\", \"amplitude\": 7, \"envelope\": \"custom\" }, { \"frequency\": \"7×\", \"amplitude\": 7, \"envelope\": \"custom\" }, { \"frequency\": \"16×\", \"amplitude\": 7, \"envelope\": \"custom\" }] } },\r\n                { name: \"agogo\", midiProgram: 113, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"strum\", \"filterCutoffHz\": 4000, \"filterResonance\": 14, \"filterEnvelope\": \"decay 1\", \"vibrato\": \"none\", \"algorithm\": \"1 2 3 4\", \"feedbackType\": \"1→4\", \"feedbackAmplitude\": 15, \"feedbackEnvelope\": \"decay 1\", \"operators\": [{ \"frequency\": \"2×\", \"amplitude\": 9, \"envelope\": \"custom\" }, { \"frequency\": \"5×\", \"amplitude\": 6, \"envelope\": \"custom\" }, { \"frequency\": \"8×\", \"amplitude\": 9, \"envelope\": \"custom\" }, { \"frequency\": \"13×\", \"amplitude\": 11, \"envelope\": \"custom\" }] } },\r\n            ])\r\n        },\r\n        {\r\n            name: \"Guitar Presets\", presets: <DictionaryArray<Preset>>toNameMap([\r\n                { name: \"nylon guitar\", midiProgram: 24, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"strum\", \"filterCutoffHz\": 5657, \"filterResonance\": 14, \"filterEnvelope\": \"twang 1\", \"vibrato\": \"none\", \"algorithm\": \"1←2←3←4\", \"feedbackType\": \"3⟲\", \"feedbackAmplitude\": 6, \"feedbackEnvelope\": \"twang 1\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 15, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 6, \"envelope\": \"steady\" }, { \"frequency\": \"5×\", \"amplitude\": 2, \"envelope\": \"steady\" }, { \"frequency\": \"7×\", \"amplitude\": 4, \"envelope\": \"steady\" }] } },\r\n                { name: \"steel guitar\", midiProgram: 25, generalMidi: true, settings: { \"type\": \"Picked String\", \"eqFilter\": [], \"effects\": [\"reverb\"], \"reverb\": 33, \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": 48, \"chord\": \"strum\", \"harmonics\": [100, 100, 86, 71, 71, 71, 86, 86, 71, 57, 43, 43, 43, 57, 57, 57, 57, 57, 43, 43, 43, 43, 43, 43, 43, 43, 43, 43], \"unison\": \"none\", \"stringSustain\": 71, \"envelopes\": [] } },\r\n                { name: \"jazz guitar\", midiProgram: 26, generalMidi: true, settings: { \"type\": \"harmonics\", \"effects\": \"reverb\", \"transition\": \"hard\", \"chord\": \"strum\", \"filterCutoffHz\": 2000, \"filterResonance\": 14, \"filterEnvelope\": \"twang 2\", \"interval\": \"union\", \"vibrato\": \"none\", \"harmonics\": [100, 100, 86, 71, 57, 71, 71, 43, 57, 71, 57, 43, 29, 29, 29, 29, 29, 29, 29, 29, 14, 14, 14, 14, 14, 14, 14, 0] } },\r\n                { name: \"clean guitar\", midiProgram: 27, generalMidi: true, settings: { \"type\": \"harmonics\", \"effects\": \"reverb\", \"transition\": \"hard\", \"chord\": \"strum\", \"filterCutoffHz\": 2828, \"filterResonance\": 14, \"filterEnvelope\": \"twang 2\", \"interval\": \"union\", \"vibrato\": \"none\", \"harmonics\": [86, 100, 100, 100, 86, 57, 86, 100, 100, 100, 71, 57, 43, 71, 86, 71, 57, 57, 71, 71, 71, 71, 57, 57, 57, 57, 57, 43] } },\r\n                { name: \"muted guitar\", midiProgram: 28, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"hard\", \"chord\": \"strum\", \"filterCutoffHz\": 2000, \"filterResonance\": 14, \"filterEnvelope\": \"twang 1\", \"vibrato\": \"none\", \"algorithm\": \"1←(2 3←4)\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 7, \"feedbackEnvelope\": \"twang 2\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 13, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 4, \"envelope\": \"twang 3\" }, { \"frequency\": \"4×\", \"amplitude\": 4, \"envelope\": \"twang 2\" }, { \"frequency\": \"16×\", \"amplitude\": 4, \"envelope\": \"twang 1\" }] } },\r\n            ])\r\n        },\r\n        {\r\n            name: \"Picked Bass Presets\", presets: <DictionaryArray<Preset>>toNameMap([\r\n                { name: \"acoustic bass\", midiProgram: 32, generalMidi: true, settings: { \"type\": \"harmonics\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"strum\", \"filterCutoffHz\": 4000, \"filterResonance\": 14, \"filterEnvelope\": \"twang 1\", \"interval\": \"union\", \"vibrato\": \"none\", \"harmonics\": [100, 86, 71, 71, 71, 71, 57, 57, 57, 57, 43, 43, 43, 43, 43, 29, 29, 29, 29, 29, 29, 14, 14, 14, 14, 14, 14, 14] } },\r\n                { name: \"fingered bass\", midiProgram: 33, generalMidi: true, settings: { \"type\": \"harmonics\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"strum\", \"filterCutoffHz\": 2828, \"filterResonance\": 14, \"filterEnvelope\": \"twang 1\", \"interval\": \"union\", \"vibrato\": \"none\", \"harmonics\": [100, 86, 71, 57, 71, 43, 57, 29, 29, 29, 29, 29, 29, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 0] } },\r\n                { name: \"picked bass\", midiProgram: 34, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"strum\", \"filterCutoffHz\": 2828, \"filterResonance\": 0, \"filterEnvelope\": \"twang 1\", \"vibrato\": \"none\", \"algorithm\": \"1←(2 3←4)\", \"feedbackType\": \"3⟲\", \"feedbackAmplitude\": 4, \"feedbackEnvelope\": \"twang 1\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 15, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 5, \"envelope\": \"steady\" }, { \"frequency\": \"11×\", \"amplitude\": 1, \"envelope\": \"twang 3\" }, { \"frequency\": \"1×\", \"amplitude\": 9, \"envelope\": \"steady\" }] } },\r\n                { name: \"fretless bass\", midiProgram: 35, generalMidi: true, settings: { \"type\": \"harmonics\", \"effects\": \"reverb\", \"transition\": \"hard\", \"chord\": \"strum\", \"filterCutoffHz\": 1000, \"filterResonance\": 14, \"filterEnvelope\": \"flare 2\", \"interval\": \"union\", \"vibrato\": \"none\", \"harmonics\": [100, 100, 86, 71, 71, 57, 57, 71, 71, 71, 57, 57, 57, 57, 57, 57, 57, 43, 43, 43, 43, 43, 43, 43, 43, 29, 29, 14] } },\r\n                { name: \"slap bass 1\", midiProgram: 36, generalMidi: true, settings: { \"type\": \"harmonics\", \"effects\": \"reverb\", \"transition\": \"hard\", \"chord\": \"strum\", \"filterCutoffHz\": 4000, \"filterResonance\": 0, \"filterEnvelope\": \"twang 1\", \"interval\": \"union\", \"vibrato\": \"none\", \"harmonics\": [100, 100, 100, 100, 86, 71, 57, 29, 29, 43, 43, 57, 71, 57, 29, 29, 43, 57, 57, 57, 43, 43, 43, 57, 71, 71, 71, 71] } },\r\n                { name: \"slap bass 2\", midiProgram: 37, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"hard\", \"chord\": \"strum\", \"filterCutoffHz\": 5657, \"filterResonance\": 0, \"filterEnvelope\": \"twang 1\", \"vibrato\": \"none\", \"algorithm\": \"1←2←3←4\", \"feedbackType\": \"3⟲\", \"feedbackAmplitude\": 4, \"feedbackEnvelope\": \"steady\", \"operators\": [{ \"frequency\": \"3×\", \"amplitude\": 13, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 7, \"envelope\": \"steady\" }, { \"frequency\": \"13×\", \"amplitude\": 3, \"envelope\": \"steady\" }, { \"frequency\": \"1×\", \"amplitude\": 11, \"envelope\": \"steady\" }] } },\r\n                { name: \"bass synth 1\", midiProgram: 38, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"hard\", \"chord\": \"strum\", \"filterCutoffHz\": 4000, \"filterResonance\": 43, \"filterEnvelope\": \"twang 2\", \"vibrato\": \"none\", \"algorithm\": \"1←3 2←4\", \"feedbackType\": \"3⟲ 4⟲\", \"feedbackAmplitude\": 9, \"feedbackEnvelope\": \"twang 2\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 15, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 10, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 14, \"envelope\": \"twang 1\" }, { \"frequency\": \"~1×\", \"amplitude\": 13, \"envelope\": \"twang 2\" }] } },\r\n                { name: \"bass synth 2\", midiProgram: 39, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"strum\", \"filterCutoffHz\": 1000, \"filterResonance\": 57, \"filterEnvelope\": \"punch\", \"vibrato\": \"none\", \"algorithm\": \"1←(2 3 4)\", \"feedbackType\": \"1→2\", \"feedbackAmplitude\": 4, \"feedbackEnvelope\": \"twang 3\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 9, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 9, \"envelope\": \"steady\" }, { \"frequency\": \"3×\", \"amplitude\": 0, \"envelope\": \"steady\" }, { \"frequency\": \"1×\", \"amplitude\": 0, \"envelope\": \"steady\" }] } },\r\n                { name: \"bass & lead\", midiProgram: 87, generalMidi: true, settings: { \"type\": \"chip\", \"transition\": \"hard\", \"effects\": \"reverb\", \"chord\": \"harmony\", \"filterCutoffHz\": 4000, \"filterResonance\": 86, \"filterEnvelope\": \"twang 2\", \"wave\": \"sawtooth\", \"interval\": \"shimmer\", \"vibrato\": \"none\" } },\r\n                { name: \"dubstep yoi yoi\", midiProgram: 87, settings: { \"type\": \"chip\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 6727.17, \"linearGain\": 0.7071 }], \"effects\": [\"note filter\", \"bitcrusher\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 594.6, \"linearGain\": 11.3137 }], \"bitcrusherOctave\": 1.5, \"bitcrusherQuantization\": 0, \"transition\": \"slide\", \"fadeInSeconds\": 0.0263, \"fadeOutTicks\": -3, \"chord\": \"arpeggio\", \"wave\": \"sawtooth\", \"unison\": \"none\", \"envelopes\": [{ \"target\": \"noteFilterFreq\", \"envelope\": \"flare 2\", \"index\": 0 }] } },\r\n            ])\r\n        },\r\n        {\r\n            name: \"Picked String Presets\", presets: <DictionaryArray<Preset>>toNameMap([\r\n                { name: \"pizzicato strings\", midiProgram: 45, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"medium fade\", \"chord\": \"harmony\", \"filterCutoffHz\": 1000, \"filterResonance\": 14, \"filterEnvelope\": \"twang 1\", \"vibrato\": \"none\", \"algorithm\": \"(1 2 3)←4\", \"feedbackType\": \"1⟲ 2⟲ 3⟲ 4⟲\", \"feedbackAmplitude\": 7, \"feedbackEnvelope\": \"twang 1\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 14, \"envelope\": \"custom\" }, { \"frequency\": \"3×\", \"amplitude\": 11, \"envelope\": \"custom\" }, { \"frequency\": \"6×\", \"amplitude\": 9, \"envelope\": \"custom\" }, { \"frequency\": \"~1×\", \"amplitude\": 10, \"envelope\": \"steady\" }] } },\r\n                { name: \"harp\", midiProgram: 46, generalMidi: true, settings: { \"type\": \"FM\", \"transition\": \"hard fade\", \"effects\": \"reverb\", \"chord\": \"strum\", \"filterCutoffHz\": 2828, \"filterResonance\": 0, \"filterEnvelope\": \"twang 1\", \"vibrato\": \"none\", \"algorithm\": \"1←3 2←4\", \"feedbackType\": \"3⟲\", \"feedbackAmplitude\": 6, \"feedbackEnvelope\": \"twang 2\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 15, \"envelope\": \"custom\" }, { \"frequency\": \"4×\", \"amplitude\": 6, \"envelope\": \"custom\" }, { \"frequency\": \"~2×\", \"amplitude\": 3, \"envelope\": \"steady\" }, { \"frequency\": \"1×\", \"amplitude\": 6, \"envelope\": \"steady\" }] } },\r\n                { name: \"sitar\", midiProgram: 104, generalMidi: true, settings: { \"type\": \"FM\", \"transition\": \"hard fade\", \"effects\": \"reverb\", \"chord\": \"strum\", \"filterCutoffHz\": 8000, \"filterResonance\": 57, \"filterEnvelope\": \"twang 2\", \"vibrato\": \"none\", \"algorithm\": \"1←(2 3 4)\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 0, \"feedbackEnvelope\": \"steady\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 15, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 14, \"envelope\": \"twang 3\" }, { \"frequency\": \"9×\", \"amplitude\": 3, \"envelope\": \"twang 3\" }, { \"frequency\": \"16×\", \"amplitude\": 9, \"envelope\": \"swell 3\" }] } },\r\n                { name: \"banjo\", midiProgram: 105, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"strum\", \"filterCutoffHz\": 2828, \"filterResonance\": 14, \"filterEnvelope\": \"twang 2\", \"vibrato\": \"none\", \"algorithm\": \"1←(2 3←4)\", \"feedbackType\": \"2⟲\", \"feedbackAmplitude\": 4, \"feedbackEnvelope\": \"steady\", \"operators\": [{ \"frequency\": \"4×\", \"amplitude\": 14, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 10, \"envelope\": \"steady\" }, { \"frequency\": \"11×\", \"amplitude\": 3, \"envelope\": \"twang 3\" }, { \"frequency\": \"1×\", \"amplitude\": 11, \"envelope\": \"steady\" }] } },\r\n                { name: \"ukulele\", midiProgram: 105, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"strum\", \"filterCutoffHz\": 2000, \"filterResonance\": 0, \"filterEnvelope\": \"twang 1\", \"vibrato\": \"none\", \"algorithm\": \"1←(2 3←4)\", \"feedbackType\": \"3⟲\", \"feedbackAmplitude\": 5, \"feedbackEnvelope\": \"twang 1\", \"operators\": [{ \"frequency\": \"2×\", \"amplitude\": 14, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 6, \"envelope\": \"steady\" }, { \"frequency\": \"9×\", \"amplitude\": 4, \"envelope\": \"twang 2\" }, { \"frequency\": \"1×\", \"amplitude\": 11, \"envelope\": \"steady\" }] } },\r\n                { name: \"shamisen\", midiProgram: 106, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"harmony\", \"filterCutoffHz\": 8000, \"filterResonance\": 14, \"filterEnvelope\": \"twang 1\", \"vibrato\": \"none\", \"algorithm\": \"1←(2 3←4)\", \"feedbackType\": \"3⟲\", \"feedbackAmplitude\": 9, \"feedbackEnvelope\": \"twang 3\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 15, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 12, \"envelope\": \"steady\" }, { \"frequency\": \"16×\", \"amplitude\": 4, \"envelope\": \"twang 3\" }, { \"frequency\": \"1×\", \"amplitude\": 7, \"envelope\": \"steady\" }] } },\r\n                { name: \"koto\", midiProgram: 107, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"harmony\", \"filterCutoffHz\": 4000, \"filterResonance\": 14, \"filterEnvelope\": \"twang 2\", \"vibrato\": \"none\", \"algorithm\": \"1←3 2←4\", \"feedbackType\": \"1⟲ 2⟲\", \"feedbackAmplitude\": 5, \"feedbackEnvelope\": \"twang 2\", \"operators\": [{ \"frequency\": \"~1×\", \"amplitude\": 12, \"envelope\": \"custom\" }, { \"frequency\": \"6×\", \"amplitude\": 10, \"envelope\": \"custom\" }, { \"frequency\": \"4×\", \"amplitude\": 8, \"envelope\": \"twang 3\" }, { \"frequency\": \"~2×\", \"amplitude\": 8, \"envelope\": \"twang 3\" }] } },\r\n            ])\r\n        },\r\n        {\r\n            name: \"Distortion Presets\", presets: <DictionaryArray<Preset>>toNameMap([\r\n                { name: \"overdrive guitar\", midiProgram: 29, generalMidi: true, settings: { \"type\": \"Picked String\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 4756.83, \"linearGain\": 0.7071 }, { \"type\": \"high-pass\", \"cutoffHz\": 210.22, \"linearGain\": 1 }, { \"type\": \"low-pass\", \"cutoffHz\": 5656.85, \"linearGain\": 1 }, { \"type\": \"peak\", \"cutoffHz\": 840.9, \"linearGain\": 0.5 }], \"effects\": [\"note filter\", \"distortion\"], \"noteFilter\": [{ \"type\": \"high-pass\", \"cutoffHz\": 297.3, \"linearGain\": 2 }, { \"type\": \"low-pass\", \"cutoffHz\": 2378.41, \"linearGain\": 0.7071 }], \"distortion\": 71, \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": 12, \"chord\": \"strum\", \"harmonics\": [86, 100, 100, 86, 86, 86, 86, 71, 71, 71, 71, 71, 71, 71, 71, 71, 71, 57, 57, 57, 57, 57, 57, 57, 57, 57, 57, 57], \"unison\": \"none\", \"stringSustain\": 71, \"envelopes\": [{ \"target\": \"noteFilterFreq\", \"envelope\": \"note size\", \"index\": 1 }] } },\r\n                { name: \"distortion guitar\", midiProgram: 30, generalMidi: true, settings: { \"type\": \"Picked String\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 4756.83, \"linearGain\": 0.7071 }, { \"type\": \"high-pass\", \"cutoffHz\": 210.22, \"linearGain\": 1 }, { \"type\": \"low-pass\", \"cutoffHz\": 5656.85, \"linearGain\": 1 }, { \"type\": \"peak\", \"cutoffHz\": 594.6, \"linearGain\": 0.3536 }, { \"type\": \"peak\", \"cutoffHz\": 1000, \"linearGain\": 0.25 }], \"effects\": [\"note filter\", \"distortion\", \"reverb\"], \"noteFilter\": [{ \"type\": \"high-pass\", \"cutoffHz\": 353.55, \"linearGain\": 2 }, { \"type\": \"low-pass\", \"cutoffHz\": 2000, \"linearGain\": 1 }], \"distortion\": 86, \"reverb\": 67, \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": 12, \"chord\": \"strum\", \"harmonics\": [86, 100, 100, 86, 86, 86, 86, 71, 71, 71, 71, 71, 71, 71, 71, 71, 71, 57, 57, 57, 57, 57, 57, 57, 57, 57, 57, 57], \"unison\": \"none\", \"stringSustain\": 71, \"envelopes\": [{ \"target\": \"noteFilterFreq\", \"envelope\": \"note size\", \"index\": 1 }] } },\r\n                { name: \"charango synth\", midiProgram: 84, generalMidi: true, settings: { \"type\": \"FM\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 11313.71, \"linearGain\": 1 }], \"effects\": [], \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": -3, \"chord\": \"strum\", \"algorithm\": \"1←(2 3←4)\", \"feedbackType\": \"1→2→3→4\", \"feedbackAmplitude\": 8, \"operators\": [{ \"frequency\": \"3×\", \"amplitude\": 13 }, { \"frequency\": \"~1×\", \"amplitude\": 5 }, { \"frequency\": \"4×\", \"amplitude\": 6 }, { \"frequency\": \"3×\", \"amplitude\": 7 }], \"envelopes\": [{ \"target\": \"feedbackAmplitude\", \"envelope\": \"twang 3\" }] } },\r\n                { name: \"guitar harmonics\", midiProgram: 31, generalMidi: true, settings: { \"type\": \"FM\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 4000, \"linearGain\": 2 }], \"effects\": [\"reverb\"], \"reverb\": 33, \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": -3, \"chord\": \"strum\", \"algorithm\": \"1←(2 3)←4\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 2, \"operators\": [{ \"frequency\": \"4×\", \"amplitude\": 12 }, { \"frequency\": \"16×\", \"amplitude\": 5 }, { \"frequency\": \"1×\", \"amplitude\": 2 }, { \"frequency\": \"~1×\", \"amplitude\": 12 }], \"envelopes\": [{ \"target\": \"operatorAmplitude\", \"envelope\": \"swell 1\", \"index\": 1 }, { \"target\": \"operatorAmplitude\", \"envelope\": \"punch\", \"index\": 2 }, { \"target\": \"operatorAmplitude\", \"envelope\": \"twang 1\", \"index\": 3 }] } },\r\n                { name: \"PWM overdrive\", midiProgram: 29, settings: { \"type\": \"PWM\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 5656.85, \"linearGain\": 1.4142 }], \"effects\": [], \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": -3, \"chord\": \"strum\", \"pulseWidth\": 17.67767, \"envelopes\": [{ \"target\": \"pulseWidth\", \"envelope\": \"punch\" }] } },\r\n                { name: \"PWM distortion\", midiProgram: 30, settings: { \"type\": \"PWM\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 3363.59, \"linearGain\": 2 }], \"effects\": [\"vibrato\"], \"vibrato\": \"delayed\", \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": -3, \"chord\": \"strum\", \"pulseWidth\": 50, \"envelopes\": [{ \"target\": \"pulseWidth\", \"envelope\": \"swell 1\" }] } },\r\n                { name: \"FM overdrive\", midiProgram: 29, settings: { \"type\": \"FM\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 4756.83, \"linearGain\": 1 }], \"effects\": [\"reverb\"], \"reverb\": 33, \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": -3, \"chord\": \"strum\", \"algorithm\": \"1←(2 3←4)\", \"feedbackType\": \"1→2\", \"feedbackAmplitude\": 2, \"operators\": [{ \"frequency\": \"~1×\", \"amplitude\": 15 }, { \"frequency\": \"1×\", \"amplitude\": 12 }, { \"frequency\": \"~2×\", \"amplitude\": 6 }, { \"frequency\": \"1×\", \"amplitude\": 12 }], \"envelopes\": [{ \"target\": \"operatorAmplitude\", \"envelope\": \"twang 1\", \"index\": 2 }, { \"target\": \"operatorAmplitude\", \"envelope\": \"swell 3\", \"index\": 3 }, { \"target\": \"feedbackAmplitude\", \"envelope\": \"punch\" }] } },\r\n                { name: \"FM distortion\", midiProgram: 30, settings: { \"type\": \"FM\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 4000, \"linearGain\": 2 }], \"effects\": [\"reverb\"], \"reverb\": 33, \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": -3, \"chord\": \"strum\", \"algorithm\": \"1←(2 3←4)\", \"feedbackType\": \"1→2\", \"feedbackAmplitude\": 4, \"operators\": [{ \"frequency\": \"~1×\", \"amplitude\": 15 }, { \"frequency\": \"1×\", \"amplitude\": 11 }, { \"frequency\": \"1×\", \"amplitude\": 9 }, { \"frequency\": \"~2×\", \"amplitude\": 4 }], \"envelopes\": [{ \"target\": \"operatorAmplitude\", \"envelope\": \"swell 1\", \"index\": 2 }, { \"target\": \"operatorAmplitude\", \"envelope\": \"swell 3\", \"index\": 3 }] } },\r\n            ])\r\n        },\r\n        {\r\n            name: \"Bellows Presets\", presets: <DictionaryArray<Preset>>toNameMap([\r\n                { name: \"drawbar organ 1\", midiProgram: 16, generalMidi: true, midiSubharmonicOctaves: 1, settings: { \"type\": \"harmonics\", \"effects\": \"reverb\", \"transition\": \"hard\", \"chord\": \"harmony\", \"filterCutoffHz\": 2828, \"filterResonance\": 14, \"filterEnvelope\": \"steady\", \"interval\": \"union\", \"vibrato\": \"none\", \"harmonics\": [86, 86, 0, 86, 0, 0, 0, 86, 0, 0, 0, 0, 0, 0, 0, 86, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] } },\r\n                { name: \"drawbar organ 2\", midiProgram: 16, midiSubharmonicOctaves: 1, settings: { \"type\": \"harmonics\", \"effects\": \"reverb\", \"transition\": \"hard\", \"chord\": \"harmony\", \"filterCutoffHz\": 2828, \"filterResonance\": 14, \"filterEnvelope\": \"steady\", \"interval\": \"union\", \"vibrato\": \"none\", \"harmonics\": [86, 29, 71, 86, 71, 14, 0, 100, 0, 0, 0, 86, 0, 0, 0, 71, 0, 0, 0, 57, 0, 0, 0, 29, 0, 0, 0, 0] } },\r\n                { name: \"percussive organ\", midiProgram: 17, generalMidi: true, midiSubharmonicOctaves: 1, settings: { \"type\": \"FM\", \"transition\": \"hard\", \"effects\": \"reverb\", \"chord\": \"harmony\", \"filterCutoffHz\": 2000, \"filterResonance\": 14, \"filterEnvelope\": \"punch\", \"vibrato\": \"light\", \"algorithm\": \"1 2 3 4\", \"feedbackType\": \"1→3 2→4\", \"feedbackAmplitude\": 7, \"feedbackEnvelope\": \"decay 1\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 7, \"envelope\": \"custom\" }, { \"frequency\": \"2×\", \"amplitude\": 7, \"envelope\": \"custom\" }, { \"frequency\": \"3×\", \"amplitude\": 8, \"envelope\": \"custom\" }, { \"frequency\": \"4×\", \"amplitude\": 8, \"envelope\": \"custom\" }] } },\r\n                { name: \"rock organ\", midiProgram: 18, generalMidi: true, midiSubharmonicOctaves: 1, settings: { \"type\": \"FM\", \"effects\": \"chorus & reverb\", \"transition\": \"hard\", \"chord\": \"harmony\", \"filterCutoffHz\": 4000, \"filterResonance\": 14, \"filterEnvelope\": \"punch\", \"vibrato\": \"delayed\", \"algorithm\": \"(1 2 3)←4\", \"feedbackType\": \"1⟲ 2⟲ 3⟲\", \"feedbackAmplitude\": 2, \"feedbackEnvelope\": \"flare 1\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 9, \"envelope\": \"custom\" }, { \"frequency\": \"4×\", \"amplitude\": 9, \"envelope\": \"custom\" }, { \"frequency\": \"6×\", \"amplitude\": 9, \"envelope\": \"custom\" }, { \"frequency\": \"2×\", \"amplitude\": 5, \"envelope\": \"steady\" }] } },\r\n                { name: \"pipe organ\", midiProgram: 19, generalMidi: true, midiSubharmonicOctaves: 1, settings: { \"type\": \"FM\", \"transition\": \"cross fade\", \"effects\": \"reverb\", \"chord\": \"harmony\", \"filterCutoffHz\": 5657, \"filterResonance\": 43, \"filterEnvelope\": \"steady\", \"vibrato\": \"none\", \"algorithm\": \"1 2 3 4\", \"feedbackType\": \"1⟲ 2⟲ 3⟲ 4⟲\", \"feedbackAmplitude\": 5, \"feedbackEnvelope\": \"steady\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 8, \"envelope\": \"custom\" }, { \"frequency\": \"2×\", \"amplitude\": 9, \"envelope\": \"custom\" }, { \"frequency\": \"4×\", \"amplitude\": 9, \"envelope\": \"custom\" }, { \"frequency\": \"8×\", \"amplitude\": 8, \"envelope\": \"custom\" }] } },\r\n                { name: \"reed organ\", midiProgram: 20, generalMidi: true, settings: { \"type\": \"harmonics\", \"effects\": \"reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 2000, \"filterResonance\": 29, \"filterEnvelope\": \"steady\", \"interval\": \"union\", \"vibrato\": \"none\", \"harmonics\": [71, 86, 100, 86, 71, 100, 57, 71, 71, 71, 43, 43, 43, 71, 43, 71, 57, 57, 57, 57, 57, 57, 57, 29, 43, 29, 29, 14] } },\r\n                { name: \"accordion\", midiProgram: 21, generalMidi: true, settings: { \"type\": \"chip\", \"effects\": \"reverb\", \"transition\": \"cross fade\", \"chord\": \"harmony\", \"filterCutoffHz\": 5657, \"filterResonance\": 0, \"filterEnvelope\": \"swell 1\", \"wave\": \"double saw\", \"interval\": \"honky tonk\", \"vibrato\": \"none\" } },\r\n                { name: \"bandoneon\", midiProgram: 23, generalMidi: true, settings: { \"type\": \"harmonics\", \"effects\": \"reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 4000, \"filterResonance\": 29, \"filterEnvelope\": \"swell 1\", \"interval\": \"hum\", \"vibrato\": \"none\", \"harmonics\": [86, 86, 86, 57, 71, 86, 57, 71, 71, 71, 57, 43, 57, 43, 71, 43, 71, 57, 57, 43, 43, 43, 57, 43, 43, 29, 29, 29] } },\r\n                { name: \"bagpipe\", midiProgram: 109, generalMidi: true, settings: { \"type\": \"harmonics\", \"effects\": \"reverb\", \"transition\": \"cross fade\", \"chord\": \"harmony\", \"filterCutoffHz\": 5657, \"filterResonance\": 43, \"filterEnvelope\": \"punch\", \"interval\": \"hum\", \"vibrato\": \"none\", \"harmonics\": [71, 86, 86, 100, 100, 86, 57, 100, 86, 71, 71, 71, 57, 57, 57, 71, 57, 71, 57, 71, 43, 57, 57, 43, 43, 43, 43, 43] } },\r\n            ])\r\n        },\r\n        {\r\n            name: \"String Presets\", presets: <DictionaryArray<Preset>>toNameMap([\r\n                { name: \"violin 1\", midiProgram: 40, generalMidi: true, settings: { \"type\": \"FM\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 4000, \"linearGain\": 1.4142 }, { \"type\": \"high-pass\", \"cutoffHz\": 105.11, \"linearGain\": 0.3536 }], \"effects\": [\"vibrato\", \"reverb\"], \"vibrato\": \"delayed\", \"reverb\": 67, \"transition\": \"normal\", \"fadeInSeconds\": 0.0413, \"fadeOutTicks\": 6, \"chord\": \"simultaneous\", \"algorithm\": \"(1 2)←(3 4)\", \"feedbackType\": \"1→2\", \"feedbackAmplitude\": 5, \"operators\": [{ \"frequency\": \"4×\", \"amplitude\": 9 }, { \"frequency\": \"3×\", \"amplitude\": 9 }, { \"frequency\": \"2×\", \"amplitude\": 7 }, { \"frequency\": \"7×\", \"amplitude\": 5 }], \"envelopes\": [{ \"target\": \"operatorAmplitude\", \"envelope\": \"swell 1\", \"index\": 3 }, { \"target\": \"feedbackAmplitude\", \"envelope\": \"twang 3\" }] } },\r\n                { name: \"viola\", midiProgram: 41, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"cross fade\", \"chord\": \"harmony\", \"filterCutoffHz\": 2000, \"filterResonance\": 29, \"filterEnvelope\": \"steady\", \"vibrato\": \"delayed\", \"algorithm\": \"(1 2 3)←4\", \"feedbackType\": \"1⟲ 2⟲ 3⟲\", \"feedbackAmplitude\": 8, \"feedbackEnvelope\": \"swell 1\", \"operators\": [{ \"frequency\": \"2×\", \"amplitude\": 11, \"envelope\": \"custom\" }, { \"frequency\": \"7×\", \"amplitude\": 7, \"envelope\": \"custom\" }, { \"frequency\": \"13×\", \"amplitude\": 4, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 5, \"envelope\": \"steady\" }] } },\r\n                { name: \"cello\", midiProgram: 42, generalMidi: true, settings: { \"type\": \"FM\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 4000, \"linearGain\": 0.1768 }, { \"type\": \"high-pass\", \"cutoffHz\": 297.3, \"linearGain\": 0.7071 }, { \"type\": \"peak\", \"cutoffHz\": 4756.83, \"linearGain\": 5.6569 }], \"effects\": [\"note filter\", \"reverb\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 16000, \"linearGain\": 0.0884 }], \"reverb\": 67, \"transition\": \"normal\", \"fadeInSeconds\": 0.0125, \"fadeOutTicks\": 12, \"chord\": \"simultaneous\", \"algorithm\": \"(1 2)←3←4\", \"feedbackType\": \"1⟲ 2⟲\", \"feedbackAmplitude\": 3, \"operators\": [{ \"frequency\": \"16×\", \"amplitude\": 5 }, { \"frequency\": \"~1×\", \"amplitude\": 10 }, { \"frequency\": \"1×\", \"amplitude\": 9 }, { \"frequency\": \"6×\", \"amplitude\": 3 }], \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"swell 1\" }, { \"target\": \"operatorAmplitude\", \"envelope\": \"swell 1\", \"index\": 3 }] } },\r\n                { name: \"contrabass\", midiProgram: 43, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"cross fade\", \"chord\": \"harmony\", \"filterCutoffHz\": 2000, \"filterResonance\": 29, \"filterEnvelope\": \"steady\", \"vibrato\": \"delayed\", \"algorithm\": \"(1 2)←3←4\", \"feedbackType\": \"1⟲ 2⟲\", \"feedbackAmplitude\": 0, \"feedbackEnvelope\": \"steady\", \"operators\": [{ \"frequency\": \"16×\", \"amplitude\": 5, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 10, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 10, \"envelope\": \"steady\" }, { \"frequency\": \"6×\", \"amplitude\": 3, \"envelope\": \"swell 1\" }] } },\r\n                { name: \"fiddle\", midiProgram: 110, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 2828, \"filterResonance\": 29, \"filterEnvelope\": \"steady\", \"vibrato\": \"delayed\", \"algorithm\": \"(1 2)←(3 4)\", \"feedbackType\": \"3⟲ 4⟲\", \"feedbackAmplitude\": 5, \"feedbackEnvelope\": \"twang 1\", \"operators\": [{ \"frequency\": \"2×\", \"amplitude\": 10, \"envelope\": \"custom\" }, { \"frequency\": \"8×\", \"amplitude\": 8, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 8, \"envelope\": \"steady\" }, { \"frequency\": \"16×\", \"amplitude\": 3, \"envelope\": \"steady\" }] } },\r\n                { name: \"tremolo strings\", midiProgram: 44, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"chorus & reverb\", \"transition\": \"medium fade\", \"chord\": \"harmony\", \"filterCutoffHz\": 2000, \"filterResonance\": 0, \"filterEnvelope\": \"tremolo4\", \"vibrato\": \"none\", \"algorithm\": \"1 2 3 4\", \"feedbackType\": \"1→2→3→4\", \"feedbackAmplitude\": 12, \"feedbackEnvelope\": \"steady\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 8, \"envelope\": \"custom\" }, { \"frequency\": \"~2×\", \"amplitude\": 8, \"envelope\": \"custom\" }, { \"frequency\": \"4×\", \"amplitude\": 8, \"envelope\": \"custom\" }, { \"frequency\": \"7×\", \"amplitude\": 8, \"envelope\": \"custom\" }] } },\r\n                { name: \"strings\", midiProgram: 48, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"chorus & reverb\", \"transition\": \"cross fade\", \"chord\": \"harmony\", \"filterCutoffHz\": 2828, \"filterResonance\": 43, \"filterEnvelope\": \"steady\", \"vibrato\": \"none\", \"algorithm\": \"(1 2)←(3 4)\", \"feedbackType\": \"4⟲\", \"feedbackAmplitude\": 5, \"feedbackEnvelope\": \"twang 3\", \"operators\": [{ \"frequency\": \"4×\", \"amplitude\": 9, \"envelope\": \"custom\" }, { \"frequency\": \"3×\", \"amplitude\": 9, \"envelope\": \"custom\" }, { \"frequency\": \"2×\", \"amplitude\": 7, \"envelope\": \"steady\" }, { \"frequency\": \"7×\", \"amplitude\": 3, \"envelope\": \"swell 1\" }] } },\r\n                { name: \"slow strings\", midiProgram: 49, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"chorus & reverb\", \"transition\": \"soft fade\", \"chord\": \"harmony\", \"filterCutoffHz\": 1414, \"filterResonance\": 0, \"filterEnvelope\": \"swell 2\", \"vibrato\": \"none\", \"algorithm\": \"(1 2)←(3 4)\", \"feedbackType\": \"4⟲\", \"feedbackAmplitude\": 6, \"feedbackEnvelope\": \"flare 3\", \"operators\": [{ \"frequency\": \"4×\", \"amplitude\": 10, \"envelope\": \"custom\" }, { \"frequency\": \"3×\", \"amplitude\": 10, \"envelope\": \"custom\" }, { \"frequency\": \"2×\", \"amplitude\": 7, \"envelope\": \"steady\" }, { \"frequency\": \"7×\", \"amplitude\": 4, \"envelope\": \"swell 1\" }] } },\r\n                { name: \"strings synth 1\", midiProgram: 50, generalMidi: true, settings: { \"type\": \"chip\", \"transition\": \"soft fade\", \"effects\": \"chorus & reverb\", \"chord\": \"harmony\", \"filterCutoffHz\": 1414, \"filterResonance\": 43, \"filterEnvelope\": \"steady\", \"wave\": \"sawtooth\", \"interval\": \"hum\", \"vibrato\": \"delayed\" } },\r\n                { name: \"strings synth 2\", midiProgram: 51, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"chorus & reverb\", \"transition\": \"soft fade\", \"chord\": \"harmony\", \"filterCutoffHz\": 2000, \"filterResonance\": 43, \"filterEnvelope\": \"steady\", \"vibrato\": \"none\", \"algorithm\": \"1 2 3 4\", \"feedbackType\": \"1⟲ 2⟲ 3⟲ 4⟲\", \"feedbackAmplitude\": 12, \"feedbackEnvelope\": \"swell 1\", \"operators\": [{ \"frequency\": \"3×\", \"amplitude\": 6, \"envelope\": \"custom\" }, { \"frequency\": \"2×\", \"amplitude\": 7, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 8, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 9, \"envelope\": \"custom\" }] } },\r\n                { name: \"orchestra hit 1\", midiProgram: 55, generalMidi: true, midiSubharmonicOctaves: 1, settings: { \"type\": \"FM\", \"effects\": \"chorus & reverb\", \"transition\": \"hard fade\", \"chord\": \"harmony\", \"filterCutoffHz\": 8000, \"filterResonance\": 14, \"filterEnvelope\": \"custom\", \"vibrato\": \"none\", \"algorithm\": \"1 2 3 4\", \"feedbackType\": \"1⟲ 2⟲ 3⟲ 4⟲\", \"feedbackAmplitude\": 14, \"feedbackEnvelope\": \"twang 3\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 15, \"envelope\": \"twang 3\" }, { \"frequency\": \"2×\", \"amplitude\": 15, \"envelope\": \"flare 3\" }, { \"frequency\": \"4×\", \"amplitude\": 15, \"envelope\": \"flare 2\" }, { \"frequency\": \"8×\", \"amplitude\": 15, \"envelope\": \"flare 1\" }] } },\r\n                { name: \"violin 2\", midiProgram: 40, generalMidi: true, settings: { \"type\": \"FM\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 2828, \"linearGain\": 1.4142 }, { \"type\": \"high-pass\", \"cutoffHz\": 105.11, \"linearGain\": 0.3536 }], \"effects\": [\"vibrato\", \"reverb\"], \"vibrato\": \"light\", \"reverb\": 67, \"transition\": \"normal\", \"fadeInSeconds\": 0.0413, \"fadeOutTicks\": 6, \"chord\": \"simultaneous\", \"algorithm\": \"(1 2)←(3 4)\", \"feedbackType\": \"4⟲\", \"feedbackAmplitude\": 5, \"feedbackEnvelope\": \"twang 3\", \"operators\": [{ \"frequency\": \"4×\", \"amplitude\": 15, \"envelope\": \"custom\" }, { \"frequency\": \"3×\", \"amplitude\": 13, \"envelope\": \"custom\" }, { \"frequency\": \"2×\", \"amplitude\": 7, \"envelope\": \"steady\" }, { \"frequency\": \"7×\", \"amplitude\": 8, \"envelope\": \"swell 1\" }] } },\r\n                { name: \"orchestra hit 2\", midiProgram: 55, midiSubharmonicOctaves: 1, settings: { \"type\": \"FM\", \"effects\": \"chorus & reverb\", \"transition\": \"medium fade\", \"chord\": \"harmony\", \"filterCutoffHz\": 8000, \"filterResonance\": 0, \"filterEnvelope\": \"decay 1\", \"vibrato\": \"delayed\", \"algorithm\": \"1 2 3 4\", \"feedbackType\": \"1⟲ 2⟲ 3⟲ 4⟲\", \"feedbackAmplitude\": 14, \"feedbackEnvelope\": \"steady\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 12, \"envelope\": \"custom\" }, { \"frequency\": \"2×\", \"amplitude\": 14, \"envelope\": \"custom\" }, { \"frequency\": \"3×\", \"amplitude\": 12, \"envelope\": \"custom\" }, { \"frequency\": \"4×\", \"amplitude\": 14, \"envelope\": \"custom\" }] } },\r\n            ])\r\n        },\r\n        {\r\n            name: \"Vocal Presets\", presets: <DictionaryArray<Preset>>toNameMap([\r\n                { name: \"choir soprano\", midiProgram: 94, generalMidi: true, settings: { \"type\": \"harmonics\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 2828.43, \"linearGain\": 2 }, { \"type\": \"peak\", \"cutoffHz\": 1189.21, \"linearGain\": 5.6569 }, { \"type\": \"high-pass\", \"cutoffHz\": 707.11, \"linearGain\": 2.8284 }, { \"type\": \"peak\", \"cutoffHz\": 2000, \"linearGain\": 0.0884 }, { \"type\": \"peak\", \"cutoffHz\": 840.9, \"linearGain\": 0.25 }, { \"type\": \"low-pass\", \"cutoffHz\": 6727.17, \"linearGain\": 11.3137 }], \"effects\": [\"vibrato\", \"chorus\", \"reverb\"], \"vibrato\": \"shaky\", \"chorus\": 100, \"reverb\": 33, \"fadeInSeconds\": 0.0413, \"fadeOutTicks\": 24, \"harmonics\": [100, 100, 86, 57, 29, 29, 57, 71, 57, 29, 14, 14, 14, 29, 43, 57, 43, 29, 14, 14, 14, 14, 14, 14, 0, 0, 0, 0], \"unison\": \"none\", \"envelopes\": [] } },\r\n                { name: \"choir tenor\", midiProgram: 52, generalMidi: true, settings: { \"type\": \"harmonics\", \"eqFilter\": [{ \"type\": \"peak\", \"cutoffHz\": 1000, \"linearGain\": 11.3137 }, { \"type\": \"peak\", \"cutoffHz\": 707.11, \"linearGain\": 5.6569 }, { \"type\": \"peak\", \"cutoffHz\": 840.9, \"linearGain\": 0.0884 }, { \"type\": \"peak\", \"cutoffHz\": 1681.79, \"linearGain\": 0.0884 }, { \"type\": \"high-pass\", \"cutoffHz\": 297.3, \"linearGain\": 0.7071 }, { \"type\": \"low-pass\", \"cutoffHz\": 2828.43, \"linearGain\": 11.3137 }], \"effects\": [\"vibrato\", \"chorus\", \"reverb\"], \"vibrato\": \"shaky\", \"chorus\": 100, \"reverb\": 67, \"transition\": \"normal\", \"fadeInSeconds\": 0.0413, \"fadeOutTicks\": 48, \"chord\": \"simultaneous\", \"harmonics\": [86, 100, 100, 86, 71, 57, 43, 29, 29, 29, 29, 43, 43, 43, 29, 29, 29, 29, 29, 29, 29, 29, 29, 14, 14, 14, 14, 14], \"unison\": \"none\", \"envelopes\": [] } },\r\n                { name: \"choir bass\", midiProgram: 52, settings: { \"type\": \"harmonics\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 2378.41, \"linearGain\": 11.3137 }, { \"type\": \"peak\", \"cutoffHz\": 594.6, \"linearGain\": 5.6569 }, { \"type\": \"peak\", \"cutoffHz\": 1681.79, \"linearGain\": 0.0884 }, { \"type\": \"peak\", \"cutoffHz\": 707.11, \"linearGain\": 0.0884 }, { \"type\": \"peak\", \"cutoffHz\": 840.9, \"linearGain\": 11.3137 }], \"effects\": [\"vibrato\", \"chorus\", \"reverb\"], \"vibrato\": \"shaky\", \"chorus\": 100, \"reverb\": 67, \"transition\": \"normal\", \"fadeInSeconds\": 0.0413, \"fadeOutTicks\": 48, \"chord\": \"simultaneous\", \"harmonics\": [71, 86, 100, 100, 86, 86, 57, 43, 29, 29, 29, 29, 29, 29, 43, 43, 43, 43, 43, 29, 29, 29, 29, 14, 14, 14, 14, 14], \"unison\": \"none\", \"envelopes\": [] } },\r\n                { name: \"solo soprano\", midiProgram: 85, settings: { \"type\": \"harmonics\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 2828.43, \"linearGain\": 2 }, { \"type\": \"peak\", \"cutoffHz\": 1189.21, \"linearGain\": 5.6569 }, { \"type\": \"high-pass\", \"cutoffHz\": 707.11, \"linearGain\": 2.8284 }, { \"type\": \"peak\", \"cutoffHz\": 2000, \"linearGain\": 0.0884 }, { \"type\": \"peak\", \"cutoffHz\": 840.9, \"linearGain\": 0.25 }], \"effects\": [\"vibrato\", \"reverb\"], \"vibrato\": \"shaky\", \"reverb\": 33, \"fadeInSeconds\": 0.0413, \"fadeOutTicks\": 12, \"harmonics\": [86, 100, 86, 43, 14, 14, 57, 71, 57, 14, 14, 14, 14, 14, 43, 57, 43, 14, 14, 14, 14, 14, 14, 14, 0, 0, 0, 0], \"unison\": \"none\", \"envelopes\": [] } },\r\n                { name: \"solo tenor\", midiProgram: 85, settings: { \"type\": \"harmonics\", \"eqFilter\": [{ \"type\": \"peak\", \"cutoffHz\": 1000, \"linearGain\": 11.3137 }, { \"type\": \"peak\", \"cutoffHz\": 707.11, \"linearGain\": 5.6569 }, { \"type\": \"peak\", \"cutoffHz\": 840.9, \"linearGain\": 0.0884 }, { \"type\": \"peak\", \"cutoffHz\": 1681.79, \"linearGain\": 0.0884 }, { \"type\": \"high-pass\", \"cutoffHz\": 297.3, \"linearGain\": 0.7071 }, { \"type\": \"low-pass\", \"cutoffHz\": 2828.43, \"linearGain\": 11.3137 }], \"effects\": [\"vibrato\", \"reverb\"], \"vibrato\": \"shaky\", \"reverb\": 33, \"fadeInSeconds\": 0.0413, \"fadeOutTicks\": 12, \"harmonics\": [86, 100, 100, 86, 71, 57, 43, 29, 29, 29, 29, 43, 43, 43, 29, 29, 29, 29, 29, 29, 29, 29, 29, 14, 14, 14, 14, 14], \"unison\": \"none\", \"envelopes\": [] } },\r\n                { name: \"solo bass\", midiProgram: 85, settings: { \"type\": \"harmonics\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 2378.41, \"linearGain\": 5.6569 }, { \"type\": \"peak\", \"cutoffHz\": 594.6, \"linearGain\": 8 }, { \"type\": \"peak\", \"cutoffHz\": 1681.79, \"linearGain\": 0.0884 }, { \"type\": \"peak\", \"cutoffHz\": 707.11, \"linearGain\": 0.0884 }, { \"type\": \"peak\", \"cutoffHz\": 840.9, \"linearGain\": 8 }, { \"type\": \"high-pass\", \"cutoffHz\": 210.22, \"linearGain\": 1.4142 }], \"effects\": [\"vibrato\", \"reverb\"], \"vibrato\": \"shaky\", \"reverb\": 33, \"transition\": \"normal\", \"fadeInSeconds\": 0.0263, \"fadeOutTicks\": 12, \"chord\": \"simultaneous\", \"harmonics\": [71, 86, 100, 100, 86, 86, 57, 43, 29, 29, 29, 29, 29, 29, 43, 43, 43, 43, 43, 29, 29, 29, 29, 14, 14, 14, 14, 14], \"unison\": \"none\", \"envelopes\": [] } },\r\n                { name: \"voice ooh\", midiProgram: 53, generalMidi: true, settings: { \"type\": \"harmonics\", \"effects\": \"reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 1414, \"filterResonance\": 57, \"filterEnvelope\": \"steady\", \"interval\": \"union\", \"vibrato\": \"shaky\", \"harmonics\": [100, 57, 43, 43, 14, 14, 0, 0, 0, 14, 29, 29, 14, 0, 14, 29, 29, 14, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] } },\r\n                { name: \"voice synth\", midiProgram: 54, generalMidi: true, settings: { \"type\": \"chip\", \"transition\": \"medium fade\", \"effects\": \"chorus & reverb\", \"chord\": \"harmony\", \"filterCutoffHz\": 4000, \"filterResonance\": 57, \"filterEnvelope\": \"steady\", \"wave\": \"rounded\", \"interval\": \"union\", \"vibrato\": \"light\" } },\r\n                { name: \"vox synth lead\", midiProgram: 85, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"chorus & reverb\", \"transition\": \"cross fade\", \"chord\": \"harmony\", \"filterCutoffHz\": 2828, \"filterResonance\": 14, \"filterEnvelope\": \"steady\", \"vibrato\": \"light\", \"algorithm\": \"(1 2 3)←4\", \"feedbackType\": \"1→2→3→4\", \"feedbackAmplitude\": 2, \"feedbackEnvelope\": \"punch\", \"operators\": [{ \"frequency\": \"2×\", \"amplitude\": 10, \"envelope\": \"custom\" }, { \"frequency\": \"9×\", \"amplitude\": 5, \"envelope\": \"custom\" }, { \"frequency\": \"20×\", \"amplitude\": 1, \"envelope\": \"custom\" }, { \"frequency\": \"~1×\", \"amplitude\": 4, \"envelope\": \"steady\" }] } },\r\n                { name: \"tiny robot\", midiProgram: 85, settings: { \"type\": \"FM\", \"eqFilter\": [], \"effects\": [\"vibrato\", \"reverb\"], \"vibrato\": \"delayed\", \"reverb\": 33, \"transition\": \"slide\", \"fadeInSeconds\": 0.0263, \"fadeOutTicks\": -3, \"chord\": \"simultaneous\", \"algorithm\": \"1←(2 3 4)\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 2, \"operators\": [{ \"frequency\": \"2×\", \"amplitude\": 15 }, { \"frequency\": \"1×\", \"amplitude\": 7 }, { \"frequency\": \"~1×\", \"amplitude\": 7 }, { \"frequency\": \"1×\", \"amplitude\": 0 }], \"envelopes\": [{ \"target\": \"operatorAmplitude\", \"envelope\": \"punch\", \"index\": 1 }, { \"target\": \"feedbackAmplitude\", \"envelope\": \"twang 3\" }] } },\r\n                { name: \"yowie\", midiProgram: 85, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"cross fade\", \"chord\": \"harmony\", \"filterCutoffHz\": 2000, \"filterResonance\": 86, \"filterEnvelope\": \"tremolo5\", \"vibrato\": \"none\", \"algorithm\": \"1←2←(3 4)\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 12, \"feedbackEnvelope\": \"tremolo3\", \"operators\": [{ \"frequency\": \"2×\", \"amplitude\": 12, \"envelope\": \"custom\" }, { \"frequency\": \"16×\", \"amplitude\": 5, \"envelope\": \"steady\" }, { \"frequency\": \"1×\", \"amplitude\": 5, \"envelope\": \"steady\" }, { \"frequency\": \"1×\", \"amplitude\": 0, \"envelope\": \"steady\" }] } },\r\n                { name: \"mouse\", midiProgram: 85, settings: { \"type\": \"FM\", \"eqFilter\": [], \"effects\": [\"vibrato\", \"reverb\"], \"vibrato\": \"light\", \"reverb\": 33, \"transition\": \"slide in pattern\", \"fadeInSeconds\": 0.0263, \"fadeOutTicks\": -3, \"chord\": \"simultaneous\", \"algorithm\": \"1 2 3 4\", \"feedbackType\": \"1⟲ 2⟲\", \"feedbackAmplitude\": 5, \"operators\": [{ \"frequency\": \"2×\", \"amplitude\": 13 }, { \"frequency\": \"5×\", \"amplitude\": 12 }, { \"frequency\": \"1×\", \"amplitude\": 0 }, { \"frequency\": \"1×\", \"amplitude\": 0 }], \"envelopes\": [{ \"target\": \"noteVolume\", \"envelope\": \"note size\" }, { \"target\": \"feedbackAmplitude\", \"envelope\": \"flare 2\" }] } },\r\n                { name: \"gumdrop\", midiProgram: 85, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"hard\", \"chord\": \"harmony\", \"filterCutoffHz\": 8000, \"filterResonance\": 0, \"filterEnvelope\": \"steady\", \"vibrato\": \"none\", \"algorithm\": \"(1 2 3)←4\", \"feedbackType\": \"1⟲ 2⟲ 3⟲\", \"feedbackAmplitude\": 0, \"feedbackEnvelope\": \"steady\", \"operators\": [{ \"frequency\": \"2×\", \"amplitude\": 15, \"envelope\": \"punch\" }, { \"frequency\": \"4×\", \"amplitude\": 15, \"envelope\": \"punch\" }, { \"frequency\": \"7×\", \"amplitude\": 15, \"envelope\": \"punch\" }, { \"frequency\": \"1×\", \"amplitude\": 10, \"envelope\": \"twang 1\" }] } },\r\n                { name: \"echo drop\", midiProgram: 102, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"chorus & reverb\", \"transition\": \"hard\", \"chord\": \"harmony\", \"filterCutoffHz\": 2828, \"filterResonance\": 14, \"filterEnvelope\": \"punch\", \"vibrato\": \"none\", \"algorithm\": \"1←(2 3←4)\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 2, \"feedbackEnvelope\": \"steady\", \"operators\": [{ \"frequency\": \"~2×\", \"amplitude\": 11, \"envelope\": \"custom\" }, { \"frequency\": \"~1×\", \"amplitude\": 5, \"envelope\": \"steady\" }, { \"frequency\": \"11×\", \"amplitude\": 2, \"envelope\": \"steady\" }, { \"frequency\": \"16×\", \"amplitude\": 5, \"envelope\": \"swell 3\" }] } },\r\n                { name: \"dark choir\", midiProgram: 85, settings: { \"type\": \"spectrum\", \"effects\": \"reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 4000, \"filterResonance\": 29, \"filterEnvelope\": \"swell 1\", \"spectrum\": [43, 14, 14, 14, 14, 14, 14, 100, 14, 14, 14, 57, 14, 14, 100, 14, 43, 14, 43, 14, 14, 43, 14, 29, 14, 29, 14, 14, 29, 0] } },\r\n            ])\r\n        },\r\n        {\r\n            name: \"Brass Presets\", presets: <DictionaryArray<Preset>>toNameMap([\r\n                { name: \"trumpet\", midiProgram: 56, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 2828, \"filterResonance\": 43, \"filterEnvelope\": \"steady\", \"vibrato\": \"none\", \"algorithm\": \"1←(2 3 4)\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 9, \"feedbackEnvelope\": \"swell 1\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 14, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 8, \"envelope\": \"steady\" }, { \"frequency\": \"1×\", \"amplitude\": 5, \"envelope\": \"flare 2\" }, { \"frequency\": \"1×\", \"amplitude\": 0, \"envelope\": \"steady\" }] } },\r\n                { name: \"trombone\", midiProgram: 57, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 2000, \"filterResonance\": 43, \"filterEnvelope\": \"steady\", \"vibrato\": \"none\", \"algorithm\": \"1←(2 3 4)\", \"feedbackType\": \"2⟲\", \"feedbackAmplitude\": 7, \"feedbackEnvelope\": \"swell 1\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 14, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 8, \"envelope\": \"steady\" }, { \"frequency\": \"1×\", \"amplitude\": 0, \"envelope\": \"steady\" }, { \"frequency\": \"1×\", \"amplitude\": 0, \"envelope\": \"steady\" }] } },\r\n                { name: \"tuba\", midiProgram: 58, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 2000, \"filterResonance\": 43, \"filterEnvelope\": \"steady\", \"vibrato\": \"none\", \"algorithm\": \"1←(2 3 4)\", \"feedbackType\": \"2⟲\", \"feedbackAmplitude\": 8, \"feedbackEnvelope\": \"swell 1\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 14, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 6, \"envelope\": \"steady\" }, { \"frequency\": \"1×\", \"amplitude\": 0, \"envelope\": \"steady\" }, { \"frequency\": \"1×\", \"amplitude\": 0, \"envelope\": \"steady\" }] } },\r\n                { name: \"muted trumpet\", midiProgram: 59, generalMidi: true, settings: { \"type\": \"FM\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 8000, \"linearGain\": 2.8284 }, { \"type\": \"peak\", \"cutoffHz\": 4000, \"linearGain\": 2.8284 }], \"effects\": [\"note filter\", \"reverb\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 3363.59, \"linearGain\": 1 }], \"reverb\": 33, \"fadeInSeconds\": 0.0263, \"fadeOutTicks\": -3, \"algorithm\": \"1←(2 3←4)\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 5, \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 13 }, { \"frequency\": \"1×\", \"amplitude\": 5 }, { \"frequency\": \"9×\", \"amplitude\": 5 }, { \"frequency\": \"13×\", \"amplitude\": 7 }], \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"swell 1\" }, { \"target\": \"operatorAmplitude\", \"envelope\": \"swell 1\", \"index\": 3 }, { \"target\": \"feedbackAmplitude\", \"envelope\": \"flare 2\" }] } },\r\n                { name: \"french horn\", midiProgram: 60, generalMidi: true, settings: { \"type\": \"FM\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 4000, \"linearGain\": 1 }, { \"type\": \"peak\", \"cutoffHz\": 2378.41, \"linearGain\": 2.8284 }], \"effects\": [\"reverb\"], \"reverb\": 33, \"fadeInSeconds\": 0.0263, \"fadeOutTicks\": -3, \"algorithm\": \"1←3 2←4\", \"feedbackType\": \"1⟲ 2⟲\", \"feedbackAmplitude\": 3, \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 15 }, { \"frequency\": \"1×\", \"amplitude\": 12 }, { \"frequency\": \"1×\", \"amplitude\": 10 }, { \"frequency\": \"~1×\", \"amplitude\": 8 }], \"envelopes\": [{ \"target\": \"operatorAmplitude\", \"envelope\": \"swell 1\", \"index\": 2 }, { \"target\": \"operatorAmplitude\", \"envelope\": \"flare 2\", \"index\": 3 }, { \"target\": \"feedbackAmplitude\", \"envelope\": \"swell 1\" }] } },\r\n                { name: \"brass section\", midiProgram: 61, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 2828, \"filterResonance\": 14, \"filterEnvelope\": \"punch\", \"vibrato\": \"none\", \"algorithm\": \"1←3 2←4\", \"feedbackType\": \"1⟲ 2⟲\", \"feedbackAmplitude\": 6, \"feedbackEnvelope\": \"swell 1\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 14, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 12, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 10, \"envelope\": \"swell 1\" }, { \"frequency\": \"~1×\", \"amplitude\": 10, \"envelope\": \"swell 1\" }] } },\r\n                { name: \"brass synth 1\", midiProgram: 62, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 4000, \"filterResonance\": 29, \"filterEnvelope\": \"steady\", \"vibrato\": \"none\", \"algorithm\": \"1←3 2←4\", \"feedbackType\": \"1⟲ 2⟲\", \"feedbackAmplitude\": 11, \"feedbackEnvelope\": \"swell 1\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 14, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 14, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 12, \"envelope\": \"flare 1\" }, { \"frequency\": \"~1×\", \"amplitude\": 8, \"envelope\": \"flare 2\" }] } },\r\n                { name: \"brass synth 2\", midiProgram: 63, generalMidi: true, settings: { \"type\": \"FM\", \"transition\": \"soft\", \"effects\": \"reverb\", \"chord\": \"harmony\", \"filterCutoffHz\": 4000, \"filterResonance\": 43, \"filterEnvelope\": \"twang 3\", \"vibrato\": \"none\", \"algorithm\": \"1←3 2←4\", \"feedbackType\": \"1⟲ 2⟲\", \"feedbackAmplitude\": 9, \"feedbackEnvelope\": \"swell 1\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 15, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 15, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 10, \"envelope\": \"flare 1\" }, { \"frequency\": \"~1×\", \"amplitude\": 7, \"envelope\": \"flare 1\" }] } },\r\n                { name: \"pulse brass\", midiProgram: 62, settings: { \"type\": \"PWM\", \"effects\": \"reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 4000, \"filterResonance\": 29, \"filterEnvelope\": \"swell 1\", \"pulseWidth\": 50, \"pulseEnvelope\": \"flare 3\", \"vibrato\": \"none\" } },\r\n            ])\r\n        },\r\n        {\r\n            name: \"Reed Presets\", presets: <DictionaryArray<Preset>>toNameMap([\r\n                { name: \"soprano sax\", midiProgram: 64, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 2000, \"filterResonance\": 29, \"filterEnvelope\": \"steady\", \"vibrato\": \"none\", \"algorithm\": \"1←2←3←4\", \"feedbackType\": \"4⟲\", \"feedbackAmplitude\": 5, \"feedbackEnvelope\": \"swell 1\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 13, \"envelope\": \"custom\" }, { \"frequency\": \"4×\", \"amplitude\": 4, \"envelope\": \"swell 1\" }, { \"frequency\": \"1×\", \"amplitude\": 7, \"envelope\": \"steady\" }, { \"frequency\": \"5×\", \"amplitude\": 4, \"envelope\": \"punch\" }] } },\r\n                { name: \"alto sax\", midiProgram: 65, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 2000, \"filterResonance\": 43, \"filterEnvelope\": \"steady\", \"vibrato\": \"none\", \"algorithm\": \"1←(2 3←4)\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 4, \"feedbackEnvelope\": \"punch\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 13, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 6, \"envelope\": \"steady\" }, { \"frequency\": \"4×\", \"amplitude\": 6, \"envelope\": \"swell 1\" }, { \"frequency\": \"1×\", \"amplitude\": 12, \"envelope\": \"steady\" }] } },\r\n                { name: \"tenor sax\", midiProgram: 66, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 2828, \"filterResonance\": 29, \"filterEnvelope\": \"steady\", \"vibrato\": \"none\", \"algorithm\": \"1←2←3←4\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 6, \"feedbackEnvelope\": \"swell 1\", \"operators\": [{ \"frequency\": \"2×\", \"amplitude\": 12, \"envelope\": \"custom\" }, { \"frequency\": \"3×\", \"amplitude\": 7, \"envelope\": \"steady\" }, { \"frequency\": \"1×\", \"amplitude\": 3, \"envelope\": \"steady\" }, { \"frequency\": \"8×\", \"amplitude\": 3, \"envelope\": \"steady\" }] } },\r\n                { name: \"baritone sax\", midiProgram: 67, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 2828, \"filterResonance\": 0, \"filterEnvelope\": \"steady\", \"vibrato\": \"none\", \"algorithm\": \"1←(2 3←4)\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 2, \"feedbackEnvelope\": \"swell 2\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 12, \"envelope\": \"custom\" }, { \"frequency\": \"8×\", \"amplitude\": 4, \"envelope\": \"steady\" }, { \"frequency\": \"4×\", \"amplitude\": 5, \"envelope\": \"steady\" }, { \"frequency\": \"1×\", \"amplitude\": 4, \"envelope\": \"punch\" }] } },\r\n                { name: \"sax synth\", midiProgram: 64, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 8000, \"filterResonance\": 0, \"filterEnvelope\": \"steady\", \"vibrato\": \"light\", \"algorithm\": \"1←(2 3 4)\", \"feedbackType\": \"1⟲ 2⟲\", \"feedbackAmplitude\": 4, \"feedbackEnvelope\": \"steady\", \"operators\": [{ \"frequency\": \"4×\", \"amplitude\": 15, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 15, \"envelope\": \"steady\" }, { \"frequency\": \"1×\", \"amplitude\": 0, \"envelope\": \"steady\" }, { \"frequency\": \"1×\", \"amplitude\": 0, \"envelope\": \"steady\" }] } },\r\n                { name: \"shehnai\", midiProgram: 111, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 8000, \"filterResonance\": 0, \"filterEnvelope\": \"steady\", \"vibrato\": \"light\", \"algorithm\": \"1←(2 3 4)\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 3, \"feedbackEnvelope\": \"steady\", \"operators\": [{ \"frequency\": \"4×\", \"amplitude\": 15, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 8, \"envelope\": \"steady\" }, { \"frequency\": \"1×\", \"amplitude\": 0, \"envelope\": \"steady\" }, { \"frequency\": \"1×\", \"amplitude\": 0, \"envelope\": \"steady\" }] } },\r\n                { name: \"oboe\", midiProgram: 68, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"cross fade\", \"chord\": \"harmony\", \"filterCutoffHz\": 4000, \"filterResonance\": 14, \"filterEnvelope\": \"swell 1\", \"vibrato\": \"none\", \"algorithm\": \"1 2←(3 4)\", \"feedbackType\": \"2⟲\", \"feedbackAmplitude\": 2, \"feedbackEnvelope\": \"tremolo5\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 7, \"envelope\": \"custom\" }, { \"frequency\": \"4×\", \"amplitude\": 12, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 6, \"envelope\": \"steady\" }, { \"frequency\": \"6×\", \"amplitude\": 2, \"envelope\": \"steady\" }] } },\r\n                { name: \"english horn\", midiProgram: 69, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"cross fade\", \"chord\": \"harmony\", \"filterCutoffHz\": 2000, \"filterResonance\": 14, \"filterEnvelope\": \"steady\", \"vibrato\": \"none\", \"algorithm\": \"1 2←(3 4)\", \"feedbackType\": \"2⟲\", \"feedbackAmplitude\": 2, \"feedbackEnvelope\": \"steady\", \"operators\": [{ \"frequency\": \"4×\", \"amplitude\": 12, \"envelope\": \"custom\" }, { \"frequency\": \"2×\", \"amplitude\": 10, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 8, \"envelope\": \"punch\" }, { \"frequency\": \"8×\", \"amplitude\": 4, \"envelope\": \"steady\" }] } },\r\n                { name: \"bassoon\", midiProgram: 70, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 707, \"filterResonance\": 57, \"filterEnvelope\": \"steady\", \"vibrato\": \"none\", \"algorithm\": \"1←(2 3←4)\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 2, \"feedbackEnvelope\": \"steady\", \"operators\": [{ \"frequency\": \"2×\", \"amplitude\": 11, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 6, \"envelope\": \"steady\" }, { \"frequency\": \"6×\", \"amplitude\": 6, \"envelope\": \"swell 1\" }, { \"frequency\": \"1×\", \"amplitude\": 0, \"envelope\": \"steady\" }] } },\r\n                { name: \"clarinet\", midiProgram: 71, generalMidi: true, settings: { \"type\": \"harmonics\", \"effects\": \"reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 1414, \"filterResonance\": 14, \"filterEnvelope\": \"steady\", \"interval\": \"union\", \"vibrato\": \"none\", \"harmonics\": [100, 43, 86, 57, 86, 71, 86, 71, 71, 71, 71, 71, 71, 43, 71, 71, 57, 57, 57, 57, 57, 57, 43, 43, 43, 29, 14, 0] } },\r\n                { name: \"harmonica\", midiProgram: 22, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 5657, \"filterResonance\": 29, \"filterEnvelope\": \"swell 1\", \"vibrato\": \"none\", \"algorithm\": \"1←(2 3←4)\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 9, \"feedbackEnvelope\": \"tremolo5\", \"operators\": [{ \"frequency\": \"2×\", \"amplitude\": 14, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 15, \"envelope\": \"steady\" }, { \"frequency\": \"~2×\", \"amplitude\": 2, \"envelope\": \"twang 3\" }, { \"frequency\": \"1×\", \"amplitude\": 0, \"envelope\": \"steady\" }] } },\r\n            ])\r\n        },\r\n        {\r\n            name: \"Flute Presets\", presets: <DictionaryArray<Preset>>toNameMap([\r\n                { name: \"flute 1\", midiProgram: 73, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 5657, \"filterResonance\": 14, \"filterEnvelope\": \"steady\", \"vibrato\": \"none\", \"algorithm\": \"1←(2 3 4)\", \"feedbackType\": \"4⟲\", \"feedbackAmplitude\": 7, \"feedbackEnvelope\": \"decay 2\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 15, \"envelope\": \"custom\" }, { \"frequency\": \"2×\", \"amplitude\": 4, \"envelope\": \"steady\" }, { \"frequency\": \"1×\", \"amplitude\": 3, \"envelope\": \"steady\" }, { \"frequency\": \"~1×\", \"amplitude\": 1, \"envelope\": \"punch\" }] } },\r\n                { name: \"recorder\", midiProgram: 74, generalMidi: true, settings: { \"type\": \"harmonics\", \"effects\": \"reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 4000, \"filterResonance\": 29, \"filterEnvelope\": \"swell 2\", \"interval\": \"union\", \"vibrato\": \"none\", \"harmonics\": [100, 43, 57, 43, 57, 43, 43, 43, 43, 43, 43, 43, 43, 29, 29, 29, 29, 29, 29, 29, 14, 14, 14, 14, 14, 14, 14, 0] } },\r\n                { name: \"whistle\", midiProgram: 78, generalMidi: true, settings: { \"type\": \"harmonics\", \"effects\": \"chorus & reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 2000, \"filterResonance\": 43, \"filterEnvelope\": \"steady\", \"interval\": \"union\", \"vibrato\": \"delayed\", \"harmonics\": [100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] } },\r\n                { name: \"ocarina\", midiProgram: 79, generalMidi: true, settings: { \"type\": \"harmonics\", \"effects\": \"reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 2828, \"filterResonance\": 43, \"filterEnvelope\": \"steady\", \"interval\": \"union\", \"vibrato\": \"none\", \"harmonics\": [100, 14, 57, 14, 29, 14, 14, 14, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] } },\r\n                { name: \"piccolo\", midiProgram: 72, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 5657, \"filterResonance\": 43, \"filterEnvelope\": \"steady\", \"vibrato\": \"none\", \"algorithm\": \"1←3 2←4\", \"feedbackType\": \"4⟲\", \"feedbackAmplitude\": 15, \"feedbackEnvelope\": \"twang 1\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 15, \"envelope\": \"custom\" }, { \"frequency\": \"1×\", \"amplitude\": 10, \"envelope\": \"custom\" }, { \"frequency\": \"~2×\", \"amplitude\": 3, \"envelope\": \"punch\" }, { \"frequency\": \"~1×\", \"amplitude\": 5, \"envelope\": \"punch\" }] } },\r\n                { name: \"shakuhachi\", midiProgram: 77, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"chorus & reverb\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 4000, \"filterResonance\": 14, \"filterEnvelope\": \"steady\", \"vibrato\": \"delayed\", \"algorithm\": \"1←(2 3←4)\", \"feedbackType\": \"3→4\", \"feedbackAmplitude\": 15, \"feedbackEnvelope\": \"steady\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 15, \"envelope\": \"custom\" }, { \"frequency\": \"2×\", \"amplitude\": 3, \"envelope\": \"punch\" }, { \"frequency\": \"~1×\", \"amplitude\": 4, \"envelope\": \"twang 1\" }, { \"frequency\": \"20×\", \"amplitude\": 15, \"envelope\": \"steady\" }] } },\r\n                { name: \"pan flute\", midiProgram: 75, generalMidi: true, settings: { \"type\": \"spectrum\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 9513.66, \"linearGain\": 5.6569 }], \"effects\": [\"note filter\", \"reverb\"], \"noteFilter\": [{ \"type\": \"high-pass\", \"cutoffHz\": 4756.83, \"linearGain\": 0.7071 }], \"reverb\": 33, \"fadeInSeconds\": 0.0125, \"fadeOutTicks\": -3, \"spectrum\": [100, 0, 0, 0, 0, 0, 0, 14, 0, 0, 0, 71, 0, 0, 14, 0, 57, 0, 29, 14, 29, 14, 14, 29, 14, 29, 14, 14, 29, 14], \"envelopes\": [{ \"target\": \"noteFilterFreq\", \"envelope\": \"twang 1\", \"index\": 0 }, { \"target\": \"noteVolume\", \"envelope\": \"punch\" }] } },\r\n                { name: \"blown bottle\", midiProgram: 76, generalMidi: true, settings: { \"type\": \"FM\", \"effects\": \"chorus & reverb\", \"transition\": \"cross fade\", \"chord\": \"harmony\", \"filterCutoffHz\": 5657, \"filterResonance\": 57, \"filterEnvelope\": \"steady\", \"vibrato\": \"none\", \"algorithm\": \"1 2 3 4\", \"feedbackType\": \"1⟲ 2⟲ 3⟲ 4⟲\", \"feedbackAmplitude\": 7, \"feedbackEnvelope\": \"twang 1\", \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 15, \"envelope\": \"custom\" }, { \"frequency\": \"3×\", \"amplitude\": 4, \"envelope\": \"custom\" }, { \"frequency\": \"6×\", \"amplitude\": 2, \"envelope\": \"custom\" }, { \"frequency\": \"11×\", \"amplitude\": 2, \"envelope\": \"custom\" }] } },\r\n                { name: \"calliope\", midiProgram: 82, generalMidi: true, settings: { \"type\": \"spectrum\", \"transition\": \"cross fade\", \"effects\": \"reverb\", \"chord\": \"harmony\", \"filterCutoffHz\": 5657, \"filterResonance\": 14, \"filterEnvelope\": \"steady\", \"spectrum\": [100, 0, 0, 0, 0, 0, 0, 86, 0, 0, 0, 71, 0, 0, 57, 0, 43, 0, 29, 14, 14, 29, 14, 14, 14, 14, 14, 14, 14, 14] } },\r\n                { name: \"chiffer\", midiProgram: 83, generalMidi: true, settings: { \"type\": \"spectrum\", \"effects\": \"reverb\", \"transition\": \"hard\", \"chord\": \"harmony\", \"filterCutoffHz\": 2000, \"filterResonance\": 14, \"filterEnvelope\": \"punch\", \"spectrum\": [86, 0, 0, 0, 0, 0, 0, 71, 0, 0, 0, 71, 0, 0, 57, 0, 57, 0, 43, 14, 14, 43, 14, 29, 14, 29, 29, 29, 29, 14] } },\r\n                { name: \"breath noise\", midiProgram: 121, generalMidi: true, settings: { \"type\": \"spectrum\", \"eqFilter\": [], \"effects\": [\"chord type\", \"note filter\", \"reverb\"], \"chord\": \"strum\", \"noteFilter\": [{ \"type\": \"high-pass\", \"cutoffHz\": 840.9, \"linearGain\": 0.3536 }, { \"type\": \"low-pass\", \"cutoffHz\": 16000, \"linearGain\": 0.3536 }], \"reverb\": 33, \"fadeInSeconds\": 0.0413, \"fadeOutTicks\": 12, \"spectrum\": [71, 0, 0, 0, 0, 0, 0, 29, 0, 0, 0, 71, 0, 0, 29, 0, 100, 29, 14, 29, 100, 29, 100, 14, 14, 71, 0, 29, 0, 0], \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"twang 1\" }] } },\r\n                { name: \"flute 2\", midiProgram: 73, generalMidi: true, settings: { \"type\": \"harmonics\", \"effects\": \"reverb\", \"transition\": \"seamless\", \"chord\": \"harmony\", \"filterCutoffHz\": 1414, \"filterResonance\": 14, \"filterEnvelope\": \"steady\", \"interval\": \"union\", \"vibrato\": \"delayed\", \"harmonics\": [100, 43, 86, 57, 86, 71, 86, 71, 71, 71, 71, 71, 71, 43, 71, 71, 57, 57, 57, 57, 57, 57, 43, 43, 43, 29, 14, 0] } },\r\n            ])\r\n        },\r\n        {\r\n            name: \"Pad Presets\", presets: <DictionaryArray<Preset>>toNameMap([\r\n                { name: \"new age pad\", midiProgram: 88, generalMidi: true, settings: { \"type\": \"FM\", \"eqFilter\": [], \"effects\": [\"chorus\"], \"chorus\": 100, \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": 48, \"chord\": \"simultaneous\", \"algorithm\": \"1←(2 3←4)\", \"feedbackType\": \"1⟲ 2⟲\", \"feedbackAmplitude\": 3, \"operators\": [{ \"frequency\": \"2×\", \"amplitude\": 14 }, { \"frequency\": \"~1×\", \"amplitude\": 4 }, { \"frequency\": \"6×\", \"amplitude\": 3 }, { \"frequency\": \"13×\", \"amplitude\": 3 }], \"envelopes\": [{ \"target\": \"operatorAmplitude\", \"envelope\": \"swell 2\", \"index\": 1 }, { \"target\": \"operatorAmplitude\", \"envelope\": \"twang 3\", \"index\": 2 }, { \"target\": \"feedbackAmplitude\", \"envelope\": \"swell 3\" }] } },\r\n                { name: \"warm pad\", midiProgram: 89, generalMidi: true, settings: { \"type\": \"FM\", \"eqFilter\": [], \"effects\": [\"note filter\", \"chorus\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 3363.59, \"linearGain\": 1 }], \"chorus\": 100, \"transition\": \"normal\", \"fadeInSeconds\": 0.0575, \"fadeOutTicks\": 96, \"chord\": \"simultaneous\", \"algorithm\": \"1←(2 3 4)\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 7, \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 14 }, { \"frequency\": \"1×\", \"amplitude\": 6 }, { \"frequency\": \"1×\", \"amplitude\": 0 }, { \"frequency\": \"1×\", \"amplitude\": 0 }], \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"swell 3\" }, { \"target\": \"operatorAmplitude\", \"envelope\": \"swell 1\", \"index\": 1 }] } },\r\n                { name: \"polysynth pad\", midiProgram: 90, generalMidi: true, settings: { \"type\": \"chip\", \"eqFilter\": [], \"effects\": [\"vibrato\", \"note filter\", \"chorus\"], \"vibrato\": \"delayed\", \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 2828.43, \"linearGain\": 1 }], \"chorus\": 100, \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": 48, \"chord\": \"simultaneous\", \"wave\": \"sawtooth\", \"unison\": \"honky tonk\", \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"twang 3\" }] } },\r\n                { name: \"space voice pad\", midiProgram: 91, generalMidi: true, settings: { \"type\": \"FM\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 6727.17, \"linearGain\": 5.6569 }, { \"type\": \"peak\", \"cutoffHz\": 2828.43, \"linearGain\": 5.6569 }, { \"type\": \"peak\", \"cutoffHz\": 1414.21, \"linearGain\": 0.1768 }], \"effects\": [\"chorus\"], \"chorus\": 100, \"transition\": \"normal\", \"fadeInSeconds\": 0.0125, \"fadeOutTicks\": 72, \"chord\": \"simultaneous\", \"algorithm\": \"(1 2 3)←4\", \"feedbackType\": \"1⟲ 2⟲ 3⟲ 4⟲\", \"feedbackAmplitude\": 5, \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 10 }, { \"frequency\": \"2×\", \"amplitude\": 8 }, { \"frequency\": \"3×\", \"amplitude\": 7 }, { \"frequency\": \"11×\", \"amplitude\": 2 }], \"envelopes\": [{ \"target\": \"operatorAmplitude\", \"envelope\": \"punch\", \"index\": 3 }, { \"target\": \"feedbackAmplitude\", \"envelope\": \"swell 2\" }] } },\r\n                { name: \"bowed glass pad\", midiProgram: 92, generalMidi: true, settings: { \"type\": \"FM\", \"eqFilter\": [], \"effects\": [\"note filter\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 4756.83, \"linearGain\": 0.5 }], \"transition\": \"normal\", \"fadeInSeconds\": 0.0575, \"fadeOutTicks\": 96, \"chord\": \"simultaneous\", \"algorithm\": \"1←3 2←4\", \"feedbackType\": \"1⟲ 2⟲\", \"feedbackAmplitude\": 0, \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 10 }, { \"frequency\": \"2×\", \"amplitude\": 12 }, { \"frequency\": \"3×\", \"amplitude\": 7 }, { \"frequency\": \"7×\", \"amplitude\": 4 }], \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"twang 3\" }, { \"target\": \"operatorAmplitude\", \"envelope\": \"twang 3\", \"index\": 2 }, { \"target\": \"operatorAmplitude\", \"envelope\": \"flare 3\", \"index\": 3 }] } },\r\n                { name: \"metallic pad\", midiProgram: 93, generalMidi: true, settings: { \"type\": \"FM\", \"eqFilter\": [], \"effects\": [\"note filter\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 6727.17, \"linearGain\": 0.5 }], \"transition\": \"normal\", \"fadeInSeconds\": 0.0125, \"fadeOutTicks\": 72, \"chord\": \"simultaneous\", \"algorithm\": \"1←3 2←4\", \"feedbackType\": \"1⟲ 2⟲\", \"feedbackAmplitude\": 13, \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 15 }, { \"frequency\": \"~1×\", \"amplitude\": 9 }, { \"frequency\": \"1×\", \"amplitude\": 7 }, { \"frequency\": \"11×\", \"amplitude\": 7 }], \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"twang 3\" }, { \"target\": \"operatorAmplitude\", \"envelope\": \"swell 2\", \"index\": 2 }, { \"target\": \"feedbackAmplitude\", \"envelope\": \"twang 3\" }] } },\r\n                { name: \"sweep pad\", midiProgram: 95, generalMidi: true, settings: { \"type\": \"chip\", \"eqFilter\": [], \"effects\": [\"note filter\", \"chorus\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 4000, \"linearGain\": 4 }], \"chorus\": 100, \"transition\": \"normal\", \"fadeInSeconds\": 0.0575, \"fadeOutTicks\": 96, \"chord\": \"simultaneous\", \"wave\": \"sawtooth\", \"unison\": \"hum\", \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"flare 3\" }] } },\r\n                { name: \"atmosphere\", midiProgram: 99, generalMidi: true, settings: { \"type\": \"FM\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 4756.83, \"linearGain\": 1 }], \"effects\": [\"chorus\", \"reverb\"], \"chorus\": 100, \"reverb\": 33, \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": 48, \"chord\": \"strum\", \"algorithm\": \"1←(2 3 4)\", \"feedbackType\": \"3⟲ 4⟲\", \"feedbackAmplitude\": 3, \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 14 }, { \"frequency\": \"~1×\", \"amplitude\": 10 }, { \"frequency\": \"3×\", \"amplitude\": 7 }, { \"frequency\": \"1×\", \"amplitude\": 7 }], \"envelopes\": [{ \"target\": \"operatorAmplitude\", \"envelope\": \"swell 3\", \"index\": 1 }, { \"target\": \"operatorAmplitude\", \"envelope\": \"twang 2\", \"index\": 2 }, { \"target\": \"operatorAmplitude\", \"envelope\": \"twang 3\", \"index\": 3 }] } },\r\n                { name: \"brightness\", midiProgram: 100, generalMidi: true, settings: { \"type\": \"Picked String\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 4756.83, \"linearGain\": 2 }], \"effects\": [\"chorus\"], \"chorus\": 100, \"transition\": \"normal\", \"fadeInSeconds\": 0.0125, \"fadeOutTicks\": 72, \"chord\": \"simultaneous\", \"harmonics\": [100, 86, 86, 86, 43, 57, 43, 71, 43, 43, 43, 57, 43, 43, 57, 71, 57, 43, 29, 43, 57, 57, 43, 29, 29, 29, 29, 14], \"unison\": \"octave\", \"stringSustain\": 86, \"envelopes\": [] } },\r\n                { name: \"goblins\", midiProgram: 101, generalMidi: true, settings: { \"type\": \"FM\", \"eqFilter\": [{ \"type\": \"peak\", \"cutoffHz\": 2828.43, \"linearGain\": 11.3137 }], \"effects\": [\"note filter\", \"chorus\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 1681.79, \"linearGain\": 0.5 }], \"chorus\": 100, \"transition\": \"normal\", \"fadeInSeconds\": 0.0575, \"fadeOutTicks\": 96, \"chord\": \"simultaneous\", \"algorithm\": \"1←2←3←4\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 10, \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 15 }, { \"frequency\": \"4×\", \"amplitude\": 5 }, { \"frequency\": \"1×\", \"amplitude\": 10 }, { \"frequency\": \"1×\", \"amplitude\": 0 }], \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"swell 2\" }, { \"target\": \"operatorAmplitude\", \"envelope\": \"swell 3\", \"index\": 1 }, { \"target\": \"operatorAmplitude\", \"envelope\": \"tremolo1\", \"index\": 2 }, { \"target\": \"feedbackAmplitude\", \"envelope\": \"flare 3\" }] } },\r\n                { name: \"sci-fi\", midiProgram: 103, generalMidi: true, settings: { \"type\": \"FM\", \"eqFilter\": [{ \"type\": \"peak\", \"cutoffHz\": 9513.66, \"linearGain\": 2.8284 }], \"effects\": [\"note filter\", \"chorus\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 6727.17, \"linearGain\": 0.5 }], \"chorus\": 100, \"transition\": \"normal\", \"fadeInSeconds\": 0.0125, \"fadeOutTicks\": 48, \"chord\": \"simultaneous\", \"algorithm\": \"(1 2)←3←4\", \"feedbackType\": \"1⟲ 2⟲ 3⟲ 4⟲\", \"feedbackAmplitude\": 8, \"operators\": [{ \"frequency\": \"~1×\", \"amplitude\": 13 }, { \"frequency\": \"2×\", \"amplitude\": 10 }, { \"frequency\": \"5×\", \"amplitude\": 5 }, { \"frequency\": \"11×\", \"amplitude\": 8 }], \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"twang 3\" }, { \"target\": \"operatorAmplitude\", \"envelope\": \"twang 3\", \"index\": 2 }, { \"target\": \"operatorAmplitude\", \"envelope\": \"tremolo5\", \"index\": 3 }, { \"target\": \"feedbackAmplitude\", \"envelope\": \"twang 3\" }] } },\r\n                { name: \"flutter pad\", midiProgram: 90, settings: { \"type\": \"FM\", \"eqFilter\": [], \"effects\": [\"vibrato\", \"note filter\", \"chorus\"], \"vibrato\": \"delayed\", \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 4000, \"linearGain\": 4 }], \"chorus\": 100, \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": 48, \"chord\": \"simultaneous\", \"algorithm\": \"(1 2)←(3 4)\", \"feedbackType\": \"1⟲ 2⟲ 3⟲\", \"feedbackAmplitude\": 9, \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 13 }, { \"frequency\": \"5×\", \"amplitude\": 7 }, { \"frequency\": \"7×\", \"amplitude\": 5 }, { \"frequency\": \"~1×\", \"amplitude\": 6 }], \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"twang 3\" }, { \"target\": \"operatorAmplitude\", \"envelope\": \"tremolo1\", \"index\": 2 }, { \"target\": \"operatorAmplitude\", \"envelope\": \"punch\", \"index\": 3 }] } },\r\n                { name: \"feedback pad\", midiProgram: 89, settings: { \"type\": \"FM\", \"eqFilter\": [{ \"type\": \"peak\", \"cutoffHz\": 2378.41, \"linearGain\": 8 }], \"effects\": [], \"transition\": \"normal\", \"fadeInSeconds\": 0.0575, \"fadeOutTicks\": 96, \"chord\": \"custom interval\", \"algorithm\": \"1 2 3 4\", \"feedbackType\": \"1⟲ 2⟲ 3⟲ 4⟲\", \"feedbackAmplitude\": 8, \"operators\": [{ \"frequency\": \"1×\", \"amplitude\": 15 }, { \"frequency\": \"1×\", \"amplitude\": 15 }, { \"frequency\": \"1×\", \"amplitude\": 15 }, { \"frequency\": \"~1×\", \"amplitude\": 15 }], \"envelopes\": [{ \"target\": \"feedbackAmplitude\", \"envelope\": \"swell 2\" }] } },\r\n            ])\r\n        },\r\n        {\r\n            name: \"Drum Presets\", presets: <DictionaryArray<Preset>>toNameMap([\r\n                { name: \"standard drumset\", midiProgram: 116, isNoise: true, settings: { \"type\": \"drumset\", \"effects\": \"reverb\", \"drums\": [{ \"filterEnvelope\": \"twang 1\", \"spectrum\": [57, 71, 71, 86, 86, 86, 71, 71, 71, 71, 57, 57, 57, 57, 43, 43, 43, 43, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29] }, { \"filterEnvelope\": \"twang 1\", \"spectrum\": [0, 0, 0, 100, 71, 71, 57, 86, 57, 57, 57, 71, 43, 43, 57, 43, 43, 43, 43, 43, 43, 43, 43, 43, 43, 43, 43, 43, 43, 43] }, { \"filterEnvelope\": \"twang 1\", \"spectrum\": [0, 0, 0, 0, 100, 57, 43, 43, 29, 57, 43, 29, 71, 43, 43, 43, 43, 57, 43, 43, 43, 43, 43, 43, 43, 43, 29, 43, 43, 43] }, { \"filterEnvelope\": \"twang 1\", \"spectrum\": [0, 0, 0, 0, 0, 71, 57, 43, 43, 43, 57, 57, 43, 29, 57, 43, 43, 43, 29, 43, 57, 43, 43, 43, 43, 43, 43, 29, 43, 43] }, { \"filterEnvelope\": \"decay 2\", \"spectrum\": [0, 14, 29, 43, 86, 71, 29, 43, 43, 43, 43, 29, 71, 29, 71, 29, 43, 43, 43, 43, 57, 43, 43, 57, 43, 43, 43, 57, 57, 57] }, { \"filterEnvelope\": \"decay 1\", \"spectrum\": [0, 0, 14, 14, 14, 14, 29, 29, 29, 43, 43, 43, 57, 57, 57, 71, 71, 71, 71, 71, 71, 71, 71, 57, 57, 57, 57, 43, 43, 43] }, { \"filterEnvelope\": \"twang 3\", \"spectrum\": [43, 43, 43, 71, 29, 29, 43, 43, 43, 29, 43, 43, 43, 29, 29, 43, 43, 29, 29, 29, 57, 14, 57, 43, 43, 57, 43, 43, 57, 57] }, { \"filterEnvelope\": \"decay 3\", \"spectrum\": [29, 43, 43, 43, 43, 29, 29, 43, 29, 29, 43, 29, 14, 29, 43, 29, 43, 29, 57, 29, 43, 57, 43, 71, 43, 71, 57, 57, 71, 71] }, { \"filterEnvelope\": \"twang 3\", \"spectrum\": [43, 29, 29, 43, 29, 29, 29, 57, 29, 29, 29, 57, 43, 43, 29, 29, 57, 43, 43, 43, 71, 43, 43, 71, 57, 71, 71, 71, 71, 71] }, { \"filterEnvelope\": \"decay 3\", \"spectrum\": [57, 57, 57, 43, 57, 57, 43, 43, 57, 43, 43, 43, 71, 57, 43, 57, 86, 71, 57, 86, 71, 57, 86, 100, 71, 86, 86, 86, 86, 86] }, { \"filterEnvelope\": \"flare 1\", \"spectrum\": [0, 0, 14, 14, 14, 14, 29, 29, 29, 43, 43, 43, 57, 57, 71, 71, 86, 86, 100, 100, 100, 100, 100, 100, 100, 100, 86, 57, 29, 0] }, { \"filterEnvelope\": \"decay 2\", \"spectrum\": [14, 14, 14, 14, 29, 14, 14, 29, 14, 43, 14, 43, 57, 86, 57, 57, 100, 57, 43, 43, 57, 100, 57, 43, 29, 14, 0, 0, 0, 0] }] } },\r\n                { name: \"steel pan\", midiProgram: 114, generalMidi: true, settings: { \"type\": \"FM\", \"eqFilter\": [{ \"type\": \"high-pass\", \"cutoffHz\": 62.5, \"linearGain\": 0.1768 }], \"effects\": [\"note filter\", \"chorus\", \"reverb\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 13454.34, \"linearGain\": 0.25 }], \"chorus\": 67, \"reverb\": 33, \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": 24, \"chord\": \"simultaneous\", \"algorithm\": \"1←(2 3←4)\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 0, \"operators\": [{ \"frequency\": \"~1×\", \"amplitude\": 14 }, { \"frequency\": \"7×\", \"amplitude\": 3 }, { \"frequency\": \"3×\", \"amplitude\": 5 }, { \"frequency\": \"4×\", \"amplitude\": 4 }], \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"decay 2\" }, { \"target\": \"operatorAmplitude\", \"envelope\": \"flare 1\", \"index\": 1 }, { \"target\": \"operatorAmplitude\", \"envelope\": \"flare 2\", \"index\": 2 }, { \"target\": \"operatorAmplitude\", \"envelope\": \"swell 2\", \"index\": 3 }] } },\r\n                { name: \"steel pan synth\", midiProgram: 114, settings: { \"type\": \"FM\", \"eqFilter\": [], \"effects\": [\"note filter\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 13454.34, \"linearGain\": 0.25 }], \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": -3, \"chord\": \"simultaneous\", \"algorithm\": \"1 2 3←4\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 5, \"operators\": [{ \"frequency\": \"~1×\", \"amplitude\": 12 }, { \"frequency\": \"2×\", \"amplitude\": 15 }, { \"frequency\": \"4×\", \"amplitude\": 14 }, { \"frequency\": \"~1×\", \"amplitude\": 3 }], \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"twang 1\" }, { \"target\": \"operatorAmplitude\", \"envelope\": \"note size\", \"index\": 0 }, { \"target\": \"operatorAmplitude\", \"envelope\": \"note size\", \"index\": 1 }, { \"target\": \"operatorAmplitude\", \"envelope\": \"flare 1\", \"index\": 2 }, { \"target\": \"operatorAmplitude\", \"envelope\": \"flare 2\", \"index\": 3 }, { \"target\": \"feedbackAmplitude\", \"envelope\": \"flare 1\" }] } },\r\n                { name: \"timpani\", midiProgram: 47, generalMidi: true, settings: { \"type\": \"spectrum\", \"eqFilter\": [{ \"type\": \"peak\", \"cutoffHz\": 6727.17, \"linearGain\": 5.6569 }], \"effects\": [\"pitch shift\", \"note filter\", \"reverb\"], \"pitchShiftSemitones\": 15, \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 19027.31, \"linearGain\": 0.5 }], \"reverb\": 33, \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": 48, \"chord\": \"simultaneous\", \"spectrum\": [100, 0, 0, 0, 86, 0, 0, 71, 0, 14, 43, 14, 43, 43, 0, 29, 43, 29, 29, 29, 43, 29, 43, 29, 43, 43, 43, 43, 43, 43], \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"twang 1\" }, { \"target\": \"pitchShift\", \"envelope\": \"twang 1\" }] } },\r\n                { name: \"dark strike\", midiProgram: 47, settings: { \"type\": \"spectrum\", \"eqFilter\": [], \"effects\": [\"note filter\", \"reverb\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 4756.83, \"linearGain\": 0.7071 }], \"reverb\": 33, \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": 48, \"chord\": \"simultaneous\", \"spectrum\": [0, 0, 14, 14, 14, 29, 29, 43, 43, 86, 43, 43, 43, 29, 86, 29, 29, 29, 86, 29, 14, 14, 14, 14, 0, 0, 0, 0, 0, 0], \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"twang 2\" }] } },\r\n                { name: \"woodblock\", midiProgram: 115, generalMidi: true, isNoise: true, midiSubharmonicOctaves: -2.5, settings: { \"type\": \"spectrum\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"strum\", \"filterCutoffHz\": 2828, \"filterResonance\": 14, \"filterEnvelope\": \"twang 1\", \"spectrum\": [0, 14, 29, 43, 43, 57, 86, 86, 71, 57, 57, 43, 43, 57, 86, 86, 43, 43, 71, 57, 57, 57, 57, 57, 86, 86, 71, 71, 71, 71] } },\r\n                { name: \"taiko drum\", midiProgram: 116, generalMidi: true, isNoise: true, midiSubharmonicOctaves: -0.5, settings: { \"type\": \"spectrum\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"strum\", \"filterCutoffHz\": 2828, \"filterResonance\": 29, \"filterEnvelope\": \"twang 1\", \"spectrum\": [71, 100, 100, 43, 43, 71, 71, 43, 43, 43, 43, 43, 43, 57, 29, 57, 43, 57, 43, 43, 57, 43, 43, 43, 43, 43, 43, 43, 43, 43] } },\r\n                { name: \"melodic drum\", midiProgram: 117, generalMidi: true, isNoise: true, midiSubharmonicOctaves: -1.5, settings: { \"type\": \"spectrum\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"strum\", \"filterCutoffHz\": 2828, \"filterResonance\": 43, \"filterEnvelope\": \"twang 1\", \"spectrum\": [100, 71, 71, 57, 57, 43, 43, 71, 43, 43, 43, 57, 43, 43, 57, 43, 43, 43, 43, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29] } },\r\n                { name: \"drum synth\", midiProgram: 118, generalMidi: true, isNoise: true, midiSubharmonicOctaves: -2, settings: { \"type\": \"spectrum\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"harmony\", \"filterCutoffHz\": 4000, \"filterResonance\": 43, \"filterEnvelope\": \"decay 1\", \"spectrum\": [100, 86, 71, 57, 43, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29] } },\r\n                { name: \"tom-tom\", midiProgram: 116, isNoise: true, midiSubharmonicOctaves: -1, settings: { \"type\": \"spectrum\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"strum\", \"filterCutoffHz\": 2000, \"filterResonance\": 14, \"filterEnvelope\": \"twang 1\", \"spectrum\": [100, 29, 14, 0, 0, 86, 14, 43, 29, 86, 29, 14, 29, 57, 43, 43, 43, 43, 57, 43, 43, 43, 29, 57, 43, 43, 43, 43, 43, 43] } },\r\n                { name: \"metal pipe\", midiProgram: 117, isNoise: true, midiSubharmonicOctaves: -1.5, settings: { \"type\": \"spectrum\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"strum\", \"filterCutoffHz\": 8000, \"filterResonance\": 14, \"filterEnvelope\": \"twang 2\", \"spectrum\": [29, 43, 86, 43, 43, 43, 43, 43, 100, 29, 14, 14, 100, 14, 14, 0, 0, 0, 0, 0, 14, 29, 29, 14, 0, 0, 14, 29, 0, 0] } },\r\n                { name: \"synth kick\", midiProgram: 47, settings: { \"type\": \"FM\", \"eqFilter\": [], \"effects\": [], \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": -6, \"chord\": \"simultaneous\", \"algorithm\": \"1←(2 3 4)\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 0, \"operators\": [{ \"frequency\": \"8×\", \"amplitude\": 15 }, { \"frequency\": \"1×\", \"amplitude\": 0 }, { \"frequency\": \"1×\", \"amplitude\": 0 }, { \"frequency\": \"1×\", \"amplitude\": 0 }], \"envelopes\": [{ \"target\": \"operatorFrequency\", \"envelope\": \"twang 1\", \"index\": 0 }, { \"target\": \"noteVolume\", \"envelope\": \"twang 2\" }] } },\r\n            ])\r\n        },\r\n        {\r\n            name: \"Novelty Presets\", presets: <DictionaryArray<Preset>>toNameMap([\r\n                { name: \"guitar fret noise\", midiProgram: 120, generalMidi: true, settings: { \"type\": \"spectrum\", \"eqFilter\": [{ \"type\": \"high-pass\", \"cutoffHz\": 1000, \"linearGain\": 0.1768 }], \"effects\": [\"note filter\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 6727.17, \"linearGain\": 5.6569 }], \"transition\": \"normal\", \"fadeInSeconds\": 0.0125, \"fadeOutTicks\": -3, \"chord\": \"simultaneous\", \"spectrum\": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 14, 0, 0, 0, 29, 14, 0, 0, 43, 0, 43, 0, 71, 43, 0, 57, 0], \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"flare 1\" }, { \"target\": \"noteVolume\", \"envelope\": \"twang 2\" }] } },\r\n                { name: \"fifth saw lead\", midiProgram: 86, generalMidi: true, midiSubharmonicOctaves: 1, settings: { \"type\": \"chip\", \"eqFilter\": [], \"effects\": [\"note filter\", \"chorus\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 2828.43, \"linearGain\": 1.4142 }], \"chorus\": 67, \"transition\": \"normal\", \"fadeInSeconds\": 0, \"fadeOutTicks\": 48, \"chord\": \"simultaneous\", \"wave\": \"sawtooth\", \"unison\": \"fifth\", \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"twang 3\" }] } },\r\n                { name: \"fifth swell\", midiProgram: 86, midiSubharmonicOctaves: 1, settings: { \"type\": \"chip\", \"eqFilter\": [], \"effects\": [\"note filter\", \"chorus\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 2000, \"linearGain\": 2 }], \"chorus\": 100, \"transition\": \"normal\", \"fadeInSeconds\": 0.0125, \"fadeOutTicks\": 72, \"chord\": \"simultaneous\", \"wave\": \"sawtooth\", \"unison\": \"fifth\", \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"swell 3\" }] } },\r\n                { name: \"soundtrack\", midiProgram: 97, generalMidi: true, settings: { \"type\": \"chip\", \"eqFilter\": [], \"effects\": [\"note filter\", \"chorus\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 2378.41, \"linearGain\": 0.5 }], \"chorus\": 67, \"transition\": \"normal\", \"fadeInSeconds\": 0.0413, \"fadeOutTicks\": 72, \"chord\": \"simultaneous\", \"wave\": \"sawtooth\", \"unison\": \"fifth\", \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"flare 3\" }] } },\r\n                { name: \"reverse cymbal\", midiProgram: 119, generalMidi: true, isNoise: true, midiSubharmonicOctaves: -3, settings: { \"type\": \"spectrum\", \"effects\": \"none\", \"transition\": \"soft\", \"chord\": \"harmony\", \"filterCutoffHz\": 4000, \"filterResonance\": 14, \"filterEnvelope\": \"swell 3\", \"spectrum\": [29, 57, 57, 29, 57, 57, 29, 29, 43, 29, 29, 43, 29, 29, 57, 57, 14, 57, 14, 57, 71, 71, 57, 86, 57, 100, 86, 86, 86, 86] } },\r\n                { name: \"seashore\", midiProgram: 122, generalMidi: true, isNoise: true, midiSubharmonicOctaves: -3, settings: { \"type\": \"spectrum\", \"transition\": \"soft fade\", \"effects\": \"reverb\", \"chord\": \"harmony\", \"filterCutoffHz\": 2828, \"filterResonance\": 0, \"filterEnvelope\": \"swell 3\", \"spectrum\": [14, 14, 29, 29, 43, 43, 43, 57, 57, 57, 57, 57, 57, 71, 71, 71, 71, 71, 71, 71, 71, 71, 71, 71, 71, 71, 71, 71, 71, 57] } },\r\n                { name: \"bird tweet\", midiProgram: 123, generalMidi: true, settings: { \"type\": \"harmonics\", \"eqFilter\": [], \"effects\": [\"chord type\", \"vibrato\", \"reverb\"], \"chord\": \"strum\", \"vibrato\": \"heavy\", \"reverb\": 67, \"fadeInSeconds\": 0.0575, \"fadeOutTicks\": -6, \"harmonics\": [0, 0, 0, 100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], \"unison\": \"hum\", \"envelopes\": [{ \"target\": \"noteVolume\", \"envelope\": \"decay 1\" }] } },\r\n                { name: \"telephone ring\", midiProgram: 124, generalMidi: true, settings: { \"type\": \"FM\", \"eqFilter\": [], \"effects\": [\"note filter\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 5656.85, \"linearGain\": 1 }], \"transition\": \"normal\", \"fadeInSeconds\": 0.0125, \"fadeOutTicks\": -3, \"chord\": \"arpeggio\", \"algorithm\": \"1←(2 3 4)\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 0, \"operators\": [{ \"frequency\": \"2×\", \"amplitude\": 12 }, { \"frequency\": \"1×\", \"amplitude\": 4 }, { \"frequency\": \"20×\", \"amplitude\": 1 }, { \"frequency\": \"1×\", \"amplitude\": 0 }], \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"tremolo4\" }, { \"target\": \"operatorAmplitude\", \"envelope\": \"tremolo1\", \"index\": 1 }] } },\r\n                { name: \"helicopter\", midiProgram: 125, generalMidi: true, isNoise: true, midiSubharmonicOctaves: -0.5, settings: { \"type\": \"spectrum\", \"effects\": \"reverb\", \"transition\": \"seamless\", \"chord\": \"arpeggio\", \"filterCutoffHz\": 1414, \"filterResonance\": 14, \"filterEnvelope\": \"tremolo4\", \"spectrum\": [14, 43, 43, 57, 57, 57, 71, 71, 71, 71, 86, 86, 86, 86, 86, 86, 86, 86, 86, 86, 86, 71, 71, 71, 71, 71, 71, 71, 57, 57] } },\r\n                { name: \"applause\", midiProgram: 126, generalMidi: true, isNoise: true, midiSubharmonicOctaves: -3, settings: { \"type\": \"spectrum\", \"effects\": \"reverb\", \"transition\": \"soft fade\", \"chord\": \"harmony\", \"filterCutoffHz\": 2000, \"filterResonance\": 14, \"filterEnvelope\": \"swell 3\", \"spectrum\": [14, 14, 29, 29, 29, 43, 43, 57, 71, 71, 86, 86, 86, 71, 71, 57, 57, 57, 71, 86, 86, 86, 86, 86, 71, 71, 57, 57, 57, 57] } },\r\n                { name: \"gunshot\", midiProgram: 127, generalMidi: true, isNoise: true, midiSubharmonicOctaves: -2, settings: { \"type\": \"spectrum\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"strum\", \"filterCutoffHz\": 1414, \"filterResonance\": 29, \"filterEnvelope\": \"twang 1\", \"spectrum\": [14, 29, 43, 43, 57, 57, 57, 71, 71, 71, 86, 86, 86, 86, 86, 86, 86, 86, 86, 86, 86, 71, 71, 71, 71, 57, 57, 57, 57, 43] } },\r\n                { name: \"scoot\", midiProgram: 92, settings: { \"type\": \"chip\", \"eqFilter\": [], \"effects\": [\"note filter\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 707.11, \"linearGain\": 4 }], \"transition\": \"normal\", \"fadeInSeconds\": 0.0125, \"fadeOutTicks\": -3, \"chord\": \"simultaneous\", \"wave\": \"double saw\", \"unison\": \"shimmer\", \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"flare 1\" }] } },\r\n                { name: \"buzz saw\", midiProgram: 30, settings: { \"type\": \"FM\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 9513.66, \"linearGain\": 0.5 }], \"effects\": [], \"transition\": \"normal\", \"fadeInSeconds\": 0.0263, \"fadeOutTicks\": -3, \"chord\": \"custom interval\", \"algorithm\": \"1←2←3←4\", \"feedbackType\": \"1⟲\", \"feedbackAmplitude\": 4, \"operators\": [{ \"frequency\": \"5×\", \"amplitude\": 13 }, { \"frequency\": \"1×\", \"amplitude\": 10 }, { \"frequency\": \"~1×\", \"amplitude\": 6 }, { \"frequency\": \"11×\", \"amplitude\": 12 }], \"envelopes\": [] } },\r\n                { name: \"mosquito\", midiProgram: 93, settings: { \"type\": \"PWM\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 2828.43, \"linearGain\": 2 }], \"effects\": [\"vibrato\"], \"vibrato\": \"shaky\", \"transition\": \"normal\", \"fadeInSeconds\": 0.0575, \"fadeOutTicks\": -6, \"chord\": \"simultaneous\", \"pulseWidth\": 4.41942, \"envelopes\": [{ \"target\": \"pulseWidth\", \"envelope\": \"tremolo6\" }] } },\r\n                { name: \"breathing\", midiProgram: 126, isNoise: true, midiSubharmonicOctaves: -1, settings: { \"type\": \"spectrum\", \"effects\": \"reverb\", \"transition\": \"hard fade\", \"chord\": \"harmony\", \"filterCutoffHz\": 2000, \"filterResonance\": 14, \"filterEnvelope\": \"swell 2\", \"spectrum\": [14, 14, 14, 29, 29, 29, 29, 29, 43, 29, 29, 43, 43, 43, 29, 29, 71, 43, 86, 86, 57, 100, 86, 86, 86, 86, 71, 86, 71, 57] } },\r\n                { name: \"klaxon synth\", midiProgram: 125, isNoise: true, midiSubharmonicOctaves: -1, settings: { \"type\": \"noise\", \"effects\": \"reverb\", \"transition\": \"slide\", \"chord\": \"harmony\", \"filterCutoffHz\": 2000, \"filterResonance\": 86, \"filterEnvelope\": \"steady\", \"wave\": \"buzz\" } },\r\n                { name: \"theremin\", midiProgram: 40, settings: { \"type\": \"harmonics\", \"eqFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 8000, \"linearGain\": 0.7071 }], \"effects\": [\"vibrato\", \"reverb\"], \"vibrato\": \"heavy\", \"reverb\": 33, \"transition\": \"slide in pattern\", \"fadeInSeconds\": 0.0263, \"fadeOutTicks\": -6, \"chord\": \"simultaneous\", \"harmonics\": [100, 71, 57, 43, 29, 29, 14, 14, 14, 14, 14, 14, 14, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], \"unison\": \"none\", \"envelopes\": [] } },\r\n                { name: \"sonar ping\", midiProgram: 121, settings: { \"type\": \"spectrum\", \"eqFilter\": [], \"effects\": [\"note filter\", \"reverb\"], \"noteFilter\": [{ \"type\": \"low-pass\", \"cutoffHz\": 1681.79, \"linearGain\": 0.5 }], \"reverb\": 33, \"transition\": \"normal\", \"fadeInSeconds\": 0.0125, \"fadeOutTicks\": 72, \"chord\": \"simultaneous\", \"spectrum\": [100, 43, 29, 29, 14, 14, 14, 14, 14, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], \"envelopes\": [{ \"target\": \"noteFilterAllFreqs\", \"envelope\": \"twang 2\" }] } },\r\n            ])\r\n        },\r\n    ]);\r\n\r\n    public static valueToPreset(presetValue: number): Preset | null {\r\n        const categoryIndex: number = presetValue >> 6;\r\n        const presetIndex: number = presetValue & 0x3F;\r\n        return EditorConfig.presetCategories[categoryIndex].presets[presetIndex];\r\n    }\r\n\r\n    public static midiProgramToPresetValue(program: number): number | null {\r\n        for (let categoryIndex: number = 0; categoryIndex < EditorConfig.presetCategories.length; categoryIndex++) {\r\n            const category: PresetCategory = EditorConfig.presetCategories[categoryIndex];\r\n            for (let presetIndex: number = 0; presetIndex < category.presets.length; presetIndex++) {\r\n                const preset: Preset = category.presets[presetIndex];\r\n                if (preset.generalMidi && preset.midiProgram == program) return (categoryIndex << 6) + presetIndex;\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n\r\n    public static nameToPresetValue(presetName: string): number | null {\r\n        for (let categoryIndex: number = 0; categoryIndex < EditorConfig.presetCategories.length; categoryIndex++) {\r\n            const category: PresetCategory = EditorConfig.presetCategories[categoryIndex];\r\n            for (let presetIndex: number = 0; presetIndex < category.presets.length; presetIndex++) {\r\n                const preset: Preset = category.presets[presetIndex];\r\n                if (preset.name == presetName) return (categoryIndex << 6) + presetIndex;\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n}\r\n","// Copyright (C) 2020 John Nesky, distributed under the MIT license.\n\nexport function applyElementArgs<T extends HTMLElement | SVGElement | DocumentFragment>(element: T, args: Array<any>): T {\n\tfor (const arg of args) {\n\t\tif (arg instanceof Node) {\n\t\t\telement.appendChild(arg);\n\t\t} else if (typeof arg === \"string\") {\n\t\t\telement.appendChild(document.createTextNode(arg));\n\t\t} else if (typeof arg === \"function\") {\n\t\t\tapplyElementArgs(element, [arg()]);\n\t\t} else if (Array.isArray(arg)) {\n\t\t\tapplyElementArgs(element, arg);\n\t\t} else if (arg && typeof Symbol !== \"undefined\" && typeof arg[Symbol.iterator] === \"function\") {\n\t\t\tapplyElementArgs(element, [...arg]);\n\t\t} else if (arg && arg.constructor === Object && element instanceof Element) {\n\t\t\t// If the argument is a literal {} Object\n\t\t\tfor (const key of Object.keys(arg)) {\n\t\t\t\tconst value = arg[key];\n\t\t\t\t/*if (key === \"classList\") {\n\t\t\t\t\tif (typeof value === \"string\") {\n\t\t\t\t\t\telement.classList.add(...value.split(\" \"));\n\t\t\t\t\t} else if (Array.isArray(arg) || (value && typeof Symbol !== \"undefined\" && typeof value[Symbol.iterator] === \"function\")) {\n\t\t\t\t\t\telement.classList.add(...value);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.warn(\"Invalid classList value \\\"\" + value + \"\\\" on \" + element.tagName + \" element.\");\n\t\t\t\t\t}\n\t\t\t\t} else*/ if (key === \"class\" /* || key === \"className\" */) {\n\t\t\t\t\tif (typeof value === \"string\") {\n\t\t\t\t\t\telement.setAttribute(\"class\", value);\n\t\t\t\t\t} else if (Array.isArray(arg) || (value && typeof Symbol !== \"undefined\" && typeof value[Symbol.iterator] === \"function\")) {\n\t\t\t\t\t\telement.setAttribute(\"class\", [...value].join(\" \"));\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.warn(\"Invalid \" + key + \" value \\\"\" + value + \"\\\" on \" + element.tagName + \" element.\");\n\t\t\t\t\t}\n\t\t\t\t} else if (key === \"style\") {\n\t\t\t\t\tif (value && value.constructor === Object) {\n\t\t\t\t\t\tfor (const styleKey of Object.keys(value)) {\n\t\t\t\t\t\t\tif (styleKey in (<HTMLElement | SVGElement>element).style) {\n\t\t\t\t\t\t\t\t// In practice, camelCase and kebab-case properties both work as properties on CSSStyleDeclaration objects.\n\t\t\t\t\t\t\t\t(<any> element).style[styleKey] = value[styleKey];\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t// CSS variables start with -- and must be set with setProperty.\n\t\t\t\t\t\t\t\t(<HTMLElement | SVGElement>element).style.setProperty(styleKey, value[styleKey]);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\telement.setAttribute(key, value);\n\t\t\t\t\t}\n\t\t\t\t} else if (typeof(value) === \"function\") {\n\t\t\t\t\t// If value is a callback, set as a property instead trying to coerce to string.\n\t\t\t\t\t(<any>element)[key] = value;\n\t\t\t\t} else if (typeof(value) === \"boolean\") {\n\t\t\t\t\t// If value is boolean, set attribute if true, remove if false.\n\t\t\t\t\tif (value) element.setAttribute(key, \"\");\n\t\t\t\t\telse element.removeAttribute(key);\n\t\t\t\t} else {\n\t\t\t\t\t// Default to setting attribute, as if writing html directly.\n\t\t\t\t\telement.setAttribute(key, value);\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t// Just convert unrecognized objects to text and append them.\n\t\t\telement.appendChild(document.createTextNode(arg));\n\t\t}\n\t}\n\treturn element;\n}\n\nexport const svgNS: string = \"http://www.w3.org/2000/svg\";\n\nexport function parseHTML(...args: Array<any>): DocumentFragment {\n\treturn document.createRange().createContextualFragment(args.join());\n}\n\n//let svgParser: SVGSVGElement | null = null;\nexport function parseSVG(...args: Array<any>): DocumentFragment {\n\tconst fragment: DocumentFragment = document.createDocumentFragment();\n\t\n\t// Internet Explorer doesn't support the first method here, so I commented it out and used a slightly more complex one involving DOMParser below.\n\t/*\n\tif (svgParser === null) svgParser = <SVGSVGElement>document.createElementNS(svgNS, \"svg\");\n\tsvgParser.innerHTML = args.join();\n\twhile (svgParser.firstChild !== null) fragment.appendChild(svgParser.firstChild);\n\t*/\n\tconst svgParser: Element = new DOMParser().parseFromString(\"<svg xmlns=\\\"http://www.w3.org/2000/svg\\\">\" + args.join() + \"</svg>\", \"image/svg+xml\").documentElement;\n\twhile (svgParser.firstChild !== null) {\n\t\tdocument.importNode(svgParser.firstChild, true);\n\t\tfragment.appendChild(svgParser.firstChild);\n\t}\n\t\n\treturn fragment;\n}\n\nexport function replaceScriptWith(...args: Array<any>): void {\n\tlet currentScript: HTMLScriptElement | SVGScriptElement | null = document.currentScript;\n\tif (currentScript == null) { // double-equals to intentionally include undefined in Internet Explorer.\n\t\t\n\t\t// Internet Explorer doens't support currentScript, try this method instead:\n\t\tif (document.readyState === \"loading\") {\n\t\t\tconst scripts: HTMLCollectionOf<HTMLScriptElement> = document.getElementsByTagName(\"script\");\n\t\t\tcurrentScript = scripts[scripts.length - 1];\n\t\t}\n\t\t\n\t\tif (currentScript == null) {\n\t\t\tconsole.warn(\"Couldn't replace script because no script is currently being parsed and executed, maybe this is happening in a callback function or event handler instead?\");\n\t\t\treturn;\n\t\t}\n\t}\n\tif (currentScript.parentNode === null) {\n\t\tconsole.warn(\"Couldn't replace script element because it is not attached to a parent anymore, did you try to replace the same script more than once?\");\n\t\treturn;\n\t}\n\tcurrentScript.parentNode.replaceChild(applyElementArgs(document.createDocumentFragment(), args), currentScript);\n}\n\nexport function applyToElement<T extends HTMLElement | SVGElement | DocumentFragment>(element: T, ...args: Array<any>): T {\n\tif (!(element instanceof Element || element instanceof DocumentFragment)) {\n\t\tconsole.warn(\"Couldn't apply to provided argument because it's not an element or DocumentFragment.\");\n\t\treturn element;\n\t}\n\treturn applyElementArgs(element, args);\n}\n","// Copyright (C) 2020 John Nesky, distributed under the MIT license.\n\nimport {applyElementArgs, svgNS, parseHTML, parseSVG, replaceScriptWith, applyToElement} from \"./elements-base\";\nexport {replaceScriptWith, applyToElement};\n\ninterface HTMLElementFactory {\n\t(...args: Array<string>): DocumentFragment;\n\t//readonly [key: string]: (...args: Array<any>) => HTMLElement;\n\ta(...args: Array<any>): HTMLAnchorElement;\n\tabbr(...args: Array<any>): HTMLElement;\n\taddress(...args: Array<any>): HTMLElement;\n\tarea(...args: Array<any>): HTMLAreaElement;\n\tarticle(...args: Array<any>): HTMLElement;\n\taside(...args: Array<any>): HTMLElement;\n\taudio(...args: Array<any>): HTMLAudioElement;\n\tb(...args: Array<any>): HTMLElement;\n\tbase(...args: Array<any>): HTMLBaseElement;\n\tbdi(...args: Array<any>): HTMLElement;\n\tbdo(...args: Array<any>): HTMLElement;\n\tblockquote(...args: Array<any>): HTMLQuoteElement;\n\tbr(...args: Array<any>): HTMLBRElement;\n\tbutton(...args: Array<any>): HTMLButtonElement;\n\tcanvas(...args: Array<any>): HTMLCanvasElement;\n\tcaption(...args: Array<any>): HTMLTableCaptionElement;\n\tcite(...args: Array<any>): HTMLElement;\n\tcode(...args: Array<any>): HTMLElement;\n\tcol(...args: Array<any>): HTMLTableColElement;\n\tcolgroup(...args: Array<any>): HTMLTableColElement;\n\tdatalist(...args: Array<any>): HTMLDataListElement;\n\tdd(...args: Array<any>): HTMLElement;\n\tdel(...args: Array<any>): HTMLModElement;\n\tdetails(...args: Array<any>): HTMLDetailsElement;\n\tdfn(...args: Array<any>): HTMLElement;\n\tdialog(...args: Array<any>): HTMLDialogElement;\n\tdiv(...args: Array<any>): HTMLDivElement;\n\tdl(...args: Array<any>): HTMLDListElement;\n\tdt(...args: Array<any>): HTMLElement;\n\tem(...args: Array<any>): HTMLElement;\n\tembed(...args: Array<any>): HTMLEmbedElement;\n\tfieldset(...args: Array<any>): HTMLFieldSetElement;\n\tfigcaption(...args: Array<any>): HTMLElement;\n\tfigure(...args: Array<any>): HTMLElement;\n\tfooter(...args: Array<any>): HTMLElement;\n\tform(...args: Array<any>): HTMLFormElement;\n\th1(...args: Array<any>): HTMLHeadingElement;\n\th2(...args: Array<any>): HTMLHeadingElement;\n\th3(...args: Array<any>): HTMLHeadingElement;\n\th4(...args: Array<any>): HTMLHeadingElement;\n\th5(...args: Array<any>): HTMLHeadingElement;\n\th6(...args: Array<any>): HTMLHeadingElement;\n\theader(...args: Array<any>): HTMLElement;\n\thr(...args: Array<any>): HTMLHRElement;\n\ti(...args: Array<any>): HTMLElement;\n\tiframe(...args: Array<any>): HTMLIFrameElement;\n\timg(...args: Array<any>): HTMLImageElement;\n\tinput(...args: Array<any>): HTMLInputElement;\n\tins(...args: Array<any>): HTMLModElement;\n\tkbd(...args: Array<any>): HTMLElement;\n\tlabel(...args: Array<any>): HTMLLabelElement;\n\tlegend(...args: Array<any>): HTMLLegendElement;\n\tli(...args: Array<any>): HTMLLIElement;\n\tlink(...args: Array<any>): HTMLLinkElement;\n\tmain(...args: Array<any>): HTMLElement;\n\tmap(...args: Array<any>): HTMLMapElement;\n\tmark(...args: Array<any>): HTMLElement;\n\tmenu(...args: Array<any>): HTMLMenuElement;\n\tmenuitem(...args: Array<any>): HTMLUnknownElement;\n\tmeta(...args: Array<any>): HTMLMetaElement;\n\tmeter(...args: Array<any>): HTMLMeterElement;\n\tnav(...args: Array<any>): HTMLElement;\n\tnoscript(...args: Array<any>): HTMLElement;\n\tobject(...args: Array<any>): HTMLObjectElement;\n\tol(...args: Array<any>): HTMLOListElement;\n\toptgroup(...args: Array<any>): HTMLOptGroupElement;\n\toption(...args: Array<any>): HTMLOptionElement;\n\toutput(...args: Array<any>): HTMLOutputElement;\n\tp(...args: Array<any>): HTMLParagraphElement;\n\tparam(...args: Array<any>): HTMLParamElement;\n\tpicture(...args: Array<any>): HTMLPictureElement;\n\tpre(...args: Array<any>): HTMLPreElement;\n\tprogress(...args: Array<any>): HTMLProgressElement;\n\tq(...args: Array<any>): HTMLQuoteElement;\n\trp(...args: Array<any>): HTMLElement;\n\trt(...args: Array<any>): HTMLElement;\n\truby(...args: Array<any>): HTMLElement;\n\ts(...args: Array<any>): HTMLElement;\n\tsamp(...args: Array<any>): HTMLElement;\n\tscript(...args: Array<any>): HTMLScriptElement;\n\tsection(...args: Array<any>): HTMLElement;\n\tselect(...args: Array<any>): HTMLSelectElement;\n\tsmall(...args: Array<any>): HTMLElement;\n\tsource(...args: Array<any>): HTMLSourceElement;\n\tspan(...args: Array<any>): HTMLSpanElement;\n\tstrong(...args: Array<any>): HTMLElement;\n\tstyle(...args: Array<any>): HTMLStyleElement;\n\tsub(...args: Array<any>): HTMLElement;\n\tsummary(...args: Array<any>): HTMLElement;\n\tsup(...args: Array<any>): HTMLElement;\n\ttable(...args: Array<any>): HTMLTableElement;\n\ttbody(...args: Array<any>): HTMLTableSectionElement;\n\ttd(...args: Array<any>): HTMLTableCellElement;\n\ttemplate(...args: Array<any>): HTMLTemplateElement;\n\ttextarea(...args: Array<any>): HTMLTextAreaElement;\n\ttfoot(...args: Array<any>): HTMLTableSectionElement;\n\tth(...args: Array<any>): HTMLTableCellElement;\n\tthead(...args: Array<any>): HTMLTableSectionElement;\n\ttime(...args: Array<any>): HTMLTimeElement;\n\ttitle(...args: Array<any>): HTMLTitleElement;\n\ttr(...args: Array<any>): HTMLTableRowElement;\n\ttrack(...args: Array<any>): HTMLTrackElement;\n\tu(...args: Array<any>): HTMLElement;\n\tul(...args: Array<any>): HTMLUListElement;\n\tvar(...args: Array<any>): HTMLElement;\n\tvideo(...args: Array<any>): HTMLVideoElement;\n\twbr(...args: Array<any>): HTMLElement;\n}\n\ninterface SVGElementFactory {\n\t(...args: Array<string>): DocumentFragment;\n\t//readonly [key: string]: (...args: Array<any>) => SVGElement;\n\ta(...args: Array<any>): SVGAElement;\n\taltGlyph(...args: Array<any>): SVGElement;\n\taltGlyphDef(...args: Array<any>): SVGElement;\n\taltGlyphItem(...args: Array<any>): SVGElement;\n\tanimate(...args: Array<any>): SVGAnimateElement;\n\tanimateMotion(...args: Array<any>): SVGAnimateMotionElement;\n\tanimateTransform(...args: Array<any>): SVGAnimateTransformElement;\n\tcircle(...args: Array<any>): SVGCircleElement;\n\tclipPath(...args: Array<any>): SVGClipPathElement;\n\t\"color-profile\"(...args: Array<any>): SVGElement;\n\tcolor_profile(...args: Array<any>): SVGElement;\n\tcursor(...args: Array<any>): SVGElement;\n\tdefs(...args: Array<any>): SVGDefsElement;\n\tdesc(...args: Array<any>): SVGDescElement;\n\tdiscard(...args: Array<any>): SVGElement;\n\tellipse(...args: Array<any>): SVGEllipseElement;\n\tfeBlend(...args: Array<any>): SVGFEBlendElement;\n\tfeColorMatrix(...args: Array<any>): SVGFEColorMatrixElement;\n\tfeComponentTransfer(...args: Array<any>): SVGFEComponentTransferElement;\n\tfeComposite(...args: Array<any>): SVGFECompositeElement;\n\tfeConvolveMatrix(...args: Array<any>): SVGFEConvolveMatrixElement;\n\tfeDiffuseLighting(...args: Array<any>): SVGFEDiffuseLightingElement;\n\tfeDisplacementMap(...args: Array<any>): SVGFEDisplacementMapElement;\n\tfeDistantLight(...args: Array<any>): SVGFEDistantLightElement;\n\tfeDropShadow(...args: Array<any>): SVGElement;\n\tfeFlood(...args: Array<any>): SVGFEFloodElement;\n\tfeFuncA(...args: Array<any>): SVGFEFuncAElement;\n\tfeFuncB(...args: Array<any>): SVGFEFuncBElement;\n\tfeFuncG(...args: Array<any>): SVGFEFuncGElement;\n\tfeFuncR(...args: Array<any>): SVGFEFuncRElement;\n\tfeGaussianBlur(...args: Array<any>): SVGFEGaussianBlurElement;\n\tfeImage(...args: Array<any>): SVGFEImageElement;\n\tfeMerge(...args: Array<any>): SVGFEMergeElement;\n\tfeMergeNode(...args: Array<any>): SVGFEMergeNodeElement;\n\tfeMorphology(...args: Array<any>): SVGFEMorphologyElement;\n\tfeOffset(...args: Array<any>): SVGFEOffsetElement;\n\tfePointLight(...args: Array<any>): SVGFEPointLightElement;\n\tfeSpecularLighting(...args: Array<any>): SVGFESpecularLightingElement;\n\tfeSpotLight(...args: Array<any>): SVGFESpotLightElement;\n\tfeTile(...args: Array<any>): SVGFETileElement;\n\tfeTurbulence(...args: Array<any>): SVGFETurbulenceElement;\n\tfilter(...args: Array<any>): SVGFilterElement;\n\tfont(...args: Array<any>): SVGElement;\n\t\"font-face\"(...args: Array<any>): SVGElement;\n\tfont_face(...args: Array<any>): SVGElement;\n\t\"font-face-format\"(...args: Array<any>): SVGElement;\n\tfont_face_format(...args: Array<any>): SVGElement;\n\t\"font-face-name\"(...args: Array<any>): SVGElement;\n\tfont_face_name(...args: Array<any>): SVGElement;\n\t\"font-face-src\"(...args: Array<any>): SVGElement;\n\tfont_face_src(...args: Array<any>): SVGElement;\n\t\"font-face-uri\"(...args: Array<any>): SVGElement;\n\tfont_face_uri(...args: Array<any>): SVGElement;\n\tforeignObject(...args: Array<any>): SVGForeignObjectElement;\n\tg(...args: Array<any>): SVGGElement;\n\tglyph(...args: Array<any>): SVGElement;\n\tglyphRef(...args: Array<any>): SVGElement;\n\thkern(...args: Array<any>): SVGElement;\n\timage(...args: Array<any>): SVGImageElement;\n\tline(...args: Array<any>): SVGLineElement;\n\tlinearGradient(...args: Array<any>): SVGLinearGradientElement;\n\tmarker(...args: Array<any>): SVGMarkerElement;\n\tmask(...args: Array<any>): SVGMaskElement;\n\tmetadata(...args: Array<any>): SVGMetadataElement;\n\t\"missing-glyph\"(...args: Array<any>): SVGElement;\n\tmissing_glyph(...args: Array<any>): SVGElement;\n\tmpath(...args: Array<any>): SVGElement;\n\tpath(...args: Array<any>): SVGPathElement;\n\tpattern(...args: Array<any>): SVGPatternElement;\n\tpolygon(...args: Array<any>): SVGPolygonElement;\n\tpolyline(...args: Array<any>): SVGPolylineElement;\n\tradialGradient(...args: Array<any>): SVGRadialGradientElement;\n\trect(...args: Array<any>): SVGRectElement;\n\tscript(...args: Array<any>): SVGScriptElement;\n\tset(...args: Array<any>): SVGElement;\n\tstop(...args: Array<any>): SVGStopElement;\n\tstyle(...args: Array<any>): SVGStyleElement;\n\tsvg(...args: Array<any>): SVGSVGElement;\n\tswitch(...args: Array<any>): SVGSwitchElement;\n\tsymbol(...args: Array<any>): SVGSymbolElement;\n\ttext(...args: Array<any>): SVGTextElement;\n\ttextPath(...args: Array<any>): SVGTextPathElement;\n\ttitle(...args: Array<any>): SVGTitleElement;\n\ttref(...args: Array<any>): SVGElement;\n\ttspan(...args: Array<any>): SVGTSpanElement;\n\tuse(...args: Array<any>): SVGUseElement;\n\tview(...args: Array<any>): SVGViewElement;\n\tvkern(...args: Array<any>): SVGElement;\n}\n\nexport const HTML: HTMLElementFactory = <HTMLElementFactory> <unknown> parseHTML;\nexport const SVG: SVGElementFactory = <SVGElementFactory> <unknown> parseSVG;\n\nfor (const name of \"a abbr address area article aside audio b base bdi bdo blockquote br button canvas caption cite code col colgroup datalist dd del details dfn dialog div dl dt em embed fieldset figcaption figure footer form h1 h2 h3 h4 h5 h6 header hr i iframe img input ins kbd label legend li link main map mark menu menuitem meta meter nav noscript object ol optgroup option output p param picture pre progress q rp rt ruby s samp script section select small source span strong style sub summary sup table tbody td template textarea tfoot th thead time title tr track u ul var video wbr\".split(\" \")) {\n\t(<any>HTML)[name] = (...args: Array<any>) => applyElementArgs(document.createElement(name), args);\n}\nfor (const name of \"a altGlyph altGlyphDef altGlyphItem animate animateMotion animateTransform circle clipPath color-profile cursor defs desc discard ellipse feBlend feColorMatrix feComponentTransfer feComposite feConvolveMatrix feDiffuseLighting feDisplacementMap feDistantLight feDropShadow feFlood feFuncA feFuncB feFuncG feFuncR feGaussianBlur feImage feMerge feMergeNode feMorphology feOffset fePointLight feSpecularLighting feSpotLight feTile feTurbulence filter font font-face font-face-format font-face-name font-face-src font-face-uri foreignObject g glyph glyphRef hkern image line linearGradient marker mask metadata missing-glyph mpath path pattern polygon polyline radialGradient rect script set stop style svg switch symbol text textPath title tref tspan use view vkern\".split(\" \")) {\n\t(<any>SVG)[name] = (...args: Array<any>) => applyElementArgs(<SVGElement> document.createElementNS(svgNS, name), args);\n\tif (/-/.test(name)) {\n\t\tconst snakeCaseName = name.replace(/-/g, \"_\");\n\t\t(<any>SVG)[snakeCaseName] = (...args: Array<any>) => applyElementArgs(<SVGElement> document.createElementNS(svgNS, name), args);\n\t}\n}\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { BeepBoxOption, DictionaryArray, toNameMap, Config } from \"../synth/SynthConfig\";\r\nimport { Song } from \"../synth/synth\";\r\nimport { HTML } from \"imperative-html/dist/esm/elements-strict\";\r\n\r\nexport interface ChannelColors extends BeepBoxOption {\r\n    readonly secondaryChannel: string;\r\n    readonly primaryChannel: string;\r\n    readonly secondaryNote: string;\r\n    readonly primaryNote: string;\r\n}\r\n\r\nexport class ColorConfig {\r\n    public static colorLookup: Map<number, ChannelColors> = new Map<number, ChannelColors>();\r\n\r\n    public static readonly themes: { [name: string]: string } = {\r\n        \"dark classic\": `\r\n\t\t\t:root {\r\n\t\t\t\t--page-margin: black;\r\n\t\t\t\t--editor-background: black;\r\n\t\t\t\t--hover-preview: white;\r\n\t\t\t\t--playhead: white;\r\n\t\t\t\t--primary-text: white;\r\n\t\t\t\t--secondary-text: #999;\r\n\t\t\t\t--inverted-text: black;\r\n\t\t\t\t--text-selection: rgba(119,68,255,0.99);\r\n\t\t\t\t--box-selection-fill: rgba(255,255,255,0.2);\r\n\t\t\t\t--loop-accent: #74f;\r\n\t\t\t\t--link-accent: #98f;\r\n\t\t\t\t--ui-widget-background: #444;\r\n\t\t\t\t--ui-widget-focus: #777;\r\n\t\t\t\t--pitch-background: #444;\r\n\t\t\t\t--tonic: #864;\r\n\t\t\t\t--fifth-note: #468;\r\n\t\t\t\t--white-piano-key: #bbb;\r\n\t\t\t\t--black-piano-key: #444;\r\n\t\t\t\t\t--use-color-formula: false;\r\n\t\t\t\t\t--track-editor-bg-pitch: #444;\r\n\t\t\t\t\t--track-editor-bg-pitch-dim: #333;\r\n\t\t\t\t\t--track-editor-bg-noise: #444;\r\n\t\t\t\t\t--track-editor-bg-noise-dim: #333;\r\n\t\t\t\t\t--track-editor-bg-mod: #234;\r\n\t\t\t\t\t--track-editor-bg-mod-dim: #123;\r\n\t\t\t\t\t--multiplicative-mod-slider: #456;\r\n\t\t\t\t\t--overwriting-mod-slider: #654;\r\n\t\t\t\t\t--indicator-primary: #74f;\r\n\t\t\t\t\t--indicator-secondary: #444;\r\n\t\t\t\t\t--select2-opt-group: #585858;\r\n\t\t\t\t\t--input-box-outline: #333;\r\n\t\t\t\t\t--mute-button-normal: #ffa033;\r\n\t\t\t\t\t--mute-button-mod: #9a6bff;\r\n\t\t\t\t--pitch1-secondary-channel: #0099A1;\r\n\t\t\t\t--pitch1-primary-channel:   #25F3FF;\r\n\t\t\t\t--pitch1-secondary-note:    #00BDC7;\r\n\t\t\t\t--pitch1-primary-note:      #92F9FF;\r\n\t\t\t\t--pitch2-secondary-channel: #A1A100;\r\n\t\t\t\t--pitch2-primary-channel:   #FFFF25;\r\n\t\t\t\t--pitch2-secondary-note:    #C7C700;\r\n\t\t\t\t--pitch2-primary-note:      #FFFF92;\r\n\t\t\t\t--pitch3-secondary-channel: #C75000;\r\n\t\t\t\t--pitch3-primary-channel:   #FF9752;\r\n\t\t\t\t--pitch3-secondary-note:    #FF771C;\r\n\t\t\t\t--pitch3-primary-note:      #FFCDAB;\r\n\t\t\t\t--pitch4-secondary-channel: #00A100;\r\n\t\t\t\t--pitch4-primary-channel:   #50FF50;\r\n\t\t\t\t--pitch4-secondary-note:    #00C700;\r\n\t\t\t\t--pitch4-primary-note:      #A0FFA0;\r\n\t\t\t\t--pitch5-secondary-channel: #D020D0;\r\n\t\t\t\t--pitch5-primary-channel:   #FF90FF;\r\n\t\t\t\t--pitch5-secondary-note:    #E040E0;\r\n\t\t\t\t--pitch5-primary-note:      #FFC0FF;\r\n\t\t\t\t--pitch6-secondary-channel: #7777B0;\r\n\t\t\t\t--pitch6-primary-channel:   #A0A0FF;\r\n\t\t\t\t--pitch6-secondary-note:    #8888D0;\r\n\t\t\t\t--pitch6-primary-note:      #D0D0FF;\r\n\t\t\t\t--pitch7-secondary-channel: #8AA100;\r\n\t\t\t\t--pitch7-primary-channel:   #DEFF25;\r\n\t\t\t\t--pitch7-secondary-note:    #AAC700;\r\n\t\t\t\t--pitch7-primary-note:      #E6FF92;\r\n\t\t\t\t--pitch8-secondary-channel: #DF0019;\r\n\t\t\t\t--pitch8-primary-channel:   #FF98A4;\r\n\t\t\t\t--pitch8-secondary-note:    #FF4E63;\r\n\t\t\t\t--pitch8-primary-note:      #FFB2BB;\r\n\t\t\t\t--pitch9-secondary-channel: #00A170;\r\n\t\t\t\t--pitch9-primary-channel:   #50FFC9;\r\n\t\t\t\t--pitch9-secondary-note:    #00C78A;\r\n\t\t\t\t--pitch9-primary-note:      #83FFD9;\r\n\t\t\t\t--pitch10-secondary-channel:#A11FFF;\r\n\t\t\t\t--pitch10-primary-channel:  #CE8BFF;\r\n\t\t\t\t--pitch10-secondary-note:   #B757FF;\r\n\t\t\t\t--pitch10-primary-note:     #DFACFF;\r\n\t\t\t\t--noise1-secondary-channel: #6F6F6F;\r\n\t\t\t\t--noise1-primary-channel:   #AAAAAA;\r\n\t\t\t\t--noise1-secondary-note:    #A7A7A7;\r\n\t\t\t\t--noise1-primary-note:      #E0E0E0;\r\n\t\t\t\t--noise2-secondary-channel: #996633;\r\n\t\t\t\t--noise2-primary-channel:   #DDAA77;\r\n\t\t\t\t--noise2-secondary-note:    #CC9966;\r\n\t\t\t\t--noise2-primary-note:      #F0D0BB;\r\n\t\t\t\t--noise3-secondary-channel: #4A6D8F;\r\n\t\t\t\t--noise3-primary-channel:   #77AADD;\r\n\t\t\t\t--noise3-secondary-note:    #6F9FCF;\r\n\t\t\t\t--noise3-primary-note:      #BBD7FF;\r\n\t\t\t\t--noise4-secondary-channel: #7A4F9A;\r\n\t\t\t\t--noise4-primary-channel:   #AF82D2;\r\n\t\t\t\t--noise4-secondary-note:    #9E71C1;\r\n\t\t\t\t--noise4-primary-note:      #D4C1EA;\r\n\t\t\t\t--noise5-secondary-channel: #607837;\r\n\t\t\t\t--noise5-primary-channel:   #A2BB77;\r\n\t\t\t\t--noise5-secondary-note:    #91AA66;\r\n\t\t\t\t--noise5-primary-note:      #C5E2B2;\r\n          --mod1-secondary-channel:   #339955;\r\n\t\t\t\t\t--mod1-primary-channel:     #77fc55;\r\n\t\t\t\t\t--mod1-secondary-note:      #77ff8a;\r\n\t\t\t\t\t--mod1-primary-note:        #cdffee;\r\n\t\t\t\t\t--mod2-secondary-channel:   #993355;\r\n\t\t\t\t\t--mod2-primary-channel:     #f04960;\r\n\t\t\t\t\t--mod2-secondary-note:      #f057a0;\r\n\t\t\t\t\t--mod2-primary-note:        #ffb8de;\r\n\t\t\t\t\t--mod3-secondary-channel:   #553399;\r\n\t\t\t\t\t--mod3-primary-channel:     #8855fc;\r\n\t\t\t\t\t--mod3-secondary-note:      #aa64ff;\r\n\t\t\t\t\t--mod3-primary-note:\t    #f8ddff;\r\n\t\t\t\t\t--mod4-secondary-channel:   #a86436;\r\n\t\t\t\t\t--mod4-primary-channel:     #c8a825;\r\n\t\t\t\t\t--mod4-secondary-note:      #e8ba46;\r\n\t\t\t\t\t--mod4-primary-note:        #fff6d3;\r\n\t\t\t\t\t--mod-label-primary:        #999;\r\n\t\t\t\t\t--mod-label-secondary-text: #333;\r\n\t\t\t\t\t--mod-label-primary-text:   black;\r\n\t\t\t\t\t--disabled-note-primary:    #999;\r\n\t\t\t\t\t--disabled-note-secondary:  #666;\r\n\t\t\t\t}\r\n\t\t\t`,\r\n        \"dark competition\": `\r\n\t\t\t\t:root {\r\n\t\t\t\t\t--page-margin: black;\r\n\t\t\t\t\t--editor-background: black;\r\n\t\t\t\t\t--hover-preview: #ddd;\r\n\t\t\t\t\t--playhead: #ddd;\r\n\t\t\t\t\t--primary-text: #ddd;\r\n\t\t\t\t\t--secondary-text: #8e695b;\r\n\t\t\t\t\t--inverted-text: black;\r\n\t\t\t\t\t--text-selection: rgba(169,0,255,0.99);\r\n\t\t\t\t\t--box-selection-fill: rgba(221,221,221,0.2);\r\n\t\t\t\t\t--loop-accent: #bf15ba;\r\n\t\t\t\t\t--link-accent: #f888ff;\r\n\t\t\t\t\t--ui-widget-background: #443a3a;\r\n\t\t\t\t\t--ui-widget-focus: #777;\r\n\t\t\t\t\t--pitch-background: #353333;\r\n\t\t\t\t\t--tonic: #884a44;\r\n\t\t\t\t\t--fifth-note: #415498;\r\n\t\t\t\t\t--white-piano-key: #bbb;\r\n\t\t\t\t\t--black-piano-key: #444;\r\n\t\t\t\t\t--use-color-formula: false;\r\n\t\t\t\t\t--track-editor-bg-pitch: #444;\r\n\t\t\t\t\t--track-editor-bg-pitch-dim: #333;\r\n\t\t\t\t\t--track-editor-bg-noise: #444;\r\n\t\t\t\t\t--track-editor-bg-noise-dim: #333;\r\n\t\t\t\t\t--track-editor-bg-mod: #234;\r\n\t\t\t\t\t--track-editor-bg-mod-dim: #123;\r\n\t\t\t\t\t--multiplicative-mod-slider: #456;\r\n\t\t\t\t\t--overwriting-mod-slider: #654;\r\n\t\t\t\t\t--indicator-primary: #74f;\r\n\t\t\t\t\t--indicator-secondary: #444;\r\n\t\t\t\t\t--select2-opt-group: #585858;\r\n\t\t\t\t\t--input-box-outline: #333;\r\n\t\t\t\t\t--mute-button-normal: #ffa033;\r\n\t\t\t\t\t--mute-button-mod: #9a6bff;\r\n\t\t\t\t\t--pitch1-secondary-channel: #0099a1;\r\n\t\t\t\t\t--pitch1-primary-channel:   #25f3ff;\r\n\t\t\t\t\t--pitch1-secondary-note:    #00bdc7;\r\n\t\t\t\t\t--pitch1-primary-note:      #92f9ff;\r\n\t\t\t\t\t--pitch2-secondary-channel: #a1a100;\r\n\t\t\t\t\t--pitch2-primary-channel:   #ffff25;\r\n\t\t\t\t\t--pitch2-secondary-note:    #c7c700;\r\n\t\t\t\t\t--pitch2-primary-note:      #ffff92;\r\n\t\t\t\t\t--pitch3-secondary-channel: #c75000;\r\n\t\t\t\t\t--pitch3-primary-channel:   #ff9752;\r\n\t\t\t\t\t--pitch3-secondary-note:    #ff771c;\r\n\t\t\t\t\t--pitch3-primary-note:      #ffcdab;\r\n\t\t\t\t\t--pitch4-secondary-channel: #00a100;\r\n\t\t\t\t\t--pitch4-primary-channel:   #50ff50;\r\n\t\t\t\t\t--pitch4-secondary-note:    #00c700;\r\n\t\t\t\t\t--pitch4-primary-note:      #a0ffa0;\r\n\t\t\t\t\t--pitch5-secondary-channel: #d020d0;\r\n\t\t\t\t\t--pitch5-primary-channel:   #ff90ff;\r\n\t\t\t\t\t--pitch5-secondary-note:    #e040e0;\r\n\t\t\t\t\t--pitch5-primary-note:      #ffc0ff;\r\n\t\t\t\t\t--pitch6-secondary-channel: #7777b0;\r\n\t\t\t\t\t--pitch6-primary-channel:   #a0a0ff;\r\n\t\t\t\t\t--pitch6-secondary-note:    #8888d0;\r\n\t\t\t\t\t--pitch6-primary-note:      #d0d0ff;\r\n\t\t\t\t\t--pitch7-secondary-channel: #8AA100;\r\n\t\t\t\t\t--pitch7-primary-channel:   #DEFF25;\r\n\t\t\t\t\t--pitch7-secondary-note:\t  #AAC700;\r\n\t\t\t\t\t--pitch7-primary-note:\t\t\t#E6FF92;\r\n\t\t\t\t\t--pitch8-secondary-channel: #DF0019;\r\n\t\t\t\t\t--pitch8-primary-channel:   #FF98A4;\r\n\t\t\t\t\t--pitch8-secondary-note:    #FF4E63;\r\n\t\t\t\t\t--pitch8-primary-note:      #FFB2BB;\r\n\t\t\t\t\t--pitch9-secondary-channel: #00A170;\r\n\t\t\t\t\t--pitch9-primary-channel:   #50FFC9;\r\n\t\t\t\t\t--pitch9-secondary-note:    #00C78A;\r\n\t\t\t\t\t--pitch9-primary-note:\t\t\t#83FFD9;\r\n\t\t\t\t\t--pitch10-secondary-channel:#A11FFF;\r\n\t\t\t\t\t--pitch10-primary-channel:  #CE8BFF;\r\n\t\t\t\t\t--pitch10-secondary-note:   #B757FF;\r\n\t\t\t\t\t--pitch10-primary-note:     #DFACFF;\r\n\t\t\t\t\t--noise1-secondary-channel: #6f6f6f;\r\n\t\t\t\t\t--noise1-primary-channel:   #aaaaaa;\r\n\t\t\t\t\t--noise1-secondary-note:    #a7a7a7;\r\n\t\t\t\t\t--noise1-primary-note:      #e0e0e0;\r\n\t\t\t\t\t--noise2-secondary-channel: #996633;\r\n\t\t\t\t\t--noise2-primary-channel:   #ddaa77;\r\n\t\t\t\t\t--noise2-secondary-note:    #cc9966;\r\n\t\t\t\t\t--noise2-primary-note:      #f0d0bb;\r\n\t\t\t\t\t--noise3-secondary-channel: #4a6d8f;\r\n\t\t\t\t\t--noise3-primary-channel:   #77aadd;\r\n\t\t\t\t\t--noise3-secondary-note:    #6f9fcf;\r\n\t\t\t\t\t--noise3-primary-note:      #bbd7ff;\r\n\t\t\t\t\t--noise4-secondary-channel: #6B3E8E;\r\n\t\t\t\t\t--noise4-primary-channel:   #AF82D2;\r\n\t\t\t\t\t--noise4-secondary-note:    #9E71C1;\r\n\t\t\t\t\t--noise5-secondary-channel: #607837;\r\n\t\t\t\t\t--noise5-primary-channel:   #A2BB77;\r\n\t\t\t\t\t--noise5-secondary-note:    #91AA66;\r\n\t\t\t\t\t--noise5-primary-note:      #C5E2B2;\r\n\t\t\t\t\t--mod1-secondary-channel:   #339955;\r\n\t\t\t\t\t--mod1-primary-channel:     #77fc55;\r\n\t\t\t\t\t--mod1-secondary-note:      #77ff8a;\r\n\t\t\t\t\t--mod1-primary-note:        #cdffee;\r\n\t\t\t\t\t--mod2-secondary-channel:   #993355;\r\n\t\t\t\t\t--mod2-primary-channel:     #f04960;\r\n\t\t\t\t\t--mod2-secondary-note:      #f057a0;\r\n\t\t\t\t\t--mod2-primary-note:        #ffb8de;\r\n\t\t\t\t\t--mod3-secondary-channel:   #553399;\r\n\t\t\t\t\t--mod3-primary-channel:     #8855fc;\r\n\t\t\t\t\t--mod3-secondary-note:      #aa64ff;\r\n\t\t\t\t\t--mod3-primary-note:\t\t\t  #f8ddff;\r\n\t\t\t\t\t--mod4-secondary-channel:   #a86436;\r\n\t\t\t\t\t--mod4-primary-channel:     #c8a825;\r\n\t\t\t\t\t--mod4-secondary-note:      #e8ba46;\r\n\t\t\t\t\t--mod4-primary-note:        #fff6d3;\r\n\t\t\t\t\t--mod-label-primary:        #999;\r\n\t\t\t\t\t--mod-label-secondary-text: #333;\r\n\t\t\t\t\t--mod-label-primary-text:   black;\r\n\t\t\t\t\t--disabled-note-primary:    #999;\r\n\t\t\t\t\t--disabled-note-secondary:  #666;\r\n\r\n\t\t\t}\r\n\t\t`,\r\n        \"light classic\": `\r\n\t\t\t:root {\r\n\t\t\t\t-webkit-text-stroke-width: 0.5px;\r\n\t\t\t\t--page-margin: #685d88;\r\n\t\t\t\t--editor-background: white;\r\n\t\t\t\t--hover-preview: black;\r\n\t\t\t\t--playhead: rgba(0,0,0,0.5);\r\n\t\t\t\t--primary-text: black;\r\n\t\t\t\t--secondary-text: #777;\r\n\t\t\t\t--inverted-text: white;\r\n\t\t\t\t--text-selection: rgba(200,170,255,0.99);\r\n\t\t\t\t--box-selection-fill: rgba(0,0,0,0.1);\r\n\t\t\t\t--loop-accent: #98f;\r\n\t\t\t\t--link-accent: #74f;\r\n\t\t\t\t--ui-widget-background: #ececec;\r\n\t\t\t\t--ui-widget-focus: #eee;\r\n\t\t\t\t--pitch-background: #ececec;\r\n\t\t\t\t--tonic: #f0d6b6;\r\n\t\t\t\t--fifth-note: #bbddf0;\r\n\t\t\t\t--white-piano-key: #eee;\r\n\t\t\t\t--black-piano-key: #666;\r\n\t\t\t\t\t--use-color-formula: false;\r\n\t\t\t\t\t--track-editor-bg-pitch: #ececec;\r\n\t\t\t\t\t--track-editor-bg-pitch-dim: #fdfdfd;\r\n\t\t\t\t\t--track-editor-bg-noise: #ececec;\r\n\t\t\t\t\t--track-editor-bg-noise-dim: #fdfdfd;\r\n\t\t\t\t\t--track-editor-bg-mod: #dbecfd;\r\n\t\t\t\t\t--track-editor-bg-mod-dim: #ecfdff;\r\n\t\t\t\t\t--multiplicative-mod-slider: #789;\r\n\t\t\t\t\t--overwriting-mod-slider: #987;\r\n\t\t\t\t\t--indicator-primary: #98f;\r\n\t\t\t\t\t--indicator-secondary: #cde;\r\n\t\t\t\t\t--select2-opt-group: #cecece;\r\n\t\t\t\t\t--input-box-outline: #ddd;\r\n\t\t\t\t\t--mute-button-normal: #c0b47f;\r\n\t\t\t\t\t--mute-button-mod: #bd7fc0;\r\n\t\t\t\t--pitch1-secondary-channel: #6CD9ED;\r\n\t\t\t\t--pitch1-primary-channel:   #00A0BD;\r\n\t\t\t\t--pitch1-secondary-note:    #34C2DC;\r\n\t\t\t\t--pitch1-primary-note:      #00758A;\r\n\t\t\t\t--pitch2-secondary-channel: #E3C941;\r\n\t\t\t\t--pitch2-primary-channel:   #B49700;\r\n\t\t\t\t--pitch2-secondary-note:    #D1B628;\r\n\t\t\t\t--pitch2-primary-note:      #836E00;\r\n\t\t\t\t--pitch3-secondary-channel: #FF9D61;\r\n\t\t\t\t--pitch3-primary-channel:   #E14E00;\r\n\t\t\t\t--pitch3-secondary-note:    #F67D3C;\r\n\t\t\t\t--pitch3-primary-note:      #B64000;\r\n\t\t\t\t--pitch4-secondary-channel: #4BE24B;\r\n\t\t\t\t--pitch4-primary-channel:   #00A800;\r\n\t\t\t\t--pitch4-secondary-note:    #2DC82D;\r\n\t\t\t\t--pitch4-primary-note:      #008000;\r\n\t\t\t\t--pitch5-secondary-channel: #FF90FF;\r\n\t\t\t\t--pitch5-primary-channel:   #E12EDF;\r\n\t\t\t\t--pitch5-secondary-note:    #EC6EEC;\r\n\t\t\t\t--pitch5-primary-note:      #A600A5;\r\n\t\t\t\t--pitch6-secondary-channel: #B5B5FE;\r\n\t\t\t\t--pitch6-primary-channel:   #6969FD;\r\n\t\t\t\t--pitch6-secondary-note:    #9393FE;\r\n\t\t\t\t--pitch6-primary-note:      #4A4AD7;\r\n\t\t\t\t--pitch7-secondary-channel: #C2D848;\r\n\t\t\t\t--pitch7-primary-channel:   #8EA800;\r\n\t\t\t\t--pitch7-secondary-note:    #B0C82D;\r\n\t\t\t\t--pitch7-primary-note:      #6C8000;\r\n\t\t\t\t--pitch8-secondary-channel: #FF90A4;\r\n\t\t\t\t--pitch8-primary-channel:   #E12E4D;\r\n\t\t\t\t--pitch8-secondary-note:    #EC6E85;\r\n\t\t\t\t--pitch8-primary-note:      #A6001D;\r\n\t\t\t\t--pitch9-secondary-channel: #41E3B5;\r\n\t\t\t\t--pitch9-primary-channel:   #00B481;\r\n\t\t\t\t--pitch9-secondary-note:    #28D1A1;\r\n\t\t\t\t--pitch9-primary-note:      #00835E;\r\n\t\t\t\t--pitch10-secondary-channel:#CA77FF;\r\n\t\t\t\t--pitch10-primary-channel:  #9609FF;\r\n\t\t\t\t--pitch10-secondary-note:   #B54FFF;\r\n\t\t\t\t--pitch10-primary-note:     #8400E3;\r\n\t\t\t\t--noise1-secondary-channel: #C1C1C1;\r\n\t\t\t\t--noise1-primary-channel:   #898989;\r\n\t\t\t\t--noise1-secondary-note:    #ADADAD;\r\n\t\t\t\t--noise1-primary-note:      #6C6C6C;\r\n\t\t\t\t--noise2-secondary-channel: #E8BB8C;\r\n\t\t\t\t--noise2-primary-channel:   #BD7D3A;\r\n\t\t\t\t--noise2-secondary-note:    #D1A374;\r\n\t\t\t\t--noise2-primary-note:      #836342;\r\n\t\t\t\t--noise3-secondary-channel: #9BC4EB;\r\n\t\t\t\t--noise3-primary-channel:   #4481BE;\r\n\t\t\t\t--noise3-secondary-note:    #7CA7D3;\r\n\t\t\t\t--noise3-primary-note:      #476685;\r\n\t\t\t\t--noise4-secondary-channel: #C5A5E0;\r\n\t\t\t\t--noise4-primary-channel:   #8553AE;\r\n\t\t\t\t--noise4-secondary-note:    #B290CC;\r\n\t\t\t\t--noise4-primary-note:      #684F7D;\r\n\t\t\t\t--noise5-secondary-channel: #B8CE93;\r\n\t\t\t\t--noise5-primary-channel:   #87A74F;\r\n\t\t\t\t--noise5-secondary-note:    #ABC183;\r\n\t\t\t\t--noise5-primary-note:      #68784C;\r\n\t\t\t\t\t--mod1-secondary-channel:   #339955;\r\n\t\t\t\t\t--mod1-primary-channel:     #77dd55;\r\n\t\t\t\t\t--mod1-secondary-note:      #77ff8a;\r\n\t\t\t\t\t--mod1-primary-note:        #2ad84a;\r\n\t\t\t\t\t--mod2-secondary-channel:   #993355;\r\n\t\t\t\t\t--mod2-primary-channel:     #f04960;\r\n\t\t\t\t\t--mod2-secondary-note:      #f057a0;\r\n\t\t\t\t\t--mod2-primary-note:        #ba124a;\r\n\t\t\t\t\t--mod3-secondary-channel:   #553399;\r\n\t\t\t\t\t--mod3-primary-channel:     #8855fc;\r\n\t\t\t\t\t--mod3-secondary-note:      #aa64ff;\r\n\t\t\t\t\t--mod3-primary-note:        #7a1caa;\r\n\t\t\t\t\t--mod4-secondary-channel:   #a86436;\r\n\t\t\t\t\t--mod4-primary-channel:     #c8a825;\r\n\t\t\t\t\t--mod4-secondary-note:      #e8ba46;\r\n\t\t\t\t\t--mod4-primary-note:        #a86810;\r\n\t\t\t\t\t--mod-label-primary:        #dddddd;\r\n\t\t\t\t\t--mod-label-secondary-text: #777;\r\n\t\t\t\t\t--mod-label-primary-text:   black;\r\n\t\t\t\t\t--disabled-note-primary:    #666;\r\n\t\t\t\t\t--disabled-note-secondary:  #aaa;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t.beepboxEditor button, .beepboxEditor select {\r\n\t\t\t\tbox-shadow: inset 0 0 0 1px var(--secondary-text);\r\n\t\t\t}\r\n\r\n\t\t\t\t.select2-selection__rendered {\r\n\t\t\t\t\tbox-shadow: inset 0 0 0 1px var(--secondary-text);\r\n\t\t\t\t}\r\n\t\t`,\r\n        \"jummbox classic\": `\r\n\t\t\t\t:root {\r\n\t\t\t\t\t--page-margin: #040410;\r\n\t\t\t\t\t--editor-background: #040410;\r\n\t\t\t\t\t--hover-preview: white;\r\n\t\t\t\t\t--playhead: rgba(255, 255, 255, 0.9);\r\n\t\t\t\t\t--primary-text: white;\r\n\t\t\t\t\t--secondary-text: #84859a;\r\n\t\t\t\t\t--inverted-text: black;\r\n\t\t\t\t\t--text-selection: rgba(119,68,255,0.99);\r\n\t\t\t\t\t--box-selection-fill: #044b94;\r\n\t\t\t\t\t--loop-accent: #74f;\r\n\t\t\t\t\t--link-accent: #98f;\r\n\t\t\t\t\t--ui-widget-background: #393e4f;\r\n\t\t\t\t\t--ui-widget-focus: #6d6886;\r\n\t\t\t\t\t--pitch-background: #393e4f;\r\n\t\t\t\t\t--tonic: #725491;\r\n\t\t\t\t\t--fifth-note: #54547a;\r\n\t\t\t\t\t--white-piano-key: #eee;\r\n\t\t\t\t\t--black-piano-key: #666;\r\n\t\t\t\t\t--use-color-formula: true;\r\n\t\t\t\t\t--track-editor-bg-pitch: #393e4f;\r\n\t\t\t\t\t--track-editor-bg-pitch-dim: #1c1d28;\r\n\t\t\t\t\t--track-editor-bg-noise: #3d3535;\r\n\t\t\t\t\t--track-editor-bg-noise-dim: #161313;\r\n\t\t\t\t\t--track-editor-bg-mod: #283560;\r\n\t\t\t\t\t--track-editor-bg-mod-dim: #0a101f;\r\n\t\t\t\t\t--multiplicative-mod-slider: #606c9f;\r\n\t\t\t\t\t--overwriting-mod-slider: #6850b5;\r\n\t\t\t\t\t--indicator-primary: #9c64f7;\r\n\t\t\t\t\t--indicator-secondary: #393e4f;\r\n\t\t\t\t\t--select2-opt-group: #5d576f;\r\n\t\t\t\t\t--input-box-outline: #222;\r\n\t\t\t\t\t--mute-button-normal: #dda85d;\r\n\t\t\t\t\t--mute-button-mod: #886eae;\r\n\t\t\t\t\t--mod-label-primary: #282840;\r\n\t\t\t\t\t--mod-label-secondary-text: rgb(87, 86, 120);\r\n\t\t\t\t\t--mod-label-primary-text: white;\r\n\t\t\t\t\t--pitch-secondary-channel-hue: 0;\r\n\t\t\t\t\t--pitch-secondary-channel-hue-scale: 6.1;\r\n\t\t\t\t\t--pitch-secondary-channel-sat: 83.3;\r\n\t\t\t\t\t--pitch-secondary-channel-sat-scale: 0.1;\r\n\t\t\t\t\t--pitch-secondary-channel-lum: 40;\r\n\t\t\t\t\t--pitch-secondary-channel-lum-scale: 0.05;\r\n\t\t\t\t\t--pitch-primary-channel-hue: 0;\r\n\t\t\t\t\t--pitch-primary-channel-hue-scale: 6.1;\r\n\t\t\t\t\t--pitch-primary-channel-sat: 100;\r\n\t\t\t\t\t--pitch-primary-channel-sat-scale: 0.1;\r\n\t\t\t\t\t--pitch-primary-channel-lum: 67.5;\r\n\t\t\t\t\t--pitch-primary-channel-lum-scale: 0.05;\r\n\t\t\t\t\t--pitch-secondary-note-hue: 0;\r\n\t\t\t\t\t--pitch-secondary-note-hue-scale: 6.1;\r\n\t\t\t\t\t--pitch-secondary-note-sat: 93.9;\r\n\t\t\t\t\t--pitch-secondary-note-sat-scale: 0.1;\r\n\t\t\t\t\t--pitch-secondary-note-lum: 25;\r\n\t\t\t\t\t--pitch-secondary-note-lum-scale: 0.05;\r\n\t\t\t\t\t--pitch-primary-note-hue: 0;\r\n\t\t\t\t\t--pitch-primary-note-hue-scale: 6.1;\r\n\t\t\t\t\t--pitch-primary-note-sat: 100;\r\n\t\t\t\t\t--pitch-primary-note-sat-scale: 0.05;\r\n\t\t\t\t\t--pitch-primary-note-lum: 85.6;\r\n\t\t\t\t\t--pitch-primary-note-lum-scale: 0.025;\r\n\t\t\t\t\t--noise-secondary-channel-hue: 0;\r\n\t\t\t\t\t--noise-secondary-channel-hue-scale: 2;\r\n\t\t\t\t\t--noise-secondary-channel-sat: 25;\r\n\t\t\t\t\t--noise-secondary-channel-sat-scale: 0;\r\n\t\t\t\t\t--noise-secondary-channel-lum: 42;\r\n\t\t\t\t\t--noise-secondary-channel-lum-scale: 0;\r\n\t\t\t\t\t--noise-primary-channel-hue: 0;\r\n\t\t\t\t\t--noise-primary-channel-hue-scale: 2;\r\n\t\t\t\t\t--noise-primary-channel-sat: 33;\r\n\t\t\t\t\t--noise-primary-channel-sat-scale: 0;\r\n\t\t\t\t\t--noise-primary-channel-lum: 63.5;\r\n\t\t\t\t\t--noise-primary-channel-lum-scale: 0;\r\n\t\t\t\t\t--noise-secondary-note-hue: 0;\r\n\t\t\t\t\t--noise-secondary-note-hue-scale: 2;\r\n\t\t\t\t\t--noise-secondary-note-sat: 33.5;\r\n\t\t\t\t\t--noise-secondary-note-sat-scale: 0;\r\n\t\t\t\t\t--noise-secondary-note-lum: 55;\r\n\t\t\t\t\t--noise-secondary-note-lum-scale: 0;\r\n\t\t\t\t\t--noise-primary-note-hue: 0;\r\n\t\t\t\t\t--noise-primary-note-hue-scale: 2;\r\n\t\t\t\t\t--noise-primary-note-sat: 46.5;\r\n\t\t\t\t\t--noise-primary-note-sat-scale: 0;\r\n\t\t\t\t\t--noise-primary-note-lum: 74;\r\n\t\t\t\t\t--noise-primary-note-lum-scale: 0;\r\n\t\t\t\t\t--mod-secondary-channel-hue: 192;\r\n\t\t\t\t\t--mod-secondary-channel-hue-scale: 1.5;\r\n\t\t\t\t\t--mod-secondary-channel-sat: 88;\r\n\t\t\t\t\t--mod-secondary-channel-sat-scale: 0;\r\n\t\t\t\t\t--mod-secondary-channel-lum: 50;\r\n\t\t\t\t\t--mod-secondary-channel-lum-scale: 0;\r\n\t\t\t\t\t--mod-primary-channel-hue: 192;\r\n\t\t\t\t\t--mod-primary-channel-hue-scale: 1.5;\r\n\t\t\t\t\t--mod-primary-channel-sat: 96;\r\n\t\t\t\t\t--mod-primary-channel-sat-scale: 0;\r\n\t\t\t\t\t--mod-primary-channel-lum: 80;\r\n\t\t\t\t\t--mod-primary-channel-lum-scale: 0;\r\n\t\t\t\t\t--mod-secondary-note-hue: 192;\r\n\t\t\t\t\t--mod-secondary-note-hue-scale: 1.5;\r\n\t\t\t\t\t--mod-secondary-note-sat: 92;\r\n\t\t\t\t\t--mod-secondary-note-sat-scale: 0;\r\n\t\t\t\t\t--mod-secondary-note-lum: 45;\r\n\t\t\t\t\t--mod-secondary-note-lum-scale: 0;\r\n\t\t\t\t\t--mod-primary-note-hue: 192;\r\n\t\t\t\t\t--mod-primary-note-hue-scale: 1.5;\r\n\t\t\t\t\t--mod-primary-note-sat: 96;\r\n\t\t\t\t\t--mod-primary-note-sat-scale: 0;\r\n\t\t\t\t\t--mod-primary-note-lum: 85;\r\n\t\t\t\t\t--mod-primary-note-lum-scale: 0;\r\n\t\t\t\t\t--disabled-note-primary:    #91879f;\r\n\t\t\t\t\t--disabled-note-secondary:  #6a677a;\r\n\t\t\t\t}\r\n\t\t\t`,\r\n        \"forest\": `\r\n\t\t\t\t:root {\r\n\t\t\t\t\t--page-margin: #010c03;\r\n\t\t\t\t\t--editor-background: #010c03;\r\n\t\t\t\t\t--hover-preview: #efe;\r\n\t\t\t\t\t--playhead: rgba(232, 255, 232, 0.9);\r\n\t\t\t\t\t--primary-text: #efe;\r\n\t\t\t\t\t--secondary-text: #70A070;\r\n\t\t\t\t\t--inverted-text: #280228;\r\n\t\t\t\t\t--text-selection: rgba(255,68,199,0.99);\r\n\t\t\t\t\t--box-selection-fill: #267aa3;\r\n\t\t\t\t\t--loop-accent: #ffe845;\r\n\t\t\t\t\t--link-accent: #9f8;\r\n\t\t\t\t\t--ui-widget-background: #203829;\r\n\t\t\t\t\t--ui-widget-focus: #487860;\r\n\t\t\t\t\t--pitch-background: #203829;\r\n\t\t\t\t\t--tonic: #2b8d20;\r\n\t\t\t\t\t--fifth-note: #385840;\r\n\t\t\t\t\t--white-piano-key: #bda;\r\n\t\t\t\t\t--black-piano-key: #573;\r\n\t\t\t\t\t--use-color-formula: true;\r\n\t\t\t\t\t--track-editor-bg-pitch: #254820;\r\n\t\t\t\t\t--track-editor-bg-pitch-dim: #102819;\r\n\t\t\t\t\t--track-editor-bg-noise: #304050;\r\n\t\t\t\t\t--track-editor-bg-noise-dim: #102030;\r\n\t\t\t\t\t--track-editor-bg-mod: #506030;\r\n\t\t\t\t\t--track-editor-bg-mod-dim: #2a300a;\r\n\t\t\t\t\t--multiplicative-mod-slider: #205c8f;\r\n\t\t\t\t\t--overwriting-mod-slider: #20ac6f;\r\n\t\t\t\t\t--indicator-primary: #dcd866;\r\n\t\t\t\t\t--indicator-secondary: #203829;\r\n\t\t\t\t\t--select2-opt-group: #1a6f5a;\r\n\t\t\t\t\t--input-box-outline: #242;\r\n\t\t\t\t\t--mute-button-normal: #49e980;\r\n\t\t\t\t\t--mute-button-mod: #c2e502;\r\n\t\t\t\t\t--mod-label-primary: #133613;\r\n\t\t\t\t\t--mod-label-secondary-text: rgb(27, 126, 40);\r\n\t\t\t\t\t--mod-label-primary-text: #efe;\r\n\t\t\t\t\t--pitch-secondary-channel-hue: 120;\r\n\t\t\t\t\t--pitch-secondary-channel-hue-scale: 8.1;\r\n\t\t\t\t\t--pitch-secondary-channel-sat: 59;\r\n\t\t\t\t\t--pitch-secondary-channel-sat-scale: 0.1;\r\n\t\t\t\t\t--pitch-secondary-channel-lum: 50;\r\n\t\t\t\t\t--pitch-secondary-channel-lum-scale: 0.04;\r\n\t\t\t\t\t--pitch-primary-channel-hue: 120;\r\n\t\t\t\t\t--pitch-primary-channel-hue-scale: 8.1;\r\n\t\t\t\t\t--pitch-primary-channel-sat: 86;\r\n\t\t\t\t\t--pitch-primary-channel-sat-scale: 0.1;\r\n\t\t\t\t\t--pitch-primary-channel-lum: 70;\r\n\t\t\t\t\t--pitch-primary-channel-lum-scale: 0.04;\r\n\t\t\t\t\t--pitch-secondary-note-hue: 120;\r\n\t\t\t\t\t--pitch-secondary-note-hue-scale: 8.1;\r\n\t\t\t\t\t--pitch-secondary-note-sat: 85;\r\n\t\t\t\t\t--pitch-secondary-note-sat-scale: 0.1;\r\n\t\t\t\t\t--pitch-secondary-note-lum: 30;\r\n\t\t\t\t\t--pitch-secondary-note-lum-scale: 0.04;\r\n\t\t\t\t\t--pitch-primary-note-hue: 120;\r\n\t\t\t\t\t--pitch-primary-note-hue-scale: 8.1;\r\n\t\t\t\t\t--pitch-primary-note-sat: 90;\r\n\t\t\t\t\t--pitch-primary-note-sat-scale: 0.05;\r\n\t\t\t\t\t--pitch-primary-note-lum: 80;\r\n\t\t\t\t\t--pitch-primary-note-lum-scale: 0.025;\r\n\t\t\t\t\t--noise-secondary-channel-hue: 200;\r\n\t\t\t\t\t--noise-secondary-channel-hue-scale: 1.1;\r\n\t\t\t\t\t--noise-secondary-channel-sat: 25;\r\n\t\t\t\t\t--noise-secondary-channel-sat-scale: 0;\r\n\t\t\t\t\t--noise-secondary-channel-lum: 22;\r\n\t\t\t\t\t--noise-secondary-channel-lum-scale: 0;\r\n\t\t\t\t\t--noise-primary-channel-hue: 200;\r\n\t\t\t\t\t--noise-primary-channel-hue-scale: 1.1;\r\n\t\t\t\t\t--noise-primary-channel-sat: 48;\r\n\t\t\t\t\t--noise-primary-channel-sat-scale: 0;\r\n\t\t\t\t\t--noise-primary-channel-lum: 65;\r\n\t\t\t\t\t--noise-primary-channel-lum-scale: 0;\r\n\t\t\t\t\t--noise-secondary-note-hue: 200;\r\n\t\t\t\t\t--noise-secondary-note-hue-scale: 1.1;\r\n\t\t\t\t\t--noise-secondary-note-sat: 33.5;\r\n\t\t\t\t\t--noise-secondary-note-sat-scale: 0;\r\n\t\t\t\t\t--noise-secondary-note-lum: 33;\r\n\t\t\t\t\t--noise-secondary-note-lum-scale: 0;\r\n\t\t\t\t\t--noise-primary-note-hue: 200;\r\n\t\t\t\t\t--noise-primary-note-hue-scale: 1.1;\r\n\t\t\t\t\t--noise-primary-note-sat: 46.5;\r\n\t\t\t\t\t--noise-primary-note-sat-scale: 0;\r\n\t\t\t\t\t--noise-primary-note-lum: 64;\r\n\t\t\t\t\t--noise-primary-note-lum-scale: 0;\r\n\t\t\t\t\t--mod-secondary-channel-hue: 40;\r\n\t\t\t\t\t--mod-secondary-channel-hue-scale: 1.8;\r\n\t\t\t\t\t--mod-secondary-channel-sat: 44;\r\n\t\t\t\t\t--mod-secondary-channel-sat-scale: 0;\r\n\t\t\t\t\t--mod-secondary-channel-lum: 50;\r\n\t\t\t\t\t--mod-secondary-channel-lum-scale: 0;\r\n\t\t\t\t\t--mod-primary-channel-hue: 40;\r\n\t\t\t\t\t--mod-primary-channel-hue-scale: 1.8;\r\n\t\t\t\t\t--mod-primary-channel-sat: 60;\r\n\t\t\t\t\t--mod-primary-channel-sat-scale: 0;\r\n\t\t\t\t\t--mod-primary-channel-lum: 80;\r\n\t\t\t\t\t--mod-primary-channel-lum-scale: 0;\r\n\t\t\t\t\t--mod-secondary-note-hue: 40;\r\n\t\t\t\t\t--mod-secondary-note-hue-scale: 1.8;\r\n\t\t\t\t\t--mod-secondary-note-sat: 62;\r\n\t\t\t\t\t--mod-secondary-note-sat-scale: 0;\r\n\t\t\t\t\t--mod-secondary-note-lum: 55;\r\n\t\t\t\t\t--mod-secondary-note-lum-scale: 0;\r\n\t\t\t\t\t--mod-primary-note-hue: 40;\r\n\t\t\t\t\t--mod-primary-note-hue-scale: 1.8;\r\n\t\t\t\t\t--mod-primary-note-sat: 66;\r\n\t\t\t\t\t--mod-primary-note-sat-scale: 0;\r\n\t\t\t\t\t--mod-primary-note-lum: 85;\r\n\t\t\t\t\t--mod-primary-note-lum-scale: 0;\r\n\t\t\t\t\t--disabled-note-primary:    #536e5c;\r\n\t\t\t\t\t--disabled-note-secondary:  #395440;\r\n\t\t\t\t}\r\n\t\t\t`,\r\n        \"canyon\": `\r\n\t\t\t\t:root {\r\n\t\t\t\t\t--page-margin: #0a0000;\r\n\t\t\t\t\t--editor-background: #0a0000;\r\n\t\t\t\t\t--hover-preview: white;\r\n\t\t\t\t\t--playhead: rgba(247, 172, 196, 0.9);\r\n\t\t\t\t\t--primary-text: #f5d6bf;\r\n\t\t\t\t\t--secondary-text: #934050;\r\n\t\t\t\t\t--inverted-text: #290505;\r\n\t\t\t\t\t--text-selection: rgba(255, 208, 68, 0.99);\r\n\t\t\t\t\t--box-selection-fill: #94044870;\r\n\t\t\t\t\t--loop-accent: #ff1e1e;\r\n\t\t\t\t\t--link-accent: #da7b76;\r\n\t\t\t\t\t--ui-widget-background: #533137;\r\n\t\t\t\t\t--ui-widget-focus: #743e4b;\r\n\t\t\t\t\t--pitch-background: #4f3939;\r\n\t\t\t\t\t--tonic: #9e4145;\r\n\t\t\t\t\t--fifth-note: #5b3e6b;\r\n\t\t\t\t\t--white-piano-key: #d89898;\r\n\t\t\t\t\t--black-piano-key: #572b29;\r\n\t\t\t\t\t--use-color-formula: true;\r\n\t\t\t\t\t--track-editor-bg-pitch: #5e3a41;\r\n\t\t\t\t\t--track-editor-bg-pitch-dim: #281d1c;\r\n\t\t\t\t\t--track-editor-bg-noise: #3a3551;\r\n\t\t\t\t\t--track-editor-bg-noise-dim: #272732;\r\n\t\t\t\t\t--track-editor-bg-mod: #552045;\r\n\t\t\t\t\t--track-editor-bg-mod-dim: #3e1442;\r\n\t\t\t\t\t--multiplicative-mod-slider: #9f6095;\r\n\t\t\t\t\t--overwriting-mod-slider: #b55050;\r\n\t\t\t\t\t--indicator-primary: #f2f764;\r\n\t\t\t\t\t--indicator-secondary: #4f3939;\r\n\t\t\t\t\t--select2-opt-group: #673030;\r\n\t\t\t\t\t--input-box-outline: #443131;\r\n\t\t\t\t\t--mute-button-normal: #d81833;\r\n\t\t\t\t\t--mute-button-mod: #9e2691;\r\n\t\t\t\t\t--mod-label-primary: #5f2b39;\r\n\t\t\t\t\t--mod-label-secondary-text: rgb(158, 66, 122);\r\n\t\t\t\t\t--mod-label-primary-text: #e6caed;\r\n\t\t\t\t\t--pitch-secondary-channel-hue: 0;\r\n\t\t\t\t\t--pitch-secondary-channel-hue-scale: 11.8;\r\n\t\t\t\t\t--pitch-secondary-channel-sat: 73.3;\r\n\t\t\t\t\t--pitch-secondary-channel-sat-scale: 0.1;\r\n\t\t\t\t\t--pitch-secondary-channel-lum: 40;\r\n\t\t\t\t\t--pitch-secondary-channel-lum-scale: 0.05;\r\n\t\t\t\t\t--pitch-primary-channel-hue: 0;\r\n\t\t\t\t\t--pitch-primary-channel-hue-scale: 11.8;\r\n\t\t\t\t\t--pitch-primary-channel-sat: 90;\r\n\t\t\t\t\t--pitch-primary-channel-sat-scale: 0.1;\r\n\t\t\t\t\t--pitch-primary-channel-lum: 67.5;\r\n\t\t\t\t\t--pitch-primary-channel-lum-scale: 0.05;\r\n\t\t\t\t\t--pitch-secondary-note-hue: 0;\r\n\t\t\t\t\t--pitch-secondary-note-hue-scale: 11.8;\r\n\t\t\t\t\t--pitch-secondary-note-sat: 83.9;\r\n\t\t\t\t\t--pitch-secondary-note-sat-scale: 0.1;\r\n\t\t\t\t\t--pitch-secondary-note-lum: 35;\r\n\t\t\t\t\t--pitch-secondary-note-lum-scale: 0.05;\r\n\t\t\t\t\t--pitch-primary-note-hue: 0;\r\n\t\t\t\t\t--pitch-primary-note-hue-scale: 11.8;\r\n\t\t\t\t\t--pitch-primary-note-sat: 100;\r\n\t\t\t\t\t--pitch-primary-note-sat-scale: 0.05;\r\n\t\t\t\t\t--pitch-primary-note-lum: 85.6;\r\n\t\t\t\t\t--pitch-primary-note-lum-scale: 0.025;\r\n\t\t\t\t\t--noise-secondary-channel-hue: 60;\r\n\t\t\t\t\t--noise-secondary-channel-hue-scale: 2;\r\n\t\t\t\t\t--noise-secondary-channel-sat: 25;\r\n\t\t\t\t\t--noise-secondary-channel-sat-scale: 0;\r\n\t\t\t\t\t--noise-secondary-channel-lum: 42;\r\n\t\t\t\t\t--noise-secondary-channel-lum-scale: 0;\r\n\t\t\t\t\t--noise-primary-channel-hue: 60;\r\n\t\t\t\t\t--noise-primary-channel-hue-scale: 2;\r\n\t\t\t\t\t--noise-primary-channel-sat: 33;\r\n\t\t\t\t\t--noise-primary-channel-sat-scale: 0;\r\n\t\t\t\t\t--noise-primary-channel-lum: 63.5;\r\n\t\t\t\t\t--noise-primary-channel-lum-scale: 0;\r\n\t\t\t\t\t--noise-secondary-note-hue: 60;\r\n\t\t\t\t\t--noise-secondary-note-hue-scale: 2;\r\n\t\t\t\t\t--noise-secondary-note-sat: 33.5;\r\n\t\t\t\t\t--noise-secondary-note-sat-scale: 0;\r\n\t\t\t\t\t--noise-secondary-note-lum: 55;\r\n\t\t\t\t\t--noise-secondary-note-lum-scale: 0;\r\n\t\t\t\t\t--noise-primary-note-hue: 60;\r\n\t\t\t\t\t--noise-primary-note-hue-scale: 2;\r\n\t\t\t\t\t--noise-primary-note-sat: 46.5;\r\n\t\t\t\t\t--noise-primary-note-sat-scale: 0;\r\n\t\t\t\t\t--noise-primary-note-lum: 74;\r\n\t\t\t\t\t--noise-primary-note-lum-scale: 0;\r\n\t\t\t\t\t--mod-secondary-channel-hue: 222;\r\n\t\t\t\t\t--mod-secondary-channel-hue-scale: 1.5;\r\n\t\t\t\t\t--mod-secondary-channel-sat: 88;\r\n\t\t\t\t\t--mod-secondary-channel-sat-scale: 0;\r\n\t\t\t\t\t--mod-secondary-channel-lum: 50;\r\n\t\t\t\t\t--mod-secondary-channel-lum-scale: 0;\r\n\t\t\t\t\t--mod-primary-channel-hue: 222;\r\n\t\t\t\t\t--mod-primary-channel-hue-scale: 1.5;\r\n\t\t\t\t\t--mod-primary-channel-sat: 96;\r\n\t\t\t\t\t--mod-primary-channel-sat-scale: 0;\r\n\t\t\t\t\t--mod-primary-channel-lum: 80;\r\n\t\t\t\t\t--mod-primary-channel-lum-scale: 0;\r\n\t\t\t\t\t--mod-secondary-note-hue: 222;\r\n\t\t\t\t\t--mod-secondary-note-hue-scale: 1.5;\r\n\t\t\t\t\t--mod-secondary-note-sat: 92;\r\n\t\t\t\t\t--mod-secondary-note-sat-scale: 0;\r\n\t\t\t\t\t--mod-secondary-note-lum: 54;\r\n\t\t\t\t\t--mod-secondary-note-lum-scale: 0;\r\n\t\t\t\t\t--mod-primary-note-hue: 222;\r\n\t\t\t\t\t--mod-primary-note-hue-scale: 1.5;\r\n\t\t\t\t\t--mod-primary-note-sat: 96;\r\n\t\t\t\t\t--mod-primary-note-sat-scale: 0;\r\n\t\t\t\t\t--mod-primary-note-lum: 75;\r\n\t\t\t\t\t--mod-primary-note-lum-scale: 0;\r\n\t\t\t\t\t--disabled-note-primary:    #515164;\r\n\t\t\t\t\t--disabled-note-secondary:  #2a2a3a;\r\n\t\t\t\t}\r\n\t\t\t`,\r\n        \"midnight\": `\r\n\t\t:root {\r\n\t\t\t--page-margin: #000;\r\n\t\t\t--editor-background: #000;\r\n\t\t\t--hover-preview: #757575;\r\n\t\t\t--playhead: #fff;\r\n\t\t\t--primary-text: #fff;\r\n\t\t\t--secondary-text: #acacac;\r\n\t\t\t--inverted-text: #290505;\r\n\t\t\t--text-selection: rgba(155, 155, 155, 0.99);\r\n\t\t\t--box-selection-fill: #79797970;\r\n\t\t\t--loop-accent: #646464;\r\n\t\t\t--link-accent: #707070;\r\n\t\t\t--ui-widget-background: #353535;\r\n\t\t\t--ui-widget-focus: #464646;\r\n\t\t\t--pitch-background: #222121;\r\n\t\t\t--tonic: #555955;\r\n\t\t\t--fifth-note: #1a1818;\r\n\t\t\t--white-piano-key: #a89e9e;\r\n\t\t\t--black-piano-key: #2d2424;\r\n\t\t\t--use-color-formula: true;\r\n\t\t\t--track-editor-bg-pitch: #373737;\r\n\t\t\t--track-editor-bg-pitch-dim: #131313;\r\n\t\t\t--track-editor-bg-noise: #484848;\r\n\t\t\t--track-editor-bg-noise-dim: #131313;\r\n\t\t\t--track-editor-bg-mod: #373737;\r\n\t\t\t--track-editor-bg-mod-dim: #131313;\r\n\t\t\t--multiplicative-mod-slider: #555;\r\n\t\t\t--overwriting-mod-slider: #464545;\r\n\t\t\t--indicator-primary: #e0e0e0;\r\n\t\t\t--indicator-secondary: #404040;\r\n\t\t\t--select2-opt-group: #3c3b3b;\r\n\t\t\t--input-box-outline: #757575;\r\n\t\t\t--mute-button-normal: #8e8d8d;\r\n\t\t\t--mute-button-mod: #ddd;\r\n\t\t\t--mod-label-primary: #262526;\r\n\t\t\t--mod-label-secondary-text: rgb(227, 222, 225);\r\n\t\t\t--mod-label-primary-text: #b9b9b9;\r\n\t\t\t--pitch-secondary-channel-hue: 240;\r\n\t\t\t--pitch-secondary-channel-hue-scale: 228;\r\n\t\t\t--pitch-secondary-channel-sat: 73.3;\r\n\t\t\t--pitch-secondary-channel-sat-scale: 0.1;\r\n\t\t\t--pitch-secondary-channel-lum: 25;\r\n\t\t\t--pitch-secondary-channel-lum-scale: 0.05;\r\n\t\t\t--pitch-primary-channel-hue: 240;\r\n\t\t\t--pitch-primary-channel-hue-scale: 228;\r\n\t\t\t--pitch-primary-channel-sat: 80;\r\n\t\t\t--pitch-primary-channel-sat-scale: 0.1;\r\n\t\t\t--pitch-primary-channel-lum: 60.5;\r\n\t\t\t--pitch-primary-channel-lum-scale: 0.05;\r\n\t\t\t--pitch-secondary-note-hue: 240;\r\n\t\t\t--pitch-secondary-note-hue-scale: 228;\r\n\t\t\t--pitch-secondary-note-sat: 73.9;\r\n\t\t\t--pitch-secondary-note-sat-scale: 0.1;\r\n\t\t\t--pitch-secondary-note-lum: 32;\r\n\t\t\t--pitch-secondary-note-lum-scale: 0.05;\r\n\t\t\t--pitch-primary-note-hue: 240;\r\n\t\t\t--pitch-primary-note-hue-scale: 228;\r\n\t\t\t--pitch-primary-note-sat: 90;\r\n\t\t\t--pitch-primary-note-sat-scale: 0.05;\r\n\t\t\t--pitch-primary-note-lum: 80.6;\r\n\t\t\t--pitch-primary-note-lum-scale: 0.025;\r\n\t\t\t--noise-secondary-channel-hue: 160;\r\n\t\t\t--noise-secondary-channel-hue-scale: 2;\r\n\t\t\t--noise-secondary-channel-sat: 25;\r\n\t\t\t--noise-secondary-channel-sat-scale: 0;\r\n\t\t\t--noise-secondary-channel-lum: 42;\r\n\t\t\t--noise-secondary-channel-lum-scale: 0;\r\n\t\t\t--noise-primary-channel-hue: 160;\r\n\t\t\t--noise-primary-channel-hue-scale: 2;\r\n\t\t\t--noise-primary-channel-sat: 33;\r\n\t\t\t--noise-primary-channel-sat-scale: 0;\r\n\t\t\t--noise-primary-channel-lum: 63.5;\r\n\t\t\t--noise-primary-channel-lum-scale: 0;\r\n\t\t\t--noise-secondary-note-hue: 160;\r\n\t\t\t--noise-secondary-note-hue-scale: 2;\r\n\t\t\t--noise-secondary-note-sat: 33.5;\r\n\t\t\t--noise-secondary-note-sat-scale: 0;\r\n\t\t\t--noise-secondary-note-lum: 55;\r\n\t\t\t--noise-secondary-note-lum-scale: 0;\r\n\t\t\t--noise-primary-note-hue: 160;\r\n\t\t\t--noise-primary-note-hue-scale: 2;\r\n\t\t\t--noise-primary-note-sat: 46.5;\r\n\t\t\t--noise-primary-note-sat-scale: 0;\r\n\t\t\t--noise-primary-note-lum: 74;\r\n\t\t\t--noise-primary-note-lum-scale: 0;\r\n\t\t\t--mod-secondary-channel-hue: 62;\r\n\t\t\t--mod-secondary-channel-hue-scale: 1.5;\r\n\t\t\t--mod-secondary-channel-sat: 88;\r\n\t\t\t--mod-secondary-channel-sat-scale: 0;\r\n\t\t\t--mod-secondary-channel-lum: 30;\r\n\t\t\t--mod-secondary-channel-lum-scale: 0;\r\n\t\t\t--mod-primary-channel-hue: 62;\r\n\t\t\t--mod-primary-channel-hue-scale: 1.5;\r\n\t\t\t--mod-primary-channel-sat: 96;\r\n\t\t\t--mod-primary-channel-sat-scale: 0;\r\n\t\t\t--mod-primary-channel-lum: 80;\r\n\t\t\t--mod-primary-channel-lum-scale: 0;\r\n\t\t\t--mod-secondary-note-hue: 62;\r\n\t\t\t--mod-secondary-note-hue-scale: 1.5;\r\n\t\t\t--mod-secondary-note-sat: 92;\r\n\t\t\t--mod-secondary-note-sat-scale: 0;\r\n\t\t\t--mod-secondary-note-lum: 34;\r\n\t\t\t--mod-secondary-note-lum-scale: 0;\r\n\t\t\t--mod-primary-note-hue: 62;\r\n\t\t\t--mod-primary-note-hue-scale: 1.5;\r\n\t\t\t--mod-primary-note-sat: 96;\r\n\t\t\t--mod-primary-note-sat-scale: 0;\r\n\t\t\t--mod-primary-note-lum: 75;\r\n\t\t\t--mod-primary-note-lum-scale: 0;\r\n\t\t\t--disabled-note-primary:    #66a;\r\n\t\t\t--disabled-note-secondary:  #447;\r\n\t\t}\r\n\t`,\r\n        \"jummbox light\": `\r\n\t\t\t\t:root {\r\n\t\t\t\t\t-webkit-text-stroke-width: 0.5px;\r\n\t\t\t\t\t--page-margin: #fefdff;\r\n\t\t\t\t\t--editor-background: #fefdff;\r\n\t\t\t\t\t--hover-preview: #302880;\r\n\t\t\t\t\t--playhead: rgba(62, 32, 120, 0.9);\r\n\t\t\t\t\t--primary-text: #401890;\r\n\t\t\t\t\t--secondary-text: #8769af;\r\n\t\t\t\t\t--inverted-text: #fefdff;\r\n\t\t\t\t\t--text-selection: rgba(255,160,235,0.99);\r\n\t\t\t\t\t--box-selection-fill: rgba(30,62,220,0.5);\r\n\t\t\t\t\t--loop-accent: #4c35d4;\r\n\t\t\t\t\t--link-accent: #7af;\r\n\t\t\t\t\t--ui-widget-background: #bf9cec;\r\n\t\t\t\t\t--ui-widget-focus: #e9c4ff;\r\n\t\t\t\t\t--pitch-background: #e2d9f9;\r\n\t\t\t\t\t--tonic: #c288cc;\r\n\t\t\t\t\t--fifth-note: #d8c9fd;\r\n\t\t\t\t\t--white-piano-key: #e2e2ff;\r\n\t\t\t\t\t--black-piano-key: #66667a;\r\n\t\t\t\t\t--use-color-formula: true;\r\n\t\t\t\t\t--track-editor-bg-pitch: #d9e5ec;\r\n\t\t\t\t\t--track-editor-bg-pitch-dim: #eaeef5;\r\n\t\t\t\t\t--track-editor-bg-noise: #ffc3ae;\r\n\t\t\t\t\t--track-editor-bg-noise-dim: #ffe0cf;\r\n\t\t\t\t\t--track-editor-bg-mod: #c9accc;\r\n\t\t\t\t\t--track-editor-bg-mod-dim: #ebe3ef;\r\n\t\t\t\t\t--multiplicative-mod-slider: #807caf;\r\n\t\t\t\t\t--overwriting-mod-slider: #909cdf;\r\n\t\t\t\t\t--indicator-primary: #ae38ff;\r\n\t\t\t\t\t--indicator-secondary: #bbd4ec;\r\n\t\t\t\t\t--select2-opt-group: #c1b7f1;\r\n\t\t\t\t\t--input-box-outline: #bbb;\r\n\t\t\t\t\t--mute-button-normal: #e9b752;\r\n\t\t\t\t\t--mute-button-mod: #9558ee;\r\n\t\t\t\t\t--mod-label-primary: #ececff;\r\n\t\t\t\t\t--mod-label-secondary-text: rgb(197, 145, 247);\r\n\t\t\t\t\t--mod-label-primary-text: #302880;\r\n\t\t\t\t\t--pitch-secondary-channel-hue: 0;\r\n\t\t\t\t\t--pitch-secondary-channel-hue-scale: 8.1;\r\n\t\t\t\t\t--pitch-secondary-channel-sat: 53.3;\r\n\t\t\t\t\t--pitch-secondary-channel-sat-scale: -0.1;\r\n\t\t\t\t\t--pitch-secondary-channel-lum: 72;\r\n\t\t\t\t\t--pitch-secondary-channel-lum-scale: -0.05;\r\n\t\t\t\t\t--pitch-primary-channel-hue: 0;\r\n\t\t\t\t\t--pitch-primary-channel-hue-scale: 8.1;\r\n\t\t\t\t\t--pitch-primary-channel-sat: 97;\r\n\t\t\t\t\t--pitch-primary-channel-sat-scale: -0.1;\r\n\t\t\t\t\t--pitch-primary-channel-lum: 45.5;\r\n\t\t\t\t\t--pitch-primary-channel-lum-scale: -0.05;\r\n\t\t\t\t\t--pitch-secondary-note-hue: 0;\r\n\t\t\t\t\t--pitch-secondary-note-hue-scale: 8.1;\r\n\t\t\t\t\t--pitch-secondary-note-sat: 93.9;\r\n\t\t\t\t\t--pitch-secondary-note-sat-scale: -0.1;\r\n\t\t\t\t\t--pitch-secondary-note-lum: 95;\r\n\t\t\t\t\t--pitch-secondary-note-lum-scale: -0.05;\r\n\t\t\t\t\t--pitch-primary-note-hue: 0;\r\n\t\t\t\t\t--pitch-primary-note-hue-scale: 8.1;\r\n\t\t\t\t\t--pitch-primary-note-sat: 100;\r\n\t\t\t\t\t--pitch-primary-note-sat-scale: 0.05;\r\n\t\t\t\t\t--pitch-primary-note-lum: 43.6;\r\n\t\t\t\t\t--pitch-primary-note-lum-scale: -0.025;\r\n\t\t\t\t\t--noise-secondary-channel-hue: 220;\r\n\t\t\t\t\t--noise-secondary-channel-hue-scale: 2;\r\n\t\t\t\t\t--noise-secondary-channel-sat: 25;\r\n\t\t\t\t\t--noise-secondary-channel-sat-scale: 0;\r\n\t\t\t\t\t--noise-secondary-channel-lum: 62;\r\n\t\t\t\t\t--noise-secondary-channel-lum-scale: -0.1;\r\n\t\t\t\t\t--noise-primary-channel-hue: 220;\r\n\t\t\t\t\t--noise-primary-channel-hue-scale: 2;\r\n\t\t\t\t\t--noise-primary-channel-sat: 53;\r\n\t\t\t\t\t--noise-primary-channel-sat-scale: 0;\r\n\t\t\t\t\t--noise-primary-channel-lum: 53.5;\r\n\t\t\t\t\t--noise-primary-channel-lum-scale: -0.1;\r\n\t\t\t\t\t--noise-secondary-note-hue: 220;\r\n\t\t\t\t\t--noise-secondary-note-hue-scale: 2;\r\n\t\t\t\t\t--noise-secondary-note-sat: 58.5;\r\n\t\t\t\t\t--noise-secondary-note-sat-scale: 0;\r\n\t\t\t\t\t--noise-secondary-note-lum: 85;\r\n\t\t\t\t\t--noise-secondary-note-lum-scale: -1;\r\n\t\t\t\t\t--noise-primary-note-hue: 220;\r\n\t\t\t\t\t--noise-primary-note-hue-scale: 2;\r\n\t\t\t\t\t--noise-primary-note-sat: 56.5;\r\n\t\t\t\t\t--noise-primary-note-sat-scale: 0;\r\n\t\t\t\t\t--noise-primary-note-lum: 54;\r\n\t\t\t\t\t--noise-primary-note-lum-scale: -1;\r\n\t\t\t\t\t--mod-secondary-channel-hue: 90;\r\n\t\t\t\t\t--mod-secondary-channel-hue-scale: 1.5;\r\n\t\t\t\t\t--mod-secondary-channel-sat: 88;\r\n\t\t\t\t\t--mod-secondary-channel-sat-scale: 0;\r\n\t\t\t\t\t--mod-secondary-channel-lum: 60;\r\n\t\t\t\t\t--mod-secondary-channel-lum-scale: 0;\r\n\t\t\t\t\t--mod-primary-channel-hue: 90;\r\n\t\t\t\t\t--mod-primary-channel-hue-scale: 1.5;\r\n\t\t\t\t\t--mod-primary-channel-sat: 100;\r\n\t\t\t\t\t--mod-primary-channel-sat-scale: 0;\r\n\t\t\t\t\t--mod-primary-channel-lum: 65;\r\n\t\t\t\t\t--mod-primary-channel-lum-scale: 0;\r\n\t\t\t\t\t--mod-secondary-note-hue: 90;\r\n\t\t\t\t\t--mod-secondary-note-hue-scale: 1.5;\r\n\t\t\t\t\t--mod-secondary-note-sat: 92;\r\n\t\t\t\t\t--mod-secondary-note-sat-scale: 0;\r\n\t\t\t\t\t--mod-secondary-note-lum: 95;\r\n\t\t\t\t\t--mod-secondary-note-lum-scale: 0;\r\n\t\t\t\t\t--mod-primary-note-hue: 90;\r\n\t\t\t\t\t--mod-primary-note-hue-scale: 1.5;\r\n\t\t\t\t\t--mod-primary-note-sat: 96;\r\n\t\t\t\t\t--mod-primary-note-sat-scale: 0;\r\n\t\t\t\t\t--mod-primary-note-lum: 55;\r\n\t\t\t\t\t--mod-primary-note-lum-scale: 0;\r\n\t\t\t\t\t--disabled-note-primary:    #868;\r\n\t\t\t\t\t--disabled-note-secondary:  #767;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t.beepboxEditor button, .beepboxEditor select {\r\n\t\t\t\t\tbox-shadow: inset 0 0 0 1px var(--secondary-text);\r\n\t\t\t\t}\r\n\r\n\t\t\t\t.select2-selection__rendered {\r\n\t\t\t\t\tbox-shadow: inset 0 0 0 1px var(--secondary-text);\r\n\t\t\t\t}\r\n\t\t\t`,\r\n\r\n\t\t\"beachcombing\": `\r\n\t\t\t:root {\r\n\t\t\t--page-margin: #010121;\r\n\t\t\t--editor-background: #020222;\r\n\t\t\t--hover-preview: #f3ffff;\r\n\t\t\t--playhead: #fff;\r\n\t\t\t--primary-text: #c1f1ff;\r\n\t\t\t--secondary-text: #546775;\r\n\t\t\t--inverted-text: black;\r\n\t\t\t--text-selection: rgba(119,68,255,0.99);\r\n\t\t\t--box-selection-fill: #3e0028;\r\n\t\t\t--loop-accent: #5a00ff;\r\n\t\t\t--link-accent: #ff00c8fc;\r\n\t\t\t--ui-widget-background: #1f2b52;\r\n\t\t\t--ui-widget-focus: #384e91;\r\n\t\t\t--pitch-background: #2c3155;\r\n\t\t\t--tonic: #a32f6e;\r\n\t\t\t--fifth-note: #0044a0;\r\n\t\t\t--white-piano-key: #fff;\r\n\t\t\t--black-piano-key: #202d42;\r\n\t\t\t--use-color-formula: false;\r\n\t\t\t--track-editor-bg-pitch: #34406c;\r\n\t\t\t--track-editor-bg-pitch-dim: #1c1d28;\r\n\t\t\t--track-editor-bg-noise: #562e3b;\r\n\t\t\t--track-editor-bg-noise-dim: #161313;\r\n\t\t\t--track-editor-bg-mod: #372e66;\r\n\t\t\t--track-editor-bg-mod-dim: #2a1640;\r\n\t\t\t--multiplicative-mod-slider: #606c9f;\r\n\t\t\t--overwriting-mod-slider: #6850b5;\r\n\t\t\t--indicator-primary: #ff67c2;\r\n\t\t\t--indicator-secondary: #393e4f;\r\n\t\t\t--select2-opt-group: #5d576f;\r\n\t\t\t--input-box-outline: #222;\r\n\t\t\t--mute-button-normal: #7ce1ff;\r\n\t\t\t--mute-button-mod: #db519d;\r\n\t\t\t--pitch1-secondary-channel: #329b70;\r\n\t\t\t--pitch1-primary-channel: #53ffb8;\r\n\t\t\t--pitch1-secondary-note: #4cb98c;\r\n\t\t\t--pitch1-primary-note: #98ffd4;\r\n\t\t\t--pitch2-secondary-channel: #8e8632;\r\n\t\t\t--pitch2-primary-channel: #fff36a;\r\n\t\t\t--pitch2-secondary-note: #afaf22;\r\n\t\t\t--pitch2-primary-note: #f9f93f;\r\n\t\t\t--pitch3-secondary-channel: #018e8e;\r\n\t\t\t--pitch3-primary-channel: #00ffff;\r\n\t\t\t--pitch3-secondary-note: #24b7b7;\r\n\t\t\t--pitch3-primary-note: #a7ffff;\r\n\t\t\t--pitch4-secondary-channel: #6c003d;\r\n\t\t\t--pitch4-primary-channel: #ff0090;\r\n\t\t\t--pitch4-secondary-note: #a73c78;\r\n\t\t\t--pitch4-primary-note: #ff98d2;\r\n\t\t\t--pitch5-secondary-channel: #0e8153;\r\n\t\t\t--pitch5-primary-channel: #59ffbd;\r\n\t\t\t--pitch5-secondary-note: #489979;\r\n\t\t\t--pitch5-primary-note: #b0ffe0;\r\n\t\t\t--pitch6-secondary-channel: #185aab;\r\n\t\t\t--pitch6-primary-channel: #4e7ce5;\r\n\t\t\t--pitch6-secondary-note: #3e99d9;\r\n\t\t\t--pitch6-primary-note: #b3e3ff;\r\n\t\t\t--pitch7-secondary-channel: #4f007d;\r\n\t\t\t--pitch7-primary-channel: #a200ff;\r\n\t\t\t--pitch7-secondary-note: #9741c9;\r\n\t\t\t--pitch7-primary-note: #d386ff;\r\n\t\t\t--pitch8-secondary-channel: #101c8d;\r\n\t\t\t--pitch8-primary-channel: #1c5df1;\r\n\t\t\t--pitch8-secondary-note: #FF4E63;\r\n\t\t\t--pitch8-primary-note: #FFB2BB;\r\n\t\t\t--pitch9-secondary-channel: #00A170;\r\n\t\t\t--pitch9-primary-channel: #50FFC9;\r\n\t\t\t--pitch9-secondary-note: #00C78A;\r\n\t\t\t--pitch9-primary-note: #83FFD9;\r\n\t\t\t--pitch10-secondary-channel: #A11FFF;\r\n\t\t\t--pitch10-primary-channel: #CE8BFF;\r\n\t\t\t--pitch10-secondary-note: #B757FF;\r\n\t\t\t--pitch10-primary-note: #DFACFF;\r\n\t\t\t--noise1-secondary-channel: #635070;\r\n\t\t\t--noise1-primary-channel: #9071db;\r\n\t\t\t--noise1-secondary-note: #915dc1;\r\n\t\t\t--noise1-primary-note: #c5a5ff;\r\n\t\t\t--noise2-secondary-channel: #993367;\r\n\t\t\t--noise2-primary-channel: #dd777c;\r\n\t\t\t--noise2-secondary-note: #cc6695;\r\n\t\t\t--noise2-primary-note: #f0bbd1;\r\n\t\t\t--noise3-secondary-channel: #4a8c8f;\r\n\t\t\t--noise3-primary-channel: #77c5dd;\r\n\t\t\t--noise3-secondary-note: #6fb4cf;\r\n\t\t\t--noise3-primary-note: #bbf2ff;\r\n\t\t\t--noise4-secondary-channel: #8e3e7d;\r\n\t\t\t--noise4-primary-channel: #c682d2;\r\n\t\t\t--noise4-secondary-note: #b871c1;\r\n\t\t\t--noise4-primary-note: #ffb8f0;\r\n\t\t\t--noise5-secondary-channel: #785e37;\r\n\t\t\t--noise5-primary-channel: #bb9d77;\r\n\t\t\t--noise5-secondary-note: #aa8c66;\r\n\t\t\t--noise5-primary-note: #e2d1b2;\r\n\t\t\t--mod1-secondary-channel: #4e8397;\r\n\t\t\t--mod1-primary-channel: #92e6f3;\r\n\t\t\t--mod1-secondary-note: #76b9d9;\r\n\t\t\t--mod1-primary-note: #cde3ff;\r\n\t\t\t--mod2-secondary-channel: #ad5774;\r\n\t\t\t--mod2-primary-channel: #eba4ae;\r\n\t\t\t--mod2-secondary-note: #c9719b;\r\n\t\t\t--mod2-primary-note: #fdcee7;\r\n\t\t\t--mod3-secondary-channel: #6f579f;\r\n\t\t\t--mod3-primary-channel: #b192f7;\r\n\t\t\t--mod3-secondary-note: #a778e1;\r\n\t\t\t--mod3-primary-note: #f8ddff;\r\n\t\t\t--mod4-secondary-channel: #a88a36;\r\n\t\t\t--mod4-primary-channel: #bec825;\r\n\t\t\t--mod4-secondary-note: #aecb57;\r\n\t\t\t--mod4-primary-note: #dee9bd;\r\n\t\t\t--mod-label-primary: #2c2c56;\r\n\t\t\t--mod-label-secondary-text: rgb(71,69,147);\r\n\t\t\t--mod-label-primary-text: white;\r\n\t\t\t--disabled-note-primary: #91879f;\r\n\t\t\t--disabled-note-secondary: #6a677a;\r\n\r\n\r\n\t\t\t}\r\n\t\t`,\r\n\r\n\t\t\"roe\": `\r\n\t\t\t:root {\r\n\t\t\t--page-margin: #050000;\r\n\t\t\t--editor-background: #050000;\r\n\t\t\t--hover-preview: white;\r\n\t\t\t--playhead: white;\r\n\t\t\t--primary-text: #b8cee0;\r\n\t\t\t--secondary-text: #cb3434;\r\n\t\t\t--inverted-text: black;\r\n\t\t\t--text-selection: rgb(255 68 68 / 99%);\r\n\t\t\t--box-selection-fill: rgb(255 0 0 / 30%);\r\n\t\t\t--loop-accent: #7744FF;\r\n\t\t\t--link-accent: #FF2A2A;\r\n\t\t\t--ui-widget-background: #1a2642;\r\n\t\t\t--ui-widget-focus: #2c3f6d;\r\n\t\t\t--pitch-background: #15111a;\r\n\t\t\t--tonic: #1b3041;\r\n\t\t\t--fifth-note: #381818;\r\n\t\t\t--white-piano-key: #cdcdcd;\r\n\t\t\t--black-piano-key: #232323;\r\n\t\t\t--use-color-formula: false;\r\n\t\t\t--track-editor-bg-pitch: #302938;\r\n\t\t\t--track-editor-bg-pitch-dim: #211c26;\r\n\t\t\t--track-editor-bg-noise: #261f42;\r\n\t\t\t--track-editor-bg-noise-dim: #1a152d;\r\n\t\t\t--track-editor-bg-mod: #183049;\r\n\t\t\t--track-editor-bg-mod-dim: #102132;\r\n\t\t\t--multiplicative-mod-slider: #344a7f;\r\n\t\t\t--overwriting-mod-slider: #344a7f;\r\n\t\t\t--indicator-primary: #FF2A2A;\r\n\t\t\t--indicator-secondary: #800000;\r\n\t\t\t--select2-opt-group: #141e34;\r\n\t\t\t--input-box-outline: #141e34;\r\n\t\t\t--mute-button-normal: #299eff;\r\n\t\t\t--mute-button-mod: #165a93;\r\n\t\t\t--pitch1-secondary-channel: #273c90;\r\n\t\t\t--pitch1-primary-channel: #476BFF;\r\n\t\t\t--pitch1-secondary-note: #273c90;\r\n\t\t\t--pitch1-primary-note: #476BFF;\r\n\t\t\t--pitch2-secondary-channel: #3a3898;\r\n\t\t\t--pitch2-primary-channel: #625FFB;\r\n\t\t\t--pitch2-secondary-note: #3a3898;\r\n\t\t\t--pitch2-primary-note: #625FFB;\r\n\t\t\t--pitch3-secondary-channel: #542780;\r\n\t\t\t--pitch3-primary-channel: #9C49EC;\r\n\t\t\t--pitch3-secondary-note: #542780;\r\n\t\t\t--pitch3-primary-note: #9C49EC;\r\n\t\t\t--pitch4-secondary-channel: #84225d;\r\n\t\t\t--pitch4-primary-channel: #fd3fb1;\r\n\t\t\t--pitch4-secondary-note: #84225d;\r\n\t\t\t--pitch4-primary-note: #fd3fb1;\r\n\t\t\t--pitch5-secondary-channel: #8d2323;\r\n\t\t\t--pitch5-primary-channel: #ff3f3f;\r\n\t\t\t--pitch5-secondary-note: #8d2323;\r\n\t\t\t--pitch5-primary-note: #ff3f3f;\r\n\t\t\t--pitch6-secondary-channel: #84225d;\r\n\t\t\t--pitch6-primary-channel: #fd3fb1;\r\n\t\t\t--pitch6-secondary-note: #84225d;\r\n\t\t\t--pitch6-primary-note: #fd3fb1;\r\n\t\t\t--pitch7-secondary-channel: #542780;\r\n\t\t\t--pitch7-primary-channel: #9C49EC;\r\n\t\t\t--pitch7-secondary-note: #542780;\r\n\t\t\t--pitch7-primary-note: #9C49EC;\r\n\t\t\t--pitch8-secondary-channel: #3a3898;\r\n\t\t\t--pitch8-primary-channel: #625FFB;\r\n\t\t\t--pitch8-secondary-note: #3a3898;\r\n\t\t\t--pitch8-primary-note: #625FFB;\r\n\t\t\t--pitch9-secondary-channel: #273c90;\r\n\t\t\t--pitch9-primary-channel: #476BFF;\r\n\t\t\t--pitch9-secondary-note: #273c90;\r\n\t\t\t--pitch9-primary-note: #476BFF;\r\n\t\t\t--pitch10-secondary-channel: #165a93;\r\n\t\t\t--pitch10-primary-channel: #299EFF;\r\n\t\t\t--pitch10-secondary-note: #165a93;\r\n\t\t\t--pitch10-primary-note: #299EFF;\r\n\t\t\t--noise1-secondary-channel: #4281FF;\r\n\t\t\t--noise1-primary-channel: #96b9ff;\r\n\t\t\t--noise1-secondary-note: #4281FF;\r\n\t\t\t--noise1-primary-note: #96b9ff;\r\n\t\t\t--noise2-secondary-channel: #7347FF;\r\n\t\t\t--noise2-primary-channel: #c3b0ff;\r\n\t\t\t--noise2-secondary-note: #7347FF;\r\n\t\t\t--noise2-primary-note: #c3b0ff;\r\n\t\t\t--noise3-secondary-channel: #9F3CBF;\r\n\t\t\t--noise3-primary-channel: #e29cf9;\r\n\t\t\t--noise3-secondary-note: #9F3CBF;\r\n\t\t\t--noise3-primary-note: #e29cf9;\r\n\t\t\t--noise4-secondary-channel: #D3326F;\r\n\t\t\t--noise4-primary-channel: #fb9bbf;\r\n\t\t\t--noise4-secondary-note: #D3326F;\r\n\t\t\t--noise4-primary-note: #fb9bbf;\r\n\t\t\t--noise5-secondary-channel: #FF2A2A;\r\n\t\t\t--noise5-primary-channel: #ffa2a2;\r\n\t\t\t--noise5-secondary-note: #FF2A2A;\r\n\t\t\t--noise5-primary-note: #ffa2a2;\r\n\t\t\t--mod1-secondary-channel: #47587a;\r\n\t\t\t--mod1-primary-channel: #96b9ff;\r\n\t\t\t--mod1-secondary-note: #47587a;\r\n\t\t\t--mod1-primary-note: #96b9ff;\r\n\t\t\t--mod2-secondary-channel: #716791;\r\n\t\t\t--mod2-primary-channel: #c3b0ff;\r\n\t\t\t--mod2-secondary-note: #716791;\r\n\t\t\t--mod2-primary-note: #c3b0ff;\r\n\t\t\t--mod3-secondary-channel: #6f4c7b;\r\n\t\t\t--mod3-primary-channel: #e29cf9;\r\n\t\t\t--mod3-secondary-note: #6f4c7b;\r\n\t\t\t--mod3-primary-note: #e29cf9;\r\n\t\t\t--mod4-secondary-channel: #9e6279;\r\n\t\t\t--mod4-primary-channel: #fb9bbf;\r\n\t\t\t--mod4-secondary-note: #9e6279;\r\n\t\t\t--mod4-primary-note: #fb9bbf;\r\n\t\t\t--mod-label-primary: #15111a;\r\n\t\t\t--mod-label-secondary-text: #cb3434;\r\n\t\t\t--mod-label-primary-text: white;\r\n\t\t\t--disabled-note-primary: #c9c9c9;\r\n\t\t\t--disabled-note-secondary: #616161;\r\n\t\t}`,\r\n\r\n\t\t\"moonlight\": `\r\n\t\t\t:root {\r\n\t\t\t--page-margin: #020514;\r\n\t\t\t--editor-background: #020514;\r\n\t\t\t--hover-preview: white;\r\n\t\t\t--playhead: white;\r\n\t\t\t--primary-text: #D4DCE9;\r\n\t\t\t--secondary-text: #3E87DA;\r\n\t\t\t--inverted-text: black;\r\n\t\t\t--text-selection: #03599bd9;\r\n\t\t\t--box-selection-fill: hsl(206deg 66% 41% / 85%);\r\n\t\t\t--loop-accent: #639BD6;\r\n\t\t\t--link-accent: #A8C6E8;\r\n\t\t\t--ui-widget-background: #1e2940;\r\n\t\t\t--ui-widget-focus: #324b81;\r\n\t\t\t--pitch-background: #223849;\r\n\t\t\t--tonic: #33536c;\r\n\t\t\t--fifth-note: hsl(206deg 36% 16%);\r\n\t\t\t--white-piano-key: #c1bfe9;\r\n\t\t\t--black-piano-key: #454354;\r\n\t\t\t--use-color-formula: false;\r\n\t\t\t--track-editor-bg-pitch: #25568d80;\r\n\t\t\t--track-editor-bg-pitch-dim: #10253c80;\r\n\t\t\t--track-editor-bg-noise: #25568d80;\r\n\t\t\t--track-editor-bg-noise-dim: #10253c80;\r\n\t\t\t--track-editor-bg-mod: #25568d80;\r\n\t\t\t--track-editor-bg-mod-dim: #10253c80;\r\n\t\t\t--multiplicative-mod-slider: #0476cd;\r\n\t\t\t--overwriting-mod-slider: #035899;\r\n\t\t\t--indicator-primary: #57a1f4;\r\n\t\t\t--indicator-secondary: #2e5684;\r\n\t\t\t--select2-opt-group: #24355c;\r\n\t\t\t--input-box-outline: #141e34;\r\n\t\t\t--mute-button-normal: #6ebffc;\r\n\t\t\t--mute-button-mod: #0a92fa;\r\n\t\t\t--pitch1-secondary-channel: #47425c;\r\n\t\t\t--pitch1-primary-channel: #918bac;\r\n\t\t\t--pitch1-secondary-note: #6b6489;\r\n\t\t\t--pitch1-primary-note: #a8a3bf;\r\n\t\t\t--pitch2-secondary-channel: #626493;\r\n\t\t\t--pitch2-primary-channel: #bdbed3;\r\n\t\t\t--pitch2-secondary-note: #626493;\r\n\t\t\t--pitch2-primary-note: #bdbed3;\r\n\t\t\t--pitch3-secondary-channel: #6e89b4;\r\n\t\t\t--pitch3-primary-channel: #d4dce9;\r\n\t\t\t--pitch3-secondary-note: #6e89b4;\r\n\t\t\t--pitch3-primary-note: #d4dce9;\r\n\t\t\t--pitch4-secondary-channel: #4c77a9;\r\n\t\t\t--pitch4-primary-channel: #a8c6e8;\r\n\t\t\t--pitch4-secondary-note: #4c77a9;\r\n\t\t\t--pitch4-primary-note: #a8c6e8;\r\n\t\t\t--pitch5-secondary-channel: #314e6d;\r\n\t\t\t--pitch5-primary-channel: #639bd6;\r\n\t\t\t--pitch5-secondary-note: #46698f;\r\n\t\t\t--pitch5-primary-note: #639bd6;\r\n\t\t\t--pitch6-secondary-channel: #143d6b;\r\n\t\t\t--pitch6-primary-channel: #3e87da;\r\n\t\t\t--pitch6-secondary-note: #143d6b;\r\n\t\t\t--pitch6-primary-note: #3e87da;\r\n\t\t\t--pitch7-secondary-channel: #314e6d;\r\n\t\t\t--pitch7-primary-channel: #639bd6;\r\n\t\t\t--pitch7-secondary-note: #314e6d;\r\n\t\t\t--pitch7-primary-note: #639bd6;\r\n\t\t\t--pitch8-secondary-channel: #4c77a9;\r\n\t\t\t--pitch8-primary-channel: #a8c6e8;\r\n\t\t\t--pitch8-secondary-note: #4c77a9;\r\n\t\t\t--pitch8-primary-note: #a8c6e8;\r\n\t\t\t--pitch9-secondary-channel: #6e89b4;\r\n\t\t\t--pitch9-primary-channel: #d4dce9;\r\n\t\t\t--pitch9-secondary-note: #6e89b4;\r\n\t\t\t--pitch9-primary-note: #d4dce9;\r\n\t\t\t--pitch10-secondary-channel: #626493;\r\n\t\t\t--pitch10-primary-channel: #bdbed3;\r\n\t\t\t--pitch10-secondary-note: #626493;\r\n\t\t\t--pitch10-primary-note: #bdbed3;\r\n\t\t\t--noise1-secondary-channel: #4b4a55;\r\n\t\t\t--noise1-primary-channel: #9795a3;\r\n\t\t\t--noise1-secondary-note: #4b4a55;\r\n\t\t\t--noise1-primary-note: #9795a3;\r\n\t\t\t--noise2-secondary-channel: #858e9d;\r\n\t\t\t--noise2-primary-channel: #d7dce5;\r\n\t\t\t--noise2-secondary-note: #858e9d;\r\n\t\t\t--noise2-primary-note: #d7dce5;\r\n\t\t\t--noise3-secondary-channel: #394e65;\r\n\t\t\t--noise3-primary-channel: #809bb7;\r\n\t\t\t--noise3-secondary-note: #394e65;\r\n\t\t\t--noise3-primary-note: #809bb7;\r\n\t\t\t--noise4-secondary-channel: #37577b;\r\n\t\t\t--noise4-primary-channel: #6189b8;\r\n\t\t\t--noise4-secondary-note: #37577b;\r\n\t\t\t--noise4-primary-note: #6189b8;\r\n\t\t\t--noise5-secondary-channel: #223849;\r\n\t\t\t--noise5-primary-channel: #5588af;\r\n\t\t\t--noise5-secondary-note: #223849;\r\n\t\t\t--noise5-primary-note: #5588af;\r\n\t\t\t--mod1-secondary-channel: #3e336c;\r\n\t\t\t--mod1-primary-channel: #6d60a4;\r\n\t\t\t--mod1-secondary-note: #3e336c;\r\n\t\t\t--mod1-primary-note: #6d60a4;\r\n\t\t\t--mod2-secondary-channel: #716791;\r\n\t\t\t--mod2-primary-channel: #bdbed3;\r\n\t\t\t--mod2-secondary-note: #716791;\r\n\t\t\t--mod2-primary-note: #bdbed3;\r\n\t\t\t--mod3-secondary-channel: #6b91bd;\r\n\t\t\t--mod3-primary-channel: #4b8fdd;\r\n\t\t\t--mod3-secondary-note: #597ca7;\r\n\t\t\t--mod3-primary-note: #7eade3;\r\n\t\t\t--mod4-secondary-channel: #14559f;\r\n\t\t\t--mod4-primary-channel: #3386e6;\r\n\t\t\t--mod4-secondary-note: #14559f;\r\n\t\t\t--mod4-primary-note: #3386e6;\r\n\t\t\t--mod-label-primary: #1e2940;\r\n\t\t\t--mod-label-secondary-text: #748ebe;\r\n\t\t\t--mod-label-primary-text: white;\r\n\t\t\t--disabled-note-primary: #828282;\r\n\t\t\t--disabled-note-secondary: #4f4f4f;\r\n\t\t\t}`,\r\n\r\n\t\t\"autumn\": `\r\n\t\t:root {\r\n\t\t\t--page-margin: #060304;\r\n\t\t\t--editor-background: #060304;\r\n\t\t\t--hover-preview: white;\r\n\t\t\t--playhead: white;\r\n\t\t\t--primary-text: white;\r\n\t\t\t--secondary-text: #999;\r\n\t\t\t--inverted-text: black;\r\n\t\t\t--text-selection: rgb(115 80 76);\r\n\t\t\t--box-selection-fill: rgb(174 73 81 / 45%);\r\n\t\t\t--loop-accent: #834A69;\r\n\t\t\t--link-accent: #98f;\r\n\t\t\t--ui-widget-background: #2a2523;\r\n\t\t\t--ui-widget-focus: #4e4c44;\r\n\t\t\t--pitch-background: #121212;\r\n\t\t\t--tonic: #4f4f4f;\r\n\t\t\t--fifth-note: #222;\r\n\t\t\t--white-piano-key: #b59b9b;\r\n\t\t\t--black-piano-key: #231e1e;\r\n\t\t\t--use-color-formula: false;\r\n\t\t\t--track-editor-bg-pitch: #352f38;\r\n\t\t\t--track-editor-bg-pitch-dim: #232025;\r\n\t\t\t--track-editor-bg-noise: #3c3029;\r\n\t\t\t--track-editor-bg-noise-dim: #251d19;\r\n\t\t\t--track-editor-bg-mod: #202623;\r\n\t\t\t--track-editor-bg-mod-dim: #131715;\r\n\t\t\t--multiplicative-mod-slider: #D9D16E;\r\n\t\t\t--overwriting-mod-slider: #2D826F;\r\n\t\t\t--indicator-primary: #D9D16E;\r\n\t\t\t--indicator-secondary: #444226;\r\n\t\t\t--select2-opt-group: #20191c;\r\n\t\t\t--input-box-outline: #20191c;\r\n\t\t\t--mute-button-normal: var(--pitch2-primary-channel);\r\n\t\t\t--mute-button-mod: var(--pitch4-primary-channel);\r\n\t\t\t--pitch1-secondary-channel: #704a34;\r\n\t\t\t--pitch1-primary-channel: #D9895A;\r\n\t\t\t--pitch1-secondary-note: #704a34;\r\n\t\t\t--pitch1-primary-note: #D9895A;\r\n\t\t\t--pitch2-secondary-channel: #5f3538;\r\n\t\t\t--pitch2-primary-channel: #AE4951;\r\n\t\t\t--pitch2-secondary-note: #5f3538;\r\n\t\t\t--pitch2-primary-note: #AE4951;\r\n\t\t\t--pitch3-secondary-channel: #5c4336;\r\n\t\t\t--pitch3-primary-channel: #CA9A81;\r\n\t\t\t--pitch3-secondary-note: #5c4336;\r\n\t\t\t--pitch3-primary-note: #CA9A81;\r\n\t\t\t--pitch4-secondary-channel: #1d3143;\r\n\t\t\t--pitch4-primary-channel: #386995;\r\n\t\t\t--pitch4-secondary-note: #1d3143;\r\n\t\t\t--pitch4-primary-note: #386995;\r\n\t\t\t--pitch5-secondary-channel: #9c8a58;\r\n\t\t\t--pitch5-primary-channel: #D9D16E;\r\n\t\t\t--pitch5-secondary-note: #7c783f;\r\n\t\t\t--pitch5-primary-note: #D9D16E;\r\n\t\t\t--pitch6-secondary-channel: #886562;\r\n\t\t\t--pitch6-primary-channel: #D3A9A5;\r\n\t\t\t--pitch6-secondary-note: #886562;\r\n\t\t\t--pitch6-primary-note: #D3A9A5;\r\n\t\t\t--pitch7-secondary-channel: #1c3f37;\r\n\t\t\t--pitch7-primary-channel: #2D826F;\r\n\t\t\t--pitch7-secondary-note: #1c3f37;\r\n\t\t\t--pitch7-primary-note: #2D826F;\r\n\t\t\t--pitch8-secondary-channel: #442e2d;\r\n\t\t\t--pitch8-primary-channel: #815150;\r\n\t\t\t--pitch8-secondary-note: #442e2d;\r\n\t\t\t--pitch8-primary-note: #815150;\r\n\t\t\t--pitch9-secondary-channel: #8e6f60;\r\n\t\t\t--pitch9-primary-channel: #E5B8A1;\r\n\t\t\t--pitch9-secondary-note: #8e6f60;\r\n\t\t\t--pitch9-primary-note: #E5B8A1;\r\n\t\t\t--pitch10-secondary-channel: #4f3142;\r\n\t\t\t--pitch10-primary-channel: #834A69;\r\n\t\t\t--pitch10-secondary-note: #4f3142;\r\n\t\t\t--pitch10-primary-note: #834A69;\r\n\t\t\t--noise1-secondary-channel: #6b5346;\r\n\t\t\t--noise1-primary-channel: #b99c89;\r\n\t\t\t--noise1-secondary-note: #6b5346;\r\n\t\t\t--noise1-primary-note: #F0D0BB;\r\n\t\t\t--noise2-secondary-channel: #4a3839;\r\n\t\t\t--noise2-primary-channel: #9c6b6e;\r\n\t\t\t--noise2-secondary-note: #4a3839;\r\n\t\t\t--noise2-primary-note: #c18b8f;\r\n\t\t\t--noise3-secondary-channel: #2d3c4a;\r\n\t\t\t--noise3-primary-channel: #536e86;\r\n\t\t\t--noise3-secondary-note: #2d3c4a;\r\n\t\t\t--noise3-primary-note: #8fa8c0;\r\n\t\t\t--noise4-secondary-channel: #273f3a;\r\n\t\t\t--noise4-primary-channel: #4e8377;\r\n\t\t\t--noise4-secondary-note: #273f3a;\r\n\t\t\t--noise4-primary-note: #87baae;\r\n\t\t\t--noise5-secondary-channel: #372730;\r\n\t\t\t--noise5-primary-channel: #7f5e70;\r\n\t\t\t--noise5-secondary-note: #372730;\r\n\t\t\t--noise5-primary-note: #cc96b3;\r\n\t\t\t--mod1-secondary-channel: #783f1f;\r\n\t\t\t--mod1-primary-channel: #dc6d2c;\r\n\t\t\t--mod1-secondary-note: #783f1f;\r\n\t\t\t--mod1-primary-note: #dc6d2c;\r\n\t\t\t--mod2-secondary-channel: #0b3153;\r\n\t\t\t--mod2-primary-channel: #1464ac;\r\n\t\t\t--mod2-secondary-note: #0b3153;\r\n\t\t\t--mod2-primary-note: #1464ac;\r\n\t\t\t--mod3-secondary-channel: #075040;\r\n\t\t\t--mod3-primary-channel: #08a17f;\r\n\t\t\t--mod3-secondary-note: #075040;\r\n\t\t\t--mod3-primary-note: #08a17f;\r\n\t\t\t--mod4-secondary-channel: #631640;\r\n\t\t\t--mod4-primary-channel: #b4186d;\r\n\t\t\t--mod4-secondary-note: #631640;\r\n\t\t\t--mod4-primary-note: #b4186d;\r\n\t\t\t--mod-label-primary: #000;\r\n\t\t\t--mod-label-secondary-text: #707070;\r\n\t\t\t--mod-label-primary-text: white;\r\n\t\t\t--disabled-note-primary: #5d5d5d;\r\n\t\t\t--disabled-note-secondary: #292929;\r\n\t\t}`,\r\n\r\n\t\t\"fruit\": `\r\n\t\t:root {\r\n\t\t\t--page-margin: #040507;\r\n\t\t\t--editor-background: #040507;\r\n\t\t\t--hover-preview: white;\r\n\t\t\t--playhead: white;\r\n\t\t\t--primary-text: white;\r\n\t\t\t--secondary-text: #999;\r\n\t\t\t--inverted-text: black;\r\n\t\t\t--text-selection: rgb(115 103 76);\r\n\t\t\t--box-selection-fill: rgb(174 109 73 / 45%);\r\n\t\t\t--loop-accent: #EC897D;\r\n\t\t\t--link-accent: #FDE484;\r\n\t\t\t--ui-widget-background: #22222c;\r\n\t\t\t--ui-widget-focus: #39394c;\r\n\t\t\t--pitch-background: #101010;\r\n\t\t\t--tonic: #2c2d34;\r\n\t\t\t--fifth-note: #191a20;\r\n\t\t\t--white-piano-key: #bbbaba;\r\n\t\t\t--black-piano-key: #2d2d2d;\r\n\t\t\t--use-color-formula: false;\r\n\t\t\t--track-editor-bg-pitch: #2b2d40;\r\n\t\t\t--track-editor-bg-pitch-dim: #191a25;\r\n\t\t\t--track-editor-bg-noise: #3c3644;\r\n\t\t\t--track-editor-bg-noise-dim: #26222b;\r\n\t\t\t--track-editor-bg-mod: #322a2a;\r\n\t\t\t--track-editor-bg-mod-dim: #191515;\r\n\t\t\t--multiplicative-mod-slider: #977da9;\r\n\t\t\t--overwriting-mod-slider: #798FA7;\r\n\t\t\t--indicator-primary: #EAAC9D;\r\n\t\t\t--indicator-secondary: #5e413a;\r\n\t\t\t--select2-opt-group: #191920;\r\n\t\t\t--input-box-outline: #191920;\r\n\t\t\t--mute-button-normal: #798FA7;\r\n\t\t\t--mute-button-mod: #354457;\r\n\t\t\t--pitch1-secondary-channel: #91655a;\r\n\t\t\t--pitch1-primary-channel: #EAAC9D;\r\n\t\t\t--pitch1-secondary-note: #91655a;\r\n\t\t\t--pitch1-primary-note: #EAAC9D;\r\n\t\t\t--pitch2-secondary-channel: #8f6513;\r\n\t\t\t--pitch2-primary-channel: #FFAF12;\r\n\t\t\t--pitch2-secondary-note: #8f6513;\r\n\t\t\t--pitch2-primary-note: #FFAF12;\r\n\t\t\t--pitch3-secondary-channel: #212f46;\r\n\t\t\t--pitch3-primary-channel: #34558B;\r\n\t\t\t--pitch3-secondary-note: #212f46;\r\n\t\t\t--pitch3-primary-note: #34558B;\r\n\t\t\t--pitch4-secondary-channel: #2e6b5b;\r\n\t\t\t--pitch4-primary-channel: #4EC5A7;\r\n\t\t\t--pitch4-secondary-note: #2e6b5b;\r\n\t\t\t--pitch4-primary-note: #4EC5A7;\r\n\t\t\t--pitch5-secondary-channel: #555D46;\r\n\t\t\t--pitch5-primary-channel: #aabf84;\r\n\t\t\t--pitch5-secondary-note: #555D46;\r\n\t\t\t--pitch5-primary-note: #aabf84;\r\n\t\t\t--pitch6-secondary-channel: #A2553B;\r\n\t\t\t--pitch6-primary-channel: #e59a81;\r\n\t\t\t--pitch6-secondary-note: #A2553B;\r\n\t\t\t--pitch6-primary-note: #e59a81;\r\n\t\t\t--pitch7-secondary-channel: #7b4021;\r\n\t\t\t--pitch7-primary-channel: #FE813E;\r\n\t\t\t--pitch7-secondary-note: #7b4021;\r\n\t\t\t--pitch7-primary-note: #FE813E;\r\n\t\t\t--pitch8-secondary-channel: #847753;\r\n\t\t\t--pitch8-primary-channel: #EFDAA3;\r\n\t\t\t--pitch8-secondary-note: #847753;\r\n\t\t\t--pitch8-primary-note: #EFDAA3;\r\n\t\t\t--pitch9-secondary-channel: #2c3642;\r\n\t\t\t--pitch9-primary-channel: #798FA7;\r\n\t\t\t--pitch9-secondary-note: #2c3642;\r\n\t\t\t--pitch9-primary-note: #798FA7;\r\n\t\t\t--pitch10-secondary-channel: #0d4453;\r\n\t\t\t--pitch10-primary-channel: #107895;\r\n\t\t\t--pitch10-secondary-note: #0d4453;\r\n\t\t\t--pitch10-primary-note: #107895;\r\n\t\t\t--noise1-secondary-channel: #71617C;\r\n\t\t\t--noise1-primary-channel: #977da9;\r\n\t\t\t--noise1-secondary-note: #71617C;\r\n\t\t\t--noise1-primary-note: #977da9;\r\n\t\t\t--noise2-secondary-channel: #3B3D4A;\r\n\t\t\t--noise2-primary-channel: #707591;\r\n\t\t\t--noise2-secondary-note: #3B3D4A;\r\n\t\t\t--noise2-primary-note: #707591;\r\n\t\t\t--noise3-secondary-channel: #625f5e;\r\n\t\t\t--noise3-primary-channel: #A19D9C;\r\n\t\t\t--noise3-secondary-note: #625f5e;\r\n\t\t\t--noise3-primary-note: #A19D9C;\r\n\t\t\t--noise4-secondary-channel: #ab847b;\r\n\t\t\t--noise4-primary-channel: #EAAC9D;\r\n\t\t\t--noise4-secondary-note: #ab847b;\r\n\t\t\t--noise4-primary-note: #EAAC9D;\r\n\t\t\t--noise5-secondary-channel: #B49D74;\r\n\t\t\t--noise5-primary-channel: #dec69b;\r\n\t\t\t--noise5-secondary-note: #B49D74;\r\n\t\t\t--noise5-primary-note: #dec69b;\r\n\t\t\t--mod1-secondary-channel: #722124;\r\n\t\t\t--mod1-primary-channel: #D13A41;\r\n\t\t\t--mod1-secondary-note: #722124;\r\n\t\t\t--mod1-primary-note: #D13A41;\r\n\t\t\t--mod2-secondary-channel: #213657;\r\n\t\t\t--mod2-primary-channel: #34558B;\r\n\t\t\t--mod2-secondary-note: #213657;\r\n\t\t\t--mod2-primary-note: #34558B;\r\n\t\t\t--mod3-secondary-channel: #555D46;\r\n\t\t\t--mod3-primary-channel: #848f6d;\r\n\t\t\t--mod3-secondary-note: #555D46;\r\n\t\t\t--mod3-primary-note: #848f6d;\r\n\t\t\t--mod4-secondary-channel: #71617C;\r\n\t\t\t--mod4-primary-channel: #a68ab9;\r\n\t\t\t--mod4-secondary-note: #71617C;\r\n\t\t\t--mod4-primary-note: #a68ab9;\r\n\t\t\t--mod-label-primary: #282828;\r\n\t\t\t--mod-label-secondary-text: #707070;\r\n\t\t\t--mod-label-primary-text: white;\r\n\t\t\t--disabled-note-primary: #5d5d5d;\r\n\t\t\t--disabled-note-secondary: #292929;\r\n\t\t}`,\r\n\r\n\t\t\"sunset\": `\r\n\t\t:root {\r\n\t\t\t--page-margin: #040300;\r\n\t\t\t--editor-background: #040300;\r\n\t\t\t--hover-preview: white;\r\n\t\t\t--playhead: white;\r\n\t\t\t--primary-text: white;\r\n\t\t\t--secondary-text: #999;\r\n\t\t\t--inverted-text: black;\r\n\t\t\t--text-selection: rgb(94 0 157);\r\n\t\t\t--box-selection-fill: rgb(174 173 73 / 45%);\r\n\t\t\t--loop-accent: #EC897D;\r\n\t\t\t--link-accent: #FDE484;\r\n\t\t\t--ui-widget-background: #241b24;\r\n\t\t\t--ui-widget-focus: #3a2e39;\r\n\t\t\t--pitch-background: #141414;\r\n\t\t\t--tonic: #2C212B;\r\n\t\t\t--fifth-note: #2E2A15;\r\n\t\t\t--white-piano-key: #bbbaba;\r\n\t\t\t--black-piano-key: #2d2d2d;\r\n\t\t\t--use-color-formula: false;\r\n\t\t\t--track-editor-bg-pitch: #2d2e42;\r\n\t\t\t--track-editor-bg-pitch-dim: #191a25;\r\n\t\t\t--track-editor-bg-noise: #393340;\r\n\t\t\t--track-editor-bg-noise-dim: #26222b;\r\n\t\t\t--track-editor-bg-mod: #232a2c;\r\n\t\t\t--track-editor-bg-mod-dim: #151819;\r\n\t\t\t--multiplicative-mod-slider: #977da9;\r\n\t\t\t--overwriting-mod-slider: #798FA7;\r\n\t\t\t--indicator-primary: #F28891;\r\n\t\t\t--indicator-secondary: #601d23;\r\n\t\t\t--select2-opt-group: #151015;\r\n\t\t\t--input-box-outline: #151015;\r\n\t\t\t--mute-button-normal: #E4739D;\r\n\t\t\t--mute-button-mod: #9650A6;\r\n\t\t\t--pitch1-secondary-channel: #7F7721;\r\n\t\t\t--pitch1-primary-channel: #F3E79A;\r\n\t\t\t--pitch1-secondary-note: #7F7721;\r\n\t\t\t--pitch1-primary-note: #F3E79A;\r\n\t\t\t--pitch2-secondary-channel: #785E20;\r\n\t\t\t--pitch2-primary-channel: #F7D086;\r\n\t\t\t--pitch2-secondary-note: #785E20;\r\n\t\t\t--pitch2-primary-note: #F7D086;\r\n\t\t\t--pitch3-secondary-channel: #6E4219;\r\n\t\t\t--pitch3-primary-channel: #F9B881;\r\n\t\t\t--pitch3-secondary-note: #6E4219;\r\n\t\t\t--pitch3-primary-note: #F9B881;\r\n\t\t\t--pitch4-secondary-channel: #79351F;\r\n\t\t\t--pitch4-primary-channel: #F7A086;\r\n\t\t\t--pitch4-secondary-note: #79351F;\r\n\t\t\t--pitch4-primary-note: #F7A086;\r\n\t\t\t--pitch5-secondary-channel: #81272F;\r\n\t\t\t--pitch5-primary-channel: #F28891;\r\n\t\t\t--pitch5-secondary-note: #81272F;\r\n\t\t\t--pitch5-primary-note: #F28891;\r\n\t\t\t--pitch6-secondary-channel: #8F224D;\r\n\t\t\t--pitch6-primary-channel: #E4739D;\r\n\t\t\t--pitch6-secondary-note: #8F224D;\r\n\t\t\t--pitch6-primary-note: #E4739D;\r\n\t\t\t--pitch7-secondary-channel: #611548;\r\n\t\t\t--pitch7-primary-channel: #CF63A6;\r\n\t\t\t--pitch7-secondary-note: #611548;\r\n\t\t\t--pitch7-primary-note: #CF63A6;\r\n\t\t\t--pitch8-secondary-channel: #561253;\r\n\t\t\t--pitch8-primary-channel: #B557A9;\r\n\t\t\t--pitch8-secondary-note: #4D104A;\r\n\t\t\t--pitch8-primary-note: #B557A9;\r\n\t\t\t--pitch9-secondary-channel: #4c1260;\r\n\t\t\t--pitch9-primary-channel: #9650A6;\r\n\t\t\t--pitch9-secondary-note: #3C0F4C;\r\n\t\t\t--pitch9-primary-note: #9650A6;\r\n\t\t\t--pitch10-secondary-channel: #3e1d78;\r\n\t\t\t--pitch10-primary-channel: #704D9E;\r\n\t\t\t--pitch10-secondary-note: #27124C;\r\n\t\t\t--pitch10-primary-note: #704D9E;\r\n\t\t\t--noise1-secondary-channel: #A7A578;\r\n\t\t\t--noise1-primary-channel: #EFE9AC;\r\n\t\t\t--noise1-secondary-note: #A7A578;\r\n\t\t\t--noise1-primary-note: #EFE9AC;\r\n\t\t\t--noise2-secondary-channel: #947A5F;\r\n\t\t\t--noise2-primary-channel: #FBCEA8;\r\n\t\t\t--noise2-secondary-note: #947A5F;\r\n\t\t\t--noise2-primary-note: #FBCEA8;\r\n\t\t\t--noise3-secondary-channel: #A3635D;\r\n\t\t\t--noise3-primary-channel: #F4A5AB;\r\n\t\t\t--noise3-secondary-note: #A3635D;\r\n\t\t\t--noise3-primary-note: #F4A5AB;\r\n\t\t\t--noise4-secondary-channel: #724D60;\r\n\t\t\t--noise4-primary-channel: #CD90B6;\r\n\t\t\t--noise4-secondary-note: #724D60;\r\n\t\t\t--noise4-primary-note: #CD90B6;\r\n\t\t\t--noise5-secondary-channel: #503F5C;\r\n\t\t\t--noise5-primary-channel: #7C6A9E;\r\n\t\t\t--noise5-secondary-note: #503F5C;\r\n\t\t\t--noise5-primary-note: #7C6A9E;\r\n\t\t\t--mod1-secondary-channel: #371883;\r\n\t\t\t--mod1-primary-channel: #6416C6;\r\n\t\t\t--mod1-secondary-note: #1F0A52;\r\n\t\t\t--mod1-primary-note: #6416C6;\r\n\t\t\t--mod2-secondary-channel: #690645;\r\n\t\t\t--mod2-primary-channel: #E52FA2;\r\n\t\t\t--mod2-secondary-note: #690645;\r\n\t\t\t--mod2-primary-note: #E52FA2;\r\n\t\t\t--mod3-secondary-channel: #943618;\r\n\t\t\t--mod3-primary-channel: #eb5b2c;\r\n\t\t\t--mod3-secondary-note: #943618;\r\n\t\t\t--mod3-primary-note: #eb5b2c;\r\n\t\t\t--mod4-secondary-channel: #928409;\r\n\t\t\t--mod4-primary-channel: #ecd50e;\r\n\t\t\t--mod4-secondary-note: #928409;\r\n\t\t\t--mod4-primary-note: #ecd50e;\r\n\t\t\t--mod-label-primary: #282828;\r\n\t\t\t--mod-label-secondary-text: #707070;\r\n\t\t\t--mod-label-primary-text: white;\r\n\t\t\t--disabled-note-primary: #5d5d5d;\r\n\t\t\t--disabled-note-secondary: #292929;\r\n\t\t}`,\r\n\r\n\t\t\"toxic\": `\r\n\t\t:root {\r\n\t\t\t--page-margin: #010003;\r\n\t\t\t--editor-background: #010003;\r\n\t\t\t--hover-preview: white;\r\n\t\t\t--playhead: white;\r\n\t\t\t--primary-text: white;\r\n\t\t\t--secondary-text: #999;\r\n\t\t\t--inverted-text: black;\r\n\t\t\t--text-selection: rgb(147 195 0);\r\n\t\t\t--box-selection-fill: rgb(145 174 73 / 49%);\r\n\t\t\t--loop-accent: #BCDE2C;\r\n\t\t\t--link-accent: #edff9f;\r\n\t\t\t--ui-widget-background: #261e2e;\r\n\t\t\t--ui-widget-focus: #322042;\r\n\t\t\t--pitch-background: #141c15;\r\n\t\t\t--tonic: #282c21;\r\n\t\t\t--fifth-note: #18221a;\r\n\t\t\t--white-piano-key: #e3e3e3;\r\n\t\t\t--black-piano-key: #2d2d2d;\r\n\t\t\t--use-color-formula: false;\r\n\t\t\t--track-editor-bg-pitch: #38293e;\r\n\t\t\t--track-editor-bg-pitch-dim: #251c29;\r\n\t\t\t--track-editor-bg-noise: #2c304c;\r\n\t\t\t--track-editor-bg-noise-dim: #191b2b;\r\n\t\t\t--track-editor-bg-mod: #311b32;\r\n\t\t\t--track-editor-bg-mod-dim: #1d101e;\r\n\t\t\t--multiplicative-mod-slider: #977da9;\r\n\t\t\t--overwriting-mod-slider: #798FA7;\r\n\t\t\t--indicator-primary: #aae9ff;\r\n\t\t\t--indicator-secondary: #253e46;\r\n\t\t\t--select2-opt-group: #110d15;\r\n\t\t\t--input-box-outline: #110d15;\r\n\t\t\t--mute-button-normal: #8f5ad1;\r\n\t\t\t--mute-button-mod: #482574;\r\n\t\t\t--pitch1-secondary-channel: #6b7f19;\r\n\t\t\t--pitch1-primary-channel: #BCDE2C;\r\n\t\t\t--pitch1-secondary-note: #6b7f19;\r\n\t\t\t--pitch1-primary-note: #BCDE2C;\r\n\t\t\t--pitch2-secondary-channel: #497a31;\r\n\t\t\t--pitch2-primary-channel: #7BD152;\r\n\t\t\t--pitch2-secondary-note: #497a31;\r\n\t\t\t--pitch2-primary-note: #7BD152;\r\n\t\t\t--pitch3-secondary-channel: #286b40;\r\n\t\t\t--pitch3-primary-channel: #45BE71;\r\n\t\t\t--pitch3-secondary-note: #286b40;\r\n\t\t\t--pitch3-primary-note: #45BE71;\r\n\t\t\t--pitch4-secondary-channel: #125140;\r\n\t\t\t--pitch4-primary-channel: #25A884;\r\n\t\t\t--pitch4-secondary-note: #125140;\r\n\t\t\t--pitch4-primary-note: #25A884;\r\n\t\t\t--pitch5-secondary-channel: #114c49;\r\n\t\t\t--pitch5-primary-channel: #21908C;\r\n\t\t\t--pitch5-secondary-note: #114c49;\r\n\t\t\t--pitch5-primary-note: #21908C;\r\n\t\t\t--pitch6-secondary-channel: #143843;\r\n\t\t\t--pitch6-primary-channel: #2B788E;\r\n\t\t\t--pitch6-secondary-note: #143843;\r\n\t\t\t--pitch6-primary-note: #2B788E;\r\n\t\t\t--pitch7-secondary-channel: #1d354e;\r\n\t\t\t--pitch7-primary-channel: #355F8D;\r\n\t\t\t--pitch7-secondary-note: #1a2f46;\r\n\t\t\t--pitch7-primary-note: #355F8D;\r\n\t\t\t--pitch8-secondary-channel: #2c2e5a;\r\n\t\t\t--pitch8-primary-channel: #414486;\r\n\t\t\t--pitch8-secondary-note: #1e1f3d;\r\n\t\t\t--pitch8-primary-note: #414486;\r\n\t\t\t--pitch9-secondary-channel: #3c1f5e;\r\n\t\t\t--pitch9-primary-channel: #5e3b89;\r\n\t\t\t--pitch9-secondary-note: #25133b;\r\n\t\t\t--pitch9-primary-note: #5e3b89;\r\n\t\t\t--pitch10-secondary-channel: #510264;\r\n\t\t\t--pitch10-primary-channel: #720d8a;\r\n\t\t\t--pitch10-secondary-note: #440154;\r\n\t\t\t--pitch10-primary-note: #720d8a;\r\n\t\t\t--noise1-secondary-channel: #BCDE2C;\r\n\t\t\t--noise1-primary-channel: #edff9f;\r\n\t\t\t--noise1-secondary-note: #BCDE2C;\r\n\t\t\t--noise1-primary-note: #edff9f;\r\n\t\t\t--noise2-secondary-channel: #45BE71;\r\n\t\t\t--noise2-primary-channel: #89ffb4;\r\n\t\t\t--noise2-secondary-note: #45BE71;\r\n\t\t\t--noise2-primary-note: #89ffb4;\r\n\t\t\t--noise3-secondary-channel: #21908C;\r\n\t\t\t--noise3-primary-channel: #72fffa;\r\n\t\t\t--noise3-secondary-note: #21908C;\r\n\t\t\t--noise3-primary-note: #72fffa;\r\n\t\t\t--noise4-secondary-channel: #355F8D;\r\n\t\t\t--noise4-primary-channel: #7cb6f5;\r\n\t\t\t--noise4-secondary-note: #355F8D;\r\n\t\t\t--noise4-primary-note: #7cb6f5;\r\n\t\t\t--noise5-secondary-channel: #482574;\r\n\t\t\t--noise5-primary-channel: #8f5ad1;\r\n\t\t\t--noise5-secondary-note: #48257A;\r\n\t\t\t--noise5-primary-note: #8f5ad1;\r\n\t\t\t--mod1-secondary-channel: #815a16;\r\n\t\t\t--mod1-primary-channel: #F5AB29;\r\n\t\t\t--mod1-secondary-note: #815a16;\r\n\t\t\t--mod1-primary-note: #F5AB29;\r\n\t\t\t--mod2-secondary-channel: #4d341a;\r\n\t\t\t--mod2-primary-channel: #C98540;\r\n\t\t\t--mod2-secondary-note: #4d341a;\r\n\t\t\t--mod2-primary-note: #C98540;\r\n\t\t\t--mod3-secondary-channel: #643734;\r\n\t\t\t--mod3-primary-channel: #A75D58;\r\n\t\t\t--mod3-secondary-note: #643734;\r\n\t\t\t--mod3-primary-note: #A75D58;\r\n\t\t\t--mod4-secondary-channel: #461430;\r\n\t\t\t--mod4-primary-channel: #812359;\r\n\t\t\t--mod4-secondary-note: #3f112b;\r\n\t\t\t--mod4-primary-note: #812359;\r\n\t\t\t--mod-label-primary: #282828;\r\n\t\t\t--mod-label-secondary-text: #707070;\r\n\t\t\t--mod-label-primary-text: white;\r\n\t\t\t--disabled-note-primary: #5d5d5d;\r\n\t\t\t--disabled-note-secondary: #292929;\r\n\t\t}`,\r\n\r\n\t\t\"violet verdant\": `\r\n\t\t:root {\r\n\t\t\t--page-margin: #0e031a;\r\n\t\t\t--editor-background: #0e031a;\r\n\t\t\t--hover-preview: #e5ffea;\r\n\t\t\t--playhead: rgba(255, 255, 255, 0.9);\r\n\t\t\t--primary-text: #f0e0ff;\r\n\t\t\t--secondary-text: #706087;\r\n\t\t\t--inverted-text: black;\r\n\t\t\t--text-selection: rgba(119,68,255,0.99);\r\n\t\t\t--box-selection-fill: #225835;\r\n\t\t\t--loop-accent: #8f00fb;\r\n\t\t\t--link-accent: #82dd5d;\r\n\t\t\t--ui-widget-background: #303c66;\r\n\t\t\t--ui-widget-focus: #62559b;\r\n\t\t\t--pitch-background: #293b52;\r\n\t\t\t--tonic: #5b46ad;\r\n\t\t\t--fifth-note: #42604d;\r\n\t\t\t--white-piano-key: #f6e8ff;\r\n\t\t\t--black-piano-key: #5a4972;\r\n\t\t\t--use-color-formula: true;\r\n\t\t\t--track-editor-bg-pitch: #392a46;\r\n\t\t\t--track-editor-bg-pitch-dim: #1c1d28;\r\n\t\t\t--track-editor-bg-noise: #403150;\r\n\t\t\t--track-editor-bg-noise-dim: #161313;\r\n\t\t\t--track-editor-bg-mod: #253c25;\r\n\t\t\t--track-editor-bg-mod-dim: #0c1811;\r\n\t\t\t--multiplicative-mod-slider: #606c9f;\r\n\t\t\t--overwriting-mod-slider: #6850b5;\r\n\t\t\t--indicator-primary: #9c64f7;\r\n\t\t\t--indicator-secondary: #393e4f;\r\n\t\t\t--select2-opt-group: #5d576f;\r\n\t\t\t--input-box-outline: #403150;\r\n\t\t\t--mute-button-normal: #82dd5d;\r\n\t\t\t--mute-button-mod: #945de5;\r\n\t\t\t--mod-label-primary: #312840;\r\n\t\t\t--mod-label-secondary-text: rgb(88 70 104);\r\n\t\t\t--mod-label-primary-text: #82dd5d;\r\n\t\t\t--pitch-secondary-channel-hue: 64;\r\n\t\t\t--pitch-secondary-channel-hue-scale: 6.1;\r\n\t\t\t--pitch-secondary-channel-sat: 63.3;\r\n\t\t\t--pitch-secondary-channel-sat-scale: 0.1;\r\n\t\t\t--pitch-secondary-channel-lum: 40;\r\n\t\t\t--pitch-secondary-channel-lum-scale: 0.05;\r\n\t\t\t--pitch-primary-channel-hue: 64;\r\n\t\t\t--pitch-primary-channel-hue-scale: 6.1;\r\n\t\t\t--pitch-primary-channel-sat: 90;\r\n\t\t\t--pitch-primary-channel-sat-scale: 0.1;\r\n\t\t\t--pitch-primary-channel-lum: 67.5;\r\n\t\t\t--pitch-primary-channel-lum-scale: 0.05;\r\n\t\t\t--pitch-secondary-note-hue: 32;\r\n\t\t\t--pitch-secondary-note-hue-scale: 6.1;\r\n\t\t\t--pitch-secondary-note-sat: 87.9;\r\n\t\t\t--pitch-secondary-note-sat-scale: 0.1;\r\n\t\t\t--pitch-secondary-note-lum: 25;\r\n\t\t\t--pitch-secondary-note-lum-scale: 0.05;\r\n\t\t\t--pitch-primary-note-hue: 64;\r\n\t\t\t--pitch-primary-note-hue-scale: 6.1;\r\n\t\t\t--pitch-primary-note-sat: 90;\r\n\t\t\t--pitch-primary-note-sat-scale: 0.05;\r\n\t\t\t--pitch-primary-note-lum: 85.6;\r\n\t\t\t--pitch-primary-note-lum-scale: 0.025;\r\n\t\t\t--noise-secondary-channel-hue: 192;\r\n\t\t\t--noise-secondary-channel-hue-scale: 2;\r\n\t\t\t--noise-secondary-channel-sat: 45;\r\n\t\t\t--noise-secondary-channel-sat-scale: 0;\r\n\t\t\t--noise-secondary-channel-lum: 32;\r\n\t\t\t--noise-secondary-channel-lum-scale: 0;\r\n\t\t\t--noise-primary-channel-hue: 192;\r\n\t\t\t--noise-primary-channel-hue-scale: 2;\r\n\t\t\t--noise-primary-channel-sat: 33;\r\n\t\t\t--noise-primary-channel-sat-scale: 0;\r\n\t\t\t--noise-primary-channel-lum: 43.5;\r\n\t\t\t--noise-primary-channel-lum-scale: 0;\r\n\t\t\t--noise-secondary-note-hue: 160;\r\n\t\t\t--noise-secondary-note-hue-scale: 2;\r\n\t\t\t--noise-secondary-note-sat: 33.5;\r\n\t\t\t--noise-secondary-note-sat-scale: 0;\r\n\t\t\t--noise-secondary-note-lum: 45;\r\n\t\t\t--noise-secondary-note-lum-scale: 0;\r\n\t\t\t--noise-primary-note-hue: 192;\r\n\t\t\t--noise-primary-note-hue-scale: 2;\r\n\t\t\t--noise-primary-note-sat: 46.5;\r\n\t\t\t--noise-primary-note-sat-scale: 0;\r\n\t\t\t--noise-primary-note-lum: 74;\r\n\t\t\t--noise-primary-note-lum-scale: 0;\r\n\t\t\t--mod-secondary-channel-hue: 132;\r\n\t\t\t--mod-secondary-channel-hue-scale: 1.5;\r\n\t\t\t--mod-secondary-channel-sat: 88;\r\n\t\t\t--mod-secondary-channel-sat-scale: 0;\r\n\t\t\t--mod-secondary-channel-lum: 50;\r\n\t\t\t--mod-secondary-channel-lum-scale: 0;\r\n\t\t\t--mod-primary-channel-hue: 132;\r\n\t\t\t--mod-primary-channel-hue-scale: 1.5;\r\n\t\t\t--mod-primary-channel-sat: 96;\r\n\t\t\t--mod-primary-channel-sat-scale: 0;\r\n\t\t\t--mod-primary-channel-lum: 80;\r\n\t\t\t--mod-primary-channel-lum-scale: 0;\r\n\t\t\t--mod-secondary-note-hue: 100;\r\n\t\t\t--mod-secondary-note-hue-scale: 1.5;\r\n\t\t\t--mod-secondary-note-sat: 92;\r\n\t\t\t--mod-secondary-note-sat-scale: 0;\r\n\t\t\t--mod-secondary-note-lum: 45;\r\n\t\t\t--mod-secondary-note-lum-scale: 0;\r\n\t\t\t--mod-primary-note-hue: 132;\r\n\t\t\t--mod-primary-note-hue-scale: 1.5;\r\n\t\t\t--mod-primary-note-sat: 96;\r\n\t\t\t--mod-primary-note-sat-scale: 0;\r\n\t\t\t--mod-primary-note-lum: 85;\r\n\t\t\t--mod-primary-note-lum-scale: 0;\r\n\t\t\t--disabled-note-primary: #91879f;\r\n\t\t\t--disabled-note-secondary: #6a677a;\r\n\t\t}`,\r\n\r\n\t\t\"portal\": `\r\n\t\t:root {\r\n\t\t\t--page-margin: #04081a;\r\n\t\t\t--editor-background: #04081a;\r\n\t\t\t--hover-preview: white;\r\n\t\t\t--playhead: white;\r\n\t\t\t--primary-text: white;\r\n\t\t\t--secondary-text: #999;\r\n\t\t\t--inverted-text: black;\r\n\t\t\t--text-selection: rgba(119,68,255,0.99);\r\n\t\t\t--box-selection-fill: rgb(0 72 181);\r\n\t\t\t--loop-accent: #44d4ff;\r\n\t\t\t--link-accent: #ffa500;\r\n\t\t\t--ui-widget-background: #212c4a;\r\n\t\t\t--ui-widget-focus: #121f42;\r\n\t\t\t--pitch-background: #1b263e;\r\n\t\t\t--tonic: #995d00;\r\n\t\t\t--fifth-note: #0898a1;\r\n\t\t\t--white-piano-key: #ffffff;\r\n\t\t\t--black-piano-key: #516d7a;\r\n\t\t\t--use-color-formula: false;\r\n\t\t\t--track-editor-bg-pitch: #213352;\r\n\t\t\t--track-editor-bg-pitch-dim: #152032;\r\n\t\t\t--track-editor-bg-noise: #403524;\r\n\t\t\t--track-editor-bg-noise-dim: #2a1f0e;\r\n\t\t\t--track-editor-bg-mod: #234;\r\n\t\t\t--track-editor-bg-mod-dim: #123;\r\n\t\t\t--multiplicative-mod-slider: #456;\r\n\t\t\t--overwriting-mod-slider: #654;\r\n\t\t\t--indicator-primary: #5490ff;\r\n\t\t\t--indicator-secondary: #444;\r\n\t\t\t--select2-opt-group: #585858;\r\n\t\t\t--input-box-outline: #333;\r\n\t\t\t--mute-button-normal: #3372ff;\r\n\t\t\t--mute-button-mod: #dd872f;\r\n\t\t\t--pitch1-secondary-channel: #0099A1;\r\n\t\t\t--pitch1-primary-channel: #77f7ff;\r\n\t\t\t--pitch1-secondary-note: #00BDC7;\r\n\t\t\t--pitch1-primary-note: #92F9FF;\r\n\t\t\t--pitch2-secondary-channel: #0083a1;\r\n\t\t\t--pitch2-primary-channel: #35d9ff;\r\n\t\t\t--pitch2-secondary-note: #0083a1;\r\n\t\t\t--pitch2-primary-note: #a4eeff;\r\n\t\t\t--pitch3-secondary-channel: #0074c7;\r\n\t\t\t--pitch3-primary-channel: #3caeff;\r\n\t\t\t--pitch3-secondary-note: #00477a;\r\n\t\t\t--pitch3-primary-note: #aadcff;\r\n\t\t\t--pitch4-secondary-channel: #0039a1;\r\n\t\t\t--pitch4-primary-channel: #2673ff;\r\n\t\t\t--pitch4-secondary-note: #001f56;\r\n\t\t\t--pitch4-primary-note: #9bbeff;\r\n\t\t\t--pitch5-secondary-channel: #31148b;\r\n\t\t\t--pitch5-primary-channel: #7042ff;\r\n\t\t\t--pitch5-secondary-note: #190656;\r\n\t\t\t--pitch5-primary-note: #b79fff;\r\n\t\t\t--pitch6-secondary-channel: #979934;\r\n\t\t\t--pitch6-primary-channel: #fbff2f;\r\n\t\t\t--pitch6-secondary-note: #5d5e0a;\r\n\t\t\t--pitch6-primary-note: #fdff9a;\r\n\t\t\t--pitch7-secondary-channel: #b78f00;\r\n\t\t\t--pitch7-primary-channel: #ffd747;\r\n\t\t\t--pitch7-secondary-note: #5e3d00;\r\n\t\t\t--pitch7-primary-note: #ffe381;\r\n\t\t\t--pitch8-secondary-channel: #9d6500;\r\n\t\t\t--pitch8-primary-channel: #ffa400;\r\n\t\t\t--pitch8-secondary-note: #583900;\r\n\t\t\t--pitch8-primary-note: #ffd07c;\r\n\t\t\t--pitch9-secondary-channel: #744203;\r\n\t\t\t--pitch9-primary-channel: #ff8e00;\r\n\t\t\t--pitch9-secondary-note: #502d00;\r\n\t\t\t--pitch9-primary-note: #ffcb89;\r\n\t\t\t--pitch10-secondary-channel: #a32d00;\r\n\t\t\t--pitch10-primary-channel: #ff885b;\r\n\t\t\t--pitch10-secondary-note: #521700;\r\n\t\t\t--pitch10-primary-note: #ffb397;\r\n\t\t\t--noise1-secondary-channel: #6e2210;\r\n\t\t\t--noise1-primary-channel: #ff4600;\r\n\t\t\t--noise1-secondary-note: #4c1a08;\r\n\t\t\t--noise1-primary-note: #ffc9b4;\r\n\t\t\t--noise2-secondary-channel: #6a3110;\r\n\t\t\t--noise2-primary-channel: #ff782a;\r\n\t\t\t--noise2-secondary-note: #4c1f05;\r\n\t\t\t--noise2-primary-note: #ffb488;\r\n\t\t\t--noise3-secondary-channel: #72460e;\r\n\t\t\t--noise3-primary-channel: #d9871f;\r\n\t\t\t--noise3-secondary-note: #442905;\r\n\t\t\t--noise3-primary-note: #ffdcae;\r\n\t\t\t--noise4-secondary-channel: #837a0f;\r\n\t\t\t--noise4-primary-channel: #f7ea55;\r\n\t\t\t--noise4-secondary-note: #605906;\r\n\t\t\t--noise4-primary-note: #fff9ab;\r\n\t\t\t--noise5-secondary-channel: #8c8f00;\r\n\t\t\t--noise5-primary-channel: #fdff90;\r\n\t\t\t--noise5-secondary-note: #606200;\r\n\t\t\t--noise5-primary-note: #feffbc;\r\n\t\t\t--mod1-secondary-channel: #561b97;\r\n\t\t\t--mod1-primary-channel: #aa66f5;\r\n\t\t\t--mod1-secondary-note: #30075c;\r\n\t\t\t--mod1-primary-note: #cd9fff;\r\n\t\t\t--mod2-secondary-channel: #5116df;\r\n\t\t\t--mod2-primary-channel: #6b2dff;\r\n\t\t\t--mod2-secondary-note: #36138b;\r\n\t\t\t--mod2-primary-note: #bea3ff;\r\n\t\t\t--mod3-secondary-channel: #2535a1;\r\n\t\t\t--mod3-primary-channel: #3f57ff;\r\n\t\t\t--mod3-secondary-note: #0e185c;\r\n\t\t\t--mod3-primary-note: #8494ff;\r\n\t\t\t--mod4-secondary-channel: #1b5883;\r\n\t\t\t--mod4-primary-channel: #5eb7f5;\r\n\t\t\t--mod4-secondary-note: #072f4a;\r\n\t\t\t--mod4-primary-note: #63beff;\r\n\t\t\t--mod-label-primary: #24293a;\r\n\t\t\t--mod-label-secondary-text: #454d4e;\r\n\t\t\t--mod-label-primary-text: #7bd4ff;\r\n\t\t\t--disabled-note-primary: #072f4a;\r\n\t\t\t--disabled-note-secondary: #6585a7;\r\n\t\t}`,\r\n\r\n\t\t\"fusion\":\r\n\t\t`:root {\r\n\t\t\t--page-margin: #0c0306;\r\n\t\t\t--editor-background: #0c0306;\r\n\t\t\t--hover-preview: white;\r\n\t\t\t--playhead: white;\r\n\t\t\t--primary-text: #26d9cd;\r\n\t\t\t--secondary-text: #ff6666;\r\n\t\t\t--inverted-text: white;\r\n\t\t\t--text-selection: #ffffff;\r\n\t\t\t--box-selection-fill: #ff00004d;\r\n\t\t\t--loop-accent: #ff6666;\r\n\t\t\t--link-accent: white;\r\n\t\t\t--ui-widget-background: #232323;\r\n\t\t\t--ui-widget-focus: #303030;\r\n\t\t\t--pitch-background: hsl(61deg 100% 70% / 25%);\r\n\t\t\t--tonic: #66a3ff40;\r\n\t\t\t--fifth-note: #ff666640;\r\n\t\t\t--white-piano-key: #cdcdcd;\r\n\t\t\t--black-piano-key: #232323;\r\n\t\t\t--use-color-formula: false;\r\n\t\t\t--track-editor-bg-pitch: #404040bf;\r\n\t\t\t--track-editor-bg-pitch-dim: #151515;\r\n\t\t\t--track-editor-bg-noise: #404040bf;\r\n\t\t\t--track-editor-bg-noise-dim: #151515;\r\n\t\t\t--track-editor-bg-mod: #404040bf;\r\n\t\t\t--track-editor-bg-mod-dim: #151515;\r\n\t\t\t--multiplicative-mod-slider: #ef7692;\r\n\t\t\t--overwriting-mod-slider: #f43e69;\r\n\t\t\t--indicator-primary: #26d9cd;\r\n\t\t\t--indicator-secondary: hsl(176deg 70% 25%);\r\n\t\t\t--select2-opt-group: #232323;\r\n\t\t\t--input-box-outline: #141e34;\r\n\t\t\t--mute-button-normal: #26d9cd;\r\n\t\t\t--mute-button-mod: hsl(346deg 70% 50%);\r\n\t\t\t--pitch1-secondary-channel: #bf4040;\r\n\t\t\t--pitch1-primary-channel: #ff6666;\r\n\t\t\t--pitch1-secondary-note: #bf4040;\r\n\t\t\t--pitch1-primary-note: #ff6666;\r\n\t\t\t--pitch2-secondary-channel: #bf5b40;\r\n\t\t\t--pitch2-primary-channel: #ff8766;\r\n\t\t\t--pitch2-secondary-note: #bf5b40;\r\n\t\t\t--pitch2-primary-note: #ff8766;\r\n\t\t\t--pitch3-secondary-channel: #bf7940;\r\n\t\t\t--pitch3-primary-channel: #ffab66;\r\n\t\t\t--pitch3-secondary-note: #bf7940;\r\n\t\t\t--pitch3-primary-note: #ffab66;\r\n\t\t\t--pitch4-secondary-channel: #bf9b40;\r\n\t\t\t--pitch4-primary-channel: #ffd466;\r\n\t\t\t--pitch4-secondary-note: #bf9b40;\r\n\t\t\t--pitch4-primary-note: #ffd466;\r\n\t\t\t--pitch5-secondary-channel: #bdbf40;\r\n\t\t\t--pitch5-primary-channel: #fcff66;\r\n\t\t\t--pitch5-secondary-note: #bdbf40;\r\n\t\t\t--pitch5-primary-note: #fcff66;\r\n\t\t\t--pitch6-secondary-channel: #9dbf40;\r\n\t\t\t--pitch6-primary-channel: #d6ff66;\r\n\t\t\t--pitch6-secondary-note: #9dbf40;\r\n\t\t\t--pitch6-primary-note: #d6ff66;\r\n\t\t\t--pitch7-secondary-channel: #9dbf40;\r\n\t\t\t--pitch7-primary-channel: #fcff66;\r\n\t\t\t--pitch7-secondary-note: #9dbf40;\r\n\t\t\t--pitch7-primary-note: #fcff66;\r\n\t\t\t--pitch8-secondary-channel: #bf9b40;\r\n\t\t\t--pitch8-primary-channel: #ffd466;\r\n\t\t\t--pitch8-secondary-note: #bf9b40;\r\n\t\t\t--pitch8-primary-note: #ffd466;\r\n\t\t\t--pitch9-secondary-channel: #bf5b40;\r\n\t\t\t--pitch9-primary-channel: #ffab66;\r\n\t\t\t--pitch9-secondary-note: #bf5b40;\r\n\t\t\t--pitch9-primary-note: #ffab66;\r\n\t\t\t--pitch10-secondary-channel: #d15a1f;\r\n\t\t\t--pitch10-primary-channel: #ff8766;\r\n\t\t\t--pitch10-secondary-note: #d15a1f;\r\n\t\t\t--pitch10-primary-note: #ff8766;\r\n\t\t\t--noise1-secondary-channel: #4073bf;\r\n\t\t\t--noise1-primary-channel: #66a3ff;\r\n\t\t\t--noise1-secondary-note: #4073bf;\r\n\t\t\t--noise1-primary-note: #66a3ff;\r\n\t\t\t--noise2-secondary-channel: #405dbf;\r\n\t\t\t--noise2-primary-channel: #668aff;\r\n\t\t\t--noise2-secondary-note: #405dbf;\r\n\t\t\t--noise2-primary-note: #668aff;\r\n\t\t\t--noise3-secondary-channel: #4f40bf;\r\n\t\t\t--noise3-primary-channel: #7866ff;\r\n\t\t\t--noise3-secondary-note: #4f40bf;\r\n\t\t\t--noise3-primary-note: #7866ff;\r\n\t\t\t--noise4-secondary-channel: #8840bf;\r\n\t\t\t--noise4-primary-channel: #bd66ff;\r\n\t\t\t--noise4-secondary-note: #8840bf;\r\n\t\t\t--noise4-primary-note: #bd66ff;\r\n\t\t\t--noise5-secondary-channel: #bf40b5;\r\n\t\t\t--noise5-primary-channel: #ff66f2;\r\n\t\t\t--noise5-secondary-note: #bf40b5;\r\n\t\t\t--noise5-primary-note: #ff66f2;\r\n\t\t\t--mod1-secondary-channel: #cc6666;\r\n\t\t\t--mod1-primary-channel: #ff9999;\r\n\t\t\t--mod1-secondary-note: #cc6666;\r\n\t\t\t--mod1-primary-note: #ff9999;\r\n\t\t\t--mod2-secondary-channel: #cc7766;\r\n\t\t\t--mod2-primary-channel: #ffaa99;\r\n\t\t\t--mod2-secondary-note: #bf5540;\r\n\t\t\t--mod2-primary-note: #ffaa99;\r\n\t\t\t--mod3-secondary-channel: #cc8866;\r\n\t\t\t--mod3-primary-channel: #ffbb99;\r\n\t\t\t--mod3-secondary-note: #cc8866;\r\n\t\t\t--mod3-primary-note: #ffbb99;\r\n\t\t\t--mod4-secondary-channel: #cc9966;\r\n\t\t\t--mod4-primary-channel: #ffcc99;\r\n\t\t\t--mod4-secondary-note: #cc9966;\r\n\t\t\t--mod4-primary-note: #ffcc99;\r\n\t\t\t--mod-label-primary: #999;\r\n\t\t\t--mod-label-secondary-text: #333;\r\n\t\t\t--mod-label-primary-text: black;\r\n\t\t\t--disabled-note-primary: #696969;\r\n\t\t\t--disabled-note-secondary: #232323;\r\n\t\t}`,\r\n\r\n\t\t\"inverse\":\r\n\t\t\t`:root {\r\n\t\t\t--page-margin: #c4c8e3;\r\n\t\t\t--editor-background: #c4c8e3;\r\n\t\t\t--hover-preview: #000000;\r\n\t\t\t--playhead: #243953;\r\n\t\t\t--primary-text: black;\r\n\t\t\t--secondary-text: #855b95;\r\n\t\t\t--inverted-text: black;\r\n\t\t\t--text-selection: rgb(132 125 255);\r\n\t\t\t--box-selection-fill: rgb(174 109 73 / 65%);\r\n\t\t\t--loop-accent: #EC897D;\r\n\t\t\t--link-accent: #4e00c8;\r\n\t\t\t--ui-widget-background: #e7e7ff;\r\n\t\t\t--ui-widget-focus: #d0d3e9;\r\n\t\t\t--pitch-background: #ffffff;\r\n\t\t\t--tonic: #bbbbbb;\r\n\t\t\t--fifth-note: #dcdcdc;\r\n\t\t\t--white-piano-key: #ffffff;\r\n\t\t\t--black-piano-key: #615f66;\r\n\t\t\t--use-color-formula: false;\r\n\t\t\t--track-editor-bg-pitch: #e9ebff;\r\n\t\t\t--track-editor-bg-pitch-dim: #e9ebff;\r\n\t\t\t--track-editor-bg-noise: #fdf2fe;\r\n\t\t\t--track-editor-bg-noise-dim: #fdf2fe;\r\n\t\t\t--track-editor-bg-mod: #dbdefe;\r\n\t\t\t--track-editor-bg-mod-dim: #dbdefe;\r\n\t\t\t--multiplicative-mod-slider: #6900b3;\r\n\t\t\t--overwriting-mod-slider: #004b9d;\r\n\t\t\t--indicator-primary: #ff633d;\r\n\t\t\t--indicator-secondary: #933822;\r\n\t\t\t--select2-opt-group: #e7e7ff;\r\n\t\t\t--input-box-outline: #e7e7ff;\r\n\t\t\t--mute-button-normal: #0072ef;\r\n\t\t\t--mute-button-mod: #002e67;\r\n\t\t\t--pitch1-secondary-channel: #b77d6e;\r\n\t\t\t--pitch1-primary-channel: #ff9d85;\r\n\t\t\t--pitch1-secondary-note: #b77d6e;\r\n\t\t\t--pitch1-primary-note: #ff9d85;\r\n\t\t\t--pitch2-secondary-channel: #be8821;\r\n\t\t\t--pitch2-primary-channel: #FFAF12;\r\n\t\t\t--pitch2-secondary-note: #be8821;\r\n\t\t\t--pitch2-primary-note: #FFAF12;\r\n\t\t\t--pitch3-secondary-channel: #3a62a4;\r\n\t\t\t--pitch3-primary-channel: #528ae6;\r\n\t\t\t--pitch3-secondary-note: #3a62a4;\r\n\t\t\t--pitch3-primary-note: #528ae6;\r\n\t\t\t--pitch4-secondary-channel: #3e8d78;\r\n\t\t\t--pitch4-primary-channel: #4EC5A7;\r\n\t\t\t--pitch4-secondary-note: #3e8d78;\r\n\t\t\t--pitch4-primary-note: #4EC5A7;\r\n\t\t\t--pitch5-secondary-channel: #84906d;\r\n\t\t\t--pitch5-primary-channel: #aabf84;\r\n\t\t\t--pitch5-secondary-note: #84906d;\r\n\t\t\t--pitch5-primary-note: #aabf84;\r\n\t\t\t--pitch6-secondary-channel: #bd6345;\r\n\t\t\t--pitch6-primary-channel: #e59a81;\r\n\t\t\t--pitch6-secondary-note: #bd6345;\r\n\t\t\t--pitch6-primary-note: #e59a81;\r\n\t\t\t--pitch7-secondary-channel: #aa592f;\r\n\t\t\t--pitch7-primary-channel: #FE813E;\r\n\t\t\t--pitch7-secondary-note: #aa592f;\r\n\t\t\t--pitch7-primary-note: #FE813E;\r\n\t\t\t--pitch8-secondary-channel: #b2a171;\r\n\t\t\t--pitch8-primary-channel: #ffd76d;\r\n\t\t\t--pitch8-secondary-note: #b2a171;\r\n\t\t\t--pitch8-primary-note: #ffd76d;\r\n\t\t\t--pitch9-secondary-channel: #4f6177;\r\n\t\t\t--pitch9-primary-channel: #798FA7;\r\n\t\t\t--pitch9-secondary-note: #4f6177;\r\n\t\t\t--pitch9-primary-note: #798FA7;\r\n\t\t\t--pitch10-secondary-channel: #165162;\r\n\t\t\t--pitch10-primary-channel: #107895;\r\n\t\t\t--pitch10-secondary-note: #165162;\r\n\t\t\t--pitch10-primary-note: #107895;\r\n\t\t\t--noise1-secondary-channel: #71617C;\r\n\t\t\t--noise1-primary-channel: #977da9;\r\n\t\t\t--noise1-secondary-note: #71617C;\r\n\t\t\t--noise1-primary-note: #977da9;\r\n\t\t\t--noise2-secondary-channel: #4a4c5b;\r\n\t\t\t--noise2-primary-channel: #707591;\r\n\t\t\t--noise2-secondary-note: #4a4c5b;\r\n\t\t\t--noise2-primary-note: #707591;\r\n\t\t\t--noise3-secondary-channel: #817c7b;\r\n\t\t\t--noise3-primary-channel: #A19D9C;\r\n\t\t\t--noise3-secondary-note: #817c7b;\r\n\t\t\t--noise3-primary-note: #A19D9C;\r\n\t\t\t--noise4-secondary-channel: #ab847b;\r\n\t\t\t--noise4-primary-channel: #EAAC9D;\r\n\t\t\t--noise4-secondary-note: #ab847b;\r\n\t\t\t--noise4-primary-note: #EAAC9D;\r\n\t\t\t--noise5-secondary-channel: #B49D74;\r\n\t\t\t--noise5-primary-channel: #dec69b;\r\n\t\t\t--noise5-secondary-note: #B49D74;\r\n\t\t\t--noise5-primary-note: #dec69b;\r\n\t\t\t--mod1-secondary-channel: #722124;\r\n\t\t\t--mod1-primary-channel: #D13A41;\r\n\t\t\t--mod1-secondary-note: #722124;\r\n\t\t\t--mod1-primary-note: #D13A41;\r\n\t\t\t--mod2-secondary-channel: #213657;\r\n\t\t\t--mod2-primary-channel: #34558B;\r\n\t\t\t--mod2-secondary-note: #213657;\r\n\t\t\t--mod2-primary-note: #34558B;\r\n\t\t\t--mod3-secondary-channel: #555D46;\r\n\t\t\t--mod3-primary-channel: #848f6d;\r\n\t\t\t--mod3-secondary-note: #555D46;\r\n\t\t\t--mod3-primary-note: #848f6d;\r\n\t\t\t--mod4-secondary-channel: #71617C;\r\n\t\t\t--mod4-primary-channel: #a68ab9;\r\n\t\t\t--mod4-secondary-note: #71617C;\r\n\t\t\t--mod4-primary-note: #a68ab9;\r\n\t\t\t--mod-label-primary: #e9e9e9;\r\n\t\t\t--mod-label-secondary-text: #707070;\r\n\t\t\t--mod-label-primary-text: black;\r\n\t\t\t--disabled-note-primary: #959595;\r\n\t\t\t--disabled-note-secondary: #6e6e6e;\r\n\t\t\t}`,\r\n\r\n\t\t\"nebula\": `\r\n\t\t:root {\r\n\t\t\t--page-margin: #040410;\r\n\t\t\t--editor-background: #150e1f;\r\n\t\t\t--hover-preview: white;\r\n\t\t\t--playhead: rgba(255, 255, 255, 0.9);\r\n\t\t\t--primary-text: white;\r\n\t\t\t--secondary-text: #8C849A;\r\n\t\t\t--inverted-text: black;\r\n\t\t\t--text-selection: rgba(141,79,201,0.99);\r\n\t\t\t--box-selection-fill: #311E44;\r\n\t\t\t--loop-accent: #CC688C;\r\n\t\t\t--link-accent: #817DC9;\r\n\t\t\t--ui-widget-background: #44394F;\r\n\t\t\t--ui-widget-focus: #7A6386;\r\n\t\t\t--pitch-background: #393e4f40;\r\n\t\t\t--tonic: #7D5C9EC0;\r\n\t\t\t--fifth-note: #ab77bd50;\r\n\t\t\t--white-piano-key: #EEEEEE;\r\n\t\t\t--black-piano-key: #5F5566;\r\n\t\t\t--use-color-formula: true;\r\n\t\t\t--track-editor-bg-pitch: #46374C;\r\n\t\t\t--track-editor-bg-pitch-dim: #1F1C2850;\r\n\t\t\t--track-editor-bg-noise: #3D353B;\r\n\t\t\t--track-editor-bg-noise-dim: #16131550;\r\n\t\t\t--track-editor-bg-mod: #623F4C;\r\n\t\t\t--track-editor-bg-mod-dim: #361A2450;\r\n\t\t\t--multiplicative-mod-slider: #9F6E6A;\r\n\t\t\t--overwriting-mod-slider: #A664B5;\r\n\t\t\t--indicator-primary: #CC6B8E;\r\n\t\t\t--indicator-secondary: #44394F;\r\n\t\t\t--select2-opt-group: #6A576F;\r\n\t\t\t--input-box-outline: #222;\r\n\t\t\t--mute-button-normal: #BF91DC;\r\n\t\t\t--mute-button-mod: #DC8C9A;\r\n\t\t\t--mod-label-primary: #3A2840;\r\n\t\t\t--mod-label-secondary-text: #62485E;\r\n\t\t\t--mod-label-primary-text: white;\r\n\t\t\t--pitch-secondary-channel-hue: -96;\r\n\t\t\t--pitch-secondary-channel-hue-scale: 4.2;\r\n\t\t\t--pitch-secondary-channel-sat: 50.3;\r\n\t\t\t--pitch-secondary-channel-sat-scale: 0.1;\r\n\t\t\t--pitch-secondary-channel-lum: 40;\r\n\t\t\t--pitch-secondary-channel-lum-scale: 0.05;\r\n\t\t\t--pitch-primary-channel-hue: -96;\r\n\t\t\t--pitch-primary-channel-hue-scale: 4.2;\r\n\t\t\t--pitch-primary-channel-sat: 70;\r\n\t\t\t--pitch-primary-channel-sat-scale: 0.1;\r\n\t\t\t--pitch-primary-channel-lum: 67.5;\r\n\t\t\t--pitch-primary-channel-lum-scale: 0.05;\r\n\t\t\t--pitch-secondary-note-hue: -96;\r\n\t\t\t--pitch-secondary-note-hue-scale: 4.2;\r\n\t\t\t--pitch-secondary-note-sat: 70.9;\r\n\t\t\t--pitch-secondary-note-sat-scale: 0.1;\r\n\t\t\t--pitch-secondary-note-lum: 25;\r\n\t\t\t--pitch-secondary-note-lum-scale: 0.05;\r\n\t\t\t--pitch-primary-note-hue: -96;\r\n\t\t\t--pitch-primary-note-hue-scale: 4.2;\r\n\t\t\t--pitch-primary-note-sat: 90;\r\n\t\t\t--pitch-primary-note-sat-scale: 0.05;\r\n\t\t\t--pitch-primary-note-lum: 85.6;\r\n\t\t\t--pitch-primary-note-lum-scale: 0.025;\r\n\t\t\t--noise-secondary-channel-hue: 16;\r\n\t\t\t--noise-secondary-channel-hue-scale: -1.33;\r\n\t\t\t--noise-secondary-channel-sat: 25;\r\n\t\t\t--noise-secondary-channel-sat-scale: 0;\r\n\t\t\t--noise-secondary-channel-lum: 42;\r\n\t\t\t--noise-secondary-channel-lum-scale: 0;\r\n\t\t\t--noise-primary-channel-hue: 16;\r\n\t\t\t--noise-primary-channel-hue-scale: -1.33;\r\n\t\t\t--noise-primary-channel-sat: 33;\r\n\t\t\t--noise-primary-channel-sat-scale: 0;\r\n\t\t\t--noise-primary-channel-lum: 63.5;\r\n\t\t\t--noise-primary-channel-lum-scale: 0;\r\n\t\t\t--noise-secondary-note-hue: 12;\r\n\t\t\t--noise-secondary-note-hue-scale: -1.33;\r\n\t\t\t--noise-secondary-note-sat: 33.5;\r\n\t\t\t--noise-secondary-note-sat-scale: 0;\r\n\t\t\t--noise-secondary-note-lum: 55;\r\n\t\t\t--noise-secondary-note-lum-scale: 0;\r\n\t\t\t--noise-primary-note-hue: 12;\r\n\t\t\t--noise-primary-note-hue-scale: -1.33;\r\n\t\t\t--noise-primary-note-sat: 46.5;\r\n\t\t\t--noise-primary-note-sat-scale: 0;\r\n\t\t\t--noise-primary-note-lum: 74;\r\n\t\t\t--noise-primary-note-lum-scale: 0;\r\n\t\t\t--mod-secondary-channel-hue: 12;\r\n\t\t\t--mod-secondary-channel-hue-scale: -.75;\r\n\t\t\t--mod-secondary-channel-sat: 50;\r\n\t\t\t--mod-secondary-channel-sat-scale: 0;\r\n\t\t\t--mod-secondary-channel-lum: 50;\r\n\t\t\t--mod-secondary-channel-lum-scale: 0;\r\n\t\t\t--mod-primary-channel-hue: 12;\r\n\t\t\t--mod-primary-channel-hue-scale: -.75;\r\n\t\t\t--mod-primary-channel-sat: 70;\r\n\t\t\t--mod-primary-channel-sat-scale: 0;\r\n\t\t\t--mod-primary-channel-lum: 80;\r\n\t\t\t--mod-primary-channel-lum-scale: 0;\r\n\t\t\t--mod-secondary-note-hue: 12;\r\n\t\t\t--mod-secondary-note-hue-scale: -.75;\r\n\t\t\t--mod-secondary-note-sat: 75;\r\n\t\t\t--mod-secondary-note-sat-scale: 0;\r\n\t\t\t--mod-secondary-note-lum: 45;\r\n\t\t\t--mod-secondary-note-lum-scale: 0;\r\n\t\t\t--mod-primary-note-hue: 12;\r\n\t\t\t--mod-primary-note-hue-scale: -.75;\r\n\t\t\t--mod-primary-note-sat: 85;\r\n\t\t\t--mod-primary-note-sat-scale: 0;\r\n\t\t\t--mod-primary-note-lum: 85;\r\n\t\t\t--mod-primary-note-lum-scale: 0;\r\n\t\t\t--disabled-note-primary: #aaa;\r\n\t\t\t--disabled-note-secondary: #666;\r\n\t\t}`,\r\n\r\n\t\t\"roe light\": `\r\n\t\t:root {\r\n\t\t\t--page-margin: #fff5f5;\r\n\t\t\t--editor-background: #fff5f5;\r\n\t\t\t--hover-preview: #0e8bf1;\r\n\t\t\t--playhead: 000;\r\n\t\t\t--primary-text: #0e8bf1;\r\n\t\t\t--secondary-text: #f10e0e;\r\n\t\t\t--inverted-text: white;\r\n\t\t\t--text-selection: #ff4444fc;\r\n\t\t\t--box-selection-fill: #ff00004d;\r\n\t\t\t--loop-accent: #9a75ff;\r\n\t\t\t--link-accent: #ff7070;\r\n\t\t\t--ui-widget-background: #bdc9e5;\r\n\t\t\t--ui-widget-focus: #a3b7e5;\r\n\t\t\t--pitch-background: #d0c7db;\r\n\t\t\t--tonic: #bed3e4;\r\n\t\t\t--fifth-note: #e7c6c6;\r\n\t\t\t--white-piano-key: #cdcdcd;\r\n\t\t\t--black-piano-key: #232323;\r\n\t\t\t--use-color-formula: false;\r\n\t\t\t--track-editor-bg-pitch: #e5e1ea;\r\n\t\t\t--track-editor-bg-pitch-dim: #cbc4d4;\r\n\t\t\t--track-editor-bg-noise: #e0ddee;\r\n\t\t\t--track-editor-bg-noise-dim: #c1bade;\r\n\t\t\t--track-editor-bg-mod: #d8e6f3;\r\n\t\t\t--track-editor-bg-mod-dim: #b1cce7;\r\n\t\t\t--multiplicative-mod-slider: #8097cb;\r\n\t\t\t--overwriting-mod-slider: #8097cb;\r\n\t\t\t--indicator-primary: #FF2A2A;\r\n\t\t\t--indicator-secondary: #92a6d3;\r\n\t\t\t--select2-opt-group: #b6c4e2;\r\n\t\t\t--input-box-outline: #bdc9e5;\r\n\t\t\t--mute-button-normal: #66baff;\r\n\t\t\t--mute-button-mod: #1a98ff;\r\n\t\t\t--pitch1-secondary-channel: #273c90;\r\n\t\t\t--pitch1-primary-channel: #476BFF;\r\n\t\t\t--pitch1-secondary-note: #273c90;\r\n\t\t\t--pitch1-primary-note: #476BFF;\r\n\t\t\t--pitch2-secondary-channel: #3a3898;\r\n\t\t\t--pitch2-primary-channel: #625FFB;\r\n\t\t\t--pitch2-secondary-note: #3a3898;\r\n\t\t\t--pitch2-primary-note: #625FFB;\r\n\t\t\t--pitch3-secondary-channel: #542780;\r\n\t\t\t--pitch3-primary-channel: #9C49EC;\r\n\t\t\t--pitch3-secondary-note: #542780;\r\n\t\t\t--pitch3-primary-note: #9C49EC;\r\n\t\t\t--pitch4-secondary-channel: #84225d;\r\n\t\t\t--pitch4-primary-channel: #fd3fb1;\r\n\t\t\t--pitch4-secondary-note: #84225d;\r\n\t\t\t--pitch4-primary-note: #fd3fb1;\r\n\t\t\t--pitch5-secondary-channel: #8d2323;\r\n\t\t\t--pitch5-primary-channel: #ff3f3f;\r\n\t\t\t--pitch5-secondary-note: #8d2323;\r\n\t\t\t--pitch5-primary-note: #ff3f3f;\r\n\t\t\t--pitch6-secondary-channel: #84225d;\r\n\t\t\t--pitch6-primary-channel: #fd3fb1;\r\n\t\t\t--pitch6-secondary-note: #84225d;\r\n\t\t\t--pitch6-primary-note: #fd3fb1;\r\n\t\t\t--pitch7-secondary-channel: #542780;\r\n\t\t\t--pitch7-primary-channel: #9C49EC;\r\n\t\t\t--pitch7-secondary-note: #542780;\r\n\t\t\t--pitch7-primary-note: #9C49EC;\r\n\t\t\t--pitch8-secondary-channel: #3a3898;\r\n\t\t\t--pitch8-primary-channel: #625FFB;\r\n\t\t\t--pitch8-secondary-note: #3a3898;\r\n\t\t\t--pitch8-primary-note: #625FFB;\r\n\t\t\t--pitch9-secondary-channel: #273c90;\r\n\t\t\t--pitch9-primary-channel: #476BFF;\r\n\t\t\t--pitch9-secondary-note: #273c90;\r\n\t\t\t--pitch9-primary-note: #476BFF;\r\n\t\t\t--pitch10-secondary-channel: #165a93;\r\n\t\t\t--pitch10-primary-channel: #299EFF;\r\n\t\t\t--pitch10-secondary-note: #165a93;\r\n\t\t\t--pitch10-primary-note: #299EFF;\r\n\t\t\t--noise1-secondary-channel: #336bdb;\r\n\t\t\t--noise1-primary-channel: #4281FF;\r\n\t\t\t--noise1-secondary-note: #336bdb;\r\n\t\t\t--noise1-primary-note: #4281FF;\r\n\t\t\t--noise2-secondary-channel: #5e38dc;\r\n\t\t\t--noise2-primary-channel: #7347FF;\r\n\t\t\t--noise2-secondary-note: #5e38dc;\r\n\t\t\t--noise2-primary-note: #7347FF;\r\n\t\t\t--noise3-secondary-channel: #7d3097;\r\n\t\t\t--noise3-primary-channel: #9F3CBF;\r\n\t\t\t--noise3-secondary-note: #7d3097;\r\n\t\t\t--noise3-primary-note: #9F3CBF;\r\n\t\t\t--noise4-secondary-channel: #ad2559;\r\n\t\t\t--noise4-primary-channel: #D3326F;\r\n\t\t\t--noise4-secondary-note: #ad2559;\r\n\t\t\t--noise4-primary-note: #D3326F;\r\n\t\t\t--noise5-secondary-channel: #d02525;\r\n\t\t\t--noise5-primary-channel: #FF2A2A;\r\n\t\t\t--noise5-secondary-note: #d02525;\r\n\t\t\t--noise5-primary-note: #FF2A2A;\r\n\t\t\t--mod1-secondary-channel: #35415a;\r\n\t\t\t--mod1-primary-channel: #47587a;\r\n\t\t\t--mod1-secondary-note: #35415a;\r\n\t\t\t--mod1-primary-note: #47587a;\r\n\t\t\t--mod2-secondary-channel: #5a5374;\r\n\t\t\t--mod2-primary-channel: #716791;\r\n\t\t\t--mod2-secondary-note: #5a5374;\r\n\t\t\t--mod2-primary-note: #716791;\r\n\t\t\t--mod3-secondary-channel: #53385c;\r\n\t\t\t--mod3-primary-channel: #6f4c7b;\r\n\t\t\t--mod3-secondary-note: #53385c;\r\n\t\t\t--mod3-primary-note: #6f4c7b;\r\n\t\t\t--mod4-secondary-channel: #7e4e60;\r\n\t\t\t--mod4-primary-channel: #9e6279;\r\n\t\t\t--mod4-secondary-note: #7e4e60;\r\n\t\t\t--mod4-primary-note: #9e6279;\r\n\t\t\t--mod-label-primary: #d0c7db;\r\n\t\t\t--mod-label-secondary-text: #cb3434;\r\n\t\t\t--mod-label-primary-text: black;\r\n\t\t\t--disabled-note-primary: #616161;\r\n\t\t\t--disabled-note-secondary: #474747;\r\n\t\t}`,\r\n\r\n\t\t\"energized\": `\r\n\t\t:root {\r\n\t\t\t--page-margin: #000a08;\r\n\t\t\t--editor-background: #000a08;\r\n\t\t\t--hover-preview: #ffffcc;\r\n\t\t\t--playhead: #ccfff5;\r\n\t\t\t--primary-text: white;\r\n\t\t\t--secondary-text: #d9d98c;\r\n\t\t\t--inverted-text: black;\r\n\t\t\t--text-selection: #ffff6659;\r\n\t\t\t--box-selection-fill: #ffffff33;\r\n\t\t\t--loop-accent: #ffff00;\r\n\t\t\t--link-accent: #00ffcc;\r\n\t\t\t--ui-widget-background: #141f1d;\r\n\t\t\t--ui-widget-focus: #24423d;\r\n\t\t\t--pitch-background: #001410;\r\n\t\t\t--tonic: #00241d;\r\n\t\t\t--fifth-note: #ffff6633;\r\n\t\t\t--white-piano-key: #66998f;\r\n\t\t\t--black-piano-key: #141f1d;\r\n\t\t\t--use-color-formula: false;\r\n\t\t\t--track-editor-bg-pitch: #66998f40;\r\n\t\t\t--track-editor-bg-pitch-dim: #293d3940;\r\n\t\t\t--track-editor-bg-noise: #66998f40;\r\n\t\t\t--track-editor-bg-noise-dim: #293d3940;\r\n\t\t\t--track-editor-bg-mod: #99996640;\r\n\t\t\t--track-editor-bg-mod-dim: #3d3d2940;\r\n\t\t\t--multiplicative-mod-slider: #ffff00;\r\n\t\t\t--overwriting-mod-slider: #00ffcc;\r\n\t\t\t--indicator-primary: #ffff00;\r\n\t\t\t--indicator-secondary: #141f1d;\r\n\t\t\t--select2-opt-group: #1b312e;\r\n\t\t\t--input-box-outline: #141f1d;\r\n\t\t\t--mute-button-normal: #00ffcc;\r\n\t\t\t--mute-button-mod: #00997a;\r\n\t\t\t--pitch1-secondary-channel: #bfbf40;\r\n\t\t\t--pitch1-primary-channel: #ffff64;\r\n\t\t\t--pitch1-secondary-note: #bfbf40;\r\n\t\t\t--pitch1-primary-note: #ffff64;\r\n\t\t\t--pitch2-secondary-channel: #a2bf40;\r\n\t\t\t--pitch2-primary-channel: #e0ff7d;\r\n\t\t\t--pitch2-secondary-note: #a2bf40;\r\n\t\t\t--pitch2-primary-note: #e0ff7d;\r\n\t\t\t--pitch3-secondary-channel: #75bf40;\r\n\t\t\t--pitch3-primary-channel: #c1ff96;\r\n\t\t\t--pitch3-secondary-note: #75bf40;\r\n\t\t\t--pitch3-primary-note: #c1ff96;\r\n\t\t\t--pitch4-secondary-channel: #40bf51;\r\n\t\t\t--pitch4-primary-channel: #a2ffaf;\r\n\t\t\t--pitch4-secondary-note: #40bf51;\r\n\t\t\t--pitch4-primary-note: #a2ffaf;\r\n\t\t\t--pitch5-secondary-channel: #40bf86;\r\n\t\t\t--pitch5-primary-channel: #83ffc8;\r\n\t\t\t--pitch5-secondary-note: #40bf86;\r\n\t\t\t--pitch5-primary-note: #83ffc8;\r\n\t\t\t--pitch6-secondary-channel: #40bfa6;\r\n\t\t\t--pitch6-primary-channel: #64ffe1;\r\n\t\t\t--pitch6-secondary-note: #40bfa6;\r\n\t\t\t--pitch6-primary-note: #64ffe1;\r\n\t\t\t--pitch7-secondary-channel: #40bf86;\r\n\t\t\t--pitch7-primary-channel: #83ffc8;\r\n\t\t\t--pitch7-secondary-note: #40bf86;\r\n\t\t\t--pitch7-primary-note: #83ffc8;\r\n\t\t\t--pitch8-secondary-channel: #40bf51;\r\n\t\t\t--pitch8-primary-channel: #a2ffaf;\r\n\t\t\t--pitch8-secondary-note: #40bf51;\r\n\t\t\t--pitch8-primary-note: #a2ffaf;\r\n\t\t\t--pitch9-secondary-channel: #75bf40;\r\n\t\t\t--pitch9-primary-channel: #c1ff96;\r\n\t\t\t--pitch9-secondary-note: #75bf40;\r\n\t\t\t--pitch9-primary-note: #c1ff96;\r\n\t\t\t--pitch10-secondary-channel: #a2bf40;\r\n\t\t\t--pitch10-primary-channel: #e0ff7d;\r\n\t\t\t--pitch10-secondary-note: #a2bf40;\r\n\t\t\t--pitch10-primary-note: #e0ff7d;\r\n\t\t\t--noise1-secondary-channel: #a6a659;\r\n\t\t\t--noise1-primary-channel: #ffffcc;\r\n\t\t\t--noise1-secondary-note: #a6a659;\r\n\t\t\t--noise1-primary-note: #ffffcc;\r\n\t\t\t--noise2-secondary-channel: #94a659;\r\n\t\t\t--noise2-primary-channel: #f3ffcc;\r\n\t\t\t--noise2-secondary-note: #94a659;\r\n\t\t\t--noise2-primary-note: #f3ffcc;\r\n\t\t\t--noise3-secondary-channel: #79a659;\r\n\t\t\t--noise3-primary-channel: #e1ffcc;\r\n\t\t\t--noise3-secondary-note: #79a659;\r\n\t\t\t--noise3-primary-note: #e1ffcc;\r\n\t\t\t--noise4-secondary-channel: #94a659;\r\n\t\t\t--noise4-primary-channel: #f3ffcc;\r\n\t\t\t--noise4-secondary-note: #94a659;\r\n\t\t\t--noise4-primary-note: #f3ffcc;\r\n\t\t\t--noise5-secondary-channel: #a6a659;\r\n\t\t\t--noise5-primary-channel: #ffffcc;\r\n\t\t\t--noise5-secondary-note: #a6a659;\r\n\t\t\t--noise5-primary-note: #ffffcc;\r\n\t\t\t--mod1-secondary-channel: #a3a329;\r\n\t\t\t--mod1-primary-channel: #ffff00;\r\n\t\t\t--mod1-secondary-note: #a3a329;\r\n\t\t\t--mod1-primary-note: #ffff00;\r\n\t\t\t--mod2-secondary-channel: #a38529;\r\n\t\t\t--mod2-primary-channel: #ffbf00;\r\n\t\t\t--mod2-secondary-note: #a38529;\r\n\t\t\t--mod2-primary-note: #ffbf00;\r\n\t\t\t--mod3-secondary-channel: #a36629;\r\n\t\t\t--mod3-primary-channel: #ff7f00;\r\n\t\t\t--mod3-secondary-note: #a36629;\r\n\t\t\t--mod3-primary-note: #ff7f00;\r\n\t\t\t--mod4-secondary-channel: #a38529;\r\n\t\t\t--mod4-primary-channel: #ffbf00;\r\n\t\t\t--mod4-secondary-note: #a38529;\r\n\t\t\t--mod4-primary-note: #ffbf00;\r\n\t\t\t--mod-label-primary: #141f1d;\r\n\t\t\t--mod-label-secondary-text: #d9d98c;\r\n\t\t\t--mod-label-primary-text: white;\r\n\t\t\t--disabled-note-primary: #808080;\r\n\t\t\t--disabled-note-secondary: #666666;\r\n\t\t}`,\r\n\r\n\t\t\"neapolitan\":\r\n\t\t`:root {\r\n\t\t\t--page-margin: #120807;\r\n\t\t\t--editor-background: #120807;\r\n\t\t\t--hover-preview: #e79a82;\r\n\t\t\t--playhead: #e79a82;\r\n\t\t\t--primary-text: #decdbf;\r\n\t\t\t--secondary-text: #fa99bb;\r\n\t\t\t--inverted-text: black;\r\n\t\t\t--text-selection: #990036;\r\n\t\t\t--box-selection-fill: rgba(255,255,255,0.2);\r\n\t\t\t--loop-accent: #f6377a;\r\n\t\t\t--link-accent: #f6377a;\r\n\t\t\t--ui-widget-background: #24160f;\r\n\t\t\t--ui-widget-focus: #362217;\r\n\t\t\t--pitch-background: #1e1106;\r\n\t\t\t--tonic: #382414;\r\n\t\t\t--fifth-note: #41240c;\r\n\t\t\t--white-piano-key: #e1c5b7;\r\n\t\t\t--black-piano-key: #482c1e;\r\n\t\t\t--use-color-formula: false;\r\n\t\t\t--track-editor-bg-pitch: #4d2a19;\r\n\t\t\t--track-editor-bg-pitch-dim: #27150c;\r\n\t\t\t--track-editor-bg-noise: #4d2a19;\r\n\t\t\t--track-editor-bg-noise-dim: #27150c;\r\n\t\t\t--track-editor-bg-mod: #4d2a19;\r\n\t\t\t--track-editor-bg-mod-dim: #27150c;\r\n\t\t\t--multiplicative-mod-slider: #decdbf;\r\n\t\t\t--overwriting-mod-slider: #decdbf;\r\n\t\t\t--indicator-primary: #decdbf;\r\n\t\t\t--indicator-secondary: #362217;\r\n\t\t\t--select2-opt-group: #24160f;\r\n\t\t\t--input-box-outline: #24160f;\r\n\t\t\t--mute-button-normal: #ff66a1;\r\n\t\t\t--mute-button-mod: #e61968;\r\n\t\t\t--pitch1-secondary-channel: #680029;\r\n\t\t\t--pitch1-primary-channel: #cc0052;\r\n\t\t\t--pitch1-secondary-note: #660029;\r\n\t\t\t--pitch1-primary-note: #cc0052;\r\n\t\t\t--pitch2-secondary-channel: #7e1b43;\r\n\t\t\t--pitch2-primary-channel: #d32e71;\r\n\t\t\t--pitch2-secondary-note: #7e1b43;\r\n\t\t\t--pitch2-primary-note: #d32e71;\r\n\t\t\t--pitch3-secondary-channel: #aa275e;\r\n\t\t\t--pitch3-primary-channel: #da5d91;\r\n\t\t\t--pitch3-secondary-note: #aa275e;\r\n\t\t\t--pitch3-primary-note: #da5d91;\r\n\t\t\t--pitch4-secondary-channel: #cc3878;\r\n\t\t\t--pitch4-primary-channel: #e18bb0;\r\n\t\t\t--pitch4-secondary-note: #cc3878;\r\n\t\t\t--pitch4-primary-note: #e18bb0;\r\n\t\t\t--pitch5-secondary-channel: #d06c9b;\r\n\t\t\t--pitch5-primary-channel: #e9bad0;\r\n\t\t\t--pitch5-secondary-note: #d06c9b;\r\n\t\t\t--pitch5-primary-note: #e9bad0;\r\n\t\t\t--pitch6-secondary-channel: #c9acc5;\r\n\t\t\t--pitch6-primary-channel: #f0e8ef;\r\n\t\t\t--pitch6-secondary-note: #c9acc5;\r\n\t\t\t--pitch6-primary-note: #f0e8ef;\r\n\t\t\t--pitch7-secondary-channel: #d06c9b;\r\n\t\t\t--pitch7-primary-channel: #e9bad0;\r\n\t\t\t--pitch7-secondary-note: #d06c9b;\r\n\t\t\t--pitch7-primary-note: #e9bad0;\r\n\t\t\t--pitch8-secondary-channel: #cc3878;\r\n\t\t\t--pitch8-primary-channel: #e18bb0;\r\n\t\t\t--pitch8-secondary-note: #cc3878;\r\n\t\t\t--pitch8-primary-note: #e18bb0;\r\n\t\t\t--pitch9-secondary-channel: #aa275e;\r\n\t\t\t--pitch9-primary-channel: #da5d91;\r\n\t\t\t--pitch9-secondary-note: #aa275e;\r\n\t\t\t--pitch9-primary-note: #da5d91;\r\n\t\t\t--pitch10-secondary-channel: #7e1b43;\r\n\t\t\t--pitch10-primary-channel: #d32e71;\r\n\t\t\t--pitch10-secondary-note: #7e1b43;\r\n\t\t\t--pitch10-primary-note: #d32e71;\r\n\t\t\t--noise1-secondary-channel: #683a37;\r\n\t\t\t--noise1-primary-channel: #A85F5A;\r\n\t\t\t--noise1-secondary-note: #683a37;\r\n\t\t\t--noise1-primary-note: #A85F5A;\r\n\t\t\t--noise2-secondary-channel: #7c4a41;\r\n\t\t\t--noise2-primary-channel: #B47A70;\r\n\t\t\t--noise2-secondary-note: #7c4a41;\r\n\t\t\t--noise2-primary-note: #B47A70;\r\n\t\t\t--noise3-secondary-channel: #935f4d;\r\n\t\t\t--noise3-primary-channel: #c09587;\r\n\t\t\t--noise3-secondary-note: #935f4d;\r\n\t\t\t--noise3-primary-note: #C09587;\r\n\t\t\t--noise4-secondary-channel: #aa795a;\r\n\t\t\t--noise4-primary-channel: #cdb09d;\r\n\t\t\t--noise4-secondary-note: #aa795a;\r\n\t\t\t--noise4-primary-note: #CDAF9D;\r\n\t\t\t--noise5-secondary-channel: #bb987c;\r\n\t\t\t--noise5-primary-channel: #decdbf;\r\n\t\t\t--noise5-secondary-note: #bb987c;\r\n\t\t\t--noise5-primary-note: #decdbf;\r\n\t\t\t--mod1-secondary-channel: #6ca784;\r\n\t\t\t--mod1-primary-channel: #accdb9;\r\n\t\t\t--mod1-secondary-note: #6ca784;\r\n\t\t\t--mod1-primary-note: #accdb9;\r\n\t\t\t--mod2-secondary-channel: #7daa9f;\r\n\t\t\t--mod2-primary-channel: #bbd3cd;\r\n\t\t\t--mod2-secondary-note: #7daa9f;\r\n\t\t\t--mod2-primary-note: #bbd3cd;\r\n\t\t\t--mod3-secondary-channel: #70a3a9;\r\n\t\t\t--mod3-primary-channel: #afcccf;\r\n\t\t\t--mod3-secondary-note: #70a3a9;\r\n\t\t\t--mod3-primary-note: #afcccf;\r\n\t\t\t--mod4-secondary-channel: #5698b8;\r\n\t\t\t--mod4-primary-channel: #9ec3d6;\r\n\t\t\t--mod4-secondary-note: #5698b8;\r\n\t\t\t--mod4-primary-note: #9ec3d6;\r\n\t\t\t--mod-label-primary: #24160f;\r\n\t\t\t--mod-label-secondary-text: #E5AFC2;\r\n\t\t\t--mod-label-primary-text: #decdbf;\r\n\t\t\t--disabled-note-primary: #bababa;\r\n\t\t\t--disabled-note-secondary: #878787;\r\n\t\t}`,\r\n\r\n\t\t\"mono\":\r\n\t\t`:root {\r\n\t\t\t--page-margin: #000;\r\n\t\t\t--editor-background: #000;\r\n\t\t\t--hover-preview: #808080;\r\n\t\t\t--playhead: #808080;\r\n\t\t\t--primary-text: white;\r\n\t\t\t--secondary-text: #cccccc;\r\n\t\t\t--inverted-text: black;\r\n\t\t\t--text-selection: #696969;\r\n\t\t\t--box-selection-fill: #cccccc40;\r\n\t\t\t--loop-accent: #808080;\r\n\t\t\t--link-accent: white;\r\n\t\t\t--ui-widget-background: #232323;\r\n\t\t\t--ui-widget-focus: #303030;\r\n\t\t\t--pitch-background: #1a1a1a;\r\n\t\t\t--tonic: #262626;\r\n\t\t\t--fifth-note: #0d0d0d;\r\n\t\t\t--white-piano-key: #808080;\r\n\t\t\t--black-piano-key: #232323;\r\n\t\t\t--use-color-formula: true;\r\n\t\t\t--track-editor-bg-pitch: #262626;\r\n\t\t\t--track-editor-bg-pitch-dim: #1a1a1a;\r\n\t\t\t--track-editor-bg-noise: #262626;\r\n\t\t\t--track-editor-bg-noise-dim: #1a1a1a;\r\n\t\t\t--track-editor-bg-mod: #262626;\r\n\t\t\t--track-editor-bg-mod-dim: #1a1a1a;\r\n\t\t\t--multiplicative-mod-slider: #808080;\r\n\t\t\t--overwriting-mod-slider: #808080;\r\n\t\t\t--indicator-primary: #808080;\r\n\t\t\t--indicator-secondary: #333333;\r\n\t\t\t--select2-opt-group: #232323;\r\n\t\t\t--input-box-outline: #222;\r\n\t\t\t--mute-button-normal: #808080;\r\n\t\t\t--mute-button-mod: #808080;\r\n\t\t\t--mod-label-primary: #232323;\r\n\t\t\t--mod-label-secondary-text: #696969;\r\n\t\t\t--mod-label-primary-text: #cdcdcd;\r\n\t\t\t--pitch-secondary-channel-hue: 0;\r\n\t\t\t--pitch-secondary-channel-hue-scale: 25;\r\n\t\t\t--pitch-secondary-channel-sat: 10;\r\n\t\t\t--pitch-secondary-channel-sat-scale: 0.1;\r\n\t\t\t--pitch-secondary-channel-lum: 70;\r\n\t\t\t--pitch-secondary-channel-lum-scale: 0;\r\n\t\t\t--pitch-primary-channel-hue: 0;\r\n\t\t\t--pitch-primary-channel-hue-scale: 25;\r\n\t\t\t--pitch-primary-channel-sat: 50;\r\n\t\t\t--pitch-primary-channel-sat-scale: 0.1;\r\n\t\t\t--pitch-primary-channel-lum: 95;\r\n\t\t\t--pitch-primary-channel-lum-scale: 0;\r\n\t\t\t--pitch-secondary-note-hue: 0;\r\n\t\t\t--pitch-secondary-note-hue-scale: 25;\r\n\t\t\t--pitch-secondary-note-sat: 10;\r\n\t\t\t--pitch-secondary-note-sat-scale: 0.1;\r\n\t\t\t--pitch-secondary-note-lum: 70;\r\n\t\t\t--pitch-secondary-note-lum-scale: 0;\r\n\t\t\t--pitch-primary-note-hue: 0;\r\n\t\t\t--pitch-primary-note-hue-scale: 25;\r\n\t\t\t--pitch-primary-note-sat: 50;\r\n\t\t\t--pitch-primary-note-sat-scale: 0.1;\r\n\t\t\t--pitch-primary-note-lum: 95;\r\n\t\t\t--pitch-primary-note-lum-scale: 0;\r\n\t\t\t--noise-secondary-channel-hue: 125;\r\n\t\t\t--noise-secondary-channel-hue-scale: 50;\r\n\t\t\t--noise-secondary-channel-sat: 10;\r\n\t\t\t--noise-secondary-channel-sat-scale: 0.1;\r\n\t\t\t--noise-secondary-channel-lum: 70;\r\n\t\t\t--noise-secondary-channel-lum-scale: 0;\r\n\t\t\t--noise-primary-channel-hue: 125;\r\n\t\t\t--noise-primary-channel-hue-scale: 50;\r\n\t\t\t--noise-primary-channel-sat: 50;\r\n\t\t\t--noise-primary-channel-sat-scale: 0.1;\r\n\t\t\t--noise-primary-channel-lum: 95;\r\n\t\t\t--noise-primary-channel-lum-scale: 0;\r\n\t\t\t--noise-secondary-note-hue: 125;\r\n\t\t\t--noise-secondary-note-hue-scale: 50;\r\n\t\t\t--noise-secondary-note-sat: 10;\r\n\t\t\t--noise-secondary-note-sat-scale: 0.1;\r\n\t\t\t--noise-secondary-note-lum: 70;\r\n\t\t\t--noise-secondary-note-lum-scale: 0;\r\n\t\t\t--noise-primary-note-hue: 125;\r\n\t\t\t--noise-primary-note-hue-scale: 50;\r\n\t\t\t--noise-primary-note-sat: 50;\r\n\t\t\t--noise-primary-note-sat-scale: 0.1;\r\n\t\t\t--noise-primary-note-lum: 95;\r\n\t\t\t--noise-primary-note-lum-scale: 0;\r\n\t\t\t--mod-secondary-channel-hue: 255;\r\n\t\t\t--mod-secondary-channel-hue-scale: 75;\r\n\t\t\t--mod-secondary-channel-sat: 10;\r\n\t\t\t--mod-secondary-channel-sat-scale: 0;\r\n\t\t\t--mod-secondary-channel-lum: 70;\r\n\t\t\t--mod-secondary-channel-lum-scale: 0;\r\n\t\t\t--mod-primary-channel-hue: 255;\r\n\t\t\t--mod-primary-channel-hue-scale: 75;\r\n\t\t\t--mod-primary-channel-sat: 50;\r\n\t\t\t--mod-primary-channel-sat-scale: 0;\r\n\t\t\t--mod-primary-channel-lum: 95;\r\n\t\t\t--mod-primary-channel-lum-scale: 0;\r\n\t\t\t--mod-secondary-note-hue: 255;\r\n\t\t\t--mod-secondary-note-hue-scale: 75;\r\n\t\t\t--mod-secondary-note-sat: 10;\r\n\t\t\t--mod-secondary-note-sat-scale: 0;\r\n\t\t\t--mod-secondary-note-lum: 70;\r\n\t\t\t--mod-secondary-note-lum-scale: 0;\r\n\t\t\t--mod-primary-note-hue: 255;\r\n\t\t\t--mod-primary-note-hue-scale: 75;\r\n\t\t\t--mod-primary-note-sat: 50;\r\n\t\t\t--mod-primary-note-sat-scale: 0;\r\n\t\t\t--mod-primary-note-lum: 95;\r\n\t\t\t--mod-primary-note-lum-scale: 0;\r\n\t\t\t--disabled-note-primary: #c6c6c6;\r\n\t\t\t--disabled-note-secondary: #8c8c8c;\r\n\t\t}`,\r\n    };\r\n\r\n    public static readonly pageMargin: string = \"var(--page-margin)\";\r\n    public static readonly editorBackground: string = \"var(--editor-background)\";\r\n    public static readonly hoverPreview: string = \"var(--hover-preview)\";\r\n    public static readonly playhead: string = \"var(--playhead)\";\r\n    public static readonly primaryText: string = \"var(--primary-text)\";\r\n    public static readonly secondaryText: string = \"var(--secondary-text)\";\r\n    public static readonly invertedText: string = \"var(--inverted-text)\";\r\n    public static readonly textSelection: string = \"var(--text-selection)\";\r\n    public static readonly boxSelectionFill: string = \"var(--box-selection-fill)\";\r\n    public static readonly loopAccent: string = \"var(--loop-accent)\";\r\n    public static readonly linkAccent: string = \"var(--link-accent)\";\r\n    public static readonly uiWidgetBackground: string = \"var(--ui-widget-background)\";\r\n    public static readonly uiWidgetFocus: string = \"var(--ui-widget-focus)\";\r\n    public static readonly pitchBackground: string = \"var(--pitch-background)\";\r\n    public static readonly tonic: string = \"var(--tonic)\";\r\n    public static readonly fifthNote: string = \"var(--fifth-note)\";\r\n    public static readonly whitePianoKey: string = \"var(--white-piano-key)\";\r\n    public static readonly blackPianoKey: string = \"var(--black-piano-key)\";\r\n    public static readonly useColorFormula: string = \"var(--use-color-formula)\";\r\n    public static readonly pitchSecondaryChannelHue: string = \"var(--pitch-secondary-channel-hue)\";\r\n    public static readonly pitchSecondaryChannelHueScale: string = \"var(--pitch-secondary-channel-hue-scale)\";\r\n    public static readonly pitchSecondaryChannelSat: string = \"var(--pitch-secondary-channel-sat)\";\r\n    public static readonly pitchSecondaryChannelSatScale: string = \"var(--pitch-secondary-channel-sat-scale)\";\r\n    public static readonly pitchSecondaryChannelLum: string = \"var(--pitch-secondary-channel-lum)\";\r\n    public static readonly pitchSecondaryChannelLumScale: string = \"var(--pitch-secondary-channel-lum-scale)\";\r\n    public static readonly pitchPrimaryChannelHue: string = \"var(--pitch-primary-channel-hue)\";\r\n    public static readonly pitchPrimaryChannelHueScale: string = \"var(--pitch-primary-channel-hue-scale)\";\r\n    public static readonly pitchPrimaryChannelSat: string = \"var(--pitch-primary-channel-sat)\";\r\n    public static readonly pitchPrimaryChannelSatScale: string = \"var(--pitch-primary-channel-sat-scale)\";\r\n    public static readonly pitchPrimaryChannelLum: string = \"var(--pitch-primary-channel-lum)\";\r\n    public static readonly pitchPrimaryChannelLumScale: string = \"var(--pitch-primary-channel-lum-scale)\";\r\n    public static readonly pitchSecondaryNoteHue: string = \"var(--pitch-secondary-note-hue)\";\r\n    public static readonly pitchSecondaryNoteHueScale: string = \"var(--pitch-secondary-note-hue-scale)\";\r\n    public static readonly pitchSecondaryNoteSat: string = \"var(--pitch-secondary-note-sat)\";\r\n    public static readonly pitchSecondaryNoteSatScale: string = \"var(--pitch-secondary-note-sat-scale)\";\r\n    public static readonly pitchSecondaryNoteLum: string = \"var(--pitch-secondary-note-lum)\";\r\n    public static readonly pitchSecondaryNoteLumScale: string = \"var(--pitch-secondary-note-lum-scale)\";\r\n    public static readonly pitchPrimaryNoteHue: string = \"var(--pitch-primary-note-hue)\";\r\n    public static readonly pitchPrimaryNoteHueScale: string = \"var(--pitch-primary-note-hue-scale)\";\r\n    public static readonly pitchPrimaryNoteSat: string = \"var(--pitch-primary-note-sat)\";\r\n    public static readonly pitchPrimaryNoteSatScale: string = \"var(--pitch-primary-note-sat-scale)\";\r\n    public static readonly pitchPrimaryNoteLum: string = \"var(--pitch-primary-note-lum)\";\r\n    public static readonly pitchPrimaryNoteLumScale: string = \"var(--pitch-primary-note-lum-scale)\";\r\n    public static readonly modSecondaryChannelHue: string = \"var(--mod-secondary-channel-hue)\";\r\n    public static readonly modSecondaryChannelHueScale: string = \"var(--mod-secondary-channel-hue-scale)\";\r\n    public static readonly modSecondaryChannelSat: string = \"var(--mod-secondary-channel-sat)\";\r\n    public static readonly modSecondaryChannelSatScale: string = \"var(--mod-secondary-channel-sat-scale)\";\r\n    public static readonly modSecondaryChannelLum: string = \"var(--mod-secondary-channel-lum)\";\r\n    public static readonly modSecondaryChannelLumScale: string = \"var(--mod-secondary-channel-lum-scale)\";\r\n    public static readonly modPrimaryChannelHue: string = \"var(--mod-primary-channel-hue)\";\r\n    public static readonly modPrimaryChannelHueScale: string = \"var(--mod-primary-channel-hue-scale)\";\r\n    public static readonly modPrimaryChannelSat: string = \"var(--mod-primary-channel-sat)\";\r\n    public static readonly modPrimaryChannelSatScale: string = \"var(--mod-primary-channel-sat-scale)\";\r\n    public static readonly modPrimaryChannelLum: string = \"var(--mod-primary-channel-lum)\";\r\n    public static readonly modPrimaryChannelLumScale: string = \"var(--mod-primary-channel-lum-scale)\";\r\n    public static readonly modSecondaryNoteHue: string = \"var(--mod-secondary-note-hue)\";\r\n    public static readonly modSecondaryNoteHueScale: string = \"var(--mod-secondary-note-hue-scale)\";\r\n    public static readonly modSecondaryNoteSat: string = \"var(--mod-secondary-note-sat)\";\r\n    public static readonly modSecondaryNoteSatScale: string = \"var(--mod-secondary-note-sat-scale)\";\r\n    public static readonly modSecondaryNoteLum: string = \"var(--mod-secondary-note-lum)\";\r\n    public static readonly modSecondaryNoteLumScale: string = \"var(--mod-secondary-note-lum-scale)\";\r\n    public static readonly modPrimaryNoteHue: string = \"var(--mod-primary-note-hue)\";\r\n    public static readonly modPrimaryNoteHueScale: string = \"var(--mod-primary-note-hue-scale)\";\r\n    public static readonly modPrimaryNoteSat: string = \"var(--mod-primary-note-sat)\";\r\n    public static readonly modPrimaryNoteSatScale: string = \"var(--mod-primary-note-sat-scale)\";\r\n    public static readonly modPrimaryNoteLum: string = \"var(--mod-primary-note-lum)\";\r\n    public static readonly modPrimaryNoteLumScale: string = \"var(--mod-primary-note-lum-scale)\";\r\n    public static readonly noiseSecondaryChannelHue: string = \"var(--noise-secondary-channel-hue)\";\r\n    public static readonly noiseSecondaryChannelHueScale: string = \"var(--noise-secondary-channel-hue-scale)\";\r\n    public static readonly noiseSecondaryChannelSat: string = \"var(--noise-secondary-channel-sat)\";\r\n    public static readonly noiseSecondaryChannelSatScale: string = \"var(--noise-secondary-channel-sat-scale)\";\r\n    public static readonly noiseSecondaryChannelLum: string = \"var(--noise-secondary-channel-lum)\";\r\n    public static readonly noiseSecondaryChannelLumScale: string = \"var(--noise-secondary-channel-lum-scale)\";\r\n    public static readonly noisePrimaryChannelHue: string = \"var(--noise-primary-channel-hue)\";\r\n    public static readonly noisePrimaryChannelHueScale: string = \"var(--noise-primary-channel-hue-scale)\";\r\n    public static readonly noisePrimaryChannelSat: string = \"var(--noise-primary-channel-sat)\";\r\n    public static readonly noisePrimaryChannelSatScale: string = \"var(--noise-primary-channel-sat-scale)\";\r\n    public static readonly noisePrimaryChannelLum: string = \"var(--noise-primary-channel-lum)\";\r\n    public static readonly noisePrimaryChannelLumScale: string = \"var(--noise-primary-channel-lum-scale)\";\r\n    public static readonly noiseSecondaryNoteHue: string = \"var(--noise-secondary-note-hue)\";\r\n    public static readonly noiseSecondaryNoteHueScale: string = \"var(--noise-secondary-note-hue-scale)\";\r\n    public static readonly noiseSecondaryNoteSat: string = \"var(--noise-secondary-note-sat)\";\r\n    public static readonly noiseSecondaryNoteSatScale: string = \"var(--noise-secondary-note-sat-scale)\";\r\n    public static readonly noiseSecondaryNoteLum: string = \"var(--noise-secondary-note-lum)\";\r\n    public static readonly noiseSecondaryNoteLumScale: string = \"var(--noise-secondary-note-lum-scale)\";\r\n    public static readonly noisePrimaryNoteHue: string = \"var(--noise-primary-note-hue)\";\r\n    public static readonly noisePrimaryNoteHueScale: string = \"var(--noise-primary-note-hue-scale)\";\r\n    public static readonly noisePrimaryNoteSat: string = \"var(--noise-primary-note-sat)\";\r\n    public static readonly noisePrimaryNoteSatScale: string = \"var(--noise-primary-note-sat-scale)\";\r\n    public static readonly noisePrimaryNoteLum: string = \"var(--noise-primary-note-lum)\";\r\n    public static readonly noisePrimaryNoteLumScale: string = \"var(--noise-primary-note-lum-scale)\";\r\n    public static readonly trackEditorBgPitch: string = \"var(--track-editor-bg-pitch)\";\r\n    public static readonly trackEditorBgPitchDim: string = \"var(--track-editor-bg-pitch-dim)\";\r\n    public static readonly trackEditorBgNoise: string = \"var(--track-editor-bg-noise)\";\r\n    public static readonly trackEditorBgNoiseDim: string = \"var(--track-editor-bg-noise-dim)\";\r\n    public static readonly trackEditorBgMod: string = \"var(--track-editor-bg-mod)\";\r\n    public static readonly trackEditorBgModDim: string = \"var(--track-editor-bg-mod-dim)\";\r\n    public static readonly multiplicativeModSlider: string = \"var(--multiplicative-mod-slider)\";\r\n    public static readonly overwritingModSlider: string = \"var(--overwriting-mod-slider)\";\r\n    public static readonly indicatorPrimary: string = \"var(--indicator-primary)\";\r\n    public static readonly indicatorSecondary: string = \"var(--indicator-secondary)\";\r\n    public static readonly select2OptGroup: string = \"var(--select2-opt-group)\";\r\n    public static readonly inputBoxOutline: string = \"var(--input-box-outline)\";\r\n    public static readonly muteButtonNormal: string = \"var(--mute-button-normal)\";\r\n    public static readonly muteButtonMod: string = \"var(--mute-button-mod)\";\r\n    public static readonly modLabelPrimary: string = \"var(--mod-label-primary)\";\r\n    public static readonly modLabelSecondaryText: string = \"var(--mod-label-secondary-text)\";\r\n    public static readonly modLabelPrimaryText: string = \"var(--mod-label-primary-text)\";\r\n    public static readonly disabledNotePrimary: string = \"var(--disabled-note-primary)\";\r\n    public static readonly disabledNoteSecondary: string = \"var(--disabled-note-secondary)\";\r\n\r\n    public static readonly pitchChannels: DictionaryArray<ChannelColors> = toNameMap([\r\n        {\r\n            name: \"pitch1\", // cyan\r\n            secondaryChannel: \"var(--pitch1-secondary-channel)\",\r\n            primaryChannel: \"var(--pitch1-primary-channel)\",\r\n            secondaryNote: \"var(--pitch1-secondary-note)\",\r\n            primaryNote: \"var(--pitch1-primary-note)\",\r\n        }, {\r\n            name: \"pitch2\", // yellow\r\n            secondaryChannel: \"var(--pitch2-secondary-channel)\",\r\n            primaryChannel: \"var(--pitch2-primary-channel)\",\r\n            secondaryNote: \"var(--pitch2-secondary-note)\",\r\n            primaryNote: \"var(--pitch2-primary-note)\",\r\n        }, {\r\n            name: \"pitch3\", // orange\r\n            secondaryChannel: \"var(--pitch3-secondary-channel)\",\r\n            primaryChannel: \"var(--pitch3-primary-channel)\",\r\n            secondaryNote: \"var(--pitch3-secondary-note)\",\r\n            primaryNote: \"var(--pitch3-primary-note)\",\r\n        }, {\r\n            name: \"pitch4\", // green\r\n            secondaryChannel: \"var(--pitch4-secondary-channel)\",\r\n            primaryChannel: \"var(--pitch4-primary-channel)\",\r\n            secondaryNote: \"var(--pitch4-secondary-note)\",\r\n            primaryNote: \"var(--pitch4-primary-note)\",\r\n        }, {\r\n            name: \"pitch5\", // magenta\r\n            secondaryChannel: \"var(--pitch5-secondary-channel)\",\r\n            primaryChannel: \"var(--pitch5-primary-channel)\",\r\n            secondaryNote: \"var(--pitch5-secondary-note)\",\r\n            primaryNote: \"var(--pitch5-primary-note)\",\r\n        }, {\r\n            name: \"pitch6\", // blue\r\n            secondaryChannel: \"var(--pitch6-secondary-channel)\",\r\n            primaryChannel: \"var(--pitch6-primary-channel)\",\r\n            secondaryNote: \"var(--pitch6-secondary-note)\",\r\n            primaryNote: \"var(--pitch6-primary-note)\",\r\n        }, {\r\n            name: \"pitch7\", // olive\r\n            secondaryChannel: \"var(--pitch7-secondary-channel)\",\r\n            primaryChannel: \"var(--pitch7-primary-channel)\",\r\n            secondaryNote: \"var(--pitch7-secondary-note)\",\r\n            primaryNote: \"var(--pitch7-primary-note)\",\r\n        }, {\r\n            name: \"pitch8\", // red\r\n            secondaryChannel: \"var(--pitch8-secondary-channel)\",\r\n            primaryChannel: \"var(--pitch8-primary-channel)\",\r\n            secondaryNote: \"var(--pitch8-secondary-note)\",\r\n            primaryNote: \"var(--pitch8-primary-note)\",\r\n        }, {\r\n            name: \"pitch9\", // teal\r\n            secondaryChannel: \"var(--pitch9-secondary-channel)\",\r\n            primaryChannel: \"var(--pitch9-primary-channel)\",\r\n            secondaryNote: \"var(--pitch9-secondary-note)\",\r\n            primaryNote: \"var(--pitch9-primary-note)\",\r\n        }, {\r\n            name: \"pitch10\", // purple\r\n            secondaryChannel: \"var(--pitch10-secondary-channel)\",\r\n            primaryChannel: \"var(--pitch10-primary-channel)\",\r\n            secondaryNote: \"var(--pitch10-secondary-note)\",\r\n            primaryNote: \"var(--pitch10-primary-note)\",\r\n        },\r\n    ]);\r\n    public static readonly noiseChannels: DictionaryArray<ChannelColors> = toNameMap([\r\n        {\r\n            name: \"noise1\", // gray\r\n            secondaryChannel: \"var(--noise1-secondary-channel)\",\r\n            primaryChannel: \"var(--noise1-primary-channel)\",\r\n            secondaryNote: \"var(--noise1-secondary-note)\",\r\n            primaryNote: \"var(--noise1-primary-note)\",\r\n        }, {\r\n            name: \"noise2\", // brown\r\n            secondaryChannel: \"var(--noise2-secondary-channel)\",\r\n            primaryChannel: \"var(--noise2-primary-channel)\",\r\n            secondaryNote: \"var(--noise2-secondary-note)\",\r\n            primaryNote: \"var(--noise2-primary-note)\",\r\n        }, {\r\n            name: \"noise3\", // azure\r\n            secondaryChannel: \"var(--noise3-secondary-channel)\",\r\n            primaryChannel: \"var(--noise3-primary-channel)\",\r\n            secondaryNote: \"var(--noise3-secondary-note)\",\r\n            primaryNote: \"var(--noise3-primary-note)\",\r\n        }, {\r\n            name: \"noise4\", // purple\r\n            secondaryChannel: \"var(--noise4-secondary-channel)\",\r\n            primaryChannel: \"var(--noise4-primary-channel)\",\r\n            secondaryNote: \"var(--noise4-secondary-note)\",\r\n            primaryNote: \"var(--noise4-primary-note)\",\r\n        }, {\r\n            name: \"noise5\", // sage\r\n            secondaryChannel: \"var(--noise5-secondary-channel)\",\r\n            primaryChannel: \"var(--noise5-primary-channel)\",\r\n            secondaryNote: \"var(--noise5-secondary-note)\",\r\n            primaryNote: \"var(--noise5-primary-note)\",\r\n        },\r\n    ]);\r\n    public static readonly modChannels: DictionaryArray<ChannelColors> = toNameMap([\r\n        {\r\n            name: \"mod1\",\r\n            secondaryChannel: \"var(--mod1-secondary-channel)\",\r\n            primaryChannel: \"var(--mod1-primary-channel)\",\r\n            secondaryNote: \"var(--mod1-secondary-note)\",\r\n            primaryNote: \"var(--mod1-primary-note)\",\r\n        }, {\r\n            name: \"mod2\",\r\n            secondaryChannel: \"var(--mod2-secondary-channel)\",\r\n            primaryChannel: \"var(--mod2-primary-channel)\",\r\n            secondaryNote: \"var(--mod2-secondary-note)\",\r\n            primaryNote: \"var(--mod2-primary-note)\",\r\n        }, {\r\n            name: \"mod3\",\r\n            secondaryChannel: \"var(--mod3-secondary-channel)\",\r\n            primaryChannel: \"var(--mod3-primary-channel)\",\r\n            secondaryNote: \"var(--mod3-secondary-note)\",\r\n            primaryNote: \"var(--mod3-primary-note)\",\r\n        }, {\r\n            name: \"mod4\",\r\n            secondaryChannel: \"var(--mod4-secondary-channel)\",\r\n            primaryChannel: \"var(--mod4-primary-channel)\",\r\n            secondaryNote: \"var(--mod4-secondary-note)\",\r\n            primaryNote: \"var(--mod4-primary-note)\",\r\n        },\r\n    ]);\r\n\r\n    public static resetColors() {\r\n        this.colorLookup.clear();\r\n    }\r\n\r\n    // Same as below, but won't return var colors\r\n    public static getComputedChannelColor(song: Song, channel: number): ChannelColors {\r\n        if (getComputedStyle(this._styleElement).getPropertyValue(\"--use-color-formula\").trim() == \"false\") {\r\n            let base: ChannelColors = ColorConfig.getChannelColor(song, channel);\r\n            // Trim away \"var(...)\"\r\n            var regex = /\\(([^)]+)\\)/;\r\n            let newChannelSecondary: string = ColorConfig.getComputed((regex.exec(base.secondaryChannel) as RegExpExecArray)[1] as string);\r\n            let newChannelPrimary: string = ColorConfig.getComputed((regex.exec(base.primaryChannel) as RegExpExecArray)[1] as string);\r\n            let newNoteSecondary: string = ColorConfig.getComputed((regex.exec(base.secondaryNote) as RegExpExecArray)[1] as string);\r\n            let newNotePrimary: string = ColorConfig.getComputed((regex.exec(base.primaryNote) as RegExpExecArray)[1] as string);\r\n            return <ChannelColors>{ secondaryChannel: newChannelSecondary, primaryChannel: newChannelPrimary, secondaryNote: newNoteSecondary, primaryNote: newNotePrimary };\r\n        }\r\n        else {\r\n            return ColorConfig.getChannelColor(song, channel);\r\n        }\r\n    };\r\n\r\n    public static getChannelColor(song: Song, channel: number): ChannelColors {\r\n        if (getComputedStyle(this._styleElement).getPropertyValue(\"--use-color-formula\").trim() == \"false\") {\r\n            // Set colors, not defined by formula\r\n            if (channel < song.pitchChannelCount) {\r\n                return ColorConfig.pitchChannels[channel % ColorConfig.pitchChannels.length];\r\n            } else if (channel < song.pitchChannelCount + song.noiseChannelCount) {\r\n                return ColorConfig.noiseChannels[(channel - song.pitchChannelCount) % ColorConfig.noiseChannels.length];\r\n            } else {\r\n                return ColorConfig.modChannels[(channel - song.pitchChannelCount - song.noiseChannelCount) % ColorConfig.modChannels.length];\r\n            }\r\n        }\r\n        else {\r\n            // Determine if color is cached\r\n            if (ColorConfig.colorLookup.has(channel)) {\r\n                return ColorConfig.colorLookup.get(channel) as ChannelColors;\r\n            }\r\n            else {\r\n                // Formulaic color definition\r\n                if (channel < song.pitchChannelCount) {\r\n                    // Pitch formula\r\n                    const pitchSecondaryChannelHue: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--pitch-secondary-channel-hue\");\r\n                    const pitchSecondaryChannelHueScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--pitch-secondary-channel-hue-scale\");\r\n                    const pitchSecondaryChannelSat: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--pitch-secondary-channel-sat\");\r\n                    const pitchSecondaryChannelSatScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--pitch-secondary-channel-sat-scale\");\r\n                    const pitchSecondaryChannelLum: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--pitch-secondary-channel-lum\");\r\n                    const pitchSecondaryChannelLumScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--pitch-secondary-channel-lum-scale\");\r\n                    const pitchPrimaryChannelHue: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--pitch-primary-channel-hue\");\r\n                    const pitchPrimaryChannelHueScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--pitch-primary-channel-hue-scale\");\r\n                    const pitchPrimaryChannelSat: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--pitch-primary-channel-sat\");\r\n                    const pitchPrimaryChannelSatScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--pitch-primary-channel-sat-scale\");\r\n                    const pitchPrimaryChannelLum: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--pitch-primary-channel-lum\");\r\n                    const pitchPrimaryChannelLumScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--pitch-primary-channel-lum-scale\");\r\n                    const pitchSecondaryNoteHue: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--pitch-secondary-note-hue\");\r\n                    const pitchSecondaryNoteHueScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--pitch-secondary-note-hue-scale\");\r\n                    const pitchSecondaryNoteSat: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--pitch-secondary-note-sat\");\r\n                    const pitchSecondaryNoteSatScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--pitch-secondary-note-sat-scale\");\r\n                    const pitchSecondaryNoteLum: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--pitch-secondary-note-lum\");\r\n                    const pitchSecondaryNoteLumScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--pitch-secondary-note-lum-scale\");\r\n                    const pitchPrimaryNoteHue: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--pitch-primary-note-hue\");\r\n                    const pitchPrimaryNoteHueScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--pitch-primary-note-hue-scale\");\r\n                    const pitchPrimaryNoteSat: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--pitch-primary-note-sat\");\r\n                    const pitchPrimaryNoteSatScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--pitch-primary-note-sat-scale\");\r\n                    const pitchPrimaryNoteLum: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--pitch-primary-note-lum\");\r\n                    const pitchPrimaryNoteLumScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--pitch-primary-note-lum-scale\");\r\n\r\n                    let newChannelSecondary: string = \"hsl(\" + ((+pitchSecondaryChannelHue + (channel * +pitchSecondaryChannelHueScale / Config.pitchChannelCountMax) * 256) % 256) + \",\"\r\n                        + (+pitchSecondaryChannelSat * (1 - (+pitchSecondaryChannelSatScale * Math.floor(channel / 7)))) + \"%,\"\r\n                        + (+pitchSecondaryChannelLum * (1 - (+pitchSecondaryChannelLumScale * Math.floor(channel / 7)))) + \"%)\";\r\n                    let newChannelPrimary: string = \"hsl(\" + ((+pitchPrimaryChannelHue + (channel * +pitchPrimaryChannelHueScale / Config.pitchChannelCountMax) * 256) % 256) + \",\"\r\n                        + (+pitchPrimaryChannelSat * (1 - (+pitchPrimaryChannelSatScale * Math.floor(channel / 7)))) + \"%,\"\r\n                        + (+pitchPrimaryChannelLum * (1 - (+pitchPrimaryChannelLumScale * Math.floor(channel / 7)))) + \"%)\";\r\n                    let newNoteSecondary: string = \"hsl(\" + ((+pitchSecondaryNoteHue + (channel * +pitchSecondaryNoteHueScale / Config.pitchChannelCountMax) * 256) % 256) + \",\"\r\n                        + (+pitchSecondaryNoteSat * (1 - (+pitchSecondaryNoteSatScale * Math.floor(channel / 7)))) + \"%,\"\r\n                        + (+pitchSecondaryNoteLum * (1 - (+pitchSecondaryNoteLumScale * Math.floor(channel / 7)))) + \"%)\";\r\n                    let newNotePrimary: string = \"hsl(\" + ((+pitchPrimaryNoteHue + (channel * +pitchPrimaryNoteHueScale / Config.pitchChannelCountMax) * 256) % 256) + \",\"\r\n                        + (+pitchPrimaryNoteSat * (1 - (+pitchPrimaryNoteSatScale * Math.floor(channel / 7)))) + \"%,\"\r\n                        + (+pitchPrimaryNoteLum * (1 - (+pitchPrimaryNoteLumScale * Math.floor(channel / 7)))) + \"%)\";\r\n\r\n                    let newChannelColors = <ChannelColors>{ secondaryChannel: newChannelSecondary, primaryChannel: newChannelPrimary, secondaryNote: newNoteSecondary, primaryNote: newNotePrimary };\r\n                    ColorConfig.colorLookup.set(channel, newChannelColors);\r\n                    return newChannelColors;\r\n\r\n                }\r\n                else if (channel < song.pitchChannelCount + song.noiseChannelCount) {\r\n                    // Noise formula\r\n                    const noiseSecondaryChannelHue: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--noise-secondary-channel-hue\");\r\n                    const noiseSecondaryChannelHueScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--noise-secondary-channel-hue-scale\");\r\n                    const noiseSecondaryChannelSat: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--noise-secondary-channel-sat\");\r\n                    const noiseSecondaryChannelSatScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--noise-secondary-channel-sat-scale\");\r\n                    const noiseSecondaryChannelLum: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--noise-secondary-channel-lum\");\r\n                    const noiseSecondaryChannelLumScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--noise-secondary-channel-lum-scale\");\r\n                    const noisePrimaryChannelHue: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--noise-primary-channel-hue\");\r\n                    const noisePrimaryChannelHueScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--noise-primary-channel-hue-scale\");\r\n                    const noisePrimaryChannelSat: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--noise-primary-channel-sat\");\r\n                    const noisePrimaryChannelSatScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--noise-primary-channel-sat-scale\");\r\n                    const noisePrimaryChannelLum: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--noise-primary-channel-lum\");\r\n                    const noisePrimaryChannelLumScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--noise-primary-channel-lum-scale\");\r\n                    const noiseSecondaryNoteHue: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--noise-secondary-note-hue\");\r\n                    const noiseSecondaryNoteHueScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--noise-secondary-note-hue-scale\");\r\n                    const noiseSecondaryNoteSat: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--noise-secondary-note-sat\");\r\n                    const noiseSecondaryNoteSatScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--noise-secondary-note-sat-scale\");\r\n                    const noiseSecondaryNoteLum: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--noise-secondary-note-lum\");\r\n                    const noiseSecondaryNoteLumScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--noise-secondary-note-lum-scale\");\r\n                    const noisePrimaryNoteHue: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--noise-primary-note-hue\");\r\n                    const noisePrimaryNoteHueScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--noise-primary-note-hue-scale\");\r\n                    const noisePrimaryNoteSat: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--noise-primary-note-sat\");\r\n                    const noisePrimaryNoteSatScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--noise-primary-note-sat-scale\");\r\n                    const noisePrimaryNoteLum: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--noise-primary-note-lum\");\r\n                    const noisePrimaryNoteLumScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--noise-primary-note-lum-scale\");\r\n\r\n                    let newChannelSecondary: string = \"hsl(\" + ((+noiseSecondaryChannelHue + (((channel - song.pitchChannelCount) * +noiseSecondaryChannelHueScale) / Config.noiseChannelCountMax) * 256) % 256) + \",\"\r\n                        + (+noiseSecondaryChannelSat + channel * +noiseSecondaryChannelSatScale) + \"%,\"\r\n                        + (+noiseSecondaryChannelLum + channel * +noiseSecondaryChannelLumScale) + \"%)\";\r\n                    let newChannelPrimary: string = \"hsl(\" + ((+noisePrimaryChannelHue + (((channel - song.pitchChannelCount) * +noisePrimaryChannelHueScale) / Config.noiseChannelCountMax) * 256) % 256) + \",\"\r\n                        + (+noisePrimaryChannelSat + channel * +noisePrimaryChannelSatScale) + \"%,\"\r\n                        + (+noisePrimaryChannelLum + channel * +noisePrimaryChannelLumScale) + \"%)\";\r\n                    let newNoteSecondary: string = \"hsl(\" + ((+noiseSecondaryNoteHue + (((channel - song.pitchChannelCount) * +noiseSecondaryNoteHueScale) / Config.noiseChannelCountMax) * 256) % 256) + \",\"\r\n                        + (+noiseSecondaryNoteSat + channel * +noiseSecondaryNoteSatScale) + \"%,\"\r\n                        + (+noiseSecondaryNoteLum + channel * +noiseSecondaryNoteLumScale) + \"%)\";\r\n                    let newNotePrimary: string = \"hsl(\" + ((+noisePrimaryNoteHue + (((channel - song.pitchChannelCount) * +noisePrimaryNoteHueScale) / Config.noiseChannelCountMax) * 256) % 256) + \",\"\r\n                        + (+noisePrimaryNoteSat + channel * +noisePrimaryNoteSatScale) + \"%,\"\r\n                        + (+noisePrimaryNoteLum + channel * +noisePrimaryNoteLumScale) + \"%)\";\r\n\r\n                    let newChannelColors = <ChannelColors>{ secondaryChannel: newChannelSecondary, primaryChannel: newChannelPrimary, secondaryNote: newNoteSecondary, primaryNote: newNotePrimary };\r\n                    ColorConfig.colorLookup.set(channel, newChannelColors);\r\n                    return newChannelColors;\r\n                }\r\n                else {\r\n                    // Mod formula\r\n                    const modSecondaryChannelHue: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--mod-secondary-channel-hue\");\r\n                    const modSecondaryChannelHueScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--mod-secondary-channel-hue-scale\");\r\n                    const modSecondaryChannelSat: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--mod-secondary-channel-sat\");\r\n                    const modSecondaryChannelSatScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--mod-secondary-channel-sat-scale\");\r\n                    const modSecondaryChannelLum: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--mod-secondary-channel-lum\");\r\n                    const modSecondaryChannelLumScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--mod-secondary-channel-lum-scale\");\r\n                    const modPrimaryChannelHue: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--mod-primary-channel-hue\");\r\n                    const modPrimaryChannelHueScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--mod-primary-channel-hue-scale\");\r\n                    const modPrimaryChannelSat: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--mod-primary-channel-sat\");\r\n                    const modPrimaryChannelSatScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--mod-primary-channel-sat-scale\");\r\n                    const modPrimaryChannelLum: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--mod-primary-channel-lum\");\r\n                    const modPrimaryChannelLumScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--mod-primary-channel-lum-scale\");\r\n                    const modSecondaryNoteHue: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--mod-secondary-note-hue\");\r\n                    const modSecondaryNoteHueScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--mod-secondary-note-hue-scale\");\r\n                    const modSecondaryNoteSat: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--mod-secondary-note-sat\");\r\n                    const modSecondaryNoteSatScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--mod-secondary-note-sat-scale\");\r\n                    const modSecondaryNoteLum: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--mod-secondary-note-lum\");\r\n                    const modSecondaryNoteLumScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--mod-secondary-note-lum-scale\");\r\n                    const modPrimaryNoteHue: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--mod-primary-note-hue\");\r\n                    const modPrimaryNoteHueScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--mod-primary-note-hue-scale\");\r\n                    const modPrimaryNoteSat: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--mod-primary-note-sat\");\r\n                    const modPrimaryNoteSatScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--mod-primary-note-sat-scale\");\r\n                    const modPrimaryNoteLum: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--mod-primary-note-lum\");\r\n                    const modPrimaryNoteLumScale: number = +getComputedStyle(this._styleElement).getPropertyValue(\"--mod-primary-note-lum-scale\");\r\n\r\n                    let newChannelSecondary: string = \"hsl(\" + ((+modSecondaryChannelHue + (((channel - song.pitchChannelCount - song.noiseChannelCount) * +modSecondaryChannelHueScale) / Config.modChannelCountMax) * 256) % 256) + \",\"\r\n                        + (+modSecondaryChannelSat + channel * +modSecondaryChannelSatScale) + \"%,\"\r\n                        + (+modSecondaryChannelLum + channel * +modSecondaryChannelLumScale) + \"%)\";\r\n                    let newChannelPrimary: string = \"hsl(\" + ((+modPrimaryChannelHue + (((channel - song.pitchChannelCount - song.noiseChannelCount) * +modPrimaryChannelHueScale) / Config.modChannelCountMax) * 256) % 256) + \",\"\r\n                        + (+modPrimaryChannelSat + channel * +modPrimaryChannelSatScale) + \"%,\"\r\n                        + (+modPrimaryChannelLum + channel * +modPrimaryChannelLumScale) + \"%)\";\r\n                    let newNoteSecondary: string = \"hsl(\" + ((+modSecondaryNoteHue + (((channel - song.pitchChannelCount - song.noiseChannelCount) * +modSecondaryNoteHueScale) / Config.modChannelCountMax) * 256) % 256) + \",\"\r\n                        + (+modSecondaryNoteSat + channel * +modSecondaryNoteSatScale) + \"%,\"\r\n                        + (+modSecondaryNoteLum + channel * +modSecondaryNoteLumScale) + \"%)\";\r\n                    let newNotePrimary: string = \"hsl(\" + ((+modPrimaryNoteHue + (((channel - song.pitchChannelCount - song.noiseChannelCount) * +modPrimaryNoteHueScale) / Config.modChannelCountMax) * 256) % 256) + \",\"\r\n                        + (+modPrimaryNoteSat + channel * +modPrimaryNoteSatScale) + \"%,\"\r\n                        + (+modPrimaryNoteLum + channel * +modPrimaryNoteLumScale) + \"%)\";\r\n\r\n                    let newChannelColors = <ChannelColors>{ secondaryChannel: newChannelSecondary, primaryChannel: newChannelPrimary, secondaryNote: newNoteSecondary, primaryNote: newNotePrimary };\r\n                    ColorConfig.colorLookup.set(channel, newChannelColors);\r\n                    return newChannelColors;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    private static readonly _styleElement: HTMLStyleElement = document.head.appendChild(HTML.style({ type: \"text/css\" }));\r\n\r\n    public static setTheme(name: string): void {\r\n\t\tlet theme: string = this.themes[name];\r\n\t\tif (theme == undefined) theme = this.themes[\"dark classic\"];\r\n\t\tthis._styleElement.textContent = theme;\r\n\r\n        const themeColor = <HTMLMetaElement>document.querySelector(\"meta[name='theme-color']\");\r\n        if (themeColor != null) {\r\n            themeColor.setAttribute(\"content\", getComputedStyle(document.documentElement).getPropertyValue('--ui-widget-background'));\r\n        }\r\n\r\n        this.resetColors();\r\n    }\r\n\r\n    public static getComputed(name: string): string {\r\n        return getComputedStyle(this._styleElement).getPropertyValue(name);\r\n    }\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {ColorConfig} from \"./ColorConfig\";\r\nimport {HTML} from \"imperative-html/dist/esm/elements-strict\";\r\n\r\n\r\n// Determine if the user's browser/OS adds scrollbars that occupy space.\r\n// See: https://www.filamentgroup.com/lab/scrollbars/\r\nconst scrollBarTest: HTMLDivElement = document.body.appendChild(HTML.div({ style: \"width:30px; height:30px; overflow: auto;\" },\r\n\tHTML.div({ style: \"width:100%;height:40px\" }),\r\n));\r\nif ((<any>scrollBarTest).firstChild.clientWidth < 30) {\r\n\tdocument.documentElement.classList.add(\"obtrusive-scrollbars\");\r\n}\r\ndocument.body.removeChild(scrollBarTest);\r\n\r\n\r\ndocument.head.appendChild(HTML.style({ type: \"text/css\" }, `\r\n\r\n/* Note: \"#\" symbols need to be encoded as \"%23\" in SVG data urls, otherwise they are interpreted as fragment identifiers! */\r\n:root {\r\n\t--button-size: 26px;\r\n\t--settings-area-width: 192px;\r\n\t--play-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><path d=\"M -5 -8 L -5 8 L 8 0 z\" fill=\"gray\"/></svg>');\r\n\t--pause-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><rect x=\"-5\" y=\"-7\" width=\"4\" height=\"14\" fill=\"gray\"/><rect x=\"3\" y=\"-7\" width=\"4\" height=\"14\" fill=\"gray\"/></svg>');\r\n\t--record-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><circle cx=\"0\" cy=\"0\" r=\"6\" fill=\"gray\"/></svg>');\r\n\t--stop-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><rect x=\"-6\" y=\"-6\" width=\"12\" height=\"12\" fill=\"gray\"/></svg>');\r\n\t--prev-bar-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><rect x=\"-6\" y=\"-6\" width=\"2\" height=\"12\" fill=\"gray\"/><path d=\"M 6 -6 L 6 6 L -3 0 z\" fill=\"gray\"/></svg>');\r\n\t--next-bar-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><rect x=\"4\" y=\"-6\" width=\"2\" height=\"12\" fill=\"gray\"/><path d=\"M -6 -6 L -6 6 L 3 0 z\" fill=\"gray\"/></svg>');\r\n\t--volume-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"0 0 26 26\"><path d=\"M 4 16 L 4 10 L 8 10 L 13 5 L 13 21 L 8 16 z M 15 11 L 16 10 A 7.2 7.2 0 0 1 16 16 L 15 15 A 5.8 5.8 0 0 0 15 12 z M 18 8 L 19 7 A 11.5 11.5 0 0 1 19 19 L 18 18 A 10.1 10.1 0 0 0 18 8 z\" fill=\"gray\"/></svg>');\r\n\t--unmuted-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"3 3 20 20\"><path d=\"M 4 16 L 4 10 L 8 10 L 13 5 L 13 21 L 8 16 z M 15 11 L 16 10 A 7.2 7.2 0 0 1 16 16 L 15 15 A 5.8 5.8 0 0 0 15 12 z M 18 8 L 19 7 A 11.5 11.5 0 0 1 19 19 L 18 18 A 10.1 10.1 0 0 0 18 8 z\" fill=\"gray\"/></svg>');\r\n\t--muted-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"3 3 20 20\"><path d=\"M 4 16 L 4 10 L 8 10 L 13 5 L 13 21 L 8 16 z\" fill=\"gray\"/></svg>');\r\n\t--menu-down-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><path d=\"M -4 -2 L 4 -2 L 0 3 z\" fill=\"gray\"/></svg>');\r\n\t--select-arrows-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><path d=\"M -4 -3 L 4 -3 L 0 -8 z M -4 3 L 4 3 L 0 8 z\" fill=\"gray\"/></svg>');\r\n\t--file-page-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-5 -21 26 26\"><path d=\"M 2 0 L 2 -16 L 10 -16 L 14 -12 L 14 0 z M 3 -1 L 13 -1 L 13 -11 L 9 -11 L 9 -15 L 3 -15 z\" fill=\"gray\"/></svg>');\r\n\t--edit-pencil-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-5 -21 26 26\"><path d=\"M 0 0 L 1 -4 L 4 -1 z M 2 -5 L 10 -13 L 13 -10 L 5 -2 zM 11 -14 L 13 -16 L 14 -16 L 16 -14 L 16 -13 L 14 -11 z\" fill=\"gray\"/></svg>');\r\n\t--preferences-gear-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><path d=\"M 5.78 -1.6 L 7.93 -0.94 L 7.93 0.94 L 5.78 1.6 L 4.85 3.53 L 5.68 5.61 L 4.21 6.78 L 2.36 5.52 L 0.27 5.99 L -0.85 7.94 L -2.68 7.52 L -2.84 5.28 L -4.52 3.95 L -6.73 4.28 L -7.55 2.59 L -5.9 1.07 L -5.9 -1.07 L -7.55 -2.59 L -6.73 -4.28 L -4.52 -3.95 L -2.84 -5.28 L -2.68 -7.52 L -0.85 -7.94 L 0.27 -5.99 L 2.36 -5.52 L 4.21 -6.78 L 5.68 -5.61 L 4.85 -3.53 M 2.92 0.67 L 2.92 -0.67 L 2.35 -1.87 L 1.3 -2.7 L 0 -3 L -1.3 -2.7 L -2.35 -1.87 L -2.92 -0.67 L -2.92 0.67 L -2.35 1.87 L -1.3 2.7 L -0 3 L 1.3 2.7 L 2.35 1.87 z\" fill=\"gray\"/></svg>');\r\n\t--customize-dial-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"> \\\r\n\t\t\t<g transform=\"translate(0,1)\" fill=\"gray\"> \\\r\n\t\t\t\t<circle cx=\"0\" cy=\"0\" r=\"6.5\" stroke=\"gray\" stroke-width=\"1\" fill=\"none\"/> \\\r\n\t\t\t\t<rect x=\"-1\" y=\"-5\" width=\"2\" height=\"4\" transform=\"rotate(30)\"/> \\\r\n\t\t\t\t<circle cx=\"-7.79\" cy=\"4.5\" r=\"0.75\"/> \\\r\n\t\t\t\t<circle cx=\"-9\" cy=\"0\" r=\"0.75\"/> \\\r\n\t\t\t\t<circle cx=\"-7.79\" cy=\"-4.5\" r=\"0.75\"/> \\\r\n\t\t\t\t<circle cx=\"-4.5\" cy=\"-7.79\" r=\"0.75\"/> \\\r\n\t\t\t\t<circle cx=\"0\" cy=\"-9\" r=\"0.75\"/> \\\r\n\t\t\t\t<circle cx=\"4.5\" cy=\"-7.79\" r=\"0.75\"/> \\\r\n\t\t\t\t<circle cx=\"7.79\" cy=\"-4.5\" r=\"0.75\"/> \\\r\n\t\t\t\t<circle cx=\"9\" cy=\"0\" r=\"0.75\"/> \\\r\n\t\t\t\t<circle cx=\"7.79\" cy=\"4.5\" r=\"0.75\"/> \\\r\n\t\t\t</g> \\\r\n\t\t</svg>');\r\n\t--instrument-copy-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-5 -21 26 26\"><path d=\"M 0 -15 L 1 -15 L 1 0 L 13 0 L 13 1 L 0 1 L 0 -15 z M 2 -1 L 2 -17 L 10 -17 L 14 -13 L 14 -1 z M 3 -2 L 13 -2 L 13 -12 L 9 -12 L 9 -16 L 3 -16 z\" fill=\"currentColor\"></path></svg>');\r\n\t--instrument-paste-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"0 0 26 26\"><path d=\"M 8 18 L 6 18 L 6 5 L 17 5 L 17 7 M 9 8 L 16 8 L 20 12 L 20 22 L 9 22 z\" stroke=\"currentColor\" fill=\"none\"></path><path d=\"M 9 3 L 14 3 L 14 6 L 9 6 L 9 3 z M 16 8 L 20 12 L 16 12 L 16 8 z\" fill=\"currentColor\"></path></svg>');\r\n\t--export-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><path fill=\"gray\" d=\"M -8 3 L -8 8 L 8 8 L 8 3 L 6 3 L 6 6 L -6 6 L -6 3 z M 0 2 L -4 -2 L -1 -2 L -1 -8 L 1 -8 L 1 -2 L 4 -2 z\"/></svg>');\r\n\t--close-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><path fill=\"gray\" d=\"M -7.07 -5.66 L -5.66 -7.07 L 0 -1.4 L 5.66 -7.07 L 7.07 -5.66 L 1.4 0 L 7.07 5.66 L 5.66 7.07 L 0 1.4 L -5.66 7.07 L -7.07 5.66 L -1.4 0 z\"/></svg>');\r\n\t--add-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><path fill=\"gray\" d=\"M -8 -1 L -1 -1 L -1 -8  L 1 -8 L 1 -1 L 8 -1 L 8 1 L 1 1 L 1 8 L -1 8 L -1 1 L -8 1 z\"/></svg>');\r\n\t--zoom-in-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"-10 -10 20 20\"><circle cx=\"-1\" cy=\"-1\" r=\"6\" stroke-width=\"2\" stroke=\"gray\" fill=\"none\"></circle><path stroke=\"gray\" stroke-width=\"2\" d=\"M 3 3 L 7 7 M -1 -4 L -1 2 M -4 -1 L 2 -1\" fill=\"none\"></path></svg>');\r\n\t--zoom-out-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"-10 -10 20 20\"><circle cx=\"-1\" cy=\"-1\" r=\"6\" stroke-width=\"2\" stroke=\"gray\" fill=\"none\"></circle><path stroke=\"gray\" stroke-width=\"2\" d=\"M 3 3 L 7 7 M -4 -1 L 2 -1\" fill=\"none\"></path></svg>');\r\n\t--checkmark-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><path fill=\"gray\" d=\"M -9 -2 L -8 -3 L -3 2 L 9 -8 L 10 -7 L -3 8 z\"/></svg>');\r\n\t--drum-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"32\" height=\"40\" viewBox=\"0 0 32 40\"> \\\r\n\t\t\t<defs> \\\r\n\t\t\t\t<linearGradient id=\"gold1\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"0%\"> \\\r\n\t\t\t\t\t<stop offset=\"0%\" stop-color=\"%237e3302\"/> \\\r\n\t\t\t\t\t<stop offset=\"40%\" stop-color=\"%23ffec6b\"/> \\\r\n\t\t\t\t\t<stop offset=\"100%\" stop-color=\"%237e3302\"/> \\\r\n\t\t\t\t</linearGradient> \\\r\n\t\t\t\t<linearGradient id=\"gold2\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"0%\"> \\\r\n\t\t\t\t\t<stop offset=\"0%\" stop-color=\"%23faaf7d\"/> \\\r\n\t\t\t\t\t<stop offset=\"15%\" stop-color=\"%23fffba9\"/> \\\r\n\t\t\t\t\t<stop offset=\"40%\" stop-color=\"%23ffffe3\"/> \\\r\n\t\t\t\t\t<stop offset=\"65%\" stop-color=\"%23fffba9\"/> \\\r\n\t\t\t\t\t<stop offset=\"100%\" stop-color=\"%23faaf7d\"/> \\\r\n\t\t\t\t</linearGradient> \\\r\n\t\t\t\t<radialGradient id=\"gold3\" cx=\"0%\" cy=\"0%\" r=\"100%\"> \\\r\n\t\t\t\t\t<stop offset=\"0%\" stop-color=\"%23ffffe3\"/> \\\r\n\t\t\t\t\t<stop offset=\"50%\" stop-color=\"%23ffec6b\"/> \\\r\n\t\t\t\t\t<stop offset=\"100%\" stop-color=\"%237e3302\"/> \\\r\n\t\t\t\t</radialGradient> \\\r\n\t\t\t\t<linearGradient id=\"red\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"0%\"> \\\r\n\t\t\t\t\t<stop offset=\"0%\" stop-color=\"%23641919\"/> \\\r\n\t\t\t\t\t<stop offset=\"40%\" stop-color=\"%23cd2c2c\"/> \\\r\n\t\t\t\t\t<stop offset=\"100%\" stop-color=\"%23641919\"/> \\\r\n\t\t\t\t</linearGradient> \\\r\n\t\t\t\t<radialGradient id=\"membrane\"> \\\r\n\t\t\t\t\t<stop offset=\"10%\" stop-color=\"%23cccccc\" /> \\\r\n\t\t\t\t\t<stop offset=\"90%\" stop-color=\"%23f6f6f7\" /> \\\r\n\t\t\t\t\t<stop offset=\"100%\" stop-color=\"%23999\" /> \\\r\n\t\t\t\t</radialGradient> \\\r\n\t\t\t</defs> \\\r\n\t\t\t<ellipse cx=\"16\" cy=\"26\" rx=\"16\" ry=\"14\" fill=\"rgba(0,0,0,0.5)\"/> \\\r\n\t\t\t<ellipse cx=\"16\" cy=\"25\" rx=\"16\" ry=\"14\" fill=\"url(%23gold1)\"/> \\\r\n\t\t\t<rect x=\"0\" y=\"23\" width=\"32\" height=\"2\" fill=\"url(%23gold1)\"/> \\\r\n\t\t\t<ellipse cx=\"16\" cy=\"23\" rx=\"16\" ry=\"14\" fill=\"url(%23gold2)\"/> \\\r\n\t\t\t<ellipse cx=\"16\" cy=\"23\" rx=\"15\" ry=\"13\" fill=\"url(%23red)\"/> \\\r\n\t\t\t<rect x=\"1\" y=\"17\" width=\"30\" height=\"6\" fill=\"url(%23red)\"/> \\\r\n\t\t\t<rect x=\"5\" y=\"27\" width=\"1\" height=\"5\" rx=\"0.5\" fill=\"rgba(0,0,0,0.5)\"/> \\\r\n\t\t\t<rect x=\"15\" y=\"31\" width=\"2\" height=\"5\" rx=\"1\" fill=\"rgba(0,0,0,0.5)\"/> \\\r\n\t\t\t<rect x=\"26\" y=\"27\" width=\"1\" height=\"5\" rx=\"0.5\" fill=\"rgba(0,0,0,0.5)\"/> \\\r\n\t\t\t<rect x=\"5\" y=\"26\" width=\"1\" height=\"5\" rx=\"0.5\" fill=\"url(%23gold3)\"/> \\\r\n\t\t\t<rect x=\"15\" y=\"30\" width=\"2\" height=\"5\" rx=\"1\" fill=\"url(%23gold3)\"/> \\\r\n\t\t\t<rect x=\"26\" y=\"26\" width=\"1\" height=\"5\" rx=\"0.5\" fill=\"url(%23gold3)\"/> \\\r\n\t\t\t<ellipse cx=\"16\" cy=\"18\" rx=\"15\" ry=\"13\" fill=\"rgba(0,0,0,0.5)\"/> \\\r\n\t\t\t<ellipse cx=\"16\" cy=\"16\" rx=\"16\" ry=\"14\" fill=\"url(%23gold1)\"/> \\\r\n\t\t\t<rect x=\"0\" y=\"14\" width=\"32\" height=\"2\" fill=\"url(%23gold1)\"/> \\\r\n\t\t\t<ellipse cx=\"16\" cy=\"14\" rx=\"16\" ry=\"14\" fill=\"url(%23gold2)\"/> \\\r\n\t\t\t<ellipse cx=\"16\" cy=\"14\" rx=\"15\" ry=\"13\" fill=\"url(%23membrane)\"/> \\\r\n\t\t</svg>');\r\n\t--piano-key-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"32\" height=\"15\" preserveAspectRatio=\"none\" viewBox=\"0 -1 32 15\"> \\\r\n\t\t\t<defs> \\\r\n\t\t\t\t<linearGradient id=\"shadow\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"0%\"> \\\r\n\t\t\t\t\t<stop offset=\"0%\" stop-color=\"rgba(0,0,0,0.5)\"/> \\\r\n\t\t\t\t\t<stop offset=\"100%\" stop-color=\"transparent\"/> \\\r\n\t\t\t\t</linearGradient> \\\r\n\t\t\t</defs> \\\r\n\t\t\t<rect x=\"-1\" y=\"1\" width=\"31\" height=\"1\" rx=\"0.6\" fill=\"rgba(255,255,255,0.4)\"/> \\\r\n\t\t\t<path d=\"M -1 11 L 30 11 L 30 2 L 33 -1 L 33 14 L -1 14 z\" fill=\"rgba(0,0,0,0.7)\"/> \\\r\n\t\t\t<rect x=\"-1\" y=\"-1\" width=\"19\" height=\"15\" fill=\"url(%23shadow)\"/> \\\r\n\t\t</svg>');\r\n  --mod-key-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"32\" height=\"80\" preserveAspectRatio=\"none\" viewBox=\"0 -1 32 80\"> \\\r\n\t\t\t<defs> \\\r\n\t\t\t\t<linearGradient id=\"shadow\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"0%\"> \\\r\n\t\t\t\t\t<stop offset=\"0%\" stop-color=\"rgba(0,0,0,0.4)\"/> \\\r\n\t\t\t\t\t<stop offset=\"100%\" stop-color=\"transparent\"/> \\\r\n\t\t\t\t</linearGradient> \\\r\n\t\t\t</defs> \\\r\n\t\t\t<rect x=\"-1\" y=\"1\" width=\"31\" height=\"1\" rx=\"0.6\" fill=\"rgba(255,255,255,0.2)\"/> \\\r\n\t\t\t<path d=\"M -1 76 L 30 76 L 30 1 L 33 -1 L 33 80 L -1 80 z\" fill=\"rgba(0,0,0,0.7)\"/> \\\r\n\t\t\t<rect x=\"-1\" y=\"-1\" width=\"19\" height=\"80\" fill=\"url(%23shadow)\"/> \\\r\n\t\t</svg>');\r\n}\r\n\r\n\r\n.obtrusive-scrollbars, .obtrusive-scrollbars * {\r\n\tscrollbar-width: thin;\r\n\tscrollbar-color: ${ColorConfig.uiWidgetBackground} ${ColorConfig.editorBackground};\r\n}\r\n.obtrusive-scrollbars::-webkit-scrollbar, .obtrusive-scrollbars *::-webkit-scrollbar {\r\n\twidth: 12px;\r\n}\r\n.obtrusive-scrollbars::-webkit-scrollbar-track, .obtrusive-scrollbars *::-webkit-scrollbar-track {\r\n\tbackground: ${ColorConfig.editorBackground};\r\n}\r\n.obtrusive-scrollbars::-webkit-scrollbar-thumb, .obtrusive-scrollbars *::-webkit-scrollbar-thumb {\r\n\tbackground-color: ${ColorConfig.uiWidgetBackground};\r\n\tborder: 3px solid ${ColorConfig.editorBackground};\r\n}\r\n\r\n@-moz-document url-prefix() {\r\n\t.muteButtonText {\r\n\t\ttransform: translate(3px, 1px) !important;\r\n\t}\r\n}\r\n\r\n.beepboxEditor {\r\n\tdisplay: grid;\r\n    grid-template-columns: minmax(0, 1fr) max-content;\r\n    grid-template-rows: max-content 1fr; /* max-content minmax(0, 1fr); Chrome 80 grid layout regression. https://bugs.chromium.org/p/chromium/issues/detail?id=1050307 */\r\n    grid-template-areas: \"pattern-area settings-area\" \"track-area settings-area\";\r\n\tgrid-column-gap: 6px;\r\n\tgrid-row-gap: 6px;\r\n\tposition: relative;\r\n\ttouch-action: manipulation;\r\n\tcursor: default;\r\n\tfont-size: 13px;\r\n\toverflow: hidden;\r\n\tcolor: ${ColorConfig.primaryText};\r\n\tbackground: ${ColorConfig.editorBackground};\r\n    opacity: 0;\r\n    -webkit-transition: opacity 0.2s ease-in;\r\n    -moz-transition: opacity 0.2s ease-in;\r\n    -o-transition: opacity 0.2s ease-in;\r\n    -ms-transition: opacity 0.2s ease-in;\r\n    transition: opacity 0.2s ease-in;\r\n    transition-delay: 0s;\r\n}\r\n\r\n.beepboxEditor .operatorRow {\r\n\tmargin: 2px 0;\r\n\theight: 2em;\r\n\tdisplay: flex;\r\n\tflex-direction: row;\r\n\talign-items: center;\r\n}\r\n\r\n.beepboxEditor .operatorRow > * {\r\n\tflex-grow: 1;\r\n\tflex-shrink: 1;\r\n}\r\n\r\n.pattern-area {\r\n     opacity: 0;\r\n    -webkit-transition: opacity 0.5s ease-in;\r\n    -moz-transition: opacity 0.5s ease-in;\r\n    -o-transition: opacity 0.5s ease-in;\r\n    -ms-transition: opacity 0.5s ease-in;\r\n    transition: opacity 0.5s ease-in;\r\n    transition-delay: 0s;\r\n}\r\n\r\n.settings-area {\r\n    opacity: 0;\r\n    -webkit-transition: opacity 0.5s ease-in;\r\n    -moz-transition: opacity 0.5s ease-in;\r\n    -o-transition: opacity 0.5s ease-in;\r\n    -ms-transition: opacity 0.5s ease-in;\r\n    transition: opacity 0.5s ease-in;\r\n    transition-delay: 0.15s;\r\n}\r\n\r\n.editor-song-settings {\r\n    opacity: 0;\r\n    -webkit-transition: opacity 0.5s ease-in;\r\n    -moz-transition: opacity 0.5s ease-in;\r\n    -o-transition: opacity 0.5s ease-in;\r\n    -ms-transition: opacity 0.5s ease-in;\r\n    transition: opacity 0.5s ease-in;\r\n    transition-delay: 0.35s;\r\n}\r\n\r\n.instrument-settings-area {\r\n    opacity: 0;\r\n    -webkit-transition: opacity 0.5s ease-in;\r\n    -moz-transition: opacity 0.5s ease-in;\r\n    -o-transition: opacity 0.5s ease-in;\r\n    -ms-transition: opacity 0.5s ease-in;\r\n    transition: opacity 0.5s ease-in;\r\n    transition-delay: 0.45s;\r\n}\r\n\r\n.trackAndMuteContainer {\r\n    opacity: 0;\r\n    -webkit-transition: opacity 0.5s ease-in;\r\n    -moz-transition: opacity 0.5s ease-in;\r\n    -o-transition: opacity 0.5s ease-in;\r\n    -ms-transition: opacity 0.5s ease-in;\r\n    transition: opacity 0.5s ease-in;\r\n    transition-delay: 0.4s;\r\n}\r\n\r\n.barScrollBar {\r\n    opacity: 0;\r\n    -webkit-transition: opacity 0.5s ease-in;\r\n    -moz-transition: opacity 0.5s ease-in;\r\n    -o-transition: opacity 0.5s ease-in;\r\n    -ms-transition: opacity 0.5s ease-in;\r\n    transition: opacity 0.5s ease-in;\r\n    transition-delay: 0.5s;\r\n}\r\n\r\n\r\n\r\n.load {\r\n    opacity: 1;\r\n}\r\n\r\n.beepboxEditor .noSelection {\r\n\t-webkit-touch-callout: none;\r\n\t-webkit-user-select: none;\r\n\t-moz-user-select: none;\r\n\t-ms-user-select: none;\r\n\tuser-select: none;\r\n}\r\n\r\n.beepboxEditor div {\r\n\tmargin: 0;\r\n\tpadding: 0;\r\n}\r\n\r\n.beepboxEditor .pattern-area {\r\n\tgrid-area: pattern-area;\r\n\theight: 481px;\r\n\tdisplay: flex;\r\n\tflex-direction: row;\r\n\tposition: relative;\r\n}\r\n\r\n.beepboxEditor .track-area {\r\n\tgrid-area: track-area;\r\n}\r\n\r\n.beepboxEditor .loopEditor {\r\n\theight: 20px;\r\n\tposition: sticky;\r\n\tbottom: 0;\r\n\tpadding: 5px 0;\r\n\tbackground-color: ${ColorConfig.editorBackground};\r\n}\r\n\r\n.beepboxEditor .settings-area {\r\n\tgrid-area: settings-area;\r\n\tdisplay: grid;\r\n    grid-template-columns: auto;\r\n    grid-template-rows: min-content min-content min-content min-content min-content;\r\n    grid-template-areas: \"version-area\" \"play-pause-area\" \"menu-area\" \"song-settings-area\" \"instrument-settings-area\";\r\n\tgrid-column-gap: 6px;\r\n}\r\n\r\n.beepboxEditor .version-area{ grid-area: version-area; }\r\n.beepboxEditor .play-pause-area{ grid-area: play-pause-area; }\r\n.beepboxEditor .menu-area{ grid-area: menu-area; }\r\n.beepboxEditor .song-settings-area{ grid-area: song-settings-area; }\r\n.beepboxEditor .instrument-settings-area{ grid-area: instrument-settings-area; }\r\n\r\n.beepboxEditor .tip {\r\n\tcursor: help;\r\n\tcolor: ${ColorConfig.secondaryText};\r\n\ttext-decoration: none;\r\n}\r\n\r\n.beepboxEditor .tip:hover {\r\n\tcolor: ${ColorConfig.linkAccent};\r\n\ttext-decoration: underline;\r\n}\r\n.beepboxEditor .tip:active {\r\n\tcolor: ${ColorConfig.primaryText};\r\n}\r\n\r\n.beepboxEditor .volume-speaker {\r\n\tflex-shrink: 0;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: ${ColorConfig.secondaryText};\r\n\t-webkit-mask-image: var(--volume-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--volume-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n\r\n.beepboxEditor .drum-button {\r\n\tflex: 1;\r\n\tbackground-color: transparent;\r\n\tbackground-image: var(--drum-symbol);\r\n\tbackground-repeat: no-repeat;\r\n\tbackground-position: center;\r\n}\r\n\r\n.beepboxEditor .modulator-button {\r\n\tflex: 1;\r\n\tposition: relative;\r\n\tdisplay: flex;\r\n\talign-items: center;\r\n}\r\n.beepboxEditor .modulator-button::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\tleft: 0;\r\n\ttop: 0;\r\n\twidth: 100%;\r\n\theight: 100%;\r\n\tpointer-events: none;\r\n\tbackground-image: var(--mod-key-symbol);\r\n\tbackground-repeat: no-repeat;\r\n\tbackground-position: center;\r\n\tbackground-size: 100% 102%;\r\n}\r\n\r\n.beepboxEditor .piano-button {\r\n\tflex: 1;\r\n\tposition: relative;\r\n\tdisplay: flex;\r\n\talign-items: center;\r\n}\r\n.beepboxEditor .piano-button::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\tleft: 0;\r\n\ttop: 0;\r\n\twidth: 100%;\r\n\theight: 100%;\r\n\tpointer-events: none;\r\n\tbackground-image: var(--piano-key-symbol);\r\n\tbackground-repeat: no-repeat;\r\n\tbackground-position: center;\r\n\tbackground-size: 100% 115.38%;\r\n}\r\n.beepboxEditor .piano-button.disabled::after {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\tright: 0;\r\n\ttop: 0;\r\n\twidth: 70%;\r\n\theight: 100%;\r\n\tpointer-events: none;\r\n\tbackground: ${ColorConfig.editorBackground};\r\n\t-webkit-mask-image: linear-gradient(90deg, transparent 0%, gray 70%, gray 100%);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: linear-gradient(90deg, transparent 0%, gray 70%, gray 100%);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n\r\n.beepboxEditor .piano-button.pressed, .beepboxEditor .drum-button.pressed {\r\n\tfilter: brightness(0.5);\r\n}\r\n\r\n.beepboxEditor .customize-instrument {\r\n\tmargin: 2px 0;\r\n}\r\n.beepboxEditor .customize-instrument::before {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tleft: 0;\r\n\ttop: 50%;\r\n\ttransform: translateY(-50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--customize-dial-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--customize-dial-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n\r\n.beepboxEditor .instrumentCopyPasteRow {\r\n\tgap: 2px;\r\n}\r\n\r\n.beepboxEditor .copy-instrument {\r\n\tmargin: 2px 0;\r\n\tflex-grow: 1;\r\n}\r\n.beepboxEditor .copy-instrument::before {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tleft: 0;\r\n\ttop: 50%;\r\n\ttransform: translateY(-50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--instrument-copy-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--instrument-copy-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n\r\n.beepboxEditor .paste-instrument {\r\n\tmargin: 2px 0;\r\n\tflex-grow: 1;\r\n}\r\n.beepboxEditor .paste-instrument::before {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tleft: 0;\r\n\ttop: 50%;\r\n\ttransform: translateY(-50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--instrument-paste-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--instrument-paste-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n\r\n.beepboxEditor .envelopeEditor {\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n}\r\n\r\n.beepboxEditor .envelope-row {\r\n\tdisplay: flex;\r\n\tmargin: 2px 0;\r\n\tgap: 2px;\r\n}\r\n\r\n.beepboxEditor .add-envelope {\r\n\twidth: var(--button-size);\r\n}\r\n.beepboxEditor .add-envelope::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tleft: 0;\r\n\ttop: 0;\r\n\tpointer-events: none;\r\n\tbackground: currentColor;\r\n\tmask-image: var(--add-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n\t-webkit-mask-image: var(--add-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n}\r\n.beepboxEditor .add-envelope:disabled {\r\n\tvisibility: hidden;\r\n}\r\n\r\n.beepboxEditor .effects-menu {\r\n\twidth: var(--button-size);\r\n\tposition: relative;\r\n}\r\n.beepboxEditor .effects-menu::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tleft: 0;\r\n\ttop: 0;\r\n\tpointer-events: none;\r\n\tbackground: currentColor;\r\n\tmask-image: var(--menu-down-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n\t-webkit-mask-image: var(--menu-down-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n}\r\n\r\n.beepboxEditor .zoomInButton, .beepboxEditor .zoomOutButton {\r\n\twidth: var(--button-size);\r\n\tposition: absolute;\r\n\tright: 10px;\r\n}\r\n.beepboxEditor .zoomInButton {\r\n\ttop: 10px;\r\n}\r\n.beepboxEditor .zoomOutButton {\r\n\ttop: 50px;\r\n}\r\n.beepboxEditor .zoomInButton::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tleft: 0;\r\n\ttop: 0;\r\n\tpointer-events: none;\r\n\tbackground: currentColor;\r\n\tmask-image: var(--zoom-in-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n\t-webkit-mask-image: var(--zoom-in-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n}\r\n.beepboxEditor .zoomOutButton::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tleft: 0;\r\n\ttop: 0;\r\n\tpointer-events: none;\r\n\tbackground: currentColor;\r\n\tmask-image: var(--zoom-out-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n\t-webkit-mask-image: var(--zoom-out-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n}\r\n\r\n.beepboxEditor .delete-envelope {\r\n\twidth: var(--button-size);\r\n\tflex-shrink: 0;\r\n\tflex-grow: 0;\r\n}\r\n.beepboxEditor .delete-envelope::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tleft: 0;\r\n\ttop: 0;\r\n\tpointer-events: none;\r\n\tbackground: currentColor;\r\n\tmask-image: var(--close-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n\t-webkit-mask-image: var(--close-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n}\r\n.beepboxEditor .delete-envelope:disabled {\r\n\tvisibility: hidden;\r\n}\r\n\r\n.beepboxEditor .menu.file::before {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tleft: 0;\r\n\ttop: 50%;\r\n\ttransform: translateY(-50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--file-page-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--file-page-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n\r\n.beepboxEditor .menu.edit::before {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tleft: 0;\r\n\ttop: 50%;\r\n\ttransform: translateY(-50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--edit-pencil-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--edit-pencil-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n\r\n.beepboxEditor .menu.preferences::before {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tleft: 0;\r\n\ttop: 50%;\r\n\ttransform: translateY(-50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--preferences-gear-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--preferences-gear-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n\r\n.beepboxEditor .mute-button {\r\n\tbackground: transparent;\r\n\tborder: none;\r\n  padding-right: 0px;\r\n  padding-left: 0px;\r\n  box-shadow: none;\r\n}\r\n\r\n.beepboxEditor .mute-button:focus {\r\n  background: transparent;\r\n\tborder: none;\r\n}\r\n\r\n.beepboxEditor .mute-button::before {\r\n\tcontent: \"\";\r\n\tpointer-events: none;\r\n\twidth: 100%;\r\n\theight: 100%;\r\n\tdisplay: inline-block;\r\n  background: var(--mute-button-normal);\r\n\t-webkit-mask-image: var(--unmuted-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\t-webkit-mask-size: cover;\r\n  mask-repeat: no-repeat;\r\n\tmask-position: center;\r\n\tmask-size: cover;\r\n  mask-image: var(--unmuted-symbol);\r\n}\r\n\r\n.beepboxEditor .mute-button.muted::before {\r\n  background: var(--ui-widget-background);\r\n\t-webkit-mask-image: var(--muted-symbol);\r\n  mask-image: var(--muted-symbol);\r\n}\r\n\r\n.beepboxEditor .mute-button.modMute.muted::before {\r\n  background: var(--ui-widget-background);\r\n\t-webkit-mask-image: var(--muted-symbol);\r\n  mask-image: var(--muted-symbol);\r\n}\r\n\r\n.beepboxEditor .mute-button.modMute::before {\r\n  background: var(--mute-button-mod);\r\n}\r\n\r\n\r\n.beepboxEditor .promptContainer {\r\n\tposition: absolute;\r\n\ttop: 0;\r\n\tleft: 0;\r\n\twidth: 100%;\r\n\theight: 100%;\r\n\tdisplay: flex;\r\n\tjustify-content: center;\r\n\talign-items: center;\r\n\tz-index: 100;\r\n}\r\n\r\n.beepboxEditor .promptContainer::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\ttop: 0;\r\n\tleft: 0;\r\n\twidth: 100%;\r\n\theight: 100%;\r\n\tbackground: ${ColorConfig.editorBackground};\r\n\topacity: 0.5;\r\n\tdisplay: flex;\r\n}\r\n\r\n.beepboxEditor .prompt {\r\n\tmargin: auto;\r\n\ttext-align: center;\r\n\tbackground: ${ColorConfig.editorBackground};\r\n\tborder-radius: 15px;\r\n\tborder: 4px solid ${ColorConfig.uiWidgetBackground};\r\n\tcolor: ${ColorConfig.primaryText};\r\n\tpadding: 20px;\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n\tposition: relative;\r\n\tbox-shadow: 5px 5px 20px 10px rgba(0,0,0,0.5);\r\n}\r\n\r\n.beepboxEditor .prompt > *:not(:first-child):not(.cancelButton) {\r\n\tmargin-top: 1.5em;\r\n}\r\n\r\n.beepboxEditor .prompt h2 {\r\n\tfont-size: 2em;\r\n\tmargin: 0 16px;\r\n\tfont-weight: normal;\r\n}\r\n\r\n.beepboxEditor .prompt p {\r\n\ttext-align: left;\r\n\tmargin: 1em 0;\r\n}\r\n\r\n.beepboxEditor .prompt label {\r\n\tcursor: pointer;\r\n}\r\n\r\n.beepboxEditor .prompt.recordingSetupPrompt p {\r\n\tmargin-top: 0.75em;\r\n\tmargin-bottom: 0;\r\n}\r\n\r\n.beepboxEditor .prompt.recordingSetupPrompt > label:not(:first-child):not(.cancelButton) {\r\n\tmargin: 2px 0;\r\n}\r\n\r\n.beepboxEditor .layout-option {\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n\tflex: 1;\r\n\tcursor: pointer;\r\n\tcolor: ${ColorConfig.secondaryText};\r\n}\r\n\r\n.beepboxEditor .layout-option input {\r\n\tdisplay: none;\r\n}\r\n\r\n.beepboxEditor .layout-option input:checked ~ * {\r\n\tcolor: ${ColorConfig.primaryText};\r\n}\r\n.beepboxEditor select.invalidSetting {\r\n\tborder: solid 1px red;\r\n}\r\n.beepboxEditor .selectContainer {\r\n\tposition: relative;\r\n}\r\n.beepboxEditor .selectContainer:not(.menu)::after {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tright: 0;\r\n\ttop: 50%;\r\n\ttransform: translateY(-50%);\r\n\tpointer-events: none;\r\n\twidth: 14px;\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--select-arrows-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--select-arrows-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n.beepboxEditor .selectContainer.menu::after {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tright: 0;\r\n\ttop: 50%;\r\n\ttransform: translateY(-50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--menu-down-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--menu-down-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n.beepboxEditor select {\r\n\tmargin: 0;\r\n\tpadding: 0 4px;\r\n\tdisplay: block;\r\n\theight: var(--button-size);\r\n\tborder: none;\r\n\tborder-radius: 5px;\r\n\tbackground: ${ColorConfig.uiWidgetBackground};\r\n\tcolor: inherit;\r\n\tfont-size: inherit;\r\n\tcursor: pointer;\r\n\tfont-family: inherit;\r\n\tfont-weight: inherit;\r\n\r\n\t-webkit-appearance:none;\r\n\t-moz-appearance: none;\r\n\tappearance: none;\r\n}\r\n.beepboxEditor select option:disabled {\r\n\tcolor: ${ColorConfig.linkAccent};\r\n\tfont-weight: bold;\r\n}\r\n\r\n.select2-container .select2-selection--single {\r\n  height: auto;\r\n}\r\n\r\n.select2-container {\r\n  width: -moz-available !important;\r\n  width: -webkit-fill-available !important;\r\n}\r\n\r\n.select2-container--default .select2-selection--single{\r\n  border-radius: 0px;\r\n  border: 0px;\r\n  background-color: transparent;\r\n  outline: none;\r\n}\r\n\r\n.select2-selection__rendered:not(.menu)::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\tright: 0.3em;\r\n\ttop: 0.4em;\r\n\tborder-bottom: 0.4em solid currentColor;\r\n\tborder-left: 0.3em solid transparent;\r\n\tborder-right: 0.3em solid transparent;\r\n\tpointer-events: none;\r\n}\r\n.select2-selection__rendered:not(.menu)::after {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\tright: 0.3em;\r\n\tbottom: 0.4em;\r\n\tborder-top: 0.4em solid currentColor;\r\n\tborder-left: 0.3em solid transparent;\r\n\tborder-right: 0.3em solid transparent;\r\n\tpointer-events: none;\r\n}\r\n.select2-selection__rendered {\r\n\tmargin: 0;\r\n\tpadding: 0 0.3em;\r\n\tdisplay: block;\r\n\theight: 2em;\r\n\tborder: none;\r\n\tborder-radius: 0.4em;\r\n\tbackground: ${ColorConfig.uiWidgetBackground};\r\n\tcolor: inherit !important;\r\n\tfont-size: inherit;\r\n\tcursor: pointer;\r\n\tfont-family: inherit;\r\n\t-webkit-appearance:none;\r\n\t-moz-appearance: none;\r\n\tappearance: none;\r\n}\r\n.select2-selection__arrow b{\r\n    display:none !important;\r\n}\r\n\r\n.select2-selection__rendered--focus {\r\n\tbackground: ${ColorConfig.uiWidgetFocus};\r\n\toutline: none;\r\n}\r\n.select2-search__field {\r\n    background: ${ColorConfig.uiWidgetBackground};\r\n    color: inherit !important;\r\n    font-size: small;\r\n    font-family: inherit;\r\n    border: 0px !important;\r\n    padding: 1px !important;\r\n}\r\n.select2-dropdown {\r\n    box-sizing: border-box;\r\n    display: inline-block;\r\n    margin: 0;\r\n    font-size: small;\r\n    position: relative;\r\n    vertical-align: middle;\r\n    background-color: ${ColorConfig.uiWidgetFocus};\r\n}\r\n\r\n.select2-container--default .select2-results>.select2-results__options {\r\n    max-height: 430px;\r\n    overflow-x: hidden;\r\n}\r\n.select2-container--default .select2-results__group {\r\n    cursor: default;\r\n    display: block;\r\n    padding: 1px;\r\n    background: ${ColorConfig.select2OptGroup};\r\n}\r\n.select2-results__option {\r\n    padding: 2px;\r\n    user-select: none;\r\n    -webkit-user-select: none;\r\n}\r\n.select2-container--default .select2-results__option .select2-results__option {\r\n    padding-left: 0.1em;\r\n}\r\n.select2-container--default .select2-results__option[aria-selected=true] {\r\n  background-color: transparent !important;\r\n}\r\n\r\n.select2-results__option--highlighted[aria-selected] {\r\n\tcolor: white !important;\r\n}\r\n\r\n.beepboxEditor .menu select {\r\n\tpadding: 0 var(--button-size);\r\n}\r\n.beepboxEditor select:focus {\r\n\tbackground: ${ColorConfig.uiWidgetFocus};\r\n\toutline: none;\r\n}\r\n.beepboxEditor .menu select {\r\n\ttext-align: center;\r\n\ttext-align-last: center;\r\n}\r\n.beepboxEditor .settings-area select {\r\n       width: 100%;\r\n}\r\n\r\n/* This makes it look better in firefox on my computer... What about others?\r\n@-moz-document url-prefix() {\r\n\t.beepboxEditor select { padding: 0 2px; }\r\n}\r\n*/\r\n.beepboxEditor button {\r\n\tmargin: 0;\r\n\tposition: relative;\r\n\theight: var(--button-size);\r\n\tborder: none;\r\n\tborder-radius: 5px;\r\n\tbackground: ${ColorConfig.uiWidgetBackground};\r\n\tcolor: inherit;\r\n\tfont-size: inherit;\r\n\tfont-family: inherit;\r\n\tfont-weight: inherit;\r\n\tcursor: pointer;\r\n}\r\n.beepboxEditor button:focus {\r\n\tbackground: ${ColorConfig.uiWidgetFocus};\r\n\toutline: none;\r\n}\r\n\r\n.beepboxEditor button.cancelButton {\r\n\tfloat: right;\r\n\twidth: var(--button-size);\r\n\tposition: absolute;\r\n\ttop: 8px;\r\n\tright: 8px;\r\n}\r\n\r\n.beepboxEditor .playback-bar-controls {\r\n\tdisplay: grid;\r\n\tgrid-template-columns: minmax(0, 1fr) minmax(0, 1fr) minmax(0, 1fr) minmax(0, 1fr);\r\n\tgrid-template-rows: min-content;\r\n\tgrid-column-gap: 4px;\r\n}\r\n\r\n.beepboxEditor button.playButton::before {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tleft: 0;\r\n\ttop: 50%;\r\n\ttransform: translateY(-50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--play-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--play-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n.beepboxEditor button.pauseButton::before {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tleft: 0;\r\n\ttop: 50%;\r\n\ttransform: translateY(-50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--pause-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--pause-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n.beepboxEditor button.recordButton::before {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tleft: 0;\r\n\ttop: 50%;\r\n\ttransform: translateY(-50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--record-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--record-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n.beepboxEditor button.stopButton::before {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tleft: 0;\r\n\ttop: 50%;\r\n\ttransform: translateY(-50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--stop-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--stop-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n\r\n.beepboxEditor button.prevBarButton::before {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tleft: 50%;\r\n\ttop: 50%;\r\n\ttransform: translate(-50%, -50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--prev-bar-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--prev-bar-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n\r\n.beepboxEditor button.nextBarButton::before {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tleft: 50%;\r\n\ttop: 50%;\r\n\ttransform: translate(-50%, -50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--next-bar-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--next-bar-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n\r\n.beepboxEditor button.playButton, .beepboxEditor button.pauseButton, .beepboxEditor button.recordButton, .beepboxEditor button.stopButton, .beepboxEditor button.okayButton, .beepboxEditor button.exportButton {\r\n\tpadding-left: var(--button-size);\r\n}\r\n.beepboxEditor button.playButton, .beepboxEditor button.pauseButton, .beepboxEditor button.recordButton {\r\n\tgrid-column-start: 1;\r\n\tgrid-column-end: 3;\r\n}\r\n.beepboxEditor button.stopButton {\r\n\tgrid-column-start: 1;\r\n\tgrid-column-end: 5;\r\n}\r\n.beepboxEditor button.prevBarButton {\r\n\tgrid-column-start: 3;\r\n\tgrid-column-end: 4;\r\n}\r\n.beepboxEditor button.nextBarButton {\r\n\tgrid-column-start: 4;\r\n\tgrid-column-end: 5;\r\n}\r\n\r\n.beepboxEditor button.playButton.shrunk, .beepboxEditor button.recordButton.shrunk {\r\n\tpadding: 0;\r\n}\r\n.beepboxEditor button.playButton.shrunk::before, .beepboxEditor button.recordButton.shrunk::before {\r\n\tleft: 50%;\r\n\ttop: 50%;\r\n\ttransform: translate(-50%, -50%);\r\n}\r\n.beepboxEditor button.playButton.shrunk span, .beepboxEditor button.recordButton.shrunk span {\r\n\tdisplay: none;\r\n}\r\n.beepboxEditor button.playButton.shrunk {\r\n\tgrid-column-start: 1;\r\n\tgrid-column-end: 2;\r\n}\r\n.beepboxEditor button.recordButton.shrunk {\r\n\tgrid-column-start: 2;\r\n\tgrid-column-end: 3;\r\n}\r\n\r\n.beepboxEditor button.cancelButton::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tleft: 0;\r\n\ttop: 0;\r\n\tpointer-events: none;\r\n\tbackground: currentColor;\r\n\tmask-image: var(--close-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n\t-webkit-mask-image: var(--close-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n}\r\n\r\n.beepboxEditor button.okayButton::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tleft: 0;\r\n\ttop: 0;\r\n\tpointer-events: none;\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--checkmark-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--checkmark-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n\r\n.beepboxEditor button.exportButton::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tleft: 0;\r\n\ttop: 0;\r\n\tpointer-events: none;\r\n\tbackground: currentColor;\r\n\tmask-image: var(--export-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n\t-webkit-mask-image: var(--export-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n}\r\n\r\n.beepboxEditor .instrument-bar {\r\n\tdisplay: flex;\r\n\tgap: 2px;\r\n}\r\n\r\n.beepboxEditor .instrument-bar button {\r\n\tflex-grow: 1;\r\n\tmin-width: 0;\r\n\tpadding: 0;\r\n\tflex-basis: 0;\r\n\tdisplay: flex;\r\n\talign-items: center;\r\n\tjustify-content: center;\r\n\tcolor: var(--text-color-lit);\r\n}\r\n\r\n.beepboxEditor .instrument-bar .remove-instrument, .beepboxEditor .instrument-bar .add-instrument {\r\n\tmax-width: var(--button-size);\r\n}\r\n\r\n.beepboxEditor .instrument-bar > :not(:first-child) {\r\n\tborder-top-left-radius: 0;\r\n\tborder-bottom-left-radius: 0;\r\n}\r\n\r\n.beepboxEditor .instrument-bar > :not(.last-button) {\r\n\tborder-top-right-radius: 0;\r\n\tborder-bottom-right-radius: 0;\r\n\tborder-bottom: inset;\r\n\tborder-color: var(--background-color-dim);\r\n}\r\n\r\n.beepboxEditor .instrument-bar .selected-instrument {\r\n\tbackground: var(--background-color-lit);\r\n\tcolor: ${ColorConfig.invertedText};\r\n}\r\n\r\n.beepboxEditor .instrument-bar .deactivated {\r\n\tbackground: ${ColorConfig.editorBackground};\r\n\tcolor: var(--text-color-dim);\r\n\tborder-bottom: unset;\r\n}\r\n\r\n.beepboxEditor .instrument-bar .deactivated.selected-instrument {\r\n\tbackground: var(--background-color-dim);\r\n\tcolor: ${ColorConfig.invertedText};\r\n}\r\n\r\n.beepboxEditor .instrument-bar .remove-instrument {\r\n\tborder-bottom: unset;\r\n}\r\n\r\n.beepboxEditor .instrument-bar .remove-instrument::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\twidth: 100%;\r\n\theight: var(--button-size);\r\n\tleft: 0;\r\n\ttop: 0;\r\n\tpointer-events: none;\r\n\tbackground: currentColor;\r\n\tmask-image: var(--close-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n\t-webkit-mask-image: var(--close-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n}\r\n\r\n.beepboxEditor .instrument-bar .add-instrument {\r\n\tborder-bottom: unset;\r\n}\r\n\r\n.beepboxEditor .instrument-bar .no-underline {\r\n\tborder-bottom: unset;\r\n}\r\n\r\n.beepboxEditor .instrument-bar .add-instrument::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\twidth: 100%;\r\n\theight: var(--button-size);\r\n\tleft: 0;\r\n\ttop: 0;\r\n\tpointer-events: none;\r\n\tbackground: currentColor;\r\n\tmask-image: var(--add-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n\t-webkit-mask-image: var(--add-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n}\r\n\r\n.beepboxEditor canvas {\r\n\toverflow: hidden;\r\n\tposition: absolute;\r\n\tdisplay: block;\r\n  cursor: crosshair;\r\n}\r\n\r\n@keyframes dash-animation {\r\n  to {\r\n    stroke-dashoffset: -100;\r\n  }\r\n}\r\n\r\n.beepboxEditor .dash-move {\r\n  animation: dash-animation 20s infinite linear;\r\n}\r\n\r\n.beepboxEditor .trackContainer {\r\n\tflex-grow: 1;\r\n}\r\n\r\n.beepboxEditor .trackAndMuteContainer {\r\n\tdisplay: flex;\r\n\talign-items: flex-start;\r\n\twidth: 100%;\r\n\tmin-height: 0;\r\n\tflex: 1;\r\n\toverflow-x: hidden;\r\n\tposition: relative;\r\n}\r\n\r\n.beepboxEditor .muteEditor {\r\n\twidth: 32px;\r\n\tflex-shrink: 0;\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n\talign-items: stretch;\r\n\tposition: sticky;\r\n\tleft: 0;\r\n\tz-index: 1;\r\n\tbackground: ${ColorConfig.editorBackground};\r\n}\r\n\r\n.beepboxEditor .selectRow, .beepboxEditor .instrumentCopyPasteRow {\r\n\tmargin: 2px 0;\r\n\theight: var(--button-size);\r\n\tdisplay: flex;\r\n\tflex-direction: row;\r\n\talign-items: center;\r\n\tjustify-content: space-between;\r\n}\r\n\r\n.beepboxEditor .selectRow > :last-child {\r\n\twidth: 62.5%;\r\n\tflex-shrink: 0;\r\n}\r\n\r\n.beepboxEditor .menu-area {\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n}\r\n.beepboxEditor .menu-area > * {\r\n\tmargin: 2px 0;\r\n}\r\n.beepboxEditor .menu-area > button {\r\n\tpadding: 0 var(--button-size);\r\n\twhite-space: nowrap;\r\n}\r\n\r\n.beepboxEditor .song-settings-area {\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n}\r\n\r\n.beepboxEditor .editor-controls {\r\n\tflex-shrink: 0;\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n}\r\n\r\n.beepboxEditor .instrument-settings-area {\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n}\r\n\r\n.beepboxEditor .editor-right-side-top > *, .beepboxEditor .editor-right-side-bottom > * {\r\n\tflex-shrink: 0;\r\n}\r\n\r\n.beepboxEditor .pitchShiftMarkerContainer {\r\n\tbox-sizing: border-box;\r\n\tdisplay: flex;\r\n\theight: 100%;\r\n\tleft: 3px;\r\n\tright: 3px;\r\n\tposition: absolute;\r\n\talign-items: center;\r\n\tpointer-events: none;\r\n}\r\n\r\n.beepboxEditor .pitchShiftMarker {\r\n\twidth: 0;\r\n\theight: 0;\r\n\tposition: absolute;\r\n}\r\n\r\n.beepboxEditor .pitchShiftMarker::before {\r\n\tcontent: \"\";\r\n\twidth: 2px;\r\n\theight: 20px;\r\n\ttransform: translate(-50%, -50%);\r\n\tposition: absolute;\r\n\tbackground: currentColor;\r\n\tborder-radius: 3px;\r\n}\r\n\r\n.beepboxEditor input[type=text], .beepboxEditor input[type=number] {\r\n\tfont-size: inherit;\r\n\tfont-weight: inherit;\r\n\tfont-family: inherit;\r\n\tbackground: transparent;\r\n\ttext-align: center;\r\n\tborder: 1px solid ${ColorConfig.inputBoxOutline};\r\n\tcolor: ${ColorConfig.primaryText};\r\n}\r\n\r\n.beepboxEditor input[type=text]::selection, .beepboxEditor input[type=number]::selection {\r\n\tbackground-color: ${ColorConfig.textSelection};\r\n\tcolor: ${ColorConfig.primaryText};\r\n}\r\n\r\n.beepboxEditor input[type=checkbox] {\r\n  transform: scale(1.5);\r\n}\r\n\r\n.beepboxEditor input[type=range] {\r\n\t-webkit-appearance: none;\r\n\tcolor: inherit;\r\n\twidth: 100%;\r\n\theight: var(--button-size);\r\n\tfont-size: inherit;\r\n\tmargin: 0;\r\n\tcursor: pointer;\r\n\tbackground: none;\r\n\ttouch-action: pan-y;\r\n  position: relative;\r\n}\r\n.beepboxEditor input[type=range]:focus {\r\n\toutline: none;\r\n}\r\n.beepboxEditor input[type=range]::-webkit-slider-runnable-track {\r\n\twidth: 100%;\r\n\theight: 6px;\r\n\tcursor: pointer;\r\n\tbackground: ${ColorConfig.uiWidgetBackground};\r\n}\r\n\r\n.modTarget:hover {\r\n\tfill: ${ColorConfig.hoverPreview} !important;\r\n}\r\n\r\n.beepboxEditor span.midTick:after {\r\n    content: \"\";\r\n    display:inline-block;\r\n    position: absolute;\r\n    background: currentColor;\r\n    width: 2%;\r\n    left: 49%;\r\n    height: 0.5em;\r\n    top: 32%;\r\n    z-index: 1;\r\n\t\tpointer-events: none;\r\n}\r\n.beepboxEditor span.modSlider {\r\n\t--mod-position: 20%;\r\n\t--mod-color: ${ColorConfig.overwritingModSlider};\r\n  --mod-border-radius: 0%;\r\n}\r\n.beepboxEditor span.modSlider:before {\r\n\tcontent: \"\";\r\n    display:inline-block;\r\n    position: absolute;\r\n    background: var(--mod-color);\r\n    width: 4%;\r\n    left: var(--mod-position);\r\n    height: 0.8em;\r\n    top: 28%;\r\n    z-index: 2;\r\n\t\ttransform: translate(-50%, 0%);\r\n\t\tpointer-events: none;\r\n\t\tborder: 40%;\r\n\t\tborder-radius: var(--mod-border-radius);\r\n}\r\n.beepboxEditor input[type=range]::-webkit-slider-thumb {\r\n\theight: var(--button-size);\r\n\twidth: 6px;\r\n\tborder-radius: 3px;\r\n\tbackground: currentColor;\r\n\tcursor: pointer;\r\n\t-webkit-appearance: none;\r\n\tmargin-top: -10px;\r\n}\r\n.beepboxEditor input[type=range]:focus::-webkit-slider-runnable-track {\r\n\tbackground: ${ColorConfig.uiWidgetFocus};\r\n}\r\n.beepboxEditor input[type=range]::-moz-range-track {\r\n\twidth: 100%;\r\n\theight: 6px;\r\n\tcursor: pointer;\r\n\tbackground: ${ColorConfig.uiWidgetBackground};\r\n}\r\n.beepboxEditor input[type=range]:focus::-moz-range-track {\r\n\tbackground: ${ColorConfig.uiWidgetFocus};\r\n}\r\n.beepboxEditor input[type=range]::-moz-range-thumb {\r\n\theight: var(--button-size);\r\n\twidth: 6px;\r\n\tborder-radius: 3px;\r\n\tborder: none;\r\n\tbackground: currentColor;\r\n\tcursor: pointer;\r\n}\r\n.beepboxEditor input[type=range]::-ms-track {\r\n\twidth: 100%;\r\n\theight: 6px;\r\n\tcursor: pointer;\r\n\tbackground: ${ColorConfig.uiWidgetBackground};\r\n\tborder-color: transparent;\r\n}\r\n.beepboxEditor input[type=range]:focus::-ms-track {\r\n\tbackground: ${ColorConfig.uiWidgetFocus};\r\n}\r\n.beepboxEditor input[type=range]::-ms-thumb {\r\n\theight: var(--button-size);\r\n\twidth: 6px;\r\n\tborder-radius: 3px;\r\n\tbackground: currentColor;\r\n\tcursor: pointer;\r\n}\r\n\r\nli.select2-results__option[role=group] > strong:hover {\r\n  background-color: #516fbb;\r\n}\r\n\r\n/* wide screen */\r\n@media (min-width: 711px) {\r\n\t#beepboxEditorContainer {\r\n\t\tdisplay: table;\r\n\t}\r\n\t.beepboxEditor {\r\n\t\tflex-direction: row;\r\n\t}\r\n\t.beepboxEditor:focus-within {\r\n\t\toutline: 3px solid ${ColorConfig.uiWidgetBackground};\r\n\t}\r\n\t.beepboxEditor .trackAndMuteContainer {\r\n\t\twidth: 512px;\r\n\t}\r\n\t.beepboxEditor .trackSelectBox {\r\n\t\tdisplay: none;\r\n\t}\r\n    .beepboxEditor .muteButtonSelectBox {\r\n\t\tdisplay: none;\r\n\t}\r\n\t.beepboxEditor .play-pause-area {\r\n\t\tdisplay: flex;\r\n\t\tflex-direction: column;\r\n\t}\r\n\t.beepboxEditor .playback-bar-controls {\r\n\t\tmargin: 2px 0;\r\n\t}\r\n\t.beepboxEditor .playback-volume-controls {\r\n\t\tdisplay: flex;\r\n\t\tflex-direction: row;\r\n\t\tmargin: 2px 0;\r\n\t\talign-items: center;\r\n\t}\r\n\t.beepboxEditor .settings-area {\r\n\t\twidth: var(--settings-area-width);\r\n\t}\r\n}\r\n\r\n/* narrow screen */\r\n@media (max-width: 710px) {\r\n\t.beepboxEditor {\r\n\t\tgrid-template-columns: minmax(0, 1fr);\r\n\t\tgrid-template-rows: min-content 6px min-content min-content;\r\n\t\tgrid-template-areas: \"pattern-area\" \".\" \"track-area\" \"settings-area\";\r\n\t\tgrid-row-gap: 0;\r\n\t}\r\n\t.beepboxEditor .settings-area {\r\n\t\tgrid-template-columns: minmax(0, 1fr) minmax(0, 1fr);\r\n\t\tgrid-template-rows: min-content min-content 1fr min-content;\r\n\t\tgrid-template-areas:\r\n\t\t\t\"play-pause-area play-pause-area\"\r\n\t\t\t\"menu-area instrument-settings-area\"\r\n\t\t\t\"song-settings-area instrument-settings-area\"\r\n\t\t\t\"version-area version-area\";\r\n\t\tgrid-column-gap: 8px;\r\n\t\tmargin: 0 4px;\r\n\t}\r\n\t.beepboxEditor:focus-within {\r\n\t\toutline: none;\r\n\t}\r\n\t.beepboxEditor .pattern-area {\r\n\t\tmax-height: 75vh;\r\n\t}\r\n\t.beepboxEditor .trackAndMuteContainer {\r\n\t\toverflow-x: auto;\r\n\t}\r\n\t.beepboxEditor .barScrollBar {\r\n\t\tdisplay: none;\r\n\t}\r\n\t.beepboxEditor .play-pause-area {\r\n\t\tdisplay: grid;\r\n\t\tgrid-template-columns: minmax(0, 1fr) minmax(0, 1fr);\r\n\t\tgrid-column-gap: 8px;\r\n\t\tmargin: 2px 0;\r\n\t}\r\n\t.beepboxEditor .playback-bar-controls {\r\n\t\tflex-grow: 1;\r\n\t}\r\n\t.beepboxEditor .playback-volume-controls {\r\n\t\tdisplay: flex;\r\n\t\tflex-direction: row;\r\n\t\talign-items: center;\r\n\t\tflex-grow: 1;\r\n\t}\r\n\t\r\n\t.beepboxEditor .soundIcon {\r\n\t  background: ${ColorConfig.editorBackground};\r\n\t  display: inline-block;\r\n\t  height: 10px;\r\n\t  margin-left: 0px;\r\n\t  margin-top: 8px;\r\n\t\tposition: relative;\r\n\t\twidth: 10px;\r\n\t}\r\n\t.beepboxEditor .soundIcon:before {\r\n\t  border-bottom: 6px solid transparent;\r\n\t  border-top: 6px solid transparent;\r\n\t  border-right: 10px solid ${ColorConfig.editorBackground};\r\n\t  content: \"\";\r\n\t  height: 10px;\r\n\t  left: 6px;\r\n\t  position: absolute;\r\n\t  top: -6px;\r\n\t  width: 0;\r\n\t}\r\n}\r\n\r\n`));\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\n\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { HTML, SVG } from \"imperative-html/dist/esm/elements-strict\";\r\nimport { ColorConfig } from \"./ColorConfig\";\r\n\r\nexport class BarScrollBar {\r\n\tprivate readonly _editorWidth: number = 512;\r\n\tprivate readonly _editorHeight: number = 20;\r\n\tprivate readonly _playhead: SVGRectElement = SVG.rect(\"rect\", { fill: ColorConfig.playhead, x: 0, y: 0, width: 2, height: this._editorHeight });\r\n\t\tprivate readonly _notches: SVGSVGElement = SVG.svg({\"pointer-events\": \"none\"});\r\n\t\tprivate readonly _handle: SVGRectElement = SVG.rect({fill: ColorConfig.uiWidgetBackground, x: 0, y: 2, width: 10, height: this._editorHeight - 4});\r\n\t\tprivate readonly _handleHighlight: SVGRectElement = SVG.rect({fill: \"none\", stroke: ColorConfig.hoverPreview, \"stroke-width\": 2, \"pointer-events\": \"none\", x: 0, y: 1, width: 10, height: this._editorHeight - 2});\r\n\t\tprivate readonly _leftHighlight: SVGPathElement = SVG.path({fill: ColorConfig.hoverPreview, \"pointer-events\": \"none\"});\r\n\t\tprivate readonly _rightHighlight: SVGPathElement = SVG.path({fill: ColorConfig.hoverPreview, \"pointer-events\": \"none\"});\r\n\tprivate _renderedPlayhead: number = -1;\r\n\t\t\r\n\t\tprivate readonly _svg: SVGSVGElement = SVG.svg({style: `background-color: ${ColorConfig.editorBackground}; touch-action: pan-y; position: absolute;`, width: this._editorWidth, height: this._editorHeight},\r\n\t\tthis._notches,\r\n\t\tthis._handle,\r\n\t\tthis._handleHighlight,\r\n\t\tthis._leftHighlight,\r\n\t\tthis._rightHighlight,\r\n\t\tthis._playhead,\r\n\t);\r\n\t\t\r\n\t\tpublic readonly container: HTMLElement = HTML.div({class: \"barScrollBar\", style: \"width: 512px; height: 20px; overflow: hidden; position: relative;\"}, this._svg);\r\n\t\t\r\n\tprivate _mouseX: number = 0;\r\n\tprivate _mouseDown: boolean = false;\r\n\tprivate _mouseOver: boolean = false;\r\n\tprivate _dragging: boolean = false;\r\n\tprivate _dragStart: number;\r\n\tprivate _notchSpace: number;\r\n\tprivate _renderedNotchCount: number = -1;\r\n\tprivate _renderedScrollBarPos: number = -1;\r\n\t\r\n\tconstructor(private _doc: SongDocument, private _trackContainer: HTMLDivElement) {\r\n\t\tconst center: number = this._editorHeight * 0.5;\r\n\t\tconst base: number = 20;\r\n\t\tconst tip: number = 9;\r\n\t\tconst arrowHeight: number = 6;\r\n\t\tthis._leftHighlight.setAttribute(\"d\", `M ${tip} ${center} L ${base} ${center + arrowHeight} L ${base} ${center - arrowHeight} z`);\r\n\t\tthis._rightHighlight.setAttribute(\"d\", `M ${this._editorWidth - tip} ${center} L ${this._editorWidth - base} ${center + arrowHeight} L ${this._editorWidth - base} ${center - arrowHeight} z`);\r\n\t\t\t\r\n\t\tthis.container.addEventListener(\"mousedown\", this._whenMousePressed);\r\n\t\tdocument.addEventListener(\"mousemove\", this._whenMouseMoved);\r\n\t\tdocument.addEventListener(\"mouseup\", this._whenCursorReleased);\r\n\t\tthis.container.addEventListener(\"mouseover\", this._whenMouseOver);\r\n\t\tthis.container.addEventListener(\"mouseout\", this._whenMouseOut);\r\n\t\t\t\r\n\t\tthis.container.addEventListener(\"touchstart\", this._whenTouchPressed);\r\n\t\tthis.container.addEventListener(\"touchmove\", this._whenTouchMoved);\r\n\t\tthis.container.addEventListener(\"touchend\", this._whenCursorReleased);\r\n\t\tthis.container.addEventListener(\"touchcancel\", this._whenCursorReleased);\r\n\t\t\t\r\n\t\t// Sorry, bypassing typescript type safety on this function because I want to use the new \"passive\" option.\r\n\t\t//this._trackContainer.addEventListener(\"scroll\", this._onScroll, {capture: false, passive: true});\r\n\t\t\t(<Function>this._trackContainer.addEventListener)(\"scroll\", this._onScroll, {capture: false, passive: true});\r\n\t}\r\n\r\n\tpublic animatePlayhead = (): void => {\r\n\t\tconst playhead = Math.min(512, Math.max(0, (this._notchSpace * this._doc.synth.playhead - 2)));\r\n\t\tif (this._renderedPlayhead != playhead) {\r\n\t\t\tthis._renderedPlayhead = playhead;\r\n\t\t\tthis._playhead.setAttribute(\"x\", \"\" + playhead);\r\n\t}\r\n\t}\r\n\t\t\r\n\tprivate _onScroll = (event: Event): void => {\r\n\t\tthis._doc.barScrollPos = (this._trackContainer.scrollLeft / this._doc.getBarWidth());\r\n\t\t//this._doc.notifier.changed();\r\n\t}\r\n\t\t\r\n\tprivate _whenMouseOver = (event: MouseEvent): void => {\r\n\t\tif (this._mouseOver) return;\r\n\t\tthis._mouseOver = true;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\t\r\n\tprivate _whenMouseOut = (event: MouseEvent): void => {\r\n\t\tif (!this._mouseOver) return;\r\n\t\tthis._mouseOver = false;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\t\r\n\tprivate _whenMousePressed = (event: MouseEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.clientX || event.pageX) - boundingRect.left;\r\n\t\t//this._mouseY = (event.clientY || event.pageY) - boundingRect.top;\r\n\t\tthis._updatePreview();\r\n\t\tif (this._mouseX >= this._doc.barScrollPos * this._notchSpace && this._mouseX <= (this._doc.barScrollPos + this._doc.trackVisibleBars) * this._notchSpace) {\r\n\t\t\tthis._dragging = true;\r\n\t\t\tthis._dragStart = this._mouseX;\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tprivate _whenTouchPressed = (event: TouchEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = event.touches[0].clientX - boundingRect.left;\r\n\t\t//this._mouseY = event.touches[0].clientY - boundingRect.top;\r\n\t\tthis._updatePreview();\r\n\t\tif (this._mouseX >= this._doc.barScrollPos * this._notchSpace && this._mouseX <= (this._doc.barScrollPos + this._doc.trackVisibleBars) * this._notchSpace) {\r\n\t\t\tthis._dragging = true;\r\n\t\t\tthis._dragStart = this._mouseX;\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tprivate _whenMouseMoved = (event: MouseEvent): void => {\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.clientX || event.pageX) - boundingRect.left;\r\n\t\t//this._mouseY = (event.clientY || event.pageY) - boundingRect.top;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\t\r\n\tprivate _whenTouchMoved = (event: TouchEvent): void => {\r\n\t\tif (!this._mouseDown) return;\r\n\t\tevent.preventDefault();\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = event.touches[0].clientX - boundingRect.left;\r\n\t\t//this._mouseY = event.touches[0].clientY - boundingRect.top;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\t\r\n\tprivate _whenCursorMoved(): void {\r\n\t\tif (this._dragging) {\r\n\t\t\twhile (this._mouseX - this._dragStart < -this._notchSpace * 0.5) {\r\n\t\t\t\tif (this._doc.barScrollPos > 0) {\r\n\t\t\t\t\tthis._doc.barScrollPos--;\r\n\t\t\t\t\tthis._dragStart -= this._notchSpace;\r\n\t\t\t\t\tthis._doc.notifier.changed();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\twhile (this._mouseX - this._dragStart > this._notchSpace * 0.5) {\r\n\t\t\t\tif (this._doc.barScrollPos < this._doc.song.barCount - this._doc.trackVisibleBars) {\r\n\t\t\t\t\tthis._doc.barScrollPos++;\r\n\t\t\t\t\tthis._dragStart += this._notchSpace;\r\n\t\t\t\t\tthis._doc.notifier.changed();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (this._mouseOver) this._updatePreview();\r\n\t}\r\n\t\t\r\n\tpublic changePos(offset: number) {\r\n\t\twhile (Math.abs(offset) >= 1) {\r\n\r\n\t\t\tif (offset < 0) {\r\n\t\t\t\tif (this._doc.barScrollPos > 0) {\r\n\t\t\t\t\tthis._doc.barScrollPos--;\r\n\t\t\t\t\tthis._dragStart += this._notchSpace;\r\n\t\t\t\t\tthis._doc.notifier.changed();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tif (this._doc.barScrollPos < this._doc.song.barCount - this._doc.trackVisibleBars) {\r\n\t\t\t\t\tthis._doc.barScrollPos++;\r\n\t\t\t\t\tthis._dragStart += this._notchSpace;\r\n\t\t\t\t\tthis._doc.notifier.changed();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\toffset += (offset > 0) ? -1 : 1;\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tprivate _whenCursorReleased = (event: Event): void => {\r\n\t\tif (!this._dragging && this._mouseDown) {\r\n\t\t\tif (this._mouseX < (this._doc.barScrollPos + 8) * this._notchSpace) {\r\n\t\t\t\tif (this._doc.barScrollPos > 0) this._doc.barScrollPos--;\r\n\t\t\t\tthis._doc.notifier.changed();\r\n\t\t\t} else {\r\n\t\t\t\tif (this._doc.barScrollPos < this._doc.song.barCount - this._doc.trackVisibleBars) this._doc.barScrollPos++;\r\n\t\t\t\tthis._doc.notifier.changed();\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis._mouseDown = false;\r\n\t\tthis._dragging = false;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\t\r\n\tprivate _updatePreview(): void {\r\n\t\tconst showHighlight: boolean = this._mouseOver && !this._mouseDown;\r\n\t\tlet showleftHighlight: boolean = false;\r\n\t\tlet showRightHighlight: boolean = false;\r\n\t\tlet showHandleHighlight: boolean = false;\r\n\t\t\t\r\n\t\tif (showHighlight) {\r\n\t\t\tif (this._mouseX < this._doc.barScrollPos * this._notchSpace) {\r\n\t\t\t\tshowleftHighlight = true;\r\n\t\t\t} else if (this._mouseX > (this._doc.barScrollPos + this._doc.trackVisibleBars) * this._notchSpace) {\r\n\t\t\t\tshowRightHighlight = true;\r\n\t\t\t} else {\r\n\t\t\t\tshowHandleHighlight = true;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\t\r\n\t\tthis._leftHighlight.style.visibility = showleftHighlight ? \"visible\" : \"hidden\";\r\n\t\tthis._rightHighlight.style.visibility = showRightHighlight ? \"visible\" : \"hidden\";\r\n\t\tthis._handleHighlight.style.visibility = showHandleHighlight ? \"visible\" : \"hidden\";\r\n\t}\r\n\t\t\r\n\tpublic render(): void {\r\n\t\t\tthis._notchSpace = (this._editorWidth-1) / Math.max(this._doc.trackVisibleBars, this._doc.song.barCount);\r\n\t\t\t\r\n\t\tconst resized: boolean = this._renderedNotchCount != this._doc.song.barCount;\r\n\t\tif (resized) {\r\n\t\t\tthis._renderedNotchCount = this._doc.song.barCount;\r\n\t\t\t\t\r\n\t\t\twhile (this._notches.firstChild) this._notches.removeChild(this._notches.firstChild);\r\n\t\t\t\t\r\n\t\t\tfor (let i: number = 0; i <= this._doc.song.barCount; i++) {\r\n\t\t\t\tconst lineHeight: number = (i % 16 == 0) ? 0 : ((i % 4 == 0) ? this._editorHeight / 8 : this._editorHeight / 3);\r\n\t\t\t\t\tthis._notches.appendChild(SVG.rect({fill: ColorConfig.uiWidgetBackground, x: i * this._notchSpace - 1, y: lineHeight, width: 2, height: this._editorHeight - lineHeight * 2}));\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tthis._doc.barScrollPos     = Math.max(0, Math.min(this._doc.song.barCount          - this._doc.trackVisibleBars,     this._doc.barScrollPos));\r\n\t\tthis._doc.channelScrollPos = Math.max(0, Math.min(this._doc.song.getChannelCount() - this._doc.trackVisibleChannels, this._doc.channelScrollPos));\r\n\t\t\r\n\t\tif (resized || this._renderedScrollBarPos != this._doc.barScrollPos) {\r\n\t\t\tthis._renderedScrollBarPos = this._doc.barScrollPos;\r\n\t\t\tthis._handle.setAttribute(\"x\", String(this._notchSpace * this._doc.barScrollPos));\r\n\t\t\tthis._handle.setAttribute(\"width\", String(this._notchSpace * this._doc.trackVisibleBars));\r\n\t\t\tthis._handleHighlight.setAttribute(\"x\", String(this._notchSpace * this._doc.barScrollPos));\r\n\t\t\tthis._handleHighlight.setAttribute(\"width\", String(this._notchSpace * this._doc.trackVisibleBars));\r\n\t\t}\r\n\t\t\t\r\n\t\tthis._updatePreview();\r\n\t\t\t\r\n\t\tthis._trackContainer.scrollLeft = this._doc.barScrollPos * this._doc.getBarWidth();\r\n\t\tthis._trackContainer.scrollTop = this._doc.channelScrollPos * this._doc.getChannelHeight();\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\n// interface shared by number[], Float32Array, and other typed arrays in JavaScript.\r\ninterface NumberArray {\r\n\tlength: number;\r\n\t[index: number]: number;\r\n}\r\n\r\n// A basic FFT operation scales the overall magnitude of elements by the\r\n// square root of the length of the array, √N. Performing a forward FFT and\r\n// then an inverse FFT results in the original array, but multiplied by N.\r\n// This helper function can be used to compensate for that. \r\nexport function scaleElementsByFactor(array: NumberArray, factor: number): void {\r\n\tfor (let i: number = 0; i < array.length; i++) {\r\n\t\tarray[i] *= factor;\r\n\t}\r\n}\r\n\r\nfunction isPowerOf2(n: number): boolean {\r\n\treturn !!n && !(n & (n - 1));\r\n}\r\n\r\nfunction countBits(n: number): number {\r\n\tif (!isPowerOf2(n)) throw new Error(\"FFT array length must be a power of 2.\");\r\n\treturn Math.round(Math.log(n) / Math.log(2));\r\n}\r\n\r\n// Rearranges the elements of the array, swapping the element at an index\r\n// with an element at an index that is the bitwise reverse of the first\r\n// index in base 2. Useful for computing the FFT.\r\nfunction reverseIndexBits(array: NumberArray, fullArrayLength: number): void {\r\n\tconst bitCount: number = countBits(fullArrayLength);\r\n\tif (bitCount > 16) throw new Error(\"FFT array length must not be greater than 2^16.\");\r\n\tconst finalShift: number = 16 - bitCount;\r\n\tfor (let i: number = 0; i < fullArrayLength; i++) {\r\n\t\t// Dear Javascript: Please support bit order reversal intrinsics. Thanks! :D\r\n\t\tlet j: number;\r\n\t\tj = ((i & 0xaaaa) >> 1) | ((i & 0x5555) << 1);\r\n\t\tj = ((j & 0xcccc) >> 2) | ((j & 0x3333) << 2);\r\n\t\tj = ((j & 0xf0f0) >> 4) | ((j & 0x0f0f) << 4);\r\n\t\t\tj = ((j           >> 8) | ((j &   0xff) << 8)) >> finalShift;\r\n\t\tif (j > i) {\r\n\t\t\tlet temp: number = array[i];\r\n\t\t\tarray[i] = array[j];\r\n\t\t\tarray[j] = temp;\r\n\t\t}\r\n\t}\r\n}\r\n\r\n// Provided for educational purposes. Easier to read than\r\n// fastFourierTransform(), but computes the same result.\r\n// Takes two parallel arrays representing the real and imaginary elements,\r\n// respectively, and returns an array containing two new arrays, which\r\n// contain the complex result of the transform.\r\nexport function discreteFourierTransform(realArray: NumberArray, imagArray: NumberArray): number[][] {\r\n\tconst fullArrayLength: number = realArray.length;\r\n\tif (fullArrayLength != imagArray.length) throw new Error(\"FFT arrays must be the same length.\");\r\n\tconst realOut: number[] = [];\r\n\tconst imagOut: number[] = [];\r\n\tfor (let i: number = 0; i < fullArrayLength; i++) {\r\n\t\trealOut[i] = 0.0;\r\n\t\timagOut[i] = 0.0;\r\n\t\tfor (let j: number = 0; j < fullArrayLength; j++) {\r\n\t\t\tconst radians: number = -6.2831853 * j * i / fullArrayLength;\r\n\t\t\tconst c: number = Math.cos(radians);\r\n\t\t\tconst s: number = Math.sin(radians);\r\n\t\t\trealOut[i] += realArray[j] * c - imagArray[j] * s;\r\n\t\t\timagOut[i] += realArray[j] * s + imagArray[j] * c;\r\n\t\t}\r\n\t}\r\n\treturn [realOut, imagOut];\r\n}\r\n\r\n// Performs a Fourier transform in O(N log(N)) operations. Overwrites the\r\n// input real and imaginary arrays. Can be used for both forward and inverse\r\n// transforms: swap the order of the arguments for the inverse.\r\nexport function fastFourierTransform(realArray: NumberArray, imagArray: NumberArray): void {\r\n\tconst fullArrayLength: number = realArray.length;\r\n\tif (!isPowerOf2(fullArrayLength)) throw new Error(\"FFT array length must be a power of 2.\");\r\n\tif (fullArrayLength < 4) throw new Error(\"FFT array length must be at least 4.\");\r\n\tif (fullArrayLength != imagArray.length) throw new Error(\"FFT arrays must be the same length.\");\r\n\t\t\r\n\treverseIndexBits(realArray, fullArrayLength);\r\n\treverseIndexBits(imagArray, fullArrayLength);\r\n\t\t\r\n\t// First two passes, with strides of 2 and 4, can be combined and optimized.\r\n\tfor (let startIndex: number = 0; startIndex < fullArrayLength; startIndex += 4) {\r\n\t\tconst startIndex1: number = startIndex + 1;\r\n\t\tconst startIndex2: number = startIndex + 2;\r\n\t\tconst startIndex3: number = startIndex + 3;\r\n\t\t\tconst real0: number = realArray[startIndex ];\r\n\t\tconst real1: number = realArray[startIndex1];\r\n\t\tconst real2: number = realArray[startIndex2];\r\n\t\tconst real3: number = realArray[startIndex3];\r\n\t\t\tconst imag0: number = imagArray[startIndex ];\r\n\t\tconst imag1: number = imagArray[startIndex1];\r\n\t\tconst imag2: number = imagArray[startIndex2];\r\n\t\tconst imag3: number = imagArray[startIndex3];\r\n\t\tconst realTemp0: number = real0 + real1;\r\n\t\tconst realTemp1: number = real0 - real1;\r\n\t\tconst realTemp2: number = real2 + real3;\r\n\t\tconst realTemp3: number = real2 - real3;\r\n\t\tconst imagTemp0: number = imag0 + imag1;\r\n\t\tconst imagTemp1: number = imag0 - imag1;\r\n\t\tconst imagTemp2: number = imag2 + imag3;\r\n\t\tconst imagTemp3: number = imag2 - imag3;\r\n\t\t\trealArray[startIndex ] = realTemp0 + realTemp2;\r\n\t\trealArray[startIndex1] = realTemp1 + imagTemp3;\r\n\t\trealArray[startIndex2] = realTemp0 - realTemp2;\r\n\t\trealArray[startIndex3] = realTemp1 - imagTemp3;\r\n\t\t\timagArray[startIndex ] = imagTemp0 + imagTemp2;\r\n\t\timagArray[startIndex1] = imagTemp1 - realTemp3;\r\n\t\timagArray[startIndex2] = imagTemp0 - imagTemp2;\r\n\t\timagArray[startIndex3] = imagTemp1 + realTemp3;\r\n\t}\r\n\t\t\r\n\tfor (let stride: number = 8; stride <= fullArrayLength; stride += stride) {\r\n\t\tconst halfLength: number = stride >>> 1;\r\n\t\tconst radiansIncrement: number = Math.PI * 2.0 / stride;\r\n\t\tconst cosIncrement: number = Math.cos(radiansIncrement);\r\n\t\tconst sinIncrement: number = Math.sin(radiansIncrement);\r\n\t\tconst oscillatorMultiplier: number = 2.0 * cosIncrement;\r\n\t\tfor (let startIndex: number = 0; startIndex < fullArrayLength; startIndex += stride) {\r\n\t\t\tlet c: number = 1.0;\r\n\t\t\tlet s: number = 0.0;\r\n\t\t\tlet cPrev: number = cosIncrement;\r\n\t\t\tlet sPrev: number = sinIncrement;\r\n\t\t\tconst secondHalf: number = startIndex + halfLength;\r\n\t\t\tfor (let i: number = startIndex; i < secondHalf; i++) {\r\n\t\t\t\tconst j: number = i + halfLength;\r\n\t\t\t\tconst real0: number = realArray[i];\r\n\t\t\t\tconst imag0: number = imagArray[i];\r\n\t\t\t\tconst real1: number = realArray[j] * c - imagArray[j] * s;\r\n\t\t\t\tconst imag1: number = realArray[j] * s + imagArray[j] * c;\r\n\t\t\t\trealArray[i] = real0 + real1;\r\n\t\t\t\timagArray[i] = imag0 + imag1;\r\n\t\t\t\trealArray[j] = real0 - real1;\r\n\t\t\t\timagArray[j] = imag0 - imag1;\r\n\t\t\t\tconst cTemp: number = oscillatorMultiplier * c - cPrev;\r\n\t\t\t\tconst sTemp: number = oscillatorMultiplier * s - sPrev;\r\n\t\t\t\tcPrev = c;\r\n\t\t\t\tsPrev = s;\r\n\t\t\t\tc = cTemp;\r\n\t\t\t\ts = sTemp;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\n// Computes the Fourier transform from an array of real-valued time-domain\r\n// samples. The output is specially formatted for space efficieny: elements\r\n// 0 through N/2 represent cosine wave amplitudes in ascending frequency,\r\n// and elements N/2+1 through N-1 represent sine wave amplitudes in\r\n// descending frequency. Overwrites the input array.\r\nexport function forwardRealFourierTransform(array: NumberArray): void {\r\n\tconst fullArrayLength: number = array.length;\r\n\tconst totalPasses: number = countBits(fullArrayLength);\r\n\tif (fullArrayLength < 4) throw new Error(\"FFT array length must be at least 4.\");\r\n\t\t\r\n\treverseIndexBits(array, fullArrayLength);\r\n\t\t\r\n\t// First and second pass.\r\n\tfor (let index: number = 0; index < fullArrayLength; index += 4) {\r\n\t\tconst index1: number = index + 1;\r\n\t\tconst index2: number = index + 2;\r\n\t\tconst index3: number = index + 3;\r\n\t\t\tconst real0: number = array[index ];\r\n\t\tconst real1: number = array[index1];\r\n\t\tconst real2: number = array[index2];\r\n\t\tconst real3: number = array[index3];\r\n\t\t// no imaginary elements yet since the input is fully real.\r\n\t\tconst tempA: number = real0 + real1;\r\n\t\tconst tempB: number = real2 + real3;\r\n\t\t\tarray[index ] = tempA + tempB;\r\n\t\tarray[index1] = real0 - real1;\r\n\t\tarray[index2] = tempA - tempB;\r\n\t\tarray[index3] = real2 - real3;\r\n\t}\r\n\t\t\r\n\t// Third pass.\r\n\tconst sqrt2over2: number = Math.sqrt(2.0) / 2.0;\r\n\tfor (let index: number = 0; index < fullArrayLength; index += 8) {\r\n\t\tconst index1: number = index + 1;\r\n\t\tconst index3: number = index + 3;\r\n\t\tconst index4: number = index + 4;\r\n\t\tconst index5: number = index + 5;\r\n\t\tconst index7: number = index + 7;\r\n\t\t\tconst real0: number = array[index ];\r\n\t\tconst real1: number = array[index1];\r\n\t\tconst imag3: number = array[index3];\r\n\t\tconst real4: number = array[index4];\r\n\t\tconst real5: number = array[index5];\r\n\t\tconst imag7: number = array[index7];\r\n\t\tconst tempA: number = (real5 - imag7) * sqrt2over2;\r\n\t\tconst tempB: number = (real5 + imag7) * sqrt2over2;\r\n\t\t\tarray[index ] = real0 + real4;\r\n\t\tarray[index1] = real1 + tempA;\r\n\t\tarray[index3] = real1 - tempA;\r\n\t\tarray[index4] = real0 - real4;\r\n\t\tarray[index5] = tempB - imag3;\r\n\t\tarray[index7] = tempB + imag3;\r\n\t}\r\n\t\t\r\n\t// Handle remaining passes.\r\n\tfor (let pass: number = 3; pass < totalPasses; pass++) {\r\n\t\tconst subStride: number = 1 << pass;\r\n\t\tconst midSubStride: number = subStride >> 1;\r\n\t\tconst stride: number = subStride << 1;\r\n\t\tconst radiansIncrement: number = Math.PI * 2.0 / stride;\r\n\t\tconst cosIncrement: number = Math.cos(radiansIncrement);\r\n\t\tconst sinIncrement: number = Math.sin(radiansIncrement);\r\n\t\tconst oscillatorMultiplier: number = 2.0 * cosIncrement;\r\n\t\tfor (let startIndex: number = 0; startIndex < fullArrayLength; startIndex += stride) {\r\n\t\t\tconst startIndexA: number = startIndex;\r\n\t\t\tconst startIndexB: number = startIndexA + subStride;\r\n\t\t\tconst stopIndex: number = startIndexB + subStride;\r\n\t\t\tconst realStartA: number = array[startIndexA];\r\n\t\t\tconst realStartB: number = array[startIndexB];\r\n\t\t\tarray[startIndexA] = realStartA + realStartB;\r\n\t\t\tarray[startIndexB] = realStartA - realStartB;\r\n\t\t\tlet c: number = cosIncrement;\r\n\t\t\tlet s: number = -sinIncrement;\r\n\t\t\tlet cPrev: number = 1.0;\r\n\t\t\tlet sPrev: number = 0.0;\r\n\t\t\tfor (let index: number = 1; index < midSubStride; index++) {\r\n\t\t\t\tconst indexA0: number = startIndexA + index;\r\n\t\t\t\tconst indexA1: number = startIndexB - index;\r\n\t\t\t\tconst indexB0: number = startIndexB + index;\r\n\t\t\t\t\tconst indexB1: number = stopIndex   - index;\r\n\t\t\t\tconst real0: number = array[indexA0];\r\n\t\t\t\tconst imag0: number = array[indexA1];\r\n\t\t\t\tconst real1: number = array[indexB0];\r\n\t\t\t\tconst imag1: number = array[indexB1];\r\n\t\t\t\tconst tempA: number = real1 * c + imag1 * s;\r\n\t\t\t\tconst tempB: number = real1 * s - imag1 * c;\r\n\t\t\t\tarray[indexA0] = real0 + tempA;\r\n\t\t\t\tarray[indexA1] = real0 - tempA;\r\n\t\t\t\t\tarray[indexB0] =-imag0 - tempB;\r\n\t\t\t\tarray[indexB1] = imag0 - tempB;\r\n\t\t\t\tconst cTemp: number = oscillatorMultiplier * c - cPrev;\r\n\t\t\t\tconst sTemp: number = oscillatorMultiplier * s - sPrev;\r\n\t\t\t\tcPrev = c;\r\n\t\t\t\tsPrev = s;\r\n\t\t\t\tc = cTemp;\r\n\t\t\t\ts = sTemp;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\n// Computes the inverse Fourier transform from a specially formatted array of\r\n// scalar values. Elements 0 through N/2 are expected to be the real values of\r\n// the corresponding complex elements, representing cosine wave amplitudes in\r\n// ascending frequency, and elements N/2+1 through N-1 correspond to the\r\n// imaginary values, representing sine wave amplitudes in descending frequency.\r\n// Generates real-valued time-domain samples. Overwrites the input array.\r\nexport function inverseRealFourierTransform(array: NumberArray, fullArrayLength: number): void {\r\n\tconst totalPasses: number = countBits(fullArrayLength);\r\n\tif (fullArrayLength < 4) throw new Error(\"FFT array length must be at least 4.\");\r\n\r\n\t// Perform all but the last few passes in reverse.\r\n\tfor (let pass: number = totalPasses - 1; pass >= 2; pass--) {\r\n\t\tconst subStride: number = 1 << pass;\r\n\t\tconst midSubStride: number = subStride >> 1;\r\n\t\tconst stride: number = subStride << 1;\r\n\t\tconst radiansIncrement: number = Math.PI * 2.0 / stride;\r\n\t\tconst cosIncrement: number = Math.cos(radiansIncrement);\r\n\t\tconst sinIncrement: number = Math.sin(radiansIncrement);\r\n\t\tconst oscillatorMultiplier: number = 2.0 * cosIncrement;\r\n\t\t\t\r\n\t\tfor (let startIndex: number = 0; startIndex < fullArrayLength; startIndex += stride) {\r\n\t\t\tconst startIndexA: number = startIndex;\r\n\t\t\tconst midIndexA: number = startIndexA + midSubStride;\r\n\t\t\tconst startIndexB: number = startIndexA + subStride;\r\n\t\t\tconst midIndexB: number = startIndexB + midSubStride;\r\n\t\t\tconst stopIndex: number = startIndexB + subStride;\r\n\t\t\tconst realStartA: number = array[startIndexA];\r\n\t\t\tconst imagStartB: number = array[startIndexB];\r\n\t\t\tarray[startIndexA] = realStartA + imagStartB;\r\n\t\t\tarray[midIndexA] *= 2;\r\n\t\t\tarray[startIndexB] = realStartA - imagStartB;\r\n\t\t\tarray[midIndexB] *= 2;\r\n\t\t\tlet c: number = cosIncrement;\r\n\t\t\tlet s: number = -sinIncrement;\r\n\t\t\tlet cPrev: number = 1.0;\r\n\t\t\tlet sPrev: number = 0.0;\r\n\t\t\tfor (let index: number = 1; index < midSubStride; index++) {\r\n\t\t\t\tconst indexA0: number = startIndexA + index;\r\n\t\t\t\tconst indexA1: number = startIndexB - index;\r\n\t\t\t\tconst indexB0: number = startIndexB + index;\r\n\t\t\t\t\tconst indexB1: number = stopIndex   - index;\r\n\t\t\t\tconst real0: number = array[indexA0];\r\n\t\t\t\tconst real1: number = array[indexA1];\r\n\t\t\t\tconst imag0: number = array[indexB0];\r\n\t\t\t\tconst imag1: number = array[indexB1];\r\n\t\t\t\tconst tempA: number = real0 - real1;\r\n\t\t\t\tconst tempB: number = imag0 + imag1;\r\n\t\t\t\tarray[indexA0] = real0 + real1;\r\n\t\t\t\tarray[indexA1] = imag1 - imag0;\r\n\t\t\t\tarray[indexB0] = tempA * c - tempB * s;\r\n\t\t\t\tarray[indexB1] = tempB * c + tempA * s;\r\n\t\t\t\tconst cTemp: number = oscillatorMultiplier * c - cPrev;\r\n\t\t\t\tconst sTemp: number = oscillatorMultiplier * s - sPrev;\r\n\t\t\t\tcPrev = c;\r\n\t\t\t\tsPrev = s;\r\n\t\t\t\tc = cTemp;\r\n\t\t\t\ts = sTemp;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t/*\r\n\t// Commented out this block (and compensated with an extra pass above)\r\n\t// because it's slower in my testing so far.\r\n\t// Pass with stride 8.\r\n\tconst sqrt2over2: number = Math.sqrt(2.0) / 2.0;\r\n\tfor (let index: number = 0; index < fullArrayLength; index += 8) {\r\n\t\tconst index1: number = index + 1;\r\n\t\tconst index2: number = index + 2;\r\n\t\tconst index3: number = index + 3;\r\n\t\tconst index4: number = index + 4;\r\n\t\tconst index5: number = index + 5;\r\n\t\tconst index6: number = index + 6;\r\n\t\tconst index7: number = index + 7;\r\n\t\tconst real0: number = array[index ];\r\n\t\tconst real1: number = array[index1];\r\n\t\tconst real2: number = array[index2];\r\n\t\tconst real3: number = array[index3];\r\n\t\tconst imag4: number = array[index4];\r\n\t\tconst imag5: number = array[index5];\r\n\t\tconst imag6: number = array[index6];\r\n\t\tconst imag7: number = array[index7];\r\n\t\tconst tempA: number = real1 - real3;\r\n\t\tconst tempB: number = imag5 + imag7;\r\n\t\tarray[index ] = real0 + imag4;\r\n\t\tarray[index1] = real1 + real3;\r\n\t\tarray[index2] = real2 * 2;\r\n\t\tarray[index3] = imag7 - imag5;\r\n\t\tarray[index4] = real0 - imag4;\r\n\t\tarray[index5] = (tempA + tempB) * sqrt2over2;\r\n\t\tarray[index6] = imag6 * 2;\r\n\t\tarray[index7] = (tempB - tempA) * sqrt2over2;\r\n\t}\r\n\t*/\r\n\t// The final passes with strides 4 and 2, combined into one loop.\r\n\tfor (let index: number = 0; index < fullArrayLength; index += 4) {\r\n\t\tconst index1: number = index + 1;\r\n\t\tconst index2: number = index + 2;\r\n\t\tconst index3: number = index + 3;\r\n\t\t\tconst real0: number = array[index ];\r\n\t\tconst real1: number = array[index1] * 2;\r\n\t\tconst imag2: number = array[index2];\r\n\t\tconst imag3: number = array[index3] * 2;\r\n\t\tconst tempA: number = real0 + imag2;\r\n\t\tconst tempB: number = real0 - imag2;\r\n\t\t\tarray[index ] = tempA + real1;\r\n\t\tarray[index1] = tempA - real1;\r\n\t\tarray[index2] = tempB + imag3;\r\n\t\tarray[index3] = tempB - imag3;\r\n\t}\r\n\t\t\r\n\treverseIndexBits(array, fullArrayLength);\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nexport class Deque<T> {\r\n\tprivate _capacity: number = 1;\r\n\tprivate _buffer: Array<T | undefined> = [undefined];\r\n\tprivate _mask: number = 0;\r\n\tprivate _offset: number = 0;\r\n\tprivate _count: number = 0;\r\n\r\n\tpublic pushFront(element: T): void {\r\n\t\tif (this._count >= this._capacity) this._expandCapacity();\r\n\t\tthis._offset = (this._offset - 1) & this._mask;\r\n\t\tthis._buffer[this._offset] = element;\r\n\t\tthis._count++;\r\n\t}\r\n\tpublic pushBack(element: T): void {\r\n\t\tif (this._count >= this._capacity) this._expandCapacity();\r\n\t\tthis._buffer[(this._offset + this._count) & this._mask] = element;\r\n\t\tthis._count++;\r\n\t}\r\n\tpublic popFront(): T {\r\n\t\tif (this._count <= 0) throw new Error(\"No elements left to pop.\");\r\n\t\tconst element: T = <T>this._buffer[this._offset];\r\n\t\tthis._buffer[this._offset] = undefined;\r\n\t\tthis._offset = (this._offset + 1) & this._mask;\r\n\t\tthis._count--;\r\n\t\treturn element;\r\n\t}\r\n\tpublic popBack(): T {\r\n\t\tif (this._count <= 0) throw new Error(\"No elements left to pop.\");\r\n\t\tthis._count--;\r\n\t\tconst index: number = (this._offset + this._count) & this._mask;\r\n\t\tconst element: T = <T>this._buffer[index];\r\n\t\tthis._buffer[index] = undefined;\r\n\t\treturn element;\r\n\t}\r\n\tpublic peakFront(): T {\r\n\t\tif (this._count <= 0) throw new Error(\"No elements left to pop.\");\r\n\t\treturn <T>this._buffer[this._offset];\r\n\t}\r\n\tpublic peakBack(): T {\r\n\t\tif (this._count <= 0) throw new Error(\"No elements left to pop.\");\r\n\t\treturn <T>this._buffer[(this._offset + this._count - 1) & this._mask];\r\n\t}\r\n\tpublic count(): number {\r\n\t\treturn this._count;\r\n\t}\r\n\tpublic set(index: number, element: T): void {\r\n\t\tif (index < 0 || index >= this._count) throw new Error(\"Invalid index\");\r\n\t\tthis._buffer[(this._offset + index) & this._mask] = element;\r\n\t}\r\n\tpublic get(index: number): T {\r\n\t\tif (index < 0 || index >= this._count) throw new Error(\"Invalid index\");\r\n\t\treturn <T>this._buffer[(this._offset + index) & this._mask];\r\n\t}\r\n\tpublic remove(index: number): void {\r\n\t\tif (index < 0 || index >= this._count) throw new Error(\"Invalid index\");\r\n\t\tif (index <= (this._count >> 1)) {\r\n\t\t\twhile (index > 0) {\r\n\t\t\t\tthis.set(index, this.get(index - 1));\r\n\t\t\t\tindex--;\r\n\t\t\t}\r\n\t\t\tthis.popFront();\r\n\t\t} else {\r\n\t\t\tindex++;\r\n\t\t\twhile (index < this._count) {\r\n\t\t\t\tthis.set(index - 1, this.get(index));\r\n\t\t\t\tindex++;\r\n\t\t\t}\r\n\t\t\tthis.popBack();\r\n\t\t}\r\n\t}\r\n\tprivate _expandCapacity(): void {\r\n\t\tif (this._capacity >= 0x40000000) throw new Error(\"Capacity too big.\");\r\n\t\tthis._capacity = this._capacity << 1;\r\n\t\tconst oldBuffer: Array<T | undefined> = this._buffer;\r\n\t\tconst newBuffer: Array<T | undefined> = new Array(this._capacity);\r\n\t\tconst size: number = this._count | 0;\r\n\t\tconst offset: number = this._offset | 0;\r\n\t\tfor (let i = 0; i < size; i++) {\r\n\t\t\tnewBuffer[i] = oldBuffer[(offset + i) & this._mask];\r\n\t\t}\r\n\t\tfor (let i = size; i < this._capacity; i++) {\r\n\t\t\tnewBuffer[i] = undefined;\r\n\t\t}\r\n\t\tthis._offset = 0;\r\n\t\tthis._buffer = newBuffer;\r\n\t\tthis._mask = this._capacity - 1;\r\n\t}\r\n}","/*\r\nThis file contains code to compute digital audio filter coefficients based on\r\nthe desired type, cutoff frequency, and other parameters. You can use these\r\ncoefficients to apply the filter to audio samples. It also contains code to\r\nanalyze these filters, which is useful for graphically displaying their effects.\r\n\r\nAll of the filters in this file are known as \"Infinite Impulse Response\" or IIR\r\nfilters, because older output samples contribute feedback to newer output\r\nsamples and thus contribute to all future samples, although typically filters\r\nare design to reduce the contribution of older samples over time.\r\n\r\nLow-pass filters aka high-cut filters preserve audio signals below the cutoff\r\nfrequency, and attenuate audio signals above the cutoff frequency. High-pass\r\nfilters aka low-cut filters are the reverse. All-pass filters do not affect the\r\nvolume of the signal at all but induce phase changes above the cutoff frequency.\r\nPeak/Notch filters maintain the volume on either side of the cutoff frequency,\r\nbut raise or lower the volume at that frequency. \r\n\r\nThe number of old samples used in the filter determines the \"order\" of the\r\nfilter. First-order filters generally have shallower slopes, and second-order\r\nfilters generally have steeper slopes and can be configured to \"resonate\",\r\nmeaning they have a louder peak at the cutoff frequency. This file contains\r\nfirst-order filters and second-order filters, meaning one or two older samples\r\nare involved, as well as the current input sample.\r\n\r\nThe class FilterCoefficients is defined lower in this file. You can use it to\r\nset up a first order filter like this:\r\n\r\n\tconst cutoffRadiansPerSample: number = 2 * Math.PI * cutoffHz / sampleRate;\r\n\tconst filter: FilterCoefficients = new FilterCoefficients();\r\n\tfilter.lowPass1stOrderButterworth(cutoffRadiansPerSample);\r\n\t// output sample coefficients are conventionally called a0, a1, etc. Note\r\n\t// that a[0] is typically normalized to 1.0 and need not be used directly.\r\n\tconst a: number[] = filter.a;\r\n\t// input sample coefficients are conventionally called b0, b1, etc\r\n\tconst b: number[] = filter.b;\r\n\t// filter input samples, x[0] is the most recent, x[1] is the previous one, etc.\r\n\tconst x: number[] = [0, 0, 0];\r\n\t// filter output samples, y[0] will be computed by the filter based on input\r\n\t// samples and older output samples.\r\n\tconst y: number[] = [0, 0, 0];\r\n\r\nThen to apply the first-order filter to samples inside a loop, using the current\r\ninput sample (x[0]) as well as previous input and output samples, do this:\r\n\r\n\t// Compute the next output sample y[0]:\r\n\ty[0] = b[0] * x[0] + b[1] * x[1] - a[1] * y[1];\r\n\t// Remember the input and output samples for next time:\r\n\tx[1] = x[0];\r\n\ty[1] = y[0];\r\n\r\n2nd order filters are similar, but have more parameters and require more old\r\nsamples:\r\n\r\n\t// Compute the next output sample y[0]:\r\n\ty[0] = b[0] * x[0] + b[1] * x[1] + b[2] * x[2] - a[1] * y[1] - a[2] * y[2];\r\n\t// Remember the input and output samples for next time:\r\n\tx[2] = x[1];\r\n\tx[1] = x[0];\r\n\ty[2] = y[1];\r\n\ty[1] = y[0];\r\n\r\nYou can compose multiple filters into a higher order filter, although doing so\r\nreduces the numerical stability of the filter:\r\n\r\n\tfilter3.combination(filter1, filter2);\r\n\t// filter3.order will equal: filter1.order + filter2.order\r\n\t// The number of coefficients in filter3.a and filter3.b will be: order + 1\r\n\r\nThis file also contains a class called FrequencyResponse. You can use it to\r\ndetermine how much gain or attenuation a filter would apply to sounds at a\r\nspecific input frequency, as well as the phase offset:\r\n\r\n\tconst inputRadians: number = 2 * Math.PI * cutoffHz / sampleRate;\r\n\tconst response: FrequencyResponse = new FrequencyResponse();\r\n\tresponse.analyze(filter, inputRadians);\r\n\tconst gainResponse = response.magnitude();\r\n\tconst phaseResponse = response.angle();\r\n\r\nThat's basically all you need to know to use this code, but I'll also explain\r\nhow the analysis works.\r\n\r\nA first-order digital IIR filter is ordinarily implemented in a form like this:\r\n\r\n\toutput = inputCoeff * input + prevInputCoeff * prevInput - prevOutputCoeff * prevOutput;\r\n\r\nIf we adopt standard naming conventions for audio filters, this same code would\r\ninstead look like:\r\n\r\n\t// x0 = current input, x1 = prevInput, y0 = current output, y1 = prevOutput\r\n\ty0 = b0*x0 + b1*x1 - a1*y1;\r\n\r\nLeaving behind the world of code for a moment and entering the world of algebra,\r\nwe can rewrite this equation by moving all the output terms to the left side,\r\nand we can add a coefficient to the y0 term called a0 (which is typically\r\nnormalized to 1.0, which is why I didn't bother including it until now):\r\n\r\n\ta0*y0 + a1*y1 = b0*x0 + b1*x1\r\n\r\nThis is known as the symmetrical form of the filter, and it will help us analyze\r\nthe impact of the filter on an input audio signal. Here's a lesson that helped\r\nme understand the symmetrical form:\r\nhttps://web.archive.org/web/20200626183458/http://123.physics.ucdavis.edu/week_5_files/filters/digital_filter.pdf\r\n\r\nThe end of that lesson introduces a concept called the \"delay operator\" which\r\nlooks like \"z^-1\", which (magically) turns a sample into the previous sample\r\nwhen you multiply them. For example:\r\n\r\n\tx0 * z^-1 = x1\r\n\r\nThe lesson doesn't explain how it actually works. Audio signals aren't always\r\npredictable, which means that you generally can't do math on a single sample to\r\ncompute what the previous sample was. However, some audio signals ARE\r\npredictable, such as pure sine waves. Fortunately, all audio signals can be\r\nbroken down into a sum of independent sine waves. We can pick one sine wave at a\r\ntime, and use it to analyze the filter's impact on waves at that frequency. In\r\npractice, this tells us what the filter will do to unpredictable input samples\r\nthat contain a partial sine wave at that frequency.\r\n\r\nTechnically, you can't just use a single sine wave sample to determine the\r\nprevious sine wave sample, because each possible value is passed going upwards\r\nand downwards once per period and the direction is ambigous. This is where we\r\nneed to move into the complex number domain, where the real and imaginary\r\ncomponents can provide enough information to compute the previous position on\r\nthe input signal. So now instead of talking about sine waves, we're talking\r\nabout waves where the imaginary component is a sine wave and the real component\r\nis a cosine wave at the same frequency. Together, they trace around a unit\r\ncircle in the complex domain, and each sample is just a consistent rotation\r\napplied to the previous sample. The \"delay operator\" described above, z^-1, is\r\nthis same rotation applied in reverse, and it can be computed as:\r\n\r\n\tz^-1 = cos(radiansPerSample) - i * sin(radiansPerSample)\r\n\r\nMath nerds may be interested to know that \"Euler's formula\" was used here, but\r\nexplaining what that means is probably beyond the scope of this documentation\r\naside from noting that a complex number on the unit circle represents a 2D\r\nrotation that you can apply via multiplication.\r\n\r\nNow we can rewrite the symmetrical form using the delay operator and algebra:\r\n\r\n\ta0*y0 + a1*y0*z^-1 = b0*x0 + b1*x0*z^-1\r\n\ty0 * (a0 + a1*z^-1) = x0 * (b0 + b1*z^-1)\r\n\ty0 = x0 * (b0 + b1*z^-1) / (a0 + a1*z^-1)\r\n\ty0 / x0 = (b0 + b1*z^-1) / (a0 + a1*z^-1)\r\n\r\nThat last equation expresses the relationship between the input and output\r\nsignals (y0/x0) in terms of the filter coefficients and delay operator. At this\r\npoint, the specific values of the input and output samples don't even matter!\r\nThis is called the \"transfer function\", and it's conventionally named \"H(z)\":\r\n\r\n\tH(z) = (b0 + b1*z^-1) / (a0 + a1*z^-1)\r\n\r\nIf you plug in actual filter coefficients and express the delay operators as\r\ncomplex numbers with the appropriate trigonometry functions, the transfer\r\nfunction can be computed and produces a complex number that represents the\r\nrelationship between the input and output signals, whose magnitude represents\r\nthe volume gain (or attenuation) of signals at that frequency, and whose angle\r\nrepresents how much phase shift is applied by the filter to signals at that\r\nfrequency.\r\n\r\n(Note that in order to compute the transfer function, you'll need to do\r\nsomething about the complex number in the denominator. It turns out you can turn\r\nthe denominator into a real number by multiplying both the numerator and\r\ndenominator by the complex conjugate of the denominator, which is just the\r\ndenominator with the imaginary component negated.)\r\n\r\nFinally, I'll list some of the links that helped me understand filters and\r\nprovided some of the algorithms I that use here.\r\n\r\nHere's where I found accurate 2nd order low-pass and high-pass digital filters:\r\nhttps://web.archive.org/web/20120531011328/http://www.musicdsp.org/files/Audio-EQ-Cookbook.txt\r\n\r\nThis page is how I found a link to the cookbook article above. It claims these\r\nfilters are Butterworth filters:\r\nhttp://web.archive.org/web/20191213120120/https://crypto.stanford.edu/~blynn/sound/analog.html\r\n\r\nI found the first-order digital Butterworth filter coefficients at:\r\nhttps://www.researchgate.net/publication/338022014_Digital_Implementation_of_Butterworth_First-Order_Filter_Type_IIR\r\n\r\nThis meta-paper helped me understand how to make 2nd order peak/notch filters:\r\nhttps://web.archive.org/web/20170706085655/https://www.thesounddesign.com/MIO/EQ-Coefficients.pdf\r\n\r\nBeepBox originally used simpler low-pass filters that I adapted from SFXR:\r\nhttps://www.drpetter.se/project_sfxr.html\r\nFor low cutoff frequencies, the simpler filters and the Butterworth filters are\r\nnearly identical, but when closer to the nyquist frequency the simpler filters\r\ncreate extra resonance.\r\n*/\r\n\r\nexport class FilterCoefficients {\r\n\tpublic readonly a: number[] = [1.0]; // output coefficients (negated, keep a[0]=1)\r\n\tpublic readonly b: number[] = [1.0]; // input coefficients\r\n\tpublic order: number = 0;\r\n\t\r\n\tpublic linearGain0thOrder(linearGain: number): void {\r\n\t\t//a[0] = 1.0; // a0 should always be normalized to 1.0, no need to assign it directly.\r\n\t\tthis.b[0] = linearGain;\r\n\t\tthis.order = 0;\r\n\t}\r\n\t\r\n\tpublic lowPass1stOrderButterworth(cornerRadiansPerSample: number): void {\r\n\t\t// First-order Butterworth low-pass filter according to:\r\n\t\t// https://www.researchgate.net/publication/338022014_Digital_Implementation_of_Butterworth_First-Order_Filter_Type_IIR\r\n\t\t// A butterworth filter is one where the amplitude response is equal to:\r\n\t\t// 1 / √(1 + (freq / cutoffFreq)^(2 * order))\r\n\t\tconst g: number = 1.0 / Math.tan(cornerRadiansPerSample * 0.5);\r\n\t\tconst a0: number = 1.0 + g;\r\n\t\tthis.a[1] = (1.0 - g) / a0;\r\n\t\tthis.b[1] = this.b[0] = 1 / a0;\r\n\t\tthis.order = 1;\r\n\t}\r\n\t\r\n\tpublic lowPass1stOrderSimplified(cornerRadiansPerSample: number): void {\r\n\t\t// The output of this filter is nearly identical to the 1st order\r\n\t\t// Butterworth low-pass above, except if the cutoff is set to nyquist/3,\r\n\t\t// then the output is the same as the input, and if the cutoff is higher\r\n\t\t// than that, then the output actually resonates at high frequencies\r\n\t\t// instead of attenuating.\r\n\t\t// I'm guessing this filter was converted from analog to digital using\r\n\t\t// the \"matched z-transform\" method instead of the \"bilinear transform\"\r\n\t\t// method. The difference is that the bilinear transform warps\r\n\t\t// frequencies so that the lowpass response of zero at analogue ∞hz maps\r\n\t\t// to the digital nyquist frequency, whereas the matched z-transform\r\n\t\t// preserves the frequency of the filter response but also adds the\r\n\t\t// reflected response from above the nyquist frequency.\r\n\t\tconst g: number = 2.0 * Math.sin(cornerRadiansPerSample * 0.5);\r\n\t\tthis.a[1] = g - 1.0;\r\n\t\tthis.b[0] = g;\r\n\t\tthis.b[1] = 0.0;\r\n\t\t/*\r\n\t\t// Alternatively:\r\n\t\tconst g: number = 1.0 / (2.0 * Math.sin(cornerRadiansPerSample / 2));\r\n\t\tconst a0: number = g;\r\n\t\tthis.a[1] = (1.0 - g) / a0;\r\n\t\tthis.b[0] = 1.0 / a0;\r\n\t\tthis.b[1] = 0.0 / a0;\r\n\t\t*/\r\n\t\tthis.order = 1;\r\n\t}\r\n\t\r\n\tpublic highPass1stOrderButterworth(cornerRadiansPerSample: number): void {\r\n\t\t// First-order Butterworth high-pass filter according to:\r\n\t\t// https://www.researchgate.net/publication/338022014_Digital_Implementation_of_Butterworth_First-Order_Filter_Type_IIR\r\n\t\tconst g: number = 1.0 / Math.tan(cornerRadiansPerSample * 0.5);\r\n\t\tconst a0: number = 1.0 + g;\r\n\t\tthis.a[1] = (1.0 - g) / a0;\r\n\t\tthis.b[0] = g / a0;\r\n\t\tthis.b[1] = -g / a0;\r\n\t\tthis.order = 1;\r\n\t}\r\n\t/*\r\n\tpublic highPass1stOrderSimplified(cornerRadiansPerSample: number): void {\r\n\t\t// The output of this filter is nearly identical to the 1st order\r\n\t\t// Butterworth high-pass above, except it resonates when the cutoff\r\n\t\t// appoaches the nyquist.\r\n\t\tconst g: number = 2.0 * Math.sin(cornerRadiansPerSample * 0.5);\r\n\t\tthis.a[1] = g - 1.0;\r\n\t\tthis.b[0] = 1.0;\r\n\t\tthis.b[1] = -1.0;\r\n\t\tthis.order = 1;\r\n\t}\r\n\t*/\r\n\tpublic highShelf1stOrder(cornerRadiansPerSample: number, shelfLinearGain: number): void {\r\n\t\t// I had trouble figuring this one out because I couldn't find any\r\n\t\t// online algorithms that I understood. There are 3 degrees of freedom\r\n\t\t// and I could narrow down a couple of them based on the desired gain at\r\n\t\t// DC and nyquist, but getting the cutoff frequency correct took a\r\n\t\t// little bit of trial and error in my attempts to interpret page 53 of\r\n\t\t// this chapter: http://www.music.mcgill.ca/~ich/classes/FiltersChap2.pdf\r\n\t\t// Obviously I don't fully understand the bilinear transform yet!\r\n\t\tconst tan: number = Math.tan(cornerRadiansPerSample * 0.5);\r\n\t\tconst sqrtGain: number = Math.sqrt(shelfLinearGain);\r\n\t\tconst g: number = (tan * sqrtGain - 1) / (tan * sqrtGain + 1.0);\r\n\t\tconst a0: number = 1.0;\r\n\t\tthis.a[1] = g / a0;\r\n\t\tthis.b[0] = (1.0 + g + shelfLinearGain * (1.0 - g)) / (2.0 * a0);\r\n\t\tthis.b[1] = (1.0 + g - shelfLinearGain * (1.0 - g)) / (2.0 * a0);\r\n\t\tthis.order = 1;\r\n\t}\r\n\t\r\n\tpublic allPass1stOrderInvertPhaseAbove(cornerRadiansPerSample: number): void {\r\n\t\tconst g: number = (Math.sin(cornerRadiansPerSample) - 1.0) / Math.cos(cornerRadiansPerSample);\r\n\t\tthis.a[1] = g;\r\n\t\tthis.b[0] = g;\r\n\t\tthis.b[1] = 1.0;\r\n\t\tthis.order = 1;\r\n\t}\r\n\t\r\n\t/*\r\n\t// I haven't found a practical use for this version of the all pass filter.\r\n\t// It seems to create a weird subharmonic when used in a delay feedback loop.\r\n\tpublic allPass1stOrderInvertPhaseBelow(cornerRadiansPerSample: number): void {\r\n\t\tconst g: number = (Math.sin(cornerRadiansPerSample) - 1.0) / Math.cos(cornerRadiansPerSample);\r\n\t\tthis.a[1] = g;\r\n\t\tthis.b[0] = -g;\r\n\t\tthis.b[1] = -1.0;\r\n\t\tthis.order = 1;\r\n\t}\r\n\t*/\r\n\t\r\n\tpublic allPass1stOrderFractionalDelay(delay: number) {\r\n\t\t// Very similar to allPass1stOrderInvertPhaseAbove, but configured\r\n\t\t// differently and for a different purpose! Useful for interpolating\r\n\t\t// between samples in a delay line.\r\n\t\tconst g: number = (1.0 - delay) / (1.0 + delay);\r\n\t\tthis.a[1] = g;\r\n\t\tthis.b[0] = g;\r\n\t\tthis.b[1] = 1.0;\r\n\t\tthis.order = 1;\r\n\t}\r\n\t\r\n\tpublic lowPass2ndOrderButterworth(cornerRadiansPerSample: number, peakLinearGain: number): void {\r\n\t\t// This is Butterworth if peakLinearGain=1/√2 according to:\r\n\t\t// http://web.archive.org/web/20191213120120/https://crypto.stanford.edu/~blynn/sound/analog.html\r\n\t\t// An interesting property is that if peakLinearGain=1/16 then the\r\n\t\t// output resembles a first-order lowpass at a cutoff 4 octaves lower,\r\n\t\t// although it gets distorted near the nyquist.\r\n\t\tconst alpha: number = Math.sin(cornerRadiansPerSample) / (2.0 * peakLinearGain);\r\n\t\tconst cos: number = Math.cos(cornerRadiansPerSample);\r\n\t\tconst a0: number = 1.0 + alpha;\r\n\t\tthis.a[1] = -2.0*cos / a0;\r\n\t\tthis.a[2] = (1 - alpha) / a0;\r\n\t\tthis.b[2] = this.b[0] = (1 - cos) / (2.0*a0);\r\n\t\tthis.b[1] = (1 - cos) / a0;\r\n\t\tthis.order = 2;\r\n\t}\r\n\t\r\n\tpublic lowPass2ndOrderSimplified(cornerRadiansPerSample: number, peakLinearGain: number): void {\r\n\t\t// This filter is adapted from the one in the SFXR source code:\r\n\t\t// https://www.drpetter.se/project_sfxr.html\r\n\t\t// The output is nearly identical to the resonant Butterworth low-pass\r\n\t\t// above, except it resonates too much when the cutoff appoaches the\r\n\t\t// nyquist. If the resonance is set to zero and the cutoff is set to\r\n\t\t// nyquist/3, then the output is the same as the input.\r\n\t\tconst g: number = 2.0 * Math.sin(cornerRadiansPerSample / 2.0);\r\n\t\tconst filterResonance: number = 1.0 - 1.0 / (2.0 * peakLinearGain);\r\n\t\tconst feedback: number = filterResonance + filterResonance / (1.0 - g);\r\n\t\tthis.a[1] = 2.0*g + (g - 1.0) * g*feedback - 2.0;\r\n\t\tthis.a[2] = (g - 1.0) * (g - g*feedback - 1.0);\r\n\t\tthis.b[0] = g*g;\r\n\t\tthis.b[1] = 0;\r\n\t\tthis.b[2] = 0;\r\n\t\tthis.order = 2;\r\n\t}\r\n\t\r\n\tpublic highPass2ndOrderButterworth(cornerRadiansPerSample: number, peakLinearGain: number): void {\r\n\t\tconst alpha: number = Math.sin(cornerRadiansPerSample) / (2 * peakLinearGain);\r\n\t\tconst cos: number = Math.cos(cornerRadiansPerSample);\r\n\t\tconst a0: number = 1.0 + alpha;\r\n\t\tthis.a[1] = -2.0*cos / a0;\r\n\t\tthis.a[2] = (1.0 - alpha) / a0;\r\n\t\tthis.b[2] = this.b[0] = (1.0 + cos) / (2.0*a0);\r\n\t\tthis.b[1] = -(1.0 + cos) / a0;\r\n\t\tthis.order = 2;\r\n\t}\r\n\t/*\r\n\tpublic highPass2ndOrderSimplified(cornerRadiansPerSample: number, peakLinearGain: number): void {\r\n\t\tconst g: number = 2.0 * Math.sin(cornerRadiansPerSample * 0.5);\r\n\t\tconst filterResonance: number = 1.0 - 1.0 / (2.0 * peakLinearGain);\r\n\t\tconst feedback: number = filterResonance + filterResonance / (1.0 - g);\r\n\t\tthis.a[1] = 2.0*g + (g - 1.0) * g*feedback - 2.0;\r\n\t\tthis.a[2] = (g - 1.0) * (g - g*feedback - 1.0);\r\n\t\tthis.b[0] = 1.0;\r\n\t\tthis.b[1] = -2.0;\r\n\t\tthis.b[2] = 1.0;\r\n\t\tthis.order = 2;\r\n\t}\r\n\t*/\r\n\tpublic peak2ndOrder(cornerRadiansPerSample: number, peakLinearGain: number, bandWidthScale: number): void {\r\n\t\tconst sqrtGain: number = Math.sqrt(peakLinearGain);\r\n\t\tconst bandWidth: number = bandWidthScale * cornerRadiansPerSample / (sqrtGain >= 1 ? sqrtGain : 1/sqrtGain);\r\n\t\t//const bandWidth: number = bandWidthScale * cornerRadiansPerSample / Math.max(sqrtGain, 1.0);\r\n\t\tconst alpha: number = Math.tan(bandWidth * 0.5);\r\n\t\tconst a0: number = 1.0 + alpha / sqrtGain;\r\n\t\tthis.b[0] = (1.0 + alpha * sqrtGain) / a0;\r\n\t\tthis.b[1] = this.a[1] = -2.0 * Math.cos(cornerRadiansPerSample) / a0;\r\n\t\tthis.b[2] = (1.0 - alpha * sqrtGain) / a0;\r\n\t\tthis.a[2] = (1.0 - alpha / sqrtGain) / a0;\r\n\t\tthis.order = 2;\r\n\t}\r\n\t/*\r\n\t// Create a higher order filter by combining two lower order filters.\r\n\t// However, making high order filters in this manner results in instability.\r\n\t// It is recommended to apply the 2nd order filters (biquads) in sequence instead.\r\n\tpublic combination(filter1: FilterCoefficients, filter2: FilterCoefficients): void {\r\n\t\tthis.order = filter1.order + filter2.order;\r\n\t\tfor (let i: number = 0; i <= this.order; i++) {\r\n\t\t\tthis.a[i] = 0.0;\r\n\t\t\tthis.b[i] = 0.0;\r\n\t\t}\r\n\t\tfor (let i: number = 0; i <= filter1.order; i++) {\r\n\t\t\tfor (let j: number = 0; j <= filter2.order; j++) {\r\n\t\t\t\tthis.a[i + j] += filter1.a[i] * filter2.a[j];\r\n\t\t\t\tthis.b[i + j] += filter1.b[i] * filter2.b[j];\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic scaledDifference(other: FilterCoefficients, scale: number): void {\r\n\t\tif (other.order != this.order) throw new Error();\r\n\t\tfor (let i: number = 0; i <= this.order; i++) {\r\n\t\t\tthis.a[i] = (this.a[i] - other.a[i]) * scale;\r\n\t\t\tthis.b[i] = (this.b[i] - other.b[i]) * scale;\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic copy(other: FilterCoefficients): void {\r\n\t\tthis.order = other.order;\r\n\t\tfor (let i: number = 0; i <= this.order; i++) {\r\n\t\t\tthis.a[i] = other.a[i];\r\n\t\t\tthis.b[i] = other.b[i];\r\n\t\t}\r\n\t}\r\n\t*/\r\n}\r\n\r\nexport class FrequencyResponse {\r\n\tpublic real: number = 0.0;\r\n\tpublic imag: number = 0.0;\r\n\tpublic denom: number = 1.0;\r\n\t\r\n\tpublic analyze(filter: FilterCoefficients, radiansPerSample: number): void {\r\n\t\tthis.analyzeComplex(filter, Math.cos(radiansPerSample), Math.sin(radiansPerSample));\r\n\t}\r\n\t\r\n\tpublic analyzeComplex(filter: FilterCoefficients, real: number, imag: number): void {\r\n\t\tconst a: number[] = filter.a;\r\n\t\tconst b: number[] = filter.b;\r\n\t\tconst realZ1: number = real;\r\n\t\tconst imagZ1: number = -imag;\r\n\t\tlet realNum: number = b[0] + b[1] * realZ1;\r\n\t\tlet imagNum: number = b[1] * imagZ1;\r\n\t\tlet realDenom: number = 1.0 + a[1] * realZ1;\r\n\t\tlet imagDenom: number = a[1] * imagZ1;\r\n\t\tlet realZ: number = realZ1;\r\n\t\tlet imagZ: number = imagZ1;\r\n\t\tfor (let i: number = 2; i <= filter.order; i++) {\r\n\t\t\tconst realTemp: number = realZ * realZ1 - imagZ * imagZ1;\r\n\t\t\tconst imagTemp: number = realZ * imagZ1 + imagZ * realZ1;\r\n\t\t\trealZ = realTemp;\r\n\t\t\timagZ = imagTemp;\r\n\t\t\trealNum += b[i] * realZ;\r\n\t\t\timagNum += b[i] * imagZ;\r\n\t\t\trealDenom += a[i] * realZ;\r\n\t\t\timagDenom += a[i] * imagZ;\r\n\t\t}\r\n\t\tthis.denom = realDenom * realDenom + imagDenom * imagDenom;\r\n\t\tthis.real = realNum * realDenom + imagNum * imagDenom;\r\n\t\tthis.imag = imagNum * realDenom - realNum * imagDenom;\r\n\t}\r\n\t\r\n\tpublic magnitude(): number {\r\n\t\treturn Math.sqrt(this.real * this.real + this.imag * this.imag) / this.denom;\r\n\t}\r\n\t\r\n\tpublic angle(): number {\r\n\t\treturn Math.atan2(this.imag, this.real);\r\n\t}\r\n}\r\n\r\nexport class DynamicBiquadFilter {\r\n\tpublic a1: number = 0.0;\r\n\tpublic a2: number = 0.0;\r\n\tpublic b0: number = 1.0;\r\n\tpublic b1: number = 0.0;\r\n\tpublic b2: number = 0.0;\r\n\tpublic a1Delta: number = 0.0;\r\n\tpublic a2Delta: number = 0.0;\r\n\tpublic b0Delta: number = 0.0;\r\n\tpublic b1Delta: number = 0.0;\r\n\tpublic b2Delta: number = 0.0;\r\n\tpublic output1: number = 0.0;\r\n\tpublic output2: number = 0.0;\r\n\t\r\n\t// Some filter types are more stable when interpolating between coefficients\r\n\t// if the \"b\" coefficient interpolation is multiplicative. Don't enable this\r\n\t// for filter types where the \"b\" coefficients might change sign!\r\n\tpublic useMultiplicativeInputCoefficients: boolean = false;\r\n\t\r\n\tpublic resetOutput(): void {\r\n\t\tthis.output1 = 0.0;\r\n\t\tthis.output2 = 0.0;\r\n\t}\r\n\t\r\n\tpublic loadCoefficientsWithGradient(start: FilterCoefficients, end: FilterCoefficients, deltaRate: number, useMultiplicativeInputCoefficients: boolean): void {\r\n\t\tif (start.order != 2 || end.order != 2) throw new Error();\r\n\t\tthis.a1 = start.a[1];\r\n\t\tthis.a2 = start.a[2];\r\n\t\tthis.b0 = start.b[0];\r\n\t\tthis.b1 = start.b[1];\r\n\t\tthis.b2 = start.b[2];\r\n\t\tthis.a1Delta = (end.a[1] - start.a[1]) * deltaRate;\r\n\t\tthis.a2Delta = (end.a[2] - start.a[2]) * deltaRate;\r\n\t\tif (useMultiplicativeInputCoefficients) {\r\n\t\t\tthis.b0Delta = Math.pow(end.b[0] / start.b[0], deltaRate);\r\n\t\t\tthis.b1Delta = Math.pow(end.b[1] / start.b[1], deltaRate);\r\n\t\t\tthis.b2Delta = Math.pow(end.b[2] / start.b[2], deltaRate);\r\n\t\t} else {\r\n\t\t\tthis.b0Delta = (end.b[0] - start.b[0]) * deltaRate;\r\n\t\t\tthis.b1Delta = (end.b[1] - start.b[1]) * deltaRate;\r\n\t\t\tthis.b2Delta = (end.b[2] - start.b[2]) * deltaRate;\r\n\t\t}\r\n\t\tthis.useMultiplicativeInputCoefficients = useMultiplicativeInputCoefficients;\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { Dictionary, DictionaryArray, FilterType, EnvelopeType, InstrumentType, EffectType, EnvelopeComputeIndex, Transition, Unison, Chord, Vibrato, Envelope, AutomationTarget, Config, getDrumWave, drawNoiseSpectrum, getArpeggioPitchIndex, performIntegralOld, getPulseWidthRatio, effectsIncludeTransition, effectsIncludeChord, effectsIncludePitchShift, effectsIncludeDetune, effectsIncludeVibrato, effectsIncludeNoteFilter, effectsIncludeDistortion, effectsIncludeBitcrusher, effectsIncludePanning, effectsIncludeChorus, effectsIncludeEcho, effectsIncludeReverb, OperatorWave } from \"./SynthConfig\";\r\nimport { EditorConfig } from \"../editor/EditorConfig\";\r\nimport { scaleElementsByFactor, inverseRealFourierTransform } from \"./FFT\";\r\nimport { Deque } from \"./Deque\";\r\nimport { FilterCoefficients, FrequencyResponse, DynamicBiquadFilter } from \"./filtering\";\r\n\r\ndeclare global {\r\n    interface Window {\r\n        AudioContext: any;\r\n        webkitAudioContext: any;\r\n    }\r\n}\r\n\r\nconst epsilon: number = (1.0e-24); // For detecting and avoiding float denormals, which have poor performance.\r\n\r\n// For performance debugging:\r\n//let samplesAccumulated: number = 0;\r\n//let samplePerformance: number = 0;\r\n\r\nexport function clamp(min: number, max: number, val: number): number {\r\n    max = max - 1;\r\n    if (val <= max) {\r\n        if (val >= min) return val;\r\n        else return min;\r\n    } else {\r\n        return max;\r\n    }\r\n}\r\n\r\nfunction validateRange(min: number, max: number, val: number): number {\r\n    if (min <= val && val <= max) return val;\r\n    throw new Error(`Value ${val} not in range [${min}, ${max}]`);\r\n}\r\n\r\nconst enum CharCode {\r\n    SPACE = 32,\r\n    HASH = 35,\r\n    PERCENT = 37,\r\n    AMPERSAND = 38,\r\n    PLUS = 43,\r\n    DASH = 45,\r\n    DOT = 46,\r\n    NUM_0 = 48,\r\n    NUM_1 = 49,\r\n    NUM_2 = 50,\r\n    NUM_3 = 51,\r\n    NUM_4 = 52,\r\n    NUM_5 = 53,\r\n    NUM_6 = 54,\r\n    NUM_7 = 55,\r\n    NUM_8 = 56,\r\n    NUM_9 = 57,\r\n    EQUALS = 61,\r\n    A = 65,\r\n    B = 66,\r\n    C = 67,\r\n    D = 68,\r\n    E = 69,\r\n    F = 70,\r\n    G = 71,\r\n    H = 72,\r\n    I = 73,\r\n    J = 74,\r\n    K = 75,\r\n    L = 76,\r\n    M = 77,\r\n    N = 78,\r\n    O = 79,\r\n    P = 80,\r\n    Q = 81,\r\n    R = 82,\r\n    S = 83,\r\n    T = 84,\r\n    U = 85,\r\n    V = 86,\r\n    W = 87,\r\n    X = 88,\r\n    Y = 89,\r\n    Z = 90,\r\n    UNDERSCORE = 95,\r\n    a = 97,\r\n    b = 98,\r\n    c = 99,\r\n    d = 100,\r\n    e = 101,\r\n    f = 102,\r\n    g = 103,\r\n    h = 104,\r\n    i = 105,\r\n    j = 106,\r\n    k = 107,\r\n    l = 108,\r\n    m = 109,\r\n    n = 110,\r\n    o = 111,\r\n    p = 112,\r\n    q = 113,\r\n    r = 114,\r\n    s = 115,\r\n    t = 116,\r\n    u = 117,\r\n    v = 118,\r\n    w = 119,\r\n    x = 120,\r\n    y = 121,\r\n    z = 122,\r\n    LEFT_CURLY_BRACE = 123,\r\n    RIGHT_CURLY_BRACE = 125,\r\n}\r\n\r\nconst enum SongTagCode {\r\n    beatCount = CharCode.a, // added in song url version 2\r\n    bars = CharCode.b, // added in 2\r\n    vibrato = CharCode.c, // added in 2, DEPRECATED\r\n    fadeInOut = CharCode.d, // added in 3 for transition, switched to fadeInOut in 9\r\n    loopEnd = CharCode.e, // added in 2\r\n    eqFilter = CharCode.f, // added in 3\r\n    barCount = CharCode.g, // added in 3\r\n    unison = CharCode.h, // added in 2\r\n    instrumentCount = CharCode.i, // added in 3\r\n    patternCount = CharCode.j, // added in 3\r\n    key = CharCode.k, // added in 2\r\n    loopStart = CharCode.l, // added in 2\r\n    reverb = CharCode.m, // added in 5, DEPRECATED\r\n    channelCount = CharCode.n, // added in 6\r\n    channelOctave = CharCode.o, // added in 3\r\n    patterns = CharCode.p, // added in 2\r\n    effects = CharCode.q, // added in 7\r\n    rhythm = CharCode.r, // added in 2\r\n    scale = CharCode.s, // added in 2\r\n    tempo = CharCode.t, // added in 2\r\n    preset = CharCode.u, // added in 7\r\n    volume = CharCode.v, // added in 2\r\n    wave = CharCode.w, // added in 2\r\n\r\n    filterResonance = CharCode.y, // added in 7, DEPRECATED\r\n    drumsetEnvelopes = CharCode.z, // added in 7 for filter envelopes, still used for drumset envelopes\r\n    algorithm = CharCode.A, // added in 6\r\n    feedbackAmplitude = CharCode.B, // added in 6\r\n    chord = CharCode.C, // added in 7, DEPRECATED\r\n    detune = CharCode.D, // [JB], added in 3(?), DEPRECATED\r\n    envelopes = CharCode.E, // added in 6 for FM operator envelopes, repurposed in 9 for general envelopes.\r\n    feedbackType = CharCode.F, // added in 6\r\n    arpeggioSpeed = CharCode.G, // [JB], added in 3, DEPRECATED\r\n    harmonics = CharCode.H, // added in 7\r\n    stringSustain = CharCode.I, // added in 9\r\n\r\n    pan = CharCode.L, // added between 8 and 9, DEPRECATED\r\n    customChipWave = CharCode.M, // [JB], added in 1(?)\r\n    songTitle = CharCode.N, // [JB], added in 1(?)\r\n    limiterSettings = CharCode.O, // [JB], added in 3(?)\r\n\r\n    operatorAmplitudes = CharCode.P, // added in 6\r\n    operatorFrequencies = CharCode.Q, // added in 6\r\n    operatorWaves = CharCode.R, // [JB], added in 4\r\n    spectrum = CharCode.S, // added in 7\r\n    startInstrument = CharCode.T, // added in 6\r\n    channelNames = CharCode.U, // [JB], added in 4(?)\r\n    feedbackEnvelope = CharCode.V, // added in 6, DEPRECATED\r\n    pulseWidth = CharCode.W, // added in 7\r\n    aliases = CharCode.X, // [JB], added in 4, DEPRECATED\r\n\r\n}\r\n\r\nconst base64IntToCharCode: ReadonlyArray<number> = [48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 45, 95];\r\nconst base64CharCodeToInt: ReadonlyArray<number> = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 62, 62, 0, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 0, 0, 0, 0, 0, 0, 0, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 0, 0, 0, 0, 63, 0, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 0, 0, 0, 0, 0]; // 62 could be represented by either \"-\" or \".\" for historical reasons. New songs should use \"-\".\r\n\r\nclass BitFieldReader {\r\n    private _bits: number[] = [];\r\n    private _readIndex: number = 0;\r\n\r\n    constructor(source: string, startIndex: number, stopIndex: number) {\r\n        for (let i: number = startIndex; i < stopIndex; i++) {\r\n            const value: number = base64CharCodeToInt[source.charCodeAt(i)];\r\n            this._bits.push((value >> 5) & 0x1);\r\n            this._bits.push((value >> 4) & 0x1);\r\n            this._bits.push((value >> 3) & 0x1);\r\n            this._bits.push((value >> 2) & 0x1);\r\n            this._bits.push((value >> 1) & 0x1);\r\n            this._bits.push(value & 0x1);\r\n        }\r\n    }\r\n\r\n    public read(bitCount: number): number {\r\n        let result: number = 0;\r\n        while (bitCount > 0) {\r\n            result = result << 1;\r\n            result += this._bits[this._readIndex++];\r\n            bitCount--;\r\n        }\r\n        return result;\r\n    }\r\n\r\n    public readLongTail(minValue: number, minBits: number): number {\r\n        let result: number = minValue;\r\n        let numBits: number = minBits;\r\n        while (this._bits[this._readIndex++]) {\r\n            result += 1 << numBits;\r\n            numBits++;\r\n        }\r\n        while (numBits > 0) {\r\n            numBits--;\r\n            if (this._bits[this._readIndex++]) {\r\n                result += 1 << numBits;\r\n            }\r\n        }\r\n        return result;\r\n    }\r\n\r\n    public readPartDuration(): number {\r\n        return this.readLongTail(1, 3);\r\n    }\r\n\r\n    public readLegacyPartDuration(): number {\r\n        return this.readLongTail(1, 2);\r\n    }\r\n\r\n    public readPinCount(): number {\r\n        return this.readLongTail(1, 0);\r\n    }\r\n\r\n    public readPitchInterval(): number {\r\n        if (this.read(1)) {\r\n            return -this.readLongTail(1, 3);\r\n        } else {\r\n            return this.readLongTail(1, 3);\r\n        }\r\n    }\r\n}\r\n\r\nclass BitFieldWriter {\r\n    private _index: number = 0;\r\n    private _bits: number[] = [];\r\n\r\n    public clear() {\r\n        this._index = 0;\r\n    }\r\n\r\n    public write(bitCount: number, value: number): void {\r\n        bitCount--;\r\n        while (bitCount >= 0) {\r\n            this._bits[this._index++] = (value >>> bitCount) & 1;\r\n            bitCount--;\r\n        }\r\n    }\r\n\r\n    public writeLongTail(minValue: number, minBits: number, value: number): void {\r\n        if (value < minValue) throw new Error(\"value out of bounds\");\r\n        value -= minValue;\r\n        let numBits: number = minBits;\r\n        while (value >= (1 << numBits)) {\r\n            this._bits[this._index++] = 1;\r\n            value -= 1 << numBits;\r\n            numBits++;\r\n        }\r\n        this._bits[this._index++] = 0;\r\n        while (numBits > 0) {\r\n            numBits--;\r\n            this._bits[this._index++] = (value >>> numBits) & 1;\r\n        }\r\n    }\r\n\r\n    public writePartDuration(value: number): void {\r\n        this.writeLongTail(1, 3, value);\r\n    }\r\n\r\n    public writePinCount(value: number): void {\r\n        this.writeLongTail(1, 0, value);\r\n    }\r\n\r\n    public writePitchInterval(value: number): void {\r\n        if (value < 0) {\r\n            this.write(1, 1); // sign\r\n            this.writeLongTail(1, 3, -value);\r\n        } else {\r\n            this.write(1, 0); // sign\r\n            this.writeLongTail(1, 3, value);\r\n        }\r\n    }\r\n\r\n    public concat(other: BitFieldWriter): void {\r\n        for (let i: number = 0; i < other._index; i++) {\r\n            this._bits[this._index++] = other._bits[i];\r\n        }\r\n    }\r\n\r\n    public encodeBase64(buffer: number[]): number[] {\r\n\r\n        for (let i: number = 0; i < this._index; i += 6) {\r\n            const value: number = (this._bits[i] << 5) | (this._bits[i + 1] << 4) | (this._bits[i + 2] << 3) | (this._bits[i + 3] << 2) | (this._bits[i + 4] << 1) | this._bits[i + 5];\r\n            buffer.push(base64IntToCharCode[value]);\r\n        }\r\n        return buffer;\r\n    }\r\n\r\n    public lengthBase64(): number {\r\n        return Math.ceil(this._index / 6);\r\n    }\r\n}\r\n\r\nexport interface NotePin {\r\n    interval: number;\r\n    time: number;\r\n    size: number;\r\n}\r\n\r\nexport function makeNotePin(interval: number, time: number, size: number): NotePin {\r\n    return { interval: interval, time: time, size: size };\r\n}\r\n\r\nexport class Note {\r\n    public pitches: number[];\r\n    public pins: NotePin[];\r\n    public start: number;\r\n    public end: number;\r\n    public continuesLastPattern: boolean;\r\n\r\n    public constructor(pitch: number, start: number, end: number, size: number, fadeout: boolean = false) {\r\n        this.pitches = [pitch];\r\n        this.pins = [makeNotePin(0, 0, size), makeNotePin(0, end - start, fadeout ? 0 : size)];\r\n        this.start = start;\r\n        this.end = end;\r\n        this.continuesLastPattern = false;\r\n    }\r\n\r\n    public pickMainInterval(): number {\r\n        let longestFlatIntervalDuration: number = 0;\r\n        let mainInterval: number = 0;\r\n        for (let pinIndex: number = 1; pinIndex < this.pins.length; pinIndex++) {\r\n            const pinA: NotePin = this.pins[pinIndex - 1];\r\n            const pinB: NotePin = this.pins[pinIndex];\r\n            if (pinA.interval == pinB.interval) {\r\n                const duration: number = pinB.time - pinA.time;\r\n                if (longestFlatIntervalDuration < duration) {\r\n                    longestFlatIntervalDuration = duration;\r\n                    mainInterval = pinA.interval;\r\n                }\r\n            }\r\n        }\r\n        if (longestFlatIntervalDuration == 0) {\r\n            let loudestSize: number = 0;\r\n            for (let pinIndex: number = 0; pinIndex < this.pins.length; pinIndex++) {\r\n                const pin: NotePin = this.pins[pinIndex];\r\n                if (loudestSize < pin.size) {\r\n                    loudestSize = pin.size;\r\n                    mainInterval = pin.interval;\r\n                }\r\n            }\r\n        }\r\n        return mainInterval;\r\n    }\r\n\r\n    public clone(): Note {\r\n        const newNote: Note = new Note(-1, this.start, this.end, 3);\r\n        newNote.pitches = this.pitches.concat();\r\n        newNote.pins = [];\r\n        for (const pin of this.pins) {\r\n            newNote.pins.push(makeNotePin(pin.interval, pin.time, pin.size));\r\n        }\r\n        newNote.continuesLastPattern = this.continuesLastPattern;\r\n        return newNote;\r\n    }\r\n\r\n    public getEndPinIndex(part: number): number {\r\n        let endPinIndex: number;\r\n        for (endPinIndex = 1; endPinIndex < this.pins.length - 1; endPinIndex++) {\r\n            if (this.pins[endPinIndex].time + this.start > part) break;\r\n        }\r\n        return endPinIndex;\r\n    }\r\n}\r\n\r\nexport class Pattern {\r\n    public notes: Note[] = [];\r\n    public readonly instruments: number[] = [0];\r\n\r\n    public cloneNotes(): Note[] {\r\n        const result: Note[] = [];\r\n        for (const note of this.notes) {\r\n            result.push(note.clone());\r\n        }\r\n        return result;\r\n    }\r\n\r\n    public reset(): void {\r\n        this.notes.length = 0;\r\n        this.instruments[0] = 0;\r\n        this.instruments.length = 1;\r\n    }\r\n\r\n    public toJsonObject(song: Song, channel: Channel, isModChannel: boolean): any {\r\n        const noteArray: Object[] = [];\r\n        for (const note of this.notes) {\r\n            // Only one ins per pattern is enforced in mod channels.\r\n            let instrument: Instrument = channel.instruments[this.instruments[0]];\r\n            let mod: number = Math.max(0, Config.modCount - note.pitches[0] - 1);\r\n            let volumeCap: number = song.getVolumeCapForSetting(isModChannel, instrument.modulators[mod], instrument.modFilterTypes[mod]);\r\n            const pointArray: Object[] = [];\r\n            for (const pin of note.pins) {\r\n                let useVol: number = isModChannel ? Math.round(pin.size) : Math.round(pin.size * 100 / volumeCap);\r\n                pointArray.push({\r\n                    \"tick\": (pin.time + note.start) * Config.rhythms[song.rhythm].stepsPerBeat / Config.partsPerBeat,\r\n                    \"pitchBend\": pin.interval,\r\n                    \"volume\": useVol,\r\n                    \"forMod\": isModChannel,\r\n                });\r\n            }\r\n\r\n            const noteObject: any = {\r\n                \"pitches\": note.pitches,\r\n                \"points\": pointArray,\r\n            };\r\n            if (note.start == 0) {\r\n                noteObject[\"continuesLastPattern\"] = note.continuesLastPattern;\r\n            }\r\n            noteArray.push(noteObject);\r\n        }\r\n\r\n        const patternObject: any = { \"notes\": noteArray };\r\n        if (song.patternInstruments) {\r\n            patternObject[\"instruments\"] = this.instruments.map(i => i + 1);\r\n        }\r\n        return patternObject;\r\n    }\r\n\r\n    public fromJsonObject(patternObject: any, song: Song, channel: Channel, importedPartsPerBeat: number, isNoiseChannel: boolean, isModChannel: boolean): void {\r\n        if (song.patternInstruments) {\r\n            if (Array.isArray(patternObject[\"instruments\"])) {\r\n                const instruments: any[] = patternObject[\"instruments\"];\r\n                const instrumentCount: number = clamp(Config.instrumentCountMin, song.getMaxInstrumentsPerPatternForChannel(channel) + 1, instruments.length);\r\n                for (let j: number = 0; j < instrumentCount; j++) {\r\n                    this.instruments[j] = clamp(0, channel.instruments.length, (instruments[j] | 0) - 1);\r\n                }\r\n                this.instruments.length = instrumentCount;\r\n            } else {\r\n                this.instruments[0] = clamp(0, channel.instruments.length, (patternObject[\"instrument\"] | 0) - 1);\r\n                this.instruments.length = 1;\r\n            }\r\n        }\r\n\r\n        if (patternObject[\"notes\"] && patternObject[\"notes\"].length > 0) {\r\n            const maxNoteCount: number = Math.min(song.beatsPerBar * Config.partsPerBeat * (isModChannel ? Config.modCount : 1), patternObject[\"notes\"].length >>> 0);\r\n\r\n            // TODO: Consider supporting notes specified in any timing order, sorting them and truncating as necessary.\r\n            //let tickClock: number = 0;\r\n            for (let j: number = 0; j < patternObject[\"notes\"].length; j++) {\r\n                if (j >= maxNoteCount) break;\r\n\r\n                const noteObject = patternObject[\"notes\"][j];\r\n                if (!noteObject || !noteObject[\"pitches\"] || !(noteObject[\"pitches\"].length >= 1) || !noteObject[\"points\"] || !(noteObject[\"points\"].length >= 2)) {\r\n                    continue;\r\n                }\r\n\r\n                const note: Note = new Note(0, 0, 0, 0);\r\n                note.pitches = [];\r\n                note.pins = [];\r\n\r\n                for (let k: number = 0; k < noteObject[\"pitches\"].length; k++) {\r\n                    const pitch: number = noteObject[\"pitches\"][k] | 0;\r\n                    if (note.pitches.indexOf(pitch) != -1) continue;\r\n                    note.pitches.push(pitch);\r\n                    if (note.pitches.length >= Config.maxChordSize) break;\r\n                }\r\n                if (note.pitches.length < 1) continue;\r\n\r\n                //let noteClock: number = tickClock;\r\n                let startInterval: number = 0;\r\n                for (let k: number = 0; k < noteObject[\"points\"].length; k++) {\r\n                    const pointObject: any = noteObject[\"points\"][k];\r\n                    if (pointObject == undefined || pointObject[\"tick\"] == undefined) continue;\r\n                    const interval: number = (pointObject[\"pitchBend\"] == undefined) ? 0 : (pointObject[\"pitchBend\"] | 0);\r\n\r\n                    const time: number = Math.round((+pointObject[\"tick\"]) * Config.partsPerBeat / importedPartsPerBeat);\r\n\r\n                    let instrument: Instrument = channel.instruments[this.instruments[0]];\r\n                    let mod: number = Math.max(0, Config.modCount - note.pitches[0] - 1);\r\n\r\n                    // Only one instrument per pattern allowed in mod channels.\r\n                    let volumeCap: number = song.getVolumeCapForSetting(isModChannel, instrument.modulators[mod], instrument.modFilterTypes[mod]);\r\n\r\n                    // The strange volume formula used for notes is not needed for mods. Some rounding errors were possible.\r\n                    // A \"forMod\" signifier was added to new JSON export to detect when the higher precision export was used in a file.\r\n                    let size: number;\r\n                    if (pointObject[\"volume\"] == undefined) {\r\n                        size = volumeCap;\r\n                    } else if (pointObject[\"forMod\"] == undefined) {\r\n                        size = Math.max(0, Math.min(volumeCap, Math.round((pointObject[\"volume\"] | 0) * volumeCap / 100)));\r\n                    }\r\n                    else {\r\n                        size = ((pointObject[\"forMod\"] | 0) > 0) ? Math.round(pointObject[\"volume\"] | 0) : Math.max(0, Math.min(volumeCap, Math.round((pointObject[\"volume\"] | 0) * volumeCap / 100)));\r\n                    }\r\n\r\n                    if (time > song.beatsPerBar * Config.partsPerBeat) continue;\r\n                    if (note.pins.length == 0) {\r\n                        //if (time < noteClock) continue;\r\n                        note.start = time;\r\n                        startInterval = interval;\r\n                    } else {\r\n                        //if (time <= noteClock) continue;\r\n                    }\r\n                    //noteClock = time;\r\n\r\n                    note.pins.push(makeNotePin(interval - startInterval, time - note.start, size));\r\n                }\r\n                if (note.pins.length < 2) continue;\r\n\r\n                note.end = note.pins[note.pins.length - 1].time + note.start;\r\n\r\n                const maxPitch: number = isNoiseChannel ? Config.drumCount - 1 : Config.maxPitch;\r\n                let lowestPitch: number = maxPitch;\r\n                let highestPitch: number = 0;\r\n                for (let k: number = 0; k < note.pitches.length; k++) {\r\n                    note.pitches[k] += startInterval;\r\n                    if (note.pitches[k] < 0 || note.pitches[k] > maxPitch) {\r\n                        note.pitches.splice(k, 1);\r\n                        k--;\r\n                    }\r\n                    if (note.pitches[k] < lowestPitch) lowestPitch = note.pitches[k];\r\n                    if (note.pitches[k] > highestPitch) highestPitch = note.pitches[k];\r\n                }\r\n                if (note.pitches.length < 1) continue;\r\n\r\n                for (let k: number = 0; k < note.pins.length; k++) {\r\n                    const pin: NotePin = note.pins[k];\r\n                    if (pin.interval + lowestPitch < 0) pin.interval = -lowestPitch;\r\n                    if (pin.interval + highestPitch > maxPitch) pin.interval = maxPitch - highestPitch;\r\n                    if (k >= 2) {\r\n                        if (pin.interval == note.pins[k - 1].interval &&\r\n                            pin.interval == note.pins[k - 2].interval &&\r\n                            pin.size == note.pins[k - 1].size &&\r\n                            pin.size == note.pins[k - 2].size) {\r\n                            note.pins.splice(k - 1, 1);\r\n                            k--;\r\n                        }\r\n                    }\r\n                }\r\n\r\n                if (note.start == 0) {\r\n                    note.continuesLastPattern = (noteObject[\"continuesLastPattern\"] === true);\r\n                } else {\r\n                    note.continuesLastPattern = false;\r\n                }\r\n\r\n                this.notes.push(note);\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nexport class Operator {\r\n    public frequency: number = 0;\r\n    public amplitude: number = 0;\r\n    public waveform: number = 0;\r\n    public pulseWidth: number = 0.5;\r\n\r\n    constructor(index: number) {\r\n        this.reset(index);\r\n    }\r\n\r\n    public reset(index: number): void {\r\n        this.frequency = 0;\r\n        this.amplitude = (index <= 1) ? Config.operatorAmplitudeMax : 0;\r\n        this.waveform = 0;\r\n        this.pulseWidth = 5;\r\n    }\r\n\r\n    public copy(other: Operator): void {\r\n        this.frequency = other.frequency;\r\n        this.amplitude = other.amplitude;\r\n        this.waveform = other.waveform;\r\n        this.pulseWidth = other.pulseWidth;\r\n    }\r\n}\r\n\r\nexport class SpectrumWave {\r\n    public spectrum: number[] = [];\r\n    public hash: number = -1;\r\n\r\n    constructor(isNoiseChannel: boolean) {\r\n        this.reset(isNoiseChannel);\r\n    }\r\n\r\n    public reset(isNoiseChannel: boolean): void {\r\n        for (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n            if (isNoiseChannel) {\r\n                this.spectrum[i] = Math.round(Config.spectrumMax * (1 / Math.sqrt(1 + i / 3)));\r\n            } else {\r\n                const isHarmonic: boolean = i == 0 || i == 7 || i == 11 || i == 14 || i == 16 || i == 18 || i == 21 || i == 23 || i >= 25;\r\n                this.spectrum[i] = isHarmonic ? Math.max(0, Math.round(Config.spectrumMax * (1 - i / 30))) : 0;\r\n            }\r\n        }\r\n        this.markCustomWaveDirty();\r\n    }\r\n\r\n    public markCustomWaveDirty(): void {\r\n        const hashMult: number = Synth.fittingPowerOfTwo(Config.spectrumMax + 2) - 1;\r\n        let hash: number = 0;\r\n        for (const point of this.spectrum) hash = ((hash * hashMult) + point) >>> 0;\r\n        this.hash = hash;\r\n    }\r\n}\r\n\r\nclass SpectrumWaveState {\r\n    public wave: Float32Array | null = null;\r\n    private _hash: number = -1;\r\n\r\n    public getCustomWave(settings: SpectrumWave, lowestOctave: number): Float32Array {\r\n        if (this._hash == settings.hash) return this.wave!;\r\n        this._hash = settings.hash;\r\n\r\n        const waveLength: number = Config.spectrumNoiseLength;\r\n        if (this.wave == null || this.wave.length != waveLength + 1) {\r\n            this.wave = new Float32Array(waveLength + 1);\r\n        }\r\n        const wave: Float32Array = this.wave;\r\n\r\n        for (let i: number = 0; i < waveLength; i++) {\r\n            wave[i] = 0;\r\n        }\r\n\r\n        const highestOctave: number = 14;\r\n        const falloffRatio: number = 0.25;\r\n        // Nudge the 2/7 and 4/7 control points so that they form harmonic intervals.\r\n        const pitchTweak: number[] = [0, 1 / 7, Math.log2(5 / 4), 3 / 7, Math.log2(3 / 2), 5 / 7, 6 / 7];\r\n        function controlPointToOctave(point: number): number {\r\n            return lowestOctave + Math.floor(point / Config.spectrumControlPointsPerOctave) + pitchTweak[(point + Config.spectrumControlPointsPerOctave) % Config.spectrumControlPointsPerOctave];\r\n        }\r\n\r\n        let combinedAmplitude: number = 1;\r\n        for (let i: number = 0; i < Config.spectrumControlPoints + 1; i++) {\r\n            const value1: number = (i <= 0) ? 0 : settings.spectrum[i - 1];\r\n            const value2: number = (i >= Config.spectrumControlPoints) ? settings.spectrum[Config.spectrumControlPoints - 1] : settings.spectrum[i];\r\n            const octave1: number = controlPointToOctave(i - 1);\r\n            let octave2: number = controlPointToOctave(i);\r\n            if (i >= Config.spectrumControlPoints) octave2 = highestOctave + (octave2 - highestOctave) * falloffRatio;\r\n            if (value1 == 0 && value2 == 0) continue;\r\n\r\n            combinedAmplitude += 0.02 * drawNoiseSpectrum(wave, waveLength, octave1, octave2, value1 / Config.spectrumMax, value2 / Config.spectrumMax, -0.5);\r\n        }\r\n        if (settings.spectrum[Config.spectrumControlPoints - 1] > 0) {\r\n            combinedAmplitude += 0.02 * drawNoiseSpectrum(wave, waveLength, highestOctave + (controlPointToOctave(Config.spectrumControlPoints) - highestOctave) * falloffRatio, highestOctave, settings.spectrum[Config.spectrumControlPoints - 1] / Config.spectrumMax, 0, -0.5);\r\n        }\r\n\r\n        inverseRealFourierTransform(wave, waveLength);\r\n        scaleElementsByFactor(wave, 5.0 / (Math.sqrt(waveLength) * Math.pow(combinedAmplitude, 0.75)));\r\n\r\n        // Duplicate the first sample at the end for easier wrap-around interpolation.\r\n        wave[waveLength] = wave[0];\r\n\r\n        return wave;\r\n    }\r\n}\r\n\r\nexport class HarmonicsWave {\r\n    public harmonics: number[] = [];\r\n    public hash: number = -1;\r\n\r\n    constructor() {\r\n        this.reset();\r\n    }\r\n\r\n    public reset(): void {\r\n        for (let i: number = 0; i < Config.harmonicsControlPoints; i++) {\r\n            this.harmonics[i] = 0;\r\n        }\r\n        this.harmonics[0] = Config.harmonicsMax;\r\n        this.harmonics[3] = Config.harmonicsMax;\r\n        this.harmonics[6] = Config.harmonicsMax;\r\n        this.markCustomWaveDirty();\r\n    }\r\n\r\n    public markCustomWaveDirty(): void {\r\n        const hashMult: number = Synth.fittingPowerOfTwo(Config.harmonicsMax + 2) - 1;\r\n        let hash: number = 0;\r\n        for (const point of this.harmonics) hash = ((hash * hashMult) + point) >>> 0;\r\n        this.hash = hash;\r\n    }\r\n}\r\n\r\nclass HarmonicsWaveState {\r\n    public wave: Float32Array | null = null;\r\n    private _hash: number = -1;\r\n    private _generatedForType: InstrumentType;\r\n\r\n    public getCustomWave(settings: HarmonicsWave, instrumentType: InstrumentType): Float32Array {\r\n        if (this._hash == settings.hash && this._generatedForType == instrumentType) return this.wave!;\r\n        this._hash = settings.hash;\r\n        this._generatedForType = instrumentType;\r\n\r\n        const harmonicsRendered: number = (instrumentType == InstrumentType.pickedString) ? Config.harmonicsRenderedForPickedString : Config.harmonicsRendered;\r\n\r\n        const waveLength: number = Config.harmonicsWavelength;\r\n        const retroWave: Float32Array = getDrumWave(0, null, null);\r\n\r\n        if (this.wave == null || this.wave.length != waveLength + 1) {\r\n            this.wave = new Float32Array(waveLength + 1);\r\n        }\r\n        const wave: Float32Array = this.wave;\r\n\r\n        for (let i: number = 0; i < waveLength; i++) {\r\n            wave[i] = 0;\r\n        }\r\n\r\n        const overallSlope: number = -0.25;\r\n        let combinedControlPointAmplitude: number = 1;\r\n\r\n        for (let harmonicIndex: number = 0; harmonicIndex < harmonicsRendered; harmonicIndex++) {\r\n            const harmonicFreq: number = harmonicIndex + 1;\r\n            let controlValue: number = harmonicIndex < Config.harmonicsControlPoints ? settings.harmonics[harmonicIndex] : settings.harmonics[Config.harmonicsControlPoints - 1];\r\n            if (harmonicIndex >= Config.harmonicsControlPoints) {\r\n                controlValue *= 1 - (harmonicIndex - Config.harmonicsControlPoints) / (harmonicsRendered - Config.harmonicsControlPoints);\r\n            }\r\n            const normalizedValue: number = controlValue / Config.harmonicsMax;\r\n            let amplitude: number = Math.pow(2, controlValue - Config.harmonicsMax + 1) * Math.sqrt(normalizedValue);\r\n            if (harmonicIndex < Config.harmonicsControlPoints) {\r\n                combinedControlPointAmplitude += amplitude;\r\n            }\r\n            amplitude *= Math.pow(harmonicFreq, overallSlope);\r\n\r\n            // Multiply all the sine wave amplitudes by 1 or -1 based on the LFSR\r\n            // retro wave (effectively random) to avoid egregiously tall spikes.\r\n            amplitude *= retroWave[harmonicIndex + 589];\r\n\r\n            wave[waveLength - harmonicFreq] = amplitude;\r\n        }\r\n\r\n        inverseRealFourierTransform(wave, waveLength);\r\n\r\n        // Limit the maximum wave amplitude.\r\n        const mult: number = 1 / Math.pow(combinedControlPointAmplitude, 0.7);\r\n        for (let i: number = 0; i < wave.length; i++) wave[i] *= mult;\r\n\r\n        performIntegralOld(wave);\r\n\r\n        // The first sample should be zero, and we'll duplicate it at the end for easier interpolation.\r\n        wave[waveLength] = wave[0];\r\n\r\n        return wave;\r\n    }\r\n}\r\n\r\nexport class FilterControlPoint {\r\n    public freq: number = 0;\r\n    public gain: number = Config.filterGainCenter;\r\n    public type: FilterType = FilterType.peak;\r\n\r\n    public set(freqSetting: number, gainSetting: number): void {\r\n        this.freq = freqSetting;\r\n        this.gain = gainSetting;\r\n    }\r\n\r\n    public getHz(): number {\r\n        return FilterControlPoint.getHzFromSettingValue(this.freq);\r\n    }\r\n\r\n    public static getHzFromSettingValue(value: number): number {\r\n        return Config.filterFreqReferenceHz * Math.pow(2.0, (value - Config.filterFreqReferenceSetting) * Config.filterFreqStep);\r\n    }\r\n    public static getSettingValueFromHz(hz: number): number {\r\n        return Math.log2(hz / Config.filterFreqReferenceHz) / Config.filterFreqStep + Config.filterFreqReferenceSetting;\r\n    }\r\n    public static getRoundedSettingValueFromHz(hz: number): number {\r\n        return Math.max(0, Math.min(Config.filterFreqRange - 1, Math.round(FilterControlPoint.getSettingValueFromHz(hz))));\r\n    }\r\n\r\n    public getLinearGain(peakMult: number = 1.0): number {\r\n        const power: number = (this.gain - Config.filterGainCenter) * Config.filterGainStep;\r\n        const neutral: number = (this.type == FilterType.peak) ? 0.0 : -0.5;\r\n        const interpolatedPower: number = neutral + (power - neutral) * peakMult;\r\n        return Math.pow(2.0, interpolatedPower);\r\n    }\r\n    public static getRoundedSettingValueFromLinearGain(linearGain: number): number {\r\n        return Math.max(0, Math.min(Config.filterGainRange - 1, Math.round(Math.log2(linearGain) / Config.filterGainStep + Config.filterGainCenter)));\r\n    }\r\n\r\n    public toCoefficients(filter: FilterCoefficients, sampleRate: number, freqMult: number = 1.0, peakMult: number = 1.0): void {\r\n        const cornerRadiansPerSample: number = 2.0 * Math.PI * Math.max(Config.filterFreqMinHz, Math.min(Config.filterFreqMaxHz, freqMult * this.getHz())) / sampleRate;\r\n        const linearGain: number = this.getLinearGain(peakMult);\r\n        switch (this.type) {\r\n            case FilterType.lowPass:\r\n                filter.lowPass2ndOrderButterworth(cornerRadiansPerSample, linearGain);\r\n                break;\r\n            case FilterType.highPass:\r\n                filter.highPass2ndOrderButterworth(cornerRadiansPerSample, linearGain);\r\n                break;\r\n            case FilterType.peak:\r\n                filter.peak2ndOrder(cornerRadiansPerSample, linearGain, 1.0);\r\n                break;\r\n            default:\r\n                throw new Error();\r\n        }\r\n    }\r\n\r\n    public getVolumeCompensationMult(): number {\r\n        const octave: number = (this.freq - Config.filterFreqReferenceSetting) * Config.filterFreqStep;\r\n        const gainPow: number = (this.gain - Config.filterGainCenter) * Config.filterGainStep;\r\n        switch (this.type) {\r\n            case FilterType.lowPass:\r\n                const freqRelativeTo8khz: number = Math.pow(2.0, octave) * Config.filterFreqReferenceHz / 8000.0;\r\n                // Reverse the frequency warping from importing legacy simplified filters to imitate how the legacy filter cutoff setting affected volume.\r\n                const warpedFreq: number = (Math.sqrt(1.0 + 4.0 * freqRelativeTo8khz) - 1.0) / 2.0;\r\n                const warpedOctave: number = Math.log2(warpedFreq);\r\n                return Math.pow(0.5, 0.2 * Math.max(0.0, gainPow + 1.0) + Math.min(0.0, Math.max(-3.0, 0.595 * warpedOctave + 0.35 * Math.min(0.0, gainPow + 1.0))));\r\n            case FilterType.highPass:\r\n                return Math.pow(0.5, 0.125 * Math.max(0.0, gainPow + 1.0) + Math.min(0.0, 0.3 * (-octave - Math.log2(Config.filterFreqReferenceHz / 125.0)) + 0.2 * Math.min(0.0, gainPow + 1.0)));\r\n            case FilterType.peak:\r\n                const distanceFromCenter: number = octave + Math.log2(Config.filterFreqReferenceHz / 2000.0);\r\n                const freqLoudness: number = Math.pow(1.0 / (1.0 + Math.pow(distanceFromCenter / 3.0, 2.0)), 2.0);\r\n                return Math.pow(0.5, 0.125 * Math.max(0.0, gainPow) + 0.1 * freqLoudness * Math.min(0.0, gainPow));\r\n            default:\r\n                throw new Error();\r\n        }\r\n    }\r\n}\r\n\r\nexport class FilterSettings {\r\n    public readonly controlPoints: FilterControlPoint[] = [];\r\n    public controlPointCount: number = 0;\r\n\r\n    constructor() {\r\n        this.reset();\r\n    }\r\n\r\n    reset(): void {\r\n        this.controlPointCount = 0;\r\n    }\r\n\r\n    addPoint(type: FilterType, freqSetting: number, gainSetting: number): void {\r\n        let controlPoint: FilterControlPoint;\r\n        if (this.controlPoints.length <= this.controlPointCount) {\r\n            controlPoint = new FilterControlPoint();\r\n            this.controlPoints[this.controlPointCount] = controlPoint;\r\n        } else {\r\n            controlPoint = this.controlPoints[this.controlPointCount];\r\n        }\r\n        this.controlPointCount++;\r\n        controlPoint.type = type;\r\n        controlPoint.set(freqSetting, gainSetting);\r\n    }\r\n\r\n    public toJsonObject(): Object {\r\n        const filterArray: any[] = [];\r\n        for (let i: number = 0; i < this.controlPointCount; i++) {\r\n            const point: FilterControlPoint = this.controlPoints[i];\r\n            filterArray.push({\r\n                \"type\": Config.filterTypeNames[point.type],\r\n                \"cutoffHz\": Math.round(point.getHz() * 100) / 100,\r\n                \"linearGain\": Math.round(point.getLinearGain() * 10000) / 10000,\r\n            });\r\n        }\r\n        return filterArray;\r\n    }\r\n\r\n    public fromJsonObject(filterObject: any): void {\r\n        this.controlPoints.length = 0;\r\n        if (filterObject) {\r\n            for (const pointObject of filterObject) {\r\n                const point: FilterControlPoint = new FilterControlPoint();\r\n                point.type = Config.filterTypeNames.indexOf(pointObject[\"type\"]);\r\n                if (<any>point.type == -1) point.type = FilterType.peak;\r\n                if (pointObject[\"cutoffHz\"] != undefined) {\r\n                    point.freq = FilterControlPoint.getRoundedSettingValueFromHz(pointObject[\"cutoffHz\"]);\r\n                } else {\r\n                    point.freq = 0;\r\n                }\r\n                if (pointObject[\"linearGain\"] != undefined) {\r\n                    point.gain = FilterControlPoint.getRoundedSettingValueFromLinearGain(pointObject[\"linearGain\"]);\r\n                } else {\r\n                    point.gain = Config.filterGainCenter;\r\n                }\r\n                this.controlPoints.push(point);\r\n            }\r\n        }\r\n        this.controlPointCount = this.controlPoints.length;\r\n    }\r\n\r\n    // Returns true if all filter control points match in number and type (but not freq/gain)\r\n    public static filtersCanMorph(filterA: FilterSettings, filterB: FilterSettings): boolean {\r\n        if (filterA.controlPointCount != filterB.controlPointCount)\r\n            return false;\r\n        for (let i: number = 0; i < filterA.controlPointCount; i++) {\r\n            if (filterA.controlPoints[i].type != filterB.controlPoints[i].type)\r\n                return false;\r\n        }\r\n        return true;\r\n    }\r\n\r\n    // Interpolate two FilterSettings, where pos=0 is filterA and pos=1 is filterB\r\n    public static lerpFilters(filterA: FilterSettings, filterB: FilterSettings, pos: number): FilterSettings {\r\n\r\n        let lerpedFilter: FilterSettings = new FilterSettings();\r\n\r\n        // One setting or another is null, return the other.\r\n        if (filterA == null) {\r\n            return filterA;\r\n        }\r\n        if (filterB == null) {\r\n            return filterB;\r\n        }\r\n\r\n        pos = Math.max(0, Math.min(1, pos));\r\n\r\n        // Filter control points match in number and type\r\n        if (this.filtersCanMorph(filterA, filterB)) {\r\n            for (let i: number = 0; i < filterA.controlPointCount; i++) {\r\n                lerpedFilter.controlPoints[i] = new FilterControlPoint();\r\n                lerpedFilter.controlPoints[i].type = filterA.controlPoints[i].type;\r\n                lerpedFilter.controlPoints[i].freq = filterA.controlPoints[i].freq + (filterB.controlPoints[i].freq - filterA.controlPoints[i].freq) * pos;\r\n                lerpedFilter.controlPoints[i].gain = filterA.controlPoints[i].gain + (filterB.controlPoints[i].gain - filterA.controlPoints[i].gain) * pos;\r\n            }\r\n\r\n            lerpedFilter.controlPointCount = filterA.controlPointCount;\r\n\r\n            return lerpedFilter;\r\n        }\r\n        else {\r\n            // Not allowing morph of unmatching filters for now. It's a hornet's nest of problems, and I had it implemented and mostly working and it didn't sound very interesting since the shape becomes \"mushy\" in between\r\n            return (pos >= 1) ? filterB : filterA;\r\n        }\r\n        /* \r\n        // Filter control points do not match. Take all filterA points and move them to neutral at pos=1 (gain 7 for normal points, slide to edge and gain 7 for lo/hipass),\r\n        // and do the opposite for filterB points. Return a filter with points for both.\r\n        else {\r\n            let lerpedFilter: FilterSettings = new FilterSettings();\r\n            // Filter A's morph points\r\n            for (let i: number = 0; i < filterA.controlPointCount; i++) {\r\n                lerpedFilter.controlPoints[i] = new FilterControlPoint();\r\n                lerpedFilter.controlPoints[i].type = filterA.controlPoints[i].type;\r\n                lerpedFilter.controlPoints[i].gain = filterA.controlPoints[i].gain + (Config.filterGainCenter - filterA.controlPoints[i].gain) * pos;\r\n\r\n                if (filterA.controlPoints[i].type == FilterType.peak) {\r\n                    lerpedFilter.controlPoints[i].freq = filterA.controlPoints[i].freq;\r\n                }\r\n                else if (filterA.controlPoints[i].type == FilterType.highPass) {\r\n                    lerpedFilter.controlPoints[i].freq = filterA.controlPoints[i].freq * (1 - pos);\r\n                }\r\n                else {\r\n                    lerpedFilter.controlPoints[i].freq = filterA.controlPoints[i].freq + ((Config.filterFreqRange - 1) - filterA.controlPoints[i].freq) * pos;\r\n                }\r\n            }\r\n            // Filter B's morph points\r\n            for (let i: number = 0, j: number = filterA.controlPointCount; i < filterB.controlPointCount; i++, j++) {\r\n                lerpedFilter.controlPoints[j] = new FilterControlPoint();\r\n                lerpedFilter.controlPoints[j].type = filterB.controlPoints[i].type;\r\n                lerpedFilter.controlPoints[j].gain = filterB.controlPoints[i].gain + (Config.filterGainCenter - filterB.controlPoints[i].gain) * (1 - pos);\r\n\r\n                if (filterB.controlPoints[i].type == FilterType.peak) {\r\n                    lerpedFilter.controlPoints[j].freq = filterB.controlPoints[i].freq;\r\n                }\r\n                else if (filterB.controlPoints[i].type == FilterType.highPass) {\r\n                    lerpedFilter.controlPoints[j].freq = filterB.controlPoints[i].freq * pos;\r\n                }\r\n                else {\r\n                    lerpedFilter.controlPoints[j].freq = filterB.controlPoints[i].freq + ((Config.filterFreqRange - 1) - filterB.controlPoints[i].freq) * (1 - pos);\r\n                }\r\n            }\r\n\r\n            lerpedFilter.controlPointCount = filterA.controlPointCount + filterB.controlPointCount;\r\n\r\n            return lerpedFilter;\r\n        }\r\n        */\r\n    }\r\n\r\n    public convertLegacySettings(legacyCutoffSetting: number, legacyResonanceSetting: number, legacyEnv: Envelope): void {\r\n        this.reset();\r\n\r\n        const legacyFilterCutoffMaxHz: number = 8000; // This was carefully calculated to correspond to no change in response when filtering at 48000 samples per second... when using the legacy simplified low-pass filter.\r\n        const legacyFilterMax: number = 0.95;\r\n        const legacyFilterMaxRadians: number = Math.asin(legacyFilterMax / 2.0) * 2.0;\r\n        const legacyFilterMaxResonance: number = 0.95;\r\n        const legacyFilterCutoffRange: number = 11;\r\n        const legacyFilterResonanceRange: number = 8;\r\n\r\n        const resonant: boolean = (legacyResonanceSetting > 1);\r\n        const firstOrder: boolean = (legacyResonanceSetting == 0);\r\n        const cutoffAtMax: boolean = (legacyCutoffSetting == legacyFilterCutoffRange - 1);\r\n        const envDecays: boolean = (legacyEnv.type == EnvelopeType.flare || legacyEnv.type == EnvelopeType.twang || legacyEnv.type == EnvelopeType.decay || legacyEnv.type == EnvelopeType.noteSize);\r\n\r\n        const standardSampleRate: number = 48000;\r\n        const legacyHz: number = legacyFilterCutoffMaxHz * Math.pow(2.0, (legacyCutoffSetting - (legacyFilterCutoffRange - 1)) * 0.5);\r\n        const legacyRadians: number = Math.min(legacyFilterMaxRadians, 2 * Math.PI * legacyHz / standardSampleRate);\r\n\r\n        if (legacyEnv.type == EnvelopeType.none && !resonant && cutoffAtMax) {\r\n            // The response is flat and there's no envelopes, so don't even bother adding any control points.\r\n        } else if (firstOrder) {\r\n            // In general, a 1st order lowpass can be approximated by a 2nd order lowpass\r\n            // with a cutoff ~4 octaves higher (*16) and a gain of 1/16.\r\n            // However, BeepBox's original lowpass filters behaved oddly as they\r\n            // approach the nyquist frequency, so I've devised this curved conversion\r\n            // to guess at a perceptually appropriate new cutoff frequency and gain.\r\n            const extraOctaves: number = 3.5;\r\n            const targetRadians: number = legacyRadians * Math.pow(2.0, extraOctaves);\r\n            const curvedRadians: number = targetRadians / (1.0 + targetRadians / Math.PI);\r\n            const curvedHz: number = standardSampleRate * curvedRadians / (2.0 * Math.PI)\r\n            const freqSetting: number = FilterControlPoint.getRoundedSettingValueFromHz(curvedHz);\r\n            const finalHz: number = FilterControlPoint.getHzFromSettingValue(freqSetting);\r\n            const finalRadians: number = 2.0 * Math.PI * finalHz / standardSampleRate;\r\n\r\n            const legacyFilter: FilterCoefficients = new FilterCoefficients();\r\n            legacyFilter.lowPass1stOrderSimplified(legacyRadians);\r\n            const response: FrequencyResponse = new FrequencyResponse();\r\n            response.analyze(legacyFilter, finalRadians);\r\n            const legacyFilterGainAtNewRadians: number = response.magnitude();\r\n\r\n            let logGain: number = Math.log2(legacyFilterGainAtNewRadians);\r\n            // Bias slightly toward 2^(-extraOctaves):\r\n            logGain = -extraOctaves + (logGain + extraOctaves) * 0.82;\r\n            // Decaying envelopes move the cutoff frequency back into an area where the best approximation of the first order slope requires a lower gain setting.\r\n            if (envDecays) logGain = Math.min(logGain, -1.0);\r\n            const convertedGain: number = Math.pow(2.0, logGain);\r\n            const gainSetting: number = FilterControlPoint.getRoundedSettingValueFromLinearGain(convertedGain);\r\n\r\n            this.addPoint(FilterType.lowPass, freqSetting, gainSetting);\r\n        } else {\r\n            const intendedGain: number = 0.5 / (1.0 - legacyFilterMaxResonance * Math.sqrt(Math.max(0.0, legacyResonanceSetting - 1.0) / (legacyFilterResonanceRange - 2.0)));\r\n            const invertedGain: number = 0.5 / intendedGain;\r\n            const maxRadians: number = 2.0 * Math.PI * legacyFilterCutoffMaxHz / standardSampleRate;\r\n            const freqRatio: number = legacyRadians / maxRadians;\r\n            const targetRadians: number = legacyRadians * (freqRatio * Math.pow(invertedGain, 0.9) + 1.0);\r\n            const curvedRadians: number = legacyRadians + (targetRadians - legacyRadians) * invertedGain;\r\n            let curvedHz: number;\r\n            if (envDecays) {\r\n                curvedHz = standardSampleRate * Math.min(curvedRadians, legacyRadians * Math.pow(2, 0.25)) / (2.0 * Math.PI);\r\n            } else {\r\n                curvedHz = standardSampleRate * curvedRadians / (2.0 * Math.PI);\r\n            }\r\n            const freqSetting: number = FilterControlPoint.getRoundedSettingValueFromHz(curvedHz);\r\n\r\n            let legacyFilterGain: number;\r\n            if (envDecays) {\r\n                legacyFilterGain = intendedGain;\r\n            } else {\r\n                const legacyFilter: FilterCoefficients = new FilterCoefficients();\r\n                legacyFilter.lowPass2ndOrderSimplified(legacyRadians, intendedGain);\r\n                const response: FrequencyResponse = new FrequencyResponse();\r\n                response.analyze(legacyFilter, curvedRadians);\r\n                legacyFilterGain = response.magnitude();\r\n            }\r\n            if (!resonant) legacyFilterGain = Math.min(legacyFilterGain, Math.sqrt(0.5));\r\n            const gainSetting: number = FilterControlPoint.getRoundedSettingValueFromLinearGain(legacyFilterGain);\r\n\r\n            this.addPoint(FilterType.lowPass, freqSetting, gainSetting);\r\n        }\r\n\r\n        // Added for JummBox - making a 0 point filter does not truncate control points!\r\n        this.controlPoints.length = this.controlPointCount;\r\n    }\r\n\r\n    // Similar to above, but purpose-fit for quick conversions in synth calls.\r\n    public convertLegacySettingsForSynth(legacyCutoffSetting: number, legacyResonanceSetting: number, allowFirstOrder: boolean = false): void {\r\n        this.reset();\r\n\r\n        const legacyFilterCutoffMaxHz: number = 8000; // This was carefully calculated to correspond to no change in response when filtering at 48000 samples per second... when using the legacy simplified low-pass filter.\r\n        const legacyFilterMax: number = 0.95;\r\n        const legacyFilterMaxRadians: number = Math.asin(legacyFilterMax / 2.0) * 2.0;\r\n        const legacyFilterMaxResonance: number = 0.95;\r\n        const legacyFilterCutoffRange: number = 11;\r\n        const legacyFilterResonanceRange: number = 8;\r\n\r\n        const firstOrder: boolean = (legacyResonanceSetting == 0 && allowFirstOrder);\r\n        const standardSampleRate: number = 48000;\r\n        const legacyHz: number = legacyFilterCutoffMaxHz * Math.pow(2.0, (legacyCutoffSetting - (legacyFilterCutoffRange - 1)) * 0.5);\r\n        const legacyRadians: number = Math.min(legacyFilterMaxRadians, 2 * Math.PI * legacyHz / standardSampleRate);\r\n\r\n        if (firstOrder) {\r\n            // In general, a 1st order lowpass can be approximated by a 2nd order lowpass\r\n            // with a cutoff ~4 octaves higher (*16) and a gain of 1/16.\r\n            // However, BeepBox's original lowpass filters behaved oddly as they\r\n            // approach the nyquist frequency, so I've devised this curved conversion\r\n            // to guess at a perceptually appropriate new cutoff frequency and gain.\r\n            const extraOctaves: number = 3.5;\r\n            const targetRadians: number = legacyRadians * Math.pow(2.0, extraOctaves);\r\n            const curvedRadians: number = targetRadians / (1.0 + targetRadians / Math.PI);\r\n            const curvedHz: number = standardSampleRate * curvedRadians / (2.0 * Math.PI)\r\n            const freqSetting: number = FilterControlPoint.getRoundedSettingValueFromHz(curvedHz);\r\n            const finalHz: number = FilterControlPoint.getHzFromSettingValue(freqSetting);\r\n            const finalRadians: number = 2.0 * Math.PI * finalHz / standardSampleRate;\r\n\r\n            const legacyFilter: FilterCoefficients = new FilterCoefficients();\r\n            legacyFilter.lowPass1stOrderSimplified(legacyRadians);\r\n            const response: FrequencyResponse = new FrequencyResponse();\r\n            response.analyze(legacyFilter, finalRadians);\r\n            const legacyFilterGainAtNewRadians: number = response.magnitude();\r\n\r\n            let logGain: number = Math.log2(legacyFilterGainAtNewRadians);\r\n            // Bias slightly toward 2^(-extraOctaves):\r\n            logGain = -extraOctaves + (logGain + extraOctaves) * 0.82;\r\n            const convertedGain: number = Math.pow(2.0, logGain);\r\n            const gainSetting: number = FilterControlPoint.getRoundedSettingValueFromLinearGain(convertedGain);\r\n\r\n            this.addPoint(FilterType.lowPass, freqSetting, gainSetting);\r\n        } else {\r\n            const intendedGain: number = 0.5 / (1.0 - legacyFilterMaxResonance * Math.sqrt(Math.max(0.0, legacyResonanceSetting - 1.0) / (legacyFilterResonanceRange - 2.0)));\r\n            const invertedGain: number = 0.5 / intendedGain;\r\n            const maxRadians: number = 2.0 * Math.PI * legacyFilterCutoffMaxHz / standardSampleRate;\r\n            const freqRatio: number = legacyRadians / maxRadians;\r\n            const targetRadians: number = legacyRadians * (freqRatio * Math.pow(invertedGain, 0.9) + 1.0);\r\n            const curvedRadians: number = legacyRadians + (targetRadians - legacyRadians) * invertedGain;\r\n            let curvedHz: number;\r\n\r\n            curvedHz = standardSampleRate * curvedRadians / (2.0 * Math.PI);\r\n            const freqSetting: number = FilterControlPoint.getSettingValueFromHz(curvedHz);\r\n\r\n            let legacyFilterGain: number;\r\n\r\n            const legacyFilter: FilterCoefficients = new FilterCoefficients();\r\n            legacyFilter.lowPass2ndOrderSimplified(legacyRadians, intendedGain);\r\n            const response: FrequencyResponse = new FrequencyResponse();\r\n            response.analyze(legacyFilter, curvedRadians);\r\n            legacyFilterGain = response.magnitude();\r\n            const gainSetting: number = FilterControlPoint.getRoundedSettingValueFromLinearGain(legacyFilterGain);\r\n\r\n            this.addPoint(FilterType.lowPass, freqSetting, gainSetting);\r\n        }\r\n\r\n    }\r\n}\r\n\r\nexport class EnvelopeSettings {\r\n    public target: number = 0;\r\n    public index: number = 0;\r\n    public envelope: number = 0;\r\n\r\n    constructor() {\r\n        this.reset();\r\n    }\r\n\r\n    reset(): void {\r\n        this.target = 0;\r\n        this.index = 0;\r\n        this.envelope = 0;\r\n    }\r\n\r\n    public toJsonObject(): Object {\r\n        const envelopeObject: any = {\r\n            \"target\": Config.instrumentAutomationTargets[this.target].name,\r\n            \"envelope\": Config.envelopes[this.envelope].name,\r\n        };\r\n        if (Config.instrumentAutomationTargets[this.target].maxCount > 1) {\r\n            envelopeObject[\"index\"] = this.index;\r\n        }\r\n        return envelopeObject;\r\n    }\r\n\r\n    public fromJsonObject(envelopeObject: any): void {\r\n        this.reset();\r\n\r\n        let target: AutomationTarget = Config.instrumentAutomationTargets.dictionary[envelopeObject[\"target\"]];\r\n        if (target == null) target = Config.instrumentAutomationTargets.dictionary[\"noteVolume\"];\r\n        this.target = target.index;\r\n\r\n        let envelope: Envelope = Config.envelopes.dictionary[envelopeObject[\"envelope\"]];\r\n        if (envelope == null) envelope = Config.envelopes.dictionary[\"none\"];\r\n        this.envelope = envelope.index;\r\n\r\n        if (envelopeObject[\"index\"] != undefined) {\r\n            this.index = clamp(0, Config.instrumentAutomationTargets[this.target].maxCount, envelopeObject[\"index\"] | 0);\r\n        } else {\r\n            this.index = 0;\r\n        }\r\n    }\r\n}\r\n\r\n// Settings that were available to old versions of BeepBox but are no longer available in the\r\n// current version that need to be reinterpreted as a group to determine the best way to\r\n// represent them in the current version.\r\ninterface LegacySettings {\r\n    filterCutoff?: number;\r\n    filterResonance?: number;\r\n    filterEnvelope?: Envelope;\r\n    pulseEnvelope?: Envelope;\r\n    operatorEnvelopes?: Envelope[];\r\n    feedbackEnvelope?: Envelope;\r\n}\r\n\r\nexport class Instrument {\r\n    public type: InstrumentType = InstrumentType.chip;\r\n    public preset: number = 0;\r\n    public chipWave: number = 2;\r\n    public chipNoise: number = 1;\r\n    public eqFilter: FilterSettings = new FilterSettings();\r\n    public eqFilterType: boolean = false;\r\n    public eqFilterSimpleCut: number = Config.filterSimpleCutRange - 1;\r\n    public eqFilterSimplePeak: number = 0;\r\n    public noteFilter: FilterSettings = new FilterSettings();\r\n    public noteFilterType: boolean = false;\r\n    public noteFilterSimpleCut: number = Config.filterSimpleCutRange - 1;\r\n    public noteFilterSimplePeak: number = 0;\r\n    public eqSubFilters: (FilterSettings | null)[] = [];\r\n    public noteSubFilters: (FilterSettings | null)[] = [];\r\n    public tmpEqFilterStart: FilterSettings | null;\r\n    public tmpEqFilterEnd: FilterSettings | null;\r\n    public tmpNoteFilterStart: FilterSettings | null;\r\n    public tmpNoteFilterEnd: FilterSettings | null;\r\n    public envelopes: EnvelopeSettings[] = [];\r\n    public fadeIn: number = 0;\r\n    public fadeOut: number = Config.fadeOutNeutral;\r\n    public envelopeCount: number = 0;\r\n    public transition: number = Config.transitions.dictionary[\"normal\"].index;\r\n    public pitchShift: number = 0;\r\n    public detune: number = 0;\r\n    public vibrato: number = 0;\r\n    public interval: number = 0;\r\n    public vibratoDepth: number = 0;\r\n    public vibratoSpeed: number = 10;\r\n    public vibratoDelay: number = 0;\r\n    public vibratoType: number = 0;\r\n    public unison: number = 0;\r\n    public effects: number = 0;\r\n    public chord: number = 1;\r\n    public volume: number = 0;\r\n    public pan: number = Config.panCenter;\r\n    public panDelay: number = 10;\r\n    public arpeggioSpeed: number = 12;\r\n    public fastTwoNoteArp: boolean = false;\r\n    public legacyTieOver: boolean = false;\r\n    public clicklessTransition: boolean = false;\r\n    public aliases: boolean = false;\r\n    public pulseWidth: number = Config.pulseWidthRange;\r\n    public stringSustain: number = 10;\r\n    public distortion: number = 0;\r\n    public bitcrusherFreq: number = 0;\r\n    public bitcrusherQuantization: number = 0;\r\n    public chorus: number = 0;\r\n    public reverb: number = 0;\r\n    public echoSustain: number = 0;\r\n    public echoDelay: number = 0;\r\n    public algorithm: number = 0;\r\n    public feedbackType: number = 0;\r\n    public feedbackAmplitude: number = 0;\r\n    public LFOtime: number = 0;\r\n    public nextLFOtime: number = 0;\r\n    public arpTime: number = 0;\r\n    public customChipWave: Float32Array = new Float32Array(64);\r\n    public customChipWaveIntegral: Float32Array = new Float32Array(65); // One extra element for wrap-around in chipSynth.\r\n    public readonly operators: Operator[] = [];\r\n    public readonly spectrumWave: SpectrumWave;\r\n    public readonly harmonicsWave: HarmonicsWave = new HarmonicsWave();\r\n    public readonly drumsetEnvelopes: number[] = [];\r\n    public readonly drumsetSpectrumWaves: SpectrumWave[] = [];\r\n    public modChannels: number[] = [];\r\n    public modInstruments: number[] = [];\r\n    public modulators: number[] = [];\r\n    public modFilterTypes: number[] = [];\r\n    public invalidModulators: boolean[] = [];\r\n    constructor(isNoiseChannel: boolean, isModChannel: boolean) {\r\n\r\n        if (isModChannel) {\r\n            for (let mod: number = 0; mod < Config.modCount; mod++) {\r\n                this.modChannels.push(0);\r\n                this.modInstruments.push(0);\r\n                this.modulators.push(Config.modulators.dictionary[\"none\"].index);\r\n            }\r\n        }\r\n\r\n        this.spectrumWave = new SpectrumWave(isNoiseChannel);\r\n        for (let i: number = 0; i < Config.operatorCount; i++) {\r\n            this.operators[i] = new Operator(i);\r\n        }\r\n        for (let i: number = 0; i < Config.drumCount; i++) {\r\n            this.drumsetEnvelopes[i] = Config.envelopes.dictionary[\"twang 2\"].index;\r\n            this.drumsetSpectrumWaves[i] = new SpectrumWave(true);\r\n        }\r\n\r\n        for (let i = 0; i < 64; i++) {\r\n            this.customChipWave[i] = 24 - Math.floor(i * (48 / 64));\r\n        }\r\n\r\n        let sum: number = 0.0;\r\n        for (let i: number = 0; i < this.customChipWave.length; i++) {\r\n            sum += this.customChipWave[i];\r\n        }\r\n        const average: number = sum / this.customChipWave.length;\r\n\r\n        // Perform the integral on the wave. The chipSynth will perform the derivative to get the original wave back but with antialiasing.\r\n        let cumulative: number = 0;\r\n        let wavePrev: number = 0;\r\n        for (let i: number = 0; i < this.customChipWave.length; i++) {\r\n            cumulative += wavePrev;\r\n            wavePrev = this.customChipWave[i] - average;\r\n            this.customChipWaveIntegral[i] = cumulative;\r\n        }\r\n\r\n        // 65th, last sample is for anti-aliasing\r\n        this.customChipWaveIntegral[64] = 0.0;\r\n\r\n    }\r\n\r\n    public setTypeAndReset(type: InstrumentType, isNoiseChannel: boolean, isModChannel: boolean): void {\r\n        // Mod channels are forced to one type.\r\n        if (isModChannel) type = InstrumentType.mod;\r\n        this.type = type;\r\n        this.preset = type;\r\n        this.volume = 0;\r\n        this.effects = (1 << EffectType.panning); // Panning enabled by default in JB.\r\n        this.chorus = Config.chorusRange - 1;\r\n        this.reverb = 0;\r\n        this.echoSustain = Math.floor((Config.echoSustainRange - 1) * 0.5);\r\n        this.echoDelay = Math.floor((Config.echoDelayRange - 1) * 0.5);\r\n        this.eqFilter.reset();\r\n        this.eqFilterType = false;\r\n        this.eqFilterSimpleCut = Config.filterSimpleCutRange - 1;\r\n        this.eqFilterSimplePeak = 0;\r\n        for (let i: number = 0; i < Config.filterMorphCount; i++) {\r\n            this.eqSubFilters[i] = null;\r\n            this.noteSubFilters[i] = null;\r\n        }\r\n        this.noteFilter.reset();\r\n        this.noteFilterType = false;\r\n        this.noteFilterSimpleCut = Config.filterSimpleCutRange - 1;\r\n        this.noteFilterSimplePeak = 0;\r\n        this.distortion = Math.floor((Config.distortionRange - 1) * 0.75);\r\n        this.bitcrusherFreq = Math.floor((Config.bitcrusherFreqRange - 1) * 0.5)\r\n        this.bitcrusherQuantization = Math.floor((Config.bitcrusherQuantizationRange - 1) * 0.5);\r\n        this.pan = Config.panCenter;\r\n        this.panDelay = 10;\r\n        this.pitchShift = Config.pitchShiftCenter;\r\n        this.detune = Config.detuneCenter;\r\n        this.vibrato = 0;\r\n        this.unison = 0;\r\n        this.stringSustain = 10;\r\n        this.clicklessTransition = false;\r\n        this.arpeggioSpeed = 12;\r\n        this.legacyTieOver = false;\r\n        this.aliases = false;\r\n        this.fadeIn = 0;\r\n        this.fadeOut = Config.fadeOutNeutral;\r\n        this.transition = Config.transitions.dictionary[\"normal\"].index;\r\n        this.envelopeCount = 0;\r\n        switch (type) {\r\n            case InstrumentType.chip:\r\n                this.chipWave = 2;\r\n                // TODO: enable the chord effect?\r\n                this.chord = Config.chords.dictionary[\"arpeggio\"].index;\r\n                break;\r\n            case InstrumentType.customChipWave:\r\n                this.chipWave = 2;\r\n                this.chord = Config.chords.dictionary[\"arpeggio\"].index;\r\n                for (let i: number = 0; i < 64; i++) {\r\n                    this.customChipWave[i] = 24 - (Math.floor(i * (48 / 64)));\r\n                }\r\n\r\n                let sum: number = 0.0;\r\n                for (let i: number = 0; i < this.customChipWave.length; i++) {\r\n                    sum += this.customChipWave[i];\r\n                }\r\n                const average: number = sum / this.customChipWave.length;\r\n\r\n                // Perform the integral on the wave. The chipSynth will perform the derivative to get the original wave back but with antialiasing.\r\n                let cumulative: number = 0;\r\n                let wavePrev: number = 0;\r\n                for (let i: number = 0; i < this.customChipWave.length; i++) {\r\n                    cumulative += wavePrev;\r\n                    wavePrev = this.customChipWave[i] - average;\r\n                    this.customChipWaveIntegral[i] = cumulative;\r\n                }\r\n\r\n                this.customChipWaveIntegral[64] = 0.0;\r\n                break;\r\n            case InstrumentType.fm:\r\n                this.chord = Config.chords.dictionary[\"custom interval\"].index;\r\n                this.algorithm = 0;\r\n                this.feedbackType = 0;\r\n                this.feedbackAmplitude = 0;\r\n                for (let i: number = 0; i < this.operators.length; i++) {\r\n                    this.operators[i].reset(i);\r\n                }\r\n                break;\r\n            case InstrumentType.noise:\r\n                this.chipNoise = 1;\r\n                this.chord = Config.chords.dictionary[\"arpeggio\"].index;\r\n                break;\r\n            case InstrumentType.spectrum:\r\n                this.chord = Config.chords.dictionary[\"simultaneous\"].index;\r\n                this.spectrumWave.reset(isNoiseChannel);\r\n                break;\r\n            case InstrumentType.drumset:\r\n                this.chord = Config.chords.dictionary[\"simultaneous\"].index;\r\n                for (let i: number = 0; i < Config.drumCount; i++) {\r\n                    this.drumsetEnvelopes[i] = Config.envelopes.dictionary[\"twang 2\"].index;\r\n                    if (this.drumsetSpectrumWaves[i] == undefined) {\r\n                        this.drumsetSpectrumWaves[i] = new SpectrumWave(true);\r\n                    }\r\n                    this.drumsetSpectrumWaves[i].reset(isNoiseChannel);\r\n                }\r\n                break;\r\n            case InstrumentType.harmonics:\r\n                this.chord = Config.chords.dictionary[\"simultaneous\"].index;\r\n                this.harmonicsWave.reset();\r\n                break;\r\n            case InstrumentType.pwm:\r\n                this.chord = Config.chords.dictionary[\"arpeggio\"].index;\r\n                this.pulseWidth = Config.pulseWidthRange;\r\n                break;\r\n            case InstrumentType.pickedString:\r\n                this.chord = Config.chords.dictionary[\"strum\"].index;\r\n                this.harmonicsWave.reset();\r\n                break;\r\n            case InstrumentType.mod:\r\n                this.transition = 0;\r\n                this.vibrato = 0;\r\n                this.interval = 0;\r\n                this.effects = 0;\r\n                this.chord = 0;\r\n                this.modChannels = [];\r\n                this.modInstruments = [];\r\n                this.modulators = [];\r\n                for (let mod: number = 0; mod < Config.modCount; mod++) {\r\n                    this.modChannels.push(-2);\r\n                    this.modInstruments.push(0);\r\n                    this.modulators.push(Config.modulators.dictionary[\"none\"].index);\r\n                    this.invalidModulators[mod] = false;\r\n                    this.modFilterTypes[mod] = 0;\r\n                }\r\n                break;\r\n            default:\r\n                throw new Error(\"Unrecognized instrument type: \" + type);\r\n        }\r\n        // Chip/noise instruments had arpeggio and FM had custom interval but neither\r\n        // explicitly saved the chorus setting beforeSeven so enable it here. The effects\r\n        // will otherwise get overridden when reading SongTagCode.startInstrument.\r\n        if (this.chord != Config.chords.dictionary[\"simultaneous\"].index) {\r\n            // Enable chord if it was used.\r\n            this.effects = (this.effects | (1 << EffectType.chord));\r\n        }\r\n    }\r\n\r\n    // (only) difference for JummBox: Returns whether or not the note filter was chosen for filter conversion.\r\n    public convertLegacySettings(legacySettings: LegacySettings, forceSimpleFilter: boolean): void {\r\n        let legacyCutoffSetting: number | undefined = legacySettings.filterCutoff;\r\n        let legacyResonanceSetting: number | undefined = legacySettings.filterResonance;\r\n        let legacyFilterEnv: Envelope | undefined = legacySettings.filterEnvelope;\r\n        let legacyPulseEnv: Envelope | undefined = legacySettings.pulseEnvelope;\r\n        let legacyOperatorEnvelopes: Envelope[] | undefined = legacySettings.operatorEnvelopes;\r\n        let legacyFeedbackEnv: Envelope | undefined = legacySettings.feedbackEnvelope;\r\n\r\n        // legacy defaults:\r\n        if (legacyCutoffSetting == undefined) legacyCutoffSetting = (this.type == InstrumentType.chip) ? 6 : 10;\r\n        if (legacyResonanceSetting == undefined) legacyResonanceSetting = 0;\r\n        if (legacyFilterEnv == undefined) legacyFilterEnv = Config.envelopes.dictionary[\"none\"];\r\n        if (legacyPulseEnv == undefined) legacyPulseEnv = Config.envelopes.dictionary[(this.type == InstrumentType.pwm) ? \"twang 2\" : \"none\"];\r\n        if (legacyOperatorEnvelopes == undefined) legacyOperatorEnvelopes = [Config.envelopes.dictionary[(this.type == InstrumentType.fm) ? \"note size\" : \"none\"], Config.envelopes.dictionary[\"none\"], Config.envelopes.dictionary[\"none\"], Config.envelopes.dictionary[\"none\"]];\r\n        if (legacyFeedbackEnv == undefined) legacyFeedbackEnv = Config.envelopes.dictionary[\"none\"];\r\n\r\n        // The \"punch\" envelope is special: it goes *above* the chosen cutoff. But if the cutoff was already at the max, it couldn't go any higher... except in the current version of BeepBox I raised the max cutoff so it *can* but then it sounds different, so to preserve the original sound let's just remove the punch envelope.\r\n        const legacyFilterCutoffRange: number = 11;\r\n        const cutoffAtMax: boolean = (legacyCutoffSetting == legacyFilterCutoffRange - 1);\r\n        if (cutoffAtMax && legacyFilterEnv.type == EnvelopeType.punch) legacyFilterEnv = Config.envelopes.dictionary[\"none\"];\r\n\r\n        const carrierCount: number = Config.algorithms[this.algorithm].carrierCount;\r\n        let noCarriersControlledByNoteSize: boolean = true;\r\n        let allCarriersControlledByNoteSize: boolean = true;\r\n        let noteSizeControlsSomethingElse: boolean = (legacyFilterEnv.type == EnvelopeType.noteSize) || (legacyPulseEnv.type == EnvelopeType.noteSize);\r\n        if (this.type == InstrumentType.fm) {\r\n            noteSizeControlsSomethingElse = noteSizeControlsSomethingElse || (legacyFeedbackEnv.type == EnvelopeType.noteSize);\r\n            for (let i: number = 0; i < legacyOperatorEnvelopes.length; i++) {\r\n                if (i < carrierCount) {\r\n                    if (legacyOperatorEnvelopes[i].type != EnvelopeType.noteSize) {\r\n                        allCarriersControlledByNoteSize = false;\r\n                    } else {\r\n                        noCarriersControlledByNoteSize = false;\r\n                    }\r\n                } else {\r\n                    noteSizeControlsSomethingElse = noteSizeControlsSomethingElse || (legacyOperatorEnvelopes[i].type == EnvelopeType.noteSize);\r\n                }\r\n            }\r\n        }\r\n\r\n        this.envelopeCount = 0;\r\n\r\n        if (this.type == InstrumentType.fm) {\r\n            if (allCarriersControlledByNoteSize && noteSizeControlsSomethingElse) {\r\n                this.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"noteVolume\"].index, 0, Config.envelopes.dictionary[\"note size\"].index);\r\n            } else if (noCarriersControlledByNoteSize && !noteSizeControlsSomethingElse) {\r\n                this.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"none\"].index, 0, Config.envelopes.dictionary[\"note size\"].index);\r\n            }\r\n        }\r\n\r\n        if (legacyFilterEnv.type == EnvelopeType.none) {\r\n            this.noteFilter.reset();\r\n            this.noteFilterType = false;\r\n            this.eqFilter.convertLegacySettings(legacyCutoffSetting, legacyResonanceSetting, legacyFilterEnv);\r\n            this.effects &= ~(1 << EffectType.noteFilter);\r\n            if (forceSimpleFilter || this.eqFilterType) {\r\n                this.eqFilterType = true;\r\n                this.eqFilterSimpleCut = legacyCutoffSetting;\r\n                this.eqFilterSimplePeak = legacyResonanceSetting;\r\n            }\r\n        } else {\r\n            this.eqFilter.reset();\r\n\r\n            this.eqFilterType = false;\r\n            this.noteFilterType = false;\r\n            this.noteFilter.convertLegacySettings(legacyCutoffSetting, legacyResonanceSetting, legacyFilterEnv);\r\n            this.effects |= 1 << EffectType.noteFilter;\r\n            this.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"noteFilterAllFreqs\"].index, 0, legacyFilterEnv.index);\r\n            if (forceSimpleFilter || this.noteFilterType) {\r\n                this.noteFilterType = true;\r\n                this.noteFilterSimpleCut = legacyCutoffSetting;\r\n                this.noteFilterSimplePeak = legacyResonanceSetting;\r\n            }\r\n        }\r\n\r\n        if (legacyPulseEnv.type != EnvelopeType.none) {\r\n            this.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"pulseWidth\"].index, 0, legacyPulseEnv.index);\r\n        }\r\n\r\n        for (let i: number = 0; i < legacyOperatorEnvelopes.length; i++) {\r\n            if (i < carrierCount && allCarriersControlledByNoteSize) continue;\r\n            if (legacyOperatorEnvelopes[i].type != EnvelopeType.none) {\r\n                this.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"operatorAmplitude\"].index, i, legacyOperatorEnvelopes[i].index);\r\n            }\r\n        }\r\n\r\n        if (legacyFeedbackEnv.type != EnvelopeType.none) {\r\n            this.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"feedbackAmplitude\"].index, 0, legacyFeedbackEnv.index);\r\n        }\r\n    }\r\n\r\n    public toJsonObject(): Object {\r\n        const instrumentObject: any = {\r\n            \"type\": Config.instrumentTypeNames[this.type],\r\n            \"volume\": this.volume,\r\n            \"eqFilter\": this.eqFilter.toJsonObject(),\r\n            \"eqFilterType\": this.eqFilterType,\r\n            \"eqSimpleCut\": this.eqFilterSimpleCut,\r\n            \"eqSimplePeak\": this.eqFilterSimplePeak\r\n        };\r\n\r\n        if (this.preset != this.type) {\r\n            instrumentObject[\"preset\"] = this.preset;\r\n        }\r\n\r\n        for (let i: number = 0; i < Config.filterMorphCount; i++) {\r\n            if (this.eqSubFilters[i] != null)\r\n                instrumentObject[\"eqSubFilters\" + i] = this.eqSubFilters[i]!.toJsonObject();\r\n        }\r\n\r\n        const effects: string[] = [];\r\n        for (const effect of Config.effectOrder) {\r\n            if (this.effects & (1 << effect)) {\r\n                effects.push(Config.effectNames[effect]);\r\n            }\r\n        }\r\n        instrumentObject[\"effects\"] = effects;\r\n\r\n\r\n        if (effectsIncludeTransition(this.effects)) {\r\n            instrumentObject[\"transition\"] = Config.transitions[this.transition].name;\r\n            instrumentObject[\"clicklessTransition\"] = this.clicklessTransition;\r\n        }\r\n        if (effectsIncludeChord(this.effects)) {\r\n            instrumentObject[\"chord\"] = this.getChord().name;\r\n            instrumentObject[\"fastTwoNoteArp\"] = this.fastTwoNoteArp;\r\n            instrumentObject[\"arpeggioSpeed\"] = this.arpeggioSpeed;\r\n        }\r\n        if (effectsIncludePitchShift(this.effects)) {\r\n            instrumentObject[\"pitchShiftSemitones\"] = this.pitchShift;\r\n        }\r\n        if (effectsIncludeDetune(this.effects)) {\r\n            instrumentObject[\"detuneCents\"] = Synth.detuneToCents(this.detune);\r\n        }\r\n        if (effectsIncludeVibrato(this.effects)) {\r\n            if (this.vibrato == -1) {\r\n                this.vibrato = 5;\r\n            }\r\n            if (this.vibrato != 5) {\r\n                instrumentObject[\"vibrato\"] = Config.vibratos[this.vibrato].name;\r\n            } else {\r\n                instrumentObject[\"vibrato\"] = \"custom\";\r\n            }\r\n            instrumentObject[\"vibratoDepth\"] = this.vibratoDepth;\r\n            instrumentObject[\"vibratoDelay\"] = this.vibratoDelay;\r\n            instrumentObject[\"vibratoSpeed\"] = this.vibratoSpeed;\r\n            instrumentObject[\"vibratoType\"] = this.vibratoType;\r\n        }\r\n        if (effectsIncludeNoteFilter(this.effects)) {\r\n            instrumentObject[\"noteFilterType\"] = this.noteFilterType;\r\n            instrumentObject[\"noteSimpleCut\"] = this.noteFilterSimpleCut;\r\n            instrumentObject[\"noteSimplePeak\"] = this.noteFilterSimplePeak;\r\n            instrumentObject[\"noteFilter\"] = this.noteFilter.toJsonObject();\r\n\r\n            for (let i: number = 0; i < Config.filterMorphCount; i++) {\r\n                if (this.noteSubFilters[i] != null)\r\n                    instrumentObject[\"noteSubFilters\" + i] = this.noteSubFilters[i]!.toJsonObject();\r\n            }\r\n        }\r\n        if (effectsIncludeDistortion(this.effects)) {\r\n            instrumentObject[\"distortion\"] = Math.round(100 * this.distortion / (Config.distortionRange - 1));\r\n            instrumentObject[\"aliases\"] = this.aliases;\r\n        }\r\n        if (effectsIncludeBitcrusher(this.effects)) {\r\n            instrumentObject[\"bitcrusherOctave\"] = (Config.bitcrusherFreqRange - 1 - this.bitcrusherFreq) * Config.bitcrusherOctaveStep;\r\n            instrumentObject[\"bitcrusherQuantization\"] = Math.round(100 * this.bitcrusherQuantization / (Config.bitcrusherQuantizationRange - 1));\r\n        }\r\n        if (effectsIncludePanning(this.effects)) {\r\n            instrumentObject[\"pan\"] = Math.round(100 * (this.pan - Config.panCenter) / Config.panCenter);\r\n            instrumentObject[\"panDelay\"] = this.panDelay;\r\n        }\r\n        if (effectsIncludeChorus(this.effects)) {\r\n            instrumentObject[\"chorus\"] = Math.round(100 * this.chorus / (Config.chorusRange - 1));\r\n        }\r\n        if (effectsIncludeEcho(this.effects)) {\r\n            instrumentObject[\"echoSustain\"] = Math.round(100 * this.echoSustain / (Config.echoSustainRange - 1));\r\n            instrumentObject[\"echoDelayBeats\"] = Math.round(1000 * (this.echoDelay + 1) * Config.echoDelayStepTicks / (Config.ticksPerPart * Config.partsPerBeat)) / 1000;\r\n        }\r\n        if (effectsIncludeReverb(this.effects)) {\r\n            instrumentObject[\"reverb\"] = Math.round(100 * this.reverb / (Config.reverbRange - 1));\r\n        }\r\n\r\n        if (this.type != InstrumentType.drumset) {\r\n            instrumentObject[\"fadeInSeconds\"] = Math.round(10000 * Synth.fadeInSettingToSeconds(this.fadeIn)) / 10000;\r\n            instrumentObject[\"fadeOutTicks\"] = Synth.fadeOutSettingToTicks(this.fadeOut);\r\n        }\r\n\r\n        if (this.type == InstrumentType.harmonics || this.type == InstrumentType.pickedString) {\r\n            instrumentObject[\"harmonics\"] = [];\r\n            for (let i: number = 0; i < Config.harmonicsControlPoints; i++) {\r\n                instrumentObject[\"harmonics\"][i] = Math.round(100 * this.harmonicsWave.harmonics[i] / Config.harmonicsMax);\r\n            }\r\n        }\r\n\r\n        if (this.type == InstrumentType.noise) {\r\n            instrumentObject[\"wave\"] = Config.chipNoises[this.chipNoise].name;\r\n        } else if (this.type == InstrumentType.spectrum) {\r\n            instrumentObject[\"spectrum\"] = [];\r\n            for (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n                instrumentObject[\"spectrum\"][i] = Math.round(100 * this.spectrumWave.spectrum[i] / Config.spectrumMax);\r\n            }\r\n        } else if (this.type == InstrumentType.drumset) {\r\n            instrumentObject[\"drums\"] = [];\r\n            for (let j: number = 0; j < Config.drumCount; j++) {\r\n                const spectrum: number[] = [];\r\n                for (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n                    spectrum[i] = Math.round(100 * this.drumsetSpectrumWaves[j].spectrum[i] / Config.spectrumMax);\r\n                }\r\n                instrumentObject[\"drums\"][j] = {\r\n                    \"filterEnvelope\": this.getDrumsetEnvelope(j).name,\r\n                    \"spectrum\": spectrum,\r\n                };\r\n            }\r\n        } else if (this.type == InstrumentType.chip) {\r\n            instrumentObject[\"wave\"] = Config.chipWaves[this.chipWave].name;\r\n            instrumentObject[\"unison\"] = Config.unisons[this.unison].name;\r\n        } else if (this.type == InstrumentType.pwm) {\r\n            instrumentObject[\"pulseWidth\"] = this.pulseWidth;\r\n        } else if (this.type == InstrumentType.pickedString) {\r\n            instrumentObject[\"unison\"] = Config.unisons[this.unison].name;\r\n            instrumentObject[\"stringSustain\"] = Math.round(100 * this.stringSustain / (Config.stringSustainRange - 1));\r\n        } else if (this.type == InstrumentType.harmonics) {\r\n            instrumentObject[\"unison\"] = Config.unisons[this.unison].name;\r\n        } else if (this.type == InstrumentType.fm) {\r\n            const operatorArray: Object[] = [];\r\n            for (const operator of this.operators) {\r\n                operatorArray.push({\r\n                    \"frequency\": Config.operatorFrequencies[operator.frequency].name,\r\n                    \"amplitude\": operator.amplitude,\r\n                    \"waveform\": Config.operatorWaves[operator.waveform].name,\r\n                    \"pulseWidth\": operator.pulseWidth,\r\n                });\r\n            }\r\n            instrumentObject[\"algorithm\"] = Config.algorithms[this.algorithm].name;\r\n            instrumentObject[\"feedbackType\"] = Config.feedbacks[this.feedbackType].name;\r\n            instrumentObject[\"feedbackAmplitude\"] = this.feedbackAmplitude;\r\n            instrumentObject[\"operators\"] = operatorArray;\r\n        } else if (this.type == InstrumentType.customChipWave) {\r\n            instrumentObject[\"wave\"] = Config.chipWaves[this.chipWave].name;\r\n            instrumentObject[\"unison\"] = Config.unisons[this.unison].name;\r\n            instrumentObject[\"customChipWave\"] = new Float64Array(64);\r\n            instrumentObject[\"customChipWaveIntegral\"] = new Float64Array(65);\r\n            for (let i: number = 0; i < this.customChipWave.length; i++) {\r\n                instrumentObject[\"customChipWave\"][i] = this.customChipWave[i];\r\n                // Meh, waste of space and can be inaccurate. It will be recalc'ed when instrument loads.\r\n                //instrumentObject[\"customChipWaveIntegral\"][i] = this.customChipWaveIntegral[i];\r\n            }\r\n        } else if (this.type == InstrumentType.mod) {\r\n            instrumentObject[\"modChannels\"] = [];\r\n            instrumentObject[\"modInstruments\"] = [];\r\n            instrumentObject[\"modSettings\"] = [];\r\n            instrumentObject[\"modStatuses\"] = [];\r\n            for (let mod: number = 0; mod < Config.modCount; mod++) {\r\n                instrumentObject[\"modChannels\"][mod] = this.modChannels[mod];\r\n                instrumentObject[\"modInstruments\"][mod] = this.modInstruments[mod];\r\n                instrumentObject[\"modSettings\"][mod] = this.modulators[mod];\r\n            }\r\n        } else {\r\n            throw new Error(\"Unrecognized instrument type\");\r\n        }\r\n\r\n        const envelopes: any[] = [];\r\n        for (let i = 0; i < this.envelopeCount; i++) {\r\n            envelopes.push(this.envelopes[i].toJsonObject());\r\n        }\r\n        instrumentObject[\"envelopes\"] = envelopes;\r\n\r\n        return instrumentObject;\r\n    }\r\n\r\n\r\n    public fromJsonObject(instrumentObject: any, isNoiseChannel: boolean, isModChannel: boolean, useSlowerRhythm: boolean, useFastTwoNoteArp: boolean, legacyGlobalReverb: number = 0): void {\r\n        if (instrumentObject == undefined) instrumentObject = {};\r\n\r\n        let type: InstrumentType = Config.instrumentTypeNames.indexOf(instrumentObject[\"type\"]);\r\n        if (<any>type == -1) type = isModChannel ? InstrumentType.mod : (isNoiseChannel ? InstrumentType.noise : InstrumentType.chip);\r\n        this.setTypeAndReset(type, isNoiseChannel, isModChannel);\r\n\r\n        if (instrumentObject[\"preset\"] != undefined) {\r\n            this.preset = instrumentObject[\"preset\"] >>> 0;\r\n        }\r\n\r\n        if (instrumentObject[\"volume\"] != undefined) {\r\n            this.volume = clamp(-Config.volumeRange / 2, (Config.volumeRange / 2) + 1, instrumentObject[\"volume\"] | 0);\r\n        } else {\r\n            this.volume = 0;\r\n        }\r\n\r\n        if (Array.isArray(instrumentObject[\"effects\"])) {\r\n            let effects: number = 0;\r\n            for (let i: number = 0; i < instrumentObject[\"effects\"].length; i++) {\r\n                effects = effects | (1 << Config.effectNames.indexOf(instrumentObject[\"effects\"][i]));\r\n            }\r\n            this.effects = (effects & ((1 << EffectType.length) - 1));\r\n        } else {\r\n            // The index of these names is reinterpreted as a bitfield, which relies on reverb and chorus being the first effects!\r\n            const legacyEffectsNames: string[] = [\"none\", \"reverb\", \"chorus\", \"chorus & reverb\"];\r\n            this.effects = legacyEffectsNames.indexOf(instrumentObject[\"effects\"]);\r\n            if (this.effects == -1) this.effects = (this.type == InstrumentType.noise) ? 0 : 1;\r\n        }\r\n\r\n        this.transition = Config.transitions.dictionary[\"normal\"].index; // default value.\r\n        const transitionProperty: any = instrumentObject[\"transition\"] || instrumentObject[\"envelope\"]; // the transition property used to be called envelope, so check that too.\r\n        if (transitionProperty != undefined) {\r\n            let transition: Transition | undefined = Config.transitions.dictionary[transitionProperty];\r\n            if (instrumentObject[\"fadeInSeconds\"] == undefined || instrumentObject[\"fadeOutTicks\"] == undefined) {\r\n                const legacySettings = (<any>{\r\n                    \"binary\": { transition: \"interrupt\", fadeInSeconds: 0.0, fadeOutTicks: -1 },\r\n                    \"seamless\": { transition: \"interrupt\", fadeInSeconds: 0.0, fadeOutTicks: -1 },\r\n                    \"sudden\": { transition: \"normal\", fadeInSeconds: 0.0, fadeOutTicks: -3 },\r\n                    \"hard\": { transition: \"normal\", fadeInSeconds: 0.0, fadeOutTicks: -3 },\r\n                    \"smooth\": { transition: \"normal\", fadeInSeconds: 0.025, fadeOutTicks: -3 },\r\n                    \"soft\": { transition: \"normal\", fadeInSeconds: 0.025, fadeOutTicks: -3 },\r\n                    // Note that the old slide transition has the same name as a new slide transition that is different.\r\n                    // Only apply legacy settings if the instrument JSON was created before, based on the presence\r\n                    // of the fade in/out fields.\r\n                    \"slide\": { transition: \"slide in pattern\", fadeInSeconds: 0.025, fadeOutTicks: -3 },\r\n                    \"cross fade\": { transition: \"normal\", fadeInSeconds: 0.04, fadeOutTicks: 6 },\r\n                    \"hard fade\": { transition: \"normal\", fadeInSeconds: 0.0, fadeOutTicks: 48 },\r\n                    \"medium fade\": { transition: \"normal\", fadeInSeconds: 0.0125, fadeOutTicks: 72 },\r\n                    \"soft fade\": { transition: \"normal\", fadeInSeconds: 0.06, fadeOutTicks: 96 },\r\n                })[transitionProperty];\r\n                if (legacySettings != undefined) {\r\n                    transition = Config.transitions.dictionary[legacySettings.transition];\r\n                    // These may be overridden below.\r\n                    this.fadeIn = Synth.secondsToFadeInSetting(legacySettings.fadeInSeconds);\r\n                    this.fadeOut = Synth.ticksToFadeOutSetting(legacySettings.fadeOutTicks);\r\n                }\r\n            }\r\n            if (transition != undefined) this.transition = transition.index;\r\n\r\n            if (this.transition != Config.transitions.dictionary[\"normal\"].index) {\r\n                // Enable transition if it was used.\r\n                this.effects = (this.effects | (1 << EffectType.transition));\r\n            }\r\n        }\r\n\r\n        // Overrides legacy settings in transition above.\r\n        if (instrumentObject[\"fadeInSeconds\"] != undefined) {\r\n            this.fadeIn = Synth.secondsToFadeInSetting(+instrumentObject[\"fadeInSeconds\"]);\r\n        }\r\n        if (instrumentObject[\"fadeOutTicks\"] != undefined) {\r\n            this.fadeOut = Synth.ticksToFadeOutSetting(+instrumentObject[\"fadeOutTicks\"]);\r\n        }\r\n\r\n        {\r\n            // Note that the chord setting may be overridden by instrumentObject[\"chorus\"] below.\r\n            const chordProperty: any = instrumentObject[\"chord\"];\r\n            const legacyChordNames: Dictionary<string> = { \"harmony\": \"simultaneous\" };\r\n            const chord: Chord | undefined = Config.chords.dictionary[legacyChordNames[chordProperty]] || Config.chords.dictionary[chordProperty];\r\n            if (chord != undefined) {\r\n                this.chord = chord.index;\r\n            } else {\r\n                // Different instruments have different default chord types based on historical behaviour.\r\n                if (this.type == InstrumentType.noise) {\r\n                    this.chord = Config.chords.dictionary[\"arpeggio\"].index;\r\n                } else if (this.type == InstrumentType.pickedString) {\r\n                    this.chord = Config.chords.dictionary[\"strum\"].index;\r\n                } else if (this.type == InstrumentType.chip) {\r\n                    this.chord = Config.chords.dictionary[\"arpeggio\"].index;\r\n                } else if (this.type == InstrumentType.fm) {\r\n                    this.chord = Config.chords.dictionary[\"custom interval\"].index;\r\n                } else {\r\n                    this.chord = Config.chords.dictionary[\"simultaneous\"].index;\r\n                }\r\n            }\r\n        }\r\n\r\n        this.unison = Config.unisons.dictionary[\"none\"].index; // default value.\r\n        const unisonProperty: any = instrumentObject[\"unison\"] || instrumentObject[\"interval\"] || instrumentObject[\"chorus\"]; // The unison property has gone by various names in the past.\r\n        if (unisonProperty != undefined) {\r\n            const legacyChorusNames: Dictionary<string> = { \"union\": \"none\", \"fifths\": \"fifth\", \"octaves\": \"octave\" };\r\n            const unison: Unison | undefined = Config.unisons.dictionary[legacyChorusNames[unisonProperty]] || Config.unisons.dictionary[unisonProperty];\r\n            if (unison != undefined) this.unison = unison.index;\r\n        }\r\n        if (instrumentObject[\"chorus\"] == \"custom harmony\") {\r\n            // The original chorus setting had an option that now maps to two different settings. Override those if necessary.\r\n            this.unison = Config.unisons.dictionary[\"hum\"].index;\r\n            this.chord = Config.chords.dictionary[\"custom interval\"].index;\r\n        }\r\n        if (this.chord != Config.chords.dictionary[\"simultaneous\"].index && !Array.isArray(instrumentObject[\"effects\"])) {\r\n            // Enable chord if it was used.\r\n            this.effects = (this.effects | (1 << EffectType.chord));\r\n        }\r\n\r\n        if (instrumentObject[\"pitchShiftSemitones\"] != undefined) {\r\n            this.pitchShift = clamp(0, Config.pitchShiftRange, Math.round(+instrumentObject[\"pitchShiftSemitones\"]));\r\n        }\r\n        if (instrumentObject[\"detuneCents\"] != undefined) {\r\n            this.detune = clamp(Config.detuneMin, Config.detuneMax + 1, Math.round(Synth.centsToDetune(+instrumentObject[\"detuneCents\"])));\r\n        }\r\n\r\n        this.vibrato = Config.vibratos.dictionary[\"none\"].index; // default value.\r\n        const vibratoProperty: any = instrumentObject[\"vibrato\"] || instrumentObject[\"effect\"]; // The vibrato property was previously called \"effect\", not to be confused with the current \"effects\".\r\n        if (vibratoProperty != undefined) {\r\n\r\n            const legacyVibratoNames: Dictionary<string> = { \"vibrato light\": \"light\", \"vibrato delayed\": \"delayed\", \"vibrato heavy\": \"heavy\" };\r\n            const vibrato: Vibrato | undefined = Config.vibratos.dictionary[legacyVibratoNames[unisonProperty]] || Config.vibratos.dictionary[vibratoProperty];\r\n            if (vibrato != undefined)\r\n                this.vibrato = vibrato.index;\r\n            else if (vibratoProperty == \"custom\")\r\n                this.vibrato = Config.vibratos.length; // custom\r\n\r\n            if (this.vibrato == Config.vibratos.length) {\r\n                this.vibratoDepth = instrumentObject[\"vibratoDepth\"];\r\n                this.vibratoSpeed = instrumentObject[\"vibratoSpeed\"];\r\n                this.vibratoDelay = instrumentObject[\"vibratoDelay\"];\r\n                this.vibratoType = instrumentObject[\"vibratoType\"];\r\n            }\r\n            else { // Set defaults for the vibrato profile\r\n                this.vibratoDepth = Config.vibratos[this.vibrato].amplitude;\r\n                this.vibratoDelay = Config.vibratos[this.vibrato].delayTicks / 2;\r\n                this.vibratoSpeed = 10; // default;\r\n                this.vibratoType = Config.vibratos[this.vibrato].type;\r\n            }\r\n\r\n            // Old songs may have a vibrato effect without explicitly enabling it.\r\n            if (vibrato != Config.vibratos.dictionary[\"none\"]) {\r\n                this.effects = (this.effects | (1 << EffectType.vibrato));\r\n            }\r\n        }\r\n\r\n        if (instrumentObject[\"pan\"] != undefined) {\r\n            this.pan = clamp(0, Config.panMax + 1, Math.round(Config.panCenter + (instrumentObject[\"pan\"] | 0) * Config.panCenter / 100));\r\n\r\n            // Old songs may have a panning effect without explicitly enabling it.\r\n            if (this.pan != Config.panCenter) {\r\n                this.effects = (this.effects | (1 << EffectType.panning));\r\n            }\r\n        } else {\r\n            this.pan = Config.panCenter;\r\n            // Still enabling pan effect, to make it a default\r\n            this.effects = (this.effects | (1 << EffectType.panning));\r\n        }\r\n\r\n        if (instrumentObject[\"panDelay\"] != undefined) {\r\n            this.panDelay = (instrumentObject[\"panDelay\"] | 0);\r\n        } else {\r\n            this.panDelay = 10;\r\n        }\r\n\r\n        if (instrumentObject[\"detune\"] != undefined) {\r\n            this.detune = clamp(Config.detuneMin, Config.detuneMax + 1, (instrumentObject[\"detune\"] | 0));\r\n        }\r\n        else if (instrumentObject[\"detuneCents\"] == undefined) {\r\n            this.detune = Config.detuneCenter;\r\n        }\r\n\r\n        if (instrumentObject[\"distortion\"] != undefined) {\r\n            this.distortion = clamp(0, Config.distortionRange, Math.round((Config.distortionRange - 1) * (instrumentObject[\"distortion\"] | 0) / 100));\r\n        }\r\n\r\n        if (instrumentObject[\"bitcrusherOctave\"] != undefined) {\r\n            this.bitcrusherFreq = Config.bitcrusherFreqRange - 1 - (+instrumentObject[\"bitcrusherOctave\"]) / Config.bitcrusherOctaveStep;\r\n        }\r\n        if (instrumentObject[\"bitcrusherQuantization\"] != undefined) {\r\n            this.bitcrusherQuantization = clamp(0, Config.bitcrusherQuantizationRange, Math.round((Config.bitcrusherQuantizationRange - 1) * (instrumentObject[\"bitcrusherQuantization\"] | 0) / 100));\r\n        }\r\n\r\n        if (instrumentObject[\"echoSustain\"] != undefined) {\r\n            this.echoSustain = clamp(0, Config.echoSustainRange, Math.round((Config.echoSustainRange - 1) * (instrumentObject[\"echoSustain\"] | 0) / 100));\r\n        }\r\n        if (instrumentObject[\"echoDelayBeats\"] != undefined) {\r\n            this.echoDelay = clamp(0, Config.echoDelayRange, Math.round((+instrumentObject[\"echoDelayBeats\"]) * (Config.ticksPerPart * Config.partsPerBeat) / Config.echoDelayStepTicks - 1.0));\r\n        }\r\n\r\n        if (!isNaN(instrumentObject[\"chorus\"])) {\r\n            this.chorus = clamp(0, Config.chorusRange, Math.round((Config.chorusRange - 1) * (instrumentObject[\"chorus\"] | 0) / 100));\r\n        }\r\n\r\n        if (instrumentObject[\"reverb\"] != undefined) {\r\n            this.reverb = clamp(0, Config.reverbRange, Math.round((Config.reverbRange - 1) * (instrumentObject[\"reverb\"] | 0) / 100));\r\n        } else {\r\n            this.reverb = legacyGlobalReverb;\r\n        }\r\n\r\n        if (instrumentObject[\"pulseWidth\"] != undefined) {\r\n            this.pulseWidth = clamp(1, Config.pulseWidthRange + 1, Math.round(instrumentObject[\"pulseWidth\"]));\r\n        } else {\r\n            this.pulseWidth = Config.pulseWidthRange;\r\n        }\r\n\r\n        if (instrumentObject[\"harmonics\"] != undefined) {\r\n            for (let i: number = 0; i < Config.harmonicsControlPoints; i++) {\r\n                this.harmonicsWave.harmonics[i] = Math.max(0, Math.min(Config.harmonicsMax, Math.round(Config.harmonicsMax * (+instrumentObject[\"harmonics\"][i]) / 100)));\r\n            }\r\n            this.harmonicsWave.markCustomWaveDirty();\r\n        } else {\r\n            this.harmonicsWave.reset();\r\n        }\r\n\r\n        if (instrumentObject[\"spectrum\"] != undefined) {\r\n            for (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n                this.spectrumWave.spectrum[i] = Math.max(0, Math.min(Config.spectrumMax, Math.round(Config.spectrumMax * (+instrumentObject[\"spectrum\"][i]) / 100)));\r\n            }\r\n        } else {\r\n            this.spectrumWave.reset(isNoiseChannel);\r\n        }\r\n\r\n        if (instrumentObject[\"stringSustain\"] != undefined) {\r\n            this.stringSustain = clamp(0, Config.stringSustainRange, Math.round((Config.stringSustainRange - 1) * (instrumentObject[\"stringSustain\"] | 0) / 100));\r\n        } else {\r\n            this.stringSustain = 10;\r\n        }\r\n\r\n        if (this.type == InstrumentType.noise) {\r\n            this.chipNoise = Config.chipNoises.findIndex(wave => wave.name == instrumentObject[\"wave\"]);\r\n            if (this.chipNoise == -1) this.chipNoise = 1;\r\n        }\r\n\r\n        const legacyEnvelopeNames: Dictionary<string> = { \"custom\": \"note size\", \"steady\": \"none\", \"pluck 1\": \"twang 1\", \"pluck 2\": \"twang 2\", \"pluck 3\": \"twang 3\" };\r\n        const getEnvelope = (name: any): Envelope | undefined => (legacyEnvelopeNames[name] != undefined) ? Config.envelopes.dictionary[legacyEnvelopeNames[name]] : Config.envelopes.dictionary[name];\r\n\r\n        if (this.type == InstrumentType.drumset) {\r\n            if (instrumentObject[\"drums\"] != undefined) {\r\n                for (let j: number = 0; j < Config.drumCount; j++) {\r\n                    const drum: any = instrumentObject[\"drums\"][j];\r\n                    if (drum == undefined) continue;\r\n\r\n                    this.drumsetEnvelopes[j] = Config.envelopes.dictionary[\"twang 2\"].index; // default value.\r\n                    if (drum[\"filterEnvelope\"] != undefined) {\r\n                        const envelope: Envelope | undefined = getEnvelope(drum[\"filterEnvelope\"]);\r\n                        if (envelope != undefined) this.drumsetEnvelopes[j] = envelope.index;\r\n                    }\r\n                    if (drum[\"spectrum\"] != undefined) {\r\n                        for (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n                            this.drumsetSpectrumWaves[j].spectrum[i] = Math.max(0, Math.min(Config.spectrumMax, Math.round(Config.spectrumMax * (+drum[\"spectrum\"][i]) / 100)));\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        if (this.type == InstrumentType.chip) {\r\n            const legacyWaveNames: Dictionary<number> = { \"triangle\": 1, \"square\": 2, \"pulse wide\": 3, \"pulse narrow\": 4, \"sawtooth\": 5, \"double saw\": 6, \"double pulse\": 7, \"spiky\": 8, \"plateau\": 0 };\r\n            this.chipWave = legacyWaveNames[instrumentObject[\"wave\"]] != undefined ? legacyWaveNames[instrumentObject[\"wave\"]] : Config.chipWaves.findIndex(wave => wave.name == instrumentObject[\"wave\"]);\r\n            if (this.chipWave == -1) this.chipWave = 1;\r\n        }\r\n\r\n        if (this.type == InstrumentType.fm) {\r\n            this.algorithm = Config.algorithms.findIndex(algorithm => algorithm.name == instrumentObject[\"algorithm\"]);\r\n            if (this.algorithm == -1) this.algorithm = 0;\r\n            this.feedbackType = Config.feedbacks.findIndex(feedback => feedback.name == instrumentObject[\"feedbackType\"]);\r\n            if (this.feedbackType == -1) this.feedbackType = 0;\r\n            if (instrumentObject[\"feedbackAmplitude\"] != undefined) {\r\n                this.feedbackAmplitude = clamp(0, Config.operatorAmplitudeMax + 1, instrumentObject[\"feedbackAmplitude\"] | 0);\r\n            } else {\r\n                this.feedbackAmplitude = 0;\r\n            }\r\n\r\n            for (let j: number = 0; j < Config.operatorCount; j++) {\r\n                const operator: Operator = this.operators[j];\r\n                let operatorObject: any = undefined;\r\n                if (instrumentObject[\"operators\"] != undefined) operatorObject = instrumentObject[\"operators\"][j];\r\n                if (operatorObject == undefined) operatorObject = {};\r\n\r\n                operator.frequency = Config.operatorFrequencies.findIndex(freq => freq.name == operatorObject[\"frequency\"]);\r\n                if (operator.frequency == -1) operator.frequency = 0;\r\n                if (operatorObject[\"amplitude\"] != undefined) {\r\n                    operator.amplitude = clamp(0, Config.operatorAmplitudeMax + 1, operatorObject[\"amplitude\"] | 0);\r\n                } else {\r\n                    operator.amplitude = 0;\r\n                }\r\n                if (operatorObject[\"waveform\"] != undefined) {\r\n                    operator.waveform = Config.operatorWaves.findIndex(wave => wave.name == operatorObject[\"waveform\"]);\r\n                    if (operator.waveform == -1) {\r\n                        // GoldBox compatibility\r\n                        if (operatorObject[\"waveform\"] == \"square\") {\r\n                            operator.waveform = Config.operatorWaves.dictionary[\"pulse width\"].index;\r\n                            operator.pulseWidth = 5;\r\n                        } else {\r\n                            operator.waveform = 0;\r\n                        }\r\n\r\n                    }\r\n                } else {\r\n                    operator.waveform = 0;\r\n                }\r\n                if (operatorObject[\"pulseWidth\"] != undefined) {\r\n                    operator.pulseWidth = operatorObject[\"pulseWidth\"] | 0;\r\n                } else {\r\n                    operator.pulseWidth = 5;\r\n                }\r\n            }\r\n        }\r\n        else if (this.type == InstrumentType.customChipWave) {\r\n            if (instrumentObject[\"customChipWave\"]) {\r\n\r\n                for (let i: number = 0; i < 64; i++) {\r\n                    this.customChipWave[i] = instrumentObject[\"customChipWave\"][i];\r\n                }\r\n\r\n\r\n                let sum: number = 0.0;\r\n                for (let i: number = 0; i < this.customChipWave.length; i++) {\r\n                    sum += this.customChipWave[i];\r\n                }\r\n                const average: number = sum / this.customChipWave.length;\r\n\r\n                // Perform the integral on the wave. The chipSynth will perform the derivative to get the original wave back but with antialiasing.\r\n                let cumulative: number = 0;\r\n                let wavePrev: number = 0;\r\n                for (let i: number = 0; i < this.customChipWave.length; i++) {\r\n                    cumulative += wavePrev;\r\n                    wavePrev = this.customChipWave[i] - average;\r\n                    this.customChipWaveIntegral[i] = cumulative;\r\n                }\r\n\r\n                // 65th, last sample is for anti-aliasing\r\n                this.customChipWaveIntegral[64] = 0.0;\r\n            }\r\n        } else if (this.type == InstrumentType.mod) {\r\n            if (instrumentObject[\"modChannels\"] != undefined) {\r\n                for (let mod: number = 0; mod < Config.modCount; mod++) {\r\n                    this.modChannels[mod] = instrumentObject[\"modChannels\"][mod];\r\n                    this.modInstruments[mod] = instrumentObject[\"modInstruments\"][mod];\r\n                    this.modulators[mod] = instrumentObject[\"modSettings\"][mod];\r\n                }\r\n            }\r\n        }\r\n\r\n        if (this.type != InstrumentType.mod) {\r\n            // Arpeggio speed\r\n            if (this.chord == Config.chords.dictionary[\"arpeggio\"].index && instrumentObject[\"arpeggioSpeed\"] != undefined) {\r\n                this.arpeggioSpeed = instrumentObject[\"arpeggioSpeed\"];\r\n            }\r\n            else {\r\n                this.arpeggioSpeed = (useSlowerRhythm) ? 9 : 12; // Decide whether to import arps as x3/4 speed\r\n            }\r\n\r\n            if (instrumentObject[\"fastTwoNoteArp\"] != undefined) {\r\n                this.fastTwoNoteArp = instrumentObject[\"fastTwoNoteArp\"];\r\n            }\r\n            else {\r\n                this.fastTwoNoteArp = useFastTwoNoteArp;\r\n            }\r\n\r\n            if (instrumentObject[\"clicklessTransition\"] != undefined) {\r\n                this.clicklessTransition = instrumentObject[\"clicklessTransition\"];\r\n            }\r\n            else {\r\n                this.clicklessTransition = false;\r\n            }\r\n\r\n            if (instrumentObject[\"aliases\"] != undefined) {\r\n                this.aliases = instrumentObject[\"aliases\"];\r\n            }\r\n            else {\r\n                this.aliases = false;\r\n            }\r\n\r\n            if (instrumentObject[\"noteFilterType\"] != undefined) {\r\n                this.noteFilterType = instrumentObject[\"noteFilterType\"];\r\n            }\r\n            if (instrumentObject[\"noteSimpleCut\"] != undefined) {\r\n                this.noteFilterSimpleCut = instrumentObject[\"noteSimpleCut\"];\r\n            }\r\n            if (instrumentObject[\"noteSimplePeak\"] != undefined) {\r\n                this.noteFilterSimplePeak = instrumentObject[\"noteSimplePeak\"];\r\n            }\r\n            if (instrumentObject[\"noteFilter\"] != undefined) {\r\n                this.noteFilter.fromJsonObject(instrumentObject[\"noteFilter\"]);\r\n            } else {\r\n                this.noteFilter.reset();\r\n            }\r\n            for (let i: number = 0; i < Config.filterMorphCount; i++) {\r\n                if (Array.isArray(instrumentObject[\"noteSubFilters\" + i])) {\r\n                    this.noteSubFilters[i] = new FilterSettings();\r\n                    this.noteSubFilters[i]!.fromJsonObject(instrumentObject[\"noteSubFilters\" + i]);\r\n                }\r\n            }\r\n            if (instrumentObject[\"eqFilterType\"] != undefined) {\r\n                this.eqFilterType = instrumentObject[\"eqFilterType\"];\r\n            }\r\n            if (instrumentObject[\"eqSimpleCut\"] != undefined) {\r\n                this.eqFilterSimpleCut = instrumentObject[\"eqSimpleCut\"];\r\n            }\r\n            if (instrumentObject[\"eqSimplePeak\"] != undefined) {\r\n                this.eqFilterSimplePeak = instrumentObject[\"eqSimplePeak\"];\r\n            }\r\n            if (Array.isArray(instrumentObject[\"eqFilter\"])) {\r\n                this.eqFilter.fromJsonObject(instrumentObject[\"eqFilter\"]);\r\n            } else {\r\n                this.eqFilter.reset();\r\n\r\n                const legacySettings: LegacySettings = {};\r\n\r\n                // Try converting from legacy filter settings.\r\n                const filterCutoffMaxHz: number = 8000;\r\n                const filterCutoffRange: number = 11;\r\n                const filterResonanceRange: number = 8;\r\n                if (instrumentObject[\"filterCutoffHz\"] != undefined) {\r\n                    legacySettings.filterCutoff = clamp(0, filterCutoffRange, Math.round((filterCutoffRange - 1) + 2.0 * Math.log((instrumentObject[\"filterCutoffHz\"] | 0) / filterCutoffMaxHz) / Math.LN2));\r\n                } else {\r\n                    legacySettings.filterCutoff = (this.type == InstrumentType.chip) ? 6 : 10;\r\n                }\r\n                if (instrumentObject[\"filterResonance\"] != undefined) {\r\n                    legacySettings.filterResonance = clamp(0, filterResonanceRange, Math.round((filterResonanceRange - 1) * (instrumentObject[\"filterResonance\"] | 0) / 100));\r\n                } else {\r\n                    legacySettings.filterResonance = 0;\r\n                }\r\n\r\n                legacySettings.filterEnvelope = getEnvelope(instrumentObject[\"filterEnvelope\"]);\r\n                legacySettings.pulseEnvelope = getEnvelope(instrumentObject[\"pulseEnvelope\"]);\r\n                legacySettings.feedbackEnvelope = getEnvelope(instrumentObject[\"feedbackEnvelope\"]);\r\n                if (Array.isArray(instrumentObject[\"operators\"])) {\r\n                    legacySettings.operatorEnvelopes = [];\r\n                    for (let j: number = 0; j < Config.operatorCount; j++) {\r\n                        let envelope: Envelope | undefined;\r\n                        if (instrumentObject[\"operators\"][j] != undefined) {\r\n                            envelope = getEnvelope(instrumentObject[\"operators\"][j][\"envelope\"]);\r\n                        }\r\n                        legacySettings.operatorEnvelopes[j] = (envelope != undefined) ? envelope : Config.envelopes.dictionary[\"none\"];\r\n                    }\r\n                }\r\n\r\n                // Try converting from even older legacy filter settings.\r\n                if (instrumentObject[\"filter\"] != undefined) {\r\n                    const legacyToCutoff: number[] = [10, 6, 3, 0, 8, 5, 2];\r\n                    const legacyToEnvelope: string[] = [\"none\", \"none\", \"none\", \"none\", \"decay 1\", \"decay 2\", \"decay 3\"];\r\n                    const filterNames: string[] = [\"none\", \"bright\", \"medium\", \"soft\", \"decay bright\", \"decay medium\", \"decay soft\"];\r\n                    const oldFilterNames: Dictionary<number> = { \"sustain sharp\": 1, \"sustain medium\": 2, \"sustain soft\": 3, \"decay sharp\": 4 };\r\n                    let legacyFilter: number = oldFilterNames[instrumentObject[\"filter\"]] != undefined ? oldFilterNames[instrumentObject[\"filter\"]] : filterNames.indexOf(instrumentObject[\"filter\"]);\r\n                    if (legacyFilter == -1) legacyFilter = 0;\r\n                    legacySettings.filterCutoff = legacyToCutoff[legacyFilter];\r\n                    legacySettings.filterEnvelope = getEnvelope(legacyToEnvelope[legacyFilter]);\r\n                    legacySettings.filterResonance = 0;\r\n                }\r\n\r\n                this.convertLegacySettings(legacySettings, true);\r\n            }\r\n\r\n            for (let i: number = 0; i < Config.filterMorphCount; i++) {\r\n                if (Array.isArray(instrumentObject[\"eqSubFilters\" + i])) {\r\n                    this.eqSubFilters[i] = new FilterSettings();\r\n                    this.eqSubFilters[i]!.fromJsonObject(instrumentObject[\"eqSubFilters\" + i]);\r\n                }\r\n            }\r\n\r\n            if (Array.isArray(instrumentObject[\"envelopes\"])) {\r\n                const envelopeArray: any[] = instrumentObject[\"envelopes\"];\r\n                for (let i = 0; i < envelopeArray.length; i++) {\r\n                    if (this.envelopeCount >= Config.maxEnvelopeCount) break;\r\n                    const tempEnvelope: EnvelopeSettings = new EnvelopeSettings();\r\n                    tempEnvelope.fromJsonObject(envelopeArray[i]);\r\n                    this.addEnvelope(tempEnvelope.target, tempEnvelope.index, tempEnvelope.envelope);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    public static frequencyFromPitch(pitch: number): number {\r\n        return 440.0 * Math.pow(2.0, (pitch - 69.0) / 12.0);\r\n    }\r\n\r\n    public addEnvelope(target: number, index: number, envelope: number): void {\r\n        let makeEmpty: boolean = false;\r\n        if (!this.supportsEnvelopeTarget(target, index)) makeEmpty = true;\r\n        if (this.envelopeCount >= Config.maxEnvelopeCount) throw new Error();\r\n        while (this.envelopes.length <= this.envelopeCount) this.envelopes[this.envelopes.length] = new EnvelopeSettings();\r\n        const envelopeSettings: EnvelopeSettings = this.envelopes[this.envelopeCount];\r\n        envelopeSettings.target = makeEmpty ? Config.instrumentAutomationTargets.dictionary[\"none\"].index : target;\r\n        envelopeSettings.index = makeEmpty ? 0 : index;\r\n        envelopeSettings.envelope = envelope;\r\n        this.envelopeCount++;\r\n    }\r\n\r\n    public supportsEnvelopeTarget(target: number, index: number): boolean {\r\n        const automationTarget: AutomationTarget = Config.instrumentAutomationTargets[target];\r\n        if (index >= automationTarget.maxCount) {\r\n            return false;\r\n        }\r\n        if (automationTarget.compatibleInstruments != null && automationTarget.compatibleInstruments.indexOf(this.type) == -1) {\r\n            return false;\r\n        }\r\n        if (automationTarget.effect != null && (this.effects & (1 << automationTarget.effect)) == 0) {\r\n            return false;\r\n        }\r\n        if (automationTarget.isFilter) {\r\n            //if (automationTarget.perNote) {\r\n            let useControlPointCount: number = this.noteFilter.controlPointCount;\r\n            if (this.noteFilterType)\r\n                useControlPointCount = 1;\r\n            if (index >= useControlPointCount) return false;\r\n            //} else {\r\n            //\tif (index >= this.eqFilter.controlPointCount)   return false;\r\n            //}\r\n        }\r\n        return true;\r\n    }\r\n\r\n    public clearInvalidEnvelopeTargets(): void {\r\n        for (let envelopeIndex: number = 0; envelopeIndex < this.envelopeCount; envelopeIndex++) {\r\n            const target: number = this.envelopes[envelopeIndex].target;\r\n            const index: number = this.envelopes[envelopeIndex].index;\r\n            if (!this.supportsEnvelopeTarget(target, index)) {\r\n                this.envelopes[envelopeIndex].target = Config.instrumentAutomationTargets.dictionary[\"none\"].index;\r\n                this.envelopes[envelopeIndex].index = 0;\r\n            }\r\n        }\r\n    }\r\n\r\n    public getTransition(): Transition {\r\n        return effectsIncludeTransition(this.effects) ? Config.transitions[this.transition] :\r\n            (this.type == InstrumentType.mod ? Config.transitions.dictionary[\"interrupt\"] : Config.transitions.dictionary[\"normal\"]);\r\n    }\r\n\r\n    public getFadeInSeconds(): number {\r\n        return (this.type == InstrumentType.drumset) ? 0.0 : Synth.fadeInSettingToSeconds(this.fadeIn);\r\n    }\r\n\r\n    public getFadeOutTicks(): number {\r\n        return (this.type == InstrumentType.drumset) ? Config.drumsetFadeOutTicks : Synth.fadeOutSettingToTicks(this.fadeOut)\r\n    }\r\n\r\n    public getChord(): Chord {\r\n        return effectsIncludeChord(this.effects) ? Config.chords[this.chord] : Config.chords.dictionary[\"simultaneous\"];\r\n    }\r\n\r\n    public getDrumsetEnvelope(pitch: number): Envelope {\r\n        if (this.type != InstrumentType.drumset) throw new Error(\"Can't getDrumsetEnvelope() for non-drumset.\");\r\n        return Config.envelopes[this.drumsetEnvelopes[pitch]];\r\n    }\r\n}\r\n\r\nexport class Channel {\r\n    public octave: number = 0;\r\n    public readonly instruments: Instrument[] = [];\r\n    public readonly patterns: Pattern[] = [];\r\n    public readonly bars: number[] = [];\r\n    public muted: boolean = false;\r\n    public name: string = \"\";\r\n}\r\n\r\nexport class Song {\r\n    private static readonly _format: string = \"BeepBox\";\r\n    private static readonly _oldestBeepboxVersion: number = 2;\r\n    private static readonly _latestBeepboxVersion: number = 9;\r\n    private static readonly _oldestJummBoxVersion: number = 1;\r\n    private static readonly _latestJummBoxVersion: number = 5;\r\n    // One-character variant detection at the start of URL to distinguish variants such as JummBox.\r\n    private static readonly _variant = 0x6A; //\"j\" ~ jummbox\r\n\r\n    public title: string;\r\n    public scale: number;\r\n    public key: number;\r\n    public tempo: number;\r\n    public reverb: number;\r\n    public beatsPerBar: number;\r\n    public barCount: number;\r\n    public patternsPerChannel: number;\r\n    public rhythm: number;\r\n    public layeredInstruments: boolean;\r\n    public patternInstruments: boolean;\r\n    public loopStart: number;\r\n    public loopLength: number;\r\n    public pitchChannelCount: number;\r\n    public noiseChannelCount: number;\r\n    public modChannelCount: number;\r\n    public readonly channels: Channel[] = [];\r\n    public limitDecay: number = 4.0;\r\n    public limitRise: number = 4000.0;\r\n    public compressionThreshold: number = 1.0;\r\n    public limitThreshold: number = 1.0;\r\n    public compressionRatio: number = 1.0;\r\n    public limitRatio: number = 1.0;\r\n    public masterGain: number = 1.0;\r\n    public inVolumeCap: number = 0.0;\r\n    public outVolumeCap: number = 0.0;\r\n\r\n    constructor(string?: string) {\r\n        if (string != undefined) {\r\n            this.fromBase64String(string);\r\n        } else {\r\n            this.initToDefault(true);\r\n        }\r\n    }\r\n\r\n    // Returns the ideal new note volume when dragging (max volume for a normal note, a \"neutral\" value for mod notes based on how they work)\r\n    public getNewNoteVolume = (isMod: boolean, modChannel?: number, modInstrument?: number, modCount?: number): number => {\r\n        if (!isMod || modChannel == undefined || modInstrument == undefined || modCount == undefined)\r\n            return 6;\r\n        else {\r\n            // Sigh, the way pitches count up and the visual ordering in the UI are flipped.\r\n            modCount = Config.modCount - modCount - 1;\r\n\r\n            let vol: number | undefined = Config.modulators[this.channels[modChannel].instruments[modInstrument].modulators[modCount]].newNoteVol;\r\n\r\n            // For tempo, actually use user defined tempo\r\n            let tempoIndex: number = Config.modulators.dictionary[\"tempo\"].index;\r\n            if (this.channels[modChannel].instruments[modInstrument].modulators[modCount] == tempoIndex) {\r\n                vol = this.tempo - Config.modulators[tempoIndex].convertRealFactor;\r\n            }\r\n\r\n            if (vol != undefined)\r\n                return vol;\r\n            else\r\n                return 6;\r\n        }\r\n    }\r\n\r\n\r\n    public getVolumeCap = (isMod: boolean, modChannel?: number, modInstrument?: number, modCount?: number): number => {\r\n        if (!isMod || modChannel == undefined || modInstrument == undefined || modCount == undefined)\r\n            return 6;\r\n        else {\r\n            // Sigh, the way pitches count up and the visual ordering in the UI are flipped.\r\n            modCount = Config.modCount - modCount - 1;\r\n\r\n            let instrument: Instrument = this.channels[modChannel].instruments[modInstrument];\r\n            let modulator = Config.modulators[instrument.modulators[modCount]];\r\n            let cap: number | undefined = modulator.maxRawVol;\r\n\r\n            if (cap != undefined) {\r\n                // For filters, cap is dependent on which filter setting is targeted\r\n                if (modulator.name == \"eq filter\" || modulator.name == \"note filter\") {\r\n                    // type 0: number of filter morphs\r\n                    // type 1/odd: number of filter x positions\r\n                    // type 2/even: number of filter y positions\r\n                    cap = Config.filterMorphCount - 1;\r\n                    if (instrument.modFilterTypes[modCount] > 0 && instrument.modFilterTypes[modCount] % 2) {\r\n                        cap = Config.filterFreqRange;\r\n                    } else if (instrument.modFilterTypes[modCount] > 0) {\r\n                        cap = Config.filterGainRange;\r\n                    }\r\n                }\r\n                return cap;\r\n            }\r\n            else\r\n                return 6;\r\n        }\r\n    }\r\n\r\n    public getVolumeCapForSetting = (isMod: boolean, modSetting: number, filterType?: number): number => {\r\n        if (!isMod)\r\n            return Config.noteSizeMax;\r\n        else {\r\n            let cap: number | undefined = Config.modulators[modSetting].maxRawVol;\r\n            if (cap != undefined) {\r\n\r\n                // For filters, cap is dependent on which filter setting is targeted\r\n                if (filterType != undefined && (Config.modulators[modSetting].name == \"eq filter\" || Config.modulators[modSetting].name == \"note filter\")) {\r\n                    // type 0: number of filter morphs\r\n                    // type 1/odd: number of filter x positions\r\n                    // type 2/even: number of filter y positions\r\n                    cap = Config.filterMorphCount - 1;\r\n                    if (filterType > 0 && filterType % 2) {\r\n                        cap = Config.filterFreqRange;\r\n                    } else if (filterType > 0) {\r\n                        cap = Config.filterGainRange;\r\n                    }\r\n                }\r\n\r\n                return cap;\r\n            }\r\n            else\r\n                return Config.noteSizeMax;\r\n        }\r\n    }\r\n\r\n    public getChannelCount(): number {\r\n        return this.pitchChannelCount + this.noiseChannelCount + this.modChannelCount;\r\n    }\r\n\r\n    public getMaxInstrumentsPerChannel(): number {\r\n        return Math.max(\r\n            this.layeredInstruments ? Config.layeredInstrumentCountMax : Config.instrumentCountMin,\r\n            this.patternInstruments ? Config.patternInstrumentCountMax : Config.instrumentCountMin);\r\n    }\r\n\r\n    public getMaxInstrumentsPerPattern(channelIndex: number): number {\r\n        return this.getMaxInstrumentsPerPatternForChannel(this.channels[channelIndex]);\r\n    }\r\n\r\n    public getMaxInstrumentsPerPatternForChannel(channel: Channel): number {\r\n        return this.layeredInstruments\r\n            ? Math.min(Config.layeredInstrumentCountMax, channel.instruments.length)\r\n            : 1;\r\n    }\r\n\r\n    public getChannelIsNoise(channelIndex: number): boolean {\r\n        return (channelIndex >= this.pitchChannelCount && channelIndex < this.pitchChannelCount + this.noiseChannelCount);\r\n    }\r\n\r\n    public getChannelIsMod(channelIndex: number): boolean {\r\n        return (channelIndex >= this.pitchChannelCount + this.noiseChannelCount);\r\n    }\r\n\r\n    public initToDefault(andResetChannels: boolean = true): void {\r\n        this.scale = 0;\r\n        this.key = 0;\r\n        this.loopStart = 0;\r\n        this.loopLength = 4;\r\n        this.tempo = 150;\r\n        this.reverb = 0;\r\n        this.beatsPerBar = 8;\r\n        this.barCount = 16;\r\n        this.patternsPerChannel = 8;\r\n        this.rhythm = 1;\r\n        this.layeredInstruments = false;\r\n        this.patternInstruments = false;\r\n\r\n        this.title = \"Unnamed\";\r\n        //document.title = EditorConfig.versionDisplayName;\r\n\r\n        if (andResetChannels) {\r\n            this.pitchChannelCount = 3;\r\n            this.noiseChannelCount = 1;\r\n            this.modChannelCount = 0;\r\n            for (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n                const isNoiseChannel: boolean = channelIndex >= this.pitchChannelCount && channelIndex < this.pitchChannelCount + this.noiseChannelCount;\r\n                const isModChannel: boolean = channelIndex >= this.pitchChannelCount + this.noiseChannelCount;\r\n                if (this.channels.length <= channelIndex) {\r\n                    this.channels[channelIndex] = new Channel();\r\n                }\r\n                const channel: Channel = this.channels[channelIndex];\r\n                channel.octave = Math.max(3 - channelIndex, 0); // [3, 2, 1, 0]; Descending octaves with drums at zero in last channel.\r\n\r\n                for (let pattern: number = 0; pattern < this.patternsPerChannel; pattern++) {\r\n                    if (channel.patterns.length <= pattern) {\r\n                        channel.patterns[pattern] = new Pattern();\r\n                    } else {\r\n                        channel.patterns[pattern].reset();\r\n                    }\r\n                }\r\n                channel.patterns.length = this.patternsPerChannel;\r\n\r\n                for (let instrument: number = 0; instrument < Config.instrumentCountMin; instrument++) {\r\n                    if (channel.instruments.length <= instrument) {\r\n                        channel.instruments[instrument] = new Instrument(isNoiseChannel, isModChannel);\r\n                    }\r\n                    channel.instruments[instrument].setTypeAndReset(isModChannel ? InstrumentType.mod : (isNoiseChannel ? InstrumentType.noise : InstrumentType.chip), isNoiseChannel, isModChannel);\r\n                }\r\n                channel.instruments.length = Config.instrumentCountMin;\r\n\r\n                for (let bar: number = 0; bar < this.barCount; bar++) {\r\n                    channel.bars[bar] = bar < 4 ? 1 : 0;\r\n                }\r\n                channel.bars.length = this.barCount;\r\n            }\r\n            this.channels.length = this.getChannelCount();\r\n        }\r\n    }\r\n\r\n    public toBase64String(): string {\r\n        let bits: BitFieldWriter;\r\n        let buffer: number[] = [];\r\n\r\n        buffer.push(Song._variant);\r\n        buffer.push(base64IntToCharCode[Song._latestJummBoxVersion]);\r\n\r\n        // Length of the song name string\r\n        buffer.push(SongTagCode.songTitle);\r\n        var encodedSongTitle: string = encodeURIComponent(this.title);\r\n        buffer.push(base64IntToCharCode[encodedSongTitle.length >> 6], base64IntToCharCode[encodedSongTitle.length & 0x3f]);\r\n\r\n        // Actual encoded string follows\r\n        for (let i: number = 0; i < encodedSongTitle.length; i++) {\r\n            buffer.push(encodedSongTitle.charCodeAt(i));\r\n        }\r\n\r\n        buffer.push(SongTagCode.channelCount, base64IntToCharCode[this.pitchChannelCount], base64IntToCharCode[this.noiseChannelCount], base64IntToCharCode[this.modChannelCount]);\r\n        buffer.push(SongTagCode.scale, base64IntToCharCode[this.scale]);\r\n        buffer.push(SongTagCode.key, base64IntToCharCode[this.key]);\r\n        buffer.push(SongTagCode.loopStart, base64IntToCharCode[this.loopStart >> 6], base64IntToCharCode[this.loopStart & 0x3f]);\r\n        buffer.push(SongTagCode.loopEnd, base64IntToCharCode[(this.loopLength - 1) >> 6], base64IntToCharCode[(this.loopLength - 1) & 0x3f]);\r\n        buffer.push(SongTagCode.tempo, base64IntToCharCode[this.tempo >> 6], base64IntToCharCode[this.tempo & 0x3F]);\r\n        buffer.push(SongTagCode.beatCount, base64IntToCharCode[this.beatsPerBar - 1]);\r\n        buffer.push(SongTagCode.barCount, base64IntToCharCode[(this.barCount - 1) >> 6], base64IntToCharCode[(this.barCount - 1) & 0x3f]);\r\n        buffer.push(SongTagCode.patternCount, base64IntToCharCode[(this.patternsPerChannel - 1) >> 6], base64IntToCharCode[(this.patternsPerChannel - 1) & 0x3f]);\r\n        buffer.push(SongTagCode.rhythm, base64IntToCharCode[this.rhythm]);\r\n\r\n        // Push limiter settings, but only if they aren't the default!\r\n        buffer.push(SongTagCode.limiterSettings);\r\n        if (this.compressionRatio != 1.0 || this.limitRatio != 1.0 || this.limitRise != 4000.0 || this.limitDecay != 4.0 || this.limitThreshold != 1.0 || this.compressionThreshold != 1.0 || this.masterGain != 1.0) {\r\n            buffer.push(base64IntToCharCode[Math.round(this.compressionRatio < 1 ? this.compressionRatio * 10 : 10 + (this.compressionRatio - 1) * 60)]); // 0 ~ 1.15 uneven, mapped to 0 ~ 20\r\n            buffer.push(base64IntToCharCode[Math.round(this.limitRatio < 1 ? this.limitRatio * 10 : 9 + this.limitRatio)]); // 0 ~ 10 uneven, mapped to 0 ~ 20\r\n            buffer.push(base64IntToCharCode[this.limitDecay]); // directly 1 ~ 30\r\n            buffer.push(base64IntToCharCode[Math.round((this.limitRise - 2000.0) / 250.0)]); // 2000 ~ 10000 by 250, mapped to 0 ~ 32\r\n            buffer.push(base64IntToCharCode[Math.round(this.compressionThreshold * 20)]); // 0 ~ 1.1 by 0.05, mapped to 0 ~ 22\r\n            buffer.push(base64IntToCharCode[Math.round(this.limitThreshold * 20)]); // 0 ~ 2 by 0.05, mapped to 0 ~ 40\r\n            buffer.push(base64IntToCharCode[Math.round(this.masterGain * 50) >> 6], base64IntToCharCode[Math.round(this.masterGain * 50) & 0x3f]); // 0 ~ 5 by 0.02, mapped to 0 ~ 250\r\n        }\r\n        else {\r\n            buffer.push(base64IntToCharCode[0x3f]); // Not using limiter\r\n        }\r\n\r\n        buffer.push(SongTagCode.channelNames);\r\n        for (let channel: number = 0; channel < this.getChannelCount(); channel++) {\r\n            // Length of the channel name string\r\n            var encodedChannelName: string = encodeURIComponent(this.channels[channel].name);\r\n            buffer.push(base64IntToCharCode[encodedChannelName.length >> 6], base64IntToCharCode[encodedChannelName.length & 0x3f]);\r\n\r\n            // Actual encoded string follows\r\n            for (let i: number = 0; i < encodedChannelName.length; i++) {\r\n                buffer.push(encodedChannelName.charCodeAt(i));\r\n            }\r\n        }\r\n\r\n        buffer.push(SongTagCode.instrumentCount, base64IntToCharCode[(<any>this.layeredInstruments << 1) | <any>this.patternInstruments]);\r\n        if (this.layeredInstruments || this.patternInstruments) {\r\n            for (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n                buffer.push(base64IntToCharCode[this.channels[channelIndex].instruments.length - Config.instrumentCountMin]);\r\n            }\r\n        }\r\n\r\n        buffer.push(SongTagCode.channelOctave);\r\n        for (let channelIndex: number = 0; channelIndex < this.pitchChannelCount; channelIndex++) {\r\n            buffer.push(base64IntToCharCode[this.channels[channelIndex].octave]);\r\n        }\r\n\r\n        for (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n            for (let i: number = 0; i < this.channels[channelIndex].instruments.length; i++) {\r\n                const instrument: Instrument = this.channels[channelIndex].instruments[i];\r\n                buffer.push(SongTagCode.startInstrument, base64IntToCharCode[instrument.type]);\r\n                buffer.push(SongTagCode.volume, base64IntToCharCode[(instrument.volume + Config.volumeRange / 2) >> 6], base64IntToCharCode[(instrument.volume + Config.volumeRange / 2) & 0x3f]);\r\n                buffer.push(SongTagCode.preset, base64IntToCharCode[instrument.preset >> 6], base64IntToCharCode[instrument.preset & 63]);\r\n\r\n                buffer.push(SongTagCode.eqFilter);\r\n                buffer.push(base64IntToCharCode[+instrument.eqFilterType]);\r\n                if (instrument.eqFilterType) {\r\n                    buffer.push(base64IntToCharCode[instrument.eqFilterSimpleCut]);\r\n                    buffer.push(base64IntToCharCode[instrument.eqFilterSimplePeak]);\r\n                }\r\n                else {\r\n                    if (instrument.eqFilter == null) {\r\n                        // Push null filter settings\r\n                        buffer.push(base64IntToCharCode[0]);\r\n                        console.log(\"Null EQ filter settings detected in toBase64String for channelIndex \" + channelIndex + \", instrumentIndex \" + i);\r\n                    } else {\r\n                        buffer.push(base64IntToCharCode[instrument.eqFilter.controlPointCount]);\r\n                        for (let j: number = 0; j < instrument.eqFilter.controlPointCount; j++) {\r\n                            const point: FilterControlPoint = instrument.eqFilter.controlPoints[j];\r\n                            buffer.push(base64IntToCharCode[point.type], base64IntToCharCode[Math.round(point.freq)], base64IntToCharCode[Math.round(point.gain)]);\r\n                        }\r\n                    }\r\n\r\n                    // Push subfilters as well. Skip Index 0, is a copy of the base filter.\r\n                    let usingSubFilterBitfield: number = 0;\r\n                    for (let j: number = 0; j < Config.filterMorphCount - 1; j++) {\r\n                        usingSubFilterBitfield |= (+(instrument.eqSubFilters[j + 1] != null) << j);\r\n                    }\r\n                    // Put subfilter usage into 2 chars (12 bits)\r\n                    buffer.push(base64IntToCharCode[usingSubFilterBitfield >> 6], base64IntToCharCode[usingSubFilterBitfield & 63]);\r\n                    // Put subfilter info in for all used subfilters\r\n                    for (let j: number = 0; j < Config.filterMorphCount - 1; j++) {\r\n                        if (usingSubFilterBitfield & (1 << j)) {\r\n                            buffer.push(base64IntToCharCode[instrument.eqSubFilters[j + 1]!.controlPointCount]);\r\n                            for (let k: number = 0; k < instrument.eqSubFilters[j + 1]!.controlPointCount; k++) {\r\n                                const point: FilterControlPoint = instrument.eqSubFilters[j + 1]!.controlPoints[k];\r\n                                buffer.push(base64IntToCharCode[point.type], base64IntToCharCode[Math.round(point.freq)], base64IntToCharCode[Math.round(point.gain)]);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n\r\n                // The list of enabled effects is represented as a 12-bit bitfield using two six-bit characters.\r\n                buffer.push(SongTagCode.effects, base64IntToCharCode[instrument.effects >> 6], base64IntToCharCode[instrument.effects & 63]);\r\n                if (effectsIncludeNoteFilter(instrument.effects)) {\r\n                    buffer.push(base64IntToCharCode[+instrument.noteFilterType]);\r\n                    if (instrument.noteFilterType) {\r\n                        buffer.push(base64IntToCharCode[instrument.noteFilterSimpleCut]);\r\n                        buffer.push(base64IntToCharCode[instrument.noteFilterSimplePeak]);\r\n                    }\r\n                    else {\r\n                        if (instrument.noteFilter == null) {\r\n                            // Push null filter settings\r\n                            buffer.push(base64IntToCharCode[0]);\r\n                            console.log(\"Null note filter settings detected in toBase64String for channelIndex \" + channelIndex + \", instrumentIndex \" + i);\r\n                        }\r\n                        else {\r\n                            buffer.push(base64IntToCharCode[instrument.noteFilter.controlPointCount]);\r\n                            for (let j: number = 0; j < instrument.noteFilter.controlPointCount; j++) {\r\n                                const point: FilterControlPoint = instrument.noteFilter.controlPoints[j];\r\n                                buffer.push(base64IntToCharCode[point.type], base64IntToCharCode[Math.round(point.freq)], base64IntToCharCode[Math.round(point.gain)]);\r\n                            }\r\n                        }\r\n\r\n                        // Push subfilters as well. Skip Index 0, is a copy of the base filter.\r\n                        let usingSubFilterBitfield: number = 0;\r\n                        for (let j: number = 0; j < Config.filterMorphCount - 1; j++) {\r\n                            usingSubFilterBitfield |= (+(instrument.noteSubFilters[j + 1] != null) << j);\r\n                        }\r\n                        // Put subfilter usage into 2 chars (12 bits)\r\n                        buffer.push(base64IntToCharCode[usingSubFilterBitfield >> 6], base64IntToCharCode[usingSubFilterBitfield & 63]);\r\n                        // Put subfilter info in for all used subfilters\r\n                        for (let j: number = 0; j < Config.filterMorphCount - 1; j++) {\r\n                            if (usingSubFilterBitfield & (1 << j)) {\r\n                                buffer.push(base64IntToCharCode[instrument.noteSubFilters[j + 1]!.controlPointCount]);\r\n                                for (let k: number = 0; k < instrument.noteSubFilters[j + 1]!.controlPointCount; k++) {\r\n                                    const point: FilterControlPoint = instrument.noteSubFilters[j + 1]!.controlPoints[k];\r\n                                    buffer.push(base64IntToCharCode[point.type], base64IntToCharCode[Math.round(point.freq)], base64IntToCharCode[Math.round(point.gain)]);\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                if (effectsIncludeTransition(instrument.effects)) {\r\n                    buffer.push(base64IntToCharCode[instrument.transition]);\r\n                }\r\n                if (effectsIncludeChord(instrument.effects)) {\r\n                    buffer.push(base64IntToCharCode[instrument.chord]);\r\n                    // Custom arpeggio speed... only if the instrument arpeggiates.\r\n                    if (instrument.chord == Config.chords.dictionary[\"arpeggio\"].index) {\r\n                        buffer.push(base64IntToCharCode[instrument.arpeggioSpeed]);\r\n                        buffer.push(base64IntToCharCode[+instrument.fastTwoNoteArp]); // Two note arp setting piggybacks on this\r\n                    }\r\n                }\r\n                if (effectsIncludePitchShift(instrument.effects)) {\r\n                    buffer.push(base64IntToCharCode[instrument.pitchShift]);\r\n                }\r\n                if (effectsIncludeDetune(instrument.effects)) {\r\n                    buffer.push(base64IntToCharCode[(instrument.detune - Config.detuneMin) >> 6], base64IntToCharCode[(instrument.detune - Config.detuneMin) & 0x3F]);\r\n                }\r\n                if (effectsIncludeVibrato(instrument.effects)) {\r\n                    buffer.push(base64IntToCharCode[instrument.vibrato]);\r\n                    // Custom vibrato settings\r\n                    if (instrument.vibrato == Config.vibratos.length) {\r\n                        buffer.push(base64IntToCharCode[Math.round(instrument.vibratoDepth * 25)]);\r\n                        buffer.push(base64IntToCharCode[instrument.vibratoSpeed]);\r\n                        buffer.push(base64IntToCharCode[Math.round(instrument.vibratoDelay)]);\r\n                        buffer.push(base64IntToCharCode[instrument.vibratoType]);\r\n                    }\r\n                }\r\n                if (effectsIncludeDistortion(instrument.effects)) {\r\n                    buffer.push(base64IntToCharCode[instrument.distortion]);\r\n                    // Aliasing is tied into distortion for now\r\n                    buffer.push(base64IntToCharCode[+instrument.aliases]);\r\n                }\r\n                if (effectsIncludeBitcrusher(instrument.effects)) {\r\n                    buffer.push(base64IntToCharCode[instrument.bitcrusherFreq], base64IntToCharCode[instrument.bitcrusherQuantization]);\r\n                }\r\n                if (effectsIncludePanning(instrument.effects)) {\r\n                    buffer.push(base64IntToCharCode[instrument.pan >> 6], base64IntToCharCode[instrument.pan & 0x3f]);\r\n                    buffer.push(base64IntToCharCode[instrument.panDelay]);\r\n                }\r\n                if (effectsIncludeChorus(instrument.effects)) {\r\n                    buffer.push(base64IntToCharCode[instrument.chorus]);\r\n                }\r\n                if (effectsIncludeEcho(instrument.effects)) {\r\n                    buffer.push(base64IntToCharCode[instrument.echoSustain], base64IntToCharCode[instrument.echoDelay]);\r\n                }\r\n                if (effectsIncludeReverb(instrument.effects)) {\r\n                    buffer.push(base64IntToCharCode[instrument.reverb]);\r\n                }\r\n\r\n                if (instrument.type != InstrumentType.drumset) {\r\n                    buffer.push(SongTagCode.fadeInOut, base64IntToCharCode[instrument.fadeIn], base64IntToCharCode[instrument.fadeOut]);\r\n                    // Transition info follows transition song tag\r\n                    buffer.push(base64IntToCharCode[+instrument.clicklessTransition]);\r\n                }\r\n\r\n                if (instrument.type == InstrumentType.harmonics || instrument.type == InstrumentType.pickedString) {\r\n                    buffer.push(SongTagCode.harmonics);\r\n                    const harmonicsBits: BitFieldWriter = new BitFieldWriter();\r\n                    for (let i: number = 0; i < Config.harmonicsControlPoints; i++) {\r\n                        harmonicsBits.write(Config.harmonicsControlPointBits, instrument.harmonicsWave.harmonics[i]);\r\n                    }\r\n                    harmonicsBits.encodeBase64(buffer);\r\n                }\r\n\r\n                if (instrument.type == InstrumentType.chip) {\r\n                    buffer.push(SongTagCode.wave, base64IntToCharCode[instrument.chipWave]);\r\n                    buffer.push(SongTagCode.unison, base64IntToCharCode[instrument.unison]);\r\n                } else if (instrument.type == InstrumentType.fm) {\r\n                    buffer.push(SongTagCode.algorithm, base64IntToCharCode[instrument.algorithm]);\r\n                    buffer.push(SongTagCode.feedbackType, base64IntToCharCode[instrument.feedbackType]);\r\n                    buffer.push(SongTagCode.feedbackAmplitude, base64IntToCharCode[instrument.feedbackAmplitude]);\r\n\r\n                    buffer.push(SongTagCode.operatorFrequencies);\r\n                    for (let o: number = 0; o < Config.operatorCount; o++) {\r\n                        buffer.push(base64IntToCharCode[instrument.operators[o].frequency]);\r\n                    }\r\n                    buffer.push(SongTagCode.operatorAmplitudes);\r\n                    for (let o: number = 0; o < Config.operatorCount; o++) {\r\n                        buffer.push(base64IntToCharCode[instrument.operators[o].amplitude]);\r\n                    }\r\n\r\n                    buffer.push(SongTagCode.operatorWaves);\r\n                    for (let o: number = 0; o < Config.operatorCount; o++) {\r\n                        buffer.push(base64IntToCharCode[instrument.operators[o].waveform]);\r\n                        // Push pulse width if that type is used\r\n                        if (instrument.operators[o].waveform == 3) {\r\n                            buffer.push(base64IntToCharCode[instrument.operators[o].pulseWidth]);\r\n                        }\r\n                    }\r\n                } else if (instrument.type == InstrumentType.customChipWave) {\r\n                    buffer.push(SongTagCode.wave, base64IntToCharCode[instrument.chipWave]);\r\n                    buffer.push(SongTagCode.unison, base64IntToCharCode[instrument.unison]);\r\n                    buffer.push(SongTagCode.customChipWave);\r\n                    // Push custom wave values\r\n                    for (let j: number = 0; j < 64; j++) {\r\n                        buffer.push(base64IntToCharCode[(instrument.customChipWave[j] + 24) as number]);\r\n                    }\r\n                } else if (instrument.type == InstrumentType.noise) {\r\n                    buffer.push(SongTagCode.wave, base64IntToCharCode[instrument.chipNoise]);\r\n                } else if (instrument.type == InstrumentType.spectrum) {\r\n                    buffer.push(SongTagCode.spectrum);\r\n                    const spectrumBits: BitFieldWriter = new BitFieldWriter();\r\n                    for (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n                        spectrumBits.write(Config.spectrumControlPointBits, instrument.spectrumWave.spectrum[i]);\r\n                    }\r\n                    spectrumBits.encodeBase64(buffer);\r\n                } else if (instrument.type == InstrumentType.drumset) {\r\n                    buffer.push(SongTagCode.drumsetEnvelopes);\r\n                    for (let j: number = 0; j < Config.drumCount; j++) {\r\n                        buffer.push(base64IntToCharCode[instrument.drumsetEnvelopes[j]]);\r\n                    }\r\n\r\n                    buffer.push(SongTagCode.spectrum);\r\n                    const spectrumBits: BitFieldWriter = new BitFieldWriter();\r\n                    for (let j: number = 0; j < Config.drumCount; j++) {\r\n                        for (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n                            spectrumBits.write(Config.spectrumControlPointBits, instrument.drumsetSpectrumWaves[j].spectrum[i]);\r\n                        }\r\n                    }\r\n                    spectrumBits.encodeBase64(buffer);\r\n                } else if (instrument.type == InstrumentType.harmonics) {\r\n                    buffer.push(SongTagCode.unison, base64IntToCharCode[instrument.unison]);\r\n                } else if (instrument.type == InstrumentType.pwm) {\r\n                    buffer.push(SongTagCode.pulseWidth, base64IntToCharCode[instrument.pulseWidth]);\r\n                } else if (instrument.type == InstrumentType.pickedString) {\r\n                    buffer.push(SongTagCode.unison, base64IntToCharCode[instrument.unison]);\r\n                    buffer.push(SongTagCode.stringSustain, base64IntToCharCode[instrument.stringSustain]);\r\n                } else if (instrument.type == InstrumentType.mod) {\r\n                    // Handled down below. Could be moved, but meh.\r\n                } else {\r\n                    throw new Error(\"Unknown instrument type.\");\r\n                }\r\n\r\n                buffer.push(SongTagCode.envelopes, base64IntToCharCode[instrument.envelopeCount]);\r\n                for (let envelopeIndex: number = 0; envelopeIndex < instrument.envelopeCount; envelopeIndex++) {\r\n                    buffer.push(base64IntToCharCode[instrument.envelopes[envelopeIndex].target]);\r\n                    if (Config.instrumentAutomationTargets[instrument.envelopes[envelopeIndex].target].maxCount > 1) {\r\n                        buffer.push(base64IntToCharCode[instrument.envelopes[envelopeIndex].index]);\r\n                    }\r\n                    buffer.push(base64IntToCharCode[instrument.envelopes[envelopeIndex].envelope]);\r\n                }\r\n            }\r\n        }\r\n\r\n        buffer.push(SongTagCode.bars);\r\n        bits = new BitFieldWriter();\r\n        let neededBits: number = 0;\r\n        while ((1 << neededBits) < this.patternsPerChannel + 1) neededBits++;\r\n        for (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) for (let i: number = 0; i < this.barCount; i++) {\r\n            bits.write(neededBits, this.channels[channelIndex].bars[i]);\r\n        }\r\n        bits.encodeBase64(buffer);\r\n\r\n        buffer.push(SongTagCode.patterns);\r\n        bits = new BitFieldWriter();\r\n        const shapeBits: BitFieldWriter = new BitFieldWriter();\r\n        const bitsPerNoteSize: number = Song.getNeededBits(Config.noteSizeMax);\r\n        for (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n            const channel: Channel = this.channels[channelIndex];\r\n            const maxInstrumentsPerPattern: number = this.getMaxInstrumentsPerPattern(channelIndex);\r\n            const isNoiseChannel: boolean = this.getChannelIsNoise(channelIndex);\r\n            const isModChannel: boolean = this.getChannelIsMod(channelIndex);\r\n            const neededInstrumentCountBits: number = Song.getNeededBits(maxInstrumentsPerPattern - Config.instrumentCountMin);\r\n            const neededInstrumentIndexBits: number = Song.getNeededBits(channel.instruments.length - 1);\r\n\r\n            // Some info about modulator settings immediately follows in mod channels.\r\n            if (isModChannel) {\r\n                const neededModInstrumentIndexBits: number = Song.getNeededBits(this.getMaxInstrumentsPerChannel() + 2);\r\n                for (let instrumentIndex: number = 0; instrumentIndex < channel.instruments.length; instrumentIndex++) {\r\n\r\n                    let instrument: Instrument = this.channels[channelIndex].instruments[instrumentIndex];\r\n\r\n                    for (let mod: number = 0; mod < Config.modCount; mod++) {\r\n                        const modChannel: number = instrument.modChannels[mod];\r\n                        const modInstrument: number = instrument.modInstruments[mod];\r\n                        const modSetting: number = instrument.modulators[mod];\r\n                        const modFilter: number = instrument.modFilterTypes[mod];\r\n\r\n                        // Still using legacy \"mod status\" format, but doing it manually as it's only used in the URL now.\r\n                        // 0 - For pitch/noise\r\n                        // 1 - (used to be For noise, not needed)\r\n                        // 2 - For song\r\n                        // 3 - None\r\n\r\n                        let status: number = Config.modulators[modSetting].forSong ? 2 : 0;\r\n                        if (modSetting == Config.modulators.dictionary[\"none\"].index)\r\n                            status = 3;\r\n\r\n                        bits.write(2, status);\r\n\r\n                        // Channel/Instrument is only used if the status isn't \"song\" or \"none\".\r\n                        if (status == 0 || status == 1) {\r\n                            bits.write(8, modChannel);\r\n                            bits.write(neededModInstrumentIndexBits, modInstrument);\r\n                        }\r\n\r\n                        // Only used if setting isn't \"none\".\r\n                        if (status != 3) {\r\n                            bits.write(6, modSetting);\r\n                        }\r\n\r\n                        // Write mod filter info, only if this is a filter mod\r\n                        if (Config.modulators[instrument.modulators[mod]].name == \"eq filter\" || Config.modulators[instrument.modulators[mod]].name == \"note filter\") {\r\n                            bits.write(6, modFilter);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            const octaveOffset: number = (isNoiseChannel || isModChannel) ? 0 : channel.octave * Config.pitchesPerOctave;\r\n            let lastPitch: number = (isNoiseChannel ? 4 : octaveOffset);\r\n            const recentPitches: number[] = isModChannel ? [0, 1, 2, 3, 4, 5] : (isNoiseChannel ? [4, 6, 7, 2, 3, 8, 0, 10] : [0, 7, 12, 19, 24, -5, -12]);\r\n            const recentShapes: string[] = [];\r\n            for (let i: number = 0; i < recentPitches.length; i++) {\r\n                recentPitches[i] += octaveOffset;\r\n            }\r\n            for (const pattern of channel.patterns) {\r\n                if (this.patternInstruments) {\r\n                    const instrumentCount: number = validateRange(Config.instrumentCountMin, maxInstrumentsPerPattern, pattern.instruments.length);\r\n                    bits.write(neededInstrumentCountBits, instrumentCount - Config.instrumentCountMin);\r\n                    for (let i: number = 0; i < instrumentCount; i++) {\r\n                        bits.write(neededInstrumentIndexBits, pattern.instruments[i]);\r\n                    }\r\n                }\r\n\r\n                if (pattern.notes.length > 0) {\r\n                    bits.write(1, 1);\r\n\r\n                    let curPart: number = 0;\r\n                    for (const note of pattern.notes) {\r\n\r\n                        // For mod channels, a negative offset may be necessary.\r\n                        if (note.start < curPart && isModChannel) {\r\n                            bits.write(2, 0); // rest, then...\r\n                            bits.write(1, 1); // negative offset\r\n                            bits.writePartDuration(curPart - note.start);\r\n                        }\r\n\r\n                        if (note.start > curPart) {\r\n                            bits.write(2, 0); // rest\r\n                            if (isModChannel) bits.write(1, 0); // positive offset, only needed for mod channels\r\n                            bits.writePartDuration(note.start - curPart);\r\n                        }\r\n\r\n                        shapeBits.clear();\r\n\r\n                        // Old format was:\r\n                        // 0: 1 pitch, 10: 2 pitches, 110: 3 pitches, 111: 4 pitches\r\n                        // New format is:\r\n                        //      0: 1 pitch\r\n                        // 1[XXX]: 3 bits of binary signifying 2+ pitches\r\n                        if (note.pitches.length == 1) {\r\n                            shapeBits.write(1, 0);\r\n                        } else {\r\n                            shapeBits.write(1, 1);\r\n                            shapeBits.write(3, note.pitches.length - 2);\r\n                        }\r\n\r\n                        shapeBits.writePinCount(note.pins.length - 1);\r\n\r\n                        if (!isModChannel) {\r\n                            shapeBits.write(bitsPerNoteSize, note.pins[0].size); // volume\r\n                        }\r\n                        else {\r\n                            shapeBits.write(9, note.pins[0].size); // Modulator value. 9 bits for now = 512 max mod value?\r\n                        }\r\n\r\n                        let shapePart: number = 0;\r\n                        let startPitch: number = note.pitches[0];\r\n                        let currentPitch: number = startPitch;\r\n                        const pitchBends: number[] = [];\r\n                        for (let i: number = 1; i < note.pins.length; i++) {\r\n                            const pin: NotePin = note.pins[i];\r\n                            const nextPitch: number = startPitch + pin.interval;\r\n                            if (currentPitch != nextPitch) {\r\n                                shapeBits.write(1, 1);\r\n                                pitchBends.push(nextPitch);\r\n                                currentPitch = nextPitch;\r\n                            } else {\r\n                                shapeBits.write(1, 0);\r\n                            }\r\n                            shapeBits.writePartDuration(pin.time - shapePart);\r\n                            shapePart = pin.time;\r\n                            if (!isModChannel) {\r\n                                shapeBits.write(bitsPerNoteSize, pin.size);\r\n                            } else {\r\n                                shapeBits.write(9, pin.size);\r\n                            }\r\n                        }\r\n\r\n                        const shapeString: string = String.fromCharCode.apply(null, shapeBits.encodeBase64([]));\r\n                        const shapeIndex: number = recentShapes.indexOf(shapeString);\r\n                        if (shapeIndex == -1) {\r\n                            bits.write(2, 1); // new shape\r\n                            bits.concat(shapeBits);\r\n                        } else {\r\n                            bits.write(1, 1); // old shape\r\n                            bits.writeLongTail(0, 0, shapeIndex);\r\n                            recentShapes.splice(shapeIndex, 1);\r\n                        }\r\n                        recentShapes.unshift(shapeString);\r\n                        if (recentShapes.length > 10) recentShapes.pop();\r\n\r\n                        const allPitches: number[] = note.pitches.concat(pitchBends);\r\n                        for (let i: number = 0; i < allPitches.length; i++) {\r\n                            const pitch: number = allPitches[i];\r\n                            const pitchIndex: number = recentPitches.indexOf(pitch);\r\n                            if (pitchIndex == -1) {\r\n                                let interval: number = 0;\r\n                                let pitchIter: number = lastPitch;\r\n                                if (pitchIter < pitch) {\r\n                                    while (pitchIter != pitch) {\r\n                                        pitchIter++;\r\n                                        if (recentPitches.indexOf(pitchIter) == -1) interval++;\r\n                                    }\r\n                                } else {\r\n                                    while (pitchIter != pitch) {\r\n                                        pitchIter--;\r\n                                        if (recentPitches.indexOf(pitchIter) == -1) interval--;\r\n                                    }\r\n                                }\r\n                                bits.write(1, 0);\r\n                                bits.writePitchInterval(interval);\r\n                            } else {\r\n                                bits.write(1, 1);\r\n                                bits.write(4, pitchIndex);\r\n                                recentPitches.splice(pitchIndex, 1);\r\n                            }\r\n                            recentPitches.unshift(pitch);\r\n                            if (recentPitches.length > 16) recentPitches.pop();\r\n\r\n                            if (i == note.pitches.length - 1) {\r\n                                lastPitch = note.pitches[0];\r\n                            } else {\r\n                                lastPitch = pitch;\r\n                            }\r\n                        }\r\n\r\n                        if (note.start == 0) {\r\n                            bits.write(1, note.continuesLastPattern ? 1 : 0);\r\n                        }\r\n\r\n                        curPart = note.end;\r\n                    }\r\n\r\n                    if (curPart < this.beatsPerBar * Config.partsPerBeat + (+isModChannel)) {\r\n                        bits.write(2, 0); // rest\r\n                        if (isModChannel) bits.write(1, 0); // positive offset\r\n                        bits.writePartDuration(this.beatsPerBar * Config.partsPerBeat + (+isModChannel) - curPart);\r\n                    }\r\n                } else {\r\n                    bits.write(1, 0);\r\n                }\r\n            }\r\n        }\r\n        let stringLength: number = bits.lengthBase64();\r\n        let digits: number[] = [];\r\n        while (stringLength > 0) {\r\n            digits.unshift(base64IntToCharCode[stringLength & 0x3f]);\r\n            stringLength = stringLength >> 6;\r\n        }\r\n        buffer.push(base64IntToCharCode[digits.length]);\r\n        Array.prototype.push.apply(buffer, digits); // append digits to buffer.\r\n        bits.encodeBase64(buffer);\r\n\r\n        const maxApplyArgs: number = 64000;\r\n        if (buffer.length < maxApplyArgs) {\r\n            // Note: Function.apply may break for long argument lists. \r\n            return String.fromCharCode.apply(null, buffer);\r\n        } else {\r\n            let result: string = \"\";\r\n            for (let i: number = 0; i < buffer.length; i += maxApplyArgs) {\r\n                result += String.fromCharCode.apply(null, buffer.slice(i, i + maxApplyArgs));\r\n            }\r\n            return result;\r\n        }\r\n    }\r\n\r\n    private static _envelopeFromLegacyIndex(legacyIndex: number): Envelope {\r\n        // I swapped the order of \"custom\"/\"steady\", now \"none\"/\"note size\".\r\n        if (legacyIndex == 0) legacyIndex = 1; else if (legacyIndex == 1) legacyIndex = 0;\r\n        return Config.envelopes[clamp(0, Config.envelopes.length, legacyIndex)];\r\n    }\r\n\r\n    public fromBase64String(compressed: string): void {\r\n        if (compressed == null || compressed == \"\") {\r\n            this.initToDefault(true);\r\n            return;\r\n        }\r\n        let charIndex: number = 0;\r\n        // skip whitespace.\r\n        while (compressed.charCodeAt(charIndex) <= CharCode.SPACE) charIndex++;\r\n        // skip hash mark.\r\n        if (compressed.charCodeAt(charIndex) == CharCode.HASH) charIndex++;\r\n        // if it starts with curly brace, treat it as JSON.\r\n        if (compressed.charCodeAt(charIndex) == CharCode.LEFT_CURLY_BRACE) {\r\n            this.fromJsonObject(JSON.parse(charIndex == 0 ? compressed : compressed.substring(charIndex)));\r\n            return;\r\n        }\r\n\r\n        const variantTest: number = compressed.charCodeAt(charIndex);\r\n        let fromBeepBox: boolean;\r\n        let fromJummBox: boolean;\r\n\r\n        // Detect variant here. If version doesn't match known variant, assume it is a vanilla string which does not report variant.\r\n        if (variantTest == 0x6A) { //\"j\"\r\n            fromBeepBox = false;\r\n            fromJummBox = true;\r\n            charIndex++;\r\n        } else {\r\n            fromBeepBox = true;\r\n            fromJummBox = false;\r\n        }\r\n\r\n        const version: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n        if (fromBeepBox && (version == -1 || version > Song._latestBeepboxVersion || version < Song._oldestBeepboxVersion)) return;\r\n        if (fromJummBox && (version == -1 || version > Song._latestJummBoxVersion || version < Song._oldestJummBoxVersion)) return;\r\n        const beforeTwo: boolean = version < 2;\r\n        const beforeThree: boolean = version < 3;\r\n        const beforeFour: boolean = version < 4;\r\n        const beforeFive: boolean = version < 5;\r\n        const beforeSix: boolean = version < 6;\r\n        const beforeSeven: boolean = version < 7;\r\n        const beforeEight: boolean = version < 8;\r\n        const beforeNine: boolean = version < 9;\r\n        this.initToDefault((fromBeepBox && beforeNine) || (fromJummBox && beforeFive));\r\n        const forceSimpleFilter: boolean = (fromBeepBox && beforeNine || fromJummBox && beforeFive);\r\n\r\n        if (beforeThree && fromBeepBox) {\r\n            // Originally, the only instrument transition was \"instant\" and the only drum wave was \"retro\".\r\n            for (const channel of this.channels) {\r\n                channel.instruments[0].transition = Config.transitions.dictionary[\"interrupt\"].index;\r\n                channel.instruments[0].effects |= 1 << EffectType.transition;\r\n            }\r\n            this.channels[3].instruments[0].chipNoise = 0;\r\n        }\r\n\r\n        let legacySettingsCache: LegacySettings[][] | null = null;\r\n        if ((fromBeepBox && beforeNine) || (fromJummBox && beforeFive)) {\r\n            // Unfortunately, old versions of BeepBox had a variety of different ways of saving\r\n            // filter-and-envelope-related parameters in the URL, and none of them directly\r\n            // correspond to the new way of saving these parameters. We can approximate the old\r\n            // settings by collecting all the old settings for an instrument and passing them to\r\n            // convertLegacySettings(), so I use this data structure to collect the settings\r\n            // for each instrument if necessary.\r\n            legacySettingsCache = [];\r\n            for (let i: number = legacySettingsCache.length; i < this.getChannelCount(); i++) {\r\n                legacySettingsCache[i] = [];\r\n                for (let j: number = 0; j < Config.instrumentCountMin; j++) legacySettingsCache[i][j] = {};\r\n            }\r\n        }\r\n\r\n        let legacyGlobalReverb: number = 0; // beforeNine reverb was song-global, record that reverb here and adapt it to instruments as needed.\r\n\r\n        let instrumentChannelIterator: number = 0;\r\n        let instrumentIndexIterator: number = -1;\r\n        let command: number;\r\n        let useSlowerArpSpeed: boolean = false;\r\n        let useFastTwoNoteArp: boolean = false;\r\n        while (charIndex < compressed.length) switch (command = compressed.charCodeAt(charIndex++)) {\r\n            case SongTagCode.songTitle: {\r\n                // Length of song name string\r\n                var songNameLength = (base64CharCodeToInt[compressed.charCodeAt(charIndex++)] << 6) + base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                this.title = decodeURIComponent(compressed.substring(charIndex, charIndex + songNameLength));\r\n                // document.title = this.title + \" - \" + EditorConfig.versionDisplayName;\r\n\r\n                charIndex += songNameLength;\r\n            } break;\r\n            case SongTagCode.channelCount: {\r\n                this.pitchChannelCount = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                this.noiseChannelCount = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                if (fromBeepBox || beforeTwo) {\r\n                    // No mod channel support before jummbox v2\r\n                    this.modChannelCount = 0;\r\n                } else {\r\n                    this.modChannelCount = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                }\r\n                this.pitchChannelCount = validateRange(Config.pitchChannelCountMin, Config.pitchChannelCountMax, this.pitchChannelCount);\r\n                this.noiseChannelCount = validateRange(Config.noiseChannelCountMin, Config.noiseChannelCountMax, this.noiseChannelCount);\r\n                this.modChannelCount = validateRange(Config.modChannelCountMin, Config.modChannelCountMax, this.modChannelCount);\r\n\r\n                for (let channelIndex = this.channels.length; channelIndex < this.getChannelCount(); channelIndex++) {\r\n                    this.channels[channelIndex] = new Channel();\r\n                }\r\n                this.channels.length = this.getChannelCount();\r\n                if ((fromBeepBox && beforeNine) || (fromJummBox && beforeFive)) {\r\n                    for (let i: number = legacySettingsCache!.length; i < this.getChannelCount(); i++) {\r\n                        legacySettingsCache![i] = [];\r\n                        for (let j: number = 0; j < Config.instrumentCountMin; j++) legacySettingsCache![i][j] = {};\r\n                    }\r\n                }\r\n            } break;\r\n            case SongTagCode.scale: {\r\n                this.scale = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                // All the scales were jumbled around by Jummbox. Just convert to free.\r\n                if (fromBeepBox) this.scale = 0;\r\n            } break;\r\n            case SongTagCode.key: {\r\n                if (beforeSeven && fromBeepBox) {\r\n                    this.key = clamp(0, Config.keys.length, 11 - base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                } else {\r\n                    this.key = clamp(0, Config.keys.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                }\r\n            } break;\r\n            case SongTagCode.loopStart: {\r\n                if (beforeFive && fromBeepBox) {\r\n                    this.loopStart = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                } else {\r\n                    this.loopStart = (base64CharCodeToInt[compressed.charCodeAt(charIndex++)] << 6) + base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                }\r\n            } break;\r\n            case SongTagCode.loopEnd: {\r\n                if (beforeFive && fromBeepBox) {\r\n                    this.loopLength = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                } else {\r\n                    this.loopLength = (base64CharCodeToInt[compressed.charCodeAt(charIndex++)] << 6) + base64CharCodeToInt[compressed.charCodeAt(charIndex++)] + 1;\r\n                }\r\n            } break;\r\n            case SongTagCode.tempo: {\r\n                if (beforeFour && fromBeepBox) {\r\n                    this.tempo = [95, 120, 151, 190][base64CharCodeToInt[compressed.charCodeAt(charIndex++)]];\r\n                } else if (beforeSeven && fromBeepBox) {\r\n                    this.tempo = [88, 95, 103, 111, 120, 130, 140, 151, 163, 176, 190, 206, 222, 240, 259][base64CharCodeToInt[compressed.charCodeAt(charIndex++)]];\r\n                } else {\r\n                    this.tempo = (base64CharCodeToInt[compressed.charCodeAt(charIndex++)] << 6) | (base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                }\r\n                this.tempo = clamp(Config.tempoMin, Config.tempoMax + 1, this.tempo);\r\n            } break;\r\n            case SongTagCode.reverb: {\r\n                if (beforeNine && fromBeepBox) {\r\n                    legacyGlobalReverb = base64CharCodeToInt[compressed.charCodeAt(charIndex++)] * 12;\r\n                    legacyGlobalReverb = clamp(0, Config.reverbRange, legacyGlobalReverb);\r\n                } else if (beforeFive && fromJummBox) {\r\n                    legacyGlobalReverb = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                    legacyGlobalReverb = clamp(0, Config.reverbRange, legacyGlobalReverb);\r\n                } else {\r\n                    // Do nothing, BeepBox v9+ do not support song-wide reverb - JummBox still does via modulator.\r\n                }\r\n            } break;\r\n            case SongTagCode.beatCount: {\r\n                if (beforeThree && fromBeepBox) {\r\n                    this.beatsPerBar = [6, 7, 8, 9, 10][base64CharCodeToInt[compressed.charCodeAt(charIndex++)]];\r\n                } else {\r\n                    this.beatsPerBar = base64CharCodeToInt[compressed.charCodeAt(charIndex++)] + 1;\r\n                }\r\n                this.beatsPerBar = Math.max(Config.beatsPerBarMin, Math.min(Config.beatsPerBarMax, this.beatsPerBar));\r\n            } break;\r\n            case SongTagCode.barCount: {\r\n                const barCount: number = (base64CharCodeToInt[compressed.charCodeAt(charIndex++)] << 6) + base64CharCodeToInt[compressed.charCodeAt(charIndex++)] + 1;\r\n                this.barCount = validateRange(Config.barCountMin, Config.barCountMax, barCount);\r\n                for (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n                    for (let bar = this.channels[channelIndex].bars.length; bar < this.barCount; bar++) {\r\n                        this.channels[channelIndex].bars[bar] = (bar < 4) ? 1 : 0;\r\n                    }\r\n                    this.channels[channelIndex].bars.length = this.barCount;\r\n                }\r\n            } break;\r\n            case SongTagCode.patternCount: {\r\n                let patternsPerChannel: number;\r\n                if (beforeEight && fromBeepBox) {\r\n                    patternsPerChannel = base64CharCodeToInt[compressed.charCodeAt(charIndex++)] + 1;\r\n                } else {\r\n                    patternsPerChannel = (base64CharCodeToInt[compressed.charCodeAt(charIndex++)] << 6) + base64CharCodeToInt[compressed.charCodeAt(charIndex++)] + 1;\r\n                }\r\n                this.patternsPerChannel = validateRange(1, Config.barCountMax, patternsPerChannel);\r\n                const channelCount: number = this.getChannelCount();\r\n                for (let channelIndex: number = 0; channelIndex < channelCount; channelIndex++) {\r\n                    const patterns: Pattern[] = this.channels[channelIndex].patterns;\r\n                    for (let pattern = patterns.length; pattern < this.patternsPerChannel; pattern++) {\r\n                        patterns[pattern] = new Pattern();\r\n                    }\r\n                    patterns.length = this.patternsPerChannel;\r\n                }\r\n            } break;\r\n            case SongTagCode.instrumentCount: {\r\n                if ((beforeNine && fromBeepBox) || (beforeFive && fromJummBox)) {\r\n                    const instrumentsPerChannel: number = validateRange(Config.instrumentCountMin, Config.patternInstrumentCountMax, base64CharCodeToInt[compressed.charCodeAt(charIndex++)] + Config.instrumentCountMin);\r\n                    this.layeredInstruments = false;\r\n                    this.patternInstruments = (instrumentsPerChannel > 1);\r\n\r\n                    for (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n                        const isNoiseChannel: boolean = channelIndex >= this.pitchChannelCount && channelIndex < this.pitchChannelCount + this.noiseChannelCount;\r\n                        const isModChannel: boolean = channelIndex >= this.pitchChannelCount + this.noiseChannelCount;\r\n\r\n                        for (let instrumentIndex: number = this.channels[channelIndex].instruments.length; instrumentIndex < instrumentsPerChannel; instrumentIndex++) {\r\n                            this.channels[channelIndex].instruments[instrumentIndex] = new Instrument(isNoiseChannel, isModChannel);\r\n                        }\r\n                        this.channels[channelIndex].instruments.length = instrumentsPerChannel;\r\n                        if (beforeSix && fromBeepBox) {\r\n                            for (let instrumentIndex: number = 0; instrumentIndex < instrumentsPerChannel; instrumentIndex++) {\r\n                                this.channels[channelIndex].instruments[instrumentIndex].setTypeAndReset(isNoiseChannel ? InstrumentType.noise : InstrumentType.chip, isNoiseChannel, isModChannel);\r\n                            }\r\n                        }\r\n\r\n                        for (let j: number = legacySettingsCache![channelIndex].length; j < instrumentsPerChannel; j++) {\r\n                            legacySettingsCache![channelIndex][j] = {};\r\n                        }\r\n                    }\r\n                } else {\r\n                    const instrumentsFlagBits: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                    this.layeredInstruments = (instrumentsFlagBits & (1 << 1)) != 0;\r\n                    this.patternInstruments = (instrumentsFlagBits & (1 << 0)) != 0;\r\n                    for (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n                        let instrumentCount: number = 1;\r\n                        if (this.layeredInstruments || this.patternInstruments) {\r\n                            instrumentCount = validateRange(Config.instrumentCountMin, this.getMaxInstrumentsPerChannel(), base64CharCodeToInt[compressed.charCodeAt(charIndex++)] + Config.instrumentCountMin);\r\n                        }\r\n                        const channel: Channel = this.channels[channelIndex];\r\n                        const isNoiseChannel: boolean = this.getChannelIsNoise(channelIndex);\r\n                        const isModChannel: boolean = this.getChannelIsMod(channelIndex);\r\n                        for (let i: number = channel.instruments.length; i < instrumentCount; i++) {\r\n                            channel.instruments[i] = new Instrument(isNoiseChannel, isModChannel);\r\n                        }\r\n                        channel.instruments.length = instrumentCount;\r\n                    }\r\n                }\r\n            } break;\r\n            case SongTagCode.rhythm: {\r\n                this.rhythm = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                // Port all arpeggio speeds over to match what they were, before arpeggio speed was decoupled from rhythm.\r\n                if (fromJummBox && beforeThree || fromBeepBox) {\r\n                    // These are all the rhythms that had 4 ticks/arpeggio instead of 3.\r\n                    if (this.rhythm == Config.rhythms.dictionary[\"÷3 (triplets)\"].index || this.rhythm == Config.rhythms.dictionary[\"÷6\"].index) {\r\n                        useSlowerArpSpeed = true;\r\n                    }\r\n                    // Use faster two note arp on these rhythms\r\n                    if (this.rhythm >= Config.rhythms.dictionary[\"÷6\"].index) {\r\n                        useFastTwoNoteArp = true;\r\n                    }\r\n                }\r\n            } break;\r\n            case SongTagCode.channelOctave: {\r\n                if (beforeThree && fromBeepBox) {\r\n                    const channelIndex: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                    this.channels[channelIndex].octave = clamp(0, Config.pitchOctaves, base64CharCodeToInt[compressed.charCodeAt(charIndex++)] + 1);\r\n                    if (channelIndex >= this.pitchChannelCount) this.channels[channelIndex].octave = 0;\r\n                } else if ((beforeNine && fromBeepBox) || (beforeFive && fromJummBox)) {\r\n                    for (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n                        this.channels[channelIndex].octave = clamp(0, Config.pitchOctaves, base64CharCodeToInt[compressed.charCodeAt(charIndex++)] + 1);\r\n                        if (channelIndex >= this.pitchChannelCount) this.channels[channelIndex].octave = 0;\r\n                    }\r\n                } else {\r\n                    for (let channelIndex: number = 0; channelIndex < this.pitchChannelCount; channelIndex++) {\r\n                        this.channels[channelIndex].octave = clamp(0, Config.pitchOctaves, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                    }\r\n                    for (let channelIndex: number = this.pitchChannelCount; channelIndex < this.getChannelCount(); channelIndex++) {\r\n                        this.channels[channelIndex].octave = 0;\r\n                    }\r\n                }\r\n            } break;\r\n            case SongTagCode.startInstrument: {\r\n                instrumentIndexIterator++;\r\n                if (instrumentIndexIterator >= this.channels[instrumentChannelIterator].instruments.length) {\r\n                    instrumentChannelIterator++;\r\n                    instrumentIndexIterator = 0;\r\n                }\r\n                validateRange(0, this.channels.length - 1, instrumentChannelIterator);\r\n                const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                // JB before v5 had custom chip in the place where pickedString is now, and mod one sooner as well. New index is +1 for both.\r\n                let instrumentType: number = validateRange(0, InstrumentType.length - 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                if (fromJummBox && beforeFive) {\r\n                    if (instrumentType == InstrumentType.pickedString) {\r\n                        instrumentType = InstrumentType.customChipWave;\r\n                    }\r\n                    else if (instrumentType == InstrumentType.customChipWave) {\r\n                        instrumentType = InstrumentType.mod;\r\n                    }\r\n                }\r\n                instrument.setTypeAndReset(instrumentType, instrumentChannelIterator >= this.pitchChannelCount && instrumentChannelIterator < this.pitchChannelCount + this.noiseChannelCount, instrumentChannelIterator >= this.pitchChannelCount + this.noiseChannelCount);\r\n\r\n                // Anti-aliasing was added in BeepBox 3.0 (v6->v7) and JummBox 1.3 (v1->v2 roughly but some leakage possible)\r\n                if (((beforeSeven && fromBeepBox) || (beforeTwo && fromJummBox)) && (instrumentType == InstrumentType.chip || instrumentType == InstrumentType.customChipWave || instrumentType == InstrumentType.pwm)) {\r\n                    instrument.aliases = true;\r\n                    instrument.distortion = 0;\r\n                    instrument.effects |= 1 << EffectType.distortion;\r\n                }\r\n                if (useSlowerArpSpeed) {\r\n                    instrument.arpeggioSpeed = 9; // x3/4 speed. This used to be tied to rhythm, but now it is decoupled to each instrument's arp speed slider. This flag gets set when importing older songs to keep things consistent.\r\n                }\r\n                if (useFastTwoNoteArp) {\r\n                    instrument.fastTwoNoteArp = true;\r\n                }\r\n\r\n                if (beforeSeven && fromBeepBox) {\r\n                    instrument.effects = 0;\r\n                    // Chip/noise instruments had arpeggio and FM had custom interval but neither\r\n                    // explicitly saved the chorus setting beforeSeven so enable it here.\r\n                    if (instrument.chord != Config.chords.dictionary[\"simultaneous\"].index) {\r\n                        // Enable chord if it was used.\r\n                        instrument.effects |= 1 << EffectType.chord;\r\n                    }\r\n                }\r\n            } break;\r\n            case SongTagCode.preset: {\r\n                const presetValue: number = (base64CharCodeToInt[compressed.charCodeAt(charIndex++)] << 6) | (base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].preset = presetValue;\r\n                // Picked string was inserted before custom chip in JB v5, so bump up preset index.\r\n                if (fromJummBox && beforeFive) {\r\n                    if (this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].preset == InstrumentType.pickedString) {\r\n                        this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].preset = InstrumentType.customChipWave;\r\n                    }\r\n                }\r\n            } break;\r\n            case SongTagCode.wave: {\r\n                if (beforeThree && fromBeepBox) {\r\n                    const legacyWaves: number[] = [1, 2, 3, 4, 5, 6, 7, 8, 0];\r\n                    const channelIndex: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                    const instrument: Instrument = this.channels[channelIndex].instruments[0];\r\n                    instrument.chipWave = clamp(0, Config.chipWaves.length, legacyWaves[base64CharCodeToInt[compressed.charCodeAt(charIndex++)]] | 0);\r\n\r\n                    // Version 2 didn't save any settings for settings for filters, or envelopes,\r\n                    // just waves, so initialize them here I guess.\r\n                    instrument.convertLegacySettings(legacySettingsCache![channelIndex][0], forceSimpleFilter);\r\n\r\n                } else if (beforeSix && fromBeepBox) {\r\n                    const legacyWaves: number[] = [1, 2, 3, 4, 5, 6, 7, 8, 0];\r\n                    for (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n                        for (const instrument of this.channels[channelIndex].instruments) {\r\n                            if (channelIndex >= this.pitchChannelCount) {\r\n                                instrument.chipNoise = clamp(0, Config.chipNoises.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                            } else {\r\n                                instrument.chipWave = clamp(0, Config.chipWaves.length, legacyWaves[base64CharCodeToInt[compressed.charCodeAt(charIndex++)]] | 0);\r\n                            }\r\n                        }\r\n                    }\r\n                } else if (beforeSeven && fromBeepBox) {\r\n                    const legacyWaves: number[] = [1, 2, 3, 4, 5, 6, 7, 8, 0];\r\n                    if (instrumentChannelIterator >= this.pitchChannelCount) {\r\n                        this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].chipNoise = clamp(0, Config.chipNoises.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                    } else {\r\n                        this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].chipWave = clamp(0, Config.chipWaves.length, legacyWaves[base64CharCodeToInt[compressed.charCodeAt(charIndex++)]] | 0);\r\n                    }\r\n                } else {\r\n                    if (instrumentChannelIterator >= this.pitchChannelCount) {\r\n                        this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].chipNoise = clamp(0, Config.chipNoises.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                    } else {\r\n                        this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].chipWave = clamp(0, Config.chipWaves.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                    }\r\n                }\r\n            } break;\r\n            case SongTagCode.eqFilter: {\r\n                if ((beforeNine && fromBeepBox) || (beforeFive && fromJummBox)) {\r\n                    if (beforeSeven && fromBeepBox) {\r\n                        const legacyToCutoff: number[] = [10, 6, 3, 0, 8, 5, 2];\r\n                        const legacyToEnvelope: string[] = [\"none\", \"none\", \"none\", \"none\", \"decay 1\", \"decay 2\", \"decay 3\"];\r\n\r\n                        if (beforeThree && fromBeepBox) {\r\n                            const channelIndex: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                            const instrument: Instrument = this.channels[channelIndex].instruments[0];\r\n                            const legacySettings: LegacySettings = legacySettingsCache![channelIndex][0];\r\n                            const legacyFilter: number = [1, 3, 4, 5][clamp(0, legacyToCutoff.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)])];\r\n                            legacySettings.filterCutoff = legacyToCutoff[legacyFilter];\r\n                            legacySettings.filterResonance = 0;\r\n                            legacySettings.filterEnvelope = Config.envelopes.dictionary[legacyToEnvelope[legacyFilter]];\r\n                            instrument.convertLegacySettings(legacySettings, forceSimpleFilter);\r\n                        } else if (beforeSix && fromBeepBox) {\r\n                            for (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n                                for (let i: number = 0; i < this.channels[channelIndex].instruments.length; i++) {\r\n                                    const instrument: Instrument = this.channels[channelIndex].instruments[i];\r\n                                    const legacySettings: LegacySettings = legacySettingsCache![channelIndex][i];\r\n                                    const legacyFilter: number = clamp(0, legacyToCutoff.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)] + 1);\r\n                                    if (channelIndex < this.pitchChannelCount) {\r\n                                        legacySettings.filterCutoff = legacyToCutoff[legacyFilter];\r\n                                        legacySettings.filterResonance = 0;\r\n                                        legacySettings.filterEnvelope = Config.envelopes.dictionary[legacyToEnvelope[legacyFilter]];\r\n                                    } else {\r\n                                        legacySettings.filterCutoff = 10;\r\n                                        legacySettings.filterResonance = 0;\r\n                                        legacySettings.filterEnvelope = Config.envelopes.dictionary[\"none\"];\r\n                                    }\r\n                                    instrument.convertLegacySettings(legacySettings, forceSimpleFilter);\r\n                                }\r\n                            }\r\n                        } else {\r\n                            const legacyFilter: number = clamp(0, legacyToCutoff.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                            const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                            const legacySettings: LegacySettings = legacySettingsCache![instrumentChannelIterator][instrumentIndexIterator];\r\n                            legacySettings.filterCutoff = legacyToCutoff[legacyFilter];\r\n                            legacySettings.filterResonance = 0;\r\n                            legacySettings.filterEnvelope = Config.envelopes.dictionary[legacyToEnvelope[legacyFilter]];\r\n                            instrument.convertLegacySettings(legacySettings, forceSimpleFilter);\r\n                        }\r\n                    } else {\r\n                        const filterCutoffRange: number = 11;\r\n                        const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                        const legacySettings: LegacySettings = legacySettingsCache![instrumentChannelIterator][instrumentIndexIterator];\r\n                        legacySettings.filterCutoff = clamp(0, filterCutoffRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                        instrument.convertLegacySettings(legacySettings, forceSimpleFilter);\r\n                    }\r\n                } else {\r\n                    const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                    let typeCheck: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\r\n                    if (fromBeepBox || typeCheck == 0) {\r\n                        instrument.eqFilterType = false;\r\n                        if (fromJummBox)\r\n                            typeCheck = base64CharCodeToInt[compressed.charCodeAt(charIndex++)]; // Skip to next to get control point count\r\n                        const originalControlPointCount: number = typeCheck;\r\n                        instrument.eqFilter.controlPointCount = clamp(0, Config.filterMaxPoints + 1, originalControlPointCount);\r\n                        for (let i: number = instrument.eqFilter.controlPoints.length; i < instrument.eqFilter.controlPointCount; i++) {\r\n                            instrument.eqFilter.controlPoints[i] = new FilterControlPoint();\r\n                        }\r\n                        for (let i: number = 0; i < instrument.eqFilter.controlPointCount; i++) {\r\n                            const point: FilterControlPoint = instrument.eqFilter.controlPoints[i];\r\n                            point.type = clamp(0, FilterType.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                            point.freq = clamp(0, Config.filterFreqRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                            point.gain = clamp(0, Config.filterGainRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                        }\r\n                        for (let i: number = instrument.eqFilter.controlPointCount; i < originalControlPointCount; i++) {\r\n                            charIndex += 3;\r\n                        }\r\n\r\n                        // Get subfilters as well. Skip Index 0, is a copy of the base filter.\r\n                        instrument.eqSubFilters[0] = instrument.eqFilter;\r\n                        if (fromJummBox && !beforeFive) {\r\n                            let usingSubFilterBitfield: number = (base64CharCodeToInt[compressed.charCodeAt(charIndex++)] << 6) | (base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                            for (let j: number = 0; j < Config.filterMorphCount - 1; j++) {\r\n                                if (usingSubFilterBitfield & (1 << j)) {\r\n                                    // Number of control points\r\n                                    const originalSubfilterControlPointCount: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                                    if (instrument.eqSubFilters[j + 1] == null)\r\n                                        instrument.eqSubFilters[j + 1] = new FilterSettings();\r\n                                    instrument.eqSubFilters[j + 1]!.controlPointCount = clamp(0, Config.filterMaxPoints + 1, originalSubfilterControlPointCount);\r\n                                    for (let i: number = instrument.eqSubFilters[j + 1]!.controlPoints.length; i < instrument.eqSubFilters[j + 1]!.controlPointCount; i++) {\r\n                                        instrument.eqSubFilters[j + 1]!.controlPoints[i] = new FilterControlPoint();\r\n                                    }\r\n                                    for (let i: number = 0; i < instrument.eqSubFilters[j + 1]!.controlPointCount; i++) {\r\n                                        const point: FilterControlPoint = instrument.eqSubFilters[j + 1]!.controlPoints[i];\r\n                                        point.type = clamp(0, FilterType.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                                        point.freq = clamp(0, Config.filterFreqRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                                        point.gain = clamp(0, Config.filterGainRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                                    }\r\n                                    for (let i: number = instrument.eqSubFilters[j + 1]!.controlPointCount; i < originalSubfilterControlPointCount; i++) {\r\n                                        charIndex += 3;\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                    else {\r\n                        instrument.eqFilterType = true;\r\n                        instrument.eqFilterSimpleCut = clamp(0, Config.filterSimpleCutRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                        instrument.eqFilterSimplePeak = clamp(0, Config.filterSimplePeakRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                    }\r\n                }\r\n            } break;\r\n            case SongTagCode.filterResonance: {\r\n                if ((beforeNine && fromBeepBox) || (beforeFive && fromJummBox)) {\r\n                    const filterResonanceRange: number = 8;\r\n                    const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                    const legacySettings: LegacySettings = legacySettingsCache![instrumentChannelIterator][instrumentIndexIterator];\r\n                    legacySettings.filterResonance = clamp(0, filterResonanceRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                    instrument.convertLegacySettings(legacySettings, forceSimpleFilter);\r\n\r\n                } else {\r\n                    // Do nothing? This song tag code is deprecated for now.\r\n                }\r\n            } break;\r\n            case SongTagCode.drumsetEnvelopes: {\r\n                const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                if ((beforeNine && fromBeepBox) || (beforeFive && fromJummBox)) {\r\n                    if (instrument.type == InstrumentType.drumset) {\r\n                        for (let i: number = 0; i < Config.drumCount; i++) {\r\n                            instrument.drumsetEnvelopes[i] = Song._envelopeFromLegacyIndex(base64CharCodeToInt[compressed.charCodeAt(charIndex++)]).index;\r\n                        }\r\n                    } else {\r\n                        // This used to be used for general filter envelopes.\r\n                        // The presence of an envelope affects how convertLegacySettings\r\n                        // decides the closest possible approximation, so update it.\r\n                        const legacySettings: LegacySettings = legacySettingsCache![instrumentChannelIterator][instrumentIndexIterator];\r\n                        legacySettings.filterEnvelope = Song._envelopeFromLegacyIndex(base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                        instrument.convertLegacySettings(legacySettings, forceSimpleFilter);\r\n                    }\r\n                } else {\r\n                    // This tag is now only used for drumset filter envelopes.\r\n                    for (let i: number = 0; i < Config.drumCount; i++) {\r\n                        instrument.drumsetEnvelopes[i] = clamp(0, Config.envelopes.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                    }\r\n                }\r\n            } break;\r\n            case SongTagCode.pulseWidth: {\r\n                const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                instrument.pulseWidth = clamp(0, Config.pulseWidthRange + (+(fromJummBox)), base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                if (fromBeepBox) {\r\n                    // BeepBox formula\r\n                    instrument.pulseWidth = Math.round(Math.pow(0.5, (7 - instrument.pulseWidth) * Config.pulseWidthStepPower) * Config.pulseWidthRange);\r\n\r\n                }\r\n\r\n                if ((beforeNine && fromBeepBox) || (beforeFive && fromJummBox)) {\r\n                    const legacySettings: LegacySettings = legacySettingsCache![instrumentChannelIterator][instrumentIndexIterator];\r\n                    legacySettings.pulseEnvelope = Song._envelopeFromLegacyIndex(base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                    instrument.convertLegacySettings(legacySettings, forceSimpleFilter);\r\n                }\r\n            } break;\r\n            case SongTagCode.stringSustain: {\r\n                const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                instrument.stringSustain = clamp(0, Config.stringSustainRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n            } break;\r\n            case SongTagCode.fadeInOut: {\r\n                if ((beforeNine && fromBeepBox) || (beforeFive && fromJummBox)) {\r\n                    // this tag was used for a combination of transition and fade in/out.\r\n                    const legacySettings = [\r\n                        { transition: \"interrupt\", fadeInSeconds: 0.0, fadeOutTicks: -1 },\r\n                        { transition: \"normal\", fadeInSeconds: 0.0, fadeOutTicks: -3 },\r\n                        { transition: \"normal\", fadeInSeconds: 0.025, fadeOutTicks: -3 },\r\n                        { transition: \"slide in pattern\", fadeInSeconds: 0.025, fadeOutTicks: -3 },\r\n                        { transition: \"normal\", fadeInSeconds: 0.04, fadeOutTicks: 6 },\r\n                        { transition: \"normal\", fadeInSeconds: 0.0, fadeOutTicks: 48 },\r\n                        { transition: \"normal\", fadeInSeconds: 0.0125, fadeOutTicks: 72 },\r\n                        { transition: \"normal\", fadeInSeconds: 0.06, fadeOutTicks: 96 },\r\n                    ];\r\n                    if (beforeThree && fromBeepBox) {\r\n                        const channelIndex: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                        const settings = legacySettings[clamp(0, legacySettings.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)])];\r\n                        const instrument: Instrument = this.channels[channelIndex].instruments[0];\r\n                        instrument.fadeIn = Synth.secondsToFadeInSetting(settings.fadeInSeconds);\r\n                        instrument.fadeOut = Synth.ticksToFadeOutSetting(settings.fadeOutTicks);\r\n                        instrument.transition = Config.transitions.dictionary[settings.transition].index;\r\n                        if (instrument.transition != Config.transitions.dictionary[\"normal\"].index) {\r\n                            // Enable transition if it was used.\r\n                            instrument.effects |= 1 << EffectType.transition;\r\n                        }\r\n                    } else if (beforeSix && fromBeepBox) {\r\n                        for (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n                            for (const instrument of this.channels[channelIndex].instruments) {\r\n                                const settings = legacySettings[clamp(0, legacySettings.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)])];\r\n                                instrument.fadeIn = Synth.secondsToFadeInSetting(settings.fadeInSeconds);\r\n                                instrument.fadeOut = Synth.ticksToFadeOutSetting(settings.fadeOutTicks);\r\n                                instrument.transition = Config.transitions.dictionary[settings.transition].index;\r\n                                if (instrument.transition != Config.transitions.dictionary[\"normal\"].index) {\r\n                                    // Enable transition if it was used.\r\n                                    instrument.effects |= 1 << EffectType.transition;\r\n                                }\r\n                            }\r\n                        }\r\n                    } else if (beforeFour || fromBeepBox) {\r\n                        const settings = legacySettings[clamp(0, legacySettings.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)])];\r\n                        const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                        instrument.fadeIn = Synth.secondsToFadeInSetting(settings.fadeInSeconds);\r\n                        instrument.fadeOut = Synth.ticksToFadeOutSetting(settings.fadeOutTicks);\r\n                        instrument.transition = Config.transitions.dictionary[settings.transition].index;\r\n                        if (instrument.transition != Config.transitions.dictionary[\"normal\"].index) {\r\n                            // Enable transition if it was used.\r\n                            instrument.effects |= 1 << EffectType.transition;\r\n                        }\r\n                    } else {\r\n                        const settings = legacySettings[clamp(0, legacySettings.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)])];\r\n                        const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                        instrument.fadeIn = Synth.secondsToFadeInSetting(settings.fadeInSeconds);\r\n                        instrument.fadeOut = Synth.ticksToFadeOutSetting(settings.fadeOutTicks);\r\n                        instrument.transition = Config.transitions.dictionary[settings.transition].index;\r\n\r\n                        // Read tie-note \r\n                        if (base64CharCodeToInt[compressed.charCodeAt(charIndex++)] > 0) {\r\n                            // Set legacy tie over flag, which is only used to port notes in patterns using this instrument as tying.\r\n                            instrument.legacyTieOver = true;\r\n\r\n                        }\r\n                        instrument.clicklessTransition = base64CharCodeToInt[compressed.charCodeAt(charIndex++)] ? true : false;\r\n\r\n                        if (instrument.transition != Config.transitions.dictionary[\"normal\"].index || instrument.clicklessTransition) {\r\n                            // Enable transition if it was used.\r\n                            instrument.effects |= 1 << EffectType.transition;\r\n                        }\r\n                    }\r\n                } else {\r\n                    const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                    instrument.fadeIn = clamp(0, Config.fadeInRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                    instrument.fadeOut = clamp(0, Config.fadeOutTicks.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                    if (fromJummBox)\r\n                        instrument.clicklessTransition = base64CharCodeToInt[compressed.charCodeAt(charIndex++)] ? true : false;\r\n                }\r\n            } break;\r\n            case SongTagCode.vibrato: {\r\n                if ((beforeNine && fromBeepBox) || (beforeFive && fromJummBox)) {\r\n                    if (beforeSeven && fromBeepBox) {\r\n                        if (beforeThree && fromBeepBox) {\r\n                            const legacyEffects: number[] = [0, 3, 2, 0];\r\n                            const legacyEnvelopes: string[] = [\"none\", \"none\", \"none\", \"tremolo2\"];\r\n                            const channelIndex: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                            const effect: number = clamp(0, legacyEffects.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                            const instrument: Instrument = this.channels[channelIndex].instruments[0];\r\n                            const legacySettings: LegacySettings = legacySettingsCache![channelIndex][0];\r\n                            instrument.vibrato = legacyEffects[effect];\r\n                            if (legacySettings.filterEnvelope == undefined || legacySettings.filterEnvelope.type == EnvelopeType.none) {\r\n                                // Imitate the legacy tremolo with a filter envelope.\r\n                                legacySettings.filterEnvelope = Config.envelopes.dictionary[legacyEnvelopes[effect]];\r\n                                instrument.convertLegacySettings(legacySettings, forceSimpleFilter);\r\n                            }\r\n                            if (instrument.vibrato != Config.vibratos.dictionary[\"none\"].index) {\r\n                                // Enable vibrato if it was used.\r\n                                instrument.effects |= 1 << EffectType.vibrato;\r\n                            }\r\n                        } else if (beforeSix && fromBeepBox) {\r\n                            const legacyEffects: number[] = [0, 1, 2, 3, 0, 0];\r\n                            const legacyEnvelopes: string[] = [\"none\", \"none\", \"none\", \"none\", \"tremolo5\", \"tremolo2\"];\r\n                            for (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n                                for (let i: number = 0; i < this.channels[channelIndex].instruments.length; i++) {\r\n                                    const effect: number = clamp(0, legacyEffects.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                                    const instrument: Instrument = this.channels[channelIndex].instruments[i];\r\n                                    const legacySettings: LegacySettings = legacySettingsCache![channelIndex][i];\r\n                                    instrument.vibrato = legacyEffects[effect];\r\n                                    if (legacySettings.filterEnvelope == undefined || legacySettings.filterEnvelope.type == EnvelopeType.none) {\r\n                                        // Imitate the legacy tremolo with a filter envelope.\r\n                                        legacySettings.filterEnvelope = Config.envelopes.dictionary[legacyEnvelopes[effect]];\r\n                                        instrument.convertLegacySettings(legacySettings, forceSimpleFilter);\r\n                                    }\r\n                                    if (instrument.vibrato != Config.vibratos.dictionary[\"none\"].index) {\r\n                                        // Enable vibrato if it was used.\r\n                                        instrument.effects |= 1 << EffectType.vibrato;\r\n                                    }\r\n                                    if ((legacyGlobalReverb != 0 || (fromJummBox && beforeFive)) && !this.getChannelIsNoise(channelIndex)) {\r\n                                        // Enable reverb if it was used globaly before. (Global reverb was added before the effects option so I need to pick somewhere else to initialize instrument reverb, and I picked the vibrato command.)\r\n                                        instrument.effects |= 1 << EffectType.reverb;\r\n                                        instrument.reverb = legacyGlobalReverb;\r\n                                    }\r\n                                }\r\n                            }\r\n                        } else {\r\n                            const legacyEffects: number[] = [0, 1, 2, 3, 0, 0];\r\n                            const legacyEnvelopes: string[] = [\"none\", \"none\", \"none\", \"none\", \"tremolo5\", \"tremolo2\"];\r\n                            const effect: number = clamp(0, legacyEffects.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                            const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                            const legacySettings: LegacySettings = legacySettingsCache![instrumentChannelIterator][instrumentIndexIterator];\r\n                            instrument.vibrato = legacyEffects[effect];\r\n                            if (legacySettings.filterEnvelope == undefined || legacySettings.filterEnvelope.type == EnvelopeType.none) {\r\n                                // Imitate the legacy tremolo with a filter envelope.\r\n                                legacySettings.filterEnvelope = Config.envelopes.dictionary[legacyEnvelopes[effect]];\r\n                                instrument.convertLegacySettings(legacySettings, forceSimpleFilter);\r\n                            }\r\n                            if (instrument.vibrato != Config.vibratos.dictionary[\"none\"].index) {\r\n                                // Enable vibrato if it was used.\r\n                                instrument.effects |= 1 << EffectType.vibrato;\r\n                            }\r\n                            if (legacyGlobalReverb != 0 || (fromJummBox && beforeFive)) {\r\n                                // Enable reverb if it was used globaly before. (Global reverb was added before the effects option so I need to pick somewhere else to initialize instrument reverb, and I picked the vibrato command.)\r\n                                instrument.effects |= 1 << EffectType.reverb;\r\n                                instrument.reverb = legacyGlobalReverb;\r\n                            }\r\n                        }\r\n                    } else {\r\n                        const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                        const vibrato: number = clamp(0, Config.vibratos.length + 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                        instrument.vibrato = vibrato;\r\n                        if (instrument.vibrato != Config.vibratos.dictionary[\"none\"].index) {\r\n                            // Enable vibrato if it was used.\r\n                            instrument.effects |= 1 << EffectType.vibrato;\r\n                        }\r\n                        // Custom vibrato\r\n                        if (vibrato == Config.vibratos.length) {\r\n                            instrument.vibratoDepth = clamp(0, Config.modulators.dictionary[\"vibrato depth\"].maxRawVol + 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]) / 50;\r\n                            instrument.vibratoSpeed = clamp(0, Config.modulators.dictionary[\"vibrato speed\"].maxRawVol + 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                            instrument.vibratoDelay = clamp(0, Config.modulators.dictionary[\"vibrato delay\"].maxRawVol + 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]) / 2;\r\n                            instrument.vibratoType = clamp(0, Config.vibratoTypes.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                            instrument.effects |= 1 << EffectType.vibrato;\r\n                        }\r\n                        // Enforce standard vibrato settings\r\n                        else {\r\n                            instrument.vibratoDepth = Config.vibratos[instrument.vibrato].amplitude;\r\n                            instrument.vibratoSpeed = 10; // Normal speed\r\n                            instrument.vibratoDelay = Config.vibratos[instrument.vibrato].delayTicks / 2;\r\n                            instrument.vibratoType = Config.vibratos[instrument.vibrato].type;\r\n                        }\r\n                    }\r\n                } else {\r\n                    // Do nothing? This song tag code is deprecated for now.\r\n                }\r\n            } break;\r\n            case SongTagCode.arpeggioSpeed: {\r\n                // Deprecated, but supported for legacy purposes\r\n                if (fromJummBox && beforeFive) {\r\n                    const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                    instrument.arpeggioSpeed = clamp(0, Config.modulators.dictionary[\"arp speed\"].maxRawVol + 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                    instrument.fastTwoNoteArp = base64CharCodeToInt[compressed.charCodeAt(charIndex++)] ? true : false; // Two note arp setting piggybacks on this\r\n                }\r\n                else {\r\n                    // Do nothing, deprecated for now\r\n                }\r\n            } break;\r\n            case SongTagCode.unison: {\r\n                if (beforeThree && fromBeepBox) {\r\n                    const channelIndex: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                    this.channels[channelIndex].instruments[0].unison = clamp(0, Config.unisons.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                } else if (beforeSix && fromBeepBox) {\r\n                    for (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n                        for (const instrument of this.channels[channelIndex].instruments) {\r\n                            const originalValue: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                            let unison: number = clamp(0, Config.unisons.length, originalValue);\r\n                            if (originalValue == 8) {\r\n                                // original \"custom harmony\" now maps to \"hum\" and \"custom interval\".\r\n                                unison = 2;\r\n                                instrument.chord = 3;\r\n                            }\r\n                            instrument.unison = unison;\r\n                        }\r\n                    }\r\n                } else if (beforeSeven && fromBeepBox) {\r\n                    const originalValue: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                    let unison: number = clamp(0, Config.unisons.length, originalValue);\r\n                    if (originalValue == 8) {\r\n                        // original \"custom harmony\" now maps to \"hum\" and \"custom interval\".\r\n                        unison = 2;\r\n                        this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].chord = 3;\r\n                    }\r\n                    this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].unison = unison;\r\n                } else {\r\n                    this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].unison = clamp(0, Config.unisons.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                }\r\n            } break;\r\n            case SongTagCode.chord: {\r\n                if ((beforeNine && fromBeepBox) || (beforeFive && fromJummBox)) {\r\n                    const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                    instrument.chord = clamp(0, Config.chords.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                    if (instrument.chord != Config.chords.dictionary[\"simultaneous\"].index) {\r\n                        // Enable chord if it was used.\r\n                        instrument.effects |= 1 << EffectType.chord;\r\n                    }\r\n                } else {\r\n                    // Do nothing? This song tag code is deprecated for now.\r\n                }\r\n            } break;\r\n            case SongTagCode.effects: {\r\n                const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                if ((beforeNine && fromBeepBox) || (beforeFive && fromJummBox)) {\r\n                    instrument.effects = (base64CharCodeToInt[compressed.charCodeAt(charIndex++)] & ((1 << EffectType.length) - 1));\r\n                    if (legacyGlobalReverb == 0 && !(fromJummBox && beforeFive)) {\r\n                        // Disable reverb if legacy song reverb was zero.\r\n                        instrument.effects &= ~(1 << EffectType.reverb);\r\n                    } else if (effectsIncludeReverb(instrument.effects)) {\r\n                        instrument.reverb = legacyGlobalReverb;\r\n                    }\r\n                    // @jummbus - Enabling pan effect on song import no matter what to make it a default.\r\n                    //if (instrument.pan != Config.panCenter) {\r\n                    instrument.effects |= 1 << EffectType.panning;\r\n                    //}\r\n                    if (instrument.vibrato != Config.vibratos.dictionary[\"none\"].index) {\r\n                        // Enable vibrato if it was used.\r\n                        instrument.effects |= 1 << EffectType.vibrato;\r\n                    }\r\n                    if (instrument.detune != Config.detuneCenter) {\r\n                        // Enable detune if it was used.\r\n                        instrument.effects |= 1 << EffectType.detune;\r\n                    }\r\n                    if (instrument.aliases)\r\n                        instrument.effects |= 1 << EffectType.distortion;\r\n                    else\r\n                        instrument.effects &= ~(1 << EffectType.distortion);\r\n\r\n                    // convertLegacySettings may need to force-enable note filter, call\r\n                    // it again here to make sure that this override takes precedence.\r\n                    const legacySettings: LegacySettings = legacySettingsCache![instrumentChannelIterator][instrumentIndexIterator];\r\n                    instrument.convertLegacySettings(legacySettings, forceSimpleFilter);\r\n                } else {\r\n                    // BeepBox currently uses two base64 characters at 6 bits each for a bitfield representing all the enabled effects.\r\n                    if (EffectType.length > 12) throw new Error();\r\n                    instrument.effects = (base64CharCodeToInt[compressed.charCodeAt(charIndex++)] << 6) | (base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\r\n                    if (effectsIncludeNoteFilter(instrument.effects)) {\r\n                        let typeCheck: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                        if (fromBeepBox || typeCheck == 0) {\r\n                            instrument.noteFilterType = false;\r\n                            if (fromJummBox)\r\n                                typeCheck = base64CharCodeToInt[compressed.charCodeAt(charIndex++)]; // Skip to next index in jummbox to get actual count\r\n                            instrument.noteFilter.controlPointCount = clamp(0, Config.filterMaxPoints + 1, typeCheck);\r\n                            for (let i: number = instrument.noteFilter.controlPoints.length; i < instrument.noteFilter.controlPointCount; i++) {\r\n                                instrument.noteFilter.controlPoints[i] = new FilterControlPoint();\r\n                            }\r\n                            for (let i: number = 0; i < instrument.noteFilter.controlPointCount; i++) {\r\n                                const point: FilterControlPoint = instrument.noteFilter.controlPoints[i];\r\n                                point.type = clamp(0, FilterType.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                                point.freq = clamp(0, Config.filterFreqRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                                point.gain = clamp(0, Config.filterGainRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                            }\r\n                            for (let i: number = instrument.noteFilter.controlPointCount; i < typeCheck; i++) {\r\n                                charIndex += 3;\r\n                            }\r\n\r\n                            // Get subfilters as well. Skip Index 0, is a copy of the base filter.\r\n                            instrument.noteSubFilters[0] = instrument.noteFilter;\r\n                            if (fromJummBox && !beforeFive) {\r\n                                let usingSubFilterBitfield: number = (base64CharCodeToInt[compressed.charCodeAt(charIndex++)] << 6) | (base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                                for (let j: number = 0; j < Config.filterMorphCount - 1; j++) {\r\n                                    if (usingSubFilterBitfield & (1 << j)) {\r\n                                        // Number of control points\r\n                                        const originalSubfilterControlPointCount: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                                        if (instrument.noteSubFilters[j + 1] == null)\r\n                                            instrument.noteSubFilters[j + 1] = new FilterSettings();\r\n                                        instrument.noteSubFilters[j + 1]!.controlPointCount = clamp(0, Config.filterMaxPoints + 1, originalSubfilterControlPointCount);\r\n                                        for (let i: number = instrument.noteSubFilters[j + 1]!.controlPoints.length; i < instrument.noteSubFilters[j + 1]!.controlPointCount; i++) {\r\n                                            instrument.noteSubFilters[j + 1]!.controlPoints[i] = new FilterControlPoint();\r\n                                        }\r\n                                        for (let i: number = 0; i < instrument.noteSubFilters[j + 1]!.controlPointCount; i++) {\r\n                                            const point: FilterControlPoint = instrument.noteSubFilters[j + 1]!.controlPoints[i];\r\n                                            point.type = clamp(0, FilterType.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                                            point.freq = clamp(0, Config.filterFreqRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                                            point.gain = clamp(0, Config.filterGainRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                                        }\r\n                                        for (let i: number = instrument.noteSubFilters[j + 1]!.controlPointCount; i < originalSubfilterControlPointCount; i++) {\r\n                                            charIndex += 3;\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                        } else {\r\n                            instrument.noteFilterType = true;\r\n                            instrument.noteFilter.reset();\r\n                            instrument.noteFilterSimpleCut = clamp(0, Config.filterSimpleCutRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                            instrument.noteFilterSimplePeak = clamp(0, Config.filterSimplePeakRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\r\n                        }\r\n                    }\r\n                    if (effectsIncludeTransition(instrument.effects)) {\r\n                        instrument.transition = clamp(0, Config.transitions.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                    }\r\n                    if (effectsIncludeChord(instrument.effects)) {\r\n                        instrument.chord = clamp(0, Config.chords.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                        // Custom arpeggio speed... only in JB, and only if the instrument arpeggiates.\r\n                        if (instrument.chord == Config.chords.dictionary[\"arpeggio\"].index && fromJummBox) {\r\n                            instrument.arpeggioSpeed = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                            instrument.fastTwoNoteArp = (base64CharCodeToInt[compressed.charCodeAt(charIndex++)]) ? true : false;\r\n                        }\r\n                    }\r\n                    if (effectsIncludePitchShift(instrument.effects)) {\r\n                        instrument.pitchShift = clamp(0, Config.pitchShiftRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                    }\r\n                    if (effectsIncludeDetune(instrument.effects)) {\r\n                        if (fromBeepBox) {\r\n                            // Convert from BeepBox's formula\r\n                            instrument.detune = clamp(Config.detuneMin, Config.detuneMax + 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                            instrument.detune = Math.round((instrument.detune - 9) * (Math.abs(instrument.detune - 9) + 1) / 2 + Config.detuneCenter);\r\n                        } else {\r\n                            instrument.detune = clamp(Config.detuneMin, Config.detuneMax + 1, (base64CharCodeToInt[compressed.charCodeAt(charIndex++)] << 6) + base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                        }\r\n                    }\r\n                    if (effectsIncludeVibrato(instrument.effects)) {\r\n                        instrument.vibrato = clamp(0, Config.vibratos.length + 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\r\n                        // Custom vibrato\r\n                        if (instrument.vibrato == Config.vibratos.length && fromJummBox) {\r\n                            instrument.vibratoDepth = clamp(0, Config.modulators.dictionary[\"vibrato depth\"].maxRawVol + 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]) / 25;\r\n                            instrument.vibratoSpeed = clamp(0, Config.modulators.dictionary[\"vibrato speed\"].maxRawVol + 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                            instrument.vibratoDelay = clamp(0, Config.modulators.dictionary[\"vibrato delay\"].maxRawVol + 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                            instrument.vibratoType = clamp(0, Config.vibratoTypes.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                        }\r\n                        // Enforce standard vibrato settings\r\n                        else {\r\n                            instrument.vibratoDepth = Config.vibratos[instrument.vibrato].amplitude;\r\n                            instrument.vibratoSpeed = 10; // Normal speed\r\n                            instrument.vibratoDelay = Config.vibratos[instrument.vibrato].delayTicks / 2;\r\n                            instrument.vibratoType = Config.vibratos[instrument.vibrato].type;\r\n                        }\r\n                    }\r\n                    if (effectsIncludeDistortion(instrument.effects)) {\r\n                        instrument.distortion = clamp(0, Config.distortionRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                        if (fromJummBox && !beforeFive)\r\n                            instrument.aliases = base64CharCodeToInt[compressed.charCodeAt(charIndex++)] ? true : false;\r\n                    }\r\n                    if (effectsIncludeBitcrusher(instrument.effects)) {\r\n                        instrument.bitcrusherFreq = clamp(0, Config.bitcrusherFreqRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                        instrument.bitcrusherQuantization = clamp(0, Config.bitcrusherQuantizationRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                    }\r\n                    if (effectsIncludePanning(instrument.effects)) {\r\n                        if (fromBeepBox) {\r\n                            // Beepbox has a panMax of 8 (9 total positions), Jummbox has a panMax of 100 (101 total positions)\r\n                            instrument.pan = clamp(0, Config.panMax + 1, Math.round(base64CharCodeToInt[compressed.charCodeAt(charIndex++)] * ((Config.panMax) / 8.0)));\r\n                        }\r\n                        else {\r\n                            instrument.pan = clamp(0, Config.panMax + 1, (base64CharCodeToInt[compressed.charCodeAt(charIndex++)] << 6) + base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                        }\r\n\r\n                        // Now, pan delay follows on new versions of jummbox.\r\n                        if (fromJummBox && !beforeTwo)\r\n                            instrument.panDelay = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                    }\r\n                    if (effectsIncludeChorus(instrument.effects)) {\r\n                        if (fromBeepBox) {\r\n                            // BeepBox has 4 chorus values vs. JB's 8\r\n                            instrument.chorus = clamp(0, (Config.chorusRange / 2) + 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]) * 2;\r\n                        }\r\n                        else {\r\n                            instrument.chorus = clamp(0, Config.chorusRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                        }\r\n                    }\r\n                    if (effectsIncludeEcho(instrument.effects)) {\r\n                        instrument.echoSustain = clamp(0, Config.echoSustainRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                        instrument.echoDelay = clamp(0, Config.echoDelayRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                    }\r\n                    if (effectsIncludeReverb(instrument.effects)) {\r\n                        if (fromBeepBox) {\r\n                            instrument.reverb = clamp(0, Config.reverbRange, Math.round(base64CharCodeToInt[compressed.charCodeAt(charIndex++)] * Config.reverbRange / 3.0));\r\n                        } else {\r\n                            instrument.reverb = clamp(0, Config.reverbRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                        }\r\n                    }\r\n                }\r\n                // Clamp the range.\r\n                instrument.effects &= (1 << EffectType.length) - 1;\r\n            } break;\r\n            case SongTagCode.volume: {\r\n                if (beforeThree && fromBeepBox) {\r\n                    const channelIndex: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                    const instrument: Instrument = this.channels[channelIndex].instruments[0];\r\n                    instrument.volume = Math.round(clamp(-Config.volumeRange / 2, 1, -base64CharCodeToInt[compressed.charCodeAt(charIndex++)] * 5.0));\r\n                } else if (beforeSix && fromBeepBox) {\r\n                    for (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n                        for (const instrument of this.channels[channelIndex].instruments) {\r\n                            instrument.volume = Math.round(clamp(-Config.volumeRange / 2, 1, -base64CharCodeToInt[compressed.charCodeAt(charIndex++)] * 5.0));\r\n                        }\r\n                    }\r\n                } else if (beforeSeven && fromBeepBox) {\r\n                    const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                    instrument.volume = Math.round(clamp(-Config.volumeRange / 2, 1, -base64CharCodeToInt[compressed.charCodeAt(charIndex++)] * 5.0));\r\n                } else if (fromBeepBox) {\r\n                    // Beepbox v9's volume range is 0-7 (0 is max, 7 is mute)\r\n                    const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                    instrument.volume = Math.round(clamp(-Config.volumeRange / 2, 1, -base64CharCodeToInt[compressed.charCodeAt(charIndex++)] * 25.0 / 7.0));\r\n                } else {\r\n                    const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                    // Volume is stored in two bytes in jummbox just in case range ever exceeds one byte, e.g. through later waffling on the subject.\r\n                    instrument.volume = Math.round(clamp(-Config.volumeRange / 2, Config.volumeRange / 2 + 1, ((base64CharCodeToInt[compressed.charCodeAt(charIndex++)] << 6) | (base64CharCodeToInt[compressed.charCodeAt(charIndex++)])) - Config.volumeRange / 2));\r\n                }\r\n            } break;\r\n            case SongTagCode.pan: {\r\n                if (beforeNine && fromBeepBox) {\r\n                    // Beepbox has a panMax of 8 (9 total positions), Jummbox has a panMax of 100 (101 total positions)\r\n                    const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                    instrument.pan = clamp(0, Config.panMax + 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)] * ((Config.panMax) / 8.0));\r\n                } else if (beforeFive && fromJummBox) {\r\n                    const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                    instrument.pan = clamp(0, Config.panMax + 1, (base64CharCodeToInt[compressed.charCodeAt(charIndex++)] << 6) + base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                    // Pan delay follows on v3 + v4\r\n                    if (fromJummBox && !beforeThree) {\r\n                        instrument.panDelay = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                    }\r\n                } else {\r\n                    // Do nothing? This song tag code is deprecated for now.\r\n                }\r\n            } break;\r\n            case SongTagCode.detune: {\r\n                const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n\r\n                if (fromJummBox && beforeFive) {\r\n                    // Before jummbox v5, detune was -50 to 50. Now it is 0 to 400\r\n                    instrument.detune = clamp(Config.detuneMin, Config.detuneMax + 1, ((base64CharCodeToInt[compressed.charCodeAt(charIndex++)] << 6) + base64CharCodeToInt[compressed.charCodeAt(charIndex++)]) * 4);\r\n                    instrument.effects |= 1 << EffectType.detune;\r\n                } else {\r\n                    // Now in v5, tag code is deprecated and handled thru detune effects.\r\n                }\r\n            } break;\r\n            case SongTagCode.customChipWave: {\r\n                let instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                // Pop custom wave values\r\n                for (let j: number = 0; j < 64; j++) {\r\n                    instrument.customChipWave[j]\r\n                        = clamp(-24, 25, base64CharCodeToInt[compressed.charCodeAt(charIndex++)] - 24);\r\n                }\r\n\r\n                let sum: number = 0.0;\r\n                for (let i: number = 0; i < instrument.customChipWave.length; i++) {\r\n                    sum += instrument.customChipWave[i];\r\n                }\r\n                const average: number = sum / instrument.customChipWave.length;\r\n\r\n                // Perform the integral on the wave. The chipSynth will perform the derivative to get the original wave back but with antialiasing.\r\n                let cumulative: number = 0;\r\n                let wavePrev: number = 0;\r\n                for (let i: number = 0; i < instrument.customChipWave.length; i++) {\r\n                    cumulative += wavePrev;\r\n                    wavePrev = instrument.customChipWave[i] - average;\r\n                    instrument.customChipWaveIntegral[i] = cumulative;\r\n                }\r\n\r\n                // 65th, last sample is for anti-aliasing\r\n                instrument.customChipWaveIntegral[64] = 0.0;\r\n\r\n            } break;\r\n            case SongTagCode.limiterSettings: {\r\n                let nextValue: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\r\n                // Check if limiter settings are used... if not, restore to default\r\n                if (nextValue == 0x3f) {\r\n                    this.restoreLimiterDefaults();\r\n                }\r\n                else {\r\n                    // Limiter is used, grab values\r\n                    this.compressionRatio = (nextValue < 10 ? nextValue / 10 : (1 + (nextValue - 10) / 60));\r\n                    nextValue = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                    this.limitRatio = (nextValue < 10 ? nextValue / 10 : (nextValue - 9));\r\n                    this.limitDecay = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                    this.limitRise = (base64CharCodeToInt[compressed.charCodeAt(charIndex++)] * 250.0) + 2000.0;\r\n                    this.compressionThreshold = base64CharCodeToInt[compressed.charCodeAt(charIndex++)] / 20.0;\r\n                    this.limitThreshold = base64CharCodeToInt[compressed.charCodeAt(charIndex++)] / 20.0;\r\n                    this.masterGain = ((base64CharCodeToInt[compressed.charCodeAt(charIndex++)] << 6) + base64CharCodeToInt[compressed.charCodeAt(charIndex++)]) / 50.0;\r\n                }\r\n            } break;\r\n            case SongTagCode.channelNames: {\r\n                for (let channel: number = 0; channel < this.getChannelCount(); channel++) {\r\n                    // Length of channel name string. Due to some crazy Unicode characters this needs to be 2 bytes...\r\n                    var channelNameLength;\r\n                    if (beforeFour)\r\n                        channelNameLength = base64CharCodeToInt[compressed.charCodeAt(charIndex++)]\r\n                    else\r\n                        channelNameLength = ((base64CharCodeToInt[compressed.charCodeAt(charIndex++)] << 6) + base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                    this.channels[channel].name = decodeURIComponent(compressed.substring(charIndex, charIndex + channelNameLength));\r\n\r\n                    charIndex += channelNameLength;\r\n                }\r\n            } break;\r\n            case SongTagCode.algorithm: {\r\n                const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                instrument.algorithm = clamp(0, Config.algorithms.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                if ((beforeNine && fromBeepBox) || (beforeFive && fromJummBox)) {\r\n                    // The algorithm determines the carrier count, which affects how legacy settings are imported.\r\n                    const legacySettings: LegacySettings = legacySettingsCache![instrumentChannelIterator][instrumentIndexIterator];\r\n                    instrument.convertLegacySettings(legacySettings, forceSimpleFilter);\r\n                }\r\n            } break;\r\n            case SongTagCode.feedbackType: {\r\n                this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].feedbackType = clamp(0, Config.feedbacks.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n            } break;\r\n            case SongTagCode.feedbackAmplitude: {\r\n                this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].feedbackAmplitude = clamp(0, Config.operatorAmplitudeMax + 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n            } break;\r\n            case SongTagCode.feedbackEnvelope: {\r\n                if ((beforeNine && fromBeepBox) || (beforeFive && fromJummBox)) {\r\n                    const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                    const legacySettings: LegacySettings = legacySettingsCache![instrumentChannelIterator][instrumentIndexIterator];\r\n                    legacySettings.feedbackEnvelope = Song._envelopeFromLegacyIndex(base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                    instrument.convertLegacySettings(legacySettings, forceSimpleFilter);\r\n                } else {\r\n                    // Do nothing? This song tag code is deprecated for now.\r\n                }\r\n            } break;\r\n            case SongTagCode.operatorFrequencies: {\r\n                for (let o: number = 0; o < Config.operatorCount; o++) {\r\n                    this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].operators[o].frequency = clamp(0, Config.operatorFrequencies.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                }\r\n            } break;\r\n            case SongTagCode.operatorAmplitudes: {\r\n                for (let o: number = 0; o < Config.operatorCount; o++) {\r\n                    this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].operators[o].amplitude = clamp(0, Config.operatorAmplitudeMax + 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                }\r\n            } break;\r\n            case SongTagCode.envelopes: {\r\n                const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                if ((beforeNine && fromBeepBox) || (beforeFive && fromJummBox)) {\r\n                    const legacySettings: LegacySettings = legacySettingsCache![instrumentChannelIterator][instrumentIndexIterator];\r\n                    legacySettings.operatorEnvelopes = [];\r\n                    for (let o: number = 0; o < Config.operatorCount; o++) {\r\n                        legacySettings.operatorEnvelopes[o] = Song._envelopeFromLegacyIndex(base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                    }\r\n                    instrument.convertLegacySettings(legacySettings, forceSimpleFilter);\r\n                } else {\r\n                    const envelopeCount: number = clamp(0, Config.maxEnvelopeCount + 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                    for (let i: number = 0; i < envelopeCount; i++) {\r\n                        const target: number = clamp(0, Config.instrumentAutomationTargets.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                        let index: number = 0;\r\n                        const maxCount: number = Config.instrumentAutomationTargets[target].maxCount;\r\n                        if (maxCount > 1) {\r\n                            index = clamp(0, maxCount, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                        }\r\n                        const envelope: number = clamp(0, Config.envelopes.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                        instrument.addEnvelope(target, index, envelope);\r\n                    }\r\n                }\r\n            } break;\r\n            case SongTagCode.operatorWaves: {\r\n                const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                for (let o: number = 0; o < Config.operatorCount; o++) {\r\n                    instrument.operators[o].waveform = clamp(0, Config.operatorWaves.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                    // Pulse width follows, if it is a pulse width operator wave\r\n                    if (instrument.operators[o].waveform == 3) {\r\n                        instrument.operators[o].pulseWidth = clamp(0, Config.pwmOperatorWaves.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                    }\r\n                }\r\n            } break;\r\n            case SongTagCode.spectrum: {\r\n                const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                if (instrument.type == InstrumentType.spectrum) {\r\n                    const byteCount: number = Math.ceil(Config.spectrumControlPoints * Config.spectrumControlPointBits / 6)\r\n                    const bits: BitFieldReader = new BitFieldReader(compressed, charIndex, charIndex + byteCount);\r\n                    for (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n                        instrument.spectrumWave.spectrum[i] = bits.read(Config.spectrumControlPointBits);\r\n                    }\r\n                    instrument.spectrumWave.markCustomWaveDirty();\r\n                    charIndex += byteCount;\r\n                } else if (instrument.type == InstrumentType.drumset) {\r\n                    const byteCount: number = Math.ceil(Config.drumCount * Config.spectrumControlPoints * Config.spectrumControlPointBits / 6)\r\n                    const bits: BitFieldReader = new BitFieldReader(compressed, charIndex, charIndex + byteCount);\r\n                    for (let j: number = 0; j < Config.drumCount; j++) {\r\n                        for (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n                            instrument.drumsetSpectrumWaves[j].spectrum[i] = bits.read(Config.spectrumControlPointBits);\r\n                        }\r\n                        instrument.drumsetSpectrumWaves[j].markCustomWaveDirty();\r\n                    }\r\n                    charIndex += byteCount;\r\n                } else {\r\n                    throw new Error(\"Unhandled instrument type for spectrum song tag code.\");\r\n                }\r\n            } break;\r\n            case SongTagCode.harmonics: {\r\n                const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                const byteCount: number = Math.ceil(Config.harmonicsControlPoints * Config.harmonicsControlPointBits / 6)\r\n                const bits: BitFieldReader = new BitFieldReader(compressed, charIndex, charIndex + byteCount);\r\n                for (let i: number = 0; i < Config.harmonicsControlPoints; i++) {\r\n                    instrument.harmonicsWave.harmonics[i] = bits.read(Config.harmonicsControlPointBits);\r\n                }\r\n                instrument.harmonicsWave.markCustomWaveDirty();\r\n                charIndex += byteCount;\r\n            } break;\r\n            case SongTagCode.aliases: {\r\n                if (fromJummBox && beforeFive) {\r\n                    const instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n                    instrument.aliases = (base64CharCodeToInt[compressed.charCodeAt(charIndex++)]) ? true : false;\r\n                    if (instrument.aliases) {\r\n                        instrument.distortion = 0;\r\n                        instrument.effects |= 1 << EffectType.distortion;\r\n                    }\r\n                } else {\r\n                    // Do nothing, deprecated\r\n                }\r\n            }\r\n                break;\r\n            case SongTagCode.bars: {\r\n                let subStringLength: number;\r\n                if (beforeThree && fromBeepBox) {\r\n                    const channelIndex: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                    const barCount: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                    subStringLength = Math.ceil(barCount * 0.5);\r\n                    const bits: BitFieldReader = new BitFieldReader(compressed, charIndex, charIndex + subStringLength);\r\n                    for (let i: number = 0; i < barCount; i++) {\r\n                        this.channels[channelIndex].bars[i] = bits.read(3) + 1;\r\n                    }\r\n                } else if (beforeFive && fromBeepBox) {\r\n                    let neededBits: number = 0;\r\n                    while ((1 << neededBits) < this.patternsPerChannel) neededBits++;\r\n                    subStringLength = Math.ceil(this.getChannelCount() * this.barCount * neededBits / 6);\r\n                    const bits: BitFieldReader = new BitFieldReader(compressed, charIndex, charIndex + subStringLength);\r\n                    for (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n                        for (let i: number = 0; i < this.barCount; i++) {\r\n                            this.channels[channelIndex].bars[i] = bits.read(neededBits) + 1;\r\n                        }\r\n                    }\r\n                } else {\r\n                    let neededBits: number = 0;\r\n                    while ((1 << neededBits) < this.patternsPerChannel + 1) neededBits++;\r\n                    subStringLength = Math.ceil(this.getChannelCount() * this.barCount * neededBits / 6);\r\n                    const bits: BitFieldReader = new BitFieldReader(compressed, charIndex, charIndex + subStringLength);\r\n                    for (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n                        for (let i: number = 0; i < this.barCount; i++) {\r\n                            this.channels[channelIndex].bars[i] = bits.read(neededBits);\r\n                        }\r\n                    }\r\n                }\r\n                charIndex += subStringLength;\r\n            } break;\r\n            case SongTagCode.patterns: {\r\n                let bitStringLength: number = 0;\r\n                let channelIndex: number;\r\n                let largerChords: boolean = !((beforeFour && fromJummBox) || fromBeepBox);\r\n                let recentPitchBitLength: number = (largerChords ? 4 : 3);\r\n                let recentPitchLength: number = (largerChords ? 16 : 8);\r\n                if (beforeThree && fromBeepBox) {\r\n                    channelIndex = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\r\n                    // The old format used the next character to represent the number of patterns in the channel, which is usually eight, the default. \r\n                    charIndex++; //let patternCount: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\r\n                    bitStringLength = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                    bitStringLength = bitStringLength << 6;\r\n                    bitStringLength += base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                } else {\r\n                    channelIndex = 0;\r\n                    let bitStringLengthLength: number = validateRange(1, 4, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n                    while (bitStringLengthLength > 0) {\r\n                        bitStringLength = bitStringLength << 6;\r\n                        bitStringLength += base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n                        bitStringLengthLength--;\r\n                    }\r\n                }\r\n\r\n                const bits: BitFieldReader = new BitFieldReader(compressed, charIndex, charIndex + bitStringLength);\r\n                charIndex += bitStringLength;\r\n\r\n                const bitsPerNoteSize: number = Song.getNeededBits(Config.noteSizeMax);\r\n                let songReverbChannel: number = -1;\r\n                let songReverbInstrument: number = -1;\r\n                let songReverbIndex: number = -1;\r\n\r\n                while (true) {\r\n                    const channel: Channel = this.channels[channelIndex];\r\n                    const isNoiseChannel: boolean = this.getChannelIsNoise(channelIndex);\r\n                    const isModChannel: boolean = this.getChannelIsMod(channelIndex);\r\n\r\n                    const maxInstrumentsPerPattern: number = this.getMaxInstrumentsPerPattern(channelIndex);\r\n                    const neededInstrumentCountBits: number = Song.getNeededBits(maxInstrumentsPerPattern - Config.instrumentCountMin);\r\n\r\n                    const neededInstrumentIndexBits: number = Song.getNeededBits(channel.instruments.length - 1);\r\n\r\n                    // Some info about modulator settings immediately follows in mod channels.\r\n                    if (isModChannel) {\r\n\r\n                        // 2 more indices for 'all' and 'active'\r\n                        const neededModInstrumentIndexBits: number = (beforeFive) ? neededInstrumentIndexBits : Song.getNeededBits(this.getMaxInstrumentsPerChannel() + 2);\r\n\r\n                        for (let instrumentIndex: number = 0; instrumentIndex < channel.instruments.length; instrumentIndex++) {\r\n\r\n                            let instrument: Instrument = channel.instruments[instrumentIndex];\r\n\r\n                            for (let mod: number = 0; mod < Config.modCount; mod++) {\r\n                                // Still using legacy \"mod status\" format, but doing it manually as it's only used in the URL now.\r\n                                // 0 - For pitch/noise\r\n                                // 1 - (used to be For noise, not needed)\r\n                                // 2 - For song\r\n                                // 3 - None\r\n                                let status: number = bits.read(2);\r\n\r\n                                switch (status) {\r\n                                    case 0: // Pitch\r\n                                        instrument.modChannels[mod] = clamp(0, this.pitchChannelCount + this.noiseChannelCount + 1, bits.read(8));\r\n                                        instrument.modInstruments[mod] = clamp(0, this.channels[instrument.modChannels[mod]].instruments.length + 2, bits.read(neededModInstrumentIndexBits));\r\n                                        break;\r\n                                    case 1: // Noise\r\n                                        // Getting a status of 1 means this is legacy mod info. Need to add pitch channel count, as it used to just store noise channel index and not overall channel index\r\n                                        instrument.modChannels[mod] = this.pitchChannelCount + clamp(0, this.noiseChannelCount + 1, bits.read(8));\r\n                                        instrument.modInstruments[mod] = clamp(0, this.channels[instrument.modChannels[mod]].instruments.length + 2, bits.read(neededInstrumentIndexBits));\r\n                                        break;\r\n                                    case 2: // For song\r\n                                        instrument.modChannels[mod] = -1;\r\n                                        break;\r\n                                    case 3: // None\r\n                                        instrument.modChannels[mod] = -2;\r\n                                        break;\r\n                                }\r\n\r\n                                // Mod setting is only used if the status isn't \"none\".\r\n                                if (status != 3) {\r\n                                    instrument.modulators[mod] = bits.read(6);\r\n                                }\r\n\r\n                                if (!beforeFive && (Config.modulators[instrument.modulators[mod]].name == \"eq filter\" || Config.modulators[instrument.modulators[mod]].name == \"note filter\")) {\r\n                                    instrument.modFilterTypes[mod] = bits.read(6);\r\n                                }\r\n\r\n                                if (beforeFive && instrument.modChannels[mod] >= 0) {\r\n                                    let forNoteFilter: boolean = effectsIncludeNoteFilter(this.channels[instrument.modChannels[mod]].instruments[instrument.modInstruments[mod]].effects);\r\n\r\n                                    // For legacy filter cut/peak, need to denote since scaling must be applied\r\n                                    if (instrument.modulators[mod] == 7) {\r\n                                        // Legacy filter cut index\r\n                                        // Check if there is no filter dot on prospective filter. If so, add a low pass at max possible freq.\r\n\r\n                                        if (forNoteFilter) {\r\n                                            instrument.modulators[mod] = Config.modulators.dictionary[\"note filt cut\"].index;\r\n                                        }\r\n                                        else {\r\n                                            instrument.modulators[mod] = Config.modulators.dictionary[\"eq filt cut\"].index;\r\n                                        }\r\n\r\n                                        instrument.modFilterTypes[mod] = 1; // Dot 1 X\r\n\r\n                                    }\r\n                                    else if (instrument.modulators[mod] == 8) {\r\n                                        // Legacy filter peak index\r\n                                        if (forNoteFilter) {\r\n                                            instrument.modulators[mod] = Config.modulators.dictionary[\"note filt peak\"].index;\r\n                                        }\r\n                                        else {\r\n                                            instrument.modulators[mod] = Config.modulators.dictionary[\"eq filt peak\"].index;\r\n                                        }\r\n\r\n                                        instrument.modFilterTypes[mod] = 2; // Dot 1 Y\r\n                                    }\r\n                                }\r\n                                else if (beforeFive) {\r\n                                    // Check for song reverb mod, which must be handled differently now that it is a multiplier\r\n                                    if (instrument.modulators[mod] == Config.modulators.dictionary[\"song reverb\"].index) {\r\n                                        songReverbChannel = channelIndex;\r\n                                        songReverbInstrument = instrumentIndex;\r\n                                        songReverbIndex = mod;\r\n                                    }\r\n                                }\r\n\r\n                                // Based on setting, enable some effects for the modulated instrument. This isn't always set, say if the instrument's pan was right in the center.\r\n                                // Only used on import of old songs, because sometimes an invalid effect can be set in a mod in the new version that is actually unused. In that case,\r\n                                // keeping the mod invalid is better since it preserves the state.\r\n                                if (beforeFive && Config.modulators[instrument.modulators[mod]].associatedEffect != EffectType.length) {\r\n                                    this.channels[instrument.modChannels[mod]].instruments[instrument.modInstruments[mod]].effects |= 1 << Config.modulators[instrument.modulators[mod]].associatedEffect;\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    // Scalar applied to detune mods since its granularity was upped. Could be repurposed later if any other granularity changes occur.\r\n                    const detuneScaleNotes: number[][] = [];\r\n                    for (let j: number = 0; j < channel.instruments.length; j++) {\r\n                        detuneScaleNotes[j] = [];\r\n                        for (let i: number = 0; i < Config.modCount; i++) {\r\n                            detuneScaleNotes[j][Config.modCount - 1 - i] = 1 + 3 * +(beforeFive && fromJummBox && isModChannel && (channel.instruments[j].modulators[i] == Config.modulators.dictionary[\"detune\"].index));\r\n                        }\r\n                    }\r\n                    const octaveOffset: number = (isNoiseChannel || isModChannel) ? 0 : channel.octave * 12;\r\n                    let lastPitch: number = ((isNoiseChannel || isModChannel) ? 4 : octaveOffset);\r\n                    const recentPitches: number[] = isModChannel ? [0, 1, 2, 3, 4, 5] : (isNoiseChannel ? [4, 6, 7, 2, 3, 8, 0, 10] : [0, 7, 12, 19, 24, -5, -12]);\r\n                    const recentShapes: any[] = [];\r\n                    for (let i: number = 0; i < recentPitches.length; i++) {\r\n                        recentPitches[i] += octaveOffset;\r\n                    }\r\n                    for (let i: number = 0; i < this.patternsPerChannel; i++) {\r\n                        const newPattern: Pattern = channel.patterns[i];\r\n\r\n                        if ((beforeNine && fromBeepBox) || (beforeFive && fromJummBox)) {\r\n                            newPattern.instruments[0] = validateRange(0, channel.instruments.length - 1, bits.read(neededInstrumentIndexBits));\r\n                            newPattern.instruments.length = 1;\r\n                        } else {\r\n                            if (this.patternInstruments) {\r\n                                const instrumentCount: number = validateRange(Config.instrumentCountMin, maxInstrumentsPerPattern, bits.read(neededInstrumentCountBits) + Config.instrumentCountMin);\r\n                                for (let j: number = 0; j < instrumentCount; j++) {\r\n                                    newPattern.instruments[j] = validateRange(0, channel.instruments.length - 1 + +(isModChannel) * 2, bits.read(neededInstrumentIndexBits));\r\n                                }\r\n                                newPattern.instruments.length = instrumentCount;\r\n                            } else {\r\n                                newPattern.instruments[0] = 0;\r\n                                newPattern.instruments.length = Config.instrumentCountMin;\r\n                            }\r\n                        }\r\n\r\n                        if (!(fromBeepBox && beforeThree) && bits.read(1) == 0) {\r\n                            newPattern.notes.length = 0;\r\n                            continue;\r\n                        }\r\n\r\n                        let curPart: number = 0;\r\n                        const newNotes: Note[] = newPattern.notes;\r\n                        let noteCount: number = 0;\r\n                        // Due to arbitrary note positioning, mod channels don't end the count until curPart actually exceeds the max\r\n                        while (curPart < this.beatsPerBar * Config.partsPerBeat + (+isModChannel)) {\r\n\r\n                            const useOldShape: boolean = bits.read(1) == 1;\r\n                            let newNote: boolean = false;\r\n                            let shapeIndex: number = 0;\r\n                            if (useOldShape) {\r\n                                shapeIndex = validateRange(0, recentShapes.length - 1, bits.readLongTail(0, 0));\r\n                            } else {\r\n                                newNote = bits.read(1) == 1;\r\n                            }\r\n\r\n                            if (!useOldShape && !newNote) {\r\n                                // For mod channels, check if you need to move backward too (notes can appear in any order and offset from each other).\r\n                                if (isModChannel) {\r\n                                    const isBackwards: boolean = bits.read(1) == 1;\r\n                                    const restLength: number = bits.readPartDuration();\r\n                                    if (isBackwards) {\r\n                                        curPart -= restLength;\r\n                                    }\r\n                                    else {\r\n                                        curPart += restLength;\r\n                                    }\r\n                                } else {\r\n                                    const restLength: number = (beforeSeven && fromBeepBox)\r\n                                        ? bits.readLegacyPartDuration() * Config.partsPerBeat / Config.rhythms[this.rhythm].stepsPerBeat\r\n                                        : bits.readPartDuration();\r\n                                    curPart += restLength;\r\n\r\n                                }\r\n                            } else {\r\n                                let shape: any;\r\n                                if (useOldShape) {\r\n                                    shape = recentShapes[shapeIndex];\r\n                                    recentShapes.splice(shapeIndex, 1);\r\n                                } else {\r\n                                    shape = {};\r\n\r\n                                    if (!largerChords) {\r\n                                        // Old format: X 1's followed by a 0 => X+1 pitches, up to 4\r\n                                        shape.pitchCount = 1;\r\n                                        while (shape.pitchCount < 4 && bits.read(1) == 1) shape.pitchCount++;\r\n                                    }\r\n                                    else {\r\n                                        // New format is:\r\n                                        //      0: 1 pitch\r\n                                        // 1[XXX]: 3 bits of binary signifying 2+ pitches\r\n                                        if (bits.read(1) == 1) {\r\n                                            shape.pitchCount = bits.read(3) + 2;\r\n                                        }\r\n                                        else {\r\n                                            shape.pitchCount = 1;\r\n                                        }\r\n                                    }\r\n\r\n                                    shape.pinCount = bits.readPinCount();\r\n                                    if (fromBeepBox) {\r\n                                        shape.initialSize = bits.read(2) * 2;\r\n                                    } else if (!isModChannel) {\r\n                                        shape.initialSize = bits.read(bitsPerNoteSize);\r\n                                    } else {\r\n                                        shape.initialSize = bits.read(9);\r\n                                    }\r\n\r\n                                    shape.pins = [];\r\n                                    shape.length = 0;\r\n                                    shape.bendCount = 0;\r\n                                    for (let j: number = 0; j < shape.pinCount; j++) {\r\n                                        let pinObj: any = {};\r\n                                        pinObj.pitchBend = bits.read(1) == 1;\r\n                                        if (pinObj.pitchBend) shape.bendCount++;\r\n                                        shape.length += (beforeSeven && fromBeepBox)\r\n                                            ? bits.readLegacyPartDuration() * Config.partsPerBeat / Config.rhythms[this.rhythm].stepsPerBeat\r\n                                            : bits.readPartDuration();\r\n                                        pinObj.time = shape.length;\r\n                                        if (fromBeepBox) {\r\n                                            pinObj.size = bits.read(2) * 2;\r\n                                        } else if (!isModChannel) {\r\n                                            pinObj.size = bits.read(bitsPerNoteSize);\r\n                                        }\r\n                                        else {\r\n                                            pinObj.size = bits.read(9);\r\n                                        }\r\n                                        shape.pins.push(pinObj);\r\n                                    }\r\n                                }\r\n                                recentShapes.unshift(shape);\r\n                                if (recentShapes.length > 10) recentShapes.pop(); // TODO: Use Deque?\r\n\r\n                                let note: Note;\r\n                                if (newNotes.length <= noteCount) {\r\n                                    note = new Note(0, curPart, curPart + shape.length, shape.initialSize);\r\n                                    newNotes[noteCount++] = note;\r\n                                } else {\r\n                                    note = newNotes[noteCount++];\r\n                                    note.start = curPart;\r\n                                    note.end = curPart + shape.length;\r\n                                    note.pins[0].size = shape.initialSize;\r\n                                }\r\n\r\n                                let pitch: number;\r\n                                let pitchCount: number = 0;\r\n                                const pitchBends: number[] = []; // TODO: allocate this array only once! keep separate length and iterator index. Use Deque?\r\n                                for (let j: number = 0; j < shape.pitchCount + shape.bendCount; j++) {\r\n                                    const useOldPitch: boolean = bits.read(1) == 1;\r\n                                    if (!useOldPitch) {\r\n                                        const interval: number = bits.readPitchInterval();\r\n                                        pitch = lastPitch;\r\n                                        let intervalIter: number = interval;\r\n                                        while (intervalIter > 0) {\r\n                                            pitch++;\r\n                                            while (recentPitches.indexOf(pitch) != -1) pitch++;\r\n                                            intervalIter--;\r\n                                        }\r\n                                        while (intervalIter < 0) {\r\n                                            pitch--;\r\n                                            while (recentPitches.indexOf(pitch) != -1) pitch--;\r\n                                            intervalIter++;\r\n                                        }\r\n                                    } else {\r\n                                        const pitchIndex: number = validateRange(0, recentPitches.length - 1, bits.read(recentPitchBitLength));\r\n                                        pitch = recentPitches[pitchIndex];\r\n                                        recentPitches.splice(pitchIndex, 1);\r\n                                    }\r\n\r\n                                    recentPitches.unshift(pitch);\r\n                                    if (recentPitches.length > recentPitchLength) recentPitches.pop();\r\n\r\n                                    if (j < shape.pitchCount) {\r\n                                        note.pitches[pitchCount++] = pitch;\r\n                                    } else {\r\n                                        pitchBends.push(pitch);\r\n                                    }\r\n\r\n                                    if (j == shape.pitchCount - 1) {\r\n                                        lastPitch = note.pitches[0];\r\n                                    } else {\r\n                                        lastPitch = pitch;\r\n                                    }\r\n                                }\r\n                                note.pitches.length = pitchCount;\r\n                                pitchBends.unshift(note.pitches[0]); // TODO: Use Deque?\r\n                                if (isModChannel) {\r\n                                    note.pins[0].size *= detuneScaleNotes[newPattern.instruments[0]][note.pitches[0]];\r\n                                }\r\n                                let pinCount: number = 1;\r\n                                for (const pinObj of shape.pins) {\r\n                                    if (pinObj.pitchBend) pitchBends.shift();\r\n\r\n                                    const interval: number = pitchBends[0] - note.pitches[0];\r\n                                    if (note.pins.length <= pinCount) {\r\n                                        if (isModChannel) {\r\n                                            note.pins[pinCount++] = makeNotePin(interval, pinObj.time, pinObj.size * detuneScaleNotes[newPattern.instruments[0]][note.pitches[0]]);\r\n                                        } else {\r\n                                            note.pins[pinCount++] = makeNotePin(interval, pinObj.time, pinObj.size);\r\n                                        }\r\n                                    } else {\r\n                                        const pin: NotePin = note.pins[pinCount++];\r\n                                        pin.interval = interval;\r\n                                        pin.time = pinObj.time;\r\n                                        if (isModChannel) {\r\n                                            pin.size = pinObj.size * detuneScaleNotes[newPattern.instruments[0]][note.pitches[0]];\r\n                                        } else {\r\n                                            pin.size = pinObj.size;\r\n                                        }\r\n                                    }\r\n                                }\r\n                                note.pins.length = pinCount;\r\n\r\n                                if (note.start == 0) {\r\n                                    if (!((beforeNine && fromBeepBox) || (beforeFive && fromJummBox))) {\r\n                                        note.continuesLastPattern = (bits.read(1) == 1);\r\n                                    } else {\r\n                                        if (beforeFour || fromBeepBox) {\r\n                                            note.continuesLastPattern = false;\r\n                                        } else {\r\n                                            note.continuesLastPattern = channel.instruments[newPattern.instruments[0]].legacyTieOver;\r\n                                        }\r\n                                    }\r\n                                }\r\n\r\n                                curPart = validateRange(0, this.beatsPerBar * Config.partsPerBeat, note.end);\r\n                            }\r\n                        }\r\n                        newNotes.length = noteCount;\r\n                    }\r\n\r\n                    if (beforeThree && fromBeepBox) {\r\n                        break;\r\n                    } else {\r\n                        channelIndex++;\r\n                        if (channelIndex >= this.getChannelCount()) break;\r\n                    }\r\n                } // while (true)\r\n\r\n                // Correction for old JB songs that had song reverb mods. Change all instruments using reverb to max reverb\r\n                if (fromJummBox && beforeFive && songReverbIndex >= 0) {\r\n                    for (let channelIndex: number = 0; channelIndex < this.channels.length; channelIndex++) {\r\n                        for (let instrumentIndex: number = 0; instrumentIndex < this.channels[channelIndex].instruments.length; instrumentIndex++) {\r\n                            const instrument: Instrument = this.channels[channelIndex].instruments[instrumentIndex];\r\n                            if (effectsIncludeReverb(instrument.effects)) {\r\n                                instrument.reverb = Config.reverbRange - 1;\r\n                            }\r\n                            // Set song reverb via mod to the old setting at song start.\r\n                            if (songReverbChannel == channelIndex && songReverbInstrument == instrumentIndex) {\r\n                                const patternIndex: number = this.channels[channelIndex].bars[0];\r\n                                if (patternIndex > 0) {\r\n                                    // Doesn't work if 1st pattern isn't using the right ins for song reverb...\r\n                                    // Add note to start of pattern\r\n                                    const pattern: Pattern = this.channels[channelIndex].patterns[patternIndex - 1];\r\n                                    let lowestPart: number = 6;\r\n                                    for (const note of pattern.notes) {\r\n                                        if (note.pitches[0] == Config.modCount - 1 - songReverbIndex) {\r\n                                            lowestPart = Math.min(lowestPart, note.start);\r\n                                        }\r\n                                    }\r\n\r\n                                    if (lowestPart > 0) {\r\n                                        pattern.notes.push(new Note(Config.modCount - 1 - songReverbIndex, 0, lowestPart, legacyGlobalReverb));\r\n                                    }\r\n                                }\r\n                                else {\r\n                                    // Add pattern\r\n                                    if (this.channels[channelIndex].patterns.length < Config.barCountMax) {\r\n                                        const pattern: Pattern = new Pattern();\r\n                                        this.channels[channelIndex].patterns.push(pattern);\r\n                                        this.channels[channelIndex].bars[0] = this.channels[channelIndex].patterns.length;\r\n                                        if (this.channels[channelIndex].patterns.length > this.patternsPerChannel) {\r\n                                            for (let chn: number = 0; chn < this.channels.length; chn++) {\r\n                                                if (this.channels[chn].patterns.length <= this.patternsPerChannel) {\r\n                                                    this.channels[chn].patterns.push(new Pattern());\r\n                                                }\r\n                                            }\r\n                                            this.patternsPerChannel++;\r\n                                        }\r\n                                        pattern.instruments.length = 1;\r\n                                        pattern.instruments[0] = songReverbInstrument;\r\n                                        pattern.notes.length = 0;\r\n                                        pattern.notes.push(new Note(Config.modCount - 1 - songReverbIndex, 0, 6, legacyGlobalReverb));\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            } break;\r\n            default: {\r\n                throw new Error(\"Unrecognized song tag code \" + String.fromCharCode(command) + \" at index \" + (charIndex - 1));\r\n            } break;\r\n        }\r\n    }\r\n\r\n    public toJsonObject(enableIntro: boolean = true, loopCount: number = 1, enableOutro: boolean = true): Object {\r\n        const channelArray: Object[] = [];\r\n        for (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n            const channel: Channel = this.channels[channelIndex];\r\n            const instrumentArray: Object[] = [];\r\n            const isNoiseChannel: boolean = this.getChannelIsNoise(channelIndex);\r\n            const isModChannel: boolean = this.getChannelIsMod(channelIndex);\r\n            for (const instrument of channel.instruments) {\r\n                instrumentArray.push(instrument.toJsonObject());\r\n            }\r\n\r\n            const patternArray: Object[] = [];\r\n            for (const pattern of channel.patterns) {\r\n                patternArray.push(pattern.toJsonObject(this, channel, isModChannel));\r\n            }\r\n\r\n            const sequenceArray: number[] = [];\r\n            if (enableIntro) for (let i: number = 0; i < this.loopStart; i++) {\r\n                sequenceArray.push(channel.bars[i]);\r\n            }\r\n            for (let l: number = 0; l < loopCount; l++) for (let i: number = this.loopStart; i < this.loopStart + this.loopLength; i++) {\r\n                sequenceArray.push(channel.bars[i]);\r\n            }\r\n            if (enableOutro) for (let i: number = this.loopStart + this.loopLength; i < this.barCount; i++) {\r\n                sequenceArray.push(channel.bars[i]);\r\n            }\r\n\r\n            const channelObject: any = {\r\n                \"type\": isModChannel ? \"mod\" : (isNoiseChannel ? \"drum\" : \"pitch\"),\r\n                \"name\": channel.name,\r\n                \"instruments\": instrumentArray,\r\n                \"patterns\": patternArray,\r\n                \"sequence\": sequenceArray,\r\n            };\r\n            if (!isNoiseChannel) {\r\n                // For compatibility with old versions the octave is offset by one.\r\n                channelObject[\"octaveScrollBar\"] = channel.octave - 1;\r\n            }\r\n            channelArray.push(channelObject);\r\n        }\r\n\r\n        return {\r\n            \"name\": this.title,\r\n            \"format\": Song._format,\r\n            \"version\": Song._latestJummBoxVersion,\r\n            \"scale\": Config.scales[this.scale].name,\r\n            \"key\": Config.keys[this.key].name,\r\n            \"introBars\": this.loopStart,\r\n            \"loopBars\": this.loopLength,\r\n            \"beatsPerBar\": this.beatsPerBar,\r\n            \"ticksPerBeat\": Config.rhythms[this.rhythm].stepsPerBeat,\r\n            \"beatsPerMinute\": this.tempo,\r\n            \"reverb\": this.reverb,\r\n            \"masterGain\": this.masterGain,\r\n            \"compressionThreshold\": this.compressionThreshold,\r\n            \"limitThreshold\": this.limitThreshold,\r\n            \"limitDecay\": this.limitDecay,\r\n            \"limitRise\": this.limitRise,\r\n            \"limitRatio\": this.limitRatio,\r\n            \"compressionRatio\": this.compressionRatio,\r\n            //\"outroBars\": this.barCount - this.loopStart - this.loopLength; // derive this from bar arrays?\r\n            //\"patternCount\": this.patternsPerChannel, // derive this from pattern arrays?\r\n            \"layeredInstruments\": this.layeredInstruments,\r\n            \"patternInstruments\": this.patternInstruments,\r\n            \"channels\": channelArray,\r\n        };\r\n    }\r\n\r\n    public fromJsonObject(jsonObject: any): void {\r\n        this.initToDefault(true);\r\n        if (!jsonObject) return;\r\n\r\n        //const version: number = jsonObject[\"version\"] | 0;\r\n        //if (version > Song._latestVersion) return; // Go ahead and try to parse something from the future I guess? JSON is pretty easy-going!\r\n\r\n        if (jsonObject[\"name\"] != undefined) {\r\n            this.title = jsonObject[\"name\"];\r\n        }\r\n\r\n        this.scale = 0; // default to free.\r\n        if (jsonObject[\"scale\"] != undefined) {\r\n            const oldScaleNames: Dictionary<string> = {\r\n                \"romani :)\": \"dbl harmonic :)\",\r\n                \"romani :(\": \"dbl harmonic :(\",\r\n                \"enigma\": \"strange\",\r\n            };\r\n            const scaleName: string = (oldScaleNames[jsonObject[\"scale\"]] != undefined) ? oldScaleNames[jsonObject[\"scale\"]] : jsonObject[\"scale\"];\r\n            const scale: number = Config.scales.findIndex(scale => scale.name == scaleName);\r\n            if (scale != -1) this.scale = scale;\r\n        }\r\n\r\n        if (jsonObject[\"key\"] != undefined) {\r\n            if (typeof (jsonObject[\"key\"]) == \"number\") {\r\n                this.key = ((jsonObject[\"key\"] + 1200) >>> 0) % Config.keys.length;\r\n            } else if (typeof (jsonObject[\"key\"]) == \"string\") {\r\n                const key: string = jsonObject[\"key\"];\r\n                const letter: string = key.charAt(0).toUpperCase();\r\n                const symbol: string = key.charAt(1).toLowerCase();\r\n                const letterMap: Readonly<Dictionary<number>> = { \"C\": 0, \"D\": 2, \"E\": 4, \"F\": 5, \"G\": 7, \"A\": 9, \"B\": 11 };\r\n                const accidentalMap: Readonly<Dictionary<number>> = { \"#\": 1, \"♯\": 1, \"b\": -1, \"♭\": -1 };\r\n                let index: number | undefined = letterMap[letter];\r\n                const offset: number | undefined = accidentalMap[symbol];\r\n                if (index != undefined) {\r\n                    if (offset != undefined) index += offset;\r\n                    if (index < 0) index += 12;\r\n                    index = index % 12;\r\n                    this.key = index;\r\n                }\r\n            }\r\n        }\r\n\r\n        if (jsonObject[\"beatsPerMinute\"] != undefined) {\r\n            this.tempo = clamp(Config.tempoMin, Config.tempoMax + 1, jsonObject[\"beatsPerMinute\"] | 0);\r\n        }\r\n\r\n        let legacyGlobalReverb: number = 0; // In older songs, reverb was song-global, record that here and pass it to Instrument.fromJsonObject() for context.\r\n        if (jsonObject[\"reverb\"] != undefined) {\r\n            legacyGlobalReverb = clamp(0, 32, jsonObject[\"reverb\"] | 0);\r\n        }\r\n\r\n        if (jsonObject[\"beatsPerBar\"] != undefined) {\r\n            this.beatsPerBar = Math.max(Config.beatsPerBarMin, Math.min(Config.beatsPerBarMax, jsonObject[\"beatsPerBar\"] | 0));\r\n        }\r\n\r\n        let importedPartsPerBeat: number = 4;\r\n        if (jsonObject[\"ticksPerBeat\"] != undefined) {\r\n            importedPartsPerBeat = (jsonObject[\"ticksPerBeat\"] | 0) || 4;\r\n            this.rhythm = Config.rhythms.findIndex(rhythm => rhythm.stepsPerBeat == importedPartsPerBeat);\r\n            if (this.rhythm == -1) {\r\n                this.rhythm = 1;\r\n            }\r\n        }\r\n\r\n        // Read limiter settings. Ranges and defaults are based on slider settings\r\n\r\n        if (jsonObject[\"masterGain\"] != undefined) {\r\n            this.masterGain = Math.max(0.0, Math.min(5.0, jsonObject[\"masterGain\"] || 0));\r\n        } else {\r\n            this.masterGain = 1.0;\r\n        }\r\n\r\n        if (jsonObject[\"limitThreshold\"] != undefined) {\r\n            this.limitThreshold = Math.max(0.0, Math.min(2.0, jsonObject[\"limitThreshold\"] || 0));\r\n        }\r\n        else {\r\n            this.limitThreshold = 1.0;\r\n        }\r\n\r\n        if (jsonObject[\"compressionThreshold\"] != undefined) {\r\n            this.compressionThreshold = Math.max(0.0, Math.min(1.1, jsonObject[\"compressionThreshold\"] || 0));\r\n        }\r\n        else {\r\n            this.compressionThreshold = 1.0;\r\n        }\r\n\r\n        if (jsonObject[\"limitRise\"] != undefined) {\r\n            this.limitRise = Math.max(2000.0, Math.min(10000.0, jsonObject[\"limitRise\"] || 0));\r\n        }\r\n        else {\r\n            this.limitRise = 4000.0;\r\n        }\r\n\r\n        if (jsonObject[\"limitDecay\"] != undefined) {\r\n            this.limitDecay = Math.max(1.0, Math.min(30.0, jsonObject[\"limitDecay\"] || 0));\r\n        }\r\n        else {\r\n            this.limitDecay = 4.0;\r\n        }\r\n\r\n        if (jsonObject[\"limitRatio\"] != undefined) {\r\n            this.limitRatio = Math.max(0.0, Math.min(11.0, jsonObject[\"limitRatio\"] || 0));\r\n        }\r\n        else {\r\n            this.limitRatio = 1.0;\r\n        }\r\n\r\n        if (jsonObject[\"compressionRatio\"] != undefined) {\r\n            this.compressionRatio = Math.max(0.0, Math.min(1.168, jsonObject[\"compressionRatio\"] || 0));\r\n        }\r\n        else {\r\n            this.compressionRatio = 1.0;\r\n        }\r\n\r\n        let maxInstruments: number = 1;\r\n        let maxPatterns: number = 1;\r\n        let maxBars: number = 1;\r\n        if (jsonObject[\"channels\"] != undefined) {\r\n            for (const channelObject of jsonObject[\"channels\"]) {\r\n                if (channelObject[\"instruments\"]) maxInstruments = Math.max(maxInstruments, channelObject[\"instruments\"].length | 0);\r\n                if (channelObject[\"patterns\"]) maxPatterns = Math.max(maxPatterns, channelObject[\"patterns\"].length | 0);\r\n                if (channelObject[\"sequence\"]) maxBars = Math.max(maxBars, channelObject[\"sequence\"].length | 0);\r\n            }\r\n        }\r\n\r\n        if (jsonObject[\"layeredInstruments\"] != undefined) {\r\n            this.layeredInstruments = !!jsonObject[\"layeredInstruments\"];\r\n        } else {\r\n            this.layeredInstruments = false;\r\n        }\r\n        if (jsonObject[\"patternInstruments\"] != undefined) {\r\n            this.patternInstruments = !!jsonObject[\"patternInstruments\"];\r\n        } else {\r\n            this.patternInstruments = (maxInstruments > 1);\r\n        }\r\n        this.patternsPerChannel = Math.min(maxPatterns, Config.barCountMax);\r\n        this.barCount = Math.min(maxBars, Config.barCountMax);\r\n\r\n        if (jsonObject[\"introBars\"] != undefined) {\r\n            this.loopStart = clamp(0, this.barCount, jsonObject[\"introBars\"] | 0);\r\n        }\r\n        if (jsonObject[\"loopBars\"] != undefined) {\r\n            this.loopLength = clamp(1, this.barCount - this.loopStart + 1, jsonObject[\"loopBars\"] | 0);\r\n        }\r\n\r\n        const newPitchChannels: Channel[] = [];\r\n        const newNoiseChannels: Channel[] = [];\r\n        const newModChannels: Channel[] = [];\r\n        if (jsonObject[\"channels\"] != undefined) {\r\n            for (let channelIndex: number = 0; channelIndex < jsonObject[\"channels\"].length; channelIndex++) {\r\n                let channelObject: any = jsonObject[\"channels\"][channelIndex];\r\n\r\n                const channel: Channel = new Channel();\r\n\r\n                let isNoiseChannel: boolean = false;\r\n                let isModChannel: boolean = false;\r\n                if (channelObject[\"type\"] != undefined) {\r\n                    isNoiseChannel = (channelObject[\"type\"] == \"drum\");\r\n                    isModChannel = (channelObject[\"type\"] == \"mod\");\r\n                } else {\r\n                    // for older files, assume drums are channel 3.\r\n                    isNoiseChannel = (channelIndex >= 3);\r\n                }\r\n                if (isNoiseChannel) {\r\n                    newNoiseChannels.push(channel);\r\n                } else if (isModChannel) {\r\n                    newModChannels.push(channel);\r\n                }\r\n                else {\r\n                    newPitchChannels.push(channel);\r\n                }\r\n\r\n                if (channelObject[\"octaveScrollBar\"] != undefined) {\r\n                    channel.octave = clamp(0, Config.pitchOctaves, (channelObject[\"octaveScrollBar\"] | 0) + 1);\r\n                    if (isNoiseChannel) channel.octave = 0;\r\n                }\r\n\r\n                if (channelObject[\"name\"] != undefined) {\r\n                    channel.name = channelObject[\"name\"];\r\n                }\r\n                else {\r\n                    channel.name = \"\";\r\n                }\r\n\r\n                if (Array.isArray(channelObject[\"instruments\"])) {\r\n                    const instrumentObjects: any[] = channelObject[\"instruments\"];\r\n                    for (let i: number = 0; i < instrumentObjects.length; i++) {\r\n                        if (i >= this.getMaxInstrumentsPerChannel()) break;\r\n                        const instrument: Instrument = new Instrument(isNoiseChannel, isModChannel);\r\n                        channel.instruments[i] = instrument;\r\n                        instrument.fromJsonObject(instrumentObjects[i], isNoiseChannel, isModChannel, false, false, legacyGlobalReverb);\r\n                    }\r\n\r\n                }\r\n\r\n                for (let i: number = 0; i < this.patternsPerChannel; i++) {\r\n                    const pattern: Pattern = new Pattern();\r\n                    channel.patterns[i] = pattern;\r\n\r\n                    let patternObject: any = undefined;\r\n                    if (channelObject[\"patterns\"]) patternObject = channelObject[\"patterns\"][i];\r\n                    if (patternObject == undefined) continue;\r\n\r\n                    pattern.fromJsonObject(patternObject, this, channel, importedPartsPerBeat, isNoiseChannel, isModChannel);\r\n                }\r\n                channel.patterns.length = this.patternsPerChannel;\r\n\r\n                for (let i: number = 0; i < this.barCount; i++) {\r\n                    channel.bars[i] = (channelObject[\"sequence\"] != undefined) ? Math.min(this.patternsPerChannel, channelObject[\"sequence\"][i] >>> 0) : 0;\r\n                }\r\n                channel.bars.length = this.barCount;\r\n            }\r\n        }\r\n\r\n        if (newPitchChannels.length > Config.pitchChannelCountMax) newPitchChannels.length = Config.pitchChannelCountMax;\r\n        if (newNoiseChannels.length > Config.noiseChannelCountMax) newNoiseChannels.length = Config.noiseChannelCountMax;\r\n        if (newModChannels.length > Config.modChannelCountMax) newModChannels.length = Config.modChannelCountMax;\r\n        this.pitchChannelCount = newPitchChannels.length;\r\n        this.noiseChannelCount = newNoiseChannels.length;\r\n        this.modChannelCount = newModChannels.length;\r\n        this.channels.length = 0;\r\n        Array.prototype.push.apply(this.channels, newPitchChannels);\r\n        Array.prototype.push.apply(this.channels, newNoiseChannels);\r\n        Array.prototype.push.apply(this.channels, newModChannels);\r\n    }\r\n\r\n    public getPattern(channelIndex: number, bar: number): Pattern | null {\r\n        if (bar < 0 || bar >= this.barCount) return null;\r\n        const patternIndex: number = this.channels[channelIndex].bars[bar];\r\n        if (patternIndex == 0) return null;\r\n        return this.channels[channelIndex].patterns[patternIndex - 1];\r\n    }\r\n\r\n    public getBeatsPerMinute(): number {\r\n        return this.tempo;\r\n    }\r\n\r\n    public static getNeededBits(maxValue: number): number {\r\n        return 32 - Math.clz32(Math.ceil(maxValue + 1) - 1);\r\n    }\r\n\r\n    public restoreLimiterDefaults(): void {\r\n        this.compressionRatio = 1.0;\r\n        this.limitRatio = 1.0;\r\n        this.limitRise = 4000.0;\r\n        this.limitDecay = 4.0;\r\n        this.limitThreshold = 1.0;\r\n        this.compressionThreshold = 1.0;\r\n        this.masterGain = 1.0;\r\n    }\r\n}\r\n\r\nclass PickedString {\r\n    public delayLine: Float32Array | null = null;\r\n    public delayIndex: number;\r\n    public allPassSample: number;\r\n    public allPassPrevInput: number;\r\n    public shelfSample: number;\r\n    public shelfPrevInput: number;\r\n    public fractionalDelaySample: number;\r\n    public prevDelayLength: number;\r\n    public delayLengthDelta: number;\r\n    public delayResetOffset: number;\r\n\r\n    public allPassG: number = 0.0;\r\n    public allPassGDelta: number = 0.0;\r\n    public shelfA1: number = 0.0;\r\n    public shelfA1Delta: number = 0.0;\r\n    public shelfB0: number = 0.0;\r\n    public shelfB0Delta: number = 0.0;\r\n    public shelfB1: number = 0.0;\r\n    public shelfB1Delta: number = 0.0;\r\n\r\n    constructor() {\r\n        this.reset();\r\n    }\r\n\r\n    public reset(): void {\r\n        this.delayIndex = -1;\r\n        this.allPassSample = 0.0;\r\n        this.allPassPrevInput = 0.0;\r\n        this.shelfSample = 0.0;\r\n        this.shelfPrevInput = 0.0;\r\n        this.fractionalDelaySample = 0.0;\r\n        this.prevDelayLength = -1.0;\r\n        this.delayResetOffset = 0;\r\n    }\r\n\r\n    public update(synth: Synth, instrumentState: InstrumentState, tone: Tone, stringIndex: number, roundedSamplesPerTick: number, stringDecayStart: number, stringDecayEnd: number): void {\r\n        const allPassCenter: number = 2.0 * Math.PI * Config.pickedStringDispersionCenterFreq / synth.samplesPerSecond;\r\n        const shelfRadians: number = 2.0 * Math.PI * Config.pickedStringShelfHz / synth.samplesPerSecond;\r\n        const decayCurveStart: number = (Math.pow(100.0, stringDecayStart) - 1.0) / 99.0;\r\n        const decayCurveEnd: number = (Math.pow(100.0, stringDecayEnd) - 1.0) / 99.0;\r\n\r\n        const prevDelayLength: number = this.prevDelayLength;\r\n\r\n        const phaseDeltaStart: number = tone.phaseDeltas[stringIndex];\r\n        const phaseDeltaScale: number = tone.phaseDeltaScales[stringIndex];\r\n        const phaseDeltaEnd: number = phaseDeltaStart * Math.pow(phaseDeltaScale, roundedSamplesPerTick);\r\n\r\n        const radiansPerSampleStart: number = Math.PI * 2.0 * phaseDeltaStart;\r\n        const radiansPerSampleEnd: number = Math.PI * 2.0 * phaseDeltaEnd;\r\n\r\n        const centerHarmonicStart: number = radiansPerSampleStart * 2.0;\r\n        const centerHarmonicEnd: number = radiansPerSampleEnd * 2.0;\r\n\r\n        const allPassRadiansStart: number = Math.min(Math.PI, radiansPerSampleStart * Config.pickedStringDispersionFreqMult * Math.pow(allPassCenter / radiansPerSampleStart, Config.pickedStringDispersionFreqScale));\r\n        const allPassRadiansEnd: number = Math.min(Math.PI, radiansPerSampleEnd * Config.pickedStringDispersionFreqMult * Math.pow(allPassCenter / radiansPerSampleEnd, Config.pickedStringDispersionFreqScale));\r\n\r\n        const decayRateStart: number = Math.pow(0.5, decayCurveStart * shelfRadians / radiansPerSampleStart);\r\n        const decayRateEnd: number = Math.pow(0.5, decayCurveEnd * shelfRadians / radiansPerSampleEnd);\r\n        const shelfGainStart: number = Math.pow(decayRateStart, Config.stringDecayRate);\r\n        const shelfGainEnd: number = Math.pow(decayRateEnd, Config.stringDecayRate);\r\n        const expressionDecayStart: number = Math.pow(decayRateStart, 0.002);\r\n        const expressionDecayEnd: number = Math.pow(decayRateEnd, 0.002);\r\n\r\n        Synth.tempFilterStartCoefficients.allPass1stOrderInvertPhaseAbove(allPassRadiansStart);\r\n        synth.tempFrequencyResponse.analyze(Synth.tempFilterStartCoefficients, centerHarmonicStart);\r\n        const allPassGStart: number = Synth.tempFilterStartCoefficients.b[0]; /* same as a[1] */\r\n        const allPassPhaseDelayStart: number = -synth.tempFrequencyResponse.angle() / centerHarmonicStart;\r\n\r\n        Synth.tempFilterEndCoefficients.allPass1stOrderInvertPhaseAbove(allPassRadiansEnd);\r\n        synth.tempFrequencyResponse.analyze(Synth.tempFilterEndCoefficients, centerHarmonicEnd);\r\n        const allPassGEnd: number = Synth.tempFilterEndCoefficients.b[0]; /* same as a[1] */\r\n        const allPassPhaseDelayEnd: number = -synth.tempFrequencyResponse.angle() / centerHarmonicEnd;\r\n\r\n        Synth.tempFilterStartCoefficients.highShelf1stOrder(shelfRadians, shelfGainStart);\r\n        synth.tempFrequencyResponse.analyze(Synth.tempFilterStartCoefficients, centerHarmonicStart);\r\n        const shelfA1Start: number = Synth.tempFilterStartCoefficients.a[1];\r\n        const shelfB0Start: number = Synth.tempFilterStartCoefficients.b[0] * expressionDecayStart;\r\n        const shelfB1Start: number = Synth.tempFilterStartCoefficients.b[1] * expressionDecayStart;\r\n        const shelfPhaseDelayStart: number = -synth.tempFrequencyResponse.angle() / centerHarmonicStart;\r\n\r\n        Synth.tempFilterEndCoefficients.highShelf1stOrder(shelfRadians, shelfGainEnd);\r\n        synth.tempFrequencyResponse.analyze(Synth.tempFilterEndCoefficients, centerHarmonicEnd);\r\n        const shelfA1End: number = Synth.tempFilterEndCoefficients.a[1];\r\n        const shelfB0End: number = Synth.tempFilterEndCoefficients.b[0] * expressionDecayEnd;\r\n        const shelfB1End: number = Synth.tempFilterEndCoefficients.b[1] * expressionDecayEnd;\r\n        const shelfPhaseDelayEnd: number = -synth.tempFrequencyResponse.angle() / centerHarmonicEnd;\r\n\r\n        const periodLengthStart: number = 1.0 / phaseDeltaStart;\r\n        const periodLengthEnd: number = 1.0 / phaseDeltaEnd;\r\n        const minBufferLength: number = Math.ceil(Math.max(periodLengthStart, periodLengthEnd) * 2);\r\n        const delayLength: number = periodLengthStart - allPassPhaseDelayStart - shelfPhaseDelayStart;\r\n        const delayLengthEnd: number = periodLengthEnd - allPassPhaseDelayEnd - shelfPhaseDelayEnd;\r\n\r\n        this.prevDelayLength = delayLength;\r\n        this.delayLengthDelta = (delayLengthEnd - delayLength) / roundedSamplesPerTick;\r\n        this.allPassG = allPassGStart;\r\n        this.shelfA1 = shelfA1Start;\r\n        this.shelfB0 = shelfB0Start;\r\n        this.shelfB1 = shelfB1Start;\r\n        this.allPassGDelta = (allPassGEnd - allPassGStart) / roundedSamplesPerTick;\r\n        this.shelfA1Delta = (shelfA1End - shelfA1Start) / roundedSamplesPerTick;\r\n        this.shelfB0Delta = (shelfB0End - shelfB0Start) / roundedSamplesPerTick;\r\n        this.shelfB1Delta = (shelfB1End - shelfB1Start) / roundedSamplesPerTick;\r\n\r\n        const pitchChanged: boolean = Math.abs(Math.log2(delayLength / prevDelayLength)) > 0.01;\r\n\r\n        const reinitializeImpulse: boolean = (this.delayIndex == -1 || pitchChanged);\r\n        if (this.delayLine == null || this.delayLine.length <= minBufferLength) {\r\n            // The delay line buffer will get reused for other tones so might as well\r\n            // start off with a buffer size that is big enough for most notes.\r\n            const likelyMaximumLength: number = Math.ceil(2 * synth.samplesPerSecond / Instrument.frequencyFromPitch(12));\r\n            const newDelayLine: Float32Array = new Float32Array(Synth.fittingPowerOfTwo(Math.max(likelyMaximumLength, minBufferLength)));\r\n            if (!reinitializeImpulse && this.delayLine != null) {\r\n                // If the tone has already started but the buffer needs to be reallocated,\r\n                // transfer the old data to the new buffer.\r\n                const oldDelayBufferMask: number = (this.delayLine.length - 1) >> 0;\r\n                const startCopyingFromIndex: number = this.delayIndex + this.delayResetOffset;\r\n                this.delayIndex = this.delayLine.length - this.delayResetOffset;\r\n                for (let i: number = 0; i < this.delayLine.length; i++) {\r\n                    newDelayLine[i] = this.delayLine[(startCopyingFromIndex + i) & oldDelayBufferMask];\r\n                }\r\n            }\r\n            this.delayLine = newDelayLine;\r\n        }\r\n        const delayLine: Float32Array = this.delayLine;\r\n        const delayBufferMask: number = (delayLine.length - 1) >> 0;\r\n\r\n        if (reinitializeImpulse) {\r\n            // -1 delay index means the tone was reset.\r\n            // Also, if the pitch changed suddenly (e.g. from seamless or arpeggio) then reset the wave.\r\n\r\n            this.delayIndex = 0;\r\n            this.allPassSample = 0.0;\r\n            this.allPassPrevInput = 0.0;\r\n            this.shelfSample = 0.0;\r\n            this.shelfPrevInput = 0.0;\r\n            this.fractionalDelaySample = 0.0;\r\n\r\n            // Clear away a region of the delay buffer for the new impulse.\r\n            const startImpulseFrom: number = -delayLength;\r\n            const startZerosFrom: number = Math.floor(startImpulseFrom - periodLengthStart / 2);\r\n            const stopZerosAt: number = Math.ceil(startZerosFrom + periodLengthStart * 2);\r\n            this.delayResetOffset = stopZerosAt; // And continue clearing the area in front of the delay line.\r\n            for (let i: number = startZerosFrom; i <= stopZerosAt; i++) {\r\n                delayLine[i & delayBufferMask] = 0.0;\r\n            }\r\n\r\n            const impulseWave: Float32Array = instrumentState.wave!;\r\n            const impulseWaveLength: number = impulseWave.length - 1; // The first sample is duplicated at the end, don't double-count it.\r\n            const impulsePhaseDelta: number = impulseWaveLength / periodLengthStart;\r\n\r\n            const fadeDuration: number = Math.min(periodLengthStart * 0.2, synth.samplesPerSecond * 0.003);\r\n            const startImpulseFromSample: number = Math.ceil(startImpulseFrom);\r\n            const stopImpulseAt: number = startImpulseFrom + periodLengthStart + fadeDuration;\r\n            const stopImpulseAtSample: number = stopImpulseAt;\r\n            let impulsePhase: number = (startImpulseFromSample - startImpulseFrom) * impulsePhaseDelta;\r\n            let prevWaveIntegral: number = 0.0;\r\n            for (let i: number = startImpulseFromSample; i <= stopImpulseAtSample; i++) {\r\n                const impulsePhaseInt: number = impulsePhase | 0;\r\n                const index: number = impulsePhaseInt % impulseWaveLength;\r\n                let nextWaveIntegral: number = impulseWave[index];\r\n                const phaseRatio: number = impulsePhase - impulsePhaseInt;\r\n                nextWaveIntegral += (impulseWave[index + 1] - nextWaveIntegral) * phaseRatio;\r\n                const sample: number = (nextWaveIntegral - prevWaveIntegral) / impulsePhaseDelta;\r\n                const fadeIn: number = Math.min(1.0, (i - startImpulseFrom) / fadeDuration);\r\n                const fadeOut: number = Math.min(1.0, (stopImpulseAt - i) / fadeDuration);\r\n                const combinedFade: number = fadeIn * fadeOut;\r\n                const curvedFade: number = combinedFade * combinedFade * (3.0 - 2.0 * combinedFade); // A cubic sigmoid from 0 to 1.\r\n                delayLine[i & delayBufferMask] += sample * curvedFade;\r\n                prevWaveIntegral = nextWaveIntegral;\r\n                impulsePhase += impulsePhaseDelta;\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nclass EnvelopeComputer {\r\n    public noteSecondsStart: number = 0.0;\r\n    public noteSecondsEnd: number = 0.0;\r\n    public noteTicksStart: number = 0.0;\r\n    public noteTicksEnd: number = 0.0;\r\n    public noteSizeStart: number = Config.noteSizeMax;\r\n    public noteSizeEnd: number = Config.noteSizeMax;\r\n    public prevNoteSize: number = Config.noteSizeMax;\r\n    public nextNoteSize: number = Config.noteSizeMax;\r\n    private _noteSizeFinal: number = Config.noteSizeMax;\r\n    public prevNoteSecondsStart: number = 0.0;\r\n    public prevNoteSecondsEnd: number = 0.0;\r\n    public prevNoteTicksStart: number = 0.0;\r\n    public prevNoteTicksEnd: number = 0.0;\r\n    private _prevNoteSizeFinal: number = Config.noteSizeMax;\r\n\r\n    public prevSlideStart: boolean = false;\r\n    public prevSlideEnd: boolean = false;\r\n    public nextSlideStart: boolean = false;\r\n    public nextSlideEnd: boolean = false;\r\n    public prevSlideRatioStart: number = 0.0;\r\n    public prevSlideRatioEnd: number = 0.0;\r\n    public nextSlideRatioStart: number = 0.0;\r\n    public nextSlideRatioEnd: number = 0.0;\r\n\r\n    public readonly envelopeStarts: number[] = [];\r\n    public readonly envelopeEnds: number[] = [];\r\n    private readonly _modifiedEnvelopeIndices: number[] = [];\r\n    private _modifiedEnvelopeCount: number = 0;\r\n    public lowpassCutoffDecayVolumeCompensation: number = 1.0;\r\n\r\n    constructor(/*private _perNote: boolean*/) {\r\n        //const length: number = this._perNote ? EnvelopeComputeIndex.length : InstrumentAutomationIndex.length;\r\n        const length: number = EnvelopeComputeIndex.length;\r\n        for (let i: number = 0; i < length; i++) {\r\n            this.envelopeStarts[i] = 1.0;\r\n            this.envelopeEnds[i] = 1.0;\r\n        }\r\n\r\n        this.reset();\r\n    }\r\n\r\n    public reset(): void {\r\n        this.noteSecondsEnd = 0.0;\r\n        this.noteTicksEnd = 0.0;\r\n        this._noteSizeFinal = Config.noteSizeMax;\r\n        this.prevNoteSecondsEnd = 0.0;\r\n        this.prevNoteTicksEnd = 0.0;\r\n        this._prevNoteSizeFinal = Config.noteSizeMax;\r\n        this._modifiedEnvelopeCount = 0;\r\n    }\r\n\r\n    public computeEnvelopes(instrument: Instrument, currentPart: number, tickTimeStart: number, secondsPerTick: number, tone: Tone | null): void {\r\n        const transition: Transition = instrument.getTransition();\r\n        if (tone != null && tone.atNoteStart && !transition.continues && !tone.forceContinueAtStart) {\r\n            this.prevNoteSecondsEnd = this.noteSecondsEnd;\r\n            this.prevNoteTicksEnd = this.noteTicksEnd;\r\n            this._prevNoteSizeFinal = this._noteSizeFinal;\r\n            this.noteSecondsEnd = 0.0;\r\n            this.noteTicksEnd = 0.0;\r\n        }\r\n        if (tone != null) {\r\n            if (tone.note != null) {\r\n                this._noteSizeFinal = tone.note.pins[tone.note.pins.length - 1].size;\r\n            } else {\r\n                this._noteSizeFinal = Config.noteSizeMax;\r\n            }\r\n        }\r\n\r\n        const tickTimeEnd: number = tickTimeStart + 1.0;\r\n        const noteSecondsStart: number = this.noteSecondsEnd;\r\n        const noteSecondsEnd: number = noteSecondsStart + secondsPerTick;\r\n        const noteTicksStart: number = this.noteTicksEnd;\r\n        const noteTicksEnd: number = noteTicksStart + 1.0;\r\n        const prevNoteSecondsStart: number = this.prevNoteSecondsEnd;\r\n        const prevNoteSecondsEnd: number = prevNoteSecondsStart + secondsPerTick;\r\n        const prevNoteTicksStart: number = this.prevNoteTicksEnd;\r\n        const prevNoteTicksEnd: number = prevNoteTicksStart + 1.0;\r\n\r\n        const beatsPerTick: number = 1.0 / (Config.ticksPerPart * Config.partsPerBeat);\r\n        const beatTimeStart: number = beatsPerTick * tickTimeStart;\r\n        const beatTimeEnd: number = beatsPerTick * tickTimeEnd;\r\n\r\n        let noteSizeStart: number = this._noteSizeFinal;\r\n        let noteSizeEnd: number = this._noteSizeFinal;\r\n        let prevNoteSize: number = this._prevNoteSizeFinal;\r\n        let nextNoteSize: number = 0;\r\n        let prevSlideStart: boolean = false;\r\n        let prevSlideEnd: boolean = false;\r\n        let nextSlideStart: boolean = false;\r\n        let nextSlideEnd: boolean = false;\r\n        let prevSlideRatioStart: number = 0.0;\r\n        let prevSlideRatioEnd: number = 0.0;\r\n        let nextSlideRatioStart: number = 0.0;\r\n        let nextSlideRatioEnd: number = 0.0;\r\n        if (tone != null && tone.note != null && !tone.passedEndOfNote) {\r\n            const endPinIndex: number = tone.note.getEndPinIndex(currentPart);\r\n            const startPin: NotePin = tone.note.pins[endPinIndex - 1];\r\n            const endPin: NotePin = tone.note.pins[endPinIndex];\r\n            const startPinTick: number = (tone.note.start + startPin.time) * Config.ticksPerPart;\r\n            const endPinTick: number = (tone.note.start + endPin.time) * Config.ticksPerPart;\r\n            const ratioStart: number = (tickTimeStart - startPinTick) / (endPinTick - startPinTick);\r\n            const ratioEnd: number = (tickTimeEnd - startPinTick) / (endPinTick - startPinTick);\r\n            noteSizeStart = startPin.size + (endPin.size - startPin.size) * ratioStart;\r\n            noteSizeEnd = startPin.size + (endPin.size - startPin.size) * ratioEnd;\r\n\r\n            if (transition.slides) {\r\n                const noteStartTick: number = tone.noteStartPart * Config.ticksPerPart;\r\n                const noteEndTick: number = tone.noteEndPart * Config.ticksPerPart;\r\n                const noteLengthTicks: number = noteEndTick - noteStartTick;\r\n                const maximumSlideTicks: number = noteLengthTicks * 0.5;\r\n                const slideTicks: number = Math.min(maximumSlideTicks, transition.slideTicks);\r\n                if (tone.prevNote != null && !tone.forceContinueAtStart) {\r\n                    if (tickTimeStart - noteStartTick < slideTicks) {\r\n                        prevSlideStart = true;\r\n                        prevSlideRatioStart = 0.5 * (1.0 - (tickTimeStart - noteStartTick) / slideTicks);\r\n                    }\r\n                    if (tickTimeEnd - noteStartTick < slideTicks) {\r\n                        prevSlideEnd = true;\r\n                        prevSlideRatioEnd = 0.5 * (1.0 - (tickTimeEnd - noteStartTick) / slideTicks);\r\n                    }\r\n                }\r\n                if (tone.nextNote != null && !tone.forceContinueAtEnd) {\r\n                    nextNoteSize = tone.nextNote.pins[0].size\r\n                    if (noteEndTick - tickTimeStart < slideTicks) {\r\n                        nextSlideStart = true;\r\n                        nextSlideRatioStart = 0.5 * (1.0 - (noteEndTick - tickTimeStart) / slideTicks);\r\n                    }\r\n                    if (noteEndTick - tickTimeEnd < slideTicks) {\r\n                        nextSlideEnd = true;\r\n                        nextSlideRatioEnd = 0.5 * (1.0 - (noteEndTick - tickTimeEnd) / slideTicks);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        let lowpassCutoffDecayVolumeCompensation: number = 1.0;\r\n        let usedNoteSize: boolean = false;\r\n        for (let envelopeIndex: number = 0; envelopeIndex <= instrument.envelopeCount; envelopeIndex++) {\r\n            let automationTarget: AutomationTarget;\r\n            let targetIndex: number;\r\n            let envelope: Envelope;\r\n            if (envelopeIndex == instrument.envelopeCount) {\r\n                if (usedNoteSize /*|| !this._perNote*/) break;\r\n                // Special case: if no other envelopes used note size, default to applying it to note volume.\r\n                automationTarget = Config.instrumentAutomationTargets.dictionary[\"noteVolume\"];\r\n                targetIndex = 0;\r\n                envelope = Config.envelopes.dictionary[\"note size\"];\r\n            } else {\r\n                let envelopeSettings: EnvelopeSettings = instrument.envelopes[envelopeIndex];\r\n                automationTarget = Config.instrumentAutomationTargets[envelopeSettings.target];\r\n                targetIndex = envelopeSettings.index;\r\n                envelope = Config.envelopes[envelopeSettings.envelope];\r\n                if (envelope.type == EnvelopeType.noteSize) usedNoteSize = true;\r\n            }\r\n            if (/*automationTarget.perNote == this._perNote &&*/ automationTarget.computeIndex != null) {\r\n                const computeIndex: number = automationTarget.computeIndex + targetIndex;\r\n                let envelopeStart: number = EnvelopeComputer.computeEnvelope(envelope, noteSecondsStart, beatTimeStart, noteSizeStart);\r\n                let envelopeEnd: number = EnvelopeComputer.computeEnvelope(envelope, noteSecondsEnd, beatTimeEnd, noteSizeEnd);\r\n\r\n                if (prevSlideStart) {\r\n                    const other: number = EnvelopeComputer.computeEnvelope(envelope, prevNoteSecondsStart, beatTimeStart, prevNoteSize);\r\n                    envelopeStart += (other - envelopeStart) * prevSlideRatioStart;\r\n                }\r\n                if (prevSlideEnd) {\r\n                    const other: number = EnvelopeComputer.computeEnvelope(envelope, prevNoteSecondsEnd, beatTimeEnd, prevNoteSize);\r\n                    envelopeEnd += (other - envelopeEnd) * prevSlideRatioEnd;\r\n                }\r\n                if (nextSlideStart) {\r\n                    const other: number = EnvelopeComputer.computeEnvelope(envelope, 0.0, beatTimeStart, nextNoteSize);\r\n                    envelopeStart += (other - envelopeStart) * nextSlideRatioStart;\r\n                }\r\n                if (nextSlideEnd) {\r\n                    const other: number = EnvelopeComputer.computeEnvelope(envelope, 0.0, beatTimeEnd, nextNoteSize);\r\n                    envelopeEnd += (other - envelopeEnd) * nextSlideRatioEnd;\r\n                }\r\n\r\n                this.envelopeStarts[computeIndex] *= envelopeStart;\r\n                this.envelopeEnds[computeIndex] *= envelopeEnd;\r\n                this._modifiedEnvelopeIndices[this._modifiedEnvelopeCount++] = computeIndex;\r\n\r\n                if (automationTarget.isFilter) {\r\n                    const filterSettings: FilterSettings = /*this._perNote ?*/ (instrument.tmpNoteFilterStart != null) ? instrument.tmpNoteFilterStart : instrument.noteFilter /*: instrument.eqFilter*/;\r\n                    if (filterSettings.controlPointCount > targetIndex && filterSettings.controlPoints[targetIndex].type == FilterType.lowPass) {\r\n                        lowpassCutoffDecayVolumeCompensation = Math.max(lowpassCutoffDecayVolumeCompensation, EnvelopeComputer.getLowpassCutoffDecayVolumeCompensation(envelope));\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        this.noteSecondsStart = noteSecondsStart;\r\n        this.noteSecondsEnd = noteSecondsEnd;\r\n        this.noteTicksStart = noteTicksStart;\r\n        this.noteTicksEnd = noteTicksEnd;\r\n        this.prevNoteSecondsStart = prevNoteSecondsStart;\r\n        this.prevNoteSecondsEnd = prevNoteSecondsEnd;\r\n        this.prevNoteTicksStart = prevNoteTicksStart;\r\n        this.prevNoteTicksEnd = prevNoteTicksEnd;\r\n        this.prevNoteSize = prevNoteSize;\r\n        this.nextNoteSize = nextNoteSize;\r\n        this.noteSizeStart = noteSizeStart;\r\n        this.noteSizeEnd = noteSizeEnd;\r\n        this.prevSlideStart = prevSlideStart;\r\n        this.prevSlideEnd = prevSlideEnd;\r\n        this.nextSlideStart = nextSlideStart;\r\n        this.nextSlideEnd = nextSlideEnd;\r\n        this.prevSlideRatioStart = prevSlideRatioStart;\r\n        this.prevSlideRatioEnd = prevSlideRatioEnd;\r\n        this.nextSlideRatioStart = nextSlideRatioStart;\r\n        this.nextSlideRatioEnd = nextSlideRatioEnd;\r\n        this.lowpassCutoffDecayVolumeCompensation = lowpassCutoffDecayVolumeCompensation;\r\n    }\r\n\r\n    public clearEnvelopes(): void {\r\n        for (let envelopeIndex: number = 0; envelopeIndex < this._modifiedEnvelopeCount; envelopeIndex++) {\r\n            const computeIndex: number = this._modifiedEnvelopeIndices[envelopeIndex];\r\n            this.envelopeStarts[computeIndex] = 1.0;\r\n            this.envelopeEnds[computeIndex] = 1.0;\r\n        }\r\n        this._modifiedEnvelopeCount = 0;\r\n    }\r\n\r\n    public static computeEnvelope(envelope: Envelope, time: number, beats: number, noteSize: number): number {\r\n        switch (envelope.type) {\r\n            case EnvelopeType.noteSize: return Synth.noteSizeToVolumeMult(noteSize);\r\n            case EnvelopeType.none: return 1.0;\r\n            case EnvelopeType.twang: return 1.0 / (1.0 + time * envelope.speed);\r\n            case EnvelopeType.swell: return 1.0 - 1.0 / (1.0 + time * envelope.speed);\r\n            case EnvelopeType.tremolo: return 0.5 - Math.cos(beats * 2.0 * Math.PI * envelope.speed) * 0.5;\r\n            case EnvelopeType.tremolo2: return 0.75 - Math.cos(beats * 2.0 * Math.PI * envelope.speed) * 0.25;\r\n            case EnvelopeType.punch: return Math.max(1.0, 2.0 - time * 10.0);\r\n            case EnvelopeType.flare: const attack: number = 0.25 / Math.sqrt(envelope.speed); return time < attack ? time / attack : 1.0 / (1.0 + (time - attack) * envelope.speed);\r\n            case EnvelopeType.decay: return Math.pow(2, -envelope.speed * time);\r\n            default: throw new Error(\"Unrecognized operator envelope type.\");\r\n        }\r\n\r\n    }\r\n\r\n    public static getLowpassCutoffDecayVolumeCompensation(envelope: Envelope): number {\r\n        // This is a little hokey in the details, but I designed it a while ago and keep it \r\n        // around for compatibility. This decides how much to increase the volume (or\r\n        // expression) to compensate for a decaying lowpass cutoff to maintain perceived\r\n        // volume overall.\r\n        if (envelope.type == EnvelopeType.decay) return 1.25 + 0.025 * envelope.speed;\r\n        if (envelope.type == EnvelopeType.twang) return 1.0 + 0.02 * envelope.speed;\r\n        return 1.0;\r\n    }\r\n}\r\n\r\nclass Tone {\r\n    public instrumentIndex: number;\r\n    public readonly pitches: number[] = Array(Config.maxChordSize).fill(0);\r\n    public pitchCount: number = 0;\r\n    public chordSize: number = 0;\r\n    public drumsetPitch: number | null = null;\r\n    public note: Note | null = null;\r\n    public prevNote: Note | null = null;\r\n    public nextNote: Note | null = null;\r\n    public prevNotePitchIndex: number = 0;\r\n    public nextNotePitchIndex: number = 0;\r\n    public freshlyAllocated: boolean = true;\r\n    public atNoteStart: boolean = false;\r\n    public isOnLastTick: boolean = false; // Whether the tone is finished fading out and ready to be freed.\r\n    public passedEndOfNote: boolean = false;\r\n    public forceContinueAtStart: boolean = false;\r\n    public forceContinueAtEnd: boolean = false;\r\n    public noteStartPart: number = 0;\r\n    public noteEndPart: number = 0;\r\n    public ticksSinceReleased: number = 0;\r\n    public liveInputSamplesHeld: number = 0;\r\n    public lastInterval: number = 0;\r\n    public noiseSample: number = 0.0;\r\n    public stringSustainStart: number = 0;\r\n    public stringSustainEnd: number = 0;\r\n    public readonly phases: number[] = [];\r\n    public readonly operatorWaves: OperatorWave[] = [];\r\n    public readonly phaseDeltas: number[] = [];\r\n    public readonly phaseDeltaScales: number[] = [];\r\n    public expression: number = 0.0;\r\n    public expressionDelta: number = 0.0;\r\n    public readonly operatorExpressions: number[] = [];\r\n    public readonly operatorExpressionDeltas: number[] = [];\r\n    public readonly prevPitchExpressions: Array<number | null> = Array(Config.maxPitchOrOperatorCount).fill(null);\r\n    public prevVibrato: number | null = null;\r\n    public prevStringDecay: number | null = null;\r\n    public pulseWidth: number = 0.0;\r\n    public pulseWidthDelta: number = 0.0;\r\n    public readonly pickedStrings: PickedString[] = [];\r\n\r\n    public readonly noteFilters: DynamicBiquadFilter[] = [];\r\n    public noteFilterCount: number = 0;\r\n    public initialNoteFilterInput1: number = 0.0;\r\n    public initialNoteFilterInput2: number = 0.0;\r\n\r\n    public specialIntervalExpressionMult: number = 1.0;\r\n    public readonly feedbackOutputs: number[] = [];\r\n    public feedbackMult: number = 0.0;\r\n    public feedbackDelta: number = 0.0;\r\n    public stereoVolumeLStart: number = 0.0;\r\n    public stereoVolumeRStart: number = 0.0;\r\n    public stereoVolumeLDelta: number = 0.0;\r\n    public stereoVolumeRDelta: number = 0.0;\r\n    public stereoDelayStart: number = 0.0;\r\n    public stereoDelayEnd: number = 0.0;\r\n    public stereoDelayDelta: number = 0.0;\r\n    public customVolumeStart: number = 0.0;\r\n    public customVolumeEnd: number = 0.0;\r\n    public filterResonanceStart: number = 0.0;\r\n    public filterResonanceDelta: number = 0.0;\r\n    public isFirstOrder: boolean = false;\r\n\r\n    public readonly envelopeComputer: EnvelopeComputer = new EnvelopeComputer(/*true*/);\r\n\r\n    constructor() {\r\n        this.reset();\r\n    }\r\n\r\n    public reset(): void {\r\n        this.noiseSample = 0.0;\r\n        for (let i: number = 0; i < Config.maxPitchOrOperatorCount; i++) {\r\n            this.phases[i] = 0.0;\r\n            this.operatorWaves[i] = Config.operatorWaves[0];\r\n            this.feedbackOutputs[i] = 0.0;\r\n            this.prevPitchExpressions[i] = null;\r\n        }\r\n        for (let i: number = 0; i < this.noteFilterCount; i++) {\r\n            this.noteFilters[i].resetOutput();\r\n        }\r\n        this.noteFilterCount = 0;\r\n        this.initialNoteFilterInput1 = 0.0;\r\n        this.initialNoteFilterInput2 = 0.0;\r\n        this.liveInputSamplesHeld = 0;\r\n        for (const pickedString of this.pickedStrings) {\r\n            pickedString.reset();\r\n        }\r\n        this.envelopeComputer.reset();\r\n        this.prevVibrato = null;\r\n        this.prevStringDecay = null;\r\n        this.drumsetPitch = null;\r\n    }\r\n}\r\n\r\nclass InstrumentState {\r\n    public instrument: Instrument;\r\n\r\n    public awake: boolean = false; // Whether the instrument's effects-processing loop should continue.\r\n    public computed: boolean = false; // Whether the effects-processing parameters are up-to-date for the current synth run.\r\n    public tonesAddedInThisTick: boolean = false; // Whether any instrument tones are currently active.\r\n    public flushingDelayLines: boolean = false; // If no tones were active recently, enter a mode where the delay lines are filled with zeros to reset them for later use.\r\n    public deactivateAfterThisTick: boolean = false; // Whether the instrument is ready to be deactivated because the delay lines, if any, are fully zeroed.\r\n    public attentuationProgress: number = 0.0; // How long since an active tone introduced an input signal to the delay lines, normalized from 0 to 1 based on how long to wait until the delay lines signal will have audibly dissapated.\r\n    public flushedSamples: number = 0; // How many delay line samples have been flushed to zero.\r\n    public readonly activeTones: Deque<Tone> = new Deque<Tone>();\r\n    public readonly activeModTones: Deque<Tone> = new Deque<Tone>();\r\n    public readonly releasedTones: Deque<Tone> = new Deque<Tone>(); // Tones that are in the process of fading out after the corresponding notes ended.\r\n    public readonly liveInputTones: Deque<Tone> = new Deque<Tone>(); // Tones that are initiated by a source external to the loaded song data.\r\n\r\n    public type: InstrumentType = InstrumentType.chip;\r\n    public synthesizer: Function | null = null;\r\n    public wave: Float32Array | null = null;\r\n    public noisePitchFilterMult: number = 1.0;\r\n    public unison: Unison | null = null;\r\n    public chord: Chord | null = null;\r\n    public effects: number = 0;\r\n\r\n    public volumeScale: number = 0;\r\n    public aliases: boolean = false;\r\n\r\n    public eqFilterVolume: number = 1.0;\r\n    public eqFilterVolumeDelta: number = 0.0;\r\n    public mixVolume: number = 1.0;\r\n    public mixVolumeDelta: number = 0.0;\r\n    public delayInputMult: number = 0.0;\r\n    public delayInputMultDelta: number = 0.0;\r\n\r\n    public distortion: number = 0.0;\r\n    public distortionDelta: number = 0.0;\r\n    public distortionDrive: number = 0.0;\r\n    public distortionDriveDelta: number = 0.0;\r\n    public distortionFractionalInput1: number = 0.0;\r\n    public distortionFractionalInput2: number = 0.0;\r\n    public distortionFractionalInput3: number = 0.0;\r\n    public distortionPrevInput: number = 0.0;\r\n    public distortionNextOutput: number = 0.0;\r\n\r\n    public bitcrusherPrevInput: number = 0.0;\r\n    public bitcrusherCurrentOutput: number = 0.0;\r\n    public bitcrusherPhase: number = 1.0;\r\n    public bitcrusherPhaseDelta: number = 0.0;\r\n    public bitcrusherPhaseDeltaScale: number = 1.0;\r\n    public bitcrusherScale: number = 1.0;\r\n    public bitcrusherScaleScale: number = 1.0;\r\n    public bitcrusherFoldLevel: number = 1.0;\r\n    public bitcrusherFoldLevelScale: number = 1.0;\r\n\r\n    public readonly eqFilters: DynamicBiquadFilter[] = [];\r\n    public eqFilterCount: number = 0;\r\n    public initialEqFilterInput1: number = 0.0;\r\n    public initialEqFilterInput2: number = 0.0;\r\n\r\n    public panningDelayLine: Float32Array | null = null;\r\n    public panningDelayPos: number = 0;\r\n    public panningVolumeL: number = 0.0;\r\n    public panningVolumeR: number = 0.0;\r\n    public panningVolumeDeltaL: number = 0.0;\r\n    public panningVolumeDeltaR: number = 0.0;\r\n    public panningOffsetL: number = 0.0;\r\n    public panningOffsetR: number = 0.0;\r\n    public panningOffsetDeltaL: number = 0.0;\r\n    public panningOffsetDeltaR: number = 0.0;\r\n\r\n    public chorusDelayLineL: Float32Array | null = null;\r\n    public chorusDelayLineR: Float32Array | null = null;\r\n    public chorusDelayLineDirty: boolean = false;\r\n    public chorusDelayPos: number = 0;\r\n    public chorusPhase: number = 0;\r\n    public chorusVoiceMult: number = 0;\r\n    public chorusVoiceMultDelta: number = 0;\r\n    public chorusCombinedMult: number = 0;\r\n    public chorusCombinedMultDelta: number = 0;\r\n\r\n    public echoDelayLineL: Float32Array | null = null;\r\n    public echoDelayLineR: Float32Array | null = null;\r\n    public echoDelayLineDirty: boolean = false;\r\n    public echoDelayPos: number = 0;\r\n    public echoDelayOffsetStart: number = 0;\r\n    public echoDelayOffsetEnd: number | null = null;\r\n    public echoDelayOffsetRatio: number = 0.0;\r\n    public echoDelayOffsetRatioDelta: number = 0.0;\r\n    public echoMult: number = 0.0;\r\n    public echoMultDelta: number = 0.0;\r\n    public echoShelfA1: number = 0.0;\r\n    public echoShelfB0: number = 0.0;\r\n    public echoShelfB1: number = 0.0;\r\n    public echoShelfSampleL: number = 0.0;\r\n    public echoShelfSampleR: number = 0.0;\r\n    public echoShelfPrevInputL: number = 0.0;\r\n    public echoShelfPrevInputR: number = 0.0;\r\n\r\n    public reverbDelayLine: Float32Array | null = null;\r\n    public reverbDelayLineDirty: boolean = false;\r\n    public reverbDelayPos: number = 0;\r\n    public reverbMult: number = 0.0;\r\n    public reverbMultDelta: number = 0.0;\r\n    public reverbShelfA1: number = 0.0;\r\n    public reverbShelfB0: number = 0.0;\r\n    public reverbShelfB1: number = 0.0;\r\n    public reverbShelfSample0: number = 0.0;\r\n    public reverbShelfSample1: number = 0.0;\r\n    public reverbShelfSample2: number = 0.0;\r\n    public reverbShelfSample3: number = 0.0;\r\n    public reverbShelfPrevInput0: number = 0.0;\r\n    public reverbShelfPrevInput1: number = 0.0;\r\n    public reverbShelfPrevInput2: number = 0.0;\r\n    public reverbShelfPrevInput3: number = 0.0;\r\n\r\n    //public readonly envelopeComputer: EnvelopeComputer = new EnvelopeComputer(false);\r\n\r\n    public readonly spectrumWave: SpectrumWaveState = new SpectrumWaveState();\r\n    public readonly harmonicsWave: HarmonicsWaveState = new HarmonicsWaveState();\r\n    public readonly drumsetSpectrumWaves: SpectrumWaveState[] = [];\r\n\r\n    constructor() {\r\n        for (let i: number = 0; i < Config.drumCount; i++) {\r\n            this.drumsetSpectrumWaves[i] = new SpectrumWaveState();\r\n        }\r\n    }\r\n\r\n\r\n    public allocateNecessaryBuffers(synth: Synth, instrument: Instrument, samplesPerTick: number): void {\r\n        if (effectsIncludePanning(instrument.effects)) {\r\n            if (this.panningDelayLine == null || this.panningDelayLine.length < synth.panningDelayBufferSize) {\r\n                this.panningDelayLine = new Float32Array(synth.panningDelayBufferSize);\r\n            }\r\n        }\r\n        if (effectsIncludeChorus(instrument.effects)) {\r\n            if (this.chorusDelayLineL == null || this.chorusDelayLineL.length < synth.chorusDelayBufferSize) {\r\n                this.chorusDelayLineL = new Float32Array(synth.chorusDelayBufferSize);\r\n            }\r\n            if (this.chorusDelayLineR == null || this.chorusDelayLineR.length < synth.chorusDelayBufferSize) {\r\n                this.chorusDelayLineR = new Float32Array(synth.chorusDelayBufferSize);\r\n            }\r\n        }\r\n        if (effectsIncludeEcho(instrument.effects)) {\r\n            // account for tempo and delay automation changing delay length during a tick?\r\n            const safeEchoDelaySteps: number = Math.max(Config.echoDelayRange >> 1, (instrument.echoDelay + 1)); // The delay may be very short now, but if it increases later make sure we have enough sample history.\r\n            const baseEchoDelayBufferSize: number = Synth.fittingPowerOfTwo(safeEchoDelaySteps * Config.echoDelayStepTicks * samplesPerTick);\r\n            const safeEchoDelayBufferSize: number = baseEchoDelayBufferSize * 2; // If the tempo or delay changes and we suddenly need a longer delay, make sure that we have enough sample history to accomodate the longer delay.\r\n\r\n            if (this.echoDelayLineL == null || this.echoDelayLineR == null) {\r\n                this.echoDelayLineL = new Float32Array(safeEchoDelayBufferSize);\r\n                this.echoDelayLineR = new Float32Array(safeEchoDelayBufferSize);\r\n            } else if (this.echoDelayLineL.length < safeEchoDelayBufferSize || this.echoDelayLineR.length < safeEchoDelayBufferSize) {\r\n                // The echo delay length may change whlie the song is playing if tempo changes,\r\n                // so buffers may need to be reallocated, but we don't want to lose any echoes\r\n                // so we need to copy the contents of the old buffer to the new one.\r\n                const newDelayLineL: Float32Array = new Float32Array(safeEchoDelayBufferSize);\r\n                const newDelayLineR: Float32Array = new Float32Array(safeEchoDelayBufferSize);\r\n                const oldMask: number = this.echoDelayLineL.length - 1;\r\n\r\n                for (let i = 0; i < this.echoDelayLineL.length; i++) {\r\n                    newDelayLineL[i] = this.echoDelayLineL[(this.echoDelayPos + i) & oldMask];\r\n                    newDelayLineR[i] = this.echoDelayLineL[(this.echoDelayPos + i) & oldMask];\r\n                }\r\n\r\n                this.echoDelayPos = this.echoDelayLineL.length;\r\n                this.echoDelayLineL = newDelayLineL;\r\n                this.echoDelayLineR = newDelayLineR;\r\n            }\r\n        }\r\n        if (effectsIncludeReverb(instrument.effects)) {\r\n            // TODO: Make reverb delay line sample rate agnostic. Maybe just double buffer size for 96KHz? Adjust attenuation and shelf cutoff appropriately?\r\n            if (this.reverbDelayLine == null) {\r\n                this.reverbDelayLine = new Float32Array(Config.reverbDelayBufferSize);\r\n            }\r\n        }\r\n    }\r\n\r\n    public deactivate(): void {\r\n        this.bitcrusherPrevInput = 0.0;\r\n        this.bitcrusherCurrentOutput = 0.0;\r\n        this.bitcrusherPhase = 1.0;\r\n        for (let i: number = 0; i < this.eqFilterCount; i++) {\r\n            this.eqFilters[i].resetOutput();\r\n        }\r\n        this.eqFilterCount = 0;\r\n        this.initialEqFilterInput1 = 0.0;\r\n        this.initialEqFilterInput2 = 0.0;\r\n        this.distortionFractionalInput1 = 0.0;\r\n        this.distortionFractionalInput2 = 0.0;\r\n        this.distortionFractionalInput3 = 0.0;\r\n        this.distortionPrevInput = 0.0;\r\n        this.distortionNextOutput = 0.0;\r\n        this.panningDelayPos = 0;\r\n        if (this.panningDelayLine != null) for (let i: number = 0; i < this.panningDelayLine.length; i++) this.panningDelayLine[i] = 0.0;\r\n        this.echoDelayOffsetEnd = null;\r\n        this.echoShelfSampleL = 0.0;\r\n        this.echoShelfSampleR = 0.0;\r\n        this.echoShelfPrevInputL = 0.0;\r\n        this.echoShelfPrevInputR = 0.0;\r\n        this.reverbShelfSample0 = 0.0;\r\n        this.reverbShelfSample1 = 0.0;\r\n        this.reverbShelfSample2 = 0.0;\r\n        this.reverbShelfSample3 = 0.0;\r\n        this.reverbShelfPrevInput0 = 0.0;\r\n        this.reverbShelfPrevInput1 = 0.0;\r\n        this.reverbShelfPrevInput2 = 0.0;\r\n        this.reverbShelfPrevInput3 = 0.0;\r\n\r\n        this.volumeScale = 1.0;\r\n        this.aliases = false;\r\n\r\n        this.awake = false;\r\n        this.flushingDelayLines = false;\r\n        this.deactivateAfterThisTick = false;\r\n        this.attentuationProgress = 0.0;\r\n        this.flushedSamples = 0;\r\n    }\r\n\r\n    public resetAllEffects(): void {\r\n        this.deactivate();\r\n\r\n        if (this.chorusDelayLineDirty) {\r\n            for (let i: number = 0; i < this.chorusDelayLineL!.length; i++) this.chorusDelayLineL![i] = 0.0;\r\n            for (let i: number = 0; i < this.chorusDelayLineR!.length; i++) this.chorusDelayLineR![i] = 0.0;\r\n        }\r\n        if (this.echoDelayLineDirty) {\r\n            for (let i: number = 0; i < this.echoDelayLineL!.length; i++) this.echoDelayLineL![i] = 0.0;\r\n            for (let i: number = 0; i < this.echoDelayLineR!.length; i++) this.echoDelayLineR![i] = 0.0;\r\n        }\r\n        if (this.reverbDelayLineDirty) {\r\n            for (let i: number = 0; i < this.reverbDelayLine!.length; i++) this.reverbDelayLine![i] = 0.0;\r\n        }\r\n\r\n        this.chorusPhase = 0.0;\r\n    }\r\n\r\n    public compute(synth: Synth, instrument: Instrument, samplesPerTick: number, roundedSamplesPerTick: number, tone: Tone | null, channelIndex: number, instrumentIndex: number): void {\r\n        this.computed = true;\r\n\r\n        this.type = instrument.type;\r\n        this.synthesizer = Synth.getInstrumentSynthFunction(instrument);\r\n        this.unison = Config.unisons[instrument.unison];\r\n        this.chord = instrument.getChord();\r\n        this.noisePitchFilterMult = Config.chipNoises[instrument.chipNoise].pitchFilterMult;\r\n        this.effects = instrument.effects;\t\r\n\r\n        this.aliases = instrument.aliases;\r\n        this.volumeScale = 1.0;\r\n\r\n        this.allocateNecessaryBuffers(synth, instrument, samplesPerTick);\r\n\r\n        const samplesPerSecond: number = synth.samplesPerSecond;\r\n        this.updateWaves(instrument, samplesPerSecond);\r\n\r\n        //const ticksIntoBar: number = synth.getTicksIntoBar();\r\n        //const tickTimeStart: number = ticksIntoBar;\r\n        //const tickTimeEnd:   number = ticksIntoBar + 1.0;\r\n        //const secondsPerTick: number = samplesPerTick / synth.samplesPerSecond;\r\n        //const currentPart: number = synth.getCurrentPart();\r\n        //this.envelopeComputer.computeEnvelopes(instrument, currentPart, tickTimeStart, secondsPerTick, tone);\r\n        //const envelopeStarts: number[] = this.envelopeComputer.envelopeStarts;\r\n        //const envelopeEnds: number[] = this.envelopeComputer.envelopeEnds;\r\n\r\n        const usesDistortion: boolean = effectsIncludeDistortion(this.effects);\r\n        const usesBitcrusher: boolean = effectsIncludeBitcrusher(this.effects);\r\n        const usesPanning: boolean = effectsIncludePanning(this.effects);\r\n        const usesChorus: boolean = effectsIncludeChorus(this.effects);\r\n        const usesEcho: boolean = effectsIncludeEcho(this.effects);\r\n        const usesReverb: boolean = effectsIncludeReverb(this.effects);\r\n\r\n        if (usesDistortion) {\r\n            let useDistortionStart: number = instrument.distortion;\r\n            let useDistortionEnd: number = instrument.distortion;\r\n\r\n            // Check for distortion mods\r\n            if (synth.isModActive(Config.modulators.dictionary[\"distortion\"].index, channelIndex, instrumentIndex)) {\r\n                useDistortionStart = synth.getModValue(Config.modulators.dictionary[\"distortion\"].index, channelIndex, instrumentIndex, false);\r\n                useDistortionEnd = synth.getModValue(Config.modulators.dictionary[\"distortion\"].index, channelIndex, instrumentIndex, true);\r\n            }\r\n\r\n            const distortionSliderStart = Math.min(1.0, /*envelopeStarts[InstrumentAutomationIndex.distortion] **/ useDistortionStart / (Config.distortionRange - 1));\r\n            const distortionSliderEnd = Math.min(1.0, /*envelopeEnds[  InstrumentAutomationIndex.distortion] **/ useDistortionEnd / (Config.distortionRange - 1));\r\n            const distortionStart: number = Math.pow(1.0 - 0.895 * (Math.pow(20.0, distortionSliderStart) - 1.0) / 19.0, 2.0);\r\n            const distortionEnd: number = Math.pow(1.0 - 0.895 * (Math.pow(20.0, distortionSliderEnd) - 1.0) / 19.0, 2.0);\r\n            const distortionDriveStart: number = (1.0 + 2.0 * distortionSliderStart) / Config.distortionBaseVolume;\r\n            const distortionDriveEnd: number = (1.0 + 2.0 * distortionSliderEnd) / Config.distortionBaseVolume;\r\n            this.distortion = distortionStart;\r\n            this.distortionDelta = (distortionEnd - distortionStart) / roundedSamplesPerTick;\r\n            this.distortionDrive = distortionDriveStart;\r\n            this.distortionDriveDelta = (distortionDriveEnd - distortionDriveStart) / roundedSamplesPerTick;\r\n        }\r\n\r\n        if (usesBitcrusher) {\r\n            let freqSettingStart: number = instrument.bitcrusherFreq /** Math.sqrt(envelopeStarts[InstrumentAutomationIndex.bitcrusherFrequency])*/;\r\n            let freqSettingEnd: number = instrument.bitcrusherFreq /** Math.sqrt(envelopeEnds[  InstrumentAutomationIndex.bitcrusherFrequency])*/;\r\n\r\n            // Check for freq crush mods\r\n            if (synth.isModActive(Config.modulators.dictionary[\"freq crush\"].index, channelIndex, instrumentIndex)) {\r\n                freqSettingStart = synth.getModValue(Config.modulators.dictionary[\"freq crush\"].index, channelIndex, instrumentIndex, false);\r\n                freqSettingEnd = synth.getModValue(Config.modulators.dictionary[\"freq crush\"].index, channelIndex, instrumentIndex, true);\r\n            }\r\n\r\n            let quantizationSettingStart: number = instrument.bitcrusherQuantization /** Math.sqrt(envelopeStarts[InstrumentAutomationIndex.bitcrusherQuantization])*/;\r\n            let quantizationSettingEnd: number = instrument.bitcrusherQuantization /** Math.sqrt(envelopeEnds[  InstrumentAutomationIndex.bitcrusherQuantization])*/;\r\n\r\n            // Check for bitcrush mods\r\n            if (synth.isModActive(Config.modulators.dictionary[\"bit crush\"].index, channelIndex, instrumentIndex)) {\r\n                quantizationSettingStart = synth.getModValue(Config.modulators.dictionary[\"bit crush\"].index, channelIndex, instrumentIndex, false);\r\n                quantizationSettingEnd = synth.getModValue(Config.modulators.dictionary[\"bit crush\"].index, channelIndex, instrumentIndex, true);\r\n            }\r\n\r\n            const basePitch: number = Config.keys[synth.song!.key].basePitch; // TODO: What if there's a key change mid-song?\r\n            const freqStart: number = Instrument.frequencyFromPitch(basePitch + 60) * Math.pow(2.0, (Config.bitcrusherFreqRange - 1 - freqSettingStart) * Config.bitcrusherOctaveStep);\r\n            const freqEnd: number = Instrument.frequencyFromPitch(basePitch + 60) * Math.pow(2.0, (Config.bitcrusherFreqRange - 1 - freqSettingEnd) * Config.bitcrusherOctaveStep);\r\n            const phaseDeltaStart: number = Math.min(1.0, freqStart / samplesPerSecond);\r\n            const phaseDeltaEnd: number = Math.min(1.0, freqEnd / samplesPerSecond);\r\n            this.bitcrusherPhaseDelta = phaseDeltaStart;\r\n            this.bitcrusherPhaseDeltaScale = Math.pow(phaseDeltaEnd / phaseDeltaStart, 1.0 / roundedSamplesPerTick);\r\n\r\n            const scaleStart: number = 2.0 * Config.bitcrusherBaseVolume * Math.pow(2.0, 1.0 - Math.pow(2.0, (Config.bitcrusherQuantizationRange - 1 - quantizationSettingStart) * 0.5));\r\n            const scaleEnd: number = 2.0 * Config.bitcrusherBaseVolume * Math.pow(2.0, 1.0 - Math.pow(2.0, (Config.bitcrusherQuantizationRange - 1 - quantizationSettingEnd) * 0.5));\r\n            this.bitcrusherScale = scaleStart;\r\n            this.bitcrusherScaleScale = Math.pow(scaleEnd / scaleStart, 1.0 / roundedSamplesPerTick);\r\n\r\n            const foldLevelStart: number = 2.0 * Config.bitcrusherBaseVolume * Math.pow(1.5, Config.bitcrusherQuantizationRange - 1 - quantizationSettingStart);\r\n            const foldLevelEnd: number = 2.0 * Config.bitcrusherBaseVolume * Math.pow(1.5, Config.bitcrusherQuantizationRange - 1 - quantizationSettingEnd);\r\n            this.bitcrusherFoldLevel = foldLevelStart;\r\n            this.bitcrusherFoldLevelScale = Math.pow(foldLevelEnd / foldLevelStart, 1.0 / roundedSamplesPerTick);\r\n        }\r\n\r\n        let eqFilterVolume: number = 1.0; //this.envelopeComputer.lowpassCutoffDecayVolumeCompensation;\r\n        if (instrument.eqFilterType) {\r\n            // Simple EQ filter (old style). For analysis, using random filters from normal style since they are N/A in this context.\r\n            const eqFilterSettingsStart: FilterSettings = instrument.eqFilter;\r\n            if (instrument.eqSubFilters[1] == null)\r\n                instrument.eqSubFilters[1] = new FilterSettings();\r\n            const eqFilterSettingsEnd: FilterSettings = instrument.eqSubFilters[1];\r\n\r\n            // Change location based on slider values\r\n            let startSimpleFreq: number = instrument.eqFilterSimpleCut;\r\n            let startSimpleGain: number = instrument.eqFilterSimplePeak;\r\n            let endSimpleFreq: number = instrument.eqFilterSimpleCut;\r\n            let endSimpleGain: number = instrument.eqFilterSimplePeak;\r\n\r\n            let filterChanges: boolean = false;\r\n\r\n            if (synth.isModActive(Config.modulators.dictionary[\"eq filt cut\"].index, channelIndex, instrumentIndex)) {\r\n                startSimpleFreq = synth.getModValue(Config.modulators.dictionary[\"eq filt cut\"].index, channelIndex, instrumentIndex, false);\r\n                endSimpleFreq = synth.getModValue(Config.modulators.dictionary[\"eq filt cut\"].index, channelIndex, instrumentIndex, true);\r\n                filterChanges = true;\r\n            }\r\n            if (synth.isModActive(Config.modulators.dictionary[\"eq filt peak\"].index, channelIndex, instrumentIndex)) {\r\n                startSimpleGain = synth.getModValue(Config.modulators.dictionary[\"eq filt peak\"].index, channelIndex, instrumentIndex, false);\r\n                endSimpleGain = synth.getModValue(Config.modulators.dictionary[\"eq filt peak\"].index, channelIndex, instrumentIndex, true);\r\n                filterChanges = true;\r\n            }\r\n\r\n            let startPoint: FilterControlPoint;\r\n\r\n            if (filterChanges) {\r\n                eqFilterSettingsStart.convertLegacySettingsForSynth(startSimpleFreq, startSimpleGain);\r\n                eqFilterSettingsEnd.convertLegacySettingsForSynth(endSimpleFreq, endSimpleGain);\r\n\r\n                startPoint = eqFilterSettingsStart.controlPoints[0];\r\n                let endPoint: FilterControlPoint = eqFilterSettingsEnd.controlPoints[0];\r\n\r\n                startPoint.toCoefficients(Synth.tempFilterStartCoefficients, samplesPerSecond, 1.0, 1.0);\r\n                endPoint.toCoefficients(Synth.tempFilterEndCoefficients, samplesPerSecond, 1.0, 1.0);\r\n\r\n                if (this.eqFilters.length < 1) this.eqFilters[0] = new DynamicBiquadFilter();\r\n                this.eqFilters[0].loadCoefficientsWithGradient(Synth.tempFilterStartCoefficients, Synth.tempFilterEndCoefficients, 1.0 / roundedSamplesPerTick, startPoint.type == FilterType.lowPass);\r\n\r\n            } else {\r\n                eqFilterSettingsStart.convertLegacySettingsForSynth(startSimpleFreq, startSimpleGain, true);\r\n\r\n                startPoint = eqFilterSettingsStart.controlPoints[0];\r\n\r\n                startPoint.toCoefficients(Synth.tempFilterStartCoefficients, samplesPerSecond, 1.0, 1.0);\r\n\r\n                if (this.eqFilters.length < 1) this.eqFilters[0] = new DynamicBiquadFilter();\r\n                this.eqFilters[0].loadCoefficientsWithGradient(Synth.tempFilterStartCoefficients, Synth.tempFilterStartCoefficients, 1.0 / roundedSamplesPerTick, startPoint.type == FilterType.lowPass);\r\n\r\n            }\r\n\r\n            eqFilterVolume *= startPoint.getVolumeCompensationMult();\r\n\r\n            this.eqFilterCount = 1;\r\n            eqFilterVolume = Math.min(3.0, eqFilterVolume);\r\n        }\r\n        else {\r\n            const eqFilterSettings: FilterSettings = (instrument.tmpEqFilterStart != null) ? instrument.tmpEqFilterStart : instrument.eqFilter;\r\n            //const eqAllFreqsEnvelopeStart: number = envelopeStarts[InstrumentAutomationIndex.eqFilterAllFreqs];\r\n            //const eqAllFreqsEnvelopeEnd:   number = envelopeEnds[  InstrumentAutomationIndex.eqFilterAllFreqs];\r\n            for (let i: number = 0; i < eqFilterSettings.controlPointCount; i++) {\r\n                //const eqFreqEnvelopeStart: number = envelopeStarts[InstrumentAutomationIndex.eqFilterFreq0 + i];\r\n                //const eqFreqEnvelopeEnd:   number = envelopeEnds[  InstrumentAutomationIndex.eqFilterFreq0 + i];\r\n                //const eqPeakEnvelopeStart: number = envelopeStarts[InstrumentAutomationIndex.eqFilterGain0 + i];\r\n                //const eqPeakEnvelopeEnd:   number = envelopeEnds[  InstrumentAutomationIndex.eqFilterGain0 + i];\r\n                let startPoint: FilterControlPoint = eqFilterSettings.controlPoints[i];\r\n                let endPoint: FilterControlPoint = (instrument.tmpEqFilterEnd != null && instrument.tmpEqFilterEnd.controlPoints[i] != null) ? instrument.tmpEqFilterEnd.controlPoints[i] : eqFilterSettings.controlPoints[i];\r\n\r\n                // If switching dot type, do it all at once and do not try to interpolate since no valid interpolation exists.\r\n                if (startPoint.type != endPoint.type) {\r\n                    startPoint = endPoint;\r\n                }\r\n\r\n                startPoint.toCoefficients(Synth.tempFilterStartCoefficients, samplesPerSecond, /*eqAllFreqsEnvelopeStart * eqFreqEnvelopeStart*/ 1.0, /*eqPeakEnvelopeStart*/ 1.0);\r\n                endPoint.toCoefficients(Synth.tempFilterEndCoefficients, samplesPerSecond, /*eqAllFreqsEnvelopeEnd   * eqFreqEnvelopeEnd*/   1.0, /*eqPeakEnvelopeEnd*/   1.0);\r\n                if (this.eqFilters.length <= i) this.eqFilters[i] = new DynamicBiquadFilter();\r\n                this.eqFilters[i].loadCoefficientsWithGradient(Synth.tempFilterStartCoefficients, Synth.tempFilterEndCoefficients, 1.0 / roundedSamplesPerTick, startPoint.type == FilterType.lowPass);\r\n                eqFilterVolume *= startPoint.getVolumeCompensationMult();\r\n\r\n            }\r\n            this.eqFilterCount = eqFilterSettings.controlPointCount;\r\n            eqFilterVolume = Math.min(3.0, eqFilterVolume);\r\n        }\r\n\r\n        const mainInstrumentVolume: number = Synth.instrumentVolumeToVolumeMult(instrument.volume);\r\n        this.mixVolume = mainInstrumentVolume /** envelopeStarts[InstrumentAutomationIndex.mixVolume]*/;\r\n        let mixVolumeEnd: number = mainInstrumentVolume /** envelopeEnds[  InstrumentAutomationIndex.mixVolume]*/;\r\n\r\n        // Check for mod-related volume delta\r\n        if (synth.isModActive(Config.modulators.dictionary[\"mix volume\"].index, channelIndex, instrumentIndex)) {\r\n            // Linear falloff below 0, normal volume formula above 0. Seems to work best for scaling since the normal volume mult formula has a big gap from -25 to -24.\r\n            const startVal: number = synth.getModValue(Config.modulators.dictionary[\"mix volume\"].index, channelIndex, instrumentIndex, false);\r\n            const endVal: number = synth.getModValue(Config.modulators.dictionary[\"mix volume\"].index, channelIndex, instrumentIndex, true)\r\n            this.mixVolume *= ((startVal <= 0) ? ((startVal + Config.volumeRange / 2) / (Config.volumeRange / 2)) : Synth.instrumentVolumeToVolumeMult(startVal));\r\n            mixVolumeEnd *= ((endVal <= 0) ? ((endVal + Config.volumeRange / 2) / (Config.volumeRange / 2)) : Synth.instrumentVolumeToVolumeMult(endVal));\r\n        }\r\n\r\n        // Check for SONG mod-related volume delta\r\n        if (synth.isModActive(Config.modulators.dictionary[\"song volume\"].index)) {\r\n            this.mixVolume *= (synth.getModValue(Config.modulators.dictionary[\"song volume\"].index, undefined, undefined, false)) / 100.0;\r\n            mixVolumeEnd *= (synth.getModValue(Config.modulators.dictionary[\"song volume\"].index, undefined, undefined, true)) / 100.0;\r\n        }\r\n\r\n        this.mixVolumeDelta = (mixVolumeEnd - this.mixVolume) / roundedSamplesPerTick;\r\n\r\n        let eqFilterVolumeStart: number = eqFilterVolume;\r\n        let eqFilterVolumeEnd: number = eqFilterVolume;\r\n        let delayInputMultStart: number = 1.0;\r\n        let delayInputMultEnd: number = 1.0;\r\n\r\n        if (usesPanning) {\r\n            //const panEnvelopeStart: number = envelopeStarts[InstrumentAutomationIndex.panning] * 2.0 - 1.0;\r\n            //const panEnvelopeEnd:   number = envelopeEnds[  InstrumentAutomationIndex.panning] * 2.0 - 1.0;\r\n\r\n            let usePanStart: number = instrument.pan;\r\n            let usePanEnd: number = instrument.pan;\r\n            // Check for pan mods\r\n            if (synth.isModActive(Config.modulators.dictionary[\"pan\"].index, channelIndex, instrumentIndex)) {\r\n                usePanStart = synth.getModValue(Config.modulators.dictionary[\"pan\"].index, channelIndex, instrumentIndex, false);\r\n                usePanEnd = synth.getModValue(Config.modulators.dictionary[\"pan\"].index, channelIndex, instrumentIndex, true);\r\n            }\r\n\r\n            let panStart: number = Math.max(-1.0, Math.min(1.0, (usePanStart - Config.panCenter) / Config.panCenter /** panEnvelopeStart*/));\r\n            let panEnd: number = Math.max(-1.0, Math.min(1.0, (usePanEnd - Config.panCenter) / Config.panCenter /** panEnvelopeEnd  */));\r\n\r\n            const volumeStartL: number = Math.cos((1 + panStart) * Math.PI * 0.25) * 1.414;\r\n            const volumeStartR: number = Math.cos((1 - panStart) * Math.PI * 0.25) * 1.414;\r\n            const volumeEndL: number = Math.cos((1 + panEnd) * Math.PI * 0.25) * 1.414;\r\n            const volumeEndR: number = Math.cos((1 - panEnd) * Math.PI * 0.25) * 1.414;\r\n            const maxDelaySamples: number = samplesPerSecond * Config.panDelaySecondsMax;\r\n\r\n            let usePanDelayStart: number = instrument.panDelay;\r\n            let usePanDelayEnd: number = instrument.panDelay;\r\n            // Check for pan delay mods\r\n            if (synth.isModActive(Config.modulators.dictionary[\"pan delay\"].index, channelIndex, instrumentIndex)) {\r\n                usePanDelayStart = synth.getModValue(Config.modulators.dictionary[\"pan delay\"].index, channelIndex, instrumentIndex, false);\r\n                usePanDelayEnd = synth.getModValue(Config.modulators.dictionary[\"pan delay\"].index, channelIndex, instrumentIndex, true);\r\n            }\r\n\r\n            const delayStart: number = panStart * usePanDelayStart * maxDelaySamples / 10;\r\n            const delayEnd: number = panEnd * usePanDelayEnd * maxDelaySamples / 10;\r\n            const delayStartL: number = Math.max(0.0, delayStart);\r\n            const delayStartR: number = Math.max(0.0, -delayStart);\r\n            const delayEndL: number = Math.max(0.0, delayEnd);\r\n            const delayEndR: number = Math.max(0.0, -delayEnd);\r\n\r\n            this.panningVolumeL = volumeStartL;\r\n            this.panningVolumeR = volumeStartR;\r\n            this.panningVolumeDeltaL = (volumeEndL - volumeStartL) / roundedSamplesPerTick;\r\n            this.panningVolumeDeltaR = (volumeEndR - volumeStartR) / roundedSamplesPerTick;\r\n            this.panningOffsetL = this.panningDelayPos - delayStartL + synth.panningDelayBufferSize;\r\n            this.panningOffsetR = this.panningDelayPos - delayStartR + synth.panningDelayBufferSize;\r\n            this.panningOffsetDeltaL = (delayEndL - delayStartL) / roundedSamplesPerTick;\r\n            this.panningOffsetDeltaR = (delayEndR - delayStartR) / roundedSamplesPerTick;\r\n        }\r\n\r\n        if (usesChorus) {\r\n            //const chorusEnvelopeStart: number = envelopeStarts[InstrumentAutomationIndex.chorus];\r\n            //const chorusEnvelopeEnd:   number = envelopeEnds[  InstrumentAutomationIndex.chorus];\r\n            let useChorusStart: number = instrument.chorus;\r\n            let useChorusEnd: number = instrument.chorus;\r\n            // Check for chorus mods\r\n            if (synth.isModActive(Config.modulators.dictionary[\"chorus\"].index, channelIndex, instrumentIndex)) {\r\n                useChorusStart = synth.getModValue(Config.modulators.dictionary[\"chorus\"].index, channelIndex, instrumentIndex, false);\r\n                useChorusEnd = synth.getModValue(Config.modulators.dictionary[\"chorus\"].index, channelIndex, instrumentIndex, true);\r\n            }\r\n\r\n            let chorusStart: number = Math.min(1.0, /*chorusEnvelopeStart **/ useChorusStart / (Config.chorusRange - 1));\r\n            let chorusEnd: number = Math.min(1.0, /*chorusEnvelopeEnd   **/ useChorusEnd / (Config.chorusRange - 1));\r\n            chorusStart = chorusStart * 0.6 + (Math.pow(chorusStart, 6.0)) * 0.4;\r\n            chorusEnd = chorusEnd * 0.6 + (Math.pow(chorusEnd, 6.0)) * 0.4;\r\n            const chorusCombinedMultStart = 1.0 / Math.sqrt(3.0 * chorusStart * chorusStart + 1.0);\r\n            const chorusCombinedMultEnd = 1.0 / Math.sqrt(3.0 * chorusEnd * chorusEnd + 1.0);\r\n            this.chorusVoiceMult = chorusStart;\r\n            this.chorusVoiceMultDelta = (chorusEnd - chorusStart) / roundedSamplesPerTick;\r\n            this.chorusCombinedMult = chorusCombinedMultStart;\r\n            this.chorusCombinedMultDelta = (chorusCombinedMultEnd - chorusCombinedMultStart) / roundedSamplesPerTick;\r\n        }\r\n\r\n        let maxEchoMult = 0.0;\r\n        let averageEchoDelaySeconds: number = 0.0;\r\n        if (usesEcho) {\r\n            //const echoSustainEnvelopeStart: number = envelopeStarts[InstrumentAutomationIndex.echoSustain];\r\n            //const echoSustainEnvelopeEnd:   number = envelopeEnds[  InstrumentAutomationIndex.echoSustain];\r\n            let useEchoSustainStart: number = instrument.echoSustain;\r\n            let useEchoSustainEnd: number = instrument.echoSustain;\r\n            // Check for echo mods\r\n            if (synth.isModActive(Config.modulators.dictionary[\"echo\"].index, channelIndex, instrumentIndex)) {\r\n                useEchoSustainStart = Math.max( 0.0, synth.getModValue(Config.modulators.dictionary[\"echo\"].index, channelIndex, instrumentIndex, false) );\r\n                useEchoSustainEnd = Math.max( 0.0, synth.getModValue(Config.modulators.dictionary[\"echo\"].index, channelIndex, instrumentIndex, true) );\r\n            }\r\n            const echoMultStart: number = Math.min(1.0, Math.pow(/*echoSustainEnvelopeStart **/ useEchoSustainStart / Config.echoSustainRange, 1.1)) * 0.9;\r\n            const echoMultEnd: number = Math.min(1.0, Math.pow(/*echoSustainEnvelopeEnd   **/ useEchoSustainEnd / Config.echoSustainRange, 1.1)) * 0.9;\r\n            this.echoMult = echoMultStart;\r\n            this.echoMultDelta = Math.max(0.0, (echoMultEnd - echoMultStart) / roundedSamplesPerTick);\r\n            maxEchoMult = Math.max(echoMultStart, echoMultEnd);\r\n\r\n            // TODO: After computing a tick's settings once for multiple run lengths (which is\r\n            // good for audio worklet threads), compute the echo delay envelopes at tick (or\r\n            // part) boundaries to interpolate between two delay taps.\r\n            //const echoDelayEnvelopeStart:   number = envelopeStarts[InstrumentAutomationIndex.echoDelay];\r\n            //const echoDelayEnvelopeEnd:     number = envelopeEnds[  InstrumentAutomationIndex.echoDelay];\r\n            let useEchoDelayStart: number = instrument.echoDelay;\r\n            let useEchoDelayEnd: number = instrument.echoDelay;\r\n            let ignoreTicks: boolean = false;\r\n            // Check for pan delay mods\r\n            if (synth.isModActive(Config.modulators.dictionary[\"echo delay\"].index, channelIndex, instrumentIndex)) {\r\n                useEchoDelayStart = synth.getModValue(Config.modulators.dictionary[\"echo delay\"].index, channelIndex, instrumentIndex, false);\r\n                useEchoDelayEnd = synth.getModValue(Config.modulators.dictionary[\"echo delay\"].index, channelIndex, instrumentIndex, true);\r\n                ignoreTicks = true;\r\n            }\r\n\r\n            const tmpEchoDelayOffsetStart: number = Math.round((useEchoDelayStart + 1) * Config.echoDelayStepTicks * samplesPerTick);\r\n            const tmpEchoDelayOffsetEnd: number = Math.round((useEchoDelayEnd + 1) * Config.echoDelayStepTicks * samplesPerTick);\r\n            if (this.echoDelayOffsetEnd != null && !ignoreTicks) {\r\n                this.echoDelayOffsetStart = this.echoDelayOffsetEnd;\r\n            } else {\r\n                this.echoDelayOffsetStart = tmpEchoDelayOffsetStart;\r\n            }\r\n\r\n            this.echoDelayOffsetEnd = tmpEchoDelayOffsetEnd;\r\n            averageEchoDelaySeconds = (this.echoDelayOffsetStart + this.echoDelayOffsetEnd) * 0.5 / samplesPerSecond;\r\n\r\n            this.echoDelayOffsetRatio = 0.0;\r\n            this.echoDelayOffsetRatioDelta = 1.0 / roundedSamplesPerTick;\r\n\r\n            const shelfRadians: number = 2.0 * Math.PI * Config.echoShelfHz / synth.samplesPerSecond;\r\n            Synth.tempFilterStartCoefficients.highShelf1stOrder(shelfRadians, Config.echoShelfGain);\r\n            this.echoShelfA1 = Synth.tempFilterStartCoefficients.a[1];\r\n            this.echoShelfB0 = Synth.tempFilterStartCoefficients.b[0];\r\n            this.echoShelfB1 = Synth.tempFilterStartCoefficients.b[1];\r\n        }\r\n\r\n        let maxReverbMult = 0.0;\r\n        if (usesReverb) {\r\n            //const reverbEnvelopeStart: number = envelopeStarts[InstrumentAutomationIndex.reverb];\r\n            //const reverbEnvelopeEnd:   number = envelopeEnds[  InstrumentAutomationIndex.reverb];\r\n\r\n            let useReverbStart: number = instrument.reverb;\r\n            let useReverbEnd: number = instrument.reverb;\r\n\r\n            // Check for mod reverb, instrument level\r\n            if (synth.isModActive(Config.modulators.dictionary[\"reverb\"].index, channelIndex, instrumentIndex)) {\r\n                useReverbStart = synth.getModValue(Config.modulators.dictionary[\"reverb\"].index, channelIndex, instrumentIndex, false);\r\n                useReverbEnd = synth.getModValue(Config.modulators.dictionary[\"reverb\"].index, channelIndex, instrumentIndex, true);\r\n            }\r\n            // Check for mod reverb, song scalar\r\n            if (synth.isModActive(Config.modulators.dictionary[\"song reverb\"].index, channelIndex, instrumentIndex)) {\r\n                useReverbStart *= (synth.getModValue(Config.modulators.dictionary[\"song reverb\"].index, undefined, undefined, false) - Config.modulators.dictionary[\"song reverb\"].convertRealFactor) / Config.reverbRange;\r\n                useReverbEnd *= (synth.getModValue(Config.modulators.dictionary[\"song reverb\"].index, undefined, undefined, true) - Config.modulators.dictionary[\"song reverb\"].convertRealFactor) / Config.reverbRange;\r\n            }\r\n\r\n            const reverbStart: number = Math.min(1.0, Math.pow(/*reverbEnvelopeStart **/ useReverbStart / Config.reverbRange, 0.667)) * 0.425;\r\n            const reverbEnd: number = Math.min(1.0, Math.pow(/*reverbEnvelopeEnd   **/ useReverbEnd / Config.reverbRange, 0.667)) * 0.425;\r\n\r\n            this.reverbMult = reverbStart;\r\n            this.reverbMultDelta = (reverbEnd - reverbStart) / roundedSamplesPerTick;\r\n            maxReverbMult = Math.max(reverbStart, reverbEnd);\r\n\r\n            const shelfRadians: number = 2.0 * Math.PI * Config.reverbShelfHz / synth.samplesPerSecond;\r\n            Synth.tempFilterStartCoefficients.highShelf1stOrder(shelfRadians, Config.reverbShelfGain);\r\n            this.reverbShelfA1 = Synth.tempFilterStartCoefficients.a[1];\r\n            this.reverbShelfB0 = Synth.tempFilterStartCoefficients.b[0];\r\n            this.reverbShelfB1 = Synth.tempFilterStartCoefficients.b[1];\r\n        }\r\n\r\n        if (this.tonesAddedInThisTick) {\r\n            this.attentuationProgress = 0.0;\r\n            this.flushedSamples = 0;\r\n            this.flushingDelayLines = false;\r\n        } else if (!this.flushingDelayLines) {\r\n            // If this instrument isn't playing tones anymore, the volume can fade out by the\r\n            // end of the first tick. It's possible for filters and the panning delay line to\r\n            // continue past the end of the tone but they should have mostly dissipated by the\r\n            // end of the tick anyway.\r\n            if (this.attentuationProgress == 0.0) {\r\n                eqFilterVolumeEnd = 0.0;\r\n            } else {\r\n                eqFilterVolumeStart = 0.0;\r\n                eqFilterVolumeEnd = 0.0;\r\n            }\r\n\r\n            const attenuationThreshold: number = 1.0 / 256.0; // when the delay line signal has attenuated this much, it should be inaudible and should be flushed to zero.\r\n            const halfLifeMult: number = -Math.log2(attenuationThreshold);\r\n            let delayDuration: number = 0.0;\r\n\r\n            if (usesChorus) {\r\n                delayDuration += Config.chorusMaxDelay;\r\n            }\r\n\r\n            if (usesEcho) {\r\n                const attenuationPerSecond: number = Math.pow(maxEchoMult, 1.0 / averageEchoDelaySeconds);\r\n                const halfLife: number = -1.0 / Math.log2(attenuationPerSecond);\r\n                const echoDuration: number = halfLife * halfLifeMult;\r\n                delayDuration += echoDuration;\r\n            }\r\n\r\n            if (usesReverb) {\r\n                const averageMult: number = maxReverbMult * 2.0;\r\n                const averageReverbDelaySeconds: number = (Config.reverbDelayBufferSize / 4.0) / samplesPerSecond;\r\n                const attenuationPerSecond: number = Math.pow(averageMult, 1.0 / averageReverbDelaySeconds);\r\n                const halfLife: number = -1.0 / Math.log2(attenuationPerSecond);\r\n                const reverbDuration: number = halfLife * halfLifeMult;\r\n                delayDuration += reverbDuration;\r\n            }\r\n\r\n            const secondsInTick: number = samplesPerTick / samplesPerSecond;\r\n            const progressInTick: number = secondsInTick / delayDuration;\r\n            const progressAtEndOfTick: number = this.attentuationProgress + progressInTick;\r\n            if (progressAtEndOfTick >= 1.0) {\r\n                delayInputMultEnd = 0.0;\r\n            }\r\n\r\n            this.attentuationProgress = progressAtEndOfTick;\r\n            if (this.attentuationProgress >= 1.0) {\r\n                this.flushingDelayLines = true;\r\n            }\r\n        } else {\r\n            // Flushing delay lines to zero since the signal has mostly dissipated.\r\n            eqFilterVolumeStart = 0.0;\r\n            eqFilterVolumeEnd = 0.0;\r\n            delayInputMultStart = 0.0;\r\n            delayInputMultEnd = 0.0;\r\n\r\n            let totalDelaySamples: number = 0;\r\n            if (usesChorus) totalDelaySamples += synth.chorusDelayBufferSize;\r\n            if (usesEcho) totalDelaySamples += this.echoDelayLineL!.length;\r\n            if (usesReverb) totalDelaySamples += Config.reverbDelayBufferSize;\r\n\r\n            this.flushedSamples += roundedSamplesPerTick;\r\n            if (this.flushedSamples >= totalDelaySamples) {\r\n                this.deactivateAfterThisTick = true;\r\n            }\r\n        }\r\n\r\n        this.eqFilterVolume = eqFilterVolumeStart;\r\n        this.eqFilterVolumeDelta = (eqFilterVolumeEnd - eqFilterVolumeStart) / roundedSamplesPerTick;\r\n        this.delayInputMult = delayInputMultStart;\r\n        this.delayInputMultDelta = (delayInputMultEnd - delayInputMultStart) / roundedSamplesPerTick;\r\n    }\r\n\r\n    public updateWaves(instrument: Instrument, samplesPerSecond: number): void {\r\n        this.volumeScale = 1.0;\r\n        if (instrument.type == InstrumentType.chip) {\r\n            this.wave = (this.aliases) ? Config.rawChipWaves[instrument.chipWave].samples : Config.chipWaves[instrument.chipWave].samples;\r\n        } else if (instrument.type == InstrumentType.customChipWave) {\r\n            this.wave = (this.aliases) ? instrument.customChipWave! : instrument.customChipWaveIntegral!;\r\n            this.volumeScale = 0.05;\r\n        } else if (instrument.type == InstrumentType.noise) {\r\n            this.wave = getDrumWave(instrument.chipNoise, inverseRealFourierTransform, scaleElementsByFactor);\r\n        } else if (instrument.type == InstrumentType.harmonics) {\r\n            this.wave = this.harmonicsWave.getCustomWave(instrument.harmonicsWave, instrument.type);\r\n        } else if (instrument.type == InstrumentType.pickedString) {\r\n            this.wave = this.harmonicsWave.getCustomWave(instrument.harmonicsWave, instrument.type);\r\n        } else if (instrument.type == InstrumentType.spectrum) {\r\n            this.wave = this.spectrumWave.getCustomWave(instrument.spectrumWave, 8);\r\n        } else if (instrument.type == InstrumentType.drumset) {\r\n            for (let i: number = 0; i < Config.drumCount; i++) {\r\n                this.drumsetSpectrumWaves[i].getCustomWave(instrument.drumsetSpectrumWaves[i], InstrumentState._drumsetIndexToSpectrumOctave(i));\r\n            }\r\n            this.wave = null;\r\n        } else {\r\n            this.wave = null;\r\n        }\r\n    }\r\n\r\n    public getDrumsetWave(pitch: number): Float32Array {\r\n        if (this.type == InstrumentType.drumset) {\r\n            return this.drumsetSpectrumWaves[pitch].wave!;\r\n        } else {\r\n            throw new Error(\"Unhandled instrument type in getDrumsetWave\");\r\n        }\r\n    }\r\n\r\n    public static drumsetIndexReferenceDelta(index: number): number {\r\n        return Instrument.frequencyFromPitch(Config.spectrumBasePitch + index * 6) / 44100;\r\n    }\r\n\r\n    private static _drumsetIndexToSpectrumOctave(index: number): number {\r\n        return 15 + Math.log2(InstrumentState.drumsetIndexReferenceDelta(index));\r\n    }\r\n}\r\n\r\nclass ChannelState {\r\n    public readonly instruments: InstrumentState[] = [];\r\n    public muted: boolean = false;\r\n    public singleSeamlessInstrument: number | null = null; // Seamless tones from a pattern with a single instrument can be transferred to a different single seamless instrument in the next pattern.\r\n}\r\n\r\nexport class Synth {\r\n\r\n    private syncSongState(): void {\r\n        const channelCount: number = this.song!.getChannelCount();\r\n        for (let i: number = this.channels.length; i < channelCount; i++) {\r\n            this.channels[i] = new ChannelState();\r\n        }\r\n        this.channels.length = channelCount;\r\n        for (let i: number = 0; i < channelCount; i++) {\r\n            const channel: Channel = this.song!.channels[i];\r\n            const channelState: ChannelState = this.channels[i];\r\n            for (let j: number = channelState.instruments.length; j < channel.instruments.length; j++) {\r\n                channelState.instruments[j] = new InstrumentState();\r\n            }\r\n            channelState.instruments.length = channel.instruments.length;\r\n\r\n            if (channelState.muted != channel.muted) {\r\n                channelState.muted = channel.muted;\r\n                if (channelState.muted) {\r\n                    for (const instrumentState of channelState.instruments) {\r\n                        instrumentState.resetAllEffects();\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    public warmUpSynthesizer(song: Song | null): void {\r\n        // Don't bother to generate the drum waves unless the song actually\r\n        // uses them, since they may require a lot of computation.\r\n        if (song != null) {\r\n            this.syncSongState();\r\n            const samplesPerTick: number = this.getSamplesPerTick();\r\n            for (let channelIndex: number = 0; channelIndex < song.getChannelCount(); channelIndex++) {\r\n                for (let instrumentIndex: number = 0; instrumentIndex < song.channels[channelIndex].instruments.length; instrumentIndex++) {\r\n                    const instrument: Instrument = song.channels[channelIndex].instruments[instrumentIndex];\r\n                    const instrumentState: InstrumentState = this.channels[channelIndex].instruments[instrumentIndex];\r\n                    Synth.getInstrumentSynthFunction(instrument);\r\n                    instrument.LFOtime = 0;\r\n                    instrument.nextLFOtime = 0;\r\n                    instrument.arpTime = 0;\r\n                    instrument.tmpEqFilterStart = instrument.eqFilter;\r\n                    instrument.tmpEqFilterEnd = null;\r\n                    instrument.tmpNoteFilterStart = instrument.noteFilter;\r\n                    instrument.tmpNoteFilterEnd = null;\r\n                    instrumentState.updateWaves(instrument, this.samplesPerSecond);\r\n                    instrumentState.allocateNecessaryBuffers(this, instrument, samplesPerTick);\r\n                }\r\n\r\n            }\r\n        }\r\n        var dummyArray = new Float32Array(1);\r\n        this.isPlayingSong = true;\r\n        this.synthesize(dummyArray, dummyArray, 1, true);\r\n        this.isPlayingSong = false;\r\n    }\r\n\r\n    public computeLatestModValues(): void {\r\n\r\n        if (this.song != null && this.song.modChannelCount > 0) {\r\n\r\n            // Clear all mod values, and set up temp variables for the time a mod would be set at.\r\n            let latestModTimes: (number | null)[] = [];\r\n            let latestModInsTimes: (number | null)[][][] = [];\r\n            this.modValues = [];\r\n            this.nextModValues = [];\r\n            this.modInsValues = [];\r\n            this.nextModInsValues = [];\r\n            for (let channel: number = 0; channel < this.song.pitchChannelCount + this.song.noiseChannelCount; channel++) {\r\n                latestModInsTimes[channel] = [];\r\n                this.modInsValues[channel] = [];\r\n                this.nextModInsValues[channel] = [];\r\n\r\n                for (let instrument: number = 0; instrument < this.song.channels[channel].instruments.length; instrument++) {\r\n                    this.modInsValues[channel][instrument] = [];\r\n                    this.nextModInsValues[channel][instrument] = [];\r\n                    latestModInsTimes[channel][instrument] = [];\r\n                }\r\n            }\r\n\r\n            // Find out where we're at in the fraction of the current bar.\r\n            let currentPart: number = this.beat * Config.partsPerBeat + this.part;\r\n\r\n            // For mod channels, calculate last set value for each mod\r\n            for (let channelIndex: number = this.song.pitchChannelCount + this.song.noiseChannelCount; channelIndex < this.song.getChannelCount(); channelIndex++) {\r\n                if (!(this.song.channels[channelIndex].muted)) {\r\n\r\n                    let pattern: Pattern | null;\r\n\r\n                    for (let currentBar: number = this.bar; currentBar >= 0; currentBar--) {\r\n                        pattern = this.song.getPattern(channelIndex, currentBar);\r\n\r\n                        if (pattern != null) {\r\n                            let instrumentIdx: number = pattern.instruments[0];\r\n                            let instrument: Instrument = this.song.channels[channelIndex].instruments[instrumentIdx];\r\n                            let latestPinParts: number[] = [];\r\n                            let latestPinValues: number[] = [];\r\n\r\n                            let partsInBar: number = (currentBar == this.bar)\r\n                                ? currentPart\r\n                                : this.findPartsInBar(currentBar);\r\n\r\n                            for (const note of pattern.notes) {\r\n                                if (note.start < partsInBar && (latestPinParts[Config.modCount - 1 - note.pitches[0]] == null || note.end > latestPinParts[Config.modCount - 1 - note.pitches[0]])) {\r\n                                    if (note.end <= partsInBar) {\r\n                                        latestPinParts[Config.modCount - 1 - note.pitches[0]] = note.end;\r\n                                        latestPinValues[Config.modCount - 1 - note.pitches[0]] = note.pins[note.pins.length - 1].size;\r\n                                    }\r\n                                    else {\r\n                                        latestPinParts[Config.modCount - 1 - note.pitches[0]] = partsInBar;\r\n                                        // Find the pin where bar change happens, and compute where pin volume would be at that time\r\n                                        for (let pinIdx = 0; pinIdx < note.pins.length; pinIdx++) {\r\n                                            if (note.pins[pinIdx].time + note.start > partsInBar) {\r\n                                                const transitionLength: number = note.pins[pinIdx].time - note.pins[pinIdx - 1].time;\r\n                                                const toNextBarLength: number = partsInBar - note.start - note.pins[pinIdx - 1].time;\r\n                                                const deltaVolume: number = note.pins[pinIdx].size - note.pins[pinIdx - 1].size;\r\n\r\n                                                latestPinValues[Config.modCount - 1 - note.pitches[0]] = Math.round(note.pins[pinIdx - 1].size + deltaVolume * toNextBarLength / transitionLength);\r\n                                                pinIdx = note.pins.length;\r\n                                            }\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n\r\n                            // Set modulator value, if it wasn't set in another pattern already scanned\r\n                            for (let mod: number = 0; mod < Config.modCount; mod++) {\r\n                                if (latestPinParts[mod] != null) {\r\n                                    if (Config.modulators[instrument.modulators[mod]].forSong) {\r\n                                        if (latestModTimes[instrument.modulators[mod]] == null || currentBar * Config.partsPerBeat * this.song.beatsPerBar + latestPinParts[mod] > (latestModTimes[instrument.modulators[mod]] as number)) {\r\n                                            this.setModValue(latestPinValues[mod], latestPinValues[mod], mod, instrument.modChannels[mod], instrument.modInstruments[mod], instrument.modulators[mod]);\r\n                                            latestModTimes[instrument.modulators[mod]] = currentBar * Config.partsPerBeat * this.song.beatsPerBar + latestPinParts[mod];\r\n                                        }\r\n                                    }\r\n                                    else {\r\n                                        // Generate list of used instruments\r\n                                        let usedInstruments: number[] = [];\r\n                                        // All\r\n                                        if (instrument.modInstruments[mod] == this.song.channels[instrument.modChannels[mod]].instruments.length) {\r\n                                            for (let i: number = 0; i < this.song.channels[instrument.modChannels[mod]].instruments.length; i++) {\r\n                                                usedInstruments.push(i);\r\n                                            }\r\n                                        }\r\n                                        // Active\r\n                                        else if (instrument.modInstruments[mod] > this.song.channels[instrument.modChannels[mod]].instruments.length) {\r\n                                            const tgtPattern: Pattern | null = this.song.getPattern(instrument.modChannels[mod], currentBar);\r\n                                            if (tgtPattern != null)\r\n                                                usedInstruments = tgtPattern.instruments;\r\n                                        } else {\r\n                                            usedInstruments.push(instrument.modInstruments[mod]);\r\n                                        }\r\n                                        for (let instrumentIndex: number = 0; instrumentIndex < usedInstruments.length; instrumentIndex++) {\r\n                                            // Iterate through all used instruments by this modulator\r\n                                            // Special indices for mod filter targets, since they control multiple things.\r\n                                            const eqFilterParam: boolean = instrument.modulators[mod] == Config.modulators.dictionary[\"eq filter\"].index;\r\n                                            const noteFilterParam: boolean = instrument.modulators[mod] == Config.modulators.dictionary[\"note filter\"].index\r\n                                            let modulatorAdjust: number = instrument.modulators[mod];\r\n                                            if (eqFilterParam) {\r\n                                                modulatorAdjust = Config.modulators.length + instrument.modFilterTypes[mod];\r\n                                            } else if (noteFilterParam) {\r\n                                                // Skip all possible indices for eq filter\r\n                                                modulatorAdjust = Config.modulators.length + 1 + (2 * Config.filterMaxPoints) + instrument.modFilterTypes[mod];\r\n                                            }\r\n\r\n                                            if (latestModInsTimes[instrument.modChannels[mod]][usedInstruments[instrumentIndex]][modulatorAdjust] == null\r\n                                                || currentBar * Config.partsPerBeat * this.song.beatsPerBar + latestPinParts[mod] > latestModInsTimes[instrument.modChannels[mod]][usedInstruments[instrumentIndex]][modulatorAdjust]!) {\r\n\r\n                                                if (eqFilterParam) {\r\n                                                    let tgtInstrument: Instrument = this.song.channels[instrument.modChannels[mod]].instruments[usedInstruments[instrumentIndex]];\r\n                                                    if (instrument.modFilterTypes[mod] == 0) {\r\n                                                        tgtInstrument.tmpEqFilterStart = tgtInstrument.eqSubFilters[latestPinValues[mod]];\r\n                                                    } else {\r\n                                                        for (let i: number = 0; i < Config.filterMorphCount; i++) {\r\n                                                            if (tgtInstrument.tmpEqFilterStart == tgtInstrument.eqSubFilters[i]) {\r\n                                                                tgtInstrument.tmpEqFilterStart = new FilterSettings();\r\n                                                                tgtInstrument.tmpEqFilterStart.fromJsonObject(tgtInstrument.eqSubFilters[i]!.toJsonObject());\r\n                                                                i = Config.filterMorphCount;\r\n                                                            }\r\n                                                        }\r\n                                                        if (Math.floor((instrument.modFilterTypes[mod] - 1) / 2) < tgtInstrument.tmpEqFilterStart!.controlPointCount) {\r\n                                                            if (instrument.modFilterTypes[mod] % 2)\r\n                                                                tgtInstrument.tmpEqFilterStart!.controlPoints[Math.floor((instrument.modFilterTypes[mod] - 1) / 2)].freq = latestPinValues[mod];\r\n                                                            else\r\n                                                                tgtInstrument.tmpEqFilterStart!.controlPoints[Math.floor((instrument.modFilterTypes[mod] - 1) / 2)].gain = latestPinValues[mod];\r\n                                                        }\r\n                                                    }\r\n                                                    tgtInstrument.tmpEqFilterEnd = tgtInstrument.tmpEqFilterStart;\r\n                                                } else if (noteFilterParam) {\r\n                                                    let tgtInstrument: Instrument = this.song.channels[instrument.modChannels[mod]].instruments[usedInstruments[instrumentIndex]];\r\n                                                    if (instrument.modFilterTypes[mod] == 0) {\r\n                                                        tgtInstrument.tmpNoteFilterStart = tgtInstrument.noteSubFilters[latestPinValues[mod]];\r\n                                                    } else {\r\n                                                        for (let i: number = 0; i < Config.filterMorphCount; i++) {\r\n                                                            if (tgtInstrument.tmpNoteFilterStart == tgtInstrument.noteSubFilters[i]) {\r\n                                                                tgtInstrument.tmpNoteFilterStart = new FilterSettings();\r\n                                                                tgtInstrument.tmpNoteFilterStart.fromJsonObject(tgtInstrument.noteSubFilters[i]!.toJsonObject());\r\n                                                                i = Config.filterMorphCount;\r\n                                                            }\r\n                                                        }\r\n                                                        if (Math.floor((instrument.modFilterTypes[mod] - 1) / 2) < tgtInstrument.tmpNoteFilterStart!.controlPointCount) {\r\n                                                            if (instrument.modFilterTypes[mod] % 2)\r\n                                                                tgtInstrument.tmpNoteFilterStart!.controlPoints[Math.floor((instrument.modFilterTypes[mod] - 1) / 2)].freq = latestPinValues[mod];\r\n                                                            else\r\n                                                                tgtInstrument.tmpNoteFilterStart!.controlPoints[Math.floor((instrument.modFilterTypes[mod] - 1) / 2)].gain = latestPinValues[mod];\r\n                                                        }\r\n                                                    }\r\n                                                    tgtInstrument.tmpNoteFilterEnd = tgtInstrument.tmpNoteFilterStart;\r\n                                                }\r\n                                                else this.setModValue(latestPinValues[mod], latestPinValues[mod], mod, instrument.modChannels[mod], usedInstruments[instrumentIndex], modulatorAdjust);\r\n\r\n                                                latestModInsTimes[instrument.modChannels[mod]][usedInstruments[instrumentIndex]][modulatorAdjust] = currentBar * Config.partsPerBeat * this.song.beatsPerBar + latestPinParts[mod];\r\n                                            }\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    // Detects if a modulator is set, but not valid for the current effects/instrument type/filter type\r\n    // Note, setting 'none' or the intermediary steps when clicking to add a mod, like an unset channel/unset instrument, counts as valid.\r\n    // TODO: This kind of check is mirrored in SongEditor.ts' whenUpdated. Creates a lot of redundancy for adding new mods. Can be moved into new properties for mods, to avoid this later.\r\n    public determineInvalidModulators(instrument: Instrument): void {\r\n        if (this.song == null)\r\n            return;\r\n        for (let mod: number = 0; mod < Config.modCount; mod++) {\r\n            instrument.invalidModulators[mod] = true;\r\n            // For song modulator, valid if any setting used\r\n            if (instrument.modChannels[mod] == -1) {\r\n                if (instrument.modulators[mod] != 0)\r\n                    instrument.invalidModulators[mod] = false;\r\n                continue;\r\n            }\r\n            const channel: Channel | null = this.song.channels[instrument.modChannels[mod]];\r\n            if (channel == null) continue;\r\n            let tgtInstrumentList: Instrument[] = [];\r\n            if (instrument.modInstruments[mod] >= channel.instruments.length) { // All or active\r\n                tgtInstrumentList = channel.instruments;\r\n            } else {\r\n                tgtInstrumentList = [channel.instruments[instrument.modInstruments[mod]]];\r\n            }\r\n            for (let i: number = 0; i < tgtInstrumentList.length; i++) {\r\n                const tgtInstrument: Instrument | null = tgtInstrumentList[i];\r\n                if (tgtInstrument == null) continue;\r\n                const str: string = Config.modulators[instrument.modulators[mod]].name;\r\n                // Check effects\r\n                if (!((Config.modulators[instrument.modulators[mod]].associatedEffect != EffectType.length && !(tgtInstrument.effects & (1 << Config.modulators[instrument.modulators[mod]].associatedEffect)))\r\n                    // Instrument type specific\r\n                    || (tgtInstrument.type != InstrumentType.fm && (str == \"fm slider 1\" || str == \"fm slider 2\" || str == \"fm slider 3\" || str == \"fm slider 4\" || str == \"fm feedback\"))\r\n                    || (tgtInstrument.type != InstrumentType.pwm && (str == \"pulse width\"))\r\n                    // Arp check\r\n                    || (!tgtInstrument.getChord().arpeggiates && (str == \"arp speed\" || str == \"reset arp\"))\r\n                    // EQ Filter check\r\n                    || (tgtInstrument.eqFilterType && str == \"eq filter\")\r\n                    || (!tgtInstrument.eqFilterType && (str == \"eq filt cut\" || str == \"eq filt peak\"))\r\n                    || (str == \"eq filter\" && Math.floor((instrument.modFilterTypes[mod] + 1) / 2) > tgtInstrument.eqFilter.controlPointCount)\r\n                    // Note Filter check\r\n                    || (tgtInstrument.noteFilterType && str == \"note filter\")\r\n                    || (!tgtInstrument.noteFilterType && (str == \"note filt cut\" || str == \"note filt peak\"))\r\n                    || (str == \"note filter\" && Math.floor((instrument.modFilterTypes[mod] + 1) / 2) > tgtInstrument.noteFilter.controlPointCount))) {\r\n\r\n                    instrument.invalidModulators[mod] = false;\r\n                    i = tgtInstrumentList.length;\r\n                }\r\n            }\r\n\r\n        }\r\n    }\r\n\r\n    private static operatorAmplitudeCurve(amplitude: number): number {\r\n        return (Math.pow(16.0, amplitude / 15.0) - 1.0) / 15.0;\r\n    }\r\n\r\n    public samplesPerSecond: number = 44100;\r\n    public panningDelayBufferSize: number;\r\n    public panningDelayBufferMask: number;\r\n    public chorusDelayBufferSize: number;\r\n    public chorusDelayBufferMask: number;\r\n    // TODO: reverb\r\n\r\n    public song: Song | null = null;\r\n    public preferLowerLatency: boolean = false; // enable when recording performances from keyboard or MIDI. Takes effect next time you activate audio.\r\n    public anticipatePoorPerformance: boolean = false; // enable on mobile devices to reduce audio stutter glitches. Takes effect next time you activate audio.\r\n    public liveInputDuration: number = 0;\r\n    public liveInputStarted: boolean = false;\r\n    public liveInputPitches: number[] = [];\r\n    public liveInputChannel: number = 0;\r\n    public liveInputInstruments: number[] = [];\r\n    public loopRepeatCount: number = -1;\r\n    public volume: number = 1.0;\r\n    public enableMetronome: boolean = false;\r\n    public countInMetronome: boolean = false;\r\n    public renderingSong: boolean = false;\r\n\r\n    private wantToSkip: boolean = false;\r\n    private playheadInternal: number = 0.0;\r\n    private bar: number = 0;\r\n    private prevBar: number | null = null;\r\n    private nextBar: number | null = null;\r\n    private beat: number = 0;\r\n    private part: number = 0;\r\n    private tick: number = 0;\r\n    public isAtStartOfTick: boolean = true;\r\n    public isAtEndOfTick: boolean = true;\r\n    public tickSampleCountdown: number = 0;\r\n    private modValues: (number | null)[] = [];\r\n    private modInsValues: (number | null)[][][] = [];\r\n    private nextModValues: (number | null)[] = [];\r\n    private nextModInsValues: (number | null)[][][] = [];\r\n    private isPlayingSong: boolean = false;\r\n    private isRecording: boolean = false;\r\n    private liveInputEndTime: number = 0.0;\r\n    private browserAutomaticallyClearsAudioBuffer: boolean = true; // Assume true until proven otherwise. Older Chrome does not clear the buffer so it needs to be cleared manually.\r\n\r\n    public static readonly tempFilterStartCoefficients: FilterCoefficients = new FilterCoefficients();\r\n    public static readonly tempFilterEndCoefficients: FilterCoefficients = new FilterCoefficients();\r\n    private tempDrumSetControlPoint: FilterControlPoint = new FilterControlPoint();\r\n    public tempFrequencyResponse: FrequencyResponse = new FrequencyResponse();\r\n\r\n    private static readonly fmSynthFunctionCache: Dictionary<Function> = {};\r\n    private static readonly effectsFunctionCache: Function[] = Array(1 << 7).fill(undefined); // keep in sync with the number of post-process effects.\r\n    private static readonly pickedStringFunctionCache: Function[] = Array(3).fill(undefined); // keep in sync with the number of unison voices.\r\n\r\n    private readonly channels: ChannelState[] = [];\r\n    private readonly tonePool: Deque<Tone> = new Deque<Tone>();\r\n    private readonly tempMatchedPitchTones: Array<Tone | null> = Array(Config.maxChordSize).fill(null);\r\n\r\n    private startedMetronome: boolean = false;\r\n    private metronomeSamplesRemaining: number = -1;\r\n    private metronomeAmplitude: number = 0.0;\r\n    private metronomePrevAmplitude: number = 0.0;\r\n    private metronomeFilter: number = 0.0;\r\n    private limit: number = 0.0;\r\n\r\n    private tempMonoInstrumentSampleBuffer: Float32Array | null = null;\r\n\r\n    private audioCtx: any | null = null;\r\n    private scriptNode: any | null = null;\r\n\r\n    public get playing(): boolean {\r\n        return this.isPlayingSong;\r\n    }\r\n\r\n    public get recording(): boolean {\r\n        return this.isRecording;\r\n    }\r\n\r\n    public get playhead(): number {\r\n        return this.playheadInternal;\r\n    }\r\n\r\n    public set playhead(value: number) {\r\n        if (this.song != null) {\r\n            this.playheadInternal = Math.max(0, Math.min(this.song.barCount, value));\r\n            let remainder: number = this.playheadInternal;\r\n            this.bar = Math.floor(remainder);\r\n            remainder = this.song.beatsPerBar * (remainder - this.bar);\r\n            this.beat = Math.floor(remainder);\r\n            remainder = Config.partsPerBeat * (remainder - this.beat);\r\n            this.part = Math.floor(remainder);\r\n            remainder = Config.ticksPerPart * (remainder - this.part);\r\n            this.tick = Math.floor(remainder);\r\n            this.tickSampleCountdown = 0;\r\n            this.isAtStartOfTick = true;\r\n            this.prevBar = null;\r\n        }\r\n    }\r\n\r\n    public getSamplesPerBar(): number {\r\n        if (this.song == null) throw new Error();\r\n        return this.getSamplesPerTick() * Config.ticksPerPart * Config.partsPerBeat * this.song.beatsPerBar;\r\n    }\r\n\r\n    public getTicksIntoBar(): number {\r\n        return (this.beat * Config.partsPerBeat + this.part) * Config.ticksPerPart + this.tick;\r\n    }\r\n    public getCurrentPart(): number {\r\n        return (this.beat * Config.partsPerBeat + this.part);\r\n    }\r\n\r\n    private findPartsInBar(bar: number): number {\r\n        if (this.song == null) return 0;\r\n        let partsInBar: number = Config.partsPerBeat * this.song.beatsPerBar;\r\n        for (let channel: number = this.song.pitchChannelCount + this.song.noiseChannelCount; channel < this.song.getChannelCount(); channel++) {\r\n            let pattern: Pattern | null = this.song.getPattern(channel, bar);\r\n            if (pattern != null) {\r\n                let instrument: Instrument = this.song.channels[channel].instruments[pattern.instruments[0]];\r\n                for (let mod: number = 0; mod < Config.modCount; mod++) {\r\n                    if (instrument.modulators[mod] == Config.modulators.dictionary[\"next bar\"].index) {\r\n                        for (const note of pattern.notes) {\r\n                            if (note.pitches[0] == (Config.modCount - 1 - mod)) {\r\n                                // Find the earliest next bar note.\r\n                                if (partsInBar > note.start)\r\n                                    partsInBar = note.start;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return partsInBar;\r\n    }\r\n\r\n    // Returns the total samples in the song\r\n    public getTotalSamples(enableIntro: boolean, enableOutro: boolean, loop: number): number {\r\n        if (this.song == null)\r\n            return -1;\r\n\r\n        // Compute the window to be checked (start bar to end bar)\r\n        let startBar: number = enableIntro ? 0 : this.song.loopStart;\r\n        let endBar: number = enableOutro ? this.song.barCount : (this.song.loopStart + this.song.loopLength);\r\n        let hasTempoMods: boolean = false;\r\n        let hasNextBarMods: boolean = false;\r\n        let prevTempo: number = this.song.tempo;\r\n\r\n        // Determine if any tempo or next bar mods happen anywhere in the window\r\n        for (let channel: number = this.song.pitchChannelCount + this.song.noiseChannelCount; channel < this.song.getChannelCount(); channel++) {\r\n            for (let bar: number = startBar; bar < endBar; bar++) {\r\n                let pattern: Pattern | null = this.song.getPattern(channel, bar);\r\n                if (pattern != null) {\r\n                    let instrument: Instrument = this.song.channels[channel].instruments[pattern.instruments[0]];\r\n                    for (let mod: number = 0; mod < Config.modCount; mod++) {\r\n                        if (instrument.modulators[mod] == Config.modulators.dictionary[\"tempo\"].index) {\r\n                            hasTempoMods = true;\r\n                        }\r\n                        if (instrument.modulators[mod] == Config.modulators.dictionary[\"next bar\"].index) {\r\n                            hasNextBarMods = true;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        // If intro is not zero length, determine what the \"entry\" tempo is going into the start part, by looking at mods that came before...\r\n        if (startBar > 0) {\r\n            let latestTempoPin: number | null = null;\r\n            let latestTempoValue: number = 0;\r\n\r\n            for (let bar: number = startBar - 1; bar >= 0; bar--) {\r\n                for (let channel: number = this.song.pitchChannelCount + this.song.noiseChannelCount; channel < this.song.getChannelCount(); channel++) {\r\n                    let pattern = this.song.getPattern(channel, bar);\r\n\r\n                    if (pattern != null) {\r\n                        let instrumentIdx: number = pattern.instruments[0];\r\n                        let instrument: Instrument = this.song.channels[channel].instruments[instrumentIdx];\r\n\r\n                        let partsInBar: number = this.findPartsInBar(bar);\r\n\r\n                        for (const note of pattern.notes) {\r\n                            if (instrument.modulators[Config.modCount - 1 - note.pitches[0]] == Config.modulators.dictionary[\"tempo\"].index) {\r\n                                if (note.start < partsInBar && (latestTempoPin == null || note.end > latestTempoPin)) {\r\n                                    if (note.end <= partsInBar) {\r\n                                        latestTempoPin = note.end;\r\n                                        latestTempoValue = note.pins[note.pins.length - 1].size;\r\n                                    }\r\n                                    else {\r\n                                        latestTempoPin = partsInBar;\r\n                                        // Find the pin where bar change happens, and compute where pin volume would be at that time\r\n                                        for (let pinIdx = 0; pinIdx < note.pins.length; pinIdx++) {\r\n                                            if (note.pins[pinIdx].time + note.start > partsInBar) {\r\n                                                const transitionLength: number = note.pins[pinIdx].time - note.pins[pinIdx - 1].time;\r\n                                                const toNextBarLength: number = partsInBar - note.start - note.pins[pinIdx - 1].time;\r\n                                                const deltaVolume: number = note.pins[pinIdx].size - note.pins[pinIdx - 1].size;\r\n\r\n                                                latestTempoValue = Math.round(note.pins[pinIdx - 1].size + deltaVolume * toNextBarLength / transitionLength);\r\n                                                pinIdx = note.pins.length;\r\n                                            }\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n\r\n                // Done once you process a pattern where tempo mods happened, since the search happens backward\r\n                if (latestTempoPin != null) {\r\n                    prevTempo = latestTempoValue + Config.modulators.dictionary[\"tempo\"].convertRealFactor;\r\n                    bar = -1;\r\n                }\r\n            }\r\n        }\r\n\r\n        if (hasTempoMods || hasNextBarMods) {\r\n            // Run from start bar to end bar and observe looping, computing average tempo across each bar\r\n            let bar: number = startBar;\r\n            let ended: boolean = false;\r\n            let totalSamples: number = 0;\r\n\r\n            while (!ended) {\r\n                // Compute the subsection of the pattern that will play\r\n                let partsInBar: number = Config.partsPerBeat * this.song.beatsPerBar;\r\n                let currentPart: number = 0;\r\n\r\n                if (hasNextBarMods) {\r\n                    partsInBar = this.findPartsInBar(bar);\r\n                }\r\n\r\n                // Compute average tempo in this tick window, or use last tempo if nothing happened\r\n                if (hasTempoMods) {\r\n                    let foundMod: boolean = false;\r\n                    for (let channel: number = this.song.pitchChannelCount + this.song.noiseChannelCount; channel < this.song.getChannelCount(); channel++) {\r\n                        if (foundMod == false) {\r\n                            let pattern: Pattern | null = this.song.getPattern(channel, bar);\r\n                            if (pattern != null) {\r\n                                let instrument: Instrument = this.song.channels[channel].instruments[pattern.instruments[0]];\r\n                                for (let mod: number = 0; mod < Config.modCount; mod++) {\r\n                                    if (foundMod == false && instrument.modulators[mod] == Config.modulators.dictionary[\"tempo\"].index\r\n                                        && pattern.notes.find(n => n.pitches[0] == (Config.modCount - 1 - mod))) {\r\n                                        // Only the first tempo mod instrument for this bar will be checked (well, the first with a note in this bar).\r\n                                        foundMod = true;\r\n                                        // Need to re-sort the notes by start time to make the next part much less painful.\r\n                                        pattern.notes.sort(function (a, b) { return (a.start == b.start) ? a.pitches[0] - b.pitches[0] : a.start - b.start; });\r\n                                        for (const note of pattern.notes) {\r\n                                            if (note.pitches[0] == (Config.modCount - 1 - mod)) {\r\n                                                // Compute samples up to this note\r\n                                                totalSamples += (Math.min(partsInBar - currentPart, note.start - currentPart)) * Config.ticksPerPart * this.getSamplesPerTickSpecificBPM(prevTempo);\r\n\r\n                                                if (note.start < partsInBar) {\r\n                                                    for (let pinIdx: number = 1; pinIdx < note.pins.length; pinIdx++) {\r\n                                                        // Compute samples up to this pin\r\n                                                        if (note.pins[pinIdx - 1].time + note.start <= partsInBar) {\r\n                                                            const tickLength: number = Config.ticksPerPart * Math.min(partsInBar - (note.start + note.pins[pinIdx - 1].time), note.pins[pinIdx].time - note.pins[pinIdx - 1].time);\r\n                                                            const prevPinTempo: number = note.pins[pinIdx - 1].size + Config.modulators.dictionary[\"tempo\"].convertRealFactor;\r\n                                                            let currPinTempo: number = note.pins[pinIdx].size + Config.modulators.dictionary[\"tempo\"].convertRealFactor;\r\n                                                            if (note.pins[pinIdx].time + note.start > partsInBar) {\r\n                                                                // Compute an intermediary tempo since bar changed over mid-pin. Maybe I'm deep in \"what if\" territory now!\r\n                                                                currPinTempo = note.pins[pinIdx - 1].size + (note.pins[pinIdx].size - note.pins[pinIdx - 1].size) * (partsInBar - (note.start + note.pins[pinIdx - 1].time)) / (note.pins[pinIdx].time - note.pins[pinIdx - 1].time) + Config.modulators.dictionary[\"tempo\"].convertRealFactor;\r\n                                                            }\r\n                                                            let bpmScalar: number = Config.partsPerBeat * Config.ticksPerPart / 60;\r\n\r\n                                                            if (currPinTempo != prevPinTempo) {\r\n\r\n                                                                // Definite integral of SamplesPerTick w/r/t beats to find total samples from start point to end point for a variable tempo\r\n                                                                // The starting formula is\r\n                                                                // SamplesPerTick = SamplesPerSec / ((PartsPerBeat * TicksPerPart) / SecPerMin) * BeatsPerMin )\r\n                                                                //\r\n                                                                // This is an expression of samples per tick \"instantaneously\", and it can be multiplied by a number of ticks to get a sample count.\r\n                                                                // But this isn't the full story. BeatsPerMin, e.g. tempo, changes throughout the interval so it has to be expressed in terms of ticks, \"t\"\r\n                                                                // ( Also from now on PartsPerBeat, TicksPerPart, and SecPerMin are combined into one scalar, called \"BPMScalar\" )\r\n                                                                // Substituting BPM for a step variable that moves with respect to the current tick, we get\r\n                                                                // SamplesPerTick = SamplesPerSec / (BPMScalar * ( (EndTempo - StartTempo / TickLength) * t + StartTempo ) )\r\n                                                                //\r\n                                                                // When this equation is integrated from 0 to TickLength with respect to t, we get the following expression:\r\n                                                                //   Samples = - SamplesPerSec * TickLength * ( log( BPMScalar * EndTempo * TickLength ) - log( BPMScalar * StartTempo * TickLength ) ) / BPMScalar * ( StartTempo - EndTempo )\r\n\r\n                                                                totalSamples += - this.samplesPerSecond * tickLength * (Math.log(bpmScalar * currPinTempo * tickLength) - Math.log(bpmScalar * prevPinTempo * tickLength)) / (bpmScalar * (prevPinTempo - currPinTempo));\r\n\r\n                                                            }\r\n                                                            else {\r\n\r\n                                                                // No tempo change between the two pins.\r\n                                                                totalSamples += tickLength * this.getSamplesPerTickSpecificBPM(currPinTempo);\r\n\r\n                                                            }\r\n                                                            prevTempo = currPinTempo;\r\n                                                        }\r\n                                                        currentPart = Math.min(note.start + note.pins[pinIdx].time, partsInBar);\r\n                                                    }\r\n                                                }\r\n                                            }\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n\r\n                // Compute samples for the rest of the bar\r\n                totalSamples += (partsInBar - currentPart) * Config.ticksPerPart * this.getSamplesPerTickSpecificBPM(prevTempo);\r\n\r\n                bar++;\r\n                if (loop != 0 && bar == this.song.loopStart + this.song.loopLength) {\r\n                    bar = this.song.loopStart;\r\n                    if (loop > 0) loop--;\r\n                }\r\n                if (bar >= endBar) {\r\n                    ended = true;\r\n                }\r\n            }\r\n\r\n            return Math.ceil(totalSamples);\r\n        }\r\n        else {\r\n            // No tempo or next bar mods... phew! Just calculate normally.\r\n            return this.getSamplesPerBar() * this.getTotalBars(enableIntro, enableOutro, loop);\r\n        }\r\n    }\r\n\r\n    public getTotalBars(enableIntro: boolean, enableOutro: boolean, useLoopCount: number = this.loopRepeatCount): number {\r\n        if (this.song == null) throw new Error();\r\n        let bars: number = this.song.loopLength * (useLoopCount + 1);\r\n        if (enableIntro) bars += this.song.loopStart;\r\n        if (enableOutro) bars += this.song.barCount - (this.song.loopStart + this.song.loopLength);\r\n        return bars;\r\n    }\r\n\r\n    constructor(song: Song | string | null = null) {\r\n        this.computeDelayBufferSizes();\r\n        if (song != null) this.setSong(song);\r\n    }\r\n\r\n    public setSong(song: Song | string): void {\r\n        if (typeof (song) == \"string\") {\r\n            this.song = new Song(song);\r\n        } else if (song instanceof Song) {\r\n            this.song = song;\r\n        }\r\n        this.prevBar = null;\r\n    }\r\n\r\n    private computeDelayBufferSizes(): void {\r\n        this.panningDelayBufferSize = Synth.fittingPowerOfTwo(this.samplesPerSecond * Config.panDelaySecondsMax);\r\n        this.panningDelayBufferMask = this.panningDelayBufferSize - 1;\r\n        this.chorusDelayBufferSize = Synth.fittingPowerOfTwo(this.samplesPerSecond * Config.chorusMaxDelay);\r\n        this.chorusDelayBufferMask = this.chorusDelayBufferSize - 1;\r\n    }\r\n\r\n    private activateAudio(): void {\r\n        const bufferSize: number = this.anticipatePoorPerformance ? (this.preferLowerLatency ? 2048 : 4096) : (this.preferLowerLatency ? 512 : 2048);\r\n        if (this.audioCtx == null || this.scriptNode == null || this.scriptNode.bufferSize != bufferSize) {\r\n            if (this.scriptNode != null) this.deactivateAudio();\r\n            const latencyHint: string = this.anticipatePoorPerformance ? (this.preferLowerLatency ? \"balanced\" : \"playback\") : (this.preferLowerLatency ? \"interactive\" : \"balanced\");\r\n            this.audioCtx = this.audioCtx || new (window.AudioContext || window.webkitAudioContext)({ latencyHint: latencyHint });\r\n            this.samplesPerSecond = this.audioCtx.sampleRate;\r\n            this.scriptNode = this.audioCtx.createScriptProcessor ? this.audioCtx.createScriptProcessor(bufferSize, 0, 2) : this.audioCtx.createJavaScriptNode(bufferSize, 0, 2); // bufferSize samples per callback buffer, 0 input channels, 2 output channels (left/right)\r\n            this.scriptNode.onaudioprocess = this.audioProcessCallback;\r\n            this.scriptNode.channelCountMode = 'explicit';\r\n            this.scriptNode.channelInterpretation = 'speakers';\r\n            this.scriptNode.connect(this.audioCtx.destination);\r\n\r\n            this.computeDelayBufferSizes();\r\n        }\r\n        this.audioCtx.resume();\r\n    }\r\n\r\n    public deactivateAudio(): void {\r\n        if (this.audioCtx != null && this.scriptNode != null) {\r\n            this.scriptNode.disconnect(this.audioCtx.destination);\r\n            this.scriptNode = null;\r\n            if (this.audioCtx.close) this.audioCtx.close(); // firefox is missing this function?\r\n            this.audioCtx = null;\r\n        }\r\n    }\r\n\r\n    public maintainLiveInput(): void {\r\n        this.activateAudio();\r\n        this.liveInputEndTime = performance.now() + 10000.0;\r\n    }\r\n\r\n    public play(): void {\r\n        if (this.isPlayingSong) return;\r\n        this.computeLatestModValues();\r\n        this.warmUpSynthesizer(this.song);\r\n        this.isPlayingSong = true;\r\n        this.activateAudio();\r\n    }\r\n\r\n    public pause(): void {\r\n        if (!this.isPlayingSong) return;\r\n        this.isPlayingSong = false;\r\n        this.isRecording = false;\r\n        this.modValues = [];\r\n        this.nextModValues = [];\r\n        if (this.song != null) {\r\n            this.song.inVolumeCap = 0.0;\r\n            this.song.outVolumeCap = 0.0;\r\n            for (let channelIndex: number = 0; channelIndex < this.song.pitchChannelCount + this.song.noiseChannelCount; channelIndex++) {\r\n                this.modInsValues[channelIndex] = [];\r\n                this.nextModInsValues[channelIndex] = [];\r\n            }\r\n        }\r\n    }\r\n\r\n    public startRecording(): void {\r\n        this.preferLowerLatency = true;\r\n        this.isRecording = true;\r\n        this.play();\r\n    }\r\n\r\n    public resetEffects(): void {\r\n        this.limit = 0.0;\r\n        this.freeAllTones();\r\n        if (this.song != null) {\r\n            for (const channelState of this.channels) {\r\n                for (const instrumentState of channelState.instruments) {\r\n                    instrumentState.resetAllEffects();\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    public setModValue(volumeStart: number, volumeEnd: number, mod: number, channelIndex: number, instrumentIndex: number, setting: number): number {\r\n        let val: number = volumeStart + Config.modulators[setting].convertRealFactor;\r\n        let nextVal: number = volumeEnd + Config.modulators[setting].convertRealFactor;\r\n        if (Config.modulators[setting].forSong) {\r\n            if (this.modValues[setting] == null || this.modValues[setting] != val || this.nextModValues[setting] != nextVal) {\r\n                this.modValues[setting] = val;\r\n                this.nextModValues[setting] = nextVal;\r\n            }\r\n        } else {\r\n            if (this.modInsValues[channelIndex][instrumentIndex][setting] == null\r\n                || this.modInsValues[channelIndex][instrumentIndex][setting] != val\r\n                || this.nextModInsValues[channelIndex][instrumentIndex][setting] != nextVal) {\r\n                this.modInsValues[channelIndex][instrumentIndex][setting] = val;\r\n                this.nextModInsValues[channelIndex][instrumentIndex][setting] = nextVal;\r\n            }\r\n        }\r\n\r\n        return val;\r\n    }\r\n\r\n    public getModValue(setting: number, channel?: number | null, instrument?: number | null, nextVal?: boolean): number {\r\n        const forSong: boolean = Config.modulators[setting].forSong;\r\n        if (forSong) {\r\n            if (this.modValues[setting] != null && this.nextModValues[setting] != null) {\r\n                return nextVal ? this.nextModValues[setting]! : this.modValues[setting]!;\r\n            }\r\n        } else if (channel != undefined && instrument != undefined) {\r\n            if (this.modInsValues[channel][instrument][setting] != null && this.nextModInsValues[channel][instrument][setting] != null) {\r\n                return nextVal ? this.nextModInsValues[channel][instrument][setting]! : this.modInsValues[channel][instrument][setting]!;\r\n            }\r\n        }\r\n        return -1;\r\n    }\r\n\r\n    // Checks if any mod is active for the given channel/instrument OR if any mod is active for the song scope. Could split the logic if needed later.\r\n    public isAnyModActive(channel: number, instrument: number): boolean {\r\n        for (let setting: number = 0; setting < Config.modulators.length; setting++) {\r\n            if ((this.modValues != undefined && this.modValues[setting] != null)\r\n                || (this.modInsValues != undefined && this.modInsValues[channel] != undefined && this.modInsValues[channel][instrument] != undefined && this.modInsValues[channel][instrument][setting] != null)) {\r\n                return true;\r\n            }\r\n        }\r\n        return false;\r\n    }\r\n\r\n    public unsetMod(setting: number, channel?: number, instrument?: number) {\r\n        if (this.isModActive(setting) || (channel != undefined && instrument != undefined && this.isModActive(setting, channel, instrument))) {\r\n            this.modValues[setting] = null;\r\n            this.nextModValues[setting] = null;\r\n            if (channel != undefined && instrument != undefined) {\r\n                this.modInsValues[channel][instrument][setting] = null;\r\n                this.nextModInsValues[channel][instrument][setting] = null;\r\n            }\r\n        }\r\n    }\r\n\r\n    public isFilterModActive(forNoteFilter: boolean, channelIdx: number, instrumentIdx: number) {\r\n        const instrument: Instrument = this.song!.channels[channelIdx].instruments[instrumentIdx];\r\n\r\n        if (forNoteFilter) {\r\n            if (instrument.noteFilterType)\r\n                return false;\r\n            if (instrument.tmpNoteFilterEnd != null)\r\n                return true;\r\n        }\r\n        else {\r\n            if (instrument.eqFilterType)\r\n                return false;\r\n            if (instrument.tmpEqFilterEnd != null)\r\n                return true;\r\n        }\r\n        return false\r\n    }\r\n\r\n    public isModActive(setting: number, channel?: number, instrument?: number): boolean {\r\n        const forSong: boolean = Config.modulators[setting].forSong;\r\n        if (forSong) {\r\n            return (this.modValues != undefined && this.modValues[setting] != null);\r\n        } else if (channel != undefined && instrument != undefined && this.modInsValues != undefined && this.modInsValues[channel] != null && this.modInsValues[channel][instrument] != null) {\r\n            return (this.modInsValues[channel][instrument][setting] != null);\r\n        }\r\n        return false;\r\n    }\r\n\r\n    public snapToStart(): void {\r\n        this.bar = 0;\r\n        this.resetEffects();\r\n        this.snapToBar();\r\n    }\r\n\r\n    public goToBar(bar: number): void {\r\n        this.bar = bar;\r\n        this.resetEffects();\r\n        this.playheadInternal = this.bar;\r\n    }\r\n\r\n    public snapToBar(): void {\r\n        this.playheadInternal = this.bar;\r\n        this.beat = 0;\r\n        this.part = 0;\r\n        this.tick = 0;\r\n        this.tickSampleCountdown = 0;\r\n    }\r\n\r\n    public jumpIntoLoop(): void {\r\n        if (!this.song) return;\r\n        if (this.bar < this.song.loopStart || this.bar >= this.song.loopStart + this.song.loopLength) {\r\n            const oldBar: number = this.bar;\r\n            this.bar = this.song.loopStart;\r\n            this.playheadInternal += this.bar - oldBar;\r\n\r\n            if (this.playing)\r\n                this.computeLatestModValues();\r\n        }\r\n    }\r\n\r\n    public goToNextBar(): void {\r\n        if (!this.song) return;\r\n        this.prevBar = this.bar;\r\n        const oldBar: number = this.bar;\r\n        this.bar++;\r\n        if (this.bar >= this.song.barCount) {\r\n            this.bar = 0;\r\n        }\r\n        this.playheadInternal += this.bar - oldBar;\r\n\r\n        if (this.playing)\r\n            this.computeLatestModValues();\r\n    }\r\n\r\n    public goToPrevBar(): void {\r\n        if (!this.song) return;\r\n        this.prevBar = null;\r\n        const oldBar: number = this.bar;\r\n        this.bar--;\r\n        if (this.bar < 0 || this.bar >= this.song.barCount) {\r\n            this.bar = this.song.barCount - 1;\r\n        }\r\n        this.playheadInternal += this.bar - oldBar;\r\n\r\n        if (this.playing)\r\n            this.computeLatestModValues();\r\n    }\r\n\r\n    private getNextBar(): number {\r\n        let nextBar: number = this.bar + 1;\r\n        if (this.isRecording) {\r\n            if (nextBar >= this.song!.barCount) {\r\n                nextBar = this.song!.barCount - 1;\r\n            }\r\n        } else if (this.loopRepeatCount != 0 && nextBar == this.song!.loopStart + this.song!.loopLength) {\r\n            nextBar = this.song!.loopStart;\r\n        }\r\n        return nextBar;\r\n    }\r\n\r\n    public skipBar(): void {\r\n        if (!this.song) return;\r\n        const samplesPerTick: number = this.getSamplesPerTick();\r\n        this.bar++;\r\n        this.beat = 0;\r\n        this.part = 0;\r\n        this.tick = 0;\r\n        this.tickSampleCountdown = samplesPerTick;\r\n        this.isAtStartOfTick = true;\r\n\r\n        if (this.loopRepeatCount != 0 && this.bar == this.song.loopStart + this.song.loopLength) {\r\n            this.bar = this.song.loopStart;\r\n            if (this.loopRepeatCount > 0) this.loopRepeatCount--;\r\n        }\r\n\r\n    }\r\n\r\n    private audioProcessCallback = (audioProcessingEvent: any): void => {\r\n        const outputBuffer = audioProcessingEvent.outputBuffer;\r\n        const outputDataL: Float32Array = outputBuffer.getChannelData(0);\r\n        const outputDataR: Float32Array = outputBuffer.getChannelData(1);\r\n\r\n        if (this.browserAutomaticallyClearsAudioBuffer && (outputDataL[0] != 0.0 || outputDataR[0] != 0.0 || outputDataL[outputBuffer.length - 1] != 0.0 || outputDataR[outputBuffer.length - 1] != 0.0)) {\r\n            // If the buffer is ever initially nonzero, then this must be an older browser that doesn't automatically clear the audio buffer.\r\n            this.browserAutomaticallyClearsAudioBuffer = false;\r\n        }\r\n        if (!this.browserAutomaticallyClearsAudioBuffer) {\r\n            // If this browser does not clear the buffer automatically, do so manually before continuing.\r\n            const length: number = outputBuffer.length;\r\n            for (let i: number = 0; i < length; i++) {\r\n                outputDataL[i] = 0.0;\r\n                outputDataR[i] = 0.0;\r\n            }\r\n        }\r\n        \r\n        // Off music on page switch \r\n        const tmp_splitted = window.location.href.split('/');\r\n        const tmp_last = tmp_splitted[tmp_splitted.length - 1];\r\n        if (tmp_last != \"music-generator\"){\r\n            this.deactivateAudio();\r\n        }\r\n\r\n        if (!this.isPlayingSong && performance.now() >= this.liveInputEndTime) {\r\n            this.deactivateAudio();\r\n        } else {\r\n            this.synthesize(outputDataL, outputDataR, outputBuffer.length, this.isPlayingSong);\r\n        }\r\n    }\r\n\r\n    public synthesize(outputDataL: Float32Array, outputDataR: Float32Array, outputBufferLength: number, playSong: boolean = true): void {\r\n        if (this.song == null) {\r\n            for (let i: number = 0; i < outputBufferLength; i++) {\r\n                outputDataL[i] = 0.0;\r\n                outputDataR[i] = 0.0;\r\n            }\r\n            this.deactivateAudio();\r\n            return;\r\n        }\r\n\r\n        const song: Song = this.song;\r\n        this.song.inVolumeCap = 0.0 // Reset volume cap for this run\r\n        this.song.outVolumeCap = 0.0;\r\n\r\n        let samplesPerTick: number = this.getSamplesPerTick();\r\n        let ended: boolean = false;\r\n\r\n        // Check the bounds of the playhead:\r\n        if (this.tickSampleCountdown <= 0 || this.tickSampleCountdown > samplesPerTick) {\r\n            this.tickSampleCountdown = samplesPerTick;\r\n            this.isAtStartOfTick = true;\r\n        }\r\n        if (playSong) {\r\n            if (this.beat >= song.beatsPerBar) {\r\n                this.beat = 0;\r\n                this.part = 0;\r\n                this.tick = 0;\r\n                this.tickSampleCountdown = samplesPerTick;\r\n                this.isAtStartOfTick = true;\r\n\r\n                this.prevBar = this.bar;\r\n                this.bar = this.getNextBar();\r\n                if (this.bar <= this.prevBar && this.loopRepeatCount > 0) this.loopRepeatCount--;\r\n\r\n            }\r\n            if (this.bar >= song.barCount) {\r\n                this.bar = 0;\r\n                if (this.loopRepeatCount != -1) {\r\n                    ended = true;\r\n                    this.pause();\r\n                }\r\n            }\r\n        }\r\n\r\n        //const synthStartTime: number = performance.now();\r\n\r\n        this.syncSongState();\r\n\r\n        if (this.tempMonoInstrumentSampleBuffer == null || this.tempMonoInstrumentSampleBuffer.length < outputBufferLength) {\r\n            this.tempMonoInstrumentSampleBuffer = new Float32Array(outputBufferLength);\r\n        }\r\n\r\n        // Post processing parameters:\r\n        const volume: number = +this.volume;\r\n        const limitDecay: number = 1.0 - Math.pow(0.5, 4.0 / this.samplesPerSecond);\r\n        const limitRise: number = 1.0 - Math.pow(0.5, 4000.0 / this.samplesPerSecond);\r\n        let limit: number = +this.limit;\r\n        let skippedBars: number[] = [];\r\n        let firstSkippedBufferIndex: number = -1;\r\n\r\n        let bufferIndex: number = 0;\r\n        while (bufferIndex < outputBufferLength && !ended) {\r\n            this.nextBar = this.getNextBar();\r\n            if (this.nextBar >= song.barCount) this.nextBar = null;\r\n\r\n            const samplesLeftInBuffer: number = outputBufferLength - bufferIndex;\r\n            const samplesLeftInTick: number = Math.ceil(this.tickSampleCountdown);\r\n            const runLength: number = Math.min(samplesLeftInTick, samplesLeftInBuffer);\r\n            const runEnd: number = bufferIndex + runLength;\r\n            \r\n            // Handle mod synth\r\n            if (this.isPlayingSong || this.renderingSong) {\r\n                for (let channelIndex: number = song.pitchChannelCount + song.noiseChannelCount; channelIndex < song.getChannelCount(); channelIndex++) {\r\n                    const channel: Channel = song.channels[channelIndex];\r\n                    const channelState: ChannelState = this.channels[channelIndex];\r\n\r\n                    this.determineCurrentActiveTones(song, channelIndex, samplesPerTick, playSong);\r\n\r\n                    for (let instrumentIndex: number = 0; instrumentIndex < channel.instruments.length; instrumentIndex++) {\r\n                        const instrumentState: InstrumentState = channelState.instruments[instrumentIndex];\r\n\r\n                        for (let i: number = 0; i < instrumentState.activeModTones.count(); i++) {\r\n                            const tone: Tone = instrumentState.activeModTones.get(i);\r\n                            this.playModTone(song, channelIndex, samplesPerTick, bufferIndex, runLength, tone, false, false);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            // Handle next bar mods if they were set\r\n            if (this.wantToSkip) {\r\n                // Unable to continue, as we have skipped back to a previously visited bar without generating new samples, which means we are infinitely skipping.\r\n                // In this case processing will return before the designated number of samples are processed. In other words, silence will be generated.\r\n                let barVisited: boolean = skippedBars.includes(this.bar);\r\n                if (barVisited && bufferIndex == firstSkippedBufferIndex)\r\n                    return;\r\n                if (firstSkippedBufferIndex == -1) {\r\n                    firstSkippedBufferIndex = bufferIndex;\r\n                }\r\n                if (!barVisited)\r\n                    skippedBars.push(this.bar);\r\n                \r\n                this.wantToSkip = false;\r\n                this.skipBar();\r\n                continue;\r\n            }\r\n\r\n            for (let channelIndex: number = 0; channelIndex < song.pitchChannelCount + song.noiseChannelCount; channelIndex++) {\r\n                const channel: Channel = song.channels[channelIndex];\r\n                const channelState: ChannelState = this.channels[channelIndex];\r\n\r\n                if (this.isAtStartOfTick) {\r\n                    this.determineCurrentActiveTones(song, channelIndex, samplesPerTick, playSong && !this.countInMetronome);\r\n                    this.determineLiveInputTones(song, channelIndex, samplesPerTick);\r\n                }\r\n                for (let instrumentIndex: number = 0; instrumentIndex < channel.instruments.length; instrumentIndex++) {\r\n                    const instrument: Instrument = channel.instruments[instrumentIndex];\r\n                    const instrumentState: InstrumentState = channelState.instruments[instrumentIndex];\r\n\r\n                    if (this.isAtStartOfTick) {\r\n                        let tonesPlayedInThisInstrument: number = instrumentState.activeTones.count() + instrumentState.liveInputTones.count();\r\n\r\n                        for (let i: number = 0; i < instrumentState.releasedTones.count(); i++) {\r\n                            const tone: Tone = instrumentState.releasedTones.get(i);\r\n                            if (tone.ticksSinceReleased >= Math.abs(instrument.getFadeOutTicks())) {\r\n                                this.freeReleasedTone(instrumentState, i);\r\n                                i--;\r\n                                continue;\r\n                            }\r\n                            const shouldFadeOutFast: boolean = (tonesPlayedInThisInstrument >= Config.maximumTonesPerChannel);\r\n                            this.computeTone(song, channelIndex, samplesPerTick, tone, true, shouldFadeOutFast);\r\n                            tonesPlayedInThisInstrument++;\r\n                        }\r\n\r\n                        if (instrumentState.awake) {\r\n                            if (!instrumentState.computed) {\r\n                                instrumentState.compute(this, instrument, samplesPerTick, Math.ceil(samplesPerTick), null, channelIndex, instrumentIndex);\r\n                            }\r\n\r\n                            instrumentState.computed = false;\r\n                            //instrumentState.envelopeComputer.clearEnvelopes();\r\n                        }\r\n                    }\r\n\r\n                    for (let i: number = 0; i < instrumentState.activeTones.count(); i++) {\r\n                        const tone: Tone = instrumentState.activeTones.get(i);\r\n                        this.playTone(channelIndex, bufferIndex, runLength, tone);\r\n                    }\r\n\r\n                    for (let i: number = 0; i < instrumentState.liveInputTones.count(); i++) {\r\n                        const tone: Tone = instrumentState.liveInputTones.get(i);\r\n                        this.playTone(channelIndex, bufferIndex, runLength, tone);\r\n                    }\r\n\r\n                    for (let i: number = 0; i < instrumentState.releasedTones.count(); i++) {\r\n                        const tone: Tone = instrumentState.releasedTones.get(i);\r\n                        this.playTone(channelIndex, bufferIndex, runLength, tone);\r\n                    }\r\n\r\n                    if (instrumentState.awake) {\r\n                        Synth.effectsSynth(this, outputDataL, outputDataR, bufferIndex, runLength, instrumentState);\r\n                    }\r\n\r\n                    // Update LFO time for instruments (used to be deterministic based on bar position but now vibrato/arp speed messes that up!)\r\n\r\n                    const tickSampleCountdown: number = this.tickSampleCountdown;\r\n                    const startRatio: number = 1.0 - (tickSampleCountdown) / samplesPerTick;\r\n                    const endRatio: number = 1.0 - (tickSampleCountdown - runLength) / samplesPerTick;\r\n                    const ticksIntoBar: number = (this.beat * Config.partsPerBeat + this.part) * Config.ticksPerPart + this.tick;\r\n                    const partTimeTickStart: number = (ticksIntoBar) / Config.ticksPerPart;\r\n                    const partTimeTickEnd: number = (ticksIntoBar + 1) / Config.ticksPerPart;\r\n                    const partTimeStart: number = partTimeTickStart + (partTimeTickEnd - partTimeTickStart) * startRatio;\r\n                    const partTimeEnd: number = partTimeTickStart + (partTimeTickEnd - partTimeTickStart) * endRatio;\r\n                    let useVibratoSpeed: number = instrument.vibratoSpeed;\r\n\r\n                    instrument.LFOtime = instrument.nextLFOtime;\r\n\r\n                    if (this.isModActive(Config.modulators.dictionary[\"vibrato speed\"].index, channelIndex, instrumentIndex)) {\r\n                        useVibratoSpeed = this.getModValue(Config.modulators.dictionary[\"vibrato speed\"].index, channelIndex, instrumentIndex);\r\n                    }\r\n\r\n                    if (useVibratoSpeed == 0) {\r\n                        instrument.LFOtime = 0;\r\n                        instrument.nextLFOtime = 0;\r\n                    }\r\n                    else {\r\n                        instrument.nextLFOtime += useVibratoSpeed * 0.1 * (partTimeEnd - partTimeStart);\r\n                    }\r\n                }\r\n            }\r\n\r\n            if (this.enableMetronome || this.countInMetronome) {\r\n                if (this.part == 0) {\r\n                    if (!this.startedMetronome) {\r\n                        const midBeat: boolean = (song.beatsPerBar > 4 && (song.beatsPerBar % 2 == 0) && this.beat == song.beatsPerBar / 2);\r\n                        const periods: number = (this.beat == 0) ? 8 : midBeat ? 6 : 4;\r\n                        const hz: number = (this.beat == 0) ? 1600 : midBeat ? 1200 : 800;\r\n                        const amplitude: number = (this.beat == 0) ? 0.06 : midBeat ? 0.05 : 0.04;\r\n                        const samplesPerPeriod: number = this.samplesPerSecond / hz;\r\n                        const radiansPerSample: number = Math.PI * 2.0 / samplesPerPeriod;\r\n                        this.metronomeSamplesRemaining = Math.floor(samplesPerPeriod * periods);\r\n                        this.metronomeFilter = 2.0 * Math.cos(radiansPerSample);\r\n                        this.metronomeAmplitude = amplitude * Math.sin(radiansPerSample);\r\n                        this.metronomePrevAmplitude = 0.0;\r\n\r\n                        this.startedMetronome = true;\r\n                    }\r\n                    if (this.metronomeSamplesRemaining > 0) {\r\n                        const stopIndex: number = Math.min(runEnd, bufferIndex + this.metronomeSamplesRemaining);\r\n                        this.metronomeSamplesRemaining -= stopIndex - bufferIndex;\r\n                        for (let i: number = bufferIndex; i < stopIndex; i++) {\r\n                            outputDataL[i] += this.metronomeAmplitude;\r\n                            outputDataR[i] += this.metronomeAmplitude;\r\n                            const tempAmplitude: number = this.metronomeFilter * this.metronomeAmplitude - this.metronomePrevAmplitude;\r\n                            this.metronomePrevAmplitude = this.metronomeAmplitude;\r\n                            this.metronomeAmplitude = tempAmplitude;\r\n                        }\r\n                    }\r\n                } else {\r\n                    this.startedMetronome = false;\r\n                }\r\n            }\r\n\r\n            // Post processing:\r\n            for (let i: number = bufferIndex; i < runEnd; i++) {\r\n                // A compressor/limiter.\r\n                const sampleL = outputDataL[i] * song.masterGain * song.masterGain;\r\n                const sampleR = outputDataR[i] * song.masterGain * song.masterGain;\r\n                const absL: number = sampleL < 0.0 ? -sampleL : sampleL;\r\n                const absR: number = sampleR < 0.0 ? -sampleR : sampleR;\r\n                const abs: number = absL > absR ? absL : absR;\r\n                this.song.inVolumeCap = (this.song.inVolumeCap > abs ? this.song.inVolumeCap : abs); // Analytics, spit out raw input volume\r\n                // Determines which formula to use. 0 when volume is between [0, compressionThreshold], 1 when between (compressionThreshold, limitThreshold], 2 above\r\n                const limitRange: number = (+(abs > song.compressionThreshold)) + (+(abs > song.limitThreshold));\r\n                // Determine the target amplification based on the range of the curve\r\n                const limitTarget: number =\r\n                    (+(limitRange == 0)) * (((abs + 1 - song.compressionThreshold) * 0.8 + 0.25) * song.compressionRatio + 1.05 * (1 - song.compressionRatio))\r\n                    + (+(limitRange == 1)) * (1.05)\r\n                    + (+(limitRange == 2)) * (1.05 * ((abs + 1 - song.limitThreshold) * song.limitRatio + (1 - song.limitThreshold)));\r\n                // Move the limit towards the target\r\n                limit += ((limitTarget - limit) * (limit < limitTarget ? limitRise : limitDecay));\r\n                const limitedVolume = volume / (limit >= 1 ? limit * 1.05 : limit * 0.8 + 0.25);\r\n                outputDataL[i] = sampleL * limitedVolume;\r\n                outputDataR[i] = sampleR * limitedVolume;\r\n\r\n                this.song.outVolumeCap = (this.song.outVolumeCap > abs * limitedVolume ? this.song.outVolumeCap : abs * limitedVolume); // Analytics, spit out limited output volume\r\n            }\r\n\r\n            bufferIndex += runLength;\r\n\r\n            this.isAtStartOfTick = false;\r\n            this.tickSampleCountdown -= runLength;\r\n            if (this.tickSampleCountdown <= 0) {\r\n                this.isAtStartOfTick = true;\r\n\r\n                // Track how long tones have been released, and free them if there are too many.\r\n                // Also reset awake InstrumentStates that didn't have any Tones during this tick.\r\n                for (const channelState of this.channels) {\r\n                    for (const instrumentState of channelState.instruments) {\r\n                        for (let i: number = 0; i < instrumentState.releasedTones.count(); i++) {\r\n                            const tone: Tone = instrumentState.releasedTones.get(i);\r\n                            if (tone.isOnLastTick) {\r\n                                this.freeReleasedTone(instrumentState, i);\r\n                                i--;\r\n                            } else {\r\n                                tone.ticksSinceReleased++;\r\n                            }\r\n                        }\r\n                        if (instrumentState.deactivateAfterThisTick) {\r\n                            instrumentState.deactivate();\r\n                        }\r\n                        instrumentState.tonesAddedInThisTick = false;\r\n                    }\r\n                }\r\n\r\n                // Update arpeggio time, which is used to calculate arpeggio position\r\n                for (let channel: number = 0; channel < this.song.pitchChannelCount + this.song.noiseChannelCount; channel++) {\r\n                    for (let instrumentIdx: number = 0; instrumentIdx < this.song.channels[channel].instruments.length; instrumentIdx++) {\r\n                        let instrument: Instrument = this.song.channels[channel].instruments[instrumentIdx];\r\n                        let useArpeggioSpeed: number = instrument.arpeggioSpeed;\r\n                        if (this.isModActive(Config.modulators.dictionary[\"arp speed\"].index, channel, instrumentIdx)) {\r\n                            useArpeggioSpeed = this.getModValue(Config.modulators.dictionary[\"arp speed\"].index, channel, instrumentIdx, false);\r\n                            if (Number.isInteger(useArpeggioSpeed)) {\r\n                                instrument.arpTime += Config.arpSpeedScale[useArpeggioSpeed];\r\n                            } else {\r\n                                // Linear interpolate arpeggio values\r\n                                instrument.arpTime += (1 - (useArpeggioSpeed % 1)) * Config.arpSpeedScale[Math.floor(useArpeggioSpeed)] + (useArpeggioSpeed % 1) * Config.arpSpeedScale[Math.ceil(useArpeggioSpeed)];\r\n                            }\r\n                        }\r\n                        else {\r\n                            instrument.arpTime += Config.arpSpeedScale[useArpeggioSpeed];\r\n                        }\r\n                    }\r\n                }\r\n\r\n                // Update next-used filters after each run\r\n                for (let channel: number = 0; channel < this.song.pitchChannelCount + this.song.noiseChannelCount; channel++) {\r\n                    for (let instrumentIdx: number = 0; instrumentIdx < this.song.channels[channel].instruments.length; instrumentIdx++) {\r\n                        let instrument: Instrument = this.song.channels[channel].instruments[instrumentIdx];\r\n                        if (instrument.tmpEqFilterEnd != null) {\r\n                            instrument.tmpEqFilterStart = instrument.tmpEqFilterEnd;\r\n                        } else {\r\n                            instrument.tmpEqFilterStart = instrument.eqFilter;\r\n                        }\r\n                        if (instrument.tmpNoteFilterEnd != null) {\r\n                            instrument.tmpNoteFilterStart = instrument.tmpNoteFilterEnd;\r\n                        } else {\r\n                            instrument.tmpNoteFilterStart = instrument.noteFilter;\r\n                        }\r\n                    }\r\n                }\r\n\r\n                this.tick++;\r\n                this.tickSampleCountdown += samplesPerTick;\r\n                if (this.tick == Config.ticksPerPart) {\r\n                    this.tick = 0;\r\n                    this.part++;\r\n                    this.liveInputDuration--;\r\n\r\n                    if (this.part == Config.partsPerBeat) {\r\n                        this.part = 0;\r\n\r\n                        if (playSong) {\r\n                            this.beat++;\r\n                            if (this.beat == song.beatsPerBar) {\r\n                                // bar changed, reset for next bar:\r\n                                this.beat = 0;\r\n\r\n                                if (this.countInMetronome) {\r\n                                    this.countInMetronome = false;\r\n                                } else {\r\n                                    this.prevBar = this.bar;\r\n                                    this.bar = this.getNextBar();\r\n                                    if (this.bar <= this.prevBar && this.loopRepeatCount > 0) this.loopRepeatCount--;\r\n\r\n                                    if (this.bar >= song.barCount) {\r\n                                        this.bar = 0;\r\n                                        if (this.loopRepeatCount != -1) {\r\n                                            ended = true;\r\n                                            this.resetEffects();\r\n                                            this.pause();\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            // Update mod values so that next values copy to current values\r\n            for (let setting: number = 0; setting < Config.modulators.length; setting++) {\r\n                if (this.nextModValues != null && this.nextModValues[setting] != null)\r\n                    this.modValues[setting] = this.nextModValues[setting];\r\n            }\r\n\r\n            // Set samples per tick if song tempo mods changed it\r\n            if (this.isModActive(Config.modulators.dictionary[\"tempo\"].index)) {\r\n                samplesPerTick = this.getSamplesPerTick();\r\n                this.tickSampleCountdown = Math.min(this.tickSampleCountdown, samplesPerTick);\r\n            }\r\n\r\n            // Bound LFO times to be within their period (to keep values from getting large)\r\n            // I figured this modulo math probably doesn't have to happen every LFO tick.\r\n            for (let channel: number = 0; channel < this.song.pitchChannelCount; channel++) {\r\n                for (let instrument of this.song.channels[channel].instruments) {\r\n                    instrument.nextLFOtime = (instrument.nextLFOtime % (Config.vibratoTypes[instrument.vibratoType].period / (Config.ticksPerPart * samplesPerTick / this.samplesPerSecond)));\r\n                    instrument.arpTime = (instrument.arpTime % (2520 * Config.ticksPerArpeggio)); // 2520 = LCM of 4, 5, 6, 7, 8, 9 (arp sizes)\r\n                }\r\n            }\r\n\r\n            for (let setting: number = 0; setting < Config.modulators.length; setting++) {\r\n                for (let channel: number = 0; channel < this.song.pitchChannelCount + this.song.noiseChannelCount; channel++) {\r\n                    for (let instrument: number = 0; instrument < this.song.getMaxInstrumentsPerChannel(); instrument++) {\r\n                        if (this.nextModInsValues != null && this.nextModInsValues[channel] != null && this.nextModInsValues[channel][instrument] != null && this.nextModInsValues[channel][instrument][setting] != null) {\r\n                            this.modInsValues[channel][instrument][setting] = this.nextModInsValues[channel][instrument][setting];\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        // Optimization: Avoid persistent reverb values in the float denormal range.\r\n        if (!Number.isFinite(limit) || Math.abs(limit) < epsilon) limit = 0.0;\r\n        this.limit = limit;\r\n\r\n        if (playSong && !this.countInMetronome) {\r\n            this.playheadInternal = (((this.tick + 1.0 - this.tickSampleCountdown / samplesPerTick) / 2.0 + this.part) / Config.partsPerBeat + this.beat) / song.beatsPerBar + this.bar;\r\n        }\r\n\r\n        /*\r\n        const synthDuration: number = performance.now() - synthStartTime;\r\n        // Performance measurements:\r\n        samplesAccumulated += outputBufferLength;\r\n        samplePerformance += synthDuration;\r\n    \t\r\n        if (samplesAccumulated >= 44100 * 4) {\r\n            const secondsGenerated = samplesAccumulated / 44100;\r\n            const secondsRequired = samplePerformance / 1000;\r\n            const ratio = secondsRequired / secondsGenerated;\r\n            console.log(ratio);\r\n            samplePerformance = 0;\r\n            samplesAccumulated = 0;\r\n        }\r\n        */\r\n    }\r\n\r\n    private freeTone(tone: Tone): void {\r\n        this.tonePool.pushBack(tone);\r\n    }\r\n\r\n    private newTone(): Tone {\r\n        if (this.tonePool.count() > 0) {\r\n            const tone: Tone = this.tonePool.popBack();\r\n            tone.freshlyAllocated = true;\r\n            return tone;\r\n        }\r\n        return new Tone();\r\n    }\r\n\r\n    private releaseTone(instrumentState: InstrumentState, tone: Tone): void {\r\n        instrumentState.releasedTones.pushFront(tone);\r\n        tone.atNoteStart = false;\r\n        tone.passedEndOfNote = true;\r\n    }\r\n\r\n    private freeReleasedTone(instrumentState: InstrumentState, toneIndex: number): void {\r\n        this.freeTone(instrumentState.releasedTones.get(toneIndex));\r\n        instrumentState.releasedTones.remove(toneIndex);\r\n    }\r\n\r\n    public freeAllTones(): void {\r\n        for (const channelState of this.channels) {\r\n            for (const instrumentState of channelState.instruments) {\r\n                while (instrumentState.activeTones.count() > 0) this.freeTone(instrumentState.activeTones.popBack());\r\n                while (instrumentState.activeModTones.count() > 0) this.freeTone(instrumentState.activeModTones.popBack());\r\n                while (instrumentState.releasedTones.count() > 0) this.freeTone(instrumentState.releasedTones.popBack());\r\n                while (instrumentState.liveInputTones.count() > 0) this.freeTone(instrumentState.liveInputTones.popBack());\r\n            }\r\n        }\r\n    }\r\n\r\n    private determineLiveInputTones(song: Song, channelIndex: number, samplesPerTick: number): void {\r\n        const channel: Channel = song.channels[channelIndex];\r\n        const channelState: ChannelState = this.channels[channelIndex];\r\n        const pitches: number[] = this.liveInputPitches;\r\n\r\n        for (let instrumentIndex: number = 0; instrumentIndex < channel.instruments.length; instrumentIndex++) {\r\n            const instrumentState: InstrumentState = channelState.instruments[instrumentIndex];\r\n            const toneList: Deque<Tone> = instrumentState.liveInputTones;\r\n            let toneCount: number = 0;\r\n            if (this.liveInputDuration > 0 && channelIndex == this.liveInputChannel && pitches.length > 0 && this.liveInputInstruments.indexOf(instrumentIndex) != -1) {\r\n                const instrument: Instrument = channel.instruments[instrumentIndex];\r\n\r\n                if (instrument.getChord().singleTone) {\r\n                    let tone: Tone;\r\n                    if (toneList.count() <= toneCount) {\r\n                        tone = this.newTone();\r\n                        toneList.pushBack(tone);\r\n                    } else if (!instrument.getTransition().isSeamless && this.liveInputStarted) {\r\n                        this.releaseTone(instrumentState, toneList.get(toneCount));\r\n                        tone = this.newTone();\r\n                        toneList.set(toneCount, tone);\r\n                    } else {\r\n                        tone = toneList.get(toneCount);\r\n                    }\r\n                    toneCount++;\r\n\r\n                    for (let i: number = 0; i < pitches.length; i++) {\r\n                        tone.pitches[i] = pitches[i];\r\n                    }\r\n                    tone.pitchCount = pitches.length;\r\n                    tone.chordSize = 1;\r\n                    tone.instrumentIndex = instrumentIndex;\r\n                    tone.note = tone.prevNote = tone.nextNote = null;\r\n                    tone.atNoteStart = this.liveInputStarted;\r\n                    tone.forceContinueAtStart = false;\r\n                    tone.forceContinueAtEnd = false;\r\n                    this.computeTone(song, channelIndex, samplesPerTick, tone, false, false);\r\n                } else {\r\n                    //const transition: Transition = instrument.getTransition();\r\n\r\n                    this.moveTonesIntoOrderedTempMatchedList(toneList, pitches);\r\n\r\n                    for (let i: number = 0; i < pitches.length; i++) {\r\n                        //const strumOffsetParts: number = i * instrument.getChord().strumParts;\r\n\r\n                        let tone: Tone;\r\n                        if (this.tempMatchedPitchTones[toneCount] != null) {\r\n                            tone = this.tempMatchedPitchTones[toneCount]!;\r\n                            this.tempMatchedPitchTones[toneCount] = null;\r\n                            if (tone.pitchCount != 1 || tone.pitches[0] != pitches[i]) {\r\n                                this.releaseTone(instrumentState, tone);\r\n                                tone = this.newTone();\r\n                            }\r\n                            toneList.pushBack(tone);\r\n                        } else {\r\n                            tone = this.newTone();\r\n                            toneList.pushBack(tone);\r\n                        }\r\n                        toneCount++;\r\n\r\n                        tone.pitches[0] = pitches[i];\r\n                        tone.pitchCount = 1;\r\n                        tone.chordSize = pitches.length;\r\n                        tone.instrumentIndex = instrumentIndex;\r\n                        tone.note = tone.prevNote = tone.nextNote = null;\r\n                        tone.atNoteStart = this.liveInputStarted;\r\n                        tone.forceContinueAtStart = false;\r\n                        tone.forceContinueAtEnd = false;\r\n                        this.computeTone(song, channelIndex, samplesPerTick, tone, false, false);\r\n                    }\r\n                }\r\n            }\r\n\r\n            while (toneList.count() > toneCount) {\r\n                this.releaseTone(instrumentState, toneList.popBack());\r\n            }\r\n\r\n            this.clearTempMatchedPitchTones(toneCount, instrumentState);\r\n        }\r\n\r\n        this.liveInputStarted = false;\r\n    }\r\n\r\n    // Returns the chord type of the instrument in the adjacent pattern if it is compatible for a\r\n    // seamless transition across patterns, otherwise returns null.\r\n    private adjacentPatternHasCompatibleInstrumentTransition(song: Song, channel: Channel, pattern: Pattern, otherPattern: Pattern, instrumentIndex: number, transition: Transition, chord: Chord, note: Note, otherNote: Note, forceContinue: boolean): Chord | null {\r\n        if (song.patternInstruments && otherPattern.instruments.indexOf(instrumentIndex) == -1) {\r\n            // The adjacent pattern does not contain the same instrument as the current pattern.\r\n\r\n            if (pattern.instruments.length > 1 || otherPattern.instruments.length > 1) {\r\n                // The current or adjacent pattern contains more than one instrument, don't bother\r\n                // trying to connect them.\r\n                return null;\r\n            }\r\n            // Otherwise, the two patterns each contain one instrument, but not the same instrument.\r\n            // Try to connect them.\r\n            const otherInstrument: Instrument = channel.instruments[otherPattern.instruments[0]];\r\n\r\n            if (forceContinue) {\r\n                // Even non-seamless instruments can be connected across patterns if forced.\r\n                return otherInstrument.getChord();\r\n            }\r\n\r\n            // Otherwise, check that both instruments are seamless across patterns.\r\n            const otherTransition: Transition = otherInstrument.getTransition();\r\n            if (transition.includeAdjacentPatterns && otherTransition.includeAdjacentPatterns && otherTransition.slides == transition.slides) {\r\n                return otherInstrument.getChord();\r\n            } else {\r\n                return null;\r\n            }\r\n        } else {\r\n            // If both patterns contain the same instrument, check that it is seamless across patterns.\r\n            return (forceContinue || transition.includeAdjacentPatterns) ? chord : null;\r\n        }\r\n    }\r\n\r\n    public static adjacentNotesHaveMatchingPitches(firstNote: Note, secondNote: Note): boolean {\r\n        if (firstNote.pitches.length != secondNote.pitches.length) return false;\r\n        const firstNoteInterval: number = firstNote.pins[firstNote.pins.length - 1].interval;\r\n        for (const pitch of firstNote.pitches) {\r\n            if (secondNote.pitches.indexOf(pitch + firstNoteInterval) == -1) return false;\r\n        }\r\n        return true;\r\n    }\r\n\r\n    private moveTonesIntoOrderedTempMatchedList(toneList: Deque<Tone>, notePitches: number[]): void {\r\n        // The tones are about to seamlessly transition to a new note. The pitches\r\n        // from the old note may or may not match any of the pitches in the new\r\n        // note, and not necessarily in order, but if any do match, they'll sound\r\n        // better if those tones continue to have the same pitch. Attempt to find\r\n        // the right spot for each old tone in the new chord if possible.\r\n\r\n        for (let i: number = 0; i < toneList.count(); i++) {\r\n            const tone: Tone = toneList.get(i);\r\n            const pitch: number = tone.pitches[0] + tone.lastInterval;\r\n            for (let j: number = 0; j < notePitches.length; j++) {\r\n                if (notePitches[j] == pitch) {\r\n                    this.tempMatchedPitchTones[j] = tone;\r\n                    toneList.remove(i);\r\n                    i--;\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n\r\n        // Any tones that didn't get matched should just fill in the gaps.\r\n        while (toneList.count() > 0) {\r\n            const tone: Tone = toneList.popFront();\r\n            for (let j: number = 0; j < this.tempMatchedPitchTones.length; j++) {\r\n                if (this.tempMatchedPitchTones[j] == null) {\r\n                    this.tempMatchedPitchTones[j] = tone;\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    private determineCurrentActiveTones(song: Song, channelIndex: number, samplesPerTick: number, playSong: boolean): void {\r\n        const channel: Channel = song.channels[channelIndex];\r\n        const channelState: ChannelState = this.channels[channelIndex];\r\n        const pattern: Pattern | null = song.getPattern(channelIndex, this.bar);\r\n        const currentPart: number = this.getCurrentPart();\r\n        const currentTick: number = this.tick + Config.ticksPerPart * currentPart;\r\n\r\n        if (playSong && song.getChannelIsMod(channelIndex)) {\r\n\r\n            // For mod channels, notes aren't strictly arranged chronologically. Also, each pitch value could play or not play at a given time. So... a bit more computation involved!\r\n            // The same transition logic should apply though, even though it isn't really used by mod channels.\r\n            let notes: (Note | null)[] = [];\r\n            let prevNotes: (Note | null)[] = [];\r\n            let nextNotes: (Note | null)[] = [];\r\n            let fillCount: number = Config.modCount;\r\n            while (fillCount--) {\r\n                notes.push(null);\r\n                prevNotes.push(null);\r\n                nextNotes.push(null);\r\n            }\r\n\r\n            if (pattern != null && !channel.muted) {\r\n                for (let i: number = 0; i < pattern.notes.length; i++) {\r\n                    if (pattern.notes[i].end <= currentPart) {\r\n                        // Actually need to check which note starts closer to the start of this note.\r\n                        if (prevNotes[pattern.notes[i].pitches[0]] == null || pattern.notes[i].end > (prevNotes[pattern.notes[i].pitches[0]] as Note).start) {\r\n                            prevNotes[pattern.notes[i].pitches[0]] = pattern.notes[i];\r\n                        }\r\n                    }\r\n                    else if (pattern.notes[i].start <= currentPart && pattern.notes[i].end > currentPart) {\r\n                        notes[pattern.notes[i].pitches[0]] = pattern.notes[i];\r\n                    }\r\n                    else if (pattern.notes[i].start > currentPart) {\r\n                        // Actually need to check which note starts closer to the end of this note.\r\n                        if (nextNotes[pattern.notes[i].pitches[0]] == null || pattern.notes[i].start < (nextNotes[pattern.notes[i].pitches[0]] as Note).start) {\r\n                            nextNotes[pattern.notes[i].pitches[0]] = pattern.notes[i];\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            let modToneCount: number = 0;\r\n            const newInstrumentIndex: number = (song.patternInstruments && (pattern != null)) ? pattern!.instruments[0] : 0;\r\n            const instrumentState: InstrumentState = channelState.instruments[newInstrumentIndex];\r\n            const toneList: Deque<Tone> = instrumentState.activeModTones;\r\n            for (let mod: number = 0; mod < Config.modCount; mod++) {\r\n                if (notes[mod] != null) {\r\n                    if (prevNotes[mod] != null && (prevNotes[mod] as Note).end != (notes[mod] as Note).start) prevNotes[mod] = null;\r\n                    if (nextNotes[mod] != null && (nextNotes[mod] as Note).start != (notes[mod] as Note).end) nextNotes[mod] = null;\r\n\r\n                }\r\n\r\n                if (channelState.singleSeamlessInstrument != null && channelState.singleSeamlessInstrument != newInstrumentIndex && channelState.singleSeamlessInstrument < channelState.instruments.length) {\r\n                    const sourceInstrumentState: InstrumentState = channelState.instruments[channelState.singleSeamlessInstrument];\r\n                    const destInstrumentState: InstrumentState = channelState.instruments[newInstrumentIndex];\r\n                    while (sourceInstrumentState.activeModTones.count() > 0) {\r\n                        destInstrumentState.activeModTones.pushFront(sourceInstrumentState.activeModTones.popBack());\r\n                    }\r\n                }\r\n                channelState.singleSeamlessInstrument = newInstrumentIndex;\r\n\r\n                if (notes[mod] != null) {\r\n                    let prevNoteForThisInstrument: Note | null = prevNotes[mod];\r\n                    let nextNoteForThisInstrument: Note | null = nextNotes[mod];\r\n\r\n                    let forceContinueAtStart: boolean = false;\r\n                    let forceContinueAtEnd: boolean = false;\r\n                    const atNoteStart: boolean = (Config.ticksPerPart * notes[mod]!.start == currentTick) && this.isAtStartOfTick;\r\n                    let tone: Tone;\r\n                    if (toneList.count() <= modToneCount) {\r\n                        tone = this.newTone();\r\n                        toneList.pushBack(tone);\r\n                    } else if (atNoteStart && (prevNoteForThisInstrument == null)) {\r\n                        const oldTone: Tone = toneList.get(modToneCount);\r\n                        if (oldTone.isOnLastTick) {\r\n                            this.freeTone(oldTone);\r\n                        } else {\r\n                            this.releaseTone(instrumentState, oldTone);\r\n                        }\r\n                        tone = this.newTone();\r\n                        toneList.set(modToneCount, tone);\r\n                    } else {\r\n                        tone = toneList.get(modToneCount);\r\n                    }\r\n                    modToneCount++;\r\n\r\n                    for (let i: number = 0; i < notes[mod]!.pitches.length; i++) {\r\n                        tone.pitches[i] = notes[mod]!.pitches[i];\r\n                    }\r\n                    tone.pitchCount = notes[mod]!.pitches.length;\r\n                    tone.chordSize = 1;\r\n                    tone.instrumentIndex = newInstrumentIndex;\r\n                    tone.note = notes[mod];\r\n                    tone.noteStartPart = notes[mod]!.start;\r\n                    tone.noteEndPart = notes[mod]!.end;\r\n                    tone.prevNote = prevNoteForThisInstrument;\r\n                    tone.nextNote = nextNoteForThisInstrument;\r\n                    tone.prevNotePitchIndex = 0;\r\n                    tone.nextNotePitchIndex = 0;\r\n                    tone.atNoteStart = atNoteStart;\r\n                    tone.passedEndOfNote = false;\r\n                    tone.forceContinueAtStart = forceContinueAtStart;\r\n                    tone.forceContinueAtEnd = forceContinueAtEnd;\r\n                }\r\n            }\r\n            // Automatically free or release seamless tones if there's no new note to take over.\r\n            while (toneList.count() > modToneCount) {\r\n                const tone: Tone = toneList.popBack();\r\n                const channel: Channel = song.channels[channelIndex];\r\n                if (tone.instrumentIndex < channel.instruments.length && !tone.isOnLastTick) {\r\n                    const instrumentState: InstrumentState = this.channels[channelIndex].instruments[tone.instrumentIndex];\r\n                    this.releaseTone(instrumentState, tone);\r\n                } else {\r\n                    this.freeTone(tone);\r\n                }\r\n            }\r\n\r\n        }\r\n        else if (!song.getChannelIsMod(channelIndex)) {\r\n\r\n            let note: Note | null = null;\r\n            let prevNote: Note | null = null;\r\n            let nextNote: Note | null = null;\r\n\r\n            if (playSong && pattern != null && !channel.muted && (!this.isRecording || this.liveInputChannel != channelIndex)) {\r\n                for (let i: number = 0; i < pattern.notes.length; i++) {\r\n                    if (pattern.notes[i].end <= currentPart) {\r\n                        prevNote = pattern.notes[i];\r\n                    } else if (pattern.notes[i].start <= currentPart && pattern.notes[i].end > currentPart) {\r\n                        note = pattern.notes[i];\r\n                    } else if (pattern.notes[i].start > currentPart) {\r\n                        nextNote = pattern.notes[i];\r\n                        break;\r\n                    }\r\n                }\r\n\r\n                if (note != null) {\r\n                    if (prevNote != null && prevNote.end != note.start) prevNote = null;\r\n                    if (nextNote != null && nextNote.start != note.end) nextNote = null;\r\n                }\r\n            }\r\n\r\n            // Seamless tones from a pattern with a single instrument can be transferred to a different single seamless instrument in the next pattern.\r\n            if (pattern != null && (!song.layeredInstruments || channel.instruments.length == 1 || (song.patternInstruments && pattern.instruments.length == 1))) {\r\n                const newInstrumentIndex: number = song.patternInstruments ? pattern.instruments[0] : 0;\r\n                if (channelState.singleSeamlessInstrument != null && channelState.singleSeamlessInstrument != newInstrumentIndex && channelState.singleSeamlessInstrument < channelState.instruments.length) {\r\n                    const sourceInstrumentState: InstrumentState = channelState.instruments[channelState.singleSeamlessInstrument];\r\n                    const destInstrumentState: InstrumentState = channelState.instruments[newInstrumentIndex];\r\n                    while (sourceInstrumentState.activeTones.count() > 0) {\r\n                        destInstrumentState.activeTones.pushFront(sourceInstrumentState.activeTones.popBack());\r\n                    }\r\n                }\r\n                channelState.singleSeamlessInstrument = newInstrumentIndex;\r\n            } else {\r\n                channelState.singleSeamlessInstrument = null;\r\n            }\r\n\r\n            for (let instrumentIndex: number = 0; instrumentIndex < channel.instruments.length; instrumentIndex++) {\r\n                const instrumentState: InstrumentState = channelState.instruments[instrumentIndex];\r\n                const toneList: Deque<Tone> = instrumentState.activeTones;\r\n                let toneCount: number = 0;\r\n                if ((note != null) && (!song.patternInstruments || (pattern!.instruments.indexOf(instrumentIndex) != -1))) {\r\n                    const instrument: Instrument = channel.instruments[instrumentIndex];\r\n                    let prevNoteForThisInstrument: Note | null = prevNote;\r\n                    let nextNoteForThisInstrument: Note | null = nextNote;\r\n\r\n                    const partsPerBar: Number = Config.partsPerBeat * song.beatsPerBar;\r\n                    const transition: Transition = instrument.getTransition();\r\n                    const chord: Chord = instrument.getChord();\r\n                    let forceContinueAtStart: boolean = false;\r\n                    let forceContinueAtEnd: boolean = false;\r\n                    let tonesInPrevNote: number = 0;\r\n                    let tonesInNextNote: number = 0;\r\n                    if (note.start == 0) {\r\n                        // If the beginning of the note coincides with the beginning of the pattern,\r\n                        let prevPattern: Pattern | null = (this.prevBar == null) ? null : song.getPattern(channelIndex, this.prevBar);\r\n                        if (prevPattern != null) {\r\n                            const lastNote: Note | null = (prevPattern.notes.length <= 0) ? null : prevPattern.notes[prevPattern.notes.length - 1];\r\n                            if (lastNote != null && lastNote.end == partsPerBar) {\r\n                                const patternForcesContinueAtStart: boolean = note.continuesLastPattern && Synth.adjacentNotesHaveMatchingPitches(lastNote, note);\r\n                                const chordOfCompatibleInstrument: Chord | null = this.adjacentPatternHasCompatibleInstrumentTransition(song, channel, pattern!, prevPattern, instrumentIndex, transition, chord, note, lastNote, patternForcesContinueAtStart);\r\n                                if (chordOfCompatibleInstrument != null) {\r\n                                    prevNoteForThisInstrument = lastNote;\r\n                                    tonesInPrevNote = chordOfCompatibleInstrument.singleTone ? 1 : prevNoteForThisInstrument.pitches.length\r\n                                    forceContinueAtStart = patternForcesContinueAtStart;\r\n                                }\r\n                            }\r\n                        }\r\n                    } else if (prevNoteForThisInstrument != null) {\r\n                        tonesInPrevNote = chord.singleTone ? 1 : prevNoteForThisInstrument.pitches.length\r\n                    }\r\n                    if (note.end == partsPerBar) {\r\n                        // If the end of the note coincides with the end of the pattern, look for an\r\n                        // adjacent note at the beginning of the next pattern.\r\n                        let nextPattern: Pattern | null = (this.nextBar == null) ? null : song.getPattern(channelIndex, this.nextBar);\r\n                        if (nextPattern != null) {\r\n                            const firstNote: Note | null = (nextPattern.notes.length <= 0) ? null : nextPattern.notes[0];\r\n                            if (firstNote != null && firstNote.start == 0) {\r\n                                const nextPatternForcesContinueAtStart: boolean = firstNote.continuesLastPattern && Synth.adjacentNotesHaveMatchingPitches(note, firstNote);\r\n                                const chordOfCompatibleInstrument: Chord | null = this.adjacentPatternHasCompatibleInstrumentTransition(song, channel, pattern!, nextPattern, instrumentIndex, transition, chord, note, firstNote, nextPatternForcesContinueAtStart);\r\n                                if (chordOfCompatibleInstrument != null) {\r\n                                    nextNoteForThisInstrument = firstNote;\r\n                                    tonesInNextNote = chordOfCompatibleInstrument.singleTone ? 1 : nextNoteForThisInstrument.pitches.length\r\n                                    forceContinueAtEnd = nextPatternForcesContinueAtStart;\r\n                                }\r\n                            }\r\n                        }\r\n                    } else if (nextNoteForThisInstrument != null) {\r\n                        tonesInNextNote = chord.singleTone ? 1 : nextNoteForThisInstrument.pitches.length\r\n                    }\r\n\r\n                    if (chord.singleTone) {\r\n                        const atNoteStart: boolean = (Config.ticksPerPart * note.start == currentTick);\r\n                        let tone: Tone;\r\n                        if (toneList.count() <= toneCount) {\r\n                            tone = this.newTone();\r\n                            toneList.pushBack(tone);\r\n                        } else if (atNoteStart && ((!(transition.isSeamless || instrument.clicklessTransition) && !forceContinueAtStart) || prevNoteForThisInstrument == null)) {\r\n                            const oldTone: Tone = toneList.get(toneCount);\r\n                            if (oldTone.isOnLastTick) {\r\n                                this.freeTone(oldTone);\r\n                            } else {\r\n                                this.releaseTone(instrumentState, oldTone);\r\n                            }\r\n                            tone = this.newTone();\r\n                            toneList.set(toneCount, tone);\r\n                        } else {\r\n                            tone = toneList.get(toneCount);\r\n                        }\r\n                        toneCount++;\r\n\r\n                        for (let i: number = 0; i < note.pitches.length; i++) {\r\n                            tone.pitches[i] = note.pitches[i];\r\n                        }\r\n                        tone.pitchCount = note.pitches.length;\r\n                        tone.chordSize = 1;\r\n                        tone.instrumentIndex = instrumentIndex;\r\n                        tone.note = note;\r\n                        tone.noteStartPart = note.start;\r\n                        tone.noteEndPart = note.end;\r\n                        tone.prevNote = prevNoteForThisInstrument;\r\n                        tone.nextNote = nextNoteForThisInstrument;\r\n                        tone.prevNotePitchIndex = 0;\r\n                        tone.nextNotePitchIndex = 0;\r\n                        tone.atNoteStart = atNoteStart;\r\n                        tone.passedEndOfNote = false;\r\n                        tone.forceContinueAtStart = forceContinueAtStart;\r\n                        tone.forceContinueAtEnd = forceContinueAtEnd;\r\n                        this.computeTone(song, channelIndex, samplesPerTick, tone, false, false);\r\n                    } else {\r\n                        const transition: Transition = instrument.getTransition();\r\n\r\n                        if (((transition.isSeamless && !transition.slides && chord.strumParts == 0) || forceContinueAtStart) && (Config.ticksPerPart * note.start == currentTick) && prevNoteForThisInstrument != null) {\r\n                            this.moveTonesIntoOrderedTempMatchedList(toneList, note.pitches);\r\n                        }\r\n\r\n                        let strumOffsetParts: number = 0;\r\n                        for (let i: number = 0; i < note.pitches.length; i++) {\r\n\r\n                            let prevNoteForThisTone: Note | null = (tonesInPrevNote > i) ? prevNoteForThisInstrument : null;\r\n                            let noteForThisTone: Note = note;\r\n                            let nextNoteForThisTone: Note | null = (tonesInNextNote > i) ? nextNoteForThisInstrument : null;\r\n                            let noteStartPart: number = noteForThisTone.start + strumOffsetParts;\r\n                            let passedEndOfNote: boolean = false;\r\n\r\n                            // Strumming may mean that a note's actual start time may be after the\r\n                            // note's displayed start time. If the note start hasn't been reached yet,\r\n                            // carry over the previous tone if available and seamless, otherwise skip\r\n                            // the new tone until it is ready to start.\r\n                            if (noteStartPart > currentPart) {\r\n                                if (toneList.count() > i && (transition.isSeamless || forceContinueAtStart) && prevNoteForThisTone != null) {\r\n                                    // Continue the previous note's chord until the current one takes over.\r\n                                    nextNoteForThisTone = noteForThisTone;\r\n                                    noteForThisTone = prevNoteForThisTone;\r\n                                    prevNoteForThisTone = null;\r\n                                    noteStartPart = noteForThisTone.start + strumOffsetParts;\r\n                                    passedEndOfNote = true;\r\n                                } else {\r\n                                    // This and the rest of the tones in the chord shouldn't start yet.\r\n                                    break;\r\n                                }\r\n                            }\r\n\r\n                            let noteEndPart: number = noteForThisTone.end;\r\n                            if ((transition.isSeamless || forceContinueAtStart) && nextNoteForThisTone != null) {\r\n                                noteEndPart = Math.min(Config.partsPerBeat * this.song!.beatsPerBar, noteEndPart + strumOffsetParts);\r\n                            }\r\n                            if ((!transition.continues && !forceContinueAtStart) || prevNoteForThisTone == null) {\r\n                                strumOffsetParts += chord.strumParts;\r\n                            }\r\n\r\n                            const atNoteStart: boolean = (Config.ticksPerPart * noteStartPart == currentTick);\r\n                            let tone: Tone;\r\n                            if (this.tempMatchedPitchTones[toneCount] != null) {\r\n                                tone = this.tempMatchedPitchTones[toneCount]!;\r\n                                this.tempMatchedPitchTones[toneCount] = null;\r\n                                toneList.pushBack(tone);\r\n                            } else if (toneList.count() <= toneCount) {\r\n                                tone = this.newTone();\r\n                                toneList.pushBack(tone);\r\n                            } else if (atNoteStart && ((!transition.isSeamless && !forceContinueAtStart) || prevNoteForThisTone == null)) {\r\n                                const oldTone: Tone = toneList.get(toneCount);\r\n                                if (oldTone.isOnLastTick) {\r\n                                    this.freeTone(oldTone);\r\n                                } else {\r\n                                    this.releaseTone(instrumentState, oldTone);\r\n                                }\r\n                                tone = this.newTone();\r\n                                toneList.set(toneCount, tone);\r\n                            } else {\r\n                                tone = toneList.get(toneCount);\r\n                            }\r\n                            toneCount++;\r\n\r\n                            tone.pitches[0] = noteForThisTone.pitches[i];\r\n                            tone.pitchCount = 1;\r\n                            tone.chordSize = noteForThisTone.pitches.length;\r\n                            tone.instrumentIndex = instrumentIndex;\r\n                            tone.note = noteForThisTone;\r\n                            tone.noteStartPart = noteStartPart;\r\n                            tone.noteEndPart = noteEndPart;\r\n                            tone.prevNote = prevNoteForThisTone;\r\n                            tone.nextNote = nextNoteForThisTone;\r\n                            tone.prevNotePitchIndex = i;\r\n                            tone.nextNotePitchIndex = i;\r\n                            tone.atNoteStart = atNoteStart;\r\n                            tone.passedEndOfNote = passedEndOfNote;\r\n                            tone.forceContinueAtStart = forceContinueAtStart && prevNoteForThisTone != null;\r\n                            tone.forceContinueAtEnd = forceContinueAtEnd && nextNoteForThisTone != null;\r\n                            this.computeTone(song, channelIndex, samplesPerTick, tone, false, false);\r\n                        }\r\n                    }\r\n                }\r\n                // Automatically free or release seamless tones if there's no new note to take over.\r\n                while (toneList.count() > toneCount) {\r\n                    const tone: Tone = toneList.popBack();\r\n                    const channel: Channel = song.channels[channelIndex];\r\n                    if (tone.instrumentIndex < channel.instruments.length && !tone.isOnLastTick) {\r\n                        const instrumentState: InstrumentState = channelState.instruments[tone.instrumentIndex];\r\n                        this.releaseTone(instrumentState, tone);\r\n                    } else {\r\n                        this.freeTone(tone);\r\n                    }\r\n                }\r\n\r\n                this.clearTempMatchedPitchTones(toneCount, instrumentState);\r\n            }\r\n        }\r\n    }\r\n\r\n    private clearTempMatchedPitchTones(toneCount: number, instrumentState: InstrumentState): void {\r\n        for (let i: number = toneCount; i < this.tempMatchedPitchTones.length; i++) {\r\n            const oldTone: Tone | null = this.tempMatchedPitchTones[i];\r\n            if (oldTone != null) {\r\n                if (oldTone.isOnLastTick) {\r\n                    this.freeTone(oldTone);\r\n                } else {\r\n                    this.releaseTone(instrumentState, oldTone);\r\n                }\r\n                this.tempMatchedPitchTones[i] = null;\r\n            }\r\n        }\r\n    }\r\n\r\n\r\n    private playTone(channelIndex: number, bufferIndex: number, runLength: number, tone: Tone): void {\r\n        const channelState: ChannelState = this.channels[channelIndex];\r\n        const instrumentState: InstrumentState = channelState.instruments[tone.instrumentIndex];\r\n\r\n        if (instrumentState.synthesizer != null) instrumentState.synthesizer!(this, bufferIndex, runLength, tone, instrumentState);\r\n        tone.envelopeComputer.clearEnvelopes();\r\n    }\r\n\r\n    // Computes mod note position at the start and end of the window and \"plays\" the mod tone, setting appropriate mod data.\r\n    private playModTone(song: Song, channelIndex: number, samplesPerTick: number, bufferIndex: number, roundedSamplesPerTick: number, tone: Tone, released: boolean, shouldFadeOutFast: boolean): void {\r\n        const channel: Channel = song.channels[channelIndex];\r\n        const instrument: Instrument = channel.instruments[tone.instrumentIndex];\r\n\r\n        if (tone.note != null) {\r\n            const ticksIntoBar: number = this.getTicksIntoBar();\r\n            const partTimeTickStart: number = (ticksIntoBar) / Config.ticksPerPart;\r\n            const partTimeTickEnd: number = (ticksIntoBar + 1) / Config.ticksPerPart;\r\n            const tickSampleCountdown: number = this.tickSampleCountdown;\r\n            const startRatio: number = 1.0 - (tickSampleCountdown) / samplesPerTick;\r\n            const endRatio: number = 1.0 - (tickSampleCountdown - roundedSamplesPerTick) / samplesPerTick;\r\n            const partTimeStart: number = partTimeTickStart + (partTimeTickEnd - partTimeTickStart) * startRatio;\r\n            const partTimeEnd: number = partTimeTickStart + (partTimeTickEnd - partTimeTickStart) * endRatio;\r\n            const tickTimeStart: number = Config.ticksPerPart * partTimeStart;\r\n            const tickTimeEnd: number = Config.ticksPerPart * partTimeEnd;\r\n            const endPinIndex: number = tone.note.getEndPinIndex(this.getCurrentPart());\r\n            const startPin: NotePin = tone.note.pins[endPinIndex - 1];\r\n            const endPin: NotePin = tone.note.pins[endPinIndex];\r\n            const startPinTick: number = (tone.note.start + startPin.time) * Config.ticksPerPart;\r\n            const endPinTick: number = (tone.note.start + endPin.time) * Config.ticksPerPart;\r\n            const ratioStart: number = (tickTimeStart - startPinTick) / (endPinTick - startPinTick);\r\n            const ratioEnd: number = (tickTimeEnd - startPinTick) / (endPinTick - startPinTick);\r\n            tone.expression = startPin.size + (endPin.size - startPin.size) * ratioStart;\r\n            tone.expressionDelta = (startPin.size + (endPin.size - startPin.size) * ratioEnd) - tone.expression;\r\n\r\n            Synth.modSynth(this, bufferIndex, roundedSamplesPerTick, tone, instrument);\r\n        }\r\n    }\r\n\r\n    private static computeChordExpression(chordSize: number): number {\r\n        return 1.0 / ((chordSize - 1) * 0.25 + 1.0);\r\n    }\r\n\r\n    private computeTone(song: Song, channelIndex: number, samplesPerTick: number, tone: Tone, released: boolean, shouldFadeOutFast: boolean): void {\r\n        const roundedSamplesPerTick: number = Math.ceil(samplesPerTick);\r\n        const channel: Channel = song.channels[channelIndex];\r\n        const channelState: ChannelState = this.channels[channelIndex];\r\n        const instrument: Instrument = channel.instruments[tone.instrumentIndex];\r\n        const instrumentState: InstrumentState = channelState.instruments[tone.instrumentIndex];\r\n        instrumentState.awake = true;\r\n        instrumentState.tonesAddedInThisTick = true;\r\n        if (!instrumentState.computed) {\r\n            instrumentState.compute(this, instrument, samplesPerTick, roundedSamplesPerTick, tone, channelIndex, tone.instrumentIndex);\r\n        }\r\n        const transition: Transition = instrument.getTransition();\r\n        const chord: Chord = instrument.getChord();\r\n        const chordExpression: number = chord.singleTone ? 1.0 : Synth.computeChordExpression(tone.chordSize);\r\n        const isNoiseChannel: boolean = song.getChannelIsNoise(channelIndex);\r\n        const intervalScale: number = isNoiseChannel ? Config.noiseInterval : 1;\r\n        const secondsPerPart: number = Config.ticksPerPart * samplesPerTick / this.samplesPerSecond;\r\n        const sampleTime: number = 1.0 / this.samplesPerSecond;\r\n        const beatsPerPart: number = 1.0 / Config.partsPerBeat;\r\n        const ticksIntoBar: number = this.getTicksIntoBar();\r\n        const partTimeStart: number = (ticksIntoBar) / Config.ticksPerPart;\r\n        const partTimeEnd: number = (ticksIntoBar + 1.0) / Config.ticksPerPart;\r\n        const currentPart: number = this.getCurrentPart();\r\n\r\n        let specialIntervalMult: number = 1.0;\r\n        tone.specialIntervalExpressionMult = 1.0;\r\n\r\n        //if (synth.isModActive(ModSetting.mstPan, channelIndex, tone.instrumentIndex)) {\r\n        //    startPan = synth.getModValue(ModSetting.mstPan, false, channel, instrumentIdx, false);\r\n        //    endPan = synth.getModValue(ModSetting.mstPan, false, channel, instrumentIdx, true);\r\n        //}\r\n\r\n        let toneIsOnLastTick: boolean = shouldFadeOutFast;\r\n        let intervalStart: number = 0.0;\r\n        let intervalEnd: number = 0.0;\r\n        let fadeExpressionStart: number = 1.0;\r\n        let fadeExpressionEnd: number = 1.0;\r\n        let chordExpressionStart: number = chordExpression;\r\n        let chordExpressionEnd: number = chordExpression;\r\n\r\n        let expressionReferencePitch: number = 16; // A low \"E\" as a MIDI pitch.\r\n        let basePitch: number = Config.keys[song.key].basePitch;\r\n        let baseExpression: number = 1.0;\r\n        let pitchDamping: number = 48;\r\n        if (instrument.type == InstrumentType.spectrum) {\r\n            baseExpression = Config.spectrumBaseExpression;\r\n            if (isNoiseChannel) {\r\n                basePitch = Config.spectrumBasePitch;\r\n                baseExpression *= 2.0; // Note: spectrum is louder for drum channels than pitch channels!\r\n            }\r\n            expressionReferencePitch = Config.spectrumBasePitch;\r\n            pitchDamping = 28;\r\n        } else if (instrument.type == InstrumentType.drumset) {\r\n            basePitch = Config.spectrumBasePitch;\r\n            baseExpression = Config.drumsetBaseExpression;\r\n            expressionReferencePitch = basePitch;\r\n        } else if (instrument.type == InstrumentType.noise) {\r\n            basePitch = Config.chipNoises[instrument.chipNoise].basePitch;\r\n            baseExpression = Config.noiseBaseExpression;\r\n            expressionReferencePitch = basePitch;\r\n            pitchDamping = Config.chipNoises[instrument.chipNoise].isSoft ? 24.0 : 60.0;\r\n        } else if (instrument.type == InstrumentType.fm) {\r\n            baseExpression = Config.fmBaseExpression;\r\n        } else if (instrument.type == InstrumentType.chip || instrument.type == InstrumentType.customChipWave) {\r\n            baseExpression = Config.chipBaseExpression;\r\n        } else if (instrument.type == InstrumentType.harmonics) {\r\n            baseExpression = Config.harmonicsBaseExpression;\r\n        } else if (instrument.type == InstrumentType.pwm) {\r\n            baseExpression = Config.pwmBaseExpression;\r\n        } else if (instrument.type == InstrumentType.pickedString) {\r\n            baseExpression = Config.pickedStringBaseExpression;\r\n        } else if (instrument.type == InstrumentType.mod) {\r\n            baseExpression = 1.0;\r\n            expressionReferencePitch = 0;\r\n            pitchDamping = 1.0;\r\n            basePitch = 0;\r\n        } else {\r\n            throw new Error(\"Unknown instrument type in computeTone.\");\r\n        }\r\n\r\n        if ((tone.atNoteStart && !transition.isSeamless && !tone.forceContinueAtStart) || tone.freshlyAllocated) {\r\n            tone.reset();\r\n        }\r\n        tone.freshlyAllocated = false;\r\n\r\n        for (let i: number = 0; i < Config.maxPitchOrOperatorCount; i++) {\r\n            tone.phaseDeltas[i] = 0.0;\r\n            tone.phaseDeltaScales[i] = 0.0;\r\n            tone.operatorExpressions[i] = 0.0;\r\n            tone.operatorExpressionDeltas[i] = 0.0;\r\n        }\r\n        tone.expression = 0.0;\r\n        tone.expressionDelta = 0.0;\r\n        for (let i: number = 0; i < Config.operatorCount; i++) {\r\n            tone.operatorWaves[i] = Synth.getOperatorWave(instrument.operators[i].waveform, instrument.operators[i].pulseWidth);\r\n        }\r\n\r\n        if (released) {\r\n            const startTicksSinceReleased: number = tone.ticksSinceReleased;\r\n            const endTicksSinceReleased: number = tone.ticksSinceReleased + 1.0;\r\n            intervalStart = intervalEnd = tone.lastInterval;\r\n            const fadeOutTicks: number = Math.abs(instrument.getFadeOutTicks());\r\n            fadeExpressionStart = Synth.noteSizeToVolumeMult((1.0 - startTicksSinceReleased / fadeOutTicks) * Config.noteSizeMax);\r\n            fadeExpressionEnd = Synth.noteSizeToVolumeMult((1.0 - endTicksSinceReleased / fadeOutTicks) * Config.noteSizeMax);\r\n\r\n            if (shouldFadeOutFast) {\r\n                fadeExpressionEnd = 0.0;\r\n            }\r\n\r\n            if (tone.ticksSinceReleased + 1 >= fadeOutTicks) toneIsOnLastTick = true;\r\n        } else if (tone.note == null) {\r\n            fadeExpressionStart = fadeExpressionEnd = 1.0;\r\n            tone.lastInterval = 0;\r\n            tone.ticksSinceReleased = 0;\r\n            tone.liveInputSamplesHeld += roundedSamplesPerTick;\r\n        } else {\r\n            const note: Note = tone.note;\r\n            const nextNote: Note | null = tone.nextNote;\r\n\r\n            const noteStartPart: number = tone.noteStartPart;\r\n            const noteEndPart: number = tone.noteEndPart;\r\n\r\n\r\n            const endPinIndex: number = note.getEndPinIndex(currentPart);\r\n            const startPin: NotePin = note.pins[endPinIndex - 1];\r\n            const endPin: NotePin = note.pins[endPinIndex];\r\n            const noteStartTick: number = noteStartPart * Config.ticksPerPart;\r\n            const noteEndTick: number = noteEndPart * Config.ticksPerPart;\r\n            const pinStart: number = (note.start + startPin.time) * Config.ticksPerPart;\r\n            const pinEnd: number = (note.start + endPin.time) * Config.ticksPerPart;\r\n\r\n            tone.ticksSinceReleased = 0;\r\n\r\n            const tickTimeStart: number = currentPart * Config.ticksPerPart + this.tick;\r\n            const tickTimeEnd: number = tickTimeStart + 1.0;\r\n            const noteTicksPassedTickStart: number = tickTimeStart - noteStartTick;\r\n            const noteTicksPassedTickEnd: number = tickTimeEnd - noteStartTick;\r\n            const pinRatioStart: number = Math.min(1.0, (tickTimeStart - pinStart) / (pinEnd - pinStart));\r\n            const pinRatioEnd: number = Math.min(1.0, (tickTimeEnd - pinStart) / (pinEnd - pinStart));\r\n            fadeExpressionStart = 1.0;\r\n            fadeExpressionEnd = 1.0;\r\n            intervalStart = startPin.interval + (endPin.interval - startPin.interval) * pinRatioStart;\r\n            intervalEnd = startPin.interval + (endPin.interval - startPin.interval) * pinRatioEnd;\r\n            tone.lastInterval = intervalEnd;\r\n\r\n            if ((!transition.isSeamless && !tone.forceContinueAtEnd) || nextNote == null) {\r\n                const fadeOutTicks: number = -instrument.getFadeOutTicks();\r\n                if (fadeOutTicks > 0.0) {\r\n                    // If the tone should fade out before the end of the note, do so here.\r\n                    const noteLengthTicks: number = noteEndTick - noteStartTick;\r\n                    fadeExpressionStart *= Math.min(1.0, (noteLengthTicks - noteTicksPassedTickStart) / fadeOutTicks);\r\n                    fadeExpressionEnd *= Math.min(1.0, (noteLengthTicks - noteTicksPassedTickEnd) / fadeOutTicks);\r\n                    if (tickTimeEnd >= noteStartTick + noteLengthTicks) toneIsOnLastTick = true;\r\n                }\r\n            }\r\n\r\n        }\r\n\r\n        tone.isOnLastTick = toneIsOnLastTick;\r\n\r\n        let tmpNoteFilter: FilterSettings = instrument.noteFilter;\r\n        let startPoint: FilterControlPoint;\r\n        let endPoint: FilterControlPoint;\r\n\r\n        if (instrument.noteFilterType) {\r\n            // Simple EQ filter (old style). For analysis, using random filters from normal style since they are N/A in this context.\r\n            const noteFilterSettingsStart: FilterSettings = instrument.noteFilter;\r\n            if (instrument.noteSubFilters[1] == null)\r\n                instrument.noteSubFilters[1] = new FilterSettings();\r\n            const noteFilterSettingsEnd: FilterSettings = instrument.noteSubFilters[1];\r\n\r\n            // Change location based on slider values\r\n            let startSimpleFreq: number = instrument.noteFilterSimpleCut;\r\n            let startSimpleGain: number = instrument.noteFilterSimplePeak;\r\n            let endSimpleFreq: number = instrument.noteFilterSimpleCut;\r\n            let endSimpleGain: number = instrument.noteFilterSimplePeak;\r\n            let filterChanges: boolean = false;\r\n\r\n            if (this.isModActive(Config.modulators.dictionary[\"note filt cut\"].index, channelIndex, tone.instrumentIndex)) {\r\n                startSimpleFreq = this.getModValue(Config.modulators.dictionary[\"note filt cut\"].index, channelIndex, tone.instrumentIndex, false);\r\n                endSimpleFreq = this.getModValue(Config.modulators.dictionary[\"note filt cut\"].index, channelIndex, tone.instrumentIndex, true);\r\n                filterChanges = true;\r\n            }\r\n            if (this.isModActive(Config.modulators.dictionary[\"note filt peak\"].index, channelIndex, tone.instrumentIndex)) {\r\n                startSimpleGain = this.getModValue(Config.modulators.dictionary[\"note filt peak\"].index, channelIndex, tone.instrumentIndex, false);\r\n                endSimpleGain = this.getModValue(Config.modulators.dictionary[\"note filt peak\"].index, channelIndex, tone.instrumentIndex, true);\r\n                filterChanges = true;\r\n            }\r\n\r\n            noteFilterSettingsStart.convertLegacySettingsForSynth(startSimpleFreq, startSimpleGain, !filterChanges);\r\n            noteFilterSettingsEnd.convertLegacySettingsForSynth(endSimpleFreq, endSimpleGain, !filterChanges);\r\n\r\n            startPoint = noteFilterSettingsStart.controlPoints[0];\r\n            endPoint = noteFilterSettingsEnd.controlPoints[0];\r\n\r\n            // Temporarily override so that envelope computer uses appropriate computed note filter\r\n            instrument.noteFilter = noteFilterSettingsStart;\r\n            instrument.tmpNoteFilterStart = noteFilterSettingsStart;\r\n        }\r\n\r\n        // Compute envelopes *after* resetting the tone, otherwise the envelope computer gets reset too!\r\n        const envelopeComputer: EnvelopeComputer = tone.envelopeComputer;\r\n        envelopeComputer.computeEnvelopes(instrument, currentPart, Config.ticksPerPart * partTimeStart, samplesPerTick / this.samplesPerSecond, tone);\r\n        const envelopeStarts: number[] = tone.envelopeComputer.envelopeStarts;\r\n        const envelopeEnds: number[] = tone.envelopeComputer.envelopeEnds;\r\n        instrument.noteFilter = tmpNoteFilter;\r\n\r\n        if (tone.note != null && transition.slides) {\r\n            // Slide interval and chordExpression at the start and/or end of the note if necessary.\r\n            const prevNote: Note | null = tone.prevNote;\r\n            const nextNote: Note | null = tone.nextNote;\r\n            if (prevNote != null) {\r\n                const intervalDiff: number = prevNote.pitches[tone.prevNotePitchIndex] + prevNote.pins[prevNote.pins.length - 1].interval - tone.pitches[0];\r\n                if (envelopeComputer.prevSlideStart) intervalStart += intervalDiff * envelopeComputer.prevSlideRatioStart;\r\n                if (envelopeComputer.prevSlideEnd) intervalEnd += intervalDiff * envelopeComputer.prevSlideRatioEnd;\r\n                if (!chord.singleTone) {\r\n                    const chordSizeDiff: number = prevNote.pitches.length - tone.chordSize;\r\n                    if (envelopeComputer.prevSlideStart) chordExpressionStart = Synth.computeChordExpression(tone.chordSize + chordSizeDiff * envelopeComputer.prevSlideRatioStart);\r\n                    if (envelopeComputer.prevSlideEnd) chordExpressionEnd = Synth.computeChordExpression(tone.chordSize + chordSizeDiff * envelopeComputer.prevSlideRatioEnd);\r\n                }\r\n            }\r\n            if (nextNote != null) {\r\n                const intervalDiff: number = nextNote.pitches[tone.nextNotePitchIndex] - (tone.pitches[0] + tone.note.pins[tone.note.pins.length - 1].interval);\r\n                if (envelopeComputer.nextSlideStart) intervalStart += intervalDiff * envelopeComputer.nextSlideRatioStart;\r\n                if (envelopeComputer.nextSlideEnd) intervalEnd += intervalDiff * envelopeComputer.nextSlideRatioEnd;\r\n                if (!chord.singleTone) {\r\n                    const chordSizeDiff: number = nextNote.pitches.length - tone.chordSize;\r\n                    if (envelopeComputer.nextSlideStart) chordExpressionStart = Synth.computeChordExpression(tone.chordSize + chordSizeDiff * envelopeComputer.nextSlideRatioStart);\r\n                    if (envelopeComputer.nextSlideEnd) chordExpressionEnd = Synth.computeChordExpression(tone.chordSize + chordSizeDiff * envelopeComputer.nextSlideRatioEnd);\r\n                }\r\n            }\r\n        }\r\n\r\n        if (effectsIncludePitchShift(instrument.effects)) {\r\n            let pitchShift: number = Config.justIntonationSemitones[instrument.pitchShift] / intervalScale;\r\n            let pitchShiftScalarStart: number = 1.0;\r\n            let pitchShiftScalarEnd: number = 1.0;\r\n            if (this.isModActive(Config.modulators.dictionary[\"pitch shift\"].index, channelIndex, tone.instrumentIndex)) {\r\n                pitchShift = Config.justIntonationSemitones[Config.justIntonationSemitones.length - 1];\r\n                pitchShiftScalarStart = (this.getModValue(Config.modulators.dictionary[\"pitch shift\"].index, channelIndex, tone.instrumentIndex, false)) / (Config.pitchShiftCenter);\r\n                pitchShiftScalarEnd = (this.getModValue(Config.modulators.dictionary[\"pitch shift\"].index, channelIndex, tone.instrumentIndex, true)) / (Config.pitchShiftCenter);\r\n            }\r\n            const envelopeStart: number = envelopeStarts[EnvelopeComputeIndex.pitchShift];\r\n            const envelopeEnd: number = envelopeEnds[EnvelopeComputeIndex.pitchShift];\r\n            intervalStart += pitchShift * envelopeStart * pitchShiftScalarStart;\r\n            intervalEnd += pitchShift * envelopeEnd * pitchShiftScalarEnd;\r\n        }\r\n        if (effectsIncludeDetune(instrument.effects) || this.isModActive(Config.modulators.dictionary[\"song detune\"].index, channelIndex, tone.instrumentIndex)) {\r\n            const envelopeStart: number = envelopeStarts[EnvelopeComputeIndex.detune];\r\n            const envelopeEnd: number = envelopeEnds[EnvelopeComputeIndex.detune];\r\n            let modDetuneStart: number = instrument.detune;\r\n            let modDetuneEnd: number = instrument.detune;\r\n            if (this.isModActive(Config.modulators.dictionary[\"detune\"].index, channelIndex, tone.instrumentIndex)) {\r\n                modDetuneStart = this.getModValue(Config.modulators.dictionary[\"detune\"].index, channelIndex, tone.instrumentIndex, false) + Config.detuneCenter;\r\n                modDetuneEnd = this.getModValue(Config.modulators.dictionary[\"detune\"].index, channelIndex, tone.instrumentIndex, true) + Config.detuneCenter;\r\n            }\r\n            if (this.isModActive(Config.modulators.dictionary[\"song detune\"].index, channelIndex, tone.instrumentIndex)) {\r\n                modDetuneStart += 4 * this.getModValue(Config.modulators.dictionary[\"song detune\"].index, channelIndex, tone.instrumentIndex, false);\r\n                modDetuneEnd += 4 * this.getModValue(Config.modulators.dictionary[\"song detune\"].index, channelIndex, tone.instrumentIndex, true);\r\n            }\r\n            intervalStart += Synth.detuneToCents((modDetuneStart) * envelopeStart) * Config.pitchesPerOctave / (12.0 * 100.0);\r\n            intervalEnd += Synth.detuneToCents((modDetuneEnd) * envelopeEnd) * Config.pitchesPerOctave / (12.0 * 100.0);\r\n        }\r\n\r\n        if (effectsIncludeVibrato(instrument.effects)) {\r\n            let delayTicks: number;\r\n            let vibratoAmplitudeStart: number;\r\n            let vibratoAmplitudeEnd: number;\r\n            // Custom vibrato\r\n            if (instrument.vibrato == Config.vibratos.length) {\r\n                delayTicks = instrument.vibratoDelay * 2; // Delay was changed from parts to ticks in BB v9\r\n                // Special case: if vibrato delay is max, NEVER vibrato.\r\n                if (instrument.vibratoDelay == Config.modulators.dictionary[\"vibrato delay\"].maxRawVol)\r\n                    delayTicks = Number.POSITIVE_INFINITY;\r\n                vibratoAmplitudeStart = instrument.vibratoDepth;\r\n                vibratoAmplitudeEnd = vibratoAmplitudeStart;\r\n            } else {\r\n                delayTicks = Config.vibratos[instrument.vibrato].delayTicks;\r\n                vibratoAmplitudeStart = Config.vibratos[instrument.vibrato].amplitude;\r\n                vibratoAmplitudeEnd = vibratoAmplitudeStart;\r\n            }\r\n\r\n            if (this.isModActive(Config.modulators.dictionary[\"vibrato delay\"].index, channelIndex, tone.instrumentIndex)) {\r\n                delayTicks = this.getModValue(Config.modulators.dictionary[\"vibrato delay\"].index, channelIndex, tone.instrumentIndex, false) * 2; // Delay was changed from parts to ticks in BB v9\r\n                if (delayTicks == Config.modulators.dictionary[\"vibrato delay\"].maxRawVol * 2)\r\n                    delayTicks = Number.POSITIVE_INFINITY;\r\n\r\n            }\r\n\r\n            if (this.isModActive(Config.modulators.dictionary[\"vibrato depth\"].index, channelIndex, tone.instrumentIndex)) {\r\n                vibratoAmplitudeStart = this.getModValue(Config.modulators.dictionary[\"vibrato depth\"].index, channelIndex, tone.instrumentIndex, false) / 25;\r\n                vibratoAmplitudeEnd = this.getModValue(Config.modulators.dictionary[\"vibrato depth\"].index, channelIndex, tone.instrumentIndex, true) / 25;\r\n            }\r\n\r\n\r\n            // To maintain pitch continuity, (mostly for picked string which retriggers impulse\r\n            // otherwise) remember the vibrato at the end of this run and reuse it at the start\r\n            // of the next run if available.\r\n            let vibratoStart: number;\r\n            if (tone.prevVibrato != null) {\r\n                vibratoStart = tone.prevVibrato;\r\n            } else {\r\n                let lfoStart: number = Synth.getLFOAmplitude(instrument, secondsPerPart * instrument.LFOtime);\r\n                const vibratoDepthEnvelopeStart: number = envelopeStarts[EnvelopeComputeIndex.vibratoDepth];\r\n                vibratoStart = vibratoAmplitudeStart * lfoStart * vibratoDepthEnvelopeStart;\r\n                if (delayTicks > 0.0) {\r\n                    const ticksUntilVibratoStart: number = delayTicks - envelopeComputer.noteTicksStart;\r\n                    vibratoStart *= Math.max(0.0, Math.min(1.0, 1.0 - ticksUntilVibratoStart / 2.0));\r\n                }\r\n            }\r\n\r\n            let lfoEnd: number = Synth.getLFOAmplitude(instrument, secondsPerPart * instrument.nextLFOtime);\r\n            const vibratoDepthEnvelopeEnd: number = envelopeEnds[EnvelopeComputeIndex.vibratoDepth];\r\n            if (instrument.type != InstrumentType.mod) {\r\n                let vibratoEnd: number = vibratoAmplitudeEnd * lfoEnd * vibratoDepthEnvelopeEnd;\r\n                if (delayTicks > 0.0) {\r\n                    const ticksUntilVibratoEnd: number = delayTicks - envelopeComputer.noteTicksEnd;\r\n                    vibratoEnd *= Math.max(0.0, Math.min(1.0, 1.0 - ticksUntilVibratoEnd / 2.0));\r\n                }\r\n\r\n                tone.prevVibrato = vibratoEnd;\r\n\r\n                intervalStart += vibratoStart;\r\n                intervalEnd += vibratoEnd;\r\n            }\r\n        }\r\n\r\n        if ((!transition.isSeamless && !tone.forceContinueAtStart) || tone.prevNote == null) {\r\n            // Fade in the beginning of the note.\r\n            const fadeInSeconds: number = instrument.getFadeInSeconds();\r\n            if (fadeInSeconds > 0.0) {\r\n                fadeExpressionStart *= Math.min(1.0, envelopeComputer.noteSecondsStart / fadeInSeconds);\r\n                fadeExpressionEnd *= Math.min(1.0, envelopeComputer.noteSecondsEnd / fadeInSeconds);\r\n            }\r\n        }\r\n\r\n        if (instrument.type == InstrumentType.drumset && tone.drumsetPitch == null) {\r\n            // It's possible that the note will change while the user is editing it,\r\n            // but the tone's pitches don't get updated because the tone has already\r\n            // ended and is fading out. To avoid an array index out of bounds error, clamp the pitch.\r\n            tone.drumsetPitch = tone.pitches[0];\r\n            if (tone.note != null) tone.drumsetPitch += tone.note.pickMainInterval();\r\n            tone.drumsetPitch = Math.max(0, Math.min(Config.drumCount - 1, tone.drumsetPitch));\r\n        }\r\n\r\n        let noteFilterExpression: number = envelopeComputer.lowpassCutoffDecayVolumeCompensation;\r\n        if (!effectsIncludeNoteFilter(instrument.effects)) {\r\n            tone.noteFilterCount = 0;\r\n        } else {\r\n\r\n            const noteAllFreqsEnvelopeStart: number = envelopeStarts[EnvelopeComputeIndex.noteFilterAllFreqs];\r\n            const noteAllFreqsEnvelopeEnd: number = envelopeEnds[EnvelopeComputeIndex.noteFilterAllFreqs];\r\n\r\n            // Simple note filter\r\n            if (instrument.noteFilterType) {\r\n                const noteFreqEnvelopeStart: number = envelopeStarts[EnvelopeComputeIndex.noteFilterFreq0];\r\n                const noteFreqEnvelopeEnd: number = envelopeEnds[EnvelopeComputeIndex.noteFilterFreq0];\r\n                const notePeakEnvelopeStart: number = envelopeStarts[EnvelopeComputeIndex.noteFilterGain0];\r\n                const notePeakEnvelopeEnd: number = envelopeEnds[EnvelopeComputeIndex.noteFilterGain0];\r\n\r\n                startPoint!.toCoefficients(Synth.tempFilterStartCoefficients, this.samplesPerSecond, noteAllFreqsEnvelopeStart * noteFreqEnvelopeStart, notePeakEnvelopeStart);\r\n                endPoint!.toCoefficients(Synth.tempFilterEndCoefficients, this.samplesPerSecond, noteAllFreqsEnvelopeEnd * noteFreqEnvelopeEnd, notePeakEnvelopeEnd);\r\n\r\n                if (tone.noteFilters.length < 1) tone.noteFilters[0] = new DynamicBiquadFilter();\r\n                tone.noteFilters[0].loadCoefficientsWithGradient(Synth.tempFilterStartCoefficients, Synth.tempFilterEndCoefficients, 1.0 / roundedSamplesPerTick, startPoint!.type == FilterType.lowPass);\r\n                noteFilterExpression *= startPoint!.getVolumeCompensationMult();\r\n\r\n                tone.noteFilterCount = 1;\r\n            }\r\n            else {\r\n                const noteFilterSettings: FilterSettings = (instrument.tmpNoteFilterStart != null) ? instrument.tmpNoteFilterStart : instrument.noteFilter;\r\n\r\n                for (let i: number = 0; i < noteFilterSettings.controlPointCount; i++) {\r\n                    const noteFreqEnvelopeStart: number = envelopeStarts[EnvelopeComputeIndex.noteFilterFreq0 + i];\r\n                    const noteFreqEnvelopeEnd: number = envelopeEnds[EnvelopeComputeIndex.noteFilterFreq0 + i];\r\n                    const notePeakEnvelopeStart: number = envelopeStarts[EnvelopeComputeIndex.noteFilterGain0 + i];\r\n                    const notePeakEnvelopeEnd: number = envelopeEnds[EnvelopeComputeIndex.noteFilterGain0 + i];\r\n                    let startPoint: FilterControlPoint = noteFilterSettings.controlPoints[i];\r\n                    const endPoint: FilterControlPoint = (instrument.tmpNoteFilterEnd != null && instrument.tmpNoteFilterEnd.controlPoints[i] != null) ? instrument.tmpNoteFilterEnd.controlPoints[i] : noteFilterSettings.controlPoints[i];\r\n\r\n                    // If switching dot type, do it all at once and do not try to interpolate since no valid interpolation exists.\r\n                    if (startPoint.type != endPoint.type) {\r\n                        startPoint = endPoint;\r\n                    }\r\n\r\n                    startPoint.toCoefficients(Synth.tempFilterStartCoefficients, this.samplesPerSecond, noteAllFreqsEnvelopeStart * noteFreqEnvelopeStart, notePeakEnvelopeStart);\r\n                    endPoint.toCoefficients(Synth.tempFilterEndCoefficients, this.samplesPerSecond, noteAllFreqsEnvelopeEnd * noteFreqEnvelopeEnd, notePeakEnvelopeEnd);\r\n                    if (tone.noteFilters.length <= i) tone.noteFilters[i] = new DynamicBiquadFilter();\r\n                    tone.noteFilters[i].loadCoefficientsWithGradient(Synth.tempFilterStartCoefficients, Synth.tempFilterEndCoefficients, 1.0 / roundedSamplesPerTick, startPoint.type == FilterType.lowPass);\r\n                    noteFilterExpression *= startPoint.getVolumeCompensationMult();\r\n                }\r\n                tone.noteFilterCount = noteFilterSettings.controlPointCount;\r\n            }\r\n        }\r\n\r\n        if (instrument.type == InstrumentType.drumset) {\r\n            const drumsetFilterEnvelope: Envelope = instrument.getDrumsetEnvelope(tone.drumsetPitch!);\r\n            // If the drumset lowpass cutoff decays, compensate by increasing expression.\r\n            noteFilterExpression *= EnvelopeComputer.getLowpassCutoffDecayVolumeCompensation(drumsetFilterEnvelope)\r\n\r\n            // Drumset filters use the same envelope timing as the rest of the envelopes, but do not include support for slide transitions.\r\n            let drumsetFilterEnvelopeStart: number = EnvelopeComputer.computeEnvelope(drumsetFilterEnvelope, envelopeComputer.noteSecondsStart, beatsPerPart * partTimeStart, envelopeComputer.noteSizeStart);\r\n            let drumsetFilterEnvelopeEnd: number = EnvelopeComputer.computeEnvelope(drumsetFilterEnvelope, envelopeComputer.noteSecondsEnd, beatsPerPart * partTimeEnd, envelopeComputer.noteSizeEnd);\r\n\r\n            // Apply slide interpolation to drumset envelope.\r\n            if (envelopeComputer.prevSlideStart) {\r\n                const other: number = EnvelopeComputer.computeEnvelope(drumsetFilterEnvelope, envelopeComputer.prevNoteSecondsStart, beatsPerPart * partTimeStart, envelopeComputer.prevNoteSize);\r\n                drumsetFilterEnvelopeStart += (other - drumsetFilterEnvelopeStart) * envelopeComputer.prevSlideRatioStart;\r\n            }\r\n            if (envelopeComputer.prevSlideEnd) {\r\n                const other: number = EnvelopeComputer.computeEnvelope(drumsetFilterEnvelope, envelopeComputer.prevNoteSecondsEnd, beatsPerPart * partTimeEnd, envelopeComputer.prevNoteSize);\r\n                drumsetFilterEnvelopeEnd += (other - drumsetFilterEnvelopeEnd) * envelopeComputer.prevSlideRatioEnd;\r\n            }\r\n            if (envelopeComputer.nextSlideStart) {\r\n                const other: number = EnvelopeComputer.computeEnvelope(drumsetFilterEnvelope, 0.0, beatsPerPart * partTimeStart, envelopeComputer.nextNoteSize);\r\n                drumsetFilterEnvelopeStart += (other - drumsetFilterEnvelopeStart) * envelopeComputer.nextSlideRatioStart;\r\n            }\r\n            if (envelopeComputer.nextSlideEnd) {\r\n                const other: number = EnvelopeComputer.computeEnvelope(drumsetFilterEnvelope, 0.0, beatsPerPart * partTimeEnd, envelopeComputer.nextNoteSize);\r\n                drumsetFilterEnvelopeEnd += (other - drumsetFilterEnvelopeEnd) * envelopeComputer.nextSlideRatioEnd;\r\n            }\r\n\r\n            const point: FilterControlPoint = this.tempDrumSetControlPoint;\r\n            point.type = FilterType.lowPass;\r\n            point.gain = FilterControlPoint.getRoundedSettingValueFromLinearGain(0.5);\r\n            point.freq = FilterControlPoint.getRoundedSettingValueFromHz(8000.0);\r\n            // Drumset envelopes are warped to better imitate the legacy simplified 2nd order lowpass at ~48000Hz that I used to use.\r\n            point.toCoefficients(Synth.tempFilterStartCoefficients, this.samplesPerSecond, drumsetFilterEnvelopeStart * (1.0 + drumsetFilterEnvelopeStart), 1.0);\r\n            point.toCoefficients(Synth.tempFilterEndCoefficients, this.samplesPerSecond, drumsetFilterEnvelopeEnd * (1.0 + drumsetFilterEnvelopeEnd), 1.0);\r\n            if (tone.noteFilters.length == tone.noteFilterCount) tone.noteFilters[tone.noteFilterCount] = new DynamicBiquadFilter();\r\n            tone.noteFilters[tone.noteFilterCount].loadCoefficientsWithGradient(Synth.tempFilterStartCoefficients, Synth.tempFilterEndCoefficients, 1.0 / roundedSamplesPerTick, true);\r\n            tone.noteFilterCount++;\r\n        }\r\n\r\n        noteFilterExpression = Math.min(3.0, noteFilterExpression);\r\n\r\n        if (instrument.type == InstrumentType.fm) {\r\n            // phase modulation!\r\n\r\n            let sineExpressionBoost: number = 1.0;\r\n            let totalCarrierExpression: number = 0.0;\r\n\r\n            let arpeggioInterval: number = 0;\r\n            const arpeggiates: boolean = chord.arpeggiates;\r\n            if (tone.pitchCount > 1 && arpeggiates) {\r\n                const arpeggio: number = Math.floor(instrument.arpTime / Config.ticksPerArpeggio);\r\n                arpeggioInterval = tone.pitches[getArpeggioPitchIndex(tone.pitchCount, instrument.fastTwoNoteArp, arpeggio)] - tone.pitches[0];\r\n            }\r\n\r\n            const carrierCount: number = Config.algorithms[instrument.algorithm].carrierCount;\r\n            for (let i: number = 0; i < Config.operatorCount; i++) {\r\n\r\n                const associatedCarrierIndex: number = Config.algorithms[instrument.algorithm].associatedCarrier[i] - 1;\r\n                const pitch: number = tone.pitches[arpeggiates ? 0 : ((i < tone.pitchCount) ? i : ((associatedCarrierIndex < tone.pitchCount) ? associatedCarrierIndex : 0))];\r\n                const freqMult = Config.operatorFrequencies[instrument.operators[i].frequency].mult;\r\n                const interval = Config.operatorCarrierInterval[associatedCarrierIndex] + arpeggioInterval;\r\n                const pitchStart: number = basePitch + (pitch + intervalStart) * intervalScale + interval;\r\n                const pitchEnd: number = basePitch + (pitch + intervalEnd) * intervalScale + interval;\r\n                const baseFreqStart: number = Instrument.frequencyFromPitch(pitchStart);\r\n                const baseFreqEnd: number = Instrument.frequencyFromPitch(pitchEnd);\r\n                const hzOffset: number = Config.operatorFrequencies[instrument.operators[i].frequency].hzOffset;\r\n                const targetFreqStart: number = freqMult * baseFreqStart + hzOffset;\r\n                const targetFreqEnd: number = freqMult * baseFreqEnd + hzOffset;\r\n\r\n                const freqEnvelopeStart: number = envelopeStarts[EnvelopeComputeIndex.operatorFrequency0 + i];\r\n                const freqEnvelopeEnd: number = envelopeEnds[EnvelopeComputeIndex.operatorFrequency0 + i];\r\n                let freqStart: number;\r\n                let freqEnd: number;\r\n                if (freqEnvelopeStart != 1.0 || freqEnvelopeEnd != 1.0) {\r\n                    freqStart = Math.pow(2.0, Math.log2(targetFreqStart / baseFreqStart) * freqEnvelopeStart) * baseFreqStart;\r\n                    freqEnd = Math.pow(2.0, Math.log2(targetFreqEnd / baseFreqEnd) * freqEnvelopeEnd) * baseFreqEnd;\r\n                } else {\r\n                    freqStart = targetFreqStart;\r\n                    freqEnd = targetFreqEnd;\r\n                }\r\n                tone.phaseDeltas[i] = freqStart * sampleTime;\r\n                tone.phaseDeltaScales[i] = Math.pow(freqEnd / freqStart, 1.0 / roundedSamplesPerTick);\r\n\r\n                let amplitudeStart: number = instrument.operators[i].amplitude;\r\n                let amplitudeEnd: number = instrument.operators[i].amplitude;\r\n                if (this.isModActive(Config.modulators.dictionary[\"fm slider 1\"].index + i, channelIndex, tone.instrumentIndex)) {\r\n                    amplitudeStart *= this.getModValue(Config.modulators.dictionary[\"fm slider 1\"].index + i, channelIndex, tone.instrumentIndex, false) / 15.0;\r\n                    amplitudeEnd *= this.getModValue(Config.modulators.dictionary[\"fm slider 1\"].index + i, channelIndex, tone.instrumentIndex, true) / 15.0;\r\n                }\r\n\r\n                const amplitudeCurveStart: number = Synth.operatorAmplitudeCurve(amplitudeStart);\r\n                const amplitudeCurveEnd: number = Synth.operatorAmplitudeCurve(amplitudeEnd);\r\n                const amplitudeMultStart: number = amplitudeCurveStart * Config.operatorFrequencies[instrument.operators[i].frequency].amplitudeSign;\r\n                const amplitudeMultEnd: number = amplitudeCurveEnd * Config.operatorFrequencies[instrument.operators[i].frequency].amplitudeSign;\r\n\r\n                let expressionStart: number = amplitudeMultStart;\r\n                let expressionEnd: number = amplitudeMultEnd;\r\n\r\n\r\n                if (i < carrierCount) {\r\n                    // carrier\r\n                    let pitchExpressionStart: number;\r\n                    if (tone.prevPitchExpressions[i] != null) {\r\n                        pitchExpressionStart = tone.prevPitchExpressions[i]!;\r\n                    } else {\r\n                        pitchExpressionStart = Math.pow(2.0, -(pitchStart - expressionReferencePitch) / pitchDamping);\r\n                    }\r\n                    const pitchExpressionEnd: number = Math.pow(2.0, -(pitchEnd - expressionReferencePitch) / pitchDamping);\r\n                    tone.prevPitchExpressions[i] = pitchExpressionEnd;\r\n                    expressionStart *= pitchExpressionStart;\r\n                    expressionEnd *= pitchExpressionEnd;\r\n\r\n                    totalCarrierExpression += amplitudeCurveEnd;\r\n                } else {\r\n                    // modulator\r\n                    expressionStart *= Config.sineWaveLength * 1.5;\r\n                    expressionEnd *= Config.sineWaveLength * 1.5;\r\n\r\n                    sineExpressionBoost *= 1.0 - Math.min(1.0, instrument.operators[i].amplitude / 15);\r\n                }\r\n\r\n                expressionStart *= envelopeStarts[EnvelopeComputeIndex.operatorAmplitude0 + i];\r\n                expressionEnd *= envelopeEnds[EnvelopeComputeIndex.operatorAmplitude0 + i];\r\n\r\n                // Check for mod-related volume delta\r\n                // @jummbus - This amplification is also applied to modulator FM operators which distorts the sound.\r\n                // The fix is to apply this only to carriers, but as this is a legacy bug and it can cause some interesting sounds, it's left in.\r\n                // You can use the mix volume modulator instead to avoid this effect.\r\n\r\n                if (this.isModActive(Config.modulators.dictionary[\"note volume\"].index, channelIndex, tone.instrumentIndex)) {\r\n                    // Linear falloff below 0, normal volume formula above 0. Seems to work best for scaling since the normal volume mult formula has a big gap from -25 to -24.\r\n                    const startVal: number = this.getModValue(Config.modulators.dictionary[\"note volume\"].index, channelIndex, tone.instrumentIndex, false);\r\n                    const endVal: number = this.getModValue(Config.modulators.dictionary[\"note volume\"].index, channelIndex, tone.instrumentIndex, true);\r\n                    expressionStart *= ((startVal <= 0) ? ((startVal + Config.volumeRange / 2) / (Config.volumeRange / 2)) : Synth.instrumentVolumeToVolumeMult(startVal));\r\n                    expressionEnd *= ((endVal <= 0) ? ((endVal + Config.volumeRange / 2) / (Config.volumeRange / 2)) : Synth.instrumentVolumeToVolumeMult(endVal));\r\n                }\r\n\r\n                tone.operatorExpressions[i] = expressionStart;\r\n                tone.operatorExpressionDeltas[i] = (expressionEnd - expressionStart) / roundedSamplesPerTick;\r\n\r\n            }\r\n\r\n            sineExpressionBoost *= (Math.pow(2.0, (2.0 - 1.4 * instrument.feedbackAmplitude / 15.0)) - 1.0) / 3.0;\r\n            sineExpressionBoost *= 1.0 - Math.min(1.0, Math.max(0.0, totalCarrierExpression - 1) / 2.0);\r\n            sineExpressionBoost = 1.0 + sineExpressionBoost * 3.0;\r\n            const expressionStart: number = baseExpression * sineExpressionBoost * noteFilterExpression * fadeExpressionStart * chordExpressionStart * envelopeStarts[EnvelopeComputeIndex.noteVolume];\r\n            const expressionEnd: number = baseExpression * sineExpressionBoost * noteFilterExpression * fadeExpressionEnd * chordExpressionEnd * envelopeEnds[EnvelopeComputeIndex.noteVolume];\r\n            tone.expression = expressionStart;\r\n            tone.expressionDelta = (expressionEnd - expressionStart) / roundedSamplesPerTick;\r\n\r\n\r\n            let useFeedbackAmplitudeStart: number = instrument.feedbackAmplitude;\r\n            let useFeedbackAmplitudeEnd: number = instrument.feedbackAmplitude;\r\n            if (this.isModActive(Config.modulators.dictionary[\"fm feedback\"].index, channelIndex, tone.instrumentIndex)) {\r\n                useFeedbackAmplitudeStart *= this.getModValue(Config.modulators.dictionary[\"fm feedback\"].index, channelIndex, tone.instrumentIndex, false) / 15.0;\r\n                useFeedbackAmplitudeEnd *= this.getModValue(Config.modulators.dictionary[\"fm feedback\"].index, channelIndex, tone.instrumentIndex, true) / 15.0;\r\n            }\r\n\r\n            let feedbackAmplitudeStart: number = Config.sineWaveLength * 0.3 * useFeedbackAmplitudeStart / 15.0;\r\n            const feedbackAmplitudeEnd: number = Config.sineWaveLength * 0.3 * useFeedbackAmplitudeEnd / 15.0;\r\n\r\n            let feedbackStart: number = feedbackAmplitudeStart * envelopeStarts[EnvelopeComputeIndex.feedbackAmplitude];\r\n            let feedbackEnd: number = feedbackAmplitudeEnd * envelopeEnds[EnvelopeComputeIndex.feedbackAmplitude];\r\n            tone.feedbackMult = feedbackStart;\r\n            tone.feedbackDelta = (feedbackEnd - feedbackStart) / roundedSamplesPerTick;\r\n\r\n\r\n        } else {\r\n            const basePhaseDeltaScale: number = Math.pow(2.0, ((intervalEnd - intervalStart) * intervalScale / 12.0) / roundedSamplesPerTick);\r\n\r\n            let pitch: number = tone.pitches[0];\r\n            if (tone.pitchCount > 1 && (chord.arpeggiates || chord.customInterval)) {\r\n                const arpeggio: number = Math.floor(instrument.arpTime / Config.ticksPerArpeggio);\r\n                if (chord.customInterval) {\r\n                    const intervalOffset: number = tone.pitches[1 + getArpeggioPitchIndex(tone.pitchCount - 1, instrument.fastTwoNoteArp, arpeggio)] - tone.pitches[0];\r\n                    specialIntervalMult = Math.pow(2.0, intervalOffset / 12.0);\r\n                    tone.specialIntervalExpressionMult = Math.pow(2.0, -intervalOffset / pitchDamping);\r\n                } else {\r\n                    pitch = tone.pitches[getArpeggioPitchIndex(tone.pitchCount, instrument.fastTwoNoteArp, arpeggio)];\r\n                }\r\n            }\r\n\r\n            const startPitch: number = basePitch + (pitch + intervalStart) * intervalScale;\r\n            const endPitch: number = basePitch + (pitch + intervalEnd) * intervalScale;\r\n            let pitchExpressionStart: number;\r\n            // TODO: use the second element of prevPitchExpressions for the unison voice, compute a separate expression delta for it.\r\n            if (tone.prevPitchExpressions[0] != null) {\r\n                pitchExpressionStart = tone.prevPitchExpressions[0]!;\r\n            } else {\r\n                pitchExpressionStart = Math.pow(2.0, -(startPitch - expressionReferencePitch) / pitchDamping);\r\n            }\r\n            const pitchExpressionEnd: number = Math.pow(2.0, -(endPitch - expressionReferencePitch) / pitchDamping);\r\n            tone.prevPitchExpressions[0] = pitchExpressionEnd;\r\n            let settingsExpressionMult: number = baseExpression * noteFilterExpression;\r\n\r\n            if (instrument.type == InstrumentType.noise) {\r\n                settingsExpressionMult *= Config.chipNoises[instrument.chipNoise].expression;\r\n            }\r\n            if (instrument.type == InstrumentType.chip) {\r\n                settingsExpressionMult *= Config.chipWaves[instrument.chipWave].expression;\r\n            }\r\n            if (instrument.type == InstrumentType.pwm) {\r\n                const basePulseWidth: number = getPulseWidthRatio(instrument.pulseWidth);\r\n\r\n                // Check for PWM mods to this instrument\r\n                let pulseWidthModStart: number = basePulseWidth;\r\n                let pulseWidthModEnd: number = basePulseWidth;\r\n                if (this.isModActive(Config.modulators.dictionary[\"pulse width\"].index, channelIndex, tone.instrumentIndex)) {\r\n                    pulseWidthModStart = (this.getModValue(Config.modulators.dictionary[\"pulse width\"].index, channelIndex, tone.instrumentIndex, false)) / (Config.pulseWidthRange * 2);\r\n                    pulseWidthModEnd = (this.getModValue(Config.modulators.dictionary[\"pulse width\"].index, channelIndex, tone.instrumentIndex, true)) / (Config.pulseWidthRange * 2);\r\n                }\r\n\r\n                const pulseWidthStart: number = pulseWidthModStart * envelopeStarts[EnvelopeComputeIndex.pulseWidth];\r\n                const pulseWidthEnd: number = pulseWidthModEnd * envelopeEnds[EnvelopeComputeIndex.pulseWidth];\r\n                tone.pulseWidth = pulseWidthStart;\r\n                tone.pulseWidthDelta = (pulseWidthEnd - pulseWidthStart) / roundedSamplesPerTick;\r\n            }\r\n            if (instrument.type == InstrumentType.pickedString) {\r\n                // Check for sustain mods\r\n                let useSustainStart: number = instrument.stringSustain;\r\n                let useSustainEnd: number = instrument.stringSustain;\r\n                if (this.isModActive(Config.modulators.dictionary[\"sustain\"].index, channelIndex, tone.instrumentIndex)) {\r\n                    useSustainStart = this.getModValue(Config.modulators.dictionary[\"sustain\"].index, channelIndex, tone.instrumentIndex, false);\r\n                    useSustainEnd = this.getModValue(Config.modulators.dictionary[\"sustain\"].index, channelIndex, tone.instrumentIndex, true);\r\n                }\r\n\r\n                tone.stringSustainStart = useSustainStart;\r\n                tone.stringSustainEnd = useSustainEnd;\r\n\r\n                // Increase expression to compensate for string decay.\r\n                settingsExpressionMult *= Math.pow(2.0, 0.7 * (1.0 - useSustainStart / (Config.stringSustainRange - 1)));\r\n\r\n            }\r\n\r\n            const startFreq: number = Instrument.frequencyFromPitch(startPitch);\r\n            if (instrument.type == InstrumentType.chip || instrument.type == InstrumentType.customChipWave || instrument.type == InstrumentType.harmonics || instrument.type == InstrumentType.pickedString) {\r\n                // These instruments have two waves at different frequencies for the unison feature.\r\n                const unison: Unison = Config.unisons[instrument.unison];\r\n                const voiceCountExpression: number = (instrument.type == InstrumentType.pickedString) ? 1 : unison.voices / 2.0;\r\n                settingsExpressionMult *= unison.expression * voiceCountExpression;\r\n                const unisonEnvelopeStart = envelopeStarts[EnvelopeComputeIndex.unison];\r\n                const unisonEnvelopeEnd = envelopeEnds[EnvelopeComputeIndex.unison];\r\n                const unisonAStart: number = Math.pow(2.0, (unison.offset + unison.spread) * unisonEnvelopeStart / 12.0);\r\n                const unisonAEnd: number = Math.pow(2.0, (unison.offset + unison.spread) * unisonEnvelopeEnd / 12.0);\r\n                const unisonBStart: number = Math.pow(2.0, (unison.offset - unison.spread) * unisonEnvelopeStart / 12.0) * specialIntervalMult;\r\n                const unisonBEnd: number = Math.pow(2.0, (unison.offset - unison.spread) * unisonEnvelopeEnd / 12.0) * specialIntervalMult;\r\n                tone.phaseDeltas[0] = startFreq * sampleTime * unisonAStart;\r\n                tone.phaseDeltas[1] = startFreq * sampleTime * unisonBStart;\r\n                tone.phaseDeltaScales[0] = basePhaseDeltaScale * Math.pow(unisonAEnd / unisonAStart, 1.0 / roundedSamplesPerTick);\r\n                tone.phaseDeltaScales[1] = basePhaseDeltaScale * Math.pow(unisonBEnd / unisonBStart, 1.0 / roundedSamplesPerTick);\r\n            } else {\r\n                tone.phaseDeltas[0] = startFreq * sampleTime;\r\n                tone.phaseDeltaScales[0] = basePhaseDeltaScale;\r\n            }\r\n\r\n            let expressionStart: number = settingsExpressionMult * fadeExpressionStart * chordExpressionStart * pitchExpressionStart * envelopeStarts[EnvelopeComputeIndex.noteVolume];\r\n            let expressionEnd: number = settingsExpressionMult * fadeExpressionEnd * chordExpressionEnd * pitchExpressionEnd * envelopeEnds[EnvelopeComputeIndex.noteVolume];\r\n\r\n            // Check for mod-related volume delta\r\n            if (this.isModActive(Config.modulators.dictionary[\"note volume\"].index, channelIndex, tone.instrumentIndex)) {\r\n                // Linear falloff below 0, normal volume formula above 0. Seems to work best for scaling since the normal volume mult formula has a big gap from -25 to -24.\r\n                const startVal: number = this.getModValue(Config.modulators.dictionary[\"note volume\"].index, channelIndex, tone.instrumentIndex, false);\r\n                const endVal: number = this.getModValue(Config.modulators.dictionary[\"note volume\"].index, channelIndex, tone.instrumentIndex, true)\r\n                expressionStart *= ((startVal <= 0) ? ((startVal + Config.volumeRange / 2) / (Config.volumeRange / 2)) : Synth.instrumentVolumeToVolumeMult(startVal));\r\n                expressionEnd *= ((endVal <= 0) ? ((endVal + Config.volumeRange / 2) / (Config.volumeRange / 2)) : Synth.instrumentVolumeToVolumeMult(endVal));\r\n            }\r\n\r\n            tone.expression = expressionStart;\r\n            tone.expressionDelta = (expressionEnd - expressionStart) / roundedSamplesPerTick;\r\n\r\n\r\n            if (instrument.type == InstrumentType.pickedString) {\r\n                let stringDecayStart: number;\r\n                if (tone.prevStringDecay != null) {\r\n                    stringDecayStart = tone.prevStringDecay;\r\n                } else {\r\n                    const sustainEnvelopeStart: number = tone.envelopeComputer.envelopeStarts[EnvelopeComputeIndex.stringSustain];\r\n                    stringDecayStart = 1.0 - Math.min(1.0, sustainEnvelopeStart * tone.stringSustainStart / (Config.stringSustainRange - 1));\r\n                }\r\n                const sustainEnvelopeEnd: number = tone.envelopeComputer.envelopeEnds[EnvelopeComputeIndex.stringSustain];\r\n                let stringDecayEnd: number = 1.0 - Math.min(1.0, sustainEnvelopeEnd * tone.stringSustainEnd / (Config.stringSustainRange - 1));\r\n                tone.prevStringDecay = stringDecayEnd;\r\n\r\n                const unison: Unison = Config.unisons[instrument.unison];\r\n                for (let i: number = tone.pickedStrings.length; i < unison.voices; i++) {\r\n                    tone.pickedStrings[i] = new PickedString();\r\n                }\r\n\r\n                if (tone.atNoteStart && !transition.continues && !tone.forceContinueAtStart) {\r\n                    for (const pickedString of tone.pickedStrings) {\r\n                        // Force the picked string to retrigger the attack impulse at the start of the note.\r\n                        pickedString.delayIndex = -1;\r\n                    }\r\n                }\r\n\r\n                for (let i: number = 0; i < unison.voices; i++) {\r\n                    tone.pickedStrings[i].update(this, instrumentState, tone, i, roundedSamplesPerTick, stringDecayStart, stringDecayEnd);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    public static getLFOAmplitude(instrument: Instrument, secondsIntoBar: number): number {\r\n        let effect: number = 0.0;\r\n        for (const vibratoPeriodSeconds of Config.vibratoTypes[instrument.vibratoType].periodsSeconds) {\r\n            effect += Math.sin(Math.PI * 2.0 * secondsIntoBar / vibratoPeriodSeconds);\r\n        }\r\n        return effect;\r\n    }\r\n\r\n\r\n    public static getInstrumentSynthFunction(instrument: Instrument): Function {\r\n        if (instrument.type == InstrumentType.fm) {\r\n            const fingerprint: string = instrument.algorithm + \"_\" + instrument.feedbackType;\r\n            if (Synth.fmSynthFunctionCache[fingerprint] == undefined) {\r\n                const synthSource: string[] = [];\r\n\r\n                for (const line of Synth.fmSourceTemplate) {\r\n                    if (line.indexOf(\"// CARRIER OUTPUTS\") != -1) {\r\n                        const outputs: string[] = [];\r\n                        for (let j: number = 0; j < Config.algorithms[instrument.algorithm].carrierCount; j++) {\r\n                            outputs.push(\"operator\" + j + \"Scaled\");\r\n                        }\r\n                        synthSource.push(line.replace(\"/*operator#Scaled*/\", outputs.join(\" + \")));\r\n                    } else if (line.indexOf(\"// INSERT OPERATOR COMPUTATION HERE\") != -1) {\r\n                        for (let j: number = Config.operatorCount - 1; j >= 0; j--) {\r\n                            for (const operatorLine of Synth.operatorSourceTemplate) {\r\n                                if (operatorLine.indexOf(\"/* + operator@Scaled*/\") != -1) {\r\n                                    let modulators = \"\";\r\n                                    for (const modulatorNumber of Config.algorithms[instrument.algorithm].modulatedBy[j]) {\r\n                                        modulators += \" + operator\" + (modulatorNumber - 1) + \"Scaled\";\r\n                                    }\r\n\r\n                                    const feedbackIndices: ReadonlyArray<number> = Config.feedbacks[instrument.feedbackType].indices[j];\r\n                                    if (feedbackIndices.length > 0) {\r\n                                        modulators += \" + feedbackMult * (\";\r\n                                        const feedbacks: string[] = [];\r\n                                        for (const modulatorNumber of feedbackIndices) {\r\n                                            feedbacks.push(\"operator\" + (modulatorNumber - 1) + \"Output\");\r\n                                        }\r\n                                        modulators += feedbacks.join(\" + \") + \")\";\r\n                                    }\r\n                                    synthSource.push(operatorLine.replace(/\\#/g, j + \"\").replace(\"/* + operator@Scaled*/\", modulators));\r\n                                } else {\r\n                                    synthSource.push(operatorLine.replace(/\\#/g, j + \"\"));\r\n                                }\r\n                            }\r\n                        }\r\n                    } else if (line.indexOf(\"#\") != -1) {\r\n                        for (let j: number = 0; j < Config.operatorCount; j++) {\r\n                            synthSource.push(line.replace(/\\#/g, j + \"\"));\r\n                        }\r\n                    } else {\r\n                        synthSource.push(line);\r\n                    }\r\n                }\r\n\r\n                //console.log(synthSource.join(\"\\n\"));\r\n\r\n                Synth.fmSynthFunctionCache[fingerprint] = new Function(\"synth\", \"bufferIndex\", \"roundedSamplesPerTick\", \"tone\", \"instrumentState\", synthSource.join(\"\\n\"));\r\n            }\r\n            return Synth.fmSynthFunctionCache[fingerprint];\r\n        } else if (instrument.type == InstrumentType.chip) {\r\n            return Synth.chipSynth;\r\n        } else if (instrument.type == InstrumentType.customChipWave) {\r\n            return Synth.chipSynth;\r\n        } else if (instrument.type == InstrumentType.harmonics) {\r\n            return Synth.harmonicsSynth;\r\n        } else if (instrument.type == InstrumentType.pwm) {\r\n            return Synth.pulseWidthSynth;\r\n        } else if (instrument.type == InstrumentType.pickedString) {\r\n            return Synth.pickedStringSynth;\r\n        } else if (instrument.type == InstrumentType.noise) {\r\n            return Synth.noiseSynth;\r\n        } else if (instrument.type == InstrumentType.spectrum) {\r\n            return Synth.spectrumSynth;\r\n        } else if (instrument.type == InstrumentType.drumset) {\r\n            return Synth.drumsetSynth;\r\n        } else if (instrument.type == InstrumentType.mod) {\r\n            return Synth.modSynth;\r\n        } else {\r\n            throw new Error(\"Unrecognized instrument type: \" + instrument.type);\r\n        }\r\n    }\r\n\r\n    private static chipSynth(synth: Synth, bufferIndex: number, roundedSamplesPerTick: number, tone: Tone, instrumentState: InstrumentState): void {\r\n        const aliases: boolean = (effectsIncludeDistortion(instrumentState.effects) && instrumentState.aliases);\r\n        const data: Float32Array = synth.tempMonoInstrumentSampleBuffer!;\r\n        const wave: Float32Array = instrumentState.wave!;\r\n        const volumeScale = instrumentState.volumeScale;\r\n\r\n        // For all but aliasing custom chip, the first sample is duplicated at the end, so don't double-count it.\r\n        const waveLength: number = (aliases && instrumentState.type == InstrumentType.customChipWave) ? wave.length : wave.length - 1;\r\n\r\n        const unisonSign: number = tone.specialIntervalExpressionMult * instrumentState.unison!.sign;\r\n        if (instrumentState.unison!.voices == 1 && !instrumentState.chord!.customInterval) tone.phases[1] = tone.phases[0];\r\n        let phaseDeltaA: number = tone.phaseDeltas[0] * waveLength;\r\n        let phaseDeltaB: number = tone.phaseDeltas[1] * waveLength;\r\n        const phaseDeltaScaleA: number = +tone.phaseDeltaScales[0];\r\n        const phaseDeltaScaleB: number = +tone.phaseDeltaScales[1];\r\n        let expression: number = +tone.expression;\r\n        const expressionDelta: number = +tone.expressionDelta;\r\n        let phaseA: number = (tone.phases[0] % 1) * waveLength;\r\n        let phaseB: number = (tone.phases[1] % 1) * waveLength;\r\n\r\n        const filters: DynamicBiquadFilter[] = tone.noteFilters;\r\n        const filterCount: number = tone.noteFilterCount | 0;\r\n        let initialFilterInput1: number = +tone.initialNoteFilterInput1;\r\n        let initialFilterInput2: number = +tone.initialNoteFilterInput2;\r\n        const applyFilters: Function = Synth.applyFilters;\r\n        let prevWaveIntegralA: number = 0;\r\n        let prevWaveIntegralB: number = 0;\r\n\r\n        if (!aliases) {\r\n            const phaseAInt: number = phaseA | 0;\r\n            const phaseBInt: number = phaseB | 0;\r\n            const indexA: number = phaseAInt % waveLength;\r\n            const indexB: number = phaseBInt % waveLength;\r\n            const phaseRatioA: number = phaseA - phaseAInt;\r\n            const phaseRatioB: number = phaseB - phaseBInt;\r\n            prevWaveIntegralA = +wave[indexA];\r\n            prevWaveIntegralB = +wave[indexB];\r\n            prevWaveIntegralA += (wave[indexA + 1] - prevWaveIntegralA) * phaseRatioA;\r\n            prevWaveIntegralB += (wave[indexB + 1] - prevWaveIntegralB) * phaseRatioB;\r\n        }\r\n\r\n        const stopIndex: number = bufferIndex + roundedSamplesPerTick;\r\n        for (let sampleIndex: number = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\r\n\r\n            phaseA += phaseDeltaA;\r\n            phaseB += phaseDeltaB;\r\n\r\n            let waveA: number;\r\n            let waveB: number;\r\n            let inputSample: number;\r\n\r\n            if (aliases) {\r\n                waveA = wave[(0 | phaseA) % waveLength];\r\n                waveB = wave[(0 | phaseB) % waveLength];\r\n                inputSample = waveA + waveB;\r\n            } else {\r\n                const phaseAInt: number = phaseA | 0;\r\n                const phaseBInt: number = phaseB | 0;\r\n                const indexA: number = phaseAInt % waveLength;\r\n                const indexB: number = phaseBInt % waveLength;\r\n                let nextWaveIntegralA: number = wave[indexA];\r\n                let nextWaveIntegralB: number = wave[indexB];\r\n                const phaseRatioA: number = phaseA - phaseAInt;\r\n                const phaseRatioB: number = phaseB - phaseBInt;\r\n                nextWaveIntegralA += (wave[indexA + 1] - nextWaveIntegralA) * phaseRatioA;\r\n                nextWaveIntegralB += (wave[indexB + 1] - nextWaveIntegralB) * phaseRatioB;\r\n                waveA = (nextWaveIntegralA - prevWaveIntegralA) / phaseDeltaA;\r\n                waveB = (nextWaveIntegralB - prevWaveIntegralB) / phaseDeltaB;\r\n                prevWaveIntegralA = nextWaveIntegralA;\r\n                prevWaveIntegralB = nextWaveIntegralB;\r\n                inputSample = waveA + waveB * unisonSign;\r\n            }\r\n\r\n            const sample: number = applyFilters(inputSample * volumeScale, initialFilterInput1, initialFilterInput2, filterCount, filters);\r\n            initialFilterInput2 = initialFilterInput1;\r\n            initialFilterInput1 = inputSample * volumeScale;\r\n\r\n            phaseDeltaA *= phaseDeltaScaleA;\r\n            phaseDeltaB *= phaseDeltaScaleB;\r\n\r\n            const output: number = sample * expression;\r\n            expression += expressionDelta;\r\n\r\n            data[sampleIndex] += output;\r\n        }\r\n\r\n        tone.phases[0] = phaseA / waveLength;\r\n        tone.phases[1] = phaseB / waveLength;\r\n        tone.phaseDeltas[0] = phaseDeltaA / waveLength;\r\n        tone.phaseDeltas[1] = phaseDeltaB / waveLength;\r\n        tone.expression = expression;\r\n\r\n        synth.sanitizeFilters(filters);\r\n        tone.initialNoteFilterInput1 = initialFilterInput1;\r\n        tone.initialNoteFilterInput2 = initialFilterInput2;\r\n    }\r\n\r\n    private static harmonicsSynth(synth: Synth, bufferIndex: number, roundedSamplesPerTick: number, tone: Tone, instrumentState: InstrumentState): void {\r\n        const data: Float32Array = synth.tempMonoInstrumentSampleBuffer!;\r\n        const wave: Float32Array = instrumentState.wave!;\r\n        const waveLength: number = wave.length - 1; // The first sample is duplicated at the end, don't double-count it.\r\n\r\n        const unisonSign: number = tone.specialIntervalExpressionMult * instrumentState.unison!.sign;\r\n        if (instrumentState.unison!.voices == 1 && !instrumentState.chord!.customInterval) tone.phases[1] = tone.phases[0];\r\n        let phaseDeltaA: number = tone.phaseDeltas[0] * waveLength;\r\n        let phaseDeltaB: number = tone.phaseDeltas[1] * waveLength;\r\n        const phaseDeltaScaleA: number = +tone.phaseDeltaScales[0];\r\n        const phaseDeltaScaleB: number = +tone.phaseDeltaScales[1];\r\n        let expression: number = +tone.expression;\r\n        const expressionDelta: number = +tone.expressionDelta;\r\n        let phaseA: number = (tone.phases[0] % 1) * waveLength;\r\n        let phaseB: number = (tone.phases[1] % 1) * waveLength;\r\n\r\n        const filters: DynamicBiquadFilter[] = tone.noteFilters;\r\n        const filterCount: number = tone.noteFilterCount | 0;\r\n        let initialFilterInput1: number = +tone.initialNoteFilterInput1;\r\n        let initialFilterInput2: number = +tone.initialNoteFilterInput2;\r\n        const applyFilters: Function = Synth.applyFilters;\r\n\r\n        const phaseAInt: number = phaseA | 0;\r\n        const phaseBInt: number = phaseB | 0;\r\n        const indexA: number = phaseAInt % waveLength;\r\n        const indexB: number = phaseBInt % waveLength;\r\n        const phaseRatioA: number = phaseA - phaseAInt;\r\n        const phaseRatioB: number = phaseB - phaseBInt;\r\n        let prevWaveIntegralA: number = +wave[indexA];\r\n        let prevWaveIntegralB: number = +wave[indexB];\r\n        prevWaveIntegralA += (wave[indexA + 1] - prevWaveIntegralA) * phaseRatioA;\r\n        prevWaveIntegralB += (wave[indexB + 1] - prevWaveIntegralB) * phaseRatioB;\r\n\r\n        const stopIndex: number = bufferIndex + roundedSamplesPerTick;\r\n        for (let sampleIndex: number = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\r\n\r\n            phaseA += phaseDeltaA;\r\n            phaseB += phaseDeltaB;\r\n\r\n            const phaseAInt: number = phaseA | 0;\r\n            const phaseBInt: number = phaseB | 0;\r\n            const indexA: number = phaseAInt % waveLength;\r\n            const indexB: number = phaseBInt % waveLength;\r\n            let nextWaveIntegralA: number = wave[indexA];\r\n            let nextWaveIntegralB: number = wave[indexB];\r\n            const phaseRatioA: number = phaseA - phaseAInt;\r\n            const phaseRatioB: number = phaseB - phaseBInt;\r\n            nextWaveIntegralA += (wave[indexA + 1] - nextWaveIntegralA) * phaseRatioA;\r\n            nextWaveIntegralB += (wave[indexB + 1] - nextWaveIntegralB) * phaseRatioB;\r\n            const waveA: number = (nextWaveIntegralA - prevWaveIntegralA) / phaseDeltaA;\r\n            const waveB: number = (nextWaveIntegralB - prevWaveIntegralB) / phaseDeltaB;\r\n            prevWaveIntegralA = nextWaveIntegralA;\r\n            prevWaveIntegralB = nextWaveIntegralB;\r\n\r\n            const inputSample: number = waveA + waveB * unisonSign;\r\n            const sample: number = applyFilters(inputSample, initialFilterInput1, initialFilterInput2, filterCount, filters);\r\n            initialFilterInput2 = initialFilterInput1;\r\n            initialFilterInput1 = inputSample;\r\n\r\n            phaseDeltaA *= phaseDeltaScaleA;\r\n            phaseDeltaB *= phaseDeltaScaleB;\r\n\r\n            const output: number = sample * expression;\r\n            expression += expressionDelta;\r\n\r\n            data[sampleIndex] += output;\r\n        }\r\n\r\n        tone.phases[0] = phaseA / waveLength;\r\n        tone.phases[1] = phaseB / waveLength;\r\n        tone.phaseDeltas[0] = phaseDeltaA / waveLength;\r\n        tone.phaseDeltas[1] = phaseDeltaB / waveLength;\r\n        tone.expression = expression;\r\n\r\n        synth.sanitizeFilters(filters);\r\n        tone.initialNoteFilterInput1 = initialFilterInput1;\r\n        tone.initialNoteFilterInput2 = initialFilterInput2;\r\n    }\r\n\r\n    private static pickedStringSynth(synth: Synth, bufferIndex: number, roundedSamplesPerTick: number, tone: Tone, instrumentState: InstrumentState): void {\r\n        // This algorithm is similar to the Karpluss-Strong algorithm in principle, but with an\r\n        // all-pass filter for dispersion and with more control over the impulse harmonics.\r\n        // The source code is processed as a string before being compiled, in order to\r\n        // handle the unison feature. If unison is disabled or set to none, then only one\r\n        // string voice is required, otherwise two string voices are required. We only want\r\n        // to compute the minimum possible number of string voices, so omit the code for\r\n        // processing extra ones if possible. Any line containing a \"#\" is duplicated for\r\n        // each required voice, replacing the \"#\" with the voice index.\r\n\r\n        const voiceCount: number = instrumentState.unison!.voices;\r\n        let pickedStringFunction: Function = Synth.pickedStringFunctionCache[voiceCount];\r\n        if (pickedStringFunction == undefined) {\r\n            let pickedStringSource: string = \"\";\r\n\r\n            pickedStringSource += `\r\n\t\t\t\tconst Config = beepbox.Config;\r\n\t\t\t\tconst Synth = beepbox.Synth;\r\n\t\t\t\tconst data = synth.tempMonoInstrumentSampleBuffer;\r\n\t\t\t\t\r\n\t\t\t\tlet pickedString# = tone.pickedStrings[#];\r\n\t\t\t\tlet allPassSample# = +pickedString#.allPassSample;\r\n\t\t\t\tlet allPassPrevInput# = +pickedString#.allPassPrevInput;\r\n\t\t\t\tlet shelfSample# = +pickedString#.shelfSample;\r\n\t\t\t\tlet shelfPrevInput# = +pickedString#.shelfPrevInput;\r\n\t\t\t\tlet fractionalDelaySample# = +pickedString#.fractionalDelaySample;\r\n\t\t\t\tconst delayLine# = pickedString#.delayLine;\r\n\t\t\t\tconst delayBufferMask# = (delayLine#.length - 1) >> 0;\r\n\t\t\t\tlet delayIndex# = pickedString#.delayIndex|0;\r\n\t\t\t\tdelayIndex# = (delayIndex# & delayBufferMask#) + delayLine#.length;\r\n\t\t\t\tlet delayLength# = +pickedString#.prevDelayLength;\r\n\t\t\t\tconst delayLengthDelta# = +pickedString#.delayLengthDelta;\r\n\t\t\t\tlet allPassG# = +pickedString#.allPassG;\r\n\t\t\t\tlet shelfA1# = +pickedString#.shelfA1;\r\n\t\t\t\tlet shelfB0# = +pickedString#.shelfB0;\r\n\t\t\t\tlet shelfB1# = +pickedString#.shelfB1;\r\n\t\t\t\tconst allPassGDelta# = +pickedString#.allPassGDelta;\r\n\t\t\t\tconst shelfA1Delta# = +pickedString#.shelfA1Delta;\r\n\t\t\t\tconst shelfB0Delta# = +pickedString#.shelfB0Delta;\r\n\t\t\t\tconst shelfB1Delta# = +pickedString#.shelfB1Delta;\r\n\t\t\t\t\r\n\t\t\t\tlet expression = +tone.expression;\r\n\t\t\t\tconst expressionDelta = +tone.expressionDelta;\r\n\t\t\t\t\r\n\t\t\t\tconst unisonSign = tone.specialIntervalExpressionMult * instrumentState.unison.sign;\r\n\t\t\t\tconst delayResetOffset# = pickedString#.delayResetOffset|0;\r\n\t\t\t\t\r\n\t\t\t\tconst filters = tone.noteFilters;\r\n\t\t\t\tconst filterCount = tone.noteFilterCount|0;\r\n\t\t\t\tlet initialFilterInput1 = +tone.initialNoteFilterInput1;\r\n\t\t\t\tlet initialFilterInput2 = +tone.initialNoteFilterInput2;\r\n\t\t\t\tconst applyFilters = Synth.applyFilters;\r\n\t\t\t\t\r\n\t\t\t\tconst stopIndex = bufferIndex + runLength;\r\n\t\t\t\tfor (let sampleIndex = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\r\n\t\t\t\t\tconst targetSampleTime# = delayIndex# - delayLength#;\r\n\t\t\t\t\tconst lowerIndex# = (targetSampleTime# + 0.125) | 0; // Offset to improve stability of all-pass filter.\r\n\t\t\t\t\tconst upperIndex# = lowerIndex# + 1;\r\n\t\t\t\t\tconst fractionalDelay# = upperIndex# - targetSampleTime#;\r\n\t\t\t\t\tconst fractionalDelayG# = (1.0 - fractionalDelay#) / (1.0 + fractionalDelay#); // Inlined version of FilterCoefficients.prototype.allPass1stOrderFractionalDelay\r\n\t\t\t\t\tconst prevInput# = delayLine#[lowerIndex# & delayBufferMask#];\r\n\t\t\t\t\tconst input# = delayLine#[upperIndex# & delayBufferMask#];\r\n\t\t\t\t\tfractionalDelaySample# = fractionalDelayG# * input# + prevInput# - fractionalDelayG# * fractionalDelaySample#;\r\n\t\t\t\t\t\r\n\t\t\t\t\tallPassSample# = fractionalDelaySample# * allPassG# + allPassPrevInput# - allPassG# * allPassSample#;\r\n\t\t\t\t\tallPassPrevInput# = fractionalDelaySample#;\r\n\t\t\t\t\t\r\n\t\t\t\t\tshelfSample# = shelfB0# * allPassSample# + shelfB1# * shelfPrevInput# - shelfA1# * shelfSample#;\r\n\t\t\t\t\tshelfPrevInput# = allPassSample#;\r\n\t\t\t\t\t\r\n\t\t\t\t\tdelayLine#[delayIndex# & delayBufferMask#] += shelfSample#;\r\n\t\t\t\t\tdelayLine#[(delayIndex# + delayResetOffset#) & delayBufferMask#] = 0.0;\r\n\t\t\t\t\tdelayIndex#++;\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst inputSample = (`\r\n\r\n            const sampleList: string[] = [];\r\n            for (let voice: number = 0; voice < voiceCount; voice++) {\r\n                sampleList.push(\"fractionalDelaySample\" + voice + (voice == 1 ? \" * unisonSign\" : \"\"));\r\n            }\r\n\r\n            pickedStringSource += sampleList.join(\" + \");\r\n\r\n            pickedStringSource += `) * expression;\r\n\t\t\t\t\tconst sample = applyFilters(inputSample, initialFilterInput1, initialFilterInput2, filterCount, filters);\r\n\t\t\t\t\tinitialFilterInput2 = initialFilterInput1;\r\n\t\t\t\t\tinitialFilterInput1 = inputSample;\r\n\t\t\t\t\tdata[sampleIndex] += sample;\r\n\t\t\t\t\t\r\n\t\t\t\t\texpression += expressionDelta;\r\n\t\t\t\t\tdelayLength# += delayLengthDelta#;\r\n\t\t\t\t\tallPassG# += allPassGDelta#;\r\n\t\t\t\t\tshelfA1# += shelfA1Delta#;\r\n\t\t\t\t\tshelfB0# += shelfB0Delta#;\r\n\t\t\t\t\tshelfB1# += shelfB1Delta#;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t// Avoid persistent denormal or NaN values in the delay buffers and filter history.\r\n\t\t\t\tconst epsilon = (1.0e-24);\r\n\t\t\t\tif (!Number.isFinite(allPassSample#) || Math.abs(allPassSample#) < epsilon) allPassSample# = 0.0;\r\n\t\t\t\tif (!Number.isFinite(allPassPrevInput#) || Math.abs(allPassPrevInput#) < epsilon) allPassPrevInput# = 0.0;\r\n\t\t\t\tif (!Number.isFinite(shelfSample#) || Math.abs(shelfSample#) < epsilon) shelfSample# = 0.0;\r\n\t\t\t\tif (!Number.isFinite(shelfPrevInput#) || Math.abs(shelfPrevInput#) < epsilon) shelfPrevInput# = 0.0;\r\n\t\t\t\tif (!Number.isFinite(fractionalDelaySample#) || Math.abs(fractionalDelaySample#) < epsilon) fractionalDelaySample# = 0.0;\r\n\t\t\t\tpickedString#.allPassSample = allPassSample#;\r\n\t\t\t\tpickedString#.allPassPrevInput = allPassPrevInput#;\r\n\t\t\t\tpickedString#.shelfSample = shelfSample#;\r\n\t\t\t\tpickedString#.shelfPrevInput = shelfPrevInput#;\r\n\t\t\t\tpickedString#.fractionalDelaySample = fractionalDelaySample#;\r\n\t\t\t\tpickedString#.delayIndex = delayIndex#;\r\n\t\t\t\tpickedString#.prevDelayLength = delayLength#;\r\n\t\t\t\tpickedString#.allPassG = allPassG#;\r\n\t\t\t\tpickedString#.shelfA1 = shelfA1#;\r\n\t\t\t\tpickedString#.shelfB0 = shelfB0#;\r\n\t\t\t\tpickedString#.shelfB1 = shelfB1#;\r\n\t\t\t\t\r\n\t\t\t\ttone.expression = expression;\r\n\t\t\t\t\r\n\t\t\t\tsynth.sanitizeFilters(filters);\r\n\t\t\t\ttone.initialNoteFilterInput1 = initialFilterInput1;\r\n\t\t\t\ttone.initialNoteFilterInput2 = initialFilterInput2;`\r\n\r\n            // Duplicate lines containing \"#\" for each voice and replace the \"#\" with the voice index.\r\n            pickedStringSource = pickedStringSource.replace(/^.*\\#.*$/mg, line => {\r\n                const lines = [];\r\n                for (let voice: number = 0; voice < voiceCount; voice++) {\r\n                    lines.push(line.replace(/\\#/g, String(voice)));\r\n                }\r\n                return lines.join(\"\\n\");\r\n            });\r\n\r\n            //console.log(pickedStringSource);\r\n            pickedStringFunction = new Function(\"synth\", \"bufferIndex\", \"runLength\", \"tone\", \"instrumentState\", pickedStringSource);\r\n            Synth.pickedStringFunctionCache[voiceCount] = pickedStringFunction;\r\n        }\r\n\r\n        pickedStringFunction(synth, bufferIndex, roundedSamplesPerTick, tone, instrumentState);\r\n    }\r\n\r\n    private static effectsSynth(synth: Synth, outputDataL: Float32Array, outputDataR: Float32Array, bufferIndex: number, runLength: number, instrumentState: InstrumentState): void {\r\n        // TODO: If automation is involved, don't assume sliders will stay at zero.\r\n        // @jummbus - ^ Correct, removed the non-zero checks as modulation can change them.\r\n\r\n        const usesDistortion: boolean = effectsIncludeDistortion(instrumentState.effects);\r\n        const usesBitcrusher: boolean = effectsIncludeBitcrusher(instrumentState.effects);\r\n        const usesEqFilter: boolean = instrumentState.eqFilterCount > 0;\r\n        const usesPanning: boolean = effectsIncludePanning(instrumentState.effects);\r\n        const usesChorus: boolean = effectsIncludeChorus(instrumentState.effects);\r\n        const usesEcho: boolean = effectsIncludeEcho(instrumentState.effects);\r\n        const usesReverb: boolean = effectsIncludeReverb(instrumentState.effects);\r\n        let signature: number = 0; if (usesDistortion) signature = signature | 1;\r\n        signature = signature << 1; if (usesBitcrusher) signature = signature | 1;\r\n        signature = signature << 1; if (usesEqFilter) signature = signature | 1;\r\n        signature = signature << 1; if (usesPanning) signature = signature | 1;\r\n        signature = signature << 1; if (usesChorus) signature = signature | 1;\r\n        signature = signature << 1; if (usesEcho) signature = signature | 1;\r\n        signature = signature << 1; if (usesReverb) signature = signature | 1;\r\n\r\n        let effectsFunction: Function = Synth.effectsFunctionCache[signature];\r\n        if (effectsFunction == undefined) {\r\n            let effectsSource: string = \"\";\r\n\r\n            const usesDelays: boolean = usesChorus || usesReverb || usesEcho;\r\n\r\n            effectsSource += `\r\n\t\t\t\tconst Config = beepbox.Config;\r\n\t\t\t\tconst tempMonoInstrumentSampleBuffer = synth.tempMonoInstrumentSampleBuffer;\r\n\t\t\t\t\r\n\t\t\t\tlet mixVolume = +instrumentState.mixVolume;\r\n\t\t\t\tconst mixVolumeDelta = +instrumentState.mixVolumeDelta;`\r\n\r\n            if (usesDelays) {\r\n                effectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tlet delayInputMult = +instrumentState.delayInputMult;\r\n\t\t\t\tconst delayInputMultDelta = +instrumentState.delayInputMultDelta;`\r\n            }\r\n\r\n            if (usesDistortion) {\r\n                // Distortion can sometimes create noticeable aliasing.\r\n                // It seems the established industry best practice for distortion antialiasing\r\n                // is to upsample the inputs (\"zero stuffing\" followed by a brick wall lowpass\r\n                // at the original nyquist frequency), perform the distortion, then downsample\r\n                // (the lowpass again followed by dropping in-between samples). This is\r\n                // \"mathematically correct\" in that it preserves only the intended frequencies,\r\n                // but it has several unfortunate tradeoffs depending on the choice of filter,\r\n                // introducing latency and/or time smearing, since no true brick wall filter\r\n                // exists. For the time being, I've opted to instead generate in-between input\r\n                // samples using fractional delay all-pass filters, and after distorting them,\r\n                // I \"downsample\" these with a simple weighted sum.\r\n\r\n                effectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tconst distortionBaseVolume = +Config.distortionBaseVolume;\r\n\t\t\t\tlet distortion = instrumentState.distortion;\r\n\t\t\t\tconst distortionDelta = instrumentState.distortionDelta;\r\n\t\t\t\tlet distortionDrive = instrumentState.distortionDrive;\r\n\t\t\t\tconst distortionDriveDelta = instrumentState.distortionDriveDelta;\r\n\t\t\t\tconst distortionFractionalResolution = 4.0;\r\n\t\t\t\tconst distortionOversampleCompensation = distortionBaseVolume / distortionFractionalResolution;\r\n\t\t\t\tconst distortionFractionalDelay1 = 1.0 / distortionFractionalResolution;\r\n\t\t\t\tconst distortionFractionalDelay2 = 2.0 / distortionFractionalResolution;\r\n\t\t\t\tconst distortionFractionalDelay3 = 3.0 / distortionFractionalResolution;\r\n\t\t\t\tconst distortionFractionalDelayG1 = (1.0 - distortionFractionalDelay1) / (1.0 + distortionFractionalDelay1); // Inlined version of FilterCoefficients.prototype.allPass1stOrderFractionalDelay\r\n\t\t\t\tconst distortionFractionalDelayG2 = (1.0 - distortionFractionalDelay2) / (1.0 + distortionFractionalDelay2); // Inlined version of FilterCoefficients.prototype.allPass1stOrderFractionalDelay\r\n\t\t\t\tconst distortionFractionalDelayG3 = (1.0 - distortionFractionalDelay3) / (1.0 + distortionFractionalDelay3); // Inlined version of FilterCoefficients.prototype.allPass1stOrderFractionalDelay\r\n\t\t\t\tconst distortionNextOutputWeight1 = Math.cos(Math.PI * distortionFractionalDelay1) * 0.5 + 0.5;\r\n\t\t\t\tconst distortionNextOutputWeight2 = Math.cos(Math.PI * distortionFractionalDelay2) * 0.5 + 0.5;\r\n\t\t\t\tconst distortionNextOutputWeight3 = Math.cos(Math.PI * distortionFractionalDelay3) * 0.5 + 0.5;\r\n\t\t\t\tconst distortionPrevOutputWeight1 = 1.0 - distortionNextOutputWeight1;\r\n\t\t\t\tconst distortionPrevOutputWeight2 = 1.0 - distortionNextOutputWeight2;\r\n\t\t\t\tconst distortionPrevOutputWeight3 = 1.0 - distortionNextOutputWeight3;\r\n\t\t\t\t\r\n\t\t\t\tlet distortionFractionalInput1 = +instrumentState.distortionFractionalInput1;\r\n\t\t\t\tlet distortionFractionalInput2 = +instrumentState.distortionFractionalInput2;\r\n\t\t\t\tlet distortionFractionalInput3 = +instrumentState.distortionFractionalInput3;\r\n\t\t\t\tlet distortionPrevInput = +instrumentState.distortionPrevInput;\r\n\t\t\t\tlet distortionNextOutput = +instrumentState.distortionNextOutput;`\r\n            }\r\n\r\n            if (usesBitcrusher) {\r\n                effectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tlet bitcrusherPrevInput = +instrumentState.bitcrusherPrevInput;\r\n\t\t\t\tlet bitcrusherCurrentOutput = +instrumentState.bitcrusherCurrentOutput;\r\n\t\t\t\tlet bitcrusherPhase = +instrumentState.bitcrusherPhase;\r\n\t\t\t\tlet bitcrusherPhaseDelta = +instrumentState.bitcrusherPhaseDelta;\r\n\t\t\t\tconst bitcrusherPhaseDeltaScale = +instrumentState.bitcrusherPhaseDeltaScale;\r\n\t\t\t\tlet bitcrusherScale = +instrumentState.bitcrusherScale;\r\n\t\t\t\tconst bitcrusherScaleScale = +instrumentState.bitcrusherScaleScale;\r\n\t\t\t\tlet bitcrusherFoldLevel = +instrumentState.bitcrusherFoldLevel;\r\n\t\t\t\tconst bitcrusherFoldLevelScale = +instrumentState.bitcrusherFoldLevelScale;`\r\n            }\r\n\r\n            if (usesEqFilter) {\r\n                effectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tlet filters = instrumentState.eqFilters;\r\n\t\t\t\tconst filterCount = instrumentState.eqFilterCount|0;\r\n\t\t\t\tlet initialFilterInput1 = +instrumentState.initialEqFilterInput1;\r\n\t\t\t\tlet initialFilterInput2 = +instrumentState.initialEqFilterInput2;\r\n\t\t\t\tconst applyFilters = beepbox.Synth.applyFilters;`\r\n            }\r\n\r\n            // The eq filter volume is also used to fade out the instrument state, so always include it.\r\n            effectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tlet eqFilterVolume = +instrumentState.eqFilterVolume;\r\n\t\t\t\tconst eqFilterVolumeDelta = +instrumentState.eqFilterVolumeDelta;`\r\n\r\n            if (usesPanning) {\r\n                effectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tconst panningMask = synth.panningDelayBufferMask >>> 0;\r\n\t\t\t\tconst panningDelayLine = instrumentState.panningDelayLine;\r\n\t\t\t\tlet panningDelayPos = instrumentState.panningDelayPos & panningMask;\r\n\t\t\t\tlet   panningVolumeL      = +instrumentState.panningVolumeL;\r\n\t\t\t\tlet   panningVolumeR      = +instrumentState.panningVolumeR;\r\n\t\t\t\tconst panningVolumeDeltaL = +instrumentState.panningVolumeDeltaL;\r\n\t\t\t\tconst panningVolumeDeltaR = +instrumentState.panningVolumeDeltaR;\r\n\t\t\t\tlet   panningOffsetL      = +instrumentState.panningOffsetL;\r\n\t\t\t\tlet   panningOffsetR      = +instrumentState.panningOffsetR;\r\n\t\t\t\tconst panningOffsetDeltaL = 1.0 - instrumentState.panningOffsetDeltaL;\r\n\t\t\t\tconst panningOffsetDeltaR = 1.0 - instrumentState.panningOffsetDeltaR;`\r\n            }\r\n\r\n            if (usesChorus) {\r\n                effectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tconst chorusMask = synth.chorusDelayBufferMask >>> 0;\r\n\t\t\t\tconst chorusDelayLineL = instrumentState.chorusDelayLineL;\r\n\t\t\t\tconst chorusDelayLineR = instrumentState.chorusDelayLineR;\r\n\t\t\t\tinstrumentState.chorusDelayLineDirty = true;\r\n\t\t\t\tlet chorusDelayPos = instrumentState.chorusDelayPos & chorusMask;\r\n\t\t\t\t\r\n\t\t\t\tlet chorusVoiceMult = +instrumentState.chorusVoiceMult;\r\n\t\t\t\tconst chorusVoiceMultDelta = +instrumentState.chorusVoiceMultDelta;\r\n\t\t\t\tlet chorusCombinedMult = +instrumentState.chorusCombinedMult;\r\n\t\t\t\tconst chorusCombinedMultDelta = +instrumentState.chorusCombinedMultDelta;\r\n\t\t\t\t\r\n\t\t\t\tconst chorusDuration = +beepbox.Config.chorusPeriodSeconds;\r\n\t\t\t\tconst chorusAngle = Math.PI * 2.0 / (chorusDuration * synth.samplesPerSecond);\r\n\t\t\t\tconst chorusRange = synth.samplesPerSecond * beepbox.Config.chorusDelayRange;\r\n\t\t\t\tconst chorusOffset0 = synth.chorusDelayBufferSize - beepbox.Config.chorusDelayOffsets[0][0] * chorusRange;\r\n\t\t\t\tconst chorusOffset1 = synth.chorusDelayBufferSize - beepbox.Config.chorusDelayOffsets[0][1] * chorusRange;\r\n\t\t\t\tconst chorusOffset2 = synth.chorusDelayBufferSize - beepbox.Config.chorusDelayOffsets[0][2] * chorusRange;\r\n\t\t\t\tconst chorusOffset3 = synth.chorusDelayBufferSize - beepbox.Config.chorusDelayOffsets[1][0] * chorusRange;\r\n\t\t\t\tconst chorusOffset4 = synth.chorusDelayBufferSize - beepbox.Config.chorusDelayOffsets[1][1] * chorusRange;\r\n\t\t\t\tconst chorusOffset5 = synth.chorusDelayBufferSize - beepbox.Config.chorusDelayOffsets[1][2] * chorusRange;\r\n\t\t\t\tlet chorusPhase = instrumentState.chorusPhase % (Math.PI * 2.0);\r\n\t\t\t\tlet chorusTap0Index = chorusDelayPos + chorusOffset0 - chorusRange * Math.sin(chorusPhase + beepbox.Config.chorusPhaseOffsets[0][0]);\r\n\t\t\t\tlet chorusTap1Index = chorusDelayPos + chorusOffset1 - chorusRange * Math.sin(chorusPhase + beepbox.Config.chorusPhaseOffsets[0][1]);\r\n\t\t\t\tlet chorusTap2Index = chorusDelayPos + chorusOffset2 - chorusRange * Math.sin(chorusPhase + beepbox.Config.chorusPhaseOffsets[0][2]);\r\n\t\t\t\tlet chorusTap3Index = chorusDelayPos + chorusOffset3 - chorusRange * Math.sin(chorusPhase + beepbox.Config.chorusPhaseOffsets[1][0]);\r\n\t\t\t\tlet chorusTap4Index = chorusDelayPos + chorusOffset4 - chorusRange * Math.sin(chorusPhase + beepbox.Config.chorusPhaseOffsets[1][1]);\r\n\t\t\t\tlet chorusTap5Index = chorusDelayPos + chorusOffset5 - chorusRange * Math.sin(chorusPhase + beepbox.Config.chorusPhaseOffsets[1][2]);\r\n\t\t\t\tchorusPhase += chorusAngle * runLength;\r\n\t\t\t\tconst chorusTap0End = chorusDelayPos + chorusOffset0 - chorusRange * Math.sin(chorusPhase + beepbox.Config.chorusPhaseOffsets[0][0]) + runLength;\r\n\t\t\t\tconst chorusTap1End = chorusDelayPos + chorusOffset1 - chorusRange * Math.sin(chorusPhase + beepbox.Config.chorusPhaseOffsets[0][1]) + runLength;\r\n\t\t\t\tconst chorusTap2End = chorusDelayPos + chorusOffset2 - chorusRange * Math.sin(chorusPhase + beepbox.Config.chorusPhaseOffsets[0][2]) + runLength;\r\n\t\t\t\tconst chorusTap3End = chorusDelayPos + chorusOffset3 - chorusRange * Math.sin(chorusPhase + beepbox.Config.chorusPhaseOffsets[1][0]) + runLength;\r\n\t\t\t\tconst chorusTap4End = chorusDelayPos + chorusOffset4 - chorusRange * Math.sin(chorusPhase + beepbox.Config.chorusPhaseOffsets[1][1]) + runLength;\r\n\t\t\t\tconst chorusTap5End = chorusDelayPos + chorusOffset5 - chorusRange * Math.sin(chorusPhase + beepbox.Config.chorusPhaseOffsets[1][2]) + runLength;\r\n\t\t\t\tconst chorusTap0Delta = (chorusTap0End - chorusTap0Index) / runLength;\r\n\t\t\t\tconst chorusTap1Delta = (chorusTap1End - chorusTap1Index) / runLength;\r\n\t\t\t\tconst chorusTap2Delta = (chorusTap2End - chorusTap2Index) / runLength;\r\n\t\t\t\tconst chorusTap3Delta = (chorusTap3End - chorusTap3Index) / runLength;\r\n\t\t\t\tconst chorusTap4Delta = (chorusTap4End - chorusTap4Index) / runLength;\r\n\t\t\t\tconst chorusTap5Delta = (chorusTap5End - chorusTap5Index) / runLength;`\r\n            }\r\n\r\n            if (usesEcho) {\r\n                effectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tlet echoMult = +instrumentState.echoMult;\r\n\t\t\t\tconst echoMultDelta = +instrumentState.echoMultDelta;\r\n\t\t\t\t\r\n\t\t\t\tconst echoDelayLineL = instrumentState.echoDelayLineL;\r\n\t\t\t\tconst echoDelayLineR = instrumentState.echoDelayLineR;\r\n\t\t\t\tconst echoMask = (echoDelayLineL.length - 1) >>> 0;\r\n\t\t\t\tinstrumentState.echoDelayLineDirty = true;\r\n\t\t\t\t\r\n\t\t\t\tlet echoDelayPos = instrumentState.echoDelayPos & echoMask;\r\n\t\t\t\tconst echoDelayOffsetStart = (echoDelayLineL.length - instrumentState.echoDelayOffsetStart) & echoMask;\r\n\t\t\t\tconst echoDelayOffsetEnd   = (echoDelayLineL.length - instrumentState.echoDelayOffsetEnd) & echoMask;\r\n\t\t\t\tlet echoDelayOffsetRatio = +instrumentState.echoDelayOffsetRatio;\r\n\t\t\t\tconst echoDelayOffsetRatioDelta = +instrumentState.echoDelayOffsetRatioDelta;\r\n\t\t\t\t\r\n\t\t\t\tconst echoShelfA1 = +instrumentState.echoShelfA1;\r\n\t\t\t\tconst echoShelfB0 = +instrumentState.echoShelfB0;\r\n\t\t\t\tconst echoShelfB1 = +instrumentState.echoShelfB1;\r\n\t\t\t\tlet echoShelfSampleL = +instrumentState.echoShelfSampleL;\r\n\t\t\t\tlet echoShelfSampleR = +instrumentState.echoShelfSampleR;\r\n\t\t\t\tlet echoShelfPrevInputL = +instrumentState.echoShelfPrevInputL;\r\n\t\t\t\tlet echoShelfPrevInputR = +instrumentState.echoShelfPrevInputR;`\r\n            }\r\n\r\n            if (usesReverb) {\r\n                effectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tconst reverbMask = Config.reverbDelayBufferMask >>> 0; //TODO: Dynamic reverb buffer size.\r\n\t\t\t\tconst reverbDelayLine = instrumentState.reverbDelayLine;\r\n\t\t\t\tinstrumentState.reverbDelayLineDirty = true;\r\n\t\t\t\tlet reverbDelayPos = instrumentState.reverbDelayPos & reverbMask;\r\n\t\t\t\t\r\n\t\t\t\tlet reverb = +instrumentState.reverbMult;\r\n\t\t\t\tconst reverbDelta = +instrumentState.reverbMultDelta;\r\n\t\t\t\t\r\n\t\t\t\tconst reverbShelfA1 = +instrumentState.reverbShelfA1;\r\n\t\t\t\tconst reverbShelfB0 = +instrumentState.reverbShelfB0;\r\n\t\t\t\tconst reverbShelfB1 = +instrumentState.reverbShelfB1;\r\n\t\t\t\tlet reverbShelfSample0 = +instrumentState.reverbShelfSample0;\r\n\t\t\t\tlet reverbShelfSample1 = +instrumentState.reverbShelfSample1;\r\n\t\t\t\tlet reverbShelfSample2 = +instrumentState.reverbShelfSample2;\r\n\t\t\t\tlet reverbShelfSample3 = +instrumentState.reverbShelfSample3;\r\n\t\t\t\tlet reverbShelfPrevInput0 = +instrumentState.reverbShelfPrevInput0;\r\n\t\t\t\tlet reverbShelfPrevInput1 = +instrumentState.reverbShelfPrevInput1;\r\n\t\t\t\tlet reverbShelfPrevInput2 = +instrumentState.reverbShelfPrevInput2;\r\n\t\t\t\tlet reverbShelfPrevInput3 = +instrumentState.reverbShelfPrevInput3;`\r\n            }\r\n\r\n            effectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tconst stopIndex = bufferIndex + runLength;\r\n\t\t\t\tfor (let sampleIndex = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\r\n\t\t\t\t\tlet sample = tempMonoInstrumentSampleBuffer[sampleIndex];\r\n\t\t\t\t\ttempMonoInstrumentSampleBuffer[sampleIndex] = 0.0;`\r\n\r\n            if (usesDistortion) {\r\n                effectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst distortionReverse = 1.0 - distortion;\r\n\t\t\t\t\tconst distortionNextInput = sample * distortionDrive;\r\n\t\t\t\t\tsample = distortionNextOutput;\r\n\t\t\t\t\tdistortionNextOutput = distortionNextInput / (distortionReverse * Math.abs(distortionNextInput) + distortion);\r\n\t\t\t\t\tdistortionFractionalInput1 = distortionFractionalDelayG1 * distortionNextInput + distortionPrevInput - distortionFractionalDelayG1 * distortionFractionalInput1;\r\n\t\t\t\t\tdistortionFractionalInput2 = distortionFractionalDelayG2 * distortionNextInput + distortionPrevInput - distortionFractionalDelayG2 * distortionFractionalInput2;\r\n\t\t\t\t\tdistortionFractionalInput3 = distortionFractionalDelayG3 * distortionNextInput + distortionPrevInput - distortionFractionalDelayG3 * distortionFractionalInput3;\r\n\t\t\t\t\tconst distortionOutput1 = distortionFractionalInput1 / (distortionReverse * Math.abs(distortionFractionalInput1) + distortion);\r\n\t\t\t\t\tconst distortionOutput2 = distortionFractionalInput2 / (distortionReverse * Math.abs(distortionFractionalInput2) + distortion);\r\n\t\t\t\t\tconst distortionOutput3 = distortionFractionalInput3 / (distortionReverse * Math.abs(distortionFractionalInput3) + distortion);\r\n\t\t\t\t\tdistortionNextOutput += distortionOutput1 * distortionNextOutputWeight1 + distortionOutput2 * distortionNextOutputWeight2 + distortionOutput3 * distortionNextOutputWeight3;\r\n\t\t\t\t\tsample += distortionOutput1 * distortionPrevOutputWeight1 + distortionOutput2 * distortionPrevOutputWeight2 + distortionOutput3 * distortionPrevOutputWeight3;\r\n\t\t\t\t\tsample *= distortionOversampleCompensation;\r\n\t\t\t\t\tdistortionPrevInput = distortionNextInput;\r\n\t\t\t\t\tdistortion += distortionDelta;\r\n\t\t\t\t\tdistortionDrive += distortionDriveDelta;`\r\n            }\r\n\r\n            if (usesBitcrusher) {\r\n                effectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\t\tbitcrusherPhase += bitcrusherPhaseDelta;\r\n\t\t\t\t\tif (bitcrusherPhase < 1.0) {\r\n\t\t\t\t\t\tbitcrusherPrevInput = sample;\r\n\t\t\t\t\t\tsample = bitcrusherCurrentOutput;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tbitcrusherPhase = bitcrusherPhase % 1.0;\r\n\t\t\t\t\t\tconst ratio = bitcrusherPhase / bitcrusherPhaseDelta;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tconst lerpedInput = sample + (bitcrusherPrevInput - sample) * ratio;\r\n\t\t\t\t\t\tbitcrusherPrevInput = sample;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tconst bitcrusherWrapLevel = bitcrusherFoldLevel * 4.0;\r\n\t\t\t\t\t\tconst wrappedSample = (((lerpedInput + bitcrusherFoldLevel) % bitcrusherWrapLevel) + bitcrusherWrapLevel) % bitcrusherWrapLevel;\r\n\t\t\t\t\t\tconst foldedSample = bitcrusherFoldLevel - Math.abs(bitcrusherFoldLevel * 2.0 - wrappedSample);\r\n\t\t\t\t\t\tconst scaledSample = foldedSample / bitcrusherScale;\r\n\t\t\t\t\t\tconst oldValue = bitcrusherCurrentOutput;\r\n\t\t\t\t\t\tconst newValue = (((scaledSample > 0 ? scaledSample + 1 : scaledSample)|0)-.5) * bitcrusherScale;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tsample = oldValue + (newValue - oldValue) * ratio;\r\n\t\t\t\t\t\tbitcrusherCurrentOutput = newValue;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbitcrusherPhaseDelta *= bitcrusherPhaseDeltaScale;\r\n\t\t\t\t\tbitcrusherScale *= bitcrusherScaleScale;\r\n\t\t\t\t\tbitcrusherFoldLevel *= bitcrusherFoldLevelScale;`\r\n            }\r\n\r\n            if (usesEqFilter) {\r\n                effectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst inputSample = sample;\r\n\t\t\t\t\tsample = applyFilters(inputSample, initialFilterInput1, initialFilterInput2, filterCount, filters);\r\n\t\t\t\t\tinitialFilterInput2 = initialFilterInput1;\r\n\t\t\t\t\tinitialFilterInput1 = inputSample;`\r\n            }\r\n\r\n            // The eq filter volume is also used to fade out the instrument state, so always include it.\r\n            effectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\t\tsample *= eqFilterVolume;\r\n\t\t\t\t\teqFilterVolume += eqFilterVolumeDelta;`\r\n\r\n            if (usesPanning) {\r\n                effectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\t\tpanningDelayLine[panningDelayPos] = sample;\r\n\t\t\t\t\tconst panningRatioL  = panningOffsetL % 1;\r\n\t\t\t\t\tconst panningRatioR  = panningOffsetR % 1;\r\n\t\t\t\t\tconst panningTapLA   = panningDelayLine[(panningOffsetL) & panningMask];\r\n\t\t\t\t\tconst panningTapLB   = panningDelayLine[(panningOffsetL + 1) & panningMask];\r\n\t\t\t\t\tconst panningTapRA   = panningDelayLine[(panningOffsetR) & panningMask];\r\n\t\t\t\t\tconst panningTapRB   = panningDelayLine[(panningOffsetR + 1) & panningMask];\r\n\t\t\t\t\tconst panningTapL    = panningTapLA + (panningTapLB - panningTapLA) * panningRatioL;\r\n\t\t\t\t\tconst panningTapR    = panningTapRA + (panningTapRB - panningTapRA) * panningRatioR;\r\n\t\t\t\t\tlet sampleL = panningTapL * panningVolumeL;\r\n\t\t\t\t\tlet sampleR = panningTapR * panningVolumeR;\r\n\t\t\t\t\tpanningDelayPos = (panningDelayPos + 1) & panningMask;\r\n\t\t\t\t\tpanningVolumeL += panningVolumeDeltaL;\r\n\t\t\t\t\tpanningVolumeR += panningVolumeDeltaR;\r\n\t\t\t\t\tpanningOffsetL += panningOffsetDeltaL;\r\n\t\t\t\t\tpanningOffsetR += panningOffsetDeltaR;`\r\n            } else {\r\n                effectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\t\tlet sampleL = sample;\r\n\t\t\t\t\tlet sampleR = sample;`\r\n            }\r\n\r\n            if (usesChorus) {\r\n                effectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst chorusTap0Ratio = chorusTap0Index % 1;\r\n\t\t\t\t\tconst chorusTap1Ratio = chorusTap1Index % 1;\r\n\t\t\t\t\tconst chorusTap2Ratio = chorusTap2Index % 1;\r\n\t\t\t\t\tconst chorusTap3Ratio = chorusTap3Index % 1;\r\n\t\t\t\t\tconst chorusTap4Ratio = chorusTap4Index % 1;\r\n\t\t\t\t\tconst chorusTap5Ratio = chorusTap5Index % 1;\r\n\t\t\t\t\tconst chorusTap0A = chorusDelayLineL[(chorusTap0Index) & chorusMask];\r\n\t\t\t\t\tconst chorusTap0B = chorusDelayLineL[(chorusTap0Index + 1) & chorusMask];\r\n\t\t\t\t\tconst chorusTap1A = chorusDelayLineL[(chorusTap1Index) & chorusMask];\r\n\t\t\t\t\tconst chorusTap1B = chorusDelayLineL[(chorusTap1Index + 1) & chorusMask];\r\n\t\t\t\t\tconst chorusTap2A = chorusDelayLineL[(chorusTap2Index) & chorusMask];\r\n\t\t\t\t\tconst chorusTap2B = chorusDelayLineL[(chorusTap2Index + 1) & chorusMask];\r\n\t\t\t\t\tconst chorusTap3A = chorusDelayLineR[(chorusTap3Index) & chorusMask];\r\n\t\t\t\t\tconst chorusTap3B = chorusDelayLineR[(chorusTap3Index + 1) & chorusMask];\r\n\t\t\t\t\tconst chorusTap4A = chorusDelayLineR[(chorusTap4Index) & chorusMask];\r\n\t\t\t\t\tconst chorusTap4B = chorusDelayLineR[(chorusTap4Index + 1) & chorusMask];\r\n\t\t\t\t\tconst chorusTap5A = chorusDelayLineR[(chorusTap5Index) & chorusMask];\r\n\t\t\t\t\tconst chorusTap5B = chorusDelayLineR[(chorusTap5Index + 1) & chorusMask];\r\n\t\t\t\t\tconst chorusTap0 = chorusTap0A + (chorusTap0B - chorusTap0A) * chorusTap0Ratio;\r\n\t\t\t\t\tconst chorusTap1 = chorusTap1A + (chorusTap1B - chorusTap1A) * chorusTap1Ratio;\r\n\t\t\t\t\tconst chorusTap2 = chorusTap2A + (chorusTap2B - chorusTap2A) * chorusTap2Ratio;\r\n\t\t\t\t\tconst chorusTap3 = chorusTap3A + (chorusTap3B - chorusTap3A) * chorusTap3Ratio;\r\n\t\t\t\t\tconst chorusTap4 = chorusTap4A + (chorusTap4B - chorusTap4A) * chorusTap4Ratio;\r\n\t\t\t\t\tconst chorusTap5 = chorusTap5A + (chorusTap5B - chorusTap5A) * chorusTap5Ratio;\r\n\t\t\t\t\tchorusDelayLineL[chorusDelayPos] = sampleL * delayInputMult;\r\n\t\t\t\t\tchorusDelayLineR[chorusDelayPos] = sampleR * delayInputMult;\r\n\t\t\t\t\tsampleL = chorusCombinedMult * (sampleL + chorusVoiceMult * (chorusTap1 - chorusTap0 - chorusTap2));\r\n\t\t\t\t\tsampleR = chorusCombinedMult * (sampleR + chorusVoiceMult * (chorusTap4 - chorusTap3 - chorusTap5));\r\n\t\t\t\t\tchorusDelayPos = (chorusDelayPos + 1) & chorusMask;\r\n\t\t\t\t\tchorusTap0Index += chorusTap0Delta;\r\n\t\t\t\t\tchorusTap1Index += chorusTap1Delta;\r\n\t\t\t\t\tchorusTap2Index += chorusTap2Delta;\r\n\t\t\t\t\tchorusTap3Index += chorusTap3Delta;\r\n\t\t\t\t\tchorusTap4Index += chorusTap4Delta;\r\n\t\t\t\t\tchorusTap5Index += chorusTap5Delta;\r\n\t\t\t\t\tchorusVoiceMult += chorusVoiceMultDelta;\r\n\t\t\t\t\tchorusCombinedMult += chorusCombinedMultDelta;`\r\n            }\r\n\r\n            if (usesEcho) {\r\n                effectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst echoTapStartIndex = (echoDelayPos + echoDelayOffsetStart) & echoMask;\r\n\t\t\t\t\tconst echoTapEndIndex   = (echoDelayPos + echoDelayOffsetEnd  ) & echoMask;\r\n\t\t\t\t\tconst echoTapStartL = echoDelayLineL[echoTapStartIndex];\r\n\t\t\t\t\tconst echoTapEndL   = echoDelayLineL[echoTapEndIndex];\r\n\t\t\t\t\tconst echoTapStartR = echoDelayLineR[echoTapStartIndex];\r\n\t\t\t\t\tconst echoTapEndR   = echoDelayLineR[echoTapEndIndex];\r\n\t\t\t\t\tconst echoTapL = (echoTapStartL + (echoTapEndL - echoTapStartL) * echoDelayOffsetRatio) * echoMult;\r\n\t\t\t\t\tconst echoTapR = (echoTapStartR + (echoTapEndR - echoTapStartR) * echoDelayOffsetRatio) * echoMult;\r\n\t\t\t\t\t\r\n\t\t\t\t\techoShelfSampleL = echoShelfB0 * echoTapL + echoShelfB1 * echoShelfPrevInputL - echoShelfA1 * echoShelfSampleL;\r\n\t\t\t\t\techoShelfSampleR = echoShelfB0 * echoTapR + echoShelfB1 * echoShelfPrevInputR - echoShelfA1 * echoShelfSampleR;\r\n\t\t\t\t\techoShelfPrevInputL = echoTapL;\r\n\t\t\t\t\techoShelfPrevInputR = echoTapR;\r\n\t\t\t\t\tsampleL += echoShelfSampleL;\r\n\t\t\t\t\tsampleR += echoShelfSampleR;\r\n\t\t\t\t\t\r\n\t\t\t\t\techoDelayLineL[echoDelayPos] = sampleL * delayInputMult;\r\n\t\t\t\t\techoDelayLineR[echoDelayPos] = sampleR * delayInputMult;\r\n\t\t\t\t\techoDelayPos = (echoDelayPos + 1) & echoMask;\r\n\t\t\t\t\techoDelayOffsetRatio += echoDelayOffsetRatioDelta;\r\n\t\t\t\t\techoMult += echoMultDelta;\r\n                    `\r\n            }\r\n\r\n            if (usesReverb) {\r\n                effectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Reverb, implemented using a feedback delay network with a Hadamard matrix and lowpass filters.\r\n\t\t\t\t\t// good ratios:    0.555235 + 0.618033 + 0.818 +   1.0 = 2.991268\r\n\t\t\t\t\t// Delay lengths:  3041     + 3385     + 4481  +  5477 = 16384 = 2^14\r\n\t\t\t\t\t// Buffer offsets: 3041    -> 6426   -> 10907 -> 16384\r\n\t\t\t\t\tconst reverbDelayPos1 = (reverbDelayPos +  3041) & reverbMask;\r\n\t\t\t\t\tconst reverbDelayPos2 = (reverbDelayPos +  6426) & reverbMask;\r\n\t\t\t\t\tconst reverbDelayPos3 = (reverbDelayPos + 10907) & reverbMask;\r\n\t\t\t\t\tconst reverbSample0 = (reverbDelayLine[reverbDelayPos]);\r\n\t\t\t\t\tconst reverbSample1 = reverbDelayLine[reverbDelayPos1];\r\n\t\t\t\t\tconst reverbSample2 = reverbDelayLine[reverbDelayPos2];\r\n\t\t\t\t\tconst reverbSample3 = reverbDelayLine[reverbDelayPos3];\r\n\t\t\t\t\tconst reverbTemp0 = -(reverbSample0 + sampleL) + reverbSample1;\r\n\t\t\t\t\tconst reverbTemp1 = -(reverbSample0 + sampleR) - reverbSample1;\r\n\t\t\t\t\tconst reverbTemp2 = -reverbSample2 + reverbSample3;\r\n\t\t\t\t\tconst reverbTemp3 = -reverbSample2 - reverbSample3;\r\n\t\t\t\t\tconst reverbShelfInput0 = (reverbTemp0 + reverbTemp2) * reverb;\r\n\t\t\t\t\tconst reverbShelfInput1 = (reverbTemp1 + reverbTemp3) * reverb;\r\n\t\t\t\t\tconst reverbShelfInput2 = (reverbTemp0 - reverbTemp2) * reverb;\r\n\t\t\t\t\tconst reverbShelfInput3 = (reverbTemp1 - reverbTemp3) * reverb;\r\n\t\t\t\t\treverbShelfSample0 = reverbShelfB0 * reverbShelfInput0 + reverbShelfB1 * reverbShelfPrevInput0 - reverbShelfA1 * reverbShelfSample0;\r\n\t\t\t\t\treverbShelfSample1 = reverbShelfB0 * reverbShelfInput1 + reverbShelfB1 * reverbShelfPrevInput1 - reverbShelfA1 * reverbShelfSample1;\r\n\t\t\t\t\treverbShelfSample2 = reverbShelfB0 * reverbShelfInput2 + reverbShelfB1 * reverbShelfPrevInput2 - reverbShelfA1 * reverbShelfSample2;\r\n\t\t\t\t\treverbShelfSample3 = reverbShelfB0 * reverbShelfInput3 + reverbShelfB1 * reverbShelfPrevInput3 - reverbShelfA1 * reverbShelfSample3;\r\n\t\t\t\t\treverbShelfPrevInput0 = reverbShelfInput0;\r\n\t\t\t\t\treverbShelfPrevInput1 = reverbShelfInput1;\r\n\t\t\t\t\treverbShelfPrevInput2 = reverbShelfInput2;\r\n\t\t\t\t\treverbShelfPrevInput3 = reverbShelfInput3;\r\n\t\t\t\t\treverbDelayLine[reverbDelayPos1] = reverbShelfSample0 * delayInputMult;\r\n\t\t\t\t\treverbDelayLine[reverbDelayPos2] = reverbShelfSample1 * delayInputMult;\r\n\t\t\t\t\treverbDelayLine[reverbDelayPos3] = reverbShelfSample2 * delayInputMult;\r\n\t\t\t\t\treverbDelayLine[reverbDelayPos ] = reverbShelfSample3 * delayInputMult;\r\n\t\t\t\t\treverbDelayPos = (reverbDelayPos + 1) & reverbMask;\r\n\t\t\t\t\tsampleL += reverbSample1 + reverbSample2 + reverbSample3;\r\n\t\t\t\t\tsampleR += reverbSample0 + reverbSample2 - reverbSample3;\r\n\t\t\t\t\treverb += reverbDelta;`\r\n            }\r\n\r\n            effectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\t\toutputDataL[sampleIndex] += sampleL * mixVolume;\r\n\t\t\t\t\toutputDataR[sampleIndex] += sampleR * mixVolume;\r\n\t\t\t\t\tmixVolume += mixVolumeDelta;`\r\n\r\n            if (usesDelays) {\r\n                effectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\t\tdelayInputMult += delayInputMultDelta;`\r\n            }\r\n\r\n            effectsSource += `\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tinstrumentState.mixVolume = mixVolume;\r\n\t\t\t\tinstrumentState.eqFilterVolume = eqFilterVolume;\r\n\t\t\t\t\r\n\t\t\t\t// Avoid persistent denormal or NaN values in the delay buffers and filter history.\r\n\t\t\t\tconst epsilon = (1.0e-24);`\r\n\r\n            if (usesDelays) {\r\n                effectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tinstrumentState.delayInputMult = delayInputMult;`\r\n            }\r\n\r\n            if (usesDistortion) {\r\n                effectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tinstrumentState.distortion = distortion;\r\n\t\t\t\tinstrumentState.distortionDrive = distortionDrive;\r\n\t\t\t\t\r\n\t\t\t\tif (!Number.isFinite(distortionFractionalInput1) || Math.abs(distortionFractionalInput1) < epsilon) distortionFractionalInput1 = 0.0;\r\n\t\t\t\tif (!Number.isFinite(distortionFractionalInput2) || Math.abs(distortionFractionalInput2) < epsilon) distortionFractionalInput2 = 0.0;\r\n\t\t\t\tif (!Number.isFinite(distortionFractionalInput3) || Math.abs(distortionFractionalInput3) < epsilon) distortionFractionalInput3 = 0.0;\r\n\t\t\t\tif (!Number.isFinite(distortionPrevInput) || Math.abs(distortionPrevInput) < epsilon) distortionPrevInput = 0.0;\r\n\t\t\t\tif (!Number.isFinite(distortionNextOutput) || Math.abs(distortionNextOutput) < epsilon) distortionNextOutput = 0.0;\r\n\t\t\t\t\r\n\t\t\t\tinstrumentState.distortionFractionalInput1 = distortionFractionalInput1;\r\n\t\t\t\tinstrumentState.distortionFractionalInput2 = distortionFractionalInput2;\r\n\t\t\t\tinstrumentState.distortionFractionalInput3 = distortionFractionalInput3;\r\n\t\t\t\tinstrumentState.distortionPrevInput = distortionPrevInput;\r\n\t\t\t\tinstrumentState.distortionNextOutput = distortionNextOutput;`\r\n            }\r\n\r\n            if (usesBitcrusher) {\r\n                effectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\tif (Math.abs(bitcrusherPrevInput) < epsilon) bitcrusherPrevInput = 0.0;\r\n\t\t\t\tif (Math.abs(bitcrusherCurrentOutput) < epsilon) bitcrusherCurrentOutput = 0.0;\r\n\t\t\t\tinstrumentState.bitcrusherPrevInput = bitcrusherPrevInput;\r\n\t\t\t\tinstrumentState.bitcrusherCurrentOutput = bitcrusherCurrentOutput;\r\n\t\t\t\tinstrumentState.bitcrusherPhase = bitcrusherPhase;\r\n\t\t\t\tinstrumentState.bitcrusherPhaseDelta = bitcrusherPhaseDelta;\r\n\t\t\t\tinstrumentState.bitcrusherScale = bitcrusherScale;\r\n\t\t\t\tinstrumentState.bitcrusherFoldLevel = bitcrusherFoldLevel;`\r\n\r\n            }\r\n\r\n            if (usesEqFilter) {\r\n                effectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\tsynth.sanitizeFilters(filters);\r\n\t\t\t\t// The filter input here is downstream from another filter so we\r\n\t\t\t\t// better make sure it's safe too.\r\n\t\t\t\tif (!(initialFilterInput1 < 100) || !(initialFilterInput2 < 100)) {\r\n\t\t\t\t\tinitialFilterInput1 = 0.0;\r\n\t\t\t\t\tinitialFilterInput2 = 0.0;\r\n\t\t\t\t}\r\n\t\t\t\tif (Math.abs(initialFilterInput1) < epsilon) initialFilterInput1 = 0.0;\r\n\t\t\t\tif (Math.abs(initialFilterInput2) < epsilon) initialFilterInput2 = 0.0;\r\n\t\t\t\tinstrumentState.initialEqFilterInput1 = initialFilterInput1;\r\n\t\t\t\tinstrumentState.initialEqFilterInput2 = initialFilterInput2;`\r\n            }\r\n\r\n            if (usesPanning) {\r\n                effectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tbeepbox.Synth.sanitizeDelayLine(panningDelayLine, panningDelayPos, panningMask);\r\n\t\t\t\tinstrumentState.panningDelayPos = panningDelayPos;\r\n\t\t\t\tinstrumentState.panningVolumeL = panningVolumeL;\r\n\t\t\t\tinstrumentState.panningVolumeR = panningVolumeR;\r\n\t\t\t\tinstrumentState.panningOffsetL = panningOffsetL;\r\n\t\t\t\tinstrumentState.panningOffsetR = panningOffsetR;`\r\n            }\r\n\r\n            if (usesChorus) {\r\n                effectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tbeepbox.Synth.sanitizeDelayLine(chorusDelayLineL, chorusDelayPos, chorusMask);\r\n\t\t\t\tbeepbox.Synth.sanitizeDelayLine(chorusDelayLineR, chorusDelayPos, chorusMask);\r\n\t\t\t\tinstrumentState.chorusPhase = chorusPhase;\r\n\t\t\t\tinstrumentState.chorusDelayPos = chorusDelayPos;\r\n\t\t\t\tinstrumentState.chorusVoiceMult = chorusVoiceMult;\r\n\t\t\t\tinstrumentState.chorusCombinedMult = chorusCombinedMult;`\r\n            }\r\n\r\n            if (usesEcho) {\r\n                effectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tbeepbox.Synth.sanitizeDelayLine(echoDelayLineL, echoDelayPos, echoMask);\r\n\t\t\t\tbeepbox.Synth.sanitizeDelayLine(echoDelayLineR, echoDelayPos, echoMask);\r\n\t\t\t\tinstrumentState.echoDelayPos = echoDelayPos;\r\n\t\t\t\tinstrumentState.echoMult = echoMult;\r\n\t\t\t\tinstrumentState.echoDelayOffsetRatio = echoDelayOffsetRatio;\r\n\t\t\t\t\r\n\t\t\t\tif (!Number.isFinite(echoShelfSampleL) || Math.abs(echoShelfSampleL) < epsilon) echoShelfSampleL = 0.0;\r\n\t\t\t\tif (!Number.isFinite(echoShelfSampleR) || Math.abs(echoShelfSampleR) < epsilon) echoShelfSampleR = 0.0;\r\n\t\t\t\tif (!Number.isFinite(echoShelfPrevInputL) || Math.abs(echoShelfPrevInputL) < epsilon) echoShelfPrevInputL = 0.0;\r\n\t\t\t\tif (!Number.isFinite(echoShelfPrevInputR) || Math.abs(echoShelfPrevInputR) < epsilon) echoShelfPrevInputR = 0.0;\r\n\t\t\t\tinstrumentState.echoShelfSampleL = echoShelfSampleL;\r\n\t\t\t\tinstrumentState.echoShelfSampleR = echoShelfSampleR;\r\n\t\t\t\tinstrumentState.echoShelfPrevInputL = echoShelfPrevInputL;\r\n\t\t\t\tinstrumentState.echoShelfPrevInputR = echoShelfPrevInputR;`\r\n            }\r\n\r\n            if (usesReverb) {\r\n                effectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tbeepbox.Synth.sanitizeDelayLine(reverbDelayLine, reverbDelayPos        , reverbMask);\r\n\t\t\t\tbeepbox.Synth.sanitizeDelayLine(reverbDelayLine, reverbDelayPos +  3041, reverbMask);\r\n\t\t\t\tbeepbox.Synth.sanitizeDelayLine(reverbDelayLine, reverbDelayPos +  6426, reverbMask);\r\n\t\t\t\tbeepbox.Synth.sanitizeDelayLine(reverbDelayLine, reverbDelayPos + 10907, reverbMask);\r\n\t\t\t\tinstrumentState.reverbDelayPos = reverbDelayPos;\r\n\t\t\t\tinstrumentState.reverbMult = reverb;\r\n\t\t\t\t\r\n\t\t\t\tif (!Number.isFinite(reverbShelfSample0) || Math.abs(reverbShelfSample0) < epsilon) reverbShelfSample0 = 0.0;\r\n\t\t\t\tif (!Number.isFinite(reverbShelfSample1) || Math.abs(reverbShelfSample1) < epsilon) reverbShelfSample1 = 0.0;\r\n\t\t\t\tif (!Number.isFinite(reverbShelfSample2) || Math.abs(reverbShelfSample2) < epsilon) reverbShelfSample2 = 0.0;\r\n\t\t\t\tif (!Number.isFinite(reverbShelfSample3) || Math.abs(reverbShelfSample3) < epsilon) reverbShelfSample3 = 0.0;\r\n\t\t\t\tif (!Number.isFinite(reverbShelfPrevInput0) || Math.abs(reverbShelfPrevInput0) < epsilon) reverbShelfPrevInput0 = 0.0;\r\n\t\t\t\tif (!Number.isFinite(reverbShelfPrevInput1) || Math.abs(reverbShelfPrevInput1) < epsilon) reverbShelfPrevInput1 = 0.0;\r\n\t\t\t\tif (!Number.isFinite(reverbShelfPrevInput2) || Math.abs(reverbShelfPrevInput2) < epsilon) reverbShelfPrevInput2 = 0.0;\r\n\t\t\t\tif (!Number.isFinite(reverbShelfPrevInput3) || Math.abs(reverbShelfPrevInput3) < epsilon) reverbShelfPrevInput3 = 0.0;\r\n\t\t\t\tinstrumentState.reverbShelfSample0 = reverbShelfSample0;\r\n\t\t\t\tinstrumentState.reverbShelfSample1 = reverbShelfSample1;\r\n\t\t\t\tinstrumentState.reverbShelfSample2 = reverbShelfSample2;\r\n\t\t\t\tinstrumentState.reverbShelfSample3 = reverbShelfSample3;\r\n\t\t\t\tinstrumentState.reverbShelfPrevInput0 = reverbShelfPrevInput0;\r\n\t\t\t\tinstrumentState.reverbShelfPrevInput1 = reverbShelfPrevInput1;\r\n\t\t\t\tinstrumentState.reverbShelfPrevInput2 = reverbShelfPrevInput2;\r\n\t\t\t\tinstrumentState.reverbShelfPrevInput3 = reverbShelfPrevInput3;`\r\n            }\r\n\r\n            //console.log(effectsSource);\r\n            effectsFunction = new Function(\"synth\", \"outputDataL\", \"outputDataR\", \"bufferIndex\", \"runLength\", \"instrumentState\", effectsSource);\r\n            Synth.effectsFunctionCache[signature] = effectsFunction;\r\n        }\r\n\r\n        effectsFunction(synth, outputDataL, outputDataR, bufferIndex, runLength, instrumentState);\r\n    }\r\n\r\n    private static pulseWidthSynth(synth: Synth, bufferIndex: number, roundedSamplesPerTick: number, tone: Tone, instrument: Instrument): void {\r\n        const data: Float32Array = synth.tempMonoInstrumentSampleBuffer!;\r\n\r\n        let phaseDelta: number = tone.phaseDeltas[0];\r\n        const phaseDeltaScale: number = +tone.phaseDeltaScales[0];\r\n        let expression: number = +tone.expression;\r\n        const expressionDelta: number = +tone.expressionDelta;\r\n        let phase: number = (tone.phases[0] % 1);\r\n\r\n        let pulseWidth: number = tone.pulseWidth;\r\n        const pulseWidthDelta: number = tone.pulseWidthDelta;\r\n\r\n        const filters: DynamicBiquadFilter[] = tone.noteFilters;\r\n        const filterCount: number = tone.noteFilterCount | 0;\r\n        let initialFilterInput1: number = +tone.initialNoteFilterInput1;\r\n        let initialFilterInput2: number = +tone.initialNoteFilterInput2;\r\n        const applyFilters: Function = Synth.applyFilters;\r\n\r\n        const stopIndex: number = bufferIndex + roundedSamplesPerTick;\r\n        for (let sampleIndex: number = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\r\n\r\n            const sawPhaseA: number = phase % 1;\r\n            const sawPhaseB: number = (phase + pulseWidth) % 1;\r\n\r\n            let pulseWave: number = sawPhaseB - sawPhaseA;\r\n\r\n            // This is a PolyBLEP, which smooths out discontinuities at any frequency to reduce aliasing. \r\n            if (!instrument.aliases) {\r\n                if (sawPhaseA < phaseDelta) {\r\n                    var t = sawPhaseA / phaseDelta;\r\n                    pulseWave += (t + t - t * t - 1) * 0.5;\r\n                } else if (sawPhaseA > 1.0 - phaseDelta) {\r\n                    var t = (sawPhaseA - 1.0) / phaseDelta;\r\n                    pulseWave += (t + t + t * t + 1) * 0.5;\r\n                }\r\n                if (sawPhaseB < phaseDelta) {\r\n                    var t = sawPhaseB / phaseDelta;\r\n                    pulseWave -= (t + t - t * t - 1) * 0.5;\r\n                } else if (sawPhaseB > 1.0 - phaseDelta) {\r\n                    var t = (sawPhaseB - 1.0) / phaseDelta;\r\n                    pulseWave -= (t + t + t * t + 1) * 0.5;\r\n                }\r\n            }\r\n\r\n            const inputSample: number = pulseWave;\r\n            const sample: number = applyFilters(inputSample, initialFilterInput1, initialFilterInput2, filterCount, filters);\r\n            initialFilterInput2 = initialFilterInput1;\r\n            initialFilterInput1 = inputSample;\r\n\r\n            phase += phaseDelta;\r\n            phaseDelta *= phaseDeltaScale;\r\n            pulseWidth += pulseWidthDelta;\r\n\r\n            const output: number = sample * expression;\r\n            expression += expressionDelta;\r\n\r\n            data[sampleIndex] += output;\r\n        }\r\n\r\n        tone.phases[0] = phase;\r\n        tone.phaseDeltas[0] = phaseDelta;\r\n        tone.expression = expression;\r\n        tone.pulseWidth = pulseWidth;\r\n\r\n        synth.sanitizeFilters(filters);\r\n        tone.initialNoteFilterInput1 = initialFilterInput1;\r\n        tone.initialNoteFilterInput2 = initialFilterInput2;\r\n    }\r\n\r\n    private static fmSourceTemplate: string[] = (`\r\n\t\tconst data = synth.tempMonoInstrumentSampleBuffer;\r\n\t\tconst sineWave = beepbox.Config.sineWave;\r\n\t\t\t\r\n\t\t// I'm adding 1000 to the phase to ensure that it's never negative even when modulated by other waves because negative numbers don't work with the modulus operator very well.\r\n\t\tlet operator#Phase       = +((tone.phases[#] % 1) + 1000) * ` + Config.sineWaveLength + `;\r\n\t\tlet operator#PhaseDelta  = +tone.phaseDeltas[#] * ` + Config.sineWaveLength + `;\r\n\t\tlet operator#PhaseDeltaScale = +tone.phaseDeltaScales[#];\r\n\t\tlet operator#OutputMult  = +tone.operatorExpressions[#];\r\n\t\tconst operator#OutputDelta = +tone.operatorExpressionDeltas[#];\r\n\t\tlet operator#Output      = +tone.feedbackOutputs[#];\r\n        const operator#Wave      = tone.operatorWaves[#].samples;\r\n\t\tlet feedbackMult         = +tone.feedbackMult;\r\n\t\tconst feedbackDelta        = +tone.feedbackDelta;\r\n        let expression = +tone.expression;\r\n\t\tconst expressionDelta = +tone.expressionDelta;\r\n\t\t\r\n\t\tconst filters = tone.noteFilters;\r\n\t\tconst filterCount = tone.noteFilterCount|0;\r\n\t\tlet initialFilterInput1 = +tone.initialNoteFilterInput1;\r\n\t\tlet initialFilterInput2 = +tone.initialNoteFilterInput2;\r\n\t\tconst applyFilters = beepbox.Synth.applyFilters;\r\n\t\t\r\n\t\tconst stopIndex = bufferIndex + roundedSamplesPerTick;\r\n\t\tfor (let sampleIndex = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\r\n\t\t\t\t// INSERT OPERATOR COMPUTATION HERE\r\n\t\t\t\tconst fmOutput = (/*operator#Scaled*/); // CARRIER OUTPUTS\r\n\t\t\t\t\r\n\t\t\tconst inputSample = fmOutput;\r\n\t\t\tconst sample = applyFilters(inputSample, initialFilterInput1, initialFilterInput2, filterCount, filters);\r\n\t\t\tinitialFilterInput2 = initialFilterInput1;\r\n\t\t\tinitialFilterInput1 = inputSample;\r\n\t\t\t\t\r\n\t\t\t\tfeedbackMult += feedbackDelta;\r\n\t\t\t\toperator#OutputMult += operator#OutputDelta;\r\n\t\t\t\toperator#Phase += operator#PhaseDelta;\r\n\t\t\toperator#PhaseDelta *= operator#PhaseDeltaScale;\r\n\t\t\t\r\n\t\t\tconst output = sample * expression;\r\n\t\t\texpression += expressionDelta;\r\n\r\n\t\t\tdata[sampleIndex] += output;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\ttone.phases[#] = operator#Phase / ` + Config.sineWaveLength + `;\r\n\t\t\ttone.phaseDeltas[#] = operator#PhaseDelta / ` + Config.sineWaveLength + `;\r\n\t\t\ttone.operatorExpressions[#] = operator#OutputMult;\r\n\t\t    tone.feedbackOutputs[#] = operator#Output;\r\n\t\t    tone.feedbackMult = feedbackMult;\r\n\t\t    tone.expression = expression;\r\n\t\t\t\r\n\t\tsynth.sanitizeFilters(filters);\r\n\t\ttone.initialNoteFilterInput1 = initialFilterInput1;\r\n\t\ttone.initialNoteFilterInput2 = initialFilterInput2;\r\n\t\t`).split(\"\\n\");\r\n\r\n    private static operatorSourceTemplate: string[] = (`\r\n\t\t\t\tconst operator#PhaseMix = operator#Phase/* + operator@Scaled*/;\r\n\t\t\t\tconst operator#PhaseInt = operator#PhaseMix|0;\r\n\t\t\t\tconst operator#Index    = operator#PhaseInt & ` + Config.sineWaveMask + `;\r\n                const operator#Sample   = operator#Wave[operator#Index];\r\n                operator#Output         = operator#Sample + (operator#Wave[operator#Index + 1] - operator#Sample) * (operator#PhaseMix - operator#PhaseInt);\r\n\t\t\t\tconst operator#Scaled   = operator#OutputMult * operator#Output;\r\n\t\t`).split(\"\\n\");\r\n\r\n    private static noiseSynth(synth: Synth, bufferIndex: number, runLength: number, tone: Tone, instrumentState: InstrumentState): void {\r\n        const data: Float32Array = synth.tempMonoInstrumentSampleBuffer!;\r\n        const wave: Float32Array = instrumentState.wave!;\r\n        let phaseDelta: number = +tone.phaseDeltas[0];\r\n        const phaseDeltaScale: number = +tone.phaseDeltaScales[0];\r\n        let expression: number = +tone.expression;\r\n        const expressionDelta: number = +tone.expressionDelta;\r\n        let phase: number = (tone.phases[0] % 1) * Config.chipNoiseLength;\r\n        if (tone.phases[0] == 0) {\r\n            // Zero phase means the tone was reset, just give noise a random start phase instead.\r\n            phase = Math.random() * Config.chipNoiseLength;\r\n        }\r\n        const phaseMask: number = Config.chipNoiseLength - 1;\r\n        let noiseSample: number = +tone.noiseSample;\r\n\r\n        const filters: DynamicBiquadFilter[] = tone.noteFilters;\r\n        const filterCount: number = tone.noteFilterCount | 0;\r\n        let initialFilterInput1: number = +tone.initialNoteFilterInput1;\r\n        let initialFilterInput2: number = +tone.initialNoteFilterInput2;\r\n        const applyFilters: Function = Synth.applyFilters;\r\n\r\n        // This is for a \"legacy\" style simplified 1st order lowpass filter with\r\n        // a cutoff frequency that is relative to the tone's fundamental frequency.\r\n        const pitchRelativefilter: number = Math.min(1.0, phaseDelta * instrumentState.noisePitchFilterMult);\r\n\r\n        const stopIndex: number = bufferIndex + runLength;\r\n        for (let sampleIndex: number = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\r\n            const waveSample: number = wave[phase & phaseMask];\r\n\r\n            noiseSample += (waveSample - noiseSample) * pitchRelativefilter;\r\n\r\n            const inputSample: number = noiseSample;\r\n            const sample: number = applyFilters(inputSample, initialFilterInput1, initialFilterInput2, filterCount, filters);\r\n            initialFilterInput2 = initialFilterInput1;\r\n            initialFilterInput1 = inputSample;\r\n\r\n            phase += phaseDelta;\r\n            phaseDelta *= phaseDeltaScale;\r\n\r\n            const output: number = sample * expression;\r\n            expression += expressionDelta;\r\n\r\n            data[sampleIndex] += output;\r\n        }\r\n\r\n        tone.phases[0] = phase / Config.chipNoiseLength;\r\n        tone.phaseDeltas[0] = phaseDelta;\r\n        tone.expression = expression;\r\n        tone.noiseSample = noiseSample;\r\n\r\n        synth.sanitizeFilters(filters);\r\n        tone.initialNoteFilterInput1 = initialFilterInput1;\r\n        tone.initialNoteFilterInput2 = initialFilterInput2;\r\n    }\r\n\r\n    private static spectrumSynth(synth: Synth, bufferIndex: number, runLength: number, tone: Tone, instrumentState: InstrumentState): void {\r\n        const data: Float32Array = synth.tempMonoInstrumentSampleBuffer!;\r\n        const wave: Float32Array = instrumentState.wave!;\r\n        const samplesInPeriod: number = (1 << 7);\r\n        let phaseDelta: number = tone.phaseDeltas[0] * samplesInPeriod;\r\n        const phaseDeltaScale: number = +tone.phaseDeltaScales[0];\r\n        let expression: number = +tone.expression;\r\n        const expressionDelta: number = +tone.expressionDelta;\r\n        let noiseSample: number = +tone.noiseSample;\r\n\r\n        const filters: DynamicBiquadFilter[] = tone.noteFilters;\r\n        const filterCount: number = tone.noteFilterCount | 0;\r\n        let initialFilterInput1: number = +tone.initialNoteFilterInput1;\r\n        let initialFilterInput2: number = +tone.initialNoteFilterInput2;\r\n        const applyFilters: Function = Synth.applyFilters;\r\n\r\n        let phase: number = (tone.phases[0] % 1) * Config.spectrumNoiseLength;\r\n        // Zero phase means the tone was reset, just give noise a random start phase instead.\r\n        if (tone.phases[0] == 0) phase = Synth.findRandomZeroCrossing(wave, Config.spectrumNoiseLength) + phaseDelta;\r\n        const phaseMask: number = Config.spectrumNoiseLength - 1;\r\n\r\n        // This is for a \"legacy\" style simplified 1st order lowpass filter with\r\n        // a cutoff frequency that is relative to the tone's fundamental frequency.\r\n        const pitchRelativefilter: number = Math.min(1.0, phaseDelta);\r\n\r\n        const stopIndex: number = bufferIndex + runLength;\r\n        for (let sampleIndex: number = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\r\n            const phaseInt: number = phase | 0;\r\n            const index: number = phaseInt & phaseMask;\r\n            let waveSample: number = wave[index];\r\n            const phaseRatio: number = phase - phaseInt;\r\n            waveSample += (wave[index + 1] - waveSample) * phaseRatio;\r\n\r\n            noiseSample += (waveSample - noiseSample) * pitchRelativefilter;\r\n\r\n\r\n            const inputSample: number = noiseSample;\r\n            const sample: number = applyFilters(inputSample, initialFilterInput1, initialFilterInput2, filterCount, filters);\r\n            initialFilterInput2 = initialFilterInput1;\r\n            initialFilterInput1 = inputSample;\r\n\r\n            phase += phaseDelta;\r\n            phaseDelta *= phaseDeltaScale;\r\n\r\n            const output: number = sample * expression;\r\n            expression += expressionDelta;\r\n\r\n            data[sampleIndex] += output;\r\n        }\r\n\r\n        tone.phases[0] = phase / Config.spectrumNoiseLength;\r\n        tone.phaseDeltas[0] = phaseDelta / samplesInPeriod;\r\n        tone.expression = expression;\r\n        tone.noiseSample = noiseSample;\r\n\r\n        synth.sanitizeFilters(filters);\r\n        tone.initialNoteFilterInput1 = initialFilterInput1;\r\n        tone.initialNoteFilterInput2 = initialFilterInput2;\r\n    }\r\n\r\n    private static drumsetSynth(synth: Synth, bufferIndex: number, runLength: number, tone: Tone, instrumentState: InstrumentState): void {\r\n        const data: Float32Array = synth.tempMonoInstrumentSampleBuffer!;\r\n        let wave: Float32Array = instrumentState.getDrumsetWave(tone.drumsetPitch!);\r\n        const referenceDelta: number = InstrumentState.drumsetIndexReferenceDelta(tone.drumsetPitch!);\r\n        let phaseDelta: number = tone.phaseDeltas[0] / referenceDelta;\r\n        const phaseDeltaScale: number = +tone.phaseDeltaScales[0];\r\n        let expression: number = +tone.expression;\r\n        const expressionDelta: number = +tone.expressionDelta;\r\n\r\n        const filters: DynamicBiquadFilter[] = tone.noteFilters;\r\n        const filterCount: number = tone.noteFilterCount | 0;\r\n        let initialFilterInput1: number = +tone.initialNoteFilterInput1;\r\n        let initialFilterInput2: number = +tone.initialNoteFilterInput2;\r\n        const applyFilters: Function = Synth.applyFilters;\r\n\r\n        let phase: number = (tone.phases[0] % 1) * Config.spectrumNoiseLength;\r\n        // Zero phase means the tone was reset, just give noise a random start phase instead.\r\n        if (tone.phases[0] == 0) phase = Synth.findRandomZeroCrossing(wave, Config.spectrumNoiseLength) + phaseDelta;\r\n        const phaseMask: number = Config.spectrumNoiseLength - 1;\r\n\r\n        const stopIndex: number = bufferIndex + runLength;\r\n        for (let sampleIndex: number = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\r\n            const phaseInt: number = phase | 0;\r\n            const index: number = phaseInt & phaseMask;\r\n            let noiseSample: number = wave[index];\r\n            const phaseRatio: number = phase - phaseInt;\r\n            noiseSample += (wave[index + 1] - noiseSample) * phaseRatio;\r\n\r\n            const inputSample: number = noiseSample;\r\n            const sample: number = applyFilters(inputSample, initialFilterInput1, initialFilterInput2, filterCount, filters);\r\n            initialFilterInput2 = initialFilterInput1;\r\n            initialFilterInput1 = inputSample;\r\n\r\n            phase += phaseDelta;\r\n            phaseDelta *= phaseDeltaScale;\r\n\r\n            const output: number = sample * expression;\r\n            expression += expressionDelta;\r\n\r\n            data[sampleIndex] += output;\r\n        }\r\n\r\n        tone.phases[0] = phase / Config.spectrumNoiseLength;\r\n        tone.phaseDeltas[0] = phaseDelta * referenceDelta;\r\n        tone.expression = expression;\r\n\r\n        synth.sanitizeFilters(filters);\r\n        tone.initialNoteFilterInput1 = initialFilterInput1;\r\n        tone.initialNoteFilterInput2 = initialFilterInput2;\r\n    }\r\n\r\n    private static modSynth(synth: Synth, stereoBufferIndex: number, roundedSamplesPerTick: number, tone: Tone, instrument: Instrument): void {\r\n        // Note: present modulator value is tone.expressionStarts[0].\r\n\r\n        if (!synth.song) return;\r\n\r\n        let mod: number = Config.modCount - 1 - tone.pitches[0];\r\n\r\n        // Flagged as invalid because unused by current settings, skip\r\n        if (instrument.invalidModulators[mod]) return;\r\n\r\n        let setting: number = instrument.modulators[mod];\r\n\r\n        // Generate list of used instruments\r\n        let usedInstruments: number[] = [];\r\n        if (Config.modulators[instrument.modulators[mod]].forSong) {\r\n            // Instrument doesn't matter for song, just push a random index to run the modsynth once\r\n            usedInstruments.push(0);\r\n        } else {\r\n            // All\r\n            if (instrument.modInstruments[mod] == synth.song.channels[instrument.modChannels[mod]].instruments.length) {\r\n                for (let i: number = 0; i < synth.song.channels[instrument.modChannels[mod]].instruments.length; i++) {\r\n                    usedInstruments.push(i);\r\n                }\r\n            }\r\n            // Active\r\n            else if (instrument.modInstruments[mod] > synth.song.channels[instrument.modChannels[mod]].instruments.length) {\r\n                if (synth.song.getPattern(instrument.modChannels[mod], synth.bar) != null)\r\n                    usedInstruments = synth.song.getPattern(instrument.modChannels[mod], synth.bar)!.instruments;\r\n            } else {\r\n                usedInstruments.push(instrument.modInstruments[mod]);\r\n            }\r\n        }\r\n\r\n        for (let instrumentIndex: number = 0; instrumentIndex < usedInstruments.length; instrumentIndex++) {\r\n\r\n            synth.setModValue(tone.expression, tone.expression + tone.expressionDelta, mod, instrument.modChannels[mod], usedInstruments[instrumentIndex], setting);\r\n\r\n            // Reset arps, but only at the start of the note\r\n            if (setting == Config.modulators.dictionary[\"reset arp\"].index && synth.tick == 0 && tone.noteStartPart == synth.beat * Config.partsPerBeat + synth.part) {\r\n                synth.song.channels[instrument.modChannels[mod]].instruments[usedInstruments[instrumentIndex]].arpTime = 0;\r\n            }\r\n            // Denote next bar skip\r\n            else if (setting == Config.modulators.dictionary[\"next bar\"].index) {\r\n                synth.wantToSkip = true;\r\n            }\r\n            // Extra info for eq filter target needs to be set as well\r\n            else if (setting == Config.modulators.dictionary[\"eq filter\"].index) {\r\n                const tgtInstrument = synth.song.channels[instrument.modChannels[mod]].instruments[usedInstruments[instrumentIndex]];\r\n\r\n                if (!tgtInstrument.eqFilterType) {\r\n\r\n                    let dotTarget = instrument.modFilterTypes[mod] | 0;\r\n\r\n                    if (dotTarget == 0) { // Morph. Figure out the target filter's X/Y coords for this point. If no point exists with this index, or point types don't match, do lerp-out for this point and lerp-in of a new point\r\n\r\n                        let pinIdx: number = 0;\r\n                        const currentPart: number = synth.getTicksIntoBar() / Config.ticksPerPart;\r\n                        while (tone.note!.start + tone.note!.pins[pinIdx].time <= currentPart) pinIdx++;\r\n                        // 0 to 1 based on distance to next morph\r\n                        //let lerpStartRatio: number = (currentPart - tone.note!.pins[pinIdx - 1].time) / (tone.note!.pins[pinIdx].time - tone.note!.pins[pinIdx - 1].time);\r\n                        let lerpEndRatio: number = ((currentPart - tone.note!.start + (roundedSamplesPerTick / (synth.getSamplesPerTick() * Config.ticksPerPart)) * Config.ticksPerPart) - tone.note!.pins[pinIdx - 1].time) / (tone.note!.pins[pinIdx].time - tone.note!.pins[pinIdx - 1].time);\r\n\r\n                        // Compute the new settings to go to.\r\n                        if (tgtInstrument.eqSubFilters[tone.note!.pins[pinIdx - 1].size] != null || tgtInstrument.eqSubFilters[tone.note!.pins[pinIdx].size] != null) {\r\n                            tgtInstrument.tmpEqFilterEnd = FilterSettings.lerpFilters(tgtInstrument.eqSubFilters[tone.note!.pins[pinIdx - 1].size]!, tgtInstrument.eqSubFilters[tone.note!.pins[pinIdx].size]!, lerpEndRatio);\r\n                        } else {\r\n                            // No mutation will occur to the filter object so we can safely return it without copying\r\n                            tgtInstrument.tmpEqFilterEnd = tgtInstrument.eqFilter;\r\n                        }\r\n\r\n                    } // Target (1 is dot 1 X, 2 is dot 1 Y, etc.)\r\n                    else {\r\n                        // Since we are directly manipulating the filter, make sure it is a new one and not an actual one of the instrument's filters\r\n                        for (let i: number = 0; i < Config.filterMorphCount; i++) {\r\n                            if (tgtInstrument.tmpEqFilterEnd == tgtInstrument.eqSubFilters[i] && tgtInstrument.tmpEqFilterEnd != null) {\r\n                                tgtInstrument.tmpEqFilterEnd = new FilterSettings();\r\n                                tgtInstrument.tmpEqFilterEnd.fromJsonObject(tgtInstrument.eqSubFilters[i]!.toJsonObject());\r\n                            }\r\n                        }\r\n                        if (tgtInstrument.tmpEqFilterEnd == null) {\r\n                            tgtInstrument.tmpEqFilterEnd = new FilterSettings();\r\n                            tgtInstrument.tmpEqFilterEnd.fromJsonObject(tgtInstrument.eqFilter.toJsonObject());\r\n                        }\r\n\r\n                        if (tgtInstrument.tmpEqFilterEnd.controlPointCount > Math.floor((dotTarget - 1) / 2)) {\r\n                            if (dotTarget % 2) { // X\r\n                                tgtInstrument.tmpEqFilterEnd.controlPoints[Math.floor((dotTarget - 1) / 2)].freq = tone.expression + tone.expressionDelta;\r\n                            } else { // Y\r\n                                tgtInstrument.tmpEqFilterEnd.controlPoints[Math.floor((dotTarget - 1) / 2)].gain = tone.expression + tone.expressionDelta;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            // Extra info for note filter target needs to be set as well\r\n            else if (setting == Config.modulators.dictionary[\"note filter\"].index) {\r\n                const tgtInstrument = synth.song.channels[instrument.modChannels[mod]].instruments[usedInstruments[instrumentIndex]];\r\n\r\n                if (!tgtInstrument.noteFilterType) {\r\n                    let dotTarget = instrument.modFilterTypes[mod] | 0;\r\n\r\n                    if (dotTarget == 0) { // Morph. Figure out the target filter's X/Y coords for this point. If no point exists with this index, or point types don't match, do lerp-out for this point and lerp-in of a new point\r\n\r\n                        let pinIdx: number = 0;\r\n                        const currentPart: number = synth.getTicksIntoBar() / Config.ticksPerPart;\r\n                        while (tone.note!.start + tone.note!.pins[pinIdx].time <= currentPart) pinIdx++;\r\n                        // 0 to 1 based on distance to next morph\r\n                        //let lerpStartRatio: number = (currentPart - tone.note!.pins[pinIdx - 1].time) / (tone.note!.pins[pinIdx].time - tone.note!.pins[pinIdx - 1].time);\r\n                        let lerpEndRatio: number = ((currentPart - tone.note!.start + (roundedSamplesPerTick / (synth.getSamplesPerTick() * Config.ticksPerPart)) * Config.ticksPerPart) - tone.note!.pins[pinIdx - 1].time) / (tone.note!.pins[pinIdx].time - tone.note!.pins[pinIdx - 1].time);\r\n\r\n                        // Compute the new settings to go to.\r\n                        if (tgtInstrument.noteSubFilters[tone.note!.pins[pinIdx - 1].size] != null || tgtInstrument.noteSubFilters[tone.note!.pins[pinIdx].size] != null) {\r\n                            tgtInstrument.tmpNoteFilterEnd = FilterSettings.lerpFilters(tgtInstrument.noteSubFilters[tone.note!.pins[pinIdx - 1].size]!, tgtInstrument.noteSubFilters[tone.note!.pins[pinIdx].size]!, lerpEndRatio);\r\n                        } else {\r\n                            // No mutation will occur to the filter object so we can safely return it without copying\r\n                            tgtInstrument.tmpNoteFilterEnd = tgtInstrument.noteFilter;\r\n                        }\r\n\r\n                    } // Target (1 is dot 1 X, 2 is dot 1 Y, etc.)\r\n                    else {\r\n                        // Since we are directly manipulating the filter, make sure it is a new one and not an actual one of the instrument's filters\r\n\r\n                        for (let i: number = 0; i < Config.filterMorphCount; i++) {\r\n                            if (tgtInstrument.tmpNoteFilterEnd == tgtInstrument.noteSubFilters[i] && tgtInstrument.tmpNoteFilterEnd != null) {\r\n                                tgtInstrument.tmpNoteFilterEnd = new FilterSettings();\r\n                                tgtInstrument.tmpNoteFilterEnd.fromJsonObject(tgtInstrument.noteSubFilters[i]!.toJsonObject());\r\n                            }\r\n                        }\r\n                        if (tgtInstrument.tmpNoteFilterEnd == null) {\r\n                            tgtInstrument.tmpNoteFilterEnd = new FilterSettings();\r\n                            tgtInstrument.tmpNoteFilterEnd.fromJsonObject(tgtInstrument.noteFilter.toJsonObject());\r\n                        }\r\n\r\n                        if (tgtInstrument.tmpNoteFilterEnd.controlPointCount > Math.floor((dotTarget - 1) / 2)) {\r\n                            if (dotTarget % 2) { // X\r\n                                tgtInstrument.tmpNoteFilterEnd.controlPoints[Math.floor((dotTarget - 1) / 2)].freq = tone.expression + tone.expressionDelta;\r\n                            } else { // Y\r\n                                tgtInstrument.tmpNoteFilterEnd.controlPoints[Math.floor((dotTarget - 1) / 2)].gain = tone.expression + tone.expressionDelta;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    private static findRandomZeroCrossing(wave: Float32Array, waveLength: number): number {\r\n        let phase: number = Math.random() * waveLength;\r\n        const phaseMask: number = waveLength - 1;\r\n\r\n        // Spectrum and drumset waves sounds best when they start at a zero crossing,\r\n        // otherwise they pop. Try to find a zero crossing.\r\n        let indexPrev: number = phase & phaseMask;\r\n        let wavePrev: number = wave[indexPrev];\r\n        const stride: number = 16;\r\n        for (let attemptsRemaining: number = 128; attemptsRemaining > 0; attemptsRemaining--) {\r\n            const indexNext: number = (indexPrev + stride) & phaseMask;\r\n            const waveNext: number = wave[indexNext];\r\n            if (wavePrev * waveNext <= 0.0) {\r\n                // Found a zero crossing! Now let's narrow it down to two adjacent sample indices.\r\n                for (let i: number = 0; i < stride; i++) {\r\n                    const innerIndexNext: number = (indexPrev + 1) & phaseMask;\r\n                    const innerWaveNext: number = wave[innerIndexNext];\r\n                    if (wavePrev * innerWaveNext <= 0.0) {\r\n                        // Found the zero crossing again! Now let's find the exact intersection.\r\n                        const slope: number = innerWaveNext - wavePrev;\r\n                        phase = indexPrev;\r\n                        if (Math.abs(slope) > 0.00000001) {\r\n                            phase += -wavePrev / slope;\r\n                        }\r\n                        phase = Math.max(0, phase) % waveLength;\r\n                        break;\r\n                    } else {\r\n                        indexPrev = innerIndexNext;\r\n                        wavePrev = innerWaveNext;\r\n                    }\r\n                }\r\n                break;\r\n            } else {\r\n                indexPrev = indexNext;\r\n                wavePrev = waveNext;\r\n            }\r\n        }\r\n\r\n        return phase;\r\n    }\r\n\r\n    public static instrumentVolumeToVolumeMult(instrumentVolume: number): number {\r\n        return (instrumentVolume == -Config.volumeRange / 2.0) ? 0.0 : Math.pow(2, Config.volumeLogScale * instrumentVolume);\r\n    }\r\n    public static volumeMultToInstrumentVolume(volumeMult: number): number {\r\n        return (volumeMult <= 0.0) ? -Config.volumeRange / 2 : Math.min(Config.volumeRange, (Math.log(volumeMult) / Math.LN2) / Config.volumeLogScale);\r\n    }\r\n    public static noteSizeToVolumeMult(size: number): number {\r\n        return Math.pow(Math.max(0.0, size) / Config.noteSizeMax, 1.5);\r\n    }\r\n    public static volumeMultToNoteSize(volumeMult: number): number {\r\n        return Math.pow(Math.max(0.0, volumeMult), 1 / 1.5) * Config.noteSizeMax;\r\n    }\r\n\r\n    public static fadeInSettingToSeconds(setting: number): number {\r\n        return 0.0125 * (0.95 * setting + 0.05 * setting * setting);\r\n    }\r\n    public static secondsToFadeInSetting(seconds: number): number {\r\n        return clamp(0, Config.fadeInRange, Math.round((-0.95 + Math.sqrt(0.9025 + 0.2 * seconds / 0.0125)) / 0.1));\r\n    }\r\n    public static fadeOutSettingToTicks(setting: number): number {\r\n        return Config.fadeOutTicks[setting];\r\n    }\r\n    public static ticksToFadeOutSetting(ticks: number): number {\r\n        let lower: number = Config.fadeOutTicks[0];\r\n        if (ticks <= lower) return 0;\r\n        for (let i: number = 1; i < Config.fadeOutTicks.length; i++) {\r\n            let upper: number = Config.fadeOutTicks[i];\r\n            if (ticks <= upper) return (ticks < (lower + upper) / 2) ? i - 1 : i;\r\n            lower = upper;\r\n        }\r\n        return Config.fadeOutTicks.length - 1;\r\n    }\r\n\r\n    public static detuneToCents(detune: number): number {\r\n        // BeepBox formula, for reference:\r\n        // return detune * (Math.abs(detune) + 1) / 2;\r\n        return detune - Config.detuneCenter;\r\n    }\r\n    public static centsToDetune(cents: number): number {\r\n        // BeepBox formula, for reference:\r\n        // return Math.sign(cents) * (Math.sqrt(1 + 8 * Math.abs(cents)) - 1) / 2.0;\r\n        return cents + Config.detuneCenter;\r\n    }\r\n\r\n    public static getOperatorWave(waveform: number, pulseWidth: number) {\r\n        if (waveform != 3) {\r\n            return Config.operatorWaves[waveform];\r\n        }\r\n        else {\r\n            return Config.pwmOperatorWaves[pulseWidth];\r\n        }\r\n    }\r\n\r\n    private getSamplesPerTick(): number {\r\n        if (this.song == null) return 0;\r\n        let beatsPerMinute: number = this.song.getBeatsPerMinute();\r\n        if (this.isModActive(Config.modulators.dictionary[\"tempo\"].index)) {\r\n            beatsPerMinute = this.getModValue(Config.modulators.dictionary[\"tempo\"].index);\r\n        }\r\n        return this.getSamplesPerTickSpecificBPM(beatsPerMinute);\r\n    }\r\n\r\n    private getSamplesPerTickSpecificBPM(beatsPerMinute: number): number {\r\n        const beatsPerSecond: number = beatsPerMinute / 60.0;\r\n        const partsPerSecond: number = Config.partsPerBeat * beatsPerSecond;\r\n        const tickPerSecond: number = Config.ticksPerPart * partsPerSecond;\r\n        return this.samplesPerSecond / tickPerSecond;\r\n    }\r\n\r\n    public static fittingPowerOfTwo(x: number): number {\r\n        return 1 << (32 - Math.clz32(Math.ceil(x) - 1));\r\n    }\r\n\r\n    private sanitizeFilters(filters: DynamicBiquadFilter[]): void {\r\n        let reset: boolean = false;\r\n        for (const filter of filters) {\r\n            const output1: number = Math.abs(filter.output1);\r\n            const output2: number = Math.abs(filter.output2);\r\n            // If either is a large value, Infinity, or NaN, then just reset all filter history.\r\n            if (!(output1 < 100) || !(output2 < 100)) {\r\n                reset = true;\r\n                break;\r\n            }\r\n            if (output1 < epsilon) filter.output1 = 0.0;\r\n            if (output2 < epsilon) filter.output2 = 0.0;\r\n        }\r\n        if (reset) {\r\n            for (const filter of filters) {\r\n                filter.output1 = 0.0;\r\n                filter.output2 = 0.0;\r\n            }\r\n        }\r\n    }\r\n\r\n    public static sanitizeDelayLine(delayLine: Float32Array, lastIndex: number, mask: number): void {\r\n        while (true) {\r\n            lastIndex--;\r\n            const index: number = lastIndex & mask;\r\n            const sample: number = Math.abs(delayLine[index]);\r\n            if (Number.isFinite(sample) && (sample == 0.0 || sample >= epsilon)) break;\r\n            delayLine[index] = 0.0;\r\n        }\r\n    }\r\n\r\n    public static applyFilters(sample: number, input1: number, input2: number, filterCount: number, filters: DynamicBiquadFilter[]): number {\r\n        for (let i: number = 0; i < filterCount; i++) {\r\n            const filter: DynamicBiquadFilter = filters[i];\r\n            const output1: number = filter.output1;\r\n            const output2: number = filter.output2;\r\n            const a1: number = filter.a1;\r\n            const a2: number = filter.a2;\r\n            const b0: number = filter.b0;\r\n            const b1: number = filter.b1;\r\n            const b2: number = filter.b2;\r\n            sample = b0 * sample + b1 * input1 + b2 * input2 - a1 * output1 - a2 * output2;\r\n            filter.a1 = a1 + filter.a1Delta;\r\n            filter.a2 = a2 + filter.a2Delta;\r\n            if (filter.useMultiplicativeInputCoefficients) {\r\n                filter.b0 = b0 * filter.b0Delta;\r\n                filter.b1 = b1 * filter.b1Delta;\r\n                filter.b2 = b2 * filter.b2Delta;\r\n            } else {\r\n                filter.b0 = b0 + filter.b0Delta;\r\n                filter.b1 = b1 + filter.b1Delta;\r\n                filter.b2 = b2 + filter.b2Delta;\r\n            }\r\n            filter.output2 = output1;\r\n            filter.output1 = sample;\r\n            // Updating the input values is waste if the next filter doesn't exist...\r\n            input2 = output2;\r\n            input1 = output1;\r\n        }\r\n        return sample;\r\n    }\r\n}\r\n\r\n// When compiling synth.ts as a standalone module named \"beepbox\", expose these classes as members to JavaScript:\r\nexport { Dictionary, DictionaryArray, FilterType, EnvelopeType, InstrumentType, Transition, Chord, Envelope, Config };\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nexport class Change {\r\n\tprivate _noop: boolean = true;\r\n\t\t\r\n\tprotected _didSomething(): void {\r\n\t\tthis._noop = false;\r\n\t}\r\n\t\t\r\n\tpublic isNoop(): boolean {\r\n\t\treturn this._noop;\r\n\t}\r\n\t\t\r\n\t\tpublic commit(): void {}\r\n}\r\n\r\nexport class UndoableChange extends Change {\r\n\tprivate _reversed: boolean;\r\n\tprivate _doneForwards: boolean;\r\n\tconstructor(reversed: boolean) {\r\n\t\tsuper();\r\n\t\tthis._reversed = reversed;\r\n\t\tthis._doneForwards = !reversed;\r\n\t}\r\n\t\t\r\n\tpublic undo(): void {\r\n\t\tif (this._reversed) {\r\n\t\t\tthis._doForwards();\r\n\t\t\tthis._doneForwards = true;\r\n\t\t} else {\r\n\t\t\tthis._doBackwards();\r\n\t\t\tthis._doneForwards = false;\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tpublic redo(): void {\r\n\t\tif (this._reversed) {\r\n\t\t\tthis._doBackwards();\r\n\t\t\tthis._doneForwards = false;\r\n\t\t} else {\r\n\t\t\tthis._doForwards();\r\n\t\t\tthis._doneForwards = true;\r\n\t\t}\r\n\t}\r\n\t\t\r\n\t// isDoneForwards() returns whether or not the Change was most recently \r\n\t// performed forwards or backwards. If the change created something, do not \r\n\t// delete it in the change destructor unless the Change was performed \r\n\t// backwards: \r\n\tprotected _isDoneForwards(): boolean {\r\n\t\treturn this._doneForwards;\r\n\t}\r\n\t\t\r\n\tprotected _doForwards(): void {\r\n\t\tthrow new Error(\"Change.doForwards(): Override me.\");\r\n\t}\r\n\t\t\r\n\tprotected _doBackwards(): void {\r\n\t\tthrow new Error(\"Change.doBackwards(): Override me.\");\r\n\t}\r\n}\r\n\r\nexport class ChangeGroup extends Change {\r\n\tconstructor() {\r\n\t\tsuper();\r\n\t}\r\n\t\t\r\n\tpublic append(change: Change): void {\r\n\t\tif (change.isNoop()) return;\r\n\t\tthis._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeSequence extends UndoableChange {\r\n\tprivate _changes: UndoableChange[];\r\n\tconstructor(changes?: UndoableChange[]) {\r\n\t\tsuper(false);\r\n\t\tif (changes == undefined) {\r\n\t\t\tthis._changes = [];\r\n\t\t} else {\r\n\t\t\tthis._changes = changes.concat();\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tpublic append(change: UndoableChange): void {\r\n\t\tif (change.isNoop()) return;\r\n\t\tthis._changes[this._changes.length] = change;\r\n\t\tthis._didSomething();\r\n\t}\r\n\t\t\r\n\tprotected _doForwards(): void {\r\n\t\tfor (let i: number = 0; i < this._changes.length; i++) {\r\n\t\t\tthis._changes[i].redo();\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tprotected _doBackwards(): void {\r\n\t\t\tfor (let i: number = this._changes.length-1; i >= 0 ; i--) {\r\n\t\t\tthis._changes[i].undo();\r\n\t\t}\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { Algorithm, Dictionary, FilterType, InstrumentType, EffectType, AutomationTarget, Config, effectsIncludeDistortion } from \"../synth/SynthConfig\";\r\nimport { NotePin, Note, makeNotePin, Pattern, FilterSettings, FilterControlPoint, SpectrumWave, HarmonicsWave, Instrument, Channel, Song, Synth } from \"../synth/synth\";\r\nimport { Preset, PresetCategory, EditorConfig } from \"./EditorConfig\";\r\nimport { Change, ChangeGroup, ChangeSequence, UndoableChange } from \"./Change\";\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { ColorConfig } from \"./ColorConfig\";\r\n\r\nexport function patternsContainSameInstruments(pattern1Instruments: number[], pattern2Instruments: number[]): boolean {\r\n    const pattern2Has1Instruments: boolean = pattern1Instruments.every(instrument => pattern2Instruments.indexOf(instrument) != -1);\r\n    const pattern1Has2Instruments: boolean = pattern2Instruments.every(instrument => pattern1Instruments.indexOf(instrument) != -1);\r\n    return pattern2Has1Instruments && pattern1Has2Instruments && pattern2Instruments.length == pattern1Instruments.length;\r\n}\r\n\r\nexport function discardInvalidPatternInstruments(instruments: number[], song: Song, channelIndex: number) {\r\n    const uniqueInstruments: Set<number> = new Set(instruments);\r\n    instruments.length = 0;\r\n    instruments.push(...uniqueInstruments);\r\n    for (let i: number = 0; i < instruments.length; i++) {\r\n        if (instruments[i] >= song.channels[channelIndex].instruments.length) {\r\n            instruments.splice(i, 1);\r\n            i--;\r\n        }\r\n    }\r\n    if (instruments.length > song.getMaxInstrumentsPerPattern(channelIndex)) {\r\n        instruments.length = song.getMaxInstrumentsPerPattern(channelIndex);\r\n    }\r\n    if (instruments.length <= 0) {\r\n        instruments[0] = 0;\r\n    }\r\n}\r\n\r\nexport function unionOfUsedNotes(pattern: Pattern, flags: boolean[]): void {\r\n    for (const note of pattern.notes) {\r\n        for (const pitch of note.pitches) {\r\n            for (const pin of note.pins) {\r\n                const key: number = (pitch + pin.interval) % 12;\r\n                if (!flags[key]) {\r\n                    flags[key] = true;\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nexport function generateScaleMap(oldScaleFlags: ReadonlyArray<boolean>, newScaleValue: number): number[] {\r\n    const newScaleFlags: ReadonlyArray<boolean> = Config.scales[newScaleValue].flags;\r\n    const oldScale: number[] = [];\r\n    const newScale: number[] = [];\r\n    for (let i: number = 0; i < 12; i++) {\r\n        if (oldScaleFlags[i]) oldScale.push(i);\r\n        if (newScaleFlags[i]) newScale.push(i);\r\n    }\r\n    const largerToSmaller: boolean = oldScale.length > newScale.length;\r\n    const smallerScale: number[] = largerToSmaller ? newScale : oldScale;\r\n    const largerScale: number[] = largerToSmaller ? oldScale : newScale;\r\n\r\n    const roles: string[] = [\"root\", \"second\", \"second\", \"third\", \"third\", \"fourth\", \"tritone\", \"fifth\", \"sixth\", \"sixth\", \"seventh\", \"seventh\", \"root\"];\r\n    let bestScore: number = Number.MAX_SAFE_INTEGER;\r\n    let bestIndexMap: number[] = [];\r\n    const stack: number[][] = [[0]]; // Root always maps to root.\r\n\r\n    while (stack.length > 0) {\r\n        const indexMap: number[] = stack.pop()!;\r\n\r\n        if (indexMap.length == smallerScale.length) {\r\n            // Score this mapping.\r\n            let score: number = 0;\r\n            for (let i: number = 0; i < indexMap.length; i++) {\r\n                score += Math.abs(smallerScale[i] - largerScale[indexMap[i]]);\r\n                if (roles[smallerScale[i]] != roles[largerScale[indexMap[i]]]) {\r\n                    // Penalize changing roles.\r\n                    score += 0.75;\r\n                }\r\n            }\r\n            if (bestScore > score) {\r\n                bestScore = score;\r\n                bestIndexMap = indexMap;\r\n            }\r\n        } else {\r\n            // Recursively choose next indices for mapping.\r\n            const lowIndex: number = indexMap[indexMap.length - 1] + 1;\r\n            const highIndex: number = largerScale.length - smallerScale.length + indexMap.length;\r\n            for (let i: number = lowIndex; i <= highIndex; i++) {\r\n                stack.push(indexMap.concat(i));\r\n            }\r\n        }\r\n    }\r\n\r\n    const sparsePitchMap: number[][] = [];\r\n    for (let i: number = 0; i < bestIndexMap.length; i++) {\r\n        const smallerScalePitch = smallerScale[i];\r\n        const largerScalePitch = largerScale[bestIndexMap[i]];\r\n        sparsePitchMap[i] = largerToSmaller\r\n            ? [largerScalePitch, smallerScalePitch]\r\n            : [smallerScalePitch, largerScalePitch];\r\n    }\r\n\r\n    // To make it easier to wrap around.\r\n    sparsePitchMap.push([12, 12]);\r\n    newScale.push(12);\r\n\r\n    let sparseIndex: number = 0;\r\n    const fullPitchMap: number[] = [];\r\n    for (let i: number = 0; i < 12; i++) {\r\n        const oldLow: number = sparsePitchMap[sparseIndex][0];\r\n        const newLow: number = sparsePitchMap[sparseIndex][1];\r\n        const oldHigh: number = sparsePitchMap[sparseIndex + 1][0];\r\n        const newHigh: number = sparsePitchMap[sparseIndex + 1][1];\r\n        if (i == oldHigh - 1) sparseIndex++;\r\n\r\n        const transformedPitch: number = (i - oldLow) * (newHigh - newLow) / (oldHigh - oldLow) + newLow;\r\n\r\n        let nearestPitch: number = 0;\r\n        let nearestPitchDistance: number = Number.MAX_SAFE_INTEGER;\r\n        for (const newPitch of newScale) {\r\n            let distance: number = Math.abs(newPitch - transformedPitch);\r\n            if (roles[newPitch] != roles[i]) {\r\n                // Again, penalize changing roles.\r\n                distance += 0.1;\r\n            }\r\n            if (nearestPitchDistance > distance) {\r\n                nearestPitchDistance = distance;\r\n                nearestPitch = newPitch;\r\n            }\r\n        }\r\n\r\n        fullPitchMap[i] = nearestPitch;\r\n    }\r\n\r\n    return fullPitchMap;\r\n}\r\n\r\nfunction removeRedundantPins(pins: NotePin[]): void {\r\n    for (let i: number = 1; i < pins.length - 1;) {\r\n        if (pins[i - 1].interval == pins[i].interval &&\r\n            pins[i].interval == pins[i + 1].interval &&\r\n            pins[i - 1].size == pins[i].size &&\r\n            pins[i].size == pins[i + 1].size) {\r\n            pins.splice(i, 1);\r\n        } else {\r\n            i++;\r\n        }\r\n    }\r\n}\r\n\r\nfunction projectNoteIntoBar(oldNote: Note, timeOffset: number, noteStartPart: number, noteEndPart: number, newNotes: Note[]): void {\r\n    // Create a new note, and interpret the pitch bend and size events\r\n    // to determine where we need to insert pins to control interval and volume.\r\n    const newNote: Note = new Note(-1, noteStartPart, noteEndPart, Config.noteSizeMax, false);\r\n    newNote.pins.length = 0;\r\n    newNote.pitches.length = 0;\r\n    const newNoteLength: number = noteEndPart - noteStartPart;\r\n\r\n    for (const pitch of oldNote.pitches) {\r\n        newNote.pitches.push(pitch);\r\n    }\r\n\r\n    for (let pinIndex: number = 0; pinIndex < oldNote.pins.length; pinIndex++) {\r\n        const pin: NotePin = oldNote.pins[pinIndex];\r\n        const newPinTime: number = pin.time + timeOffset;\r\n        if (newPinTime < 0) {\r\n            if (pinIndex + 1 >= oldNote.pins.length) throw new Error(\"Error converting pins in note overflow.\");\r\n            const nextPin: NotePin = oldNote.pins[pinIndex + 1];\r\n            const nextPinTime: number = nextPin.time + timeOffset;\r\n            if (nextPinTime > 0) {\r\n                // Insert an interpolated pin at the start of the new note.\r\n                const ratio: number = (-newPinTime) / (nextPinTime - newPinTime);\r\n                newNote.pins.push(makeNotePin(Math.round(pin.interval + ratio * (nextPin.interval - pin.interval)), 0, Math.round(pin.size + ratio * (nextPin.size - pin.size))));\r\n\r\n            }\r\n        } else if (newPinTime <= newNoteLength) {\r\n            newNote.pins.push(makeNotePin(pin.interval, newPinTime, pin.size));\r\n        } else {\r\n            if (pinIndex < 1) throw new Error(\"Error converting pins in note overflow.\");\r\n            const prevPin: NotePin = oldNote.pins[pinIndex - 1];\r\n            const prevPinTime: number = prevPin.time + timeOffset;\r\n            if (prevPinTime < newNoteLength) {\r\n                // Insert an interpolated pin at the end of the new note.\r\n                const ratio: number = (newNoteLength - prevPinTime) / (newPinTime - prevPinTime);\r\n                newNote.pins.push(makeNotePin(Math.round(prevPin.interval + ratio * (pin.interval - prevPin.interval)), newNoteLength, Math.round(prevPin.size + ratio * (pin.size - prevPin.size))));\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Fix from Jummbus: Ensure the first pin's interval is zero, adjust pitches and pins to compensate.\r\n    const offsetInterval: number = newNote.pins[0].interval;\r\n    for (let pitchIdx: number = 0; pitchIdx < newNote.pitches.length; pitchIdx++) {\r\n        newNote.pitches[pitchIdx] += offsetInterval;\r\n    }\r\n    for (let pinIdx: number = 0; pinIdx < newNote.pins.length; pinIdx++) {\r\n        newNote.pins[pinIdx].interval -= offsetInterval;\r\n    }\r\n\r\n    let joinedWithPrevNote: boolean = false;\r\n    if (newNote.start == 0) {\r\n        newNote.continuesLastPattern = (timeOffset < 0 || oldNote.continuesLastPattern);\r\n    } else {\r\n        newNote.continuesLastPattern = false;\r\n        if (newNotes.length > 0 && oldNote.continuesLastPattern) {\r\n            const prevNote: Note = newNotes[newNotes.length - 1];\r\n            if (prevNote.end == newNote.start && Synth.adjacentNotesHaveMatchingPitches(prevNote, newNote)) {\r\n                joinedWithPrevNote = true;\r\n                const newIntervalOffset: number = prevNote.pins[prevNote.pins.length - 1].interval;\r\n                const newTimeOffset: number = prevNote.end - prevNote.start;\r\n                for (let pinIndex: number = 1; pinIndex < newNote.pins.length; pinIndex++) {\r\n                    const tempPin: NotePin = newNote.pins[pinIndex];\r\n                    const transformedPin: NotePin = makeNotePin(tempPin.interval + newIntervalOffset, tempPin.time + newTimeOffset, tempPin.size);\r\n                    prevNote.pins.push(transformedPin);\r\n                    prevNote.end = prevNote.start + transformedPin.time;\r\n                }\r\n                removeRedundantPins(prevNote.pins);\r\n            }\r\n        }\r\n    }\r\n    if (!joinedWithPrevNote) {\r\n        newNotes.push(newNote);\r\n    }\r\n}\r\n\r\nexport class ChangeMoveAndOverflowNotes extends ChangeGroup {\r\n    constructor(doc: SongDocument, newBeatsPerBar: number, partsToMove: number) {\r\n        super();\r\n\r\n        const pitchChannels: Channel[] = [];\r\n        const noiseChannels: Channel[] = [];\r\n        const modChannels: Channel[] = []\r\n\r\n        for (let channelIndex: number = 0; channelIndex < doc.song.getChannelCount(); channelIndex++) {\r\n            const oldChannel: Channel = doc.song.channels[channelIndex];\r\n            const newChannel: Channel = new Channel();\r\n\r\n            if (channelIndex < doc.song.pitchChannelCount) {\r\n                pitchChannels.push(newChannel);\r\n            } else if (channelIndex < doc.song.pitchChannelCount + doc.song.noiseChannelCount) {\r\n                noiseChannels.push(newChannel);\r\n            }\r\n            else {\r\n                modChannels.push(newChannel);\r\n            }\r\n\r\n            newChannel.muted = oldChannel.muted;\r\n            newChannel.octave = oldChannel.octave;\r\n            newChannel.name = oldChannel.name;\r\n\r\n            for (const instrument of oldChannel.instruments) {\r\n                newChannel.instruments.push(instrument);\r\n            }\r\n\r\n            const oldPartsPerBar: number = Config.partsPerBeat * doc.song.beatsPerBar;\r\n            const newPartsPerBar: number = Config.partsPerBeat * newBeatsPerBar;\r\n            let currentBar: number = -1;\r\n            let pattern: Pattern | null = null;\r\n\r\n            for (let oldBar: number = 0; oldBar < doc.song.barCount; oldBar++) {\r\n                const oldPattern: Pattern | null = doc.song.getPattern(channelIndex, oldBar);\r\n                if (oldPattern != null) {\r\n                    const oldBarStart: number = oldBar * oldPartsPerBar;\r\n                    for (const oldNote of oldPattern.notes) {\r\n\r\n                        const absoluteNoteStart: number = oldNote.start + oldBarStart + partsToMove;\r\n                        const absoluteNoteEnd: number = oldNote.end + oldBarStart + partsToMove;\r\n\r\n                        const startBar: number = Math.floor(absoluteNoteStart / newPartsPerBar);\r\n                        const endBar: number = Math.ceil(absoluteNoteEnd / newPartsPerBar);\r\n                        for (let bar: number = startBar; bar < endBar; bar++) {\r\n                            const barStartPart: number = bar * newPartsPerBar;\r\n                            const noteStartPart: number = Math.max(0, absoluteNoteStart - barStartPart);\r\n                            const noteEndPart: number = Math.min(newPartsPerBar, absoluteNoteEnd - barStartPart);\r\n\r\n                            if (noteStartPart < noteEndPart) {\r\n\r\n                                // Ensure a pattern exists for the current bar before inserting notes into it.\r\n                                if (currentBar < bar || pattern == null) {\r\n                                    currentBar++;\r\n                                    while (currentBar < bar) {\r\n                                        newChannel.bars[currentBar] = 0;\r\n                                        currentBar++;\r\n                                    }\r\n                                    pattern = new Pattern();\r\n                                    newChannel.patterns.push(pattern);\r\n                                    newChannel.bars[currentBar] = newChannel.patterns.length;\r\n                                    pattern.instruments.length = 0;\r\n                                    pattern.instruments.push(...oldPattern.instruments);\r\n                                }\r\n\r\n                                // This is a consideration to allow arbitrary note sequencing, e.g. for mod channels (so the pattern being used can jump around)\r\n                                pattern = newChannel.patterns[newChannel.bars[bar] - 1];\r\n\r\n                                projectNoteIntoBar(oldNote, absoluteNoteStart - barStartPart - noteStartPart, noteStartPart, noteEndPart, pattern.notes);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        removeDuplicatePatterns(pitchChannels);\r\n        removeDuplicatePatterns(noiseChannels);\r\n        removeDuplicatePatterns(modChannels);\r\n        this.append(new ChangeReplacePatterns(doc, pitchChannels, noiseChannels, modChannels));\r\n    }\r\n}\r\n\r\nclass ChangePins extends UndoableChange {\r\n    protected _oldStart: number;\r\n    protected _newStart: number;\r\n    protected _oldEnd: number;\r\n    protected _newEnd: number;\r\n    protected _oldPins: NotePin[];\r\n    protected _newPins: NotePin[];\r\n    protected _oldPitches: number[];\r\n    protected _newPitches: number[];\r\n    protected _oldContinuesLastPattern: boolean;\r\n    protected _newContinuesLastPattern: boolean;\r\n    constructor(protected _doc: SongDocument | null, protected _note: Note) {\r\n        super(false);\r\n        this._oldStart = this._note.start;\r\n        this._oldEnd = this._note.end;\r\n        this._newStart = this._note.start;\r\n        this._newEnd = this._note.end;\r\n        this._oldPins = this._note.pins;\r\n        this._newPins = [];\r\n        this._oldPitches = this._note.pitches;\r\n        this._newPitches = [];\r\n        this._oldContinuesLastPattern = this._note.continuesLastPattern;\r\n        this._newContinuesLastPattern = this._note.continuesLastPattern;\r\n    }\r\n\r\n    protected _finishSetup(continuesLastPattern?: boolean): void {\r\n        for (let i: number = 0; i < this._newPins.length - 1;) {\r\n            if (this._newPins[i].time >= this._newPins[i + 1].time) {\r\n                this._newPins.splice(i, 1);\r\n            } else {\r\n                i++;\r\n            }\r\n        }\r\n\r\n        removeRedundantPins(this._newPins);\r\n\r\n        const firstInterval: number = this._newPins[0].interval;\r\n        const firstTime: number = this._newPins[0].time;\r\n        for (let i: number = 0; i < this._oldPitches.length; i++) {\r\n            this._newPitches[i] = this._oldPitches[i] + firstInterval;\r\n        }\r\n        for (let i: number = 0; i < this._newPins.length; i++) {\r\n            this._newPins[i].interval -= firstInterval;\r\n            this._newPins[i].time -= firstTime;\r\n        }\r\n        this._newStart = this._oldStart + firstTime;\r\n        this._newEnd = this._newStart + this._newPins[this._newPins.length - 1].time;\r\n\r\n        if (continuesLastPattern != undefined) {\r\n            this._newContinuesLastPattern = continuesLastPattern;\r\n        }\r\n        if (this._newStart != 0) {\r\n            this._newContinuesLastPattern = false;\r\n        }\r\n\r\n        this._doForwards();\r\n        this._didSomething();\r\n    }\r\n\r\n    protected _doForwards(): void {\r\n        this._note.pins = this._newPins;\r\n        this._note.pitches = this._newPitches;\r\n        this._note.start = this._newStart;\r\n        this._note.end = this._newEnd;\r\n        this._note.continuesLastPattern = this._newContinuesLastPattern;\r\n        if (this._doc != null) this._doc.notifier.changed();\r\n    }\r\n\r\n    protected _doBackwards(): void {\r\n        this._note.pins = this._oldPins;\r\n        this._note.pitches = this._oldPitches;\r\n        this._note.start = this._oldStart;\r\n        this._note.end = this._oldEnd;\r\n        this._note.continuesLastPattern = this._oldContinuesLastPattern;\r\n        if (this._doc != null) this._doc.notifier.changed();\r\n    }\r\n}\r\n\r\nexport class ChangeCustomizeInstrument extends Change {\r\n    constructor(doc: SongDocument) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        if (instrument.preset != instrument.type) {\r\n            instrument.preset = instrument.type;\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeCustomWave extends Change {\r\n    constructor(doc: SongDocument, newArray: Float32Array) {\r\n        super();\r\n        const oldArray: Float32Array = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()].customChipWave;\r\n        var comparisonResult: boolean = true;\r\n        for (let i: number = 0; i < oldArray.length; i++) {\r\n            if (oldArray[i] != newArray[i]) {\r\n                comparisonResult = false;\r\n                i = oldArray.length;\r\n            }\r\n        }\r\n        if (comparisonResult == false) {\r\n            let instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n            for (let i: number = 0; i < newArray.length; i++) {\r\n                instrument.customChipWave[i] = newArray[i];\r\n            }\r\n\r\n            let sum: number = 0.0;\r\n            for (let i: number = 0; i < instrument.customChipWave.length; i++) {\r\n                sum += instrument.customChipWave[i];\r\n            }\r\n            const average: number = sum / instrument.customChipWave.length;\r\n\r\n            // Perform the integral on the wave. The chipSynth will perform the derivative to get the original wave back but with antialiasing.\r\n            let cumulative: number = 0;\r\n            let wavePrev: number = 0;\r\n            for (let i: number = 0; i < instrument.customChipWave.length; i++) {\r\n                cumulative += wavePrev;\r\n                wavePrev = instrument.customChipWave[i] - average;\r\n                instrument.customChipWaveIntegral[i] = cumulative;\r\n            }\r\n\r\n            instrument.customChipWaveIntegral[64] = 0.0;\r\n            instrument.preset = instrument.type;\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangePreset extends Change {\r\n    constructor(doc: SongDocument, newValue: number) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        const oldValue: number = instrument.preset;\r\n        if (oldValue != newValue) {\r\n            const preset: Preset | null = EditorConfig.valueToPreset(newValue);\r\n            if (preset != null) {\r\n                if (preset.customType != undefined) {\r\n                    instrument.type = preset.customType;\r\n                    if (!Config.instrumentTypeHasSpecialInterval[instrument.type] && Config.chords[instrument.chord].customInterval) {\r\n                        instrument.chord = 0;\r\n                    }\r\n                    instrument.clearInvalidEnvelopeTargets();\r\n                } else if (preset.settings != undefined) {\r\n                    const tempVolume: number = instrument.volume;\r\n                    const tempPan: number = instrument.pan;\r\n                    const tempPanDelay = instrument.panDelay;\r\n                    //const usesPanning: boolean = effectsIncludePanning(instrument.effects);\r\n                    instrument.fromJsonObject(preset.settings, doc.song.getChannelIsNoise(doc.channel), doc.song.getChannelIsMod(doc.channel), doc.song.rhythm == 0 || doc.song.rhythm == 2, doc.song.rhythm >= 2);\r\n                    instrument.volume = tempVolume;\r\n                    instrument.pan = tempPan;\r\n                    instrument.panDelay = tempPanDelay;\r\n                    //@jummbus - Disable this check, pan will be on by default.\r\n                    //if (usesPanning && instrument.pan != Config.panCenter) {\r\n                        instrument.effects = (instrument.effects | (1 << EffectType.panning));\r\n                    //}\r\n                }\r\n            }\r\n            instrument.preset = newValue;\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeRandomGeneratedInstrument extends Change {\r\n    constructor(doc: SongDocument) {\r\n        super();\r\n\r\n        interface ItemWeight<T> {\r\n            readonly item: T;\r\n            readonly weight: number;\r\n        }\r\n        function selectWeightedRandom<T>(entries: ReadonlyArray<ItemWeight<T>>): T {\r\n            let total: number = 0;\r\n            for (const entry of entries) {\r\n                total += entry.weight;\r\n            }\r\n            let random: number = Math.random() * total;\r\n            for (const entry of entries) {\r\n                random -= entry.weight;\r\n                if (random <= 0.0) return entry.item;\r\n            }\r\n            return entries[(Math.random() * entries.length) | 0].item;\r\n        }\r\n        function selectCurvedDistribution(min: number, max: number, peak: number, width: number): number {\r\n            const entries: Array<ItemWeight<number>> = [];\r\n            for (let i: number = min; i <= max; i++) {\r\n                entries.push({ item: i, weight: 1.0 / (Math.pow((i - peak) / width, 2.0) + 1.0) });\r\n            }\r\n            return selectWeightedRandom(entries);\r\n        }\r\n\r\n        class PotentialFilterPoint {\r\n            constructor(\r\n                public readonly chance: number,\r\n                public readonly type: FilterType,\r\n                public readonly minFreq: number,\r\n                public readonly maxFreq: number,\r\n                public readonly centerHz: number,\r\n                public readonly centerGain: number,\r\n            ) { };\r\n        }\r\n        function applyFilterPoints(filter: FilterSettings, potentialPoints: ReadonlyArray<PotentialFilterPoint>): void {\r\n            filter.reset();\r\n            const usedFreqs: number[] = [];\r\n            for (const potentialPoint of potentialPoints) {\r\n                if (Math.random() > potentialPoint.chance) continue;\r\n                const point: FilterControlPoint = new FilterControlPoint();\r\n                point.type = potentialPoint.type;\r\n                point.freq = selectCurvedDistribution(potentialPoint.minFreq, potentialPoint.maxFreq, FilterControlPoint.getRoundedSettingValueFromHz(potentialPoint.centerHz), 1.0 / Config.filterFreqStep);\r\n                point.gain = selectCurvedDistribution(0, Config.filterGainRange - 1, Config.filterGainCenter + potentialPoint.centerGain, 2.0 / Config.filterGainStep);\r\n                if (point.type == FilterType.peak && point.gain == Config.filterGainCenter) continue; // skip pointless points. :P\r\n                if (usedFreqs.includes(point.freq)) continue;\r\n                usedFreqs.push(point.freq);\r\n                filter.controlPoints[filter.controlPointCount] = point;\r\n                filter.controlPointCount++;\r\n            }\r\n        }\r\n\r\n        const isNoise: boolean = doc.song.getChannelIsNoise(doc.channel);\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        instrument.effects &= 1 << EffectType.panning; // disable all existing effects except panning.\r\n        instrument.envelopeCount = 0;\r\n\r\n        const midFreq: number = FilterControlPoint.getRoundedSettingValueFromHz(700.0);\r\n        const maxFreq: number = Config.filterFreqRange - 1;\r\n        applyFilterPoints(instrument.eqFilter, [\r\n            new PotentialFilterPoint(0.8, FilterType.lowPass, midFreq, maxFreq, 4000.0, -1),\r\n            new PotentialFilterPoint(0.4, FilterType.highPass, 0, midFreq - 1, 250.0, -1),\r\n            new PotentialFilterPoint(0.5, FilterType.peak, 0, maxFreq, 2000.0, 0),\r\n            new PotentialFilterPoint(0.4, FilterType.peak, 0, maxFreq, 1400.0, 0),\r\n            new PotentialFilterPoint(0.3, FilterType.peak, 0, maxFreq, 1000.0, 0),\r\n            new PotentialFilterPoint(0.2, FilterType.peak, 0, maxFreq, 500.0, 0),\r\n        ]);\r\n\r\n        if (isNoise) {\r\n            const type: InstrumentType = selectWeightedRandom([\r\n                { item: InstrumentType.noise, weight: 1 },\r\n                { item: InstrumentType.spectrum, weight: 3 },\r\n            ]);\r\n            instrument.preset = instrument.type = type;\r\n\r\n            instrument.fadeIn = (Math.random() < 0.8) ? 0 : selectCurvedDistribution(0, Config.fadeInRange - 1, 0, 2);\r\n            instrument.fadeOut = selectCurvedDistribution(0, Config.fadeOutTicks.length - 1, Config.fadeOutNeutral, 2);\r\n\r\n            if (Math.random() < 0.1) {\r\n                instrument.effects |= 1 << EffectType.transition;\r\n                instrument.transition = Config.transitions.dictionary[selectWeightedRandom([\r\n                    { item: \"normal\", weight: 30 },\r\n                    { item: \"interrupt\", weight: 1 },\r\n                    { item: \"slide\", weight: 2 },\r\n                ])].index;\r\n            }\r\n            if (Math.random() < 0.2) {\r\n                instrument.effects |= 1 << EffectType.chord;\r\n                instrument.chord = Config.chords.dictionary[selectWeightedRandom([\r\n                    { item: \"strum\", weight: 2 },\r\n                    { item: \"arpeggio\", weight: 1 },\r\n                ])].index;\r\n            }\r\n            if (Math.random() < 0.1) {\r\n                instrument.pitchShift = selectCurvedDistribution(0, Config.pitchShiftRange - 1, Config.pitchShiftCenter, 2);\r\n                if (instrument.pitchShift != Config.pitchShiftCenter) {\r\n                    instrument.effects |= 1 << EffectType.pitchShift;\r\n                    instrument.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"pitchShift\"].index, 0, Config.envelopes.dictionary[selectWeightedRandom([\r\n                        { item: \"flare 1\", weight: 2 },\r\n                        { item: \"flare 2\", weight: 1 },\r\n                        { item: \"flare 3\", weight: 1 },\r\n                        { item: \"twang 1\", weight: 16 },\r\n                        { item: \"twang 2\", weight: 8 },\r\n                        { item: \"twang 3\", weight: 4 },\r\n                        { item: \"tremolo1\", weight: 1 },\r\n                        { item: \"tremolo2\", weight: 1 },\r\n                        { item: \"tremolo3\", weight: 1 },\r\n                        { item: \"decay 1\", weight: 4 },\r\n                        { item: \"decay 2\", weight: 2 },\r\n                        { item: \"decay 3\", weight: 1 },\r\n                    ])].index);\r\n                }\r\n            }\r\n            if (Math.random() < 0.1) {\r\n                instrument.effects |= 1 << EffectType.vibrato;\r\n                instrument.vibrato = selectCurvedDistribution(0, Config.echoSustainRange - 1, Config.echoSustainRange >> 1, 2);\r\n                instrument.vibrato = Config.vibratos.dictionary[selectWeightedRandom([\r\n                    { item: \"light\", weight: 2 },\r\n                    { item: \"delayed\", weight: 2 },\r\n                    { item: \"heavy\", weight: 1 },\r\n                    { item: \"shaky\", weight: 2 },\r\n                ])].index;\r\n            }\r\n            if (Math.random() < 0.8) {\r\n                instrument.effects |= 1 << EffectType.noteFilter;\r\n                applyFilterPoints(instrument.noteFilter, [\r\n                    new PotentialFilterPoint(1.0, FilterType.lowPass, midFreq, maxFreq, 8000.0, -1),\r\n                ]);\r\n                instrument.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"noteFilterAllFreqs\"].index, 0, Config.envelopes.dictionary[selectWeightedRandom([\r\n                    { item: \"punch\", weight: 4 },\r\n                    { item: \"flare 1\", weight: 2 },\r\n                    { item: \"flare 2\", weight: 2 },\r\n                    { item: \"flare 3\", weight: 2 },\r\n                    { item: \"twang 1\", weight: 8 },\r\n                    { item: \"twang 2\", weight: 8 },\r\n                    { item: \"twang 3\", weight: 8 },\r\n                    { item: \"swell 1\", weight: 2 },\r\n                    { item: \"swell 2\", weight: 2 },\r\n                    { item: \"swell 3\", weight: 1 },\r\n                    { item: \"tremolo1\", weight: 1 },\r\n                    { item: \"tremolo2\", weight: 1 },\r\n                    { item: \"tremolo3\", weight: 1 },\r\n                    { item: \"tremolo4\", weight: 1 },\r\n                    { item: \"tremolo5\", weight: 1 },\r\n                    { item: \"tremolo6\", weight: 1 },\r\n                    { item: \"decay 1\", weight: 4 },\r\n                    { item: \"decay 2\", weight: 4 },\r\n                    { item: \"decay 3\", weight: 4 },\r\n                ])].index);\r\n            }\r\n            if (Math.random() < 0.1) {\r\n                instrument.effects |= 1 << EffectType.distortion;\r\n                instrument.distortion = selectCurvedDistribution(1, Config.distortionRange - 1, Config.distortionRange - 1, 2);\r\n            }\r\n            if (Math.random() < 0.1) {\r\n                instrument.effects |= 1 << EffectType.bitcrusher;\r\n                instrument.bitcrusherFreq = selectCurvedDistribution(0, Config.bitcrusherFreqRange - 1, Config.bitcrusherFreqRange >> 1, 2);\r\n                instrument.bitcrusherQuantization = selectCurvedDistribution(0, Config.bitcrusherQuantizationRange - 1, Config.bitcrusherQuantizationRange >> 1, 2);\r\n            }\r\n            if (Math.random() < 0.1) {\r\n                instrument.effects |= 1 << EffectType.chorus;\r\n                instrument.chorus = selectCurvedDistribution(1, Config.chorusRange - 1, Config.chorusRange - 1, 1);\r\n            }\r\n            if (Math.random() < 0.1) {\r\n                instrument.echoSustain = selectCurvedDistribution(0, Config.echoSustainRange - 1, Config.echoSustainRange >> 1, 2);\r\n                instrument.echoDelay = selectCurvedDistribution(0, Config.echoDelayRange - 1, Config.echoDelayRange >> 1, 2);\r\n                if (instrument.echoSustain != 0 || instrument.echoDelay != 0) {\r\n                    instrument.effects |= 1 << EffectType.echo;\r\n                }\r\n            }\r\n            if (Math.random() < 0.5) {\r\n                instrument.effects |= 1 << EffectType.reverb;\r\n                instrument.reverb = selectCurvedDistribution(1, Config.reverbRange - 1, 1, 1);\r\n            }\r\n\r\n            function normalize(harmonics: number[]): void {\r\n                let max: number = 0;\r\n                for (const value of harmonics) {\r\n                    if (value > max) max = value;\r\n                }\r\n                for (let i: number = 0; i < harmonics.length; i++) {\r\n                    harmonics[i] = Config.harmonicsMax * harmonics[i] / max;\r\n                }\r\n            }\r\n            switch (type) {\r\n                case InstrumentType.noise: {\r\n                    instrument.chipNoise = (Math.random() * Config.chipNoises.length) | 0;\r\n                } break;\r\n                case InstrumentType.spectrum: {\r\n                    const spectrumGenerators: Function[] = [\r\n                        (): number[] => {\r\n                            const spectrum: number[] = [];\r\n                            for (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n                                spectrum[i] = (Math.random() < 0.5) ? Math.random() : 0.0;\r\n                            }\r\n                            return spectrum;\r\n                        },\r\n                        (): number[] => {\r\n                            let current: number = 1.0;\r\n                            const spectrum: number[] = [current];\r\n                            for (let i = 1; i < Config.spectrumControlPoints; i++) {\r\n                                current *= Math.pow(2, Math.random() - 0.52);\r\n                                spectrum[i] = current;\r\n                            }\r\n                            return spectrum;\r\n                        },\r\n                        (): number[] => {\r\n                            let current: number = 1.0;\r\n                            const spectrum: number[] = [current];\r\n                            for (let i = 1; i < Config.spectrumControlPoints; i++) {\r\n                                current *= Math.pow(2, Math.random() - 0.52);\r\n                                spectrum[i] = current * Math.random();\r\n                            }\r\n                            return spectrum;\r\n                        },\r\n                    ];\r\n                    const generator = spectrumGenerators[(Math.random() * spectrumGenerators.length) | 0];\r\n                    const spectrum: number[] = generator();\r\n                    normalize(spectrum);\r\n                    for (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n                        instrument.spectrumWave.spectrum[i] = Math.round(spectrum[i]);\r\n                    }\r\n                    instrument.spectrumWave.markCustomWaveDirty();\r\n                } break;\r\n                default: throw new Error(\"Unhandled noise instrument type in random generator.\");\r\n            }\r\n        } else {\r\n            const type: InstrumentType = selectWeightedRandom([\r\n                { item: InstrumentType.chip, weight: 4 },\r\n                { item: InstrumentType.pwm, weight: 4 },\r\n                { item: InstrumentType.harmonics, weight: 5 },\r\n                { item: InstrumentType.pickedString, weight: 5 },\r\n                { item: InstrumentType.spectrum, weight: 1 },\r\n                { item: InstrumentType.fm, weight: 5 },\r\n            ]);\r\n            instrument.preset = instrument.type = type;\r\n\r\n            instrument.fadeIn = (Math.random() < 0.5) ? 0 : selectCurvedDistribution(0, Config.fadeInRange - 1, 0, 2);\r\n            instrument.fadeOut = selectCurvedDistribution(0, Config.fadeOutTicks.length - 1, Config.fadeOutNeutral, 2);\r\n            if (type == InstrumentType.chip || type == InstrumentType.harmonics || type == InstrumentType.pickedString) {\r\n                instrument.unison = Config.unisons.dictionary[selectWeightedRandom([\r\n                    { item: \"none\", weight: 10 },\r\n                    { item: \"shimmer\", weight: 5 },\r\n                    { item: \"hum\", weight: 4 },\r\n                    { item: \"honky tonk\", weight: 3 },\r\n                    { item: \"dissonant\", weight: 1 },\r\n                    { item: \"fifth\", weight: 1 },\r\n                    { item: \"octave\", weight: 2 },\r\n                    { item: \"bowed\", weight: 2 },\r\n                    { item: \"piano\", weight: 5 },\r\n                    { item: \"warbled\", weight: 3 },\r\n                ])].index;\r\n            }\r\n\r\n            if (Math.random() < 0.1) {\r\n                instrument.effects |= 1 << EffectType.transition;\r\n                instrument.transition = Config.transitions.dictionary[selectWeightedRandom([\r\n                    { item: \"interrupt\", weight: 1 },\r\n                    { item: \"slide\", weight: 2 },\r\n                ])].index;\r\n            }\r\n            if (Math.random() < 0.2) {\r\n                instrument.effects |= 1 << EffectType.chord;\r\n                instrument.chord = Config.chords.dictionary[selectWeightedRandom([\r\n                    { item: \"strum\", weight: 2 },\r\n                    { item: \"arpeggio\", weight: 1 },\r\n                ])].index;\r\n            }\r\n            if (Math.random() < 0.05) {\r\n                instrument.pitchShift = selectCurvedDistribution(0, Config.pitchShiftRange - 1, Config.pitchShiftCenter, 1);\r\n                if (instrument.pitchShift != Config.pitchShiftCenter) {\r\n                    instrument.effects |= 1 << EffectType.pitchShift;\r\n                    instrument.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"pitchShift\"].index, 0, Config.envelopes.dictionary[selectWeightedRandom([\r\n                        { item: \"flare 1\", weight: 2 },\r\n                        { item: \"flare 2\", weight: 1 },\r\n                        { item: \"flare 3\", weight: 1 },\r\n                        { item: \"twang 1\", weight: 16 },\r\n                        { item: \"twang 2\", weight: 8 },\r\n                        { item: \"twang 3\", weight: 4 },\r\n                        { item: \"decay 1\", weight: 4 },\r\n                        { item: \"decay 2\", weight: 2 },\r\n                        { item: \"decay 3\", weight: 1 },\r\n                    ])].index);\r\n                }\r\n            }\r\n            if (Math.random() < 0.25) {\r\n                instrument.effects |= 1 << EffectType.vibrato;\r\n                instrument.vibrato = selectCurvedDistribution(0, Config.echoSustainRange - 1, Config.echoSustainRange >> 1, 2);\r\n                instrument.vibrato = Config.vibratos.dictionary[selectWeightedRandom([\r\n                    { item: \"light\", weight: 2 },\r\n                    { item: \"delayed\", weight: 2 },\r\n                    { item: \"heavy\", weight: 1 },\r\n                    { item: \"shaky\", weight: 2 },\r\n                ])].index;\r\n            }\r\n            if (Math.random() < 0.1) {\r\n                instrument.effects |= 1 << EffectType.distortion;\r\n                instrument.distortion = selectCurvedDistribution(1, Config.distortionRange - 1, Config.distortionRange - 1, 2);\r\n            }\r\n            if (effectsIncludeDistortion(instrument.effects) && Math.random() < 0.8) {\r\n                instrument.effects |= 1 << EffectType.noteFilter;\r\n                applyFilterPoints(instrument.noteFilter, [\r\n                    new PotentialFilterPoint(1.0, FilterType.lowPass, midFreq, maxFreq, 2000.0, -1),\r\n                    new PotentialFilterPoint(0.9, FilterType.highPass, 0, midFreq - 1, 500.0, -1),\r\n                    new PotentialFilterPoint(0.4, FilterType.peak, 0, maxFreq, 1400.0, 0),\r\n                ]);\r\n            } else if (Math.random() < 0.5) {\r\n                instrument.effects |= 1 << EffectType.noteFilter;\r\n                applyFilterPoints(instrument.noteFilter, [\r\n                    new PotentialFilterPoint(1.0, FilterType.lowPass, midFreq, maxFreq, 8000.0, -1),\r\n                ]);\r\n                instrument.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"noteFilterAllFreqs\"].index, 0, Config.envelopes.dictionary[selectWeightedRandom([\r\n                    { item: \"punch\", weight: 6 },\r\n                    { item: \"flare 1\", weight: 2 },\r\n                    { item: \"flare 2\", weight: 4 },\r\n                    { item: \"flare 3\", weight: 2 },\r\n                    { item: \"twang 1\", weight: 2 },\r\n                    { item: \"twang 2\", weight: 4 },\r\n                    { item: \"twang 3\", weight: 4 },\r\n                    { item: \"swell 1\", weight: 4 },\r\n                    { item: \"swell 2\", weight: 2 },\r\n                    { item: \"swell 3\", weight: 1 },\r\n                    { item: \"tremolo1\", weight: 1 },\r\n                    { item: \"tremolo2\", weight: 1 },\r\n                    { item: \"tremolo3\", weight: 1 },\r\n                    { item: \"tremolo4\", weight: 1 },\r\n                    { item: \"tremolo5\", weight: 1 },\r\n                    { item: \"tremolo6\", weight: 1 },\r\n                    { item: \"decay 1\", weight: 1 },\r\n                    { item: \"decay 2\", weight: 2 },\r\n                    { item: \"decay 3\", weight: 2 },\r\n                ])].index);\r\n            }\r\n            if (Math.random() < 0.1) {\r\n                instrument.effects |= 1 << EffectType.bitcrusher;\r\n                instrument.bitcrusherFreq = selectCurvedDistribution(0, Config.bitcrusherFreqRange - 1, 0, 2);\r\n                instrument.bitcrusherQuantization = selectCurvedDistribution(0, Config.bitcrusherQuantizationRange - 1, Config.bitcrusherQuantizationRange >> 1, 2);\r\n            }\r\n            if (Math.random() < 0.1) {\r\n                instrument.effects |= 1 << EffectType.chorus;\r\n                instrument.chorus = selectCurvedDistribution(1, Config.chorusRange - 1, Config.chorusRange - 1, 1);\r\n            }\r\n            if (Math.random() < 0.1) {\r\n                instrument.echoSustain = selectCurvedDistribution(0, Config.echoSustainRange - 1, Config.echoSustainRange >> 1, 2);\r\n                instrument.echoDelay = selectCurvedDistribution(0, Config.echoDelayRange - 1, Config.echoDelayRange >> 1, 2);\r\n                if (instrument.echoSustain != 0 || instrument.echoDelay != 0) {\r\n                    instrument.effects |= 1 << EffectType.echo;\r\n                }\r\n            }\r\n            if (Math.random() < 0.5) {\r\n                instrument.effects |= 1 << EffectType.reverb;\r\n                instrument.reverb = selectCurvedDistribution(1, Config.reverbRange - 1, 1, 1);\r\n            }\r\n\r\n            function normalize(harmonics: number[]): void {\r\n                let max: number = 0;\r\n                for (const value of harmonics) {\r\n                    if (value > max) max = value;\r\n                }\r\n                for (let i: number = 0; i < harmonics.length; i++) {\r\n                    harmonics[i] = Config.harmonicsMax * harmonics[i] / max;\r\n                }\r\n            }\r\n            switch (type) {\r\n                case InstrumentType.chip: {\r\n                    instrument.chipWave = (Math.random() * Config.chipWaves.length) | 0;\r\n                } break;\r\n                case InstrumentType.pwm: {\r\n                    instrument.pulseWidth = selectCurvedDistribution(0, Config.pulseWidthRange - 1, Config.pulseWidthRange - 1, 2);\r\n\r\n                    if (Math.random() < 0.6) {\r\n                        instrument.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"pulseWidth\"].index, 0, Config.envelopes.dictionary[selectWeightedRandom([\r\n                            { item: \"punch\", weight: 6 },\r\n                            { item: \"flare 1\", weight: 2 },\r\n                            { item: \"flare 2\", weight: 4 },\r\n                            { item: \"flare 3\", weight: 2 },\r\n                            { item: \"twang 1\", weight: 2 },\r\n                            { item: \"twang 2\", weight: 4 },\r\n                            { item: \"twang 3\", weight: 4 },\r\n                            { item: \"swell 1\", weight: 4 },\r\n                            { item: \"swell 2\", weight: 2 },\r\n                            { item: \"swell 3\", weight: 1 },\r\n                            { item: \"tremolo1\", weight: 1 },\r\n                            { item: \"tremolo2\", weight: 1 },\r\n                            { item: \"tremolo3\", weight: 1 },\r\n                            { item: \"tremolo4\", weight: 1 },\r\n                            { item: \"tremolo5\", weight: 1 },\r\n                            { item: \"tremolo6\", weight: 1 },\r\n                            { item: \"decay 1\", weight: 1 },\r\n                            { item: \"decay 2\", weight: 2 },\r\n                            { item: \"decay 3\", weight: 2 },\r\n                        ])].index);\r\n                    }\r\n                } break;\r\n                case InstrumentType.pickedString:\r\n                case InstrumentType.harmonics: {\r\n                    if (type == InstrumentType.pickedString) {\r\n                        instrument.stringSustain = (Math.random() * Config.stringSustainRange) | 0;\r\n                    }\r\n\r\n                    const harmonicGenerators: Function[] = [\r\n                        (): number[] => {\r\n                            const harmonics: number[] = [];\r\n                            for (let i: number = 0; i < Config.harmonicsControlPoints; i++) {\r\n                                harmonics[i] = (Math.random() < 0.4) ? Math.random() : 0.0;\r\n                            }\r\n                            harmonics[(Math.random() * 8) | 0] = Math.pow(Math.random(), 0.25);\r\n                            return harmonics;\r\n                        },\r\n                        (): number[] => {\r\n                            let current: number = 1.0;\r\n                            const harmonics: number[] = [current];\r\n                            for (let i = 1; i < Config.harmonicsControlPoints; i++) {\r\n                                current *= Math.pow(2, Math.random() - 0.55);\r\n                                harmonics[i] = current;\r\n                            }\r\n                            return harmonics;\r\n                        },\r\n                        (): number[] => {\r\n                            let current: number = 1.0;\r\n                            const harmonics: number[] = [current];\r\n                            for (let i = 1; i < Config.harmonicsControlPoints; i++) {\r\n                                current *= Math.pow(2, Math.random() - 0.55);\r\n                                harmonics[i] = current * Math.random();\r\n                            }\r\n                            return harmonics;\r\n                        },\r\n                    ];\r\n                    const generator = harmonicGenerators[(Math.random() * harmonicGenerators.length) | 0];\r\n                    const harmonics: number[] = generator();\r\n                    normalize(harmonics);\r\n                    for (let i: number = 0; i < Config.harmonicsControlPoints; i++) {\r\n                        instrument.harmonicsWave.harmonics[i] = Math.round(harmonics[i]);\r\n                    }\r\n                    instrument.harmonicsWave.markCustomWaveDirty();\r\n                } break;\r\n                case InstrumentType.spectrum: {\r\n                    const spectrum: number[] = [];\r\n                    for (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n                        const isHarmonic: boolean = i == 0 || i == 7 || i == 11 || i == 14 || i == 16 || i == 18 || i == 21;\r\n                        if (isHarmonic) {\r\n                            spectrum[i] = Math.pow(Math.random(), 0.25);\r\n                        } else {\r\n                            spectrum[i] = Math.pow(Math.random(), 3) * 0.5;\r\n                        }\r\n                    }\r\n                    normalize(spectrum);\r\n                    for (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n                        instrument.spectrumWave.spectrum[i] = Math.round(spectrum[i]);\r\n                    }\r\n                    instrument.spectrumWave.markCustomWaveDirty();\r\n                } break;\r\n                case InstrumentType.fm: {\r\n                    instrument.algorithm = (Math.random() * Config.algorithms.length) | 0;\r\n                    instrument.feedbackType = (Math.random() * Config.feedbacks.length) | 0;\r\n                    const algorithm: Algorithm = Config.algorithms[instrument.algorithm];\r\n                    for (let i: number = 0; i < algorithm.carrierCount; i++) {\r\n                        instrument.operators[i].frequency = selectCurvedDistribution(0, Config.operatorFrequencies.length - 1, 0, 3);\r\n                        instrument.operators[i].amplitude = selectCurvedDistribution(0, Config.operatorAmplitudeMax, Config.operatorAmplitudeMax - 1, 2);\r\n                        instrument.operators[i].waveform = Config.operatorWaves.dictionary[selectWeightedRandom([\r\n                            { item: \"sine\", weight: 10 },\r\n                            { item: \"triangle\", weight: 6 },\r\n                            { item: \"sawtooth\", weight: 3 },\r\n                            { item: \"pulse width\", weight: 6 },\r\n                            { item: \"ramp\", weight: 3 },\r\n                            { item: \"trapezoid\", weight: 4 },\r\n                        ])].index;\r\n                        if (instrument.operators[i].waveform == 3/*\"pulse width\"*/) {\r\n                            instrument.operators[i].pulseWidth = selectWeightedRandom([\r\n                                { item: 0, weight: 3 },\r\n                                { item: 1, weight: 5 },\r\n                                { item: 2, weight: 7 },\r\n                                { item: 3, weight: 10 },\r\n                                { item: 4, weight: 15 },\r\n                                { item: 5, weight: 25 }, // 50%\r\n                                { item: 6, weight: 15 },\r\n                                { item: 7, weight: 10 },\r\n                                { item: 8, weight: 7 },\r\n                                { item: 9, weight: 5 },\r\n                                { item: 9, weight: 3 },\r\n                            ]);\r\n                        }\r\n                    }\r\n                    for (let i: number = algorithm.carrierCount; i < Config.operatorCount; i++) {\r\n                        instrument.operators[i].frequency = selectCurvedDistribution(3, Config.operatorFrequencies.length - 1, 0, 3);\r\n                        instrument.operators[i].amplitude = (Math.pow(Math.random(), 2) * Config.operatorAmplitudeMax) | 0;\r\n                        if (instrument.envelopeCount < Config.maxEnvelopeCount && Math.random() < 0.4) {\r\n                            instrument.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"operatorAmplitude\"].index, i, Config.envelopes.dictionary[selectWeightedRandom([\r\n                                { item: \"punch\", weight: 2 },\r\n                                { item: \"flare 1\", weight: 2 },\r\n                                { item: \"flare 2\", weight: 2 },\r\n                                { item: \"flare 3\", weight: 2 },\r\n                                { item: \"twang 1\", weight: 2 },\r\n                                { item: \"twang 2\", weight: 2 },\r\n                                { item: \"twang 3\", weight: 2 },\r\n                                { item: \"swell 1\", weight: 2 },\r\n                                { item: \"swell 2\", weight: 2 },\r\n                                { item: \"swell 3\", weight: 2 },\r\n                                { item: \"tremolo1\", weight: 1 },\r\n                                { item: \"tremolo2\", weight: 1 },\r\n                                { item: \"tremolo3\", weight: 1 },\r\n                                { item: \"tremolo4\", weight: 1 },\r\n                                { item: \"tremolo5\", weight: 1 },\r\n                                { item: \"tremolo6\", weight: 1 },\r\n                                { item: \"decay 1\", weight: 1 },\r\n                                { item: \"decay 2\", weight: 1 },\r\n                                { item: \"decay 3\", weight: 1 },\r\n                            ])].index);\r\n                            instrument.operators[i].waveform = Config.operatorWaves.dictionary[selectWeightedRandom([\r\n                                { item: \"sine\", weight: 10 },\r\n                                { item: \"triangle\", weight: 6 },\r\n                                { item: \"sawtooth\", weight: 3 },\r\n                                { item: \"pulse width\", weight: 6 },\r\n                                { item: \"ramp\", weight: 3 },\r\n                                { item: \"trapezoid\", weight: 4 },\r\n                            ])].index;\r\n                            if (instrument.operators[i].waveform == 3) {\r\n                                instrument.operators[i].pulseWidth = selectWeightedRandom([\r\n                                    { item: 0, weight: 3 },\r\n                                    { item: 1, weight: 5 },\r\n                                    { item: 2, weight: 7 },\r\n                                    { item: 3, weight: 10 },\r\n                                    { item: 4, weight: 15 },\r\n                                    { item: 5, weight: 25 }, // 50%\r\n                                    { item: 6, weight: 15 },\r\n                                    { item: 7, weight: 10 },\r\n                                    { item: 8, weight: 7 },\r\n                                    { item: 9, weight: 5 },\r\n                                    { item: 9, weight: 3 },\r\n                                ]);\r\n                            }\r\n                        }\r\n                        if (instrument.envelopeCount < Config.maxEnvelopeCount && Math.random() < 0.05) {\r\n                            instrument.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"operatorFrequency\"].index, i, Config.envelopes.dictionary[selectWeightedRandom([\r\n                                { item: \"punch\", weight: 4 },\r\n                                { item: \"flare 1\", weight: 4 },\r\n                                { item: \"flare 2\", weight: 2 },\r\n                                { item: \"flare 3\", weight: 1 },\r\n                                { item: \"twang 1\", weight: 16 },\r\n                                { item: \"twang 2\", weight: 2 },\r\n                                { item: \"twang 3\", weight: 1 },\r\n                                { item: \"swell 1\", weight: 4 },\r\n                                { item: \"swell 2\", weight: 2 },\r\n                                { item: \"swell 3\", weight: 1 },\r\n                                { item: \"decay 1\", weight: 2 },\r\n                                { item: \"decay 2\", weight: 1 },\r\n                                { item: \"decay 3\", weight: 1 },\r\n                            ])].index);\r\n                        }\r\n                    }\r\n                    instrument.feedbackAmplitude = (Math.pow(Math.random(), 3) * Config.operatorAmplitudeMax) | 0;\r\n                    if (instrument.envelopeCount < Config.maxEnvelopeCount && Math.random() < 0.4) {\r\n                        instrument.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"feedbackAmplitude\"].index, 0, Config.envelopes.dictionary[selectWeightedRandom([\r\n                            { item: \"punch\", weight: 2 },\r\n                            { item: \"flare 1\", weight: 2 },\r\n                            { item: \"flare 2\", weight: 2 },\r\n                            { item: \"flare 3\", weight: 2 },\r\n                            { item: \"twang 1\", weight: 2 },\r\n                            { item: \"twang 2\", weight: 2 },\r\n                            { item: \"twang 3\", weight: 2 },\r\n                            { item: \"swell 1\", weight: 2 },\r\n                            { item: \"swell 2\", weight: 2 },\r\n                            { item: \"swell 3\", weight: 2 },\r\n                            { item: \"tremolo1\", weight: 1 },\r\n                            { item: \"tremolo2\", weight: 1 },\r\n                            { item: \"tremolo3\", weight: 1 },\r\n                            { item: \"tremolo4\", weight: 1 },\r\n                            { item: \"tremolo5\", weight: 1 },\r\n                            { item: \"tremolo6\", weight: 1 },\r\n                            { item: \"decay 1\", weight: 1 },\r\n                            { item: \"decay 2\", weight: 1 },\r\n                            { item: \"decay 3\", weight: 1 },\r\n                        ])].index);\r\n                    }\r\n                } break;\r\n                default: throw new Error(\"Unhandled pitched instrument type in random generator.\");\r\n            }\r\n        }\r\n\r\n        doc.notifier.changed();\r\n        this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeTransition extends Change {\r\n    constructor(doc: SongDocument, newValue: number) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        const oldValue: number = instrument.transition;\r\n        if (oldValue != newValue) {\r\n            this._didSomething();\r\n            instrument.transition = newValue;\r\n            instrument.preset = instrument.type;\r\n            doc.notifier.changed();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeToggleEffects extends Change {\r\n    constructor(doc: SongDocument, toggleFlag: number, useInstrument: Instrument | null) {\r\n        super();\r\n        let instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        if (useInstrument != null)\r\n            instrument = useInstrument;\r\n        const oldValue: number = instrument.effects;\r\n        const wasSelected: boolean = ((oldValue & (1 << toggleFlag)) != 0);\r\n        const newValue: number = wasSelected ? (oldValue & (~(1 << toggleFlag))) : (oldValue | (1 << toggleFlag));\r\n        instrument.effects = newValue;\r\n        // As a special case, toggling the panning effect doesn't remove the preset.\r\n        if (toggleFlag != EffectType.panning) instrument.preset = instrument.type;\r\n        if (wasSelected) instrument.clearInvalidEnvelopeTargets();\r\n        this._didSomething();\r\n        doc.notifier.changed();\r\n    }\r\n}\r\n\r\n\r\nexport class ChangePatternNumbers extends Change {\r\n    constructor(doc: SongDocument, value: number, startBar: number, startChannel: number, width: number, height: number) {\r\n        super();\r\n        if (value > doc.song.patternsPerChannel) throw new Error(\"invalid pattern\");\r\n\r\n        for (let bar: number = startBar; bar < startBar + width; bar++) {\r\n            for (let channelIndex: number = startChannel; channelIndex < startChannel + height; channelIndex++) {\r\n                if (doc.song.channels[channelIndex].bars[bar] != value) {\r\n                    doc.song.channels[channelIndex].bars[bar] = value;\r\n                    this._didSomething();\r\n                }\r\n            }\r\n        }\r\n\r\n        //Make mod channels shift viewed instrument over when pattern numbers change\r\n        if (startChannel >= doc.song.pitchChannelCount + doc.song.noiseChannelCount) {\r\n            const pattern: Pattern | null = doc.getCurrentPattern();\r\n            if (pattern != null) {\r\n                doc.viewedInstrument[startChannel] = pattern.instruments[0];\r\n            }\r\n            else {\r\n                doc.viewedInstrument[startChannel] = 0;\r\n            }\r\n        }\r\n\r\n        doc.notifier.changed();\r\n    }\r\n}\r\n\r\nexport class ChangeBarCount extends Change {\r\n    constructor(doc: SongDocument, newValue: number, atBeginning: boolean) {\r\n        super();\r\n        if (doc.song.barCount != newValue) {\r\n            for (const channel of doc.song.channels) {\r\n                if (atBeginning) {\r\n                    while (channel.bars.length < newValue) {\r\n                        channel.bars.unshift(0);\r\n                    }\r\n                    if (doc.song.barCount > newValue) {\r\n                        channel.bars.splice(0, doc.song.barCount - newValue);\r\n                    }\r\n                } else {\r\n                    while (channel.bars.length < newValue) {\r\n                        channel.bars.push(0);\r\n                    }\r\n                    channel.bars.length = newValue;\r\n                }\r\n            }\r\n\r\n            if (atBeginning) {\r\n                const diff: number = newValue - doc.song.barCount;\r\n                doc.bar = Math.max(0, doc.bar + diff);\r\n                if (diff < 0 || doc.barScrollPos > 0) {\r\n                    doc.barScrollPos = Math.max(0, doc.barScrollPos + diff);\r\n                }\r\n                doc.song.loopStart = Math.max(0, doc.song.loopStart + diff);\r\n            }\r\n            doc.bar = Math.min(doc.bar, newValue - 1);\r\n            doc.song.loopLength = Math.min(newValue, doc.song.loopLength);\r\n            doc.song.loopStart = Math.min(newValue - doc.song.loopLength, doc.song.loopStart);\r\n            doc.song.barCount = newValue;\r\n            doc.notifier.changed();\r\n\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeInsertBars extends Change {\r\n    constructor(doc: SongDocument, start: number, count: number) {\r\n        super();\r\n\r\n        const newLength: number = Math.min(Config.barCountMax, doc.song.barCount + count);\r\n        count = newLength - doc.song.barCount;\r\n        if (count == 0) return;\r\n\r\n        for (const channel of doc.song.channels) {\r\n            while (channel.bars.length < newLength) {\r\n                channel.bars.splice(start, 0, 0);\r\n            }\r\n        }\r\n        doc.song.barCount = newLength;\r\n\r\n        doc.bar += count;\r\n        doc.barScrollPos += count;\r\n        if (doc.song.loopStart >= start) {\r\n            doc.song.loopStart += count;\r\n        } else if (doc.song.loopStart + doc.song.loopLength >= start) {\r\n            doc.song.loopLength += count;\r\n        }\r\n\r\n        doc.notifier.changed();\r\n        this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeDeleteBars extends Change {\r\n    constructor(doc: SongDocument, start: number, count: number) {\r\n        super();\r\n\r\n        for (const channel of doc.song.channels) {\r\n            channel.bars.splice(start, count);\r\n            if (channel.bars.length == 0) channel.bars.push(0);\r\n        }\r\n        doc.song.barCount = Math.max(1, doc.song.barCount - count);\r\n\r\n        doc.bar = Math.max(0, doc.bar - count);\r\n\r\n        doc.barScrollPos = Math.max(0, doc.barScrollPos - count);\r\n        if (doc.song.loopStart >= start) {\r\n            doc.song.loopStart = Math.max(0, doc.song.loopStart - count);\r\n        } else if (doc.song.loopStart + doc.song.loopLength > start) {\r\n            doc.song.loopLength -= count;\r\n        }\r\n        doc.song.loopLength = Math.max(1, Math.min(doc.song.barCount - doc.song.loopStart, doc.song.loopLength));\r\n\r\n        doc.notifier.changed();\r\n        this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeLimiterSettings extends Change {\r\n    constructor(doc: SongDocument, limitRatio: number, compressionRatio: number, limitThreshold: number, compressionThreshold: number, limitRise: number, limitDecay: number, masterGain: number) {\r\n        super();\r\n\r\n        // This check causes issues with the state change handler because it gets superceded by whenupdated when the limiter prompt closes for some reason, causing the state to revert. I think it's because the notifier change needs to happen right as the prompt closes.\r\n        //if (limitRatio != doc.song.limitRatio || compressionRatio != doc.song.compressionRatio || limitThreshold != doc.song.limitThreshold || compressionThreshold != doc.song.compressionThreshold || limitRise != doc.song.limitRise || limitDecay != doc.song.limitDecay) {\r\n\r\n        doc.song.limitRatio = limitRatio;\r\n        doc.song.compressionRatio = compressionRatio;\r\n        doc.song.limitThreshold = limitThreshold;\r\n        doc.song.compressionThreshold = compressionThreshold;\r\n        doc.song.limitRise = limitRise;\r\n        doc.song.limitDecay = limitDecay;\r\n        doc.song.masterGain = masterGain;\r\n\r\n        doc.notifier.changed();\r\n        this._didSomething();\r\n        //}\r\n    }\r\n}\r\n\r\nexport class ChangeChannelOrder extends Change {\r\n    constructor(doc: SongDocument, selectionMin: number, selectionMax: number, offset: number) {\r\n        super();\r\n        // Change the order of two channels by swapping.\r\n        doc.song.channels.splice(selectionMin + offset, 0, ...doc.song.channels.splice(selectionMin, selectionMax - selectionMin + 1));\r\n\r\n        // Update mods for each channel\r\n        selectionMax = Math.max(selectionMax, selectionMin);\r\n        for (let channelIndex: number = doc.song.pitchChannelCount + doc.song.noiseChannelCount; channelIndex < doc.song.getChannelCount(); channelIndex++) {\r\n            for (let instrumentIdx: number = 0; instrumentIdx < doc.song.channels[channelIndex].instruments.length; instrumentIdx++) {\r\n                let instrument: Instrument = doc.song.channels[channelIndex].instruments[instrumentIdx];\r\n                for (let i: number = 0; i < Config.modCount; i++) {\r\n                    if (instrument.modChannels[i] >= selectionMin && instrument.modChannels[i] <= selectionMax) {\r\n                        instrument.modChannels[i] += offset;\r\n                    }\r\n                    else if (instrument.modChannels[i] >= selectionMin + offset && instrument.modChannels[i] <= selectionMax + offset) {\r\n                        instrument.modChannels[i] -= offset * (selectionMax - selectionMin + 1);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        doc.notifier.changed();\r\n        this._didSomething();\r\n\r\n    }\r\n}\r\n\r\nexport class ChangeChannelCount extends Change {\r\n    constructor(doc: SongDocument, newPitchChannelCount: number, newNoiseChannelCount: number, newModChannelCount: number) {\r\n        super();\r\n        if (doc.song.pitchChannelCount != newPitchChannelCount || doc.song.noiseChannelCount != newNoiseChannelCount || doc.song.modChannelCount != newModChannelCount) {\r\n            const newChannels: Channel[] = [];\r\n\r\n            function changeGroup(newCount: number, oldCount: number, newStart: number, oldStart: number, octave: number, isNoise: boolean, isMod: boolean): void {\r\n                for (let i: number = 0; i < newCount; i++) {\r\n                    const channelIndex = i + newStart;\r\n                    const oldChannel = i + oldStart;\r\n                    if (i < oldCount) {\r\n                        newChannels[channelIndex] = doc.song.channels[oldChannel];\r\n                    } else {\r\n                        newChannels[channelIndex] = new Channel();\r\n                        newChannels[channelIndex].octave = octave;\r\n                        for (let j: number = 0; j < Config.instrumentCountMin; j++) {\r\n                            const instrument: Instrument = new Instrument(isNoise, isMod);\r\n                            if (!isMod) {\r\n                                const presetValue: number = pickRandomPresetValue(isNoise);\r\n                                const preset: Preset = EditorConfig.valueToPreset(presetValue)!;\r\n                                instrument.fromJsonObject(preset.settings, isNoise, isMod, doc.song.rhythm == 0 || doc.song.rhythm == 2, doc.song.rhythm >= 2);\r\n                                instrument.preset = presetValue;\r\n                            }\r\n                            newChannels[channelIndex].instruments[j] = instrument;\r\n                        }\r\n                        for (let j: number = 0; j < doc.song.patternsPerChannel; j++) {\r\n                            newChannels[channelIndex].patterns[j] = new Pattern();\r\n                        }\r\n                        for (let j: number = 0; j < doc.song.barCount; j++) {\r\n                            newChannels[channelIndex].bars[j] = 0;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            changeGroup(newPitchChannelCount, doc.song.pitchChannelCount, 0, 0, 3, false, false);\r\n            changeGroup(newNoiseChannelCount, doc.song.noiseChannelCount, newPitchChannelCount, doc.song.pitchChannelCount, 0, true, false);\r\n            changeGroup(newModChannelCount, doc.song.modChannelCount, newNoiseChannelCount + newPitchChannelCount, doc.song.pitchChannelCount + doc.song.noiseChannelCount, 0, false, true);\r\n\r\n            let oldPitchCount: number = doc.song.pitchChannelCount;\r\n            doc.song.pitchChannelCount = newPitchChannelCount;\r\n            doc.song.noiseChannelCount = newNoiseChannelCount;\r\n            doc.song.modChannelCount = newModChannelCount;\r\n\r\n            for (let channelIndex: number = 0; channelIndex < doc.song.getChannelCount(); channelIndex++) {\r\n                doc.song.channels[channelIndex] = newChannels[channelIndex];\r\n            }\r\n            doc.song.channels.length = doc.song.getChannelCount();\r\n\r\n            doc.channel = Math.min(doc.channel, newPitchChannelCount + newNoiseChannelCount + newModChannelCount - 1);\r\n\r\n            // Determine if any mod instruments now refer to an invalid channel. Unset them if so\r\n            for (let channelIndex: number = doc.song.pitchChannelCount + doc.song.noiseChannelCount; channelIndex < doc.song.getChannelCount(); channelIndex++) {\r\n                for (let instrumentIdx: number = 0; instrumentIdx < doc.song.channels[channelIndex].instruments.length; instrumentIdx++) {\r\n                    for (let mod: number = 0; mod < Config.modCount; mod++) {\r\n\r\n                        let instrument: Instrument = doc.song.channels[channelIndex].instruments[instrumentIdx];\r\n                        let modChannel: number = instrument.modChannels[mod];\r\n\r\n                        // Boundary checking\r\n                        if ((modChannel >= doc.song.pitchChannelCount && modChannel < oldPitchCount) || modChannel >= doc.song.pitchChannelCount + doc.song.noiseChannelCount) {\r\n                            instrument.modulators[mod] = Config.modulators.dictionary[\"none\"].index;\r\n                        }\r\n\r\n                        // Bump indices - new pitch channel added, bump all noise mods.\r\n                        if (modChannel >= oldPitchCount && oldPitchCount < newPitchChannelCount) {\r\n                            instrument.modChannels[mod] += newPitchChannelCount - oldPitchCount;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            doc.notifier.changed();\r\n\r\n            ColorConfig.resetColors();\r\n\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeAddChannel extends ChangeGroup {\r\n\tconstructor(doc: SongDocument, index: number, isNoise: boolean, isMod: boolean) {\r\n\t\tsuper();\r\n\t\tconst newPitchChannelCount: number = doc.song.pitchChannelCount + (isNoise || isMod ? 0 : 1);\r\n        const newNoiseChannelCount: number = doc.song.noiseChannelCount + (!isNoise || isMod ? 0 : 1);\r\n        const newModChannelCount: number = doc.song.modChannelCount + (isNoise || !isMod ? 0 : 1);\r\n\r\n        if (newPitchChannelCount <= Config.pitchChannelCountMax && newNoiseChannelCount <= Config.noiseChannelCountMax && newModChannelCount <= Config.modChannelCountMax) {\r\n            const addedChannelIndex: number = isNoise ? doc.song.pitchChannelCount + doc.song.noiseChannelCount : doc.song.pitchChannelCount;\r\n            this.append(new ChangeChannelCount(doc, newPitchChannelCount, newNoiseChannelCount, newModChannelCount));\r\n            if (addedChannelIndex - 1 >= index) {\r\n                this.append(new ChangeChannelOrder(doc, index, addedChannelIndex - 1, 1));\r\n            }\r\n\r\n            doc.synth.computeLatestModValues();\r\n            doc.recalcChannelNames = true;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeRemoveChannel extends ChangeGroup {\r\n\tconstructor(doc: SongDocument, minIndex: number, maxIndex: number) {\r\n        super();\r\n\r\n        const oldMax: number = maxIndex;\r\n\r\n        // Update modulators - if a higher index was removed, shift down\r\n        for (let modChannel: number = doc.song.pitchChannelCount + doc.song.noiseChannelCount; modChannel < doc.song.channels.length; modChannel++) {\r\n            for (let instrumentIndex: number = 0; instrumentIndex < doc.song.channels[modChannel].instruments.length; instrumentIndex++) {\r\n                const modInstrument: Instrument = doc.song.channels[modChannel].instruments[instrumentIndex];\r\n                for (let mod: number = 0; mod < Config.modCount; mod++) {\r\n                    if (modInstrument.modChannels[mod] >= minIndex && modInstrument.modChannels[mod] <= oldMax) {\r\n                        this.append(new ChangeModChannel(doc, mod, 0, modInstrument));\r\n                    }\r\n                    else if (modInstrument.modChannels[mod] > oldMax) {\r\n                        this.append(new ChangeModChannel(doc, mod, modInstrument.modChannels[mod] - (oldMax - minIndex + 1) + 2, modInstrument));\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n\t\twhile (maxIndex >= minIndex) {\r\n            const isNoise: boolean = doc.song.getChannelIsNoise(maxIndex);\r\n            const isMod: boolean = doc.song.getChannelIsMod(maxIndex);\r\n\t\t\tdoc.song.channels.splice(maxIndex, 1);\r\n            if (isNoise) {\r\n                doc.song.noiseChannelCount--;\r\n            } else if (isMod) {\r\n                doc.song.modChannelCount--;\r\n            } else {\r\n\t\t\t\tdoc.song.pitchChannelCount--;\r\n\t\t\t}\r\n            maxIndex--;\r\n\t\t}\r\n\t\t\r\n        if (doc.song.pitchChannelCount < Config.pitchChannelCountMin) {\r\n            this.append(new ChangeChannelCount(doc, Config.pitchChannelCountMin, doc.song.noiseChannelCount, doc.song.modChannelCount));\r\n        }\r\n\r\n        ColorConfig.resetColors();\r\n        doc.recalcChannelNames = true;\r\n\r\n\t\tthis.append(new ChangeChannelBar(doc, Math.max(0, minIndex - 1), doc.bar));\r\n\r\n        doc.synth.computeLatestModValues();\r\n\r\n\t\tthis._didSomething();\r\n\t\tdoc.notifier.changed();\r\n\t}\r\n}\r\n\r\nexport class ChangeChannelBar extends Change {\r\n    constructor(doc: SongDocument, newChannel: number, newBar: number, silently: boolean = false) {\r\n        super();\r\n        const oldChannel: number = doc.channel;\r\n        const oldBar: number = doc.bar;\r\n        doc.channel = newChannel;\r\n        doc.bar = newBar;\r\n        if (!silently) {\r\n            doc.selection.scrollToSelectedPattern();\r\n        }\r\n        // Mod channels always jump to viewing the active instrument for the mod.\r\n        if (doc.song.getChannelIsMod(doc.channel)) {\r\n            const pattern: Pattern | null = doc.song!.getPattern(doc.channel, doc.bar);\r\n            if (pattern != null)\r\n                doc.viewedInstrument[doc.channel] = pattern.instruments[0];\r\n        }\r\n        doc.notifier.changed();\r\n        if (oldChannel != newChannel || oldBar != newBar) {\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeUnison extends Change {\r\n    constructor(doc: SongDocument, newValue: number) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        const oldValue: number = instrument.unison;\r\n        if (oldValue != newValue) {\r\n            this._didSomething();\r\n            instrument.unison = newValue;\r\n            instrument.preset = instrument.type;\r\n            doc.notifier.changed();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeChord extends Change {\r\n    constructor(doc: SongDocument, newValue: number) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        const oldValue: number = instrument.chord;\r\n        if (oldValue != newValue) {\r\n            this._didSomething();\r\n            instrument.chord = newValue;\r\n            instrument.preset = instrument.type;\r\n            doc.notifier.changed();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeVibrato extends Change {\r\n    constructor(doc: SongDocument, newValue: number) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        const oldValue: number = instrument.vibrato;\r\n        if (oldValue != newValue) {\r\n            instrument.vibrato = newValue;\r\n            instrument.vibratoDepth = Config.vibratos[instrument.vibrato].amplitude;\r\n            instrument.vibratoDelay = Config.vibratos[instrument.vibrato].delayTicks / 2;\r\n            instrument.vibratoSpeed = 10; // default\r\n            instrument.vibratoType = Config.vibratos[instrument.vibrato].type;\r\n            instrument.preset = instrument.type;\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeVibratoDepth extends Change {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        let prevVibrato: number = instrument.vibrato;\r\n        doc.synth.unsetMod(Config.modulators.dictionary[\"vibrato depth\"].index, doc.channel, doc.getCurrentInstrument());\r\n\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue || prevVibrato != Config.vibratos.length) {\r\n            instrument.vibratoDepth = newValue / 25;\r\n            instrument.vibrato = Config.vibratos.length; // Custom\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeVibratoSpeed extends Change {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        let prevVibrato: number = instrument.vibrato;\r\n        doc.synth.unsetMod(Config.modulators.dictionary[\"vibrato speed\"].index, doc.channel, doc.getCurrentInstrument());\r\n\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue || prevVibrato != Config.vibratos.length) {\r\n            instrument.vibratoSpeed = newValue;\r\n            instrument.vibrato = Config.vibratos.length; // Custom\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeVibratoDelay extends Change {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        let prevVibrato: number = instrument.vibrato;\r\n        doc.synth.unsetMod(Config.modulators.dictionary[\"vibrato delay\"].index, doc.channel, doc.getCurrentInstrument());\r\n\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue || prevVibrato != Config.vibratos.length) {\r\n            instrument.vibratoDelay = newValue;\r\n            instrument.vibrato = Config.vibratos.length; // Custom\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeVibratoType extends Change {\r\n    constructor(doc: SongDocument, newValue: number) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        const oldValue: number = instrument.vibratoType;\r\n        let prevVibrato: number = instrument.vibrato;\r\n\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue || prevVibrato != Config.vibratos.length) {\r\n            instrument.vibratoType = newValue;\r\n            instrument.vibrato = Config.vibratos.length; // Custom\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeArpeggioSpeed extends Change {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        instrument.arpeggioSpeed = newValue;\r\n        doc.synth.unsetMod(Config.modulators.dictionary[\"arp speed\"].index, doc.channel, doc.getCurrentInstrument());\r\n\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeFastTwoNoteArp extends Change {\r\n    constructor(doc: SongDocument, newValue: boolean) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        const oldValue = instrument.fastTwoNoteArp;\r\n\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) {\r\n            instrument.fastTwoNoteArp = newValue;\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeClicklessTransition extends Change {\r\n    constructor(doc: SongDocument, newValue: boolean) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        const oldValue = instrument.clicklessTransition;\r\n\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) {\r\n            instrument.clicklessTransition = newValue;\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeAliasing extends Change {\r\n    constructor(doc: SongDocument, newValue: boolean) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        const oldValue = instrument.aliases;\r\n\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) {\r\n            instrument.aliases = newValue;\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeSpectrum extends Change {\r\n    constructor(doc: SongDocument, instrument: Instrument, spectrumWave: SpectrumWave) {\r\n        super();\r\n        spectrumWave.markCustomWaveDirty();\r\n        instrument.preset = instrument.type;\r\n        doc.notifier.changed();\r\n        this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeHarmonics extends Change {\r\n    constructor(doc: SongDocument, instrument: Instrument, harmonicsWave: HarmonicsWave) {\r\n        super();\r\n        harmonicsWave.markCustomWaveDirty();\r\n        instrument.preset = instrument.type;\r\n        doc.notifier.changed();\r\n        this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeDrumsetEnvelope extends Change {\r\n    constructor(doc: SongDocument, drumIndex: number, newValue: number) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        const oldValue: number = instrument.drumsetEnvelopes[drumIndex];\r\n        if (oldValue != newValue) {\r\n            instrument.drumsetEnvelopes[drumIndex] = newValue;\r\n            instrument.preset = instrument.type;\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nclass ChangeInstrumentSlider extends Change {\r\n    protected _instrument: Instrument;\r\n    constructor(private _doc: SongDocument) {\r\n        super();\r\n        this._instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n    }\r\n\r\n    public commit(): void {\r\n        if (!this.isNoop()) {\r\n            this._instrument.preset = this._instrument.type;\r\n            this._doc.notifier.changed();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangePulseWidth extends ChangeInstrumentSlider {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super(doc);\r\n        this._instrument.pulseWidth = newValue;\r\n        doc.synth.unsetMod(Config.modulators.dictionary[\"pulse width\"].index, doc.channel, doc.getCurrentInstrument());\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangePitchShift extends ChangeInstrumentSlider {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super(doc);\r\n        this._instrument.pitchShift = newValue;\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeDetune extends ChangeInstrumentSlider {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super(doc);\r\n        this._instrument.detune = newValue + Config.detuneCenter;\r\n        doc.notifier.changed();\r\n        doc.synth.unsetMod(Config.modulators.dictionary[\"detune\"].index, doc.channel, doc.getCurrentInstrument());\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeDistortion extends ChangeInstrumentSlider {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super(doc);\r\n        this._instrument.distortion = newValue;\r\n        doc.notifier.changed();\r\n        doc.synth.unsetMod(Config.modulators.dictionary[\"distortion\"].index, doc.channel, doc.getCurrentInstrument());\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeBitcrusherFreq extends ChangeInstrumentSlider {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super(doc);\r\n        this._instrument.bitcrusherFreq = newValue;\r\n        //doc.synth.unsetMod(Config.modulators.dictionary[\"bit crush\"].index, doc.channel, doc.getCurrentInstrument());\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeBitcrusherQuantization extends ChangeInstrumentSlider {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super(doc);\r\n        //doc.synth.unsetMod(Config.modulators.dictionary[\"freq crush\"].index, doc.channel, doc.getCurrentInstrument());\r\n        this._instrument.bitcrusherQuantization = newValue;\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeStringSustain extends ChangeInstrumentSlider {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super(doc);\r\n        this._instrument.stringSustain = newValue;\r\n        doc.synth.unsetMod(Config.modulators.dictionary[\"sustain\"].index, doc.channel, doc.getCurrentInstrument());\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeEQFilterType extends Change {\r\n    constructor(doc: SongDocument, instrument: Instrument, newValue: boolean) {\r\n        super();\r\n        instrument.eqFilterType = newValue;\r\n        if (newValue == true) { // To Simple - clear eq filter\r\n            instrument.eqFilter.reset();\r\n            instrument.tmpEqFilterStart = instrument.eqFilter;\r\n            instrument.tmpEqFilterEnd = null;\r\n        }\r\n        else {\r\n            // To Advanced - convert filter\r\n            instrument.eqFilter.convertLegacySettings(instrument.eqFilterSimpleCut, instrument.eqFilterSimplePeak, Config.envelopes.dictionary[\"none\"]);\r\n            instrument.tmpEqFilterStart = instrument.eqFilter;\r\n            instrument.tmpEqFilterEnd = null;\r\n        }\r\n        instrument.clearInvalidEnvelopeTargets();\r\n        doc.notifier.changed();\r\n        this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeNoteFilterType extends Change {\r\n    constructor(doc: SongDocument, instrument: Instrument, newValue: boolean) {\r\n        super();\r\n        instrument.noteFilterType = newValue;\r\n        if (newValue == true) { // To Simple - clear note filter, kill modulators\r\n            instrument.noteFilter.reset();\r\n            instrument.tmpNoteFilterStart = instrument.noteFilter;\r\n            instrument.tmpNoteFilterEnd = null;\r\n        }\r\n        else {\r\n            // To Advanced - convert filter, kill modulators\r\n            instrument.noteFilter.convertLegacySettings(instrument.noteFilterSimpleCut, instrument.noteFilterSimplePeak, Config.envelopes.dictionary[\"none\"]);\r\n            instrument.tmpNoteFilterStart = instrument.noteFilter;\r\n            instrument.tmpNoteFilterEnd = null;\r\n        }\r\n        instrument.clearInvalidEnvelopeTargets();\r\n        doc.notifier.changed();\r\n        this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeEQFilterSimpleCut extends ChangeInstrumentSlider {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super(doc);\r\n        this._instrument.eqFilterSimpleCut = newValue;\r\n        doc.synth.unsetMod(Config.modulators.dictionary[\"eq filt cut\"].index, doc.channel, doc.getCurrentInstrument());\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeEQFilterSimplePeak extends ChangeInstrumentSlider {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super(doc);\r\n        this._instrument.eqFilterSimplePeak = newValue;\r\n        doc.synth.unsetMod(Config.modulators.dictionary[\"eq filt peak\"].index, doc.channel, doc.getCurrentInstrument());\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeNoteFilterSimpleCut extends ChangeInstrumentSlider {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super(doc);\r\n        this._instrument.noteFilterSimpleCut = newValue;\r\n        doc.synth.unsetMod(Config.modulators.dictionary[\"note filt cut\"].index, doc.channel, doc.getCurrentInstrument());\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeNoteFilterSimplePeak extends ChangeInstrumentSlider {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super(doc);\r\n        this._instrument.noteFilterSimplePeak = newValue;\r\n        doc.synth.unsetMod(Config.modulators.dictionary[\"note filt peak\"].index, doc.channel, doc.getCurrentInstrument());\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeFilterAddPoint extends UndoableChange {\r\n    private _doc: SongDocument;\r\n    private _instrument: Instrument;\r\n    private _instrumentPrevPreset: number;\r\n    private _instrumentNextPreset: number;\r\n    private _filterSettings: FilterSettings;\r\n    private _point: FilterControlPoint;\r\n    private _index: number;\r\n    private _envelopeTargetsAdd: number[] = [];\r\n    private _envelopeIndicesAdd: number[] = [];\r\n    private _envelopeTargetsRemove: number[] = [];\r\n    private _envelopeIndicesRemove: number[] = [];\r\n    constructor(doc: SongDocument, filterSettings: FilterSettings, point: FilterControlPoint, index: number, isNoteFilter: boolean, deletion: boolean = false) {\r\n        super(deletion);\r\n        this._doc = doc;\r\n        this._instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n        this._instrumentNextPreset = deletion ? this._instrument.preset : this._instrument.type;\r\n        this._instrumentPrevPreset = deletion ? this._instrument.type : this._instrument.preset;\r\n        this._filterSettings = filterSettings;\r\n        this._point = point;\r\n        this._index = index;\r\n\r\n        for (let envelopeIndex: number = 0; envelopeIndex < this._instrument.envelopeCount; envelopeIndex++) {\r\n            let target: number = this._instrument.envelopes[envelopeIndex].target;\r\n            let targetIndex: number = this._instrument.envelopes[envelopeIndex].index;\r\n            this._envelopeTargetsAdd.push(target);\r\n            this._envelopeIndicesAdd.push(targetIndex);\r\n            if (deletion) {\r\n                // When deleting a filter control point, find all envelopes that targeted that\r\n                // point and clear them, and all envelopes that targeted later points and\r\n                // decrement those to keep them in sync with the new list of points.\r\n                const automationTarget: AutomationTarget = Config.instrumentAutomationTargets[target];\r\n                if (automationTarget.isFilter && (automationTarget.effect == EffectType.noteFilter) == isNoteFilter) {\r\n                    if (automationTarget.maxCount == Config.filterMaxPoints) {\r\n                        if (targetIndex == index) {\r\n                            target = Config.instrumentAutomationTargets.dictionary[\"none\"].index;\r\n                            targetIndex = 0;\r\n                        } else if (targetIndex > index) {\r\n                            targetIndex--;\r\n                        }\r\n                    } else {\r\n                        if (filterSettings.controlPointCount <= 1) {\r\n                            target = Config.instrumentAutomationTargets.dictionary[\"none\"].index;\r\n                            targetIndex = 0;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            this._envelopeTargetsRemove.push(target);\r\n            this._envelopeIndicesRemove.push(targetIndex);\r\n        }\r\n\r\n        this._didSomething();\r\n        this.redo();\r\n    }\r\n\r\n    protected _doForwards(): void {\r\n        this._filterSettings.controlPoints.splice(this._index, 0, this._point);\r\n        this._filterSettings.controlPointCount++;\r\n        this._filterSettings.controlPoints.length = this._filterSettings.controlPointCount;\r\n        this._instrument.preset = this._instrumentNextPreset;\r\n        for (let envelopeIndex: number = 0; envelopeIndex < this._instrument.envelopeCount; envelopeIndex++) {\r\n            this._instrument.envelopes[envelopeIndex].target = this._envelopeTargetsAdd[envelopeIndex];\r\n            this._instrument.envelopes[envelopeIndex].index = this._envelopeIndicesAdd[envelopeIndex];\r\n        }\r\n        this._instrument.tmpEqFilterStart = this._instrument.eqFilter;\r\n        this._instrument.tmpEqFilterEnd = null;\r\n        this._instrument.tmpNoteFilterStart = this._instrument.noteFilter;\r\n        this._instrument.tmpNoteFilterEnd = null;\r\n        this._doc.notifier.changed();\r\n    }\r\n\r\n    protected _doBackwards(): void {\r\n        this._filterSettings.controlPoints.splice(this._index, 1);\r\n        this._filterSettings.controlPointCount--;\r\n        this._filterSettings.controlPoints.length = this._filterSettings.controlPointCount;\r\n        this._instrument.preset = this._instrumentPrevPreset;\r\n        for (let envelopeIndex: number = 0; envelopeIndex < this._instrument.envelopeCount; envelopeIndex++) {\r\n            this._instrument.envelopes[envelopeIndex].target = this._envelopeTargetsRemove[envelopeIndex];\r\n            this._instrument.envelopes[envelopeIndex].index = this._envelopeIndicesRemove[envelopeIndex];\r\n        }\r\n        this._instrument.tmpEqFilterStart = this._instrument.eqFilter;\r\n        this._instrument.tmpEqFilterEnd = null;\r\n        this._instrument.tmpNoteFilterStart = this._instrument.noteFilter;\r\n        this._instrument.tmpNoteFilterEnd = null;\r\n        this._doc.notifier.changed();\r\n    }\r\n}\r\n\r\nexport class ChangeFilterMovePoint extends UndoableChange {\r\n    private _doc: SongDocument;\r\n    private _instrument: Instrument;\r\n    private _instrumentPrevPreset: number;\r\n    private _instrumentNextPreset: number;\r\n    private _point: FilterControlPoint;\r\n    private _oldFreq: number;\r\n    private _newFreq: number;\r\n    private _oldGain: number;\r\n    private _newGain: number;\r\n    constructor(doc: SongDocument, point: FilterControlPoint, oldFreq: number, newFreq: number, oldGain: number, newGain: number) {\r\n        super(false);\r\n        this._doc = doc;\r\n        this._instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n        this._instrumentNextPreset = this._instrument.type;\r\n        this._instrumentPrevPreset = this._instrument.preset;\r\n        this._point = point;\r\n        this._oldFreq = oldFreq;\r\n        this._newFreq = newFreq;\r\n        this._oldGain = oldGain;\r\n        this._newGain = newGain;\r\n        this._didSomething();\r\n        this.redo();\r\n    }\r\n\r\n    protected _doForwards(): void {\r\n        this._point.freq = this._newFreq;\r\n        this._point.gain = this._newGain;\r\n        this._instrument.preset = this._instrumentNextPreset;\r\n        this._instrument.tmpEqFilterStart = this._instrument.eqFilter;\r\n        this._instrument.tmpEqFilterEnd = null;\r\n        this._instrument.tmpNoteFilterStart = this._instrument.noteFilter;\r\n        this._instrument.tmpNoteFilterEnd = null;\r\n        this._doc.notifier.changed();\r\n    }\r\n\r\n    protected _doBackwards(): void {\r\n        this._point.freq = this._oldFreq;\r\n        this._point.gain = this._oldGain;\r\n        this._instrument.preset = this._instrumentPrevPreset;\r\n        this._instrument.tmpEqFilterStart = this._instrument.eqFilter;\r\n        this._instrument.tmpEqFilterEnd = null;\r\n        this._instrument.tmpNoteFilterStart = this._instrument.noteFilter;\r\n        this._instrument.tmpNoteFilterEnd = null;\r\n        this._doc.notifier.changed();\r\n    }\r\n}\r\n\r\nexport class ChangeFilterSettings extends UndoableChange {\r\n    private _doc: SongDocument;\r\n    private _instrument: Instrument;\r\n    private _instrumentPrevPreset: number;\r\n    private _instrumentNextPreset: number;\r\n    private _filterSettings: FilterSettings;\r\n    private _subFilters: (FilterSettings | null)[];\r\n    private _oldSubFilters: (FilterSettings | null)[];\r\n    private _oldSettings: FilterSettings;\r\n    private _useNoteFilter: boolean;\r\n    constructor(doc: SongDocument, settings: FilterSettings, oldSettings: FilterSettings, useNoteFilter: boolean, subFilters: (FilterSettings | null)[] | null = null, oldSubFilters: (FilterSettings | null)[] | null = null) {\r\n        super(false);\r\n        this._doc = doc;\r\n        this._instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n        this._instrumentNextPreset = this._instrument.type;\r\n        this._instrumentPrevPreset = this._instrument.preset;\r\n        this._oldSettings = oldSettings;\r\n        this._useNoteFilter = useNoteFilter;\r\n        this._filterSettings = settings;\r\n        if (subFilters != null && oldSubFilters != null) {\r\n            this._subFilters = subFilters;\r\n            this._oldSubFilters = oldSubFilters;\r\n        }\r\n        this._instrument.clearInvalidEnvelopeTargets();\r\n        this._didSomething();\r\n        this.redo();\r\n    }\r\n\r\n    protected _doForwards(): void {\r\n\r\n        if (this._useNoteFilter) {\r\n            this._instrument.noteFilter = this._filterSettings;\r\n            if (this._subFilters != null)\r\n                this._instrument.noteSubFilters = this._subFilters;\r\n            this._instrument.tmpNoteFilterStart = this._instrument.noteFilter;\r\n            this._instrument.tmpNoteFilterEnd = null;\r\n        } else {\r\n            this._instrument.eqFilter = this._filterSettings;\r\n            if (this._subFilters != null)\r\n                this._instrument.eqSubFilters = this._subFilters;\r\n            this._instrument.tmpEqFilterStart = this._instrument.eqFilter;\r\n            this._instrument.tmpEqFilterEnd = null;\r\n        }\r\n\r\n        this._instrument.preset = this._instrumentNextPreset;\r\n        this._instrument.clearInvalidEnvelopeTargets();\r\n        this._doc.notifier.changed();\r\n    }\r\n\r\n    protected _doBackwards(): void {\r\n        if (this._useNoteFilter) {\r\n            this._instrument.noteFilter = this._oldSettings;\r\n            if (this._oldSubFilters != null)\r\n                this._instrument.noteSubFilters = this._oldSubFilters;\r\n            this._instrument.tmpNoteFilterStart = this._instrument.noteFilter;\r\n            this._instrument.tmpNoteFilterEnd = null;\r\n        } else {\r\n            this._instrument.eqFilter = this._oldSettings;\r\n            if (this._oldSubFilters != null)\r\n                this._instrument.eqSubFilters = this._oldSubFilters;\r\n            this._instrument.tmpEqFilterStart = this._instrument.eqFilter;\r\n            this._instrument.tmpEqFilterEnd = null;\r\n        }\r\n        this._instrument.preset = this._instrumentPrevPreset;\r\n        this._instrument.clearInvalidEnvelopeTargets();\r\n        this._doc.notifier.changed();\r\n    }\r\n}\r\n\r\nexport class ChangeFadeInOut extends UndoableChange {\r\n    private _doc: SongDocument;\r\n    private _instrument: Instrument;\r\n    private _instrumentPrevPreset: number;\r\n    private _instrumentNextPreset: number;\r\n    private _oldFadeIn: number;\r\n    private _oldFadeOut: number;\r\n    private _newFadeIn: number;\r\n    private _newFadeOut: number;\r\n    constructor(doc: SongDocument, fadeIn: number, fadeOut: number) {\r\n        super(false);\r\n        this._doc = doc;\r\n        this._instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n        this._instrumentNextPreset = this._instrument.type;\r\n        this._instrumentPrevPreset = this._instrument.preset;\r\n        this._oldFadeIn = this._instrument.fadeIn;\r\n        this._oldFadeOut = this._instrument.fadeOut;\r\n        this._newFadeIn = fadeIn;\r\n        this._newFadeOut = fadeOut;\r\n        this._didSomething();\r\n        this.redo();\r\n    }\r\n\r\n    protected _doForwards(): void {\r\n        this._instrument.fadeIn = this._newFadeIn;\r\n        this._instrument.fadeOut = this._newFadeOut;\r\n        this._instrument.preset = this._instrumentNextPreset;\r\n        this._doc.notifier.changed();\r\n    }\r\n\r\n    protected _doBackwards(): void {\r\n        this._instrument.fadeIn = this._oldFadeIn;\r\n        this._instrument.fadeOut = this._oldFadeOut;\r\n        this._instrument.preset = this._instrumentPrevPreset;\r\n        this._doc.notifier.changed();\r\n    }\r\n}\r\n\r\nexport class ChangeAlgorithm extends Change {\r\n    constructor(doc: SongDocument, newValue: number) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        const oldValue: number = instrument.algorithm;\r\n        if (oldValue != newValue) {\r\n            instrument.algorithm = newValue;\r\n            instrument.preset = instrument.type;\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeFeedbackType extends Change {\r\n    constructor(doc: SongDocument, newValue: number) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        const oldValue: number = instrument.feedbackType;\r\n        if (oldValue != newValue) {\r\n            instrument.feedbackType = newValue;\r\n            instrument.preset = instrument.type;\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\n\r\n\r\nexport class ChangeOperatorWaveform extends Change {\r\n    constructor(doc: SongDocument, operatorIndex: number, newValue: number) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        const oldValue: number = instrument.operators[operatorIndex].waveform;\r\n        if (oldValue != newValue) {\r\n            instrument.operators[operatorIndex].waveform = newValue;\r\n            instrument.preset = instrument.type;\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeOperatorPulseWidth extends Change {\r\n    constructor(doc: SongDocument, operatorIndex: number, oldValue: number, newValue: number) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        instrument.operators[operatorIndex].pulseWidth = newValue;\r\n        instrument.preset = instrument.type;\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) {\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeOperatorFrequency extends Change {\r\n    constructor(doc: SongDocument, operatorIndex: number, newValue: number) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        const oldValue: number = instrument.operators[operatorIndex].frequency;\r\n        if (oldValue != newValue) {\r\n            instrument.operators[operatorIndex].frequency = newValue;\r\n            instrument.preset = instrument.type;\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeOperatorAmplitude extends ChangeInstrumentSlider {\r\n    constructor(doc: SongDocument, operatorIndex: number, oldValue: number, newValue: number) {\r\n        super(doc);\r\n        this._instrument.operators[operatorIndex].amplitude = newValue;\r\n        // Not used currently as mod is implemented as multiplicative\r\n        //doc.synth.unsetMod(ModSetting.mstFMSlider1 + operatorIndex, doc.channel, doc.getCurrentInstrument());\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeFeedbackAmplitude extends ChangeInstrumentSlider {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super(doc);\r\n        this._instrument.feedbackAmplitude = newValue;\r\n        // Not used currently as mod is implemented as multiplicative\r\n        //doc.synth.unsetMod(ModSetting.mstFMFeedback, doc.channel, doc.getCurrentInstrument());\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeAddChannelInstrument extends Change {\r\n    constructor(doc: SongDocument) {\r\n        super();\r\n        const channel: Channel = doc.song.channels[doc.channel];\r\n        const isNoise: boolean = doc.song.getChannelIsNoise(doc.channel);\r\n        const isMod: boolean = doc.song.getChannelIsMod(doc.channel);\r\n        const maxInstruments: number = doc.song.getMaxInstrumentsPerChannel();\r\n        if (channel.instruments.length >= maxInstruments) return;\r\n        const presetValue: number = pickRandomPresetValue(isNoise);\r\n        const preset: Preset = EditorConfig.valueToPreset(presetValue)!;\r\n        const instrument: Instrument = new Instrument(isNoise, isMod);\r\n        instrument.fromJsonObject(preset.settings, isNoise, isMod, false, false, 1);\r\n        instrument.preset = presetValue;\r\n        instrument.volume = 0;\r\n        channel.instruments.push(instrument);\r\n        if (!isMod) { // Mod channels lose information when changing set instrument\r\n            doc.viewedInstrument[doc.channel] = channel.instruments.length - 1;\r\n        }\r\n\r\n        // Determine if any mod instruments were setting 'all' or 'active'. If so, bump indices since there is now a new instrument in the list.\r\n        for (let channelIndex: number = doc.song.pitchChannelCount + doc.song.noiseChannelCount; channelIndex < doc.song.getChannelCount(); channelIndex++) {\r\n            for (let instrumentIndex: number = 0; instrumentIndex < doc.song.channels[channelIndex].instruments.length; instrumentIndex++) {\r\n                for (let mod: number = 0; mod < Config.modCount; mod++) {\r\n\r\n                    let instrument: Instrument = doc.song.channels[channelIndex].instruments[instrumentIndex];\r\n                    let modInstrument: number = instrument.modInstruments[mod];\r\n                    let modChannel: number = instrument.modChannels[mod];\r\n\r\n                    if (modChannel == doc.channel && modInstrument >= doc.song.channels[modChannel].instruments.length-1 ) {\r\n                        instrument.modInstruments[mod]++;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        // Also, make synth re-compute mod values, since 'all'/'active' mods now retroactively apply to this new instrument.\r\n        doc.synth.computeLatestModValues();\r\n\r\n        doc.notifier.changed();\r\n        this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeRemoveChannelInstrument extends Change {\r\n    constructor(doc: SongDocument) {\r\n        super();\r\n        const channel: Channel = doc.song.channels[doc.channel];\r\n        if (channel.instruments.length <= Config.instrumentCountMin) return;\r\n        const removedIndex: number = doc.viewedInstrument[doc.channel];\r\n        channel.instruments.splice(removedIndex, 1);\r\n        if (doc.song.patternInstruments) {\r\n            for (const pattern of channel.patterns) {\r\n                for (let i: number = 0; i < pattern.instruments.length; i++) {\r\n                    if (pattern.instruments[i] == removedIndex) {\r\n                        pattern.instruments.splice(i, 1);\r\n                        i--;\r\n                    } else if (pattern.instruments[i] > removedIndex) {\r\n                        pattern.instruments[i]--;\r\n                    }\r\n                }\r\n                if (pattern.instruments.length <= 0) {\r\n                    pattern.instruments[0] = 0;\r\n                }\r\n            }\r\n        }\r\n\r\n        // Determine if any mod instruments now refer to an invalid instrument number. Unset them if so\r\n        for (let channelIndex: number = doc.song.pitchChannelCount + doc.song.noiseChannelCount; channelIndex < doc.song.getChannelCount(); channelIndex++) {\r\n            for (let instrumentIdx: number = 0; instrumentIdx < doc.song.channels[channelIndex].instruments.length; instrumentIdx++) {\r\n                for (let mod: number = 0; mod < Config.modCount; mod++) {\r\n\r\n                    let instrument: Instrument = doc.song.channels[channelIndex].instruments[instrumentIdx];\r\n                    let modInstrument: number = instrument.modInstruments[mod];\r\n                    let modChannel: number = instrument.modChannels[mod];\r\n\r\n                    if (modChannel == doc.channel) {\r\n                        // Boundary checking - check if setting was previously higher index\r\n                        if (modInstrument > removedIndex) {\r\n                            instrument.modInstruments[mod]--;\r\n                        }\r\n                        // Boundary checking - check if setting was set to the last instrument before splice\r\n                        else if (modInstrument == removedIndex) {\r\n                            instrument.modInstruments[mod] = 0;\r\n                            instrument.modulators[mod] = 0;\r\n                        }\r\n                    }\r\n\r\n                }\r\n            }\r\n        }\r\n\r\n        doc.notifier.changed();\r\n        this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeViewInstrument extends Change {\r\n    constructor(doc: SongDocument, index: number) {\r\n        super();\r\n        if (doc.viewedInstrument[doc.channel] != index) {\r\n            doc.viewedInstrument[doc.channel] = index;\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeInstrumentsFlags extends Change {\r\n    constructor(doc: SongDocument, newLayeredInstruments: boolean, newPatternInstruments: boolean) {\r\n        super();\r\n        const oldLayeredInstruments: boolean = doc.song.layeredInstruments;\r\n        const oldPatternInstruments: boolean = doc.song.patternInstruments;\r\n        if (oldLayeredInstruments == newLayeredInstruments && oldPatternInstruments == newPatternInstruments) return;\r\n        doc.song.layeredInstruments = newLayeredInstruments;\r\n        doc.song.patternInstruments = newPatternInstruments;\r\n\r\n        for (let channelIndex: number = 0; channelIndex < doc.song.getChannelCount(); channelIndex++) {\r\n            const channel: Channel = doc.song.channels[channelIndex];\r\n            if (channel.instruments.length > doc.song.getMaxInstrumentsPerChannel()) {\r\n                channel.instruments.length = doc.song.getMaxInstrumentsPerChannel();\r\n            }\r\n            for (let j: number = 0; j < doc.song.patternsPerChannel; j++) {\r\n                const pattern: Pattern = channel.patterns[j];\r\n                if (!oldPatternInstruments && newPatternInstruments) {\r\n                    // patternInstruments was enabled, set up pattern instruments as appropriate.\r\n                    for (let i: number = 0; i < channel.instruments.length; i++) {\r\n                        pattern.instruments[i] = i;\r\n                    }\r\n                    pattern.instruments.length = channel.instruments.length;\r\n                }\r\n                discardInvalidPatternInstruments(pattern.instruments, doc.song, channelIndex);\r\n            }\r\n        }\r\n\r\n\r\n\r\n        doc.notifier.changed();\r\n        this._didSomething();\r\n    }\r\n}\r\n\r\n\r\nexport class ChangeKey extends Change {\r\n    constructor(doc: SongDocument, newValue: number) {\r\n        super();\r\n        if (doc.song.key != newValue) {\r\n            doc.song.key = newValue;\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeLoop extends Change {\r\n    constructor(private _doc: SongDocument, public oldStart: number, public oldLength: number, public newStart: number, public newLength: number) {\r\n        super();\r\n        this._doc.song.loopStart = this.newStart;\r\n        this._doc.song.loopLength = this.newLength;\r\n        this._doc.notifier.changed();\r\n        if (this.oldStart != this.newStart || this.oldLength != this.newLength) {\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangePitchAdded extends UndoableChange {\r\n    private _doc: SongDocument;\r\n    private _note: Note;\r\n    private _pitch: number;\r\n    private _index: number;\r\n    constructor(doc: SongDocument, note: Note, pitch: number, index: number, deletion: boolean = false) {\r\n        super(deletion);\r\n        this._doc = doc;\r\n        this._note = note;\r\n        this._pitch = pitch;\r\n        this._index = index;\r\n        this._didSomething();\r\n        this.redo();\r\n    }\r\n\r\n    protected _doForwards(): void {\r\n        this._note.pitches.splice(this._index, 0, this._pitch);\r\n        this._doc.notifier.changed();\r\n    }\r\n\r\n    protected _doBackwards(): void {\r\n        this._note.pitches.splice(this._index, 1);\r\n        this._doc.notifier.changed();\r\n    }\r\n}\r\n\r\nexport class ChangeOctave extends Change {\r\n    constructor(doc: SongDocument, public oldValue: number, newValue: number) {\r\n        super();\r\n        doc.song.channels[doc.channel].octave = newValue;\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeRhythm extends ChangeGroup {\r\n    constructor(doc: SongDocument, newValue: number) {\r\n        super();\r\n\r\n        if (doc.song.rhythm != newValue) {\r\n            doc.song.rhythm = newValue;\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangePaste extends ChangeGroup {\r\n    constructor(doc: SongDocument, pattern: Pattern, notes: any[], selectionStart: number, selectionEnd: number, oldPartDuration: number) {\r\n        super();\r\n\r\n        // Erase the current contents of the selection:\r\n        this.append(new ChangeNoteTruncate(doc, pattern, selectionStart, selectionEnd, null, true));\r\n\r\n        // Mods don't follow this sequence, so skipping for now.\r\n        let noteInsertionIndex: number = 0;\r\n        if (!doc.song.getChannelIsMod(doc.channel)) {\r\n            for (let i: number = 0; i < pattern.notes.length; i++) {\r\n                if (pattern.notes[i].start < selectionStart) {\r\n                    if (pattern.notes[i].end > selectionStart) throw new Error();\r\n\r\n                    noteInsertionIndex = i + 1;\r\n                } else if (pattern.notes[i].start < selectionEnd) {\r\n                    throw new Error();\r\n                }\r\n            }\r\n        }\r\n        else {\r\n            noteInsertionIndex = pattern.notes.length;\r\n        }\r\n\r\n        while (selectionStart < selectionEnd) {\r\n            for (const noteObject of notes) {\r\n                const noteStart: number = noteObject[\"start\"] + selectionStart;\r\n                const noteEnd: number = noteObject[\"end\"] + selectionStart;\r\n                if (noteStart >= selectionEnd) break;\r\n                const note: Note = new Note(noteObject[\"pitches\"][0], noteStart, noteEnd, noteObject[\"pins\"][0][\"size\"], false);\r\n                note.pitches.length = 0;\r\n                for (const pitch of noteObject[\"pitches\"]) {\r\n                    note.pitches.push(pitch);\r\n                }\r\n                note.pins.length = 0;\r\n                for (const pin of noteObject[\"pins\"]) {\r\n                    note.pins.push(makeNotePin(pin.interval, pin.time, pin.size));\r\n                }\r\n                note.continuesLastPattern = (noteObject[\"continuesLastPattern\"] === true) && (note.start == 0);\r\n                pattern.notes.splice(noteInsertionIndex++, 0, note);\r\n                if (note.end > selectionEnd) {\r\n                    this.append(new ChangeNoteLength(doc, note, note.start, selectionEnd));\r\n                }\r\n            }\r\n\r\n            selectionStart += oldPartDuration;\r\n        }\r\n\r\n        // Need to re-sort the notes by start time as they might change order because of paste.\r\n        if (pattern != null && doc.song.getChannelIsMod(doc.channel)) pattern.notes.sort(function (a, b) { return (a.start == b.start) ? a.pitches[0] - b.pitches[0] : a.start - b.start; });\r\n\r\n\r\n        doc.notifier.changed();\r\n        this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangePasteInstrument extends ChangeGroup {\r\n    constructor(doc: SongDocument, instrument: Instrument, instrumentCopy: any) {\r\n        super();\r\n        instrument.fromJsonObject(instrumentCopy, instrumentCopy[\"isDrum\"], instrumentCopy[\"isMod\"], false, false);\r\n        doc.notifier.changed();\r\n        this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeSetPatternInstruments extends Change {\r\n    constructor(doc: SongDocument, channelIndex: number, instruments: number[], pattern: Pattern) {\r\n        super();\r\n        if (!patternsContainSameInstruments(instruments, pattern.instruments)) {\r\n            pattern.instruments.length = 0;\r\n            pattern.instruments.push(...instruments);\r\n            discardInvalidPatternInstruments(pattern.instruments, doc.song, channelIndex);\r\n            this._didSomething();\r\n            doc.notifier.changed();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeModChannel extends Change {\r\n    constructor(doc: SongDocument, mod: number, index: number, useInstrument?: Instrument) {\r\n        super();\r\n        let instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        if (useInstrument != undefined)\r\n            instrument = useInstrument;\r\n\r\n        // None, or swapping from song to instrument/vice-versa\r\n        if (index == 0 || (Config.modulators[instrument.modulators[mod]].forSong && index >= 2) || (!Config.modulators[instrument.modulators[mod]].forSong && index < 2)) {\r\n            instrument.modulators[mod] = Config.modulators.dictionary[\"none\"].index;\r\n        }\r\n\r\n        instrument.modChannels[mod] = index - 2;\r\n\r\n        doc.notifier.changed();\r\n        this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeModInstrument extends Change {\r\n    constructor(doc: SongDocument, mod: number, tgtInstrument: number) {\r\n        super();\r\n\r\n        let instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n\r\n        if (instrument.modInstruments[mod] != tgtInstrument) {\r\n            instrument.modInstruments[mod] = tgtInstrument;\r\n\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeModSetting extends Change {\r\n    constructor(doc: SongDocument, mod: number, text: string) {\r\n        super();\r\n\r\n        let instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n\r\n        // Populate all instruments that could be targeted by this mod setting.\r\n        let tgtChannel: number = instrument.modChannels[mod];\r\n        let usedInstruments: Instrument[] = [];\r\n        if (tgtChannel >= 0) { // Ignore song/none.\r\n            if (instrument.modInstruments[mod] == doc.song.channels[tgtChannel].instruments.length) {\r\n                // All - Populate list of all instruments\r\n                usedInstruments = usedInstruments.concat(doc.song.channels[tgtChannel].instruments);\r\n            } else if (instrument.modInstruments[mod] > doc.song.channels[tgtChannel].instruments.length) {\r\n                // Active - Populate list of only used instruments\r\n                let tgtPattern: Pattern | null = doc.song.getPattern(tgtChannel, doc.bar);\r\n                if (tgtPattern != null) {\r\n                    for (let i: number = 0; i < tgtPattern.instruments.length; i++) {\r\n                        usedInstruments.push(doc.song.channels[tgtChannel].instruments[tgtPattern.instruments[i]]);\r\n                    }\r\n                }\r\n            }\r\n            else {\r\n                // Single instrument used.\r\n                usedInstruments.push(doc.song.channels[tgtChannel].instruments[instrument.modInstruments[mod]]);\r\n            }\r\n        }\r\n\r\n        // Check if a new effect is being added - if so add the proper associated effect to the instrument(s), and truncate \"+ \" from start of text.\r\n        if (text.startsWith(\"+ \")) {\r\n            text = text.substr(2);\r\n            for (let i: number = 0; i < usedInstruments.length; i++) {\r\n                const tgtInstrument: Instrument = usedInstruments[i];\r\n                if (!(tgtInstrument.effects & (1 << Config.modulators.dictionary[text].associatedEffect))) {\r\n                    doc.record(new ChangeToggleEffects(doc, Config.modulators.dictionary[text].associatedEffect, tgtInstrument));\r\n                }\r\n            }\r\n        }\r\n\r\n        let setting: number = Config.modulators.dictionary[text].index;\r\n\r\n        if (instrument.modulators[mod] != setting) {\r\n\r\n            instrument.modulators[mod] = setting;\r\n\r\n            // Go through each pattern where this instrument is set, and clean up any notes that are out of bounds\r\n            let cap: number = Config.modulators[setting].maxRawVol;\r\n\r\n            for (let i: number = 0; i < doc.song.patternsPerChannel; i++) {\r\n                const pattern: Pattern = doc.song.channels[doc.channel].patterns[i];\r\n                if (pattern.instruments[0] == doc.getCurrentInstrument()) {\r\n                    for (let j: number = 0; j < pattern.notes.length; j++) {\r\n                        const note: Note = pattern.notes[j];\r\n                        if (note.pitches[0] == Config.modCount - mod - 1) {\r\n                            for (let k: number = 0; k < note.pins.length; k++) {\r\n                                const pin: NotePin = note.pins[k];\r\n                                if (pin.size > cap)\r\n                                    pin.size = cap;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeModFilter extends Change {\r\n    constructor(doc: SongDocument, mod: number, type: number) {\r\n        super();\r\n\r\n        let instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n\r\n        if (instrument.modFilterTypes[mod] != type) {\r\n\r\n            instrument.modFilterTypes[mod] = type;\r\n\r\n            // Go through each pattern where this instrument is set, and clean up any notes that are out of bounds\r\n            let cap: number = doc.song.getVolumeCapForSetting(true, instrument.modulators[mod], instrument.modFilterTypes[mod]);\r\n\r\n            for (let i: number = 0; i < doc.song.patternsPerChannel; i++) {\r\n                const pattern: Pattern = doc.song.channels[doc.channel].patterns[i];\r\n                if (pattern.instruments[0] == doc.getCurrentInstrument()) {\r\n                    for (let j: number = 0; j < pattern.notes.length; j++) {\r\n                        const note: Note = pattern.notes[j];\r\n                        if (note.pitches[0] == Config.modCount - mod - 1) {\r\n                            for (let k: number = 0; k < note.pins.length; k++) {\r\n                                const pin: NotePin = note.pins[k];\r\n                                if (pin.size > cap)\r\n                                    pin.size = cap;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangePatternsPerChannel extends Change {\r\n    constructor(doc: SongDocument, newValue: number) {\r\n        super();\r\n        if (doc.song.patternsPerChannel != newValue) {\r\n            for (let i: number = 0; i < doc.song.getChannelCount(); i++) {\r\n                const channelBars: number[] = doc.song.channels[i].bars;\r\n                const channelPatterns: Pattern[] = doc.song.channels[i].patterns;\r\n                for (let j: number = 0; j < channelBars.length; j++) {\r\n                    if (channelBars[j] > newValue) channelBars[j] = 0;\r\n                }\r\n                for (let j: number = channelPatterns.length; j < newValue; j++) {\r\n                    channelPatterns[j] = new Pattern();\r\n                }\r\n                channelPatterns.length = newValue;\r\n            }\r\n            doc.song.patternsPerChannel = newValue;\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeEnsurePatternExists extends UndoableChange {\r\n    private _doc: SongDocument;\r\n    private _bar: number;\r\n    private _channelIndex: number;\r\n    private _patternIndex: number;\r\n    private _patternOldNotes: Note[] | null = null;\r\n    private _oldPatternCount: number;\r\n    private _newPatternCount: number;\r\n    private _oldPatternInstruments: number[] | null = null;\r\n    private _newPatternInstruments: number[];\r\n\r\n    constructor(doc: SongDocument, channelIndex: number, bar: number) {\r\n        super(false);\r\n        const song: Song = doc.song;\r\n        if (song.channels[channelIndex].bars[bar] != 0) return;\r\n\r\n        this._doc = doc;\r\n        this._bar = bar;\r\n        this._channelIndex = channelIndex;\r\n        this._oldPatternCount = song.patternsPerChannel;\r\n        this._newPatternCount = song.patternsPerChannel;\r\n        this._newPatternInstruments = doc.recentPatternInstruments[channelIndex].concat();\r\n\r\n        let firstEmptyUnusedIndex: number | null = null;\r\n        let firstUnusedIndex: number | null = null;\r\n        for (let patternIndex: number = 1; patternIndex <= song.patternsPerChannel; patternIndex++) {\r\n            let used = false;\r\n            for (let barIndex: number = 0; barIndex < song.barCount; barIndex++) {\r\n                if (song.channels[channelIndex].bars[barIndex] == patternIndex) {\r\n                    used = true;\r\n                    break;\r\n                }\r\n            }\r\n            if (used) continue;\r\n            if (firstUnusedIndex == null) {\r\n                firstUnusedIndex = patternIndex;\r\n            }\r\n            const pattern: Pattern = song.channels[channelIndex].patterns[patternIndex - 1];\r\n            if (pattern.notes.length == 0) {\r\n                firstEmptyUnusedIndex = patternIndex;\r\n                break;\r\n            }\r\n        }\r\n\r\n        if (firstEmptyUnusedIndex != null) {\r\n            this._patternIndex = firstEmptyUnusedIndex;\r\n            this._oldPatternInstruments = song.channels[channelIndex].patterns[firstEmptyUnusedIndex - 1].instruments.concat();\r\n        } else if (song.patternsPerChannel < song.barCount) {\r\n            this._newPatternCount = song.patternsPerChannel + 1;\r\n            this._patternIndex = song.patternsPerChannel + 1;\r\n        } else if (firstUnusedIndex != null) {\r\n            this._patternIndex = firstUnusedIndex;\r\n            this._patternOldNotes = song.channels[channelIndex].patterns[firstUnusedIndex - 1].notes;\r\n            this._oldPatternInstruments = song.channels[channelIndex].patterns[firstUnusedIndex - 1].instruments.concat();\r\n        } else {\r\n            throw new Error();\r\n        }\r\n\r\n        this._didSomething();\r\n        this._doForwards();\r\n    }\r\n\r\n    protected _doForwards(): void {\r\n        const song: Song = this._doc.song;\r\n        for (let j: number = song.patternsPerChannel; j < this._newPatternCount; j++) {\r\n            for (let i: number = 0; i < song.getChannelCount(); i++) {\r\n                song.channels[i].patterns[j] = new Pattern();\r\n            }\r\n        }\r\n        song.patternsPerChannel = this._newPatternCount;\r\n        const pattern: Pattern = song.channels[this._channelIndex].patterns[this._patternIndex - 1];\r\n        pattern.notes = [];\r\n        pattern.instruments.length = 0;\r\n        pattern.instruments.push(...this._newPatternInstruments);\r\n        song.channels[this._channelIndex].bars[this._bar] = this._patternIndex;\r\n        this._doc.notifier.changed();\r\n    }\r\n\r\n    protected _doBackwards(): void {\r\n        const song: Song = this._doc.song;\r\n        const pattern: Pattern = song.channels[this._channelIndex].patterns[this._patternIndex - 1];\r\n        if (this._patternOldNotes != null) pattern.notes = this._patternOldNotes;\r\n        if (this._oldPatternInstruments != null) {\r\n            pattern.instruments.length = 0;\r\n            pattern.instruments.push(...this._oldPatternInstruments);\r\n        }\r\n        song.channels[this._channelIndex].bars[this._bar] = 0;\r\n        for (let i: number = 0; i < song.getChannelCount(); i++) {\r\n            song.channels[i].patterns.length = this._oldPatternCount;\r\n        }\r\n        song.patternsPerChannel = this._oldPatternCount;\r\n        this._doc.notifier.changed();\r\n    }\r\n}\r\n\r\nexport class ChangePinTime extends ChangePins {\r\n    constructor(doc: SongDocument | null, note: Note, pinIndex: number, shiftedTime: number, continuesLastPattern: boolean) {\r\n        super(doc, note);\r\n\r\n        shiftedTime -= this._oldStart;\r\n        const originalTime: number = this._oldPins[pinIndex].time;\r\n        const skipStart: number = Math.min(originalTime, shiftedTime);\r\n        const skipEnd: number = Math.max(originalTime, shiftedTime);\r\n        let setPin: boolean = false;\r\n        for (let i: number = 0; i < this._oldPins.length; i++) {\r\n            const oldPin: NotePin = note.pins[i];\r\n            const time: number = oldPin.time;\r\n            if (time < skipStart) {\r\n                this._newPins.push(makeNotePin(oldPin.interval, time, oldPin.size));\r\n            } else if (time > skipEnd) {\r\n                if (!setPin) {\r\n                    if (this._newPins.length > 0) continuesLastPattern = note.continuesLastPattern;\r\n                    this._newPins.push(makeNotePin(this._oldPins[pinIndex].interval, shiftedTime, this._oldPins[pinIndex].size));\r\n                    setPin = true;\r\n                }\r\n                this._newPins.push(makeNotePin(oldPin.interval, time, oldPin.size));\r\n            }\r\n        }\r\n        if (!setPin) {\r\n            continuesLastPattern = note.continuesLastPattern;\r\n            this._newPins.push(makeNotePin(this._oldPins[pinIndex].interval, shiftedTime, this._oldPins[pinIndex].size));\r\n        }\r\n\r\n        this._finishSetup(continuesLastPattern);\r\n    }\r\n}\r\n\r\nexport class ChangePitchBend extends ChangePins {\r\n    constructor(doc: SongDocument | null, note: Note, bendStart: number, bendEnd: number, bendTo: number, pitchIndex: number) {\r\n        super(doc, note);\r\n\r\n        bendStart -= this._oldStart;\r\n        bendEnd -= this._oldStart;\r\n        bendTo -= note.pitches[pitchIndex];\r\n\r\n        let setStart: boolean = false;\r\n        let setEnd: boolean = false;\r\n        let prevInterval: number = 0;\r\n        let prevSize: number = Config.noteSizeMax;\r\n        let persist: boolean = true;\r\n        let i: number;\r\n        let direction: number;\r\n        let stop: number;\r\n        let push: (item: NotePin) => void;\r\n        if (bendEnd > bendStart) {\r\n            i = 0;\r\n            direction = 1;\r\n            stop = note.pins.length;\r\n            push = (item: NotePin) => { this._newPins.push(item); };\r\n        } else {\r\n            i = note.pins.length - 1;\r\n            direction = -1;\r\n            stop = -1;\r\n            push = (item: NotePin) => { this._newPins.unshift(item); };\r\n        }\r\n        for (; i != stop; i += direction) {\r\n            const oldPin: NotePin = note.pins[i];\r\n            const time: number = oldPin.time;\r\n            for (; ;) {\r\n                if (!setStart) {\r\n                    if (time * direction <= bendStart * direction) {\r\n                        prevInterval = oldPin.interval;\r\n                        prevSize = oldPin.size;\r\n                    }\r\n                    if (time * direction < bendStart * direction) {\r\n                        push(makeNotePin(oldPin.interval, time, oldPin.size));\r\n                        break;\r\n                    } else {\r\n                        push(makeNotePin(prevInterval, bendStart, prevSize));\r\n                        setStart = true;\r\n                    }\r\n                } else if (!setEnd) {\r\n                    if (time * direction <= bendEnd * direction) {\r\n                        prevInterval = oldPin.interval;\r\n                        prevSize = oldPin.size;\r\n                    }\r\n                    if (time * direction < bendEnd * direction) {\r\n                        break;\r\n                    } else {\r\n                        push(makeNotePin(bendTo, bendEnd, prevSize));\r\n                        setEnd = true;\r\n                    }\r\n                } else {\r\n                    if (time * direction == bendEnd * direction) {\r\n                        break;\r\n                    } else {\r\n                        if (oldPin.interval != prevInterval) persist = false;\r\n                        push(makeNotePin(persist ? bendTo : oldPin.interval, time, oldPin.size));\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        if (!setEnd) {\r\n            push(makeNotePin(bendTo, bendEnd, prevSize));\r\n        }\r\n\r\n        this._finishSetup();\r\n    }\r\n}\r\n\r\nexport class ChangePatternRhythm extends ChangeSequence {\r\n    constructor(doc: SongDocument, pattern: Pattern) {\r\n        super();\r\n        const minDivision: number = Config.partsPerBeat / Config.rhythms[doc.song.rhythm].stepsPerBeat;\r\n\r\n        const changeRhythm: (oldTime: number) => number = function (oldTime: number): number {\r\n            let thresholds: number[] | null = Config.rhythms[doc.song.rhythm].roundUpThresholds;\r\n            if (thresholds != null) {\r\n                const beatStart: number = Math.floor(oldTime / Config.partsPerBeat) * Config.partsPerBeat;\r\n                const remainder: number = oldTime - beatStart;\r\n                let newTime: number = beatStart;\r\n                for (const threshold of thresholds) {\r\n                    if (remainder >= threshold) {\r\n                        newTime += minDivision;\r\n                    } else {\r\n                        break;\r\n                    }\r\n                }\r\n                return newTime;\r\n            } else {\r\n                return Math.round(oldTime / minDivision) * minDivision;\r\n            }\r\n        };\r\n\r\n        let i: number = 0;\r\n        while (i < pattern.notes.length) {\r\n            const note: Note = pattern.notes[i];\r\n            if (changeRhythm(note.start) >= changeRhythm(note.end)) {\r\n                this.append(new ChangeNoteAdded(doc, pattern, note, i, true));\r\n            } else {\r\n                this.append(new ChangeRhythmNote(doc, note, changeRhythm));\r\n                i++;\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nclass ChangeRhythmNote extends ChangePins {\r\n    constructor(doc: SongDocument | null, note: Note, changeRhythm: (oldTime: number) => number) {\r\n        super(doc, note);\r\n\r\n        for (const oldPin of this._oldPins) {\r\n            this._newPins.push(makeNotePin(oldPin.interval, changeRhythm(oldPin.time + this._oldStart) - this._oldStart, oldPin.size));\r\n        }\r\n\r\n        this._finishSetup();\r\n    }\r\n}\r\n\r\nexport class ChangeMoveNotesSideways extends ChangeGroup {\r\n    constructor(doc: SongDocument, beatsToMove: number, strategy: string) {\r\n        super();\r\n        let partsToMove: number = Math.round((beatsToMove % doc.song.beatsPerBar) * Config.partsPerBeat);\r\n        if (partsToMove < 0) partsToMove += doc.song.beatsPerBar * Config.partsPerBeat;\r\n        if (partsToMove == 0.0) return;\r\n\r\n        switch (strategy) {\r\n            case \"wrapAround\": {\r\n                const partsPerBar: number = Config.partsPerBeat * doc.song.beatsPerBar;\r\n                for (const channel of doc.song.channels) {\r\n                    for (const pattern of channel.patterns) {\r\n                        const newNotes: Note[] = [];\r\n\r\n                        for (let bar: number = 1; bar >= 0; bar--) {\r\n                            const barStartPart: number = bar * partsPerBar;\r\n\r\n                            for (const oldNote of pattern.notes) {\r\n                                const absoluteNoteStart: number = oldNote.start + partsToMove;\r\n                                const absoluteNoteEnd: number = oldNote.end + partsToMove;\r\n                                const noteStartPart: number = Math.max(0, absoluteNoteStart - barStartPart);\r\n                                const noteEndPart: number = Math.min(partsPerBar, absoluteNoteEnd - barStartPart);\r\n\r\n                                if (noteStartPart < noteEndPart) {\r\n                                    projectNoteIntoBar(oldNote, absoluteNoteStart - barStartPart - noteStartPart, noteStartPart, noteEndPart, newNotes);\r\n                                }\r\n                            }\r\n                        }\r\n\r\n                        pattern.notes = newNotes;\r\n                    }\r\n                }\r\n            } break;\r\n            case \"overflow\": {\r\n                let originalBarCount: number = doc.song.barCount;\r\n                let originalLoopStart: number = doc.song.loopStart;\r\n                let originalLoopLength: number = doc.song.loopLength;\r\n\r\n                this.append(new ChangeMoveAndOverflowNotes(doc, doc.song.beatsPerBar, partsToMove));\r\n\r\n                if (beatsToMove < 0) {\r\n                    let firstBarIsEmpty: boolean = true;\r\n                    for (const channel of doc.song.channels) {\r\n                        if (channel.bars[0] != 0) firstBarIsEmpty = false;\r\n                    }\r\n                    if (firstBarIsEmpty) {\r\n                        for (const channel of doc.song.channels) {\r\n                            channel.bars.shift();\r\n                        }\r\n                        doc.song.barCount--;\r\n                    } else {\r\n                        originalBarCount++;\r\n                        originalLoopStart++;\r\n                        doc.bar++;\r\n                    }\r\n                }\r\n                while (doc.song.barCount < originalBarCount) {\r\n                    for (const channel of doc.song.channels) {\r\n                        channel.bars.push(0);\r\n                    }\r\n                    doc.song.barCount++;\r\n                }\r\n                doc.song.loopStart = originalLoopStart;\r\n                doc.song.loopLength = originalLoopLength;\r\n            } break;\r\n            default: throw new Error(\"Unrecognized beats-per-bar conversion strategy.\");\r\n        }\r\n\r\n        doc.notifier.changed();\r\n        this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeBeatsPerBar extends ChangeGroup {\r\n    constructor(doc: SongDocument, newValue: number, strategy: string) {\r\n        super();\r\n        if (doc.song.beatsPerBar != newValue) {\r\n            switch (strategy) {\r\n                case \"splice\": {\r\n                    if (doc.song.beatsPerBar > newValue) {\r\n                        const sequence: ChangeSequence = new ChangeSequence();\r\n                        for (let i: number = 0; i < doc.song.getChannelCount(); i++) {\r\n                            for (let j: number = 0; j < doc.song.channels[i].patterns.length; j++) {\r\n                                sequence.append(new ChangeNoteTruncate(doc, doc.song.channels[i].patterns[j], newValue * Config.partsPerBeat, doc.song.beatsPerBar * Config.partsPerBeat, null, true));\r\n                            }\r\n                        }\r\n                    }\r\n                } break;\r\n                case \"stretch\": {\r\n                    const changeRhythm = function (oldTime: number): number {\r\n                        return Math.round(oldTime * newValue / doc.song.beatsPerBar);\r\n                    };\r\n                    for (let channelIndex: number = 0; channelIndex < doc.song.getChannelCount(); channelIndex++) {\r\n                        for (let patternIndex: number = 0; patternIndex < doc.song.channels[channelIndex].patterns.length; patternIndex++) {\r\n                            const pattern: Pattern = doc.song.channels[channelIndex].patterns[patternIndex];\r\n                            let noteIndex: number = 0;\r\n                            while (noteIndex < pattern.notes.length) {\r\n                                const note: Note = pattern.notes[noteIndex];\r\n                                if (changeRhythm(note.start) >= changeRhythm(note.end)) {\r\n                                    this.append(new ChangeNoteAdded(doc, pattern, note, noteIndex, true));\r\n                                } else {\r\n                                    this.append(new ChangeRhythmNote(doc, note, changeRhythm));\r\n                                    noteIndex++;\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                    this.append(new ChangeTempo(doc, doc.song.tempo, doc.song.tempo * newValue / doc.song.beatsPerBar));\r\n                } break;\r\n                case \"overflow\": {\r\n                    this.append(new ChangeMoveAndOverflowNotes(doc, newValue, 0));\r\n                    doc.song.loopStart = 0;\r\n                    doc.song.loopLength = doc.song.barCount;\r\n                } break;\r\n                default: throw new Error(\"Unrecognized beats-per-bar conversion strategy.\");\r\n            }\r\n\r\n            doc.song.beatsPerBar = newValue;\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeScale extends ChangeGroup {\r\n    constructor(doc: SongDocument, newValue: number) {\r\n        super();\r\n        if (doc.song.scale != newValue) {\r\n            doc.song.scale = newValue;\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeDetectKey extends ChangeGroup {\r\n    constructor(doc: SongDocument) {\r\n        super();\r\n        const song: Song = doc.song;\r\n        const basePitch: number = Config.keys[song.key].basePitch;\r\n        const keyWeights: number[] = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];\r\n        for (let channelIndex: number = 0; channelIndex < song.pitchChannelCount; channelIndex++) {\r\n            for (let barIndex: number = 0; barIndex < song.barCount; barIndex++) {\r\n                const pattern: Pattern | null = song.getPattern(channelIndex, barIndex);\r\n                if (pattern != null) {\r\n                    for (const note of pattern.notes) {\r\n                        const prevPin: NotePin = note.pins[0];\r\n                        for (let pinIndex: number = 1; pinIndex < note.pins.length; pinIndex++) {\r\n                            const nextPin: NotePin = note.pins[pinIndex];\r\n                            if (prevPin.interval == nextPin.interval) {\r\n                                let weight: number = nextPin.time - prevPin.time;\r\n                                weight += Math.max(0, Math.min(Config.partsPerBeat, nextPin.time + note.start) - (prevPin.time + note.start));\r\n                                weight *= nextPin.size + prevPin.size;\r\n                                for (const pitch of note.pitches) {\r\n                                    const key = (basePitch + prevPin.interval + pitch) % 12;\r\n                                    keyWeights[key] += weight;\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        let bestKey: number = 0;\r\n        let bestKeyWeight: number = 0;\r\n        for (let key: number = 0; key < 12; key++) {\r\n            // Look for the root of the most prominent major or minor chord.\r\n            const keyWeight: number = keyWeights[key] * (3 * keyWeights[(key + 7) % 12] + keyWeights[(key + 4) % 12] + keyWeights[(key + 3) % 12]);\r\n            if (bestKeyWeight < keyWeight) {\r\n                bestKeyWeight = keyWeight;\r\n                bestKey = key;\r\n            }\r\n        }\r\n\r\n        if (bestKey != song.key) {\r\n            const diff: number = song.key - bestKey;\r\n            const absoluteDiff: number = Math.abs(diff);\r\n\r\n            for (let channelIndex: number = 0; channelIndex < song.pitchChannelCount; channelIndex++) {\r\n                for (const pattern of song.channels[channelIndex].patterns) {\r\n                    for (let i: number = 0; i < absoluteDiff; i++) {\r\n                        this.append(new ChangeTranspose(doc, channelIndex, pattern, diff > 0, true));\r\n                    }\r\n                }\r\n            }\r\n\r\n            song.key = bestKey;\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport function pickRandomPresetValue(isNoise: boolean): number {\r\n    const eligiblePresetValues: number[] = [];\r\n    for (let categoryIndex: number = 0; categoryIndex < EditorConfig.presetCategories.length; categoryIndex++) {\r\n        const category: PresetCategory = EditorConfig.presetCategories[categoryIndex];\r\n        if (category.name == \"Novelty Presets\") continue;\r\n        for (let presetIndex: number = 0; presetIndex < category.presets.length; presetIndex++) {\r\n            const preset: Preset = category.presets[presetIndex];\r\n            if (preset.settings != undefined && (preset.isNoise == true) == isNoise) {\r\n                eligiblePresetValues.push((categoryIndex << 6) + presetIndex);\r\n            }\r\n        }\r\n    }\r\n    return eligiblePresetValues[(Math.random() * eligiblePresetValues.length) | 0];\r\n}\r\n\r\nexport function setDefaultInstruments(song: Song): void {\r\n    for (let channelIndex: number = 0; channelIndex < song.channels.length; channelIndex++) {\r\n        for (const instrument of song.channels[channelIndex].instruments) {\r\n            const isNoise: boolean = song.getChannelIsNoise(channelIndex);\r\n            const isMod: boolean = song.getChannelIsMod(channelIndex);\r\n            const presetValue: number = (channelIndex == song.pitchChannelCount) ? EditorConfig.nameToPresetValue(Math.random() > 0.5 ? \"chip noise\" : \"standard drumset\")! : pickRandomPresetValue(isNoise);\r\n            const preset: Preset = EditorConfig.valueToPreset(presetValue)!;\r\n            instrument.fromJsonObject(preset.settings, isNoise, isMod, song.rhythm == 0 || song.rhythm == 2, song.rhythm >= 2, 1);\r\n            instrument.preset = presetValue;\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeSong extends ChangeGroup {\r\n    constructor(doc: SongDocument, newHash: string) {\r\n        super();\r\n        let pitchChannelCount = doc.song.pitchChannelCount;\r\n        let noiseChannelCount = doc.song.noiseChannelCount;\r\n        let modChannelCount = doc.song.modChannelCount;\r\n        doc.song.fromBase64String(newHash);\r\n        if (pitchChannelCount != doc.song.pitchChannelCount || noiseChannelCount != doc.song.noiseChannelCount || modChannelCount != doc.song.modChannelCount) {\r\n            ColorConfig.resetColors();\r\n        }\r\n        if (newHash == \"\") {\r\n            this.append(new ChangePatternSelection(doc, 0, 0));\r\n            doc.selection.resetBoxSelection();\r\n            setDefaultInstruments(doc.song);\r\n            doc.song.scale = doc.prefs.defaultScale;\r\n\r\n            for (let i: number = 0; i <= doc.song.channels.length; i++) {\r\n                doc.viewedInstrument[i] = 0;\r\n                doc.recentPatternInstruments[i] = [0];\r\n            }\r\n            doc.viewedInstrument.length = doc.song.channels.length;\r\n        } else {\r\n            this.append(new ChangeValidateTrackSelection(doc));\r\n        }\r\n        doc.synth.computeLatestModValues();\r\n        doc.notifier.changed();\r\n        this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeValidateTrackSelection extends Change {\r\n    constructor(doc: SongDocument) {\r\n        super();\r\n        const channelIndex: number = Math.min(doc.channel, doc.song.getChannelCount() - 1);\r\n        const bar: number = Math.max(0, Math.min(doc.song.barCount - 1, doc.bar));\r\n        if (doc.channel != channelIndex || doc.bar != bar) {\r\n\t\t\tdoc.bar = bar;\r\n\t\t\tdoc.channel = channelIndex;\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t\tdoc.selection.scrollToSelectedPattern();\r\n\t\tdoc.notifier.changed();\r\n    }\r\n}\r\n\r\nexport class ChangeReplacePatterns extends ChangeGroup {\r\n    constructor(doc: SongDocument, pitchChannels: Channel[], noiseChannels: Channel[], modChannels: Channel[]) {\r\n        super();\r\n\r\n        const song: Song = doc.song;\r\n\r\n        function removeExtraSparseChannels(channels: Channel[], maxLength: number): void {\r\n            while (channels.length > maxLength) {\r\n                let sparsestIndex: number = channels.length - 1;\r\n                let mostZeroes: number = 0;\r\n                for (let channelIndex: number = 0; channelIndex < channels.length - 1; channelIndex++) {\r\n                    let zeroes: number = 0;\r\n                    for (const bar of channels[channelIndex].bars) {\r\n                        if (bar == 0) zeroes++;\r\n                    }\r\n                    if (zeroes >= mostZeroes) {\r\n                        sparsestIndex = channelIndex;\r\n                        mostZeroes = zeroes;\r\n                    }\r\n                }\r\n                channels.splice(sparsestIndex, 1);\r\n            }\r\n        }\r\n\r\n        removeExtraSparseChannels(pitchChannels, Config.pitchChannelCountMax);\r\n        removeExtraSparseChannels(noiseChannels, Config.noiseChannelCountMax);\r\n        removeExtraSparseChannels(modChannels, Config.modChannelCountMax);\r\n\r\n        while (pitchChannels.length < Config.pitchChannelCountMin) pitchChannels.push(new Channel());\r\n        while (noiseChannels.length < Config.noiseChannelCountMin) noiseChannels.push(new Channel());\r\n        while (modChannels.length < Config.modChannelCountMin) modChannels.push(new Channel());\r\n\r\n        // Set minimum counts.\r\n        song.barCount = 1;\r\n        song.patternsPerChannel = 8;\r\n        const combinedChannels: Channel[] = pitchChannels.concat(noiseChannels.concat(modChannels));\r\n        for (let channelIndex: number = 0; channelIndex < combinedChannels.length; channelIndex++) {\r\n            const channel: Channel = combinedChannels[channelIndex];\r\n            song.barCount = Math.max(song.barCount, channel.bars.length);\r\n            song.patternsPerChannel = Math.max(song.patternsPerChannel, channel.patterns.length);\r\n            song.channels[channelIndex] = channel;\r\n        }\r\n        song.channels.length = combinedChannels.length;\r\n        song.pitchChannelCount = pitchChannels.length;\r\n        song.noiseChannelCount = noiseChannels.length;\r\n        song.modChannelCount = modChannels.length;\r\n\r\n        song.barCount = Math.min(Config.barCountMax, song.barCount);\r\n        song.patternsPerChannel = Math.min(Config.barCountMax, song.patternsPerChannel);\r\n        for (let channelIndex: number = 0; channelIndex < song.channels.length; channelIndex++) {\r\n            const channel: Channel = song.channels[channelIndex];\r\n\r\n            for (let barIndex: number = 0; barIndex < channel.bars.length; barIndex++) {\r\n                if (channel.bars[barIndex] > song.patternsPerChannel || channel.bars[barIndex] < 0) {\r\n                    channel.bars[barIndex] = 0;\r\n                }\r\n            }\r\n            while (channel.bars.length < song.barCount) {\r\n                channel.bars.push(0);\r\n            }\r\n            channel.bars.length = song.barCount;\r\n\r\n            if (channel.instruments.length > song.getMaxInstrumentsPerChannel()) {\r\n                channel.instruments.length = song.getMaxInstrumentsPerChannel();\r\n            }\r\n\r\n            for (const pattern of channel.patterns) {\r\n                discardInvalidPatternInstruments(pattern.instruments, song, channelIndex);\r\n            }\r\n            while (channel.patterns.length < song.patternsPerChannel) {\r\n                channel.patterns.push(new Pattern());\r\n            }\r\n\r\n            channel.patterns.length = song.patternsPerChannel;\r\n        }\r\n\r\n        song.loopStart = Math.max(0, Math.min(song.barCount - 1, song.loopStart));\r\n        song.loopLength = Math.min(song.barCount - song.loopStart, song.loopLength);\r\n\r\n        this.append(new ChangeValidateTrackSelection(doc));\r\n        doc.notifier.changed();\r\n        this._didSomething();\r\n\r\n        ColorConfig.resetColors();\r\n    }\r\n}\r\n\r\nexport function comparePatternNotes(a: Note[], b: Note[]): boolean {\r\n    if (a.length != b.length) return false;\r\n\r\n    for (let noteIndex: number = 0; noteIndex < a.length; noteIndex++) {\r\n        const oldNote: Note = a[noteIndex];\r\n        const newNote: Note = b[noteIndex];\r\n        if (newNote.start != oldNote.start || newNote.end != oldNote.end || newNote.pitches.length != oldNote.pitches.length || newNote.pins.length != oldNote.pins.length) {\r\n            return false;\r\n        }\r\n\r\n        for (let pitchIndex: number = 0; pitchIndex < oldNote.pitches.length; pitchIndex++) {\r\n            if (newNote.pitches[pitchIndex] != oldNote.pitches[pitchIndex]) {\r\n                return false;\r\n            }\r\n        }\r\n\r\n        for (let pinIndex: number = 0; pinIndex < oldNote.pins.length; pinIndex++) {\r\n            if (newNote.pins[pinIndex].interval != oldNote.pins[pinIndex].interval || newNote.pins[pinIndex].time != oldNote.pins[pinIndex].time || newNote.pins[pinIndex].size != oldNote.pins[pinIndex].size) {\r\n                return false;\r\n            }\r\n        }\r\n    }\r\n\r\n    return true;\r\n}\r\n\r\nexport function removeDuplicatePatterns(channels: Channel[]): void {\r\n    for (const channel of channels) {\r\n        const newPatterns: Pattern[] = [];\r\n        for (let bar: number = 0; bar < channel.bars.length; bar++) {\r\n            if (channel.bars[bar] == 0) continue;\r\n\r\n            const oldPattern: Pattern = channel.patterns[channel.bars[bar] - 1];\r\n\r\n            let foundMatchingPattern: boolean = false;\r\n            for (let newPatternIndex: number = 0; newPatternIndex < newPatterns.length; newPatternIndex++) {\r\n                const newPattern: Pattern = newPatterns[newPatternIndex];\r\n\r\n                if (!patternsContainSameInstruments(oldPattern.instruments, newPattern.instruments) || newPattern.notes.length != oldPattern.notes.length) {\r\n                    continue;\r\n                }\r\n\r\n                if (comparePatternNotes(oldPattern.notes, newPattern.notes)) {\r\n                    foundMatchingPattern = true;\r\n                    channel.bars[bar] = newPatternIndex + 1;\r\n                    break;\r\n                }\r\n            }\r\n\r\n            if (!foundMatchingPattern) {\r\n                newPatterns.push(oldPattern);\r\n                channel.bars[bar] = newPatterns.length;\r\n            }\r\n        }\r\n\r\n        for (let patternIndex: number = 0; patternIndex < newPatterns.length; patternIndex++) {\r\n            channel.patterns[patternIndex] = newPatterns[patternIndex];\r\n        }\r\n        channel.patterns.length = newPatterns.length;\r\n    }\r\n}\r\n\r\nexport class ChangeTempo extends Change {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super();\r\n        doc.song.tempo = Math.max(Config.tempoMin, Math.min(Config.tempoMax, Math.round(newValue)));\r\n        doc.synth.unsetMod(Config.modulators.dictionary[\"tempo\"].index);\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeEchoDelay extends ChangeInstrumentSlider {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super(doc);\r\n        this._instrument.echoDelay = newValue;\r\n        doc.synth.unsetMod(Config.modulators.dictionary[\"echo delay\"].index, doc.channel, doc.getCurrentInstrument());\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeEchoSustain extends ChangeInstrumentSlider {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super(doc);\r\n        this._instrument.echoSustain = newValue;\r\n        doc.synth.unsetMod(Config.modulators.dictionary[\"echo\"].index, doc.channel, doc.getCurrentInstrument());\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeChorus extends ChangeInstrumentSlider {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super(doc);\r\n        this._instrument.chorus = newValue;\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeReverb extends ChangeInstrumentSlider {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super(doc);\r\n        this._instrument.reverb = newValue;\r\n        doc.synth.unsetMod(Config.modulators.dictionary[\"reverb\"].index, doc.channel, doc.getCurrentInstrument());\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeSongReverb extends Change {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super();\r\n        doc.song.reverb = newValue;\r\n        doc.synth.unsetMod(Config.modulators.dictionary[\"song reverb\"].index);\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeNoteAdded extends UndoableChange {\r\n    private _doc: SongDocument;\r\n    private _pattern: Pattern;\r\n    private _note: Note;\r\n    private _index: number;\r\n    constructor(doc: SongDocument, pattern: Pattern, note: Note, index: number, deletion: boolean = false) {\r\n        super(deletion);\r\n        this._doc = doc;\r\n        this._pattern = pattern;\r\n        this._note = note;\r\n        this._index = index;\r\n        this._didSomething();\r\n        this.redo();\r\n    }\r\n\r\n    protected _doForwards(): void {\r\n        this._pattern.notes.splice(this._index, 0, this._note);\r\n        this._doc.notifier.changed();\r\n    }\r\n\r\n    protected _doBackwards(): void {\r\n        this._pattern.notes.splice(this._index, 1);\r\n        this._doc.notifier.changed();\r\n    }\r\n}\r\n\r\nexport class ChangeNoteLength extends ChangePins {\r\n    constructor(doc: SongDocument | null, note: Note, truncStart: number, truncEnd: number) {\r\n        super(doc, note);\r\n        const continuesLastPattern: boolean = ((this._oldStart < 0 || note.continuesLastPattern) && truncStart == 0);\r\n\r\n        truncStart -= this._oldStart;\r\n        truncEnd -= this._oldStart;\r\n        let setStart: boolean = false;\r\n        let prevSize: number = this._oldPins[0].size;\r\n        let prevInterval: number = this._oldPins[0].interval;\r\n        let pushLastPin: boolean = true;\r\n        let i: number;\r\n        for (i = 0; i < this._oldPins.length; i++) {\r\n            const oldPin: NotePin = this._oldPins[i];\r\n            if (oldPin.time < truncStart) {\r\n                prevSize = oldPin.size;\r\n                prevInterval = oldPin.interval;\r\n            } else {\r\n                if (oldPin.time > truncStart && !setStart) {\r\n                    this._newPins.push(makeNotePin(prevInterval, truncStart, prevSize));\r\n                    setStart = true;\r\n                }\r\n                if (oldPin.time <= truncEnd) {\r\n                    this._newPins.push(makeNotePin(oldPin.interval, oldPin.time, oldPin.size));\r\n                    if (oldPin.time == truncEnd) {\r\n                        pushLastPin = false;\r\n                        break;\r\n                    }\r\n                } else {\r\n                    break;\r\n                }\r\n\r\n            }\r\n\r\n        }\r\n\r\n        if (pushLastPin) this._newPins.push(makeNotePin(this._oldPins[i].interval, truncEnd, this._oldPins[i].size));\r\n\r\n        this._finishSetup(continuesLastPattern);\r\n    }\r\n}\r\n\r\nexport class ChangeNoteTruncate extends ChangeSequence {\r\n    constructor(doc: SongDocument, pattern: Pattern, start: number, end: number, skipNote: Note | null = null, force: boolean = false) {\r\n        super();\r\n        let i: number = 0;\r\n        while (i < pattern.notes.length) {\r\n            const note: Note = pattern.notes[i];\r\n            if (note == skipNote && skipNote != null) {\r\n                i++;\r\n            } else if (note.end <= start) {\r\n                i++;\r\n            } else if (note.start >= end) {\r\n                // Allow out-of-order notes for mods so that all get checked.\r\n                if (!doc.song.getChannelIsMod(doc.channel)) {\r\n                    break;\r\n                } else {\r\n                    i++;\r\n                }\r\n            } else if (note.start < start && note.end > end) {\r\n                if (!doc.song.getChannelIsMod(doc.channel) || force || (skipNote != null && note.pitches[0] == skipNote.pitches[0])) {\r\n                    const copy: Note = note.clone();\r\n                    this.append(new ChangeNoteLength(doc, note, note.start, start));\r\n                    i++;\r\n                    this.append(new ChangeNoteAdded(doc, pattern, copy, i, false));\r\n                    this.append(new ChangeNoteLength(doc, copy, end, copy.end));\r\n                }\r\n                i++;\r\n            } else if (note.start < start) {\r\n                if (!doc.song.getChannelIsMod(doc.channel) || force || (skipNote != null && note.pitches[0] == skipNote.pitches[0]))\r\n                    this.append(new ChangeNoteLength(doc, note, note.start, start));\r\n                i++;\r\n            } else if (note.end > end) {\r\n                if (!doc.song.getChannelIsMod(doc.channel) || force || (skipNote != null && note.pitches[0] == skipNote.pitches[0]))\r\n                    this.append(new ChangeNoteLength(doc, note, end, note.end));\r\n                i++;\r\n            } else {\r\n                if (!doc.song.getChannelIsMod(doc.channel) || force || (skipNote != null && note.pitches[0] == skipNote.pitches[0]))\r\n                    this.append(new ChangeNoteAdded(doc, pattern, note, i, true));\r\n                else\r\n                    i++;\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nclass ChangeSplitNotesAtSelection extends ChangeSequence {\r\n    constructor(doc: SongDocument, pattern: Pattern) {\r\n        super();\r\n        let i: number = 0;\r\n        while (i < pattern.notes.length) {\r\n            const note: Note = pattern.notes[i];\r\n            if (note.start < doc.selection.patternSelectionStart && doc.selection.patternSelectionStart < note.end) {\r\n                const copy: Note = note.clone();\r\n                this.append(new ChangeNoteLength(doc, note, note.start, doc.selection.patternSelectionStart));\r\n                i++;\r\n                this.append(new ChangeNoteAdded(doc, pattern, copy, i, false));\r\n                this.append(new ChangeNoteLength(doc, copy, doc.selection.patternSelectionStart, copy.end));\r\n                // i++; // The second note might be split again at the end of the selection. Check it again.\r\n            } else if (note.start < doc.selection.patternSelectionEnd && doc.selection.patternSelectionEnd < note.end) {\r\n                const copy: Note = note.clone();\r\n                this.append(new ChangeNoteLength(doc, note, note.start, doc.selection.patternSelectionEnd));\r\n                i++;\r\n                this.append(new ChangeNoteAdded(doc, pattern, copy, i, false));\r\n                this.append(new ChangeNoteLength(doc, copy, doc.selection.patternSelectionEnd, copy.end));\r\n                i++;\r\n            } else {\r\n                i++;\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nclass ChangeTransposeNote extends UndoableChange {\r\n    protected _doc: SongDocument;\r\n    protected _note: Note;\r\n    protected _oldStart: number;\r\n    protected _newStart: number;\r\n    protected _oldEnd: number;\r\n    protected _newEnd: number;\r\n    protected _oldPins: NotePin[];\r\n    protected _newPins: NotePin[];\r\n    protected _oldPitches: number[];\r\n    protected _newPitches: number[];\r\n    constructor(doc: SongDocument, channelIndex: number, note: Note, upward: boolean, ignoreScale: boolean = false, octave: boolean = false) {\r\n        super(false);\r\n        this._doc = doc;\r\n        this._note = note;\r\n        this._oldPins = note.pins;\r\n        this._newPins = [];\r\n        this._oldPitches = note.pitches;\r\n        this._newPitches = [];\r\n\r\n        // I'm disabling pitch transposing for noise channels to avoid\r\n        // accidentally messing up noise channels when pitch shifting all\r\n        // channels at once.\r\n        const isNoise: boolean = doc.song.getChannelIsNoise(channelIndex);\r\n        if (isNoise != doc.song.getChannelIsNoise(doc.channel)) return;\r\n\r\n        // Can't transpose mods\r\n        if (doc.song.getChannelIsMod(doc.channel)) return;\r\n\r\n        const maxPitch: number = (isNoise ? Config.drumCount - 1 : Config.maxPitch);\r\n\r\n        for (let i: number = 0; i < this._oldPitches.length; i++) {\r\n            let pitch: number = this._oldPitches[i];\r\n            if (octave && !isNoise) {\r\n                if (upward) {\r\n                    pitch = Math.min(maxPitch, pitch + 12);\r\n                } else {\r\n                    pitch = Math.max(0, pitch - 12);\r\n                }\r\n            } else {\r\n                if (upward) {\r\n                    for (let j: number = pitch + 1; j <= maxPitch; j++) {\r\n                        if (isNoise || ignoreScale || Config.scales[doc.song.scale].flags[j % 12]) {\r\n                            pitch = j;\r\n                            break;\r\n                        }\r\n                    }\r\n                } else {\r\n                    for (let j: number = pitch - 1; j >= 0; j--) {\r\n                        if (isNoise || ignoreScale || Config.scales[doc.song.scale].flags[j % 12]) {\r\n                            pitch = j;\r\n                            break;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            let foundMatch: boolean = false;\r\n            for (let j: number = 0; j < this._newPitches.length; j++) {\r\n                if (this._newPitches[j] == pitch) {\r\n                    foundMatch = true;\r\n                    break;\r\n                }\r\n            }\r\n            if (!foundMatch) this._newPitches.push(pitch);\r\n        }\r\n\r\n        let min: number = 0;\r\n        let max: number = maxPitch;\r\n\r\n        for (let i: number = 1; i < this._newPitches.length; i++) {\r\n            const diff: number = this._newPitches[0] - this._newPitches[i];\r\n            if (min < diff) min = diff;\r\n            if (max > diff + maxPitch) max = diff + maxPitch;\r\n        }\r\n\r\n        for (const oldPin of this._oldPins) {\r\n            let interval: number = oldPin.interval + this._oldPitches[0];\r\n\r\n            if (interval < min) interval = min;\r\n            if (interval > max) interval = max;\r\n            if (octave && !isNoise) {\r\n                if (upward) {\r\n                    interval = Math.min(max, interval + 12);\r\n                } else {\r\n                    interval = Math.max(min, interval - 12);\r\n                }\r\n            } else {\r\n                if (upward) {\r\n                    for (let i: number = interval + 1; i <= max; i++) {\r\n                        if (isNoise || ignoreScale || Config.scales[doc.song.scale].flags[i % 12]) {\r\n                            interval = i;\r\n                            break;\r\n                        }\r\n                    }\r\n                } else {\r\n                    for (let i: number = interval - 1; i >= min; i--) {\r\n                        if (isNoise || ignoreScale || Config.scales[doc.song.scale].flags[i % 12]) {\r\n                            interval = i;\r\n                            break;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            interval -= this._newPitches[0];\r\n            this._newPins.push(makeNotePin(interval, oldPin.time, oldPin.size));\r\n        }\r\n\r\n        if (this._newPins[0].interval != 0) throw new Error(\"wrong pin start interval\");\r\n\r\n        for (let i: number = 1; i < this._newPins.length - 1;) {\r\n            if (this._newPins[i - 1].interval == this._newPins[i].interval &&\r\n                this._newPins[i].interval == this._newPins[i + 1].interval &&\r\n                this._newPins[i - 1].size == this._newPins[i].size &&\r\n                this._newPins[i].size == this._newPins[i + 1].size) {\r\n                this._newPins.splice(i, 1);\r\n            } else {\r\n                i++;\r\n            }\r\n        }\r\n\r\n        this._doForwards();\r\n        this._didSomething();\r\n    }\r\n\r\n    protected _doForwards(): void {\r\n        this._note.pins = this._newPins;\r\n        this._note.pitches = this._newPitches;\r\n        this._doc.notifier.changed();\r\n    }\r\n\r\n    protected _doBackwards(): void {\r\n        this._note.pins = this._oldPins;\r\n        this._note.pitches = this._oldPitches;\r\n        this._doc.notifier.changed();\r\n    }\r\n}\r\n\r\nexport class ChangeTranspose extends ChangeSequence {\r\n    constructor(doc: SongDocument, channelIndex: number, pattern: Pattern, upward: boolean, ignoreScale: boolean = false, octave: boolean = false) {\r\n        super();\r\n        if (doc.selection.patternSelectionActive) {\r\n            this.append(new ChangeSplitNotesAtSelection(doc, pattern));\r\n        }\r\n        for (const note of pattern.notes) {\r\n            if (doc.selection.patternSelectionActive && (note.end <= doc.selection.patternSelectionStart || note.start >= doc.selection.patternSelectionEnd)) {\r\n                continue;\r\n            }\r\n            this.append(new ChangeTransposeNote(doc, channelIndex, note, upward, ignoreScale, octave));\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeTrackSelection extends Change {\r\n    constructor(doc: SongDocument, newX0: number, newX1: number, newY0: number, newY1: number) {\r\n        super();\r\n        doc.selection.boxSelectionX0 = newX0;\r\n        doc.selection.boxSelectionX1 = newX1;\r\n        doc.selection.boxSelectionY0 = newY0;\r\n        doc.selection.boxSelectionY1 = newY1;\r\n        doc.notifier.changed();\r\n        this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangePatternSelection extends UndoableChange {\r\n    private _doc: SongDocument;\r\n    private _oldStart: number;\r\n    private _oldEnd: number;\r\n    private _oldActive: boolean;\r\n    private _newStart: number;\r\n    private _newEnd: number;\r\n    private _newActive: boolean;\r\n\r\n    constructor(doc: SongDocument, newStart: number, newEnd: number) {\r\n        super(false);\r\n        this._doc = doc;\r\n        this._oldStart = doc.selection.patternSelectionStart;\r\n        this._oldEnd = doc.selection.patternSelectionEnd;\r\n        this._oldActive = doc.selection.patternSelectionActive;\r\n        this._newStart = newStart;\r\n        this._newEnd = newEnd;\r\n        this._newActive = newStart < newEnd;\r\n        this._doForwards();\r\n        this._didSomething();\r\n    }\r\n\r\n    protected _doForwards(): void {\r\n        this._doc.selection.patternSelectionStart = this._newStart;\r\n        this._doc.selection.patternSelectionEnd = this._newEnd;\r\n        this._doc.selection.patternSelectionActive = this._newActive;\r\n        this._doc.notifier.changed();\r\n    }\r\n\r\n    protected _doBackwards(): void {\r\n        this._doc.selection.patternSelectionStart = this._oldStart;\r\n        this._doc.selection.patternSelectionEnd = this._oldEnd;\r\n        this._doc.selection.patternSelectionActive = this._oldActive;\r\n        this._doc.notifier.changed();\r\n    }\r\n}\r\n\r\nexport class ChangeDragSelectedNotes extends ChangeSequence {\r\n    constructor(doc: SongDocument, channelIndex: number, pattern: Pattern, parts: number, transpose: number) {\r\n        super();\r\n\r\n        if (parts == 0 && transpose == 0) return;\r\n\r\n        if (doc.selection.patternSelectionActive) {\r\n            this.append(new ChangeSplitNotesAtSelection(doc, pattern));\r\n        }\r\n\r\n        const oldStart: number = doc.selection.patternSelectionStart;\r\n        const oldEnd: number = doc.selection.patternSelectionEnd;\r\n        const newStart: number = Math.max(0, Math.min(doc.song.beatsPerBar * Config.partsPerBeat, oldStart + parts));\r\n        const newEnd: number = Math.max(0, Math.min(doc.song.beatsPerBar * Config.partsPerBeat, oldEnd + parts));\r\n        if (newStart == newEnd) {\r\n            // Just erase the current contents of the selection:\r\n            this.append(new ChangeNoteTruncate(doc, pattern, oldStart, oldEnd, null, true));\r\n        } else if (parts < 0) {\r\n            // Clear space for the dragged notes:\r\n            this.append(new ChangeNoteTruncate(doc, pattern, newStart, Math.min(oldStart, newEnd), null, true));\r\n        } else {\r\n            // Clear space for the dragged notes:\r\n            this.append(new ChangeNoteTruncate(doc, pattern, Math.max(oldEnd, newStart), newEnd, null, true));\r\n        }\r\n\r\n        this.append(new ChangePatternSelection(doc, newStart, newEnd));\r\n        const draggedNotes = [];\r\n        let noteInsertionIndex: number = 0;\r\n        let i: number = 0;\r\n        while (i < pattern.notes.length) {\r\n            const note: Note = pattern.notes[i];\r\n            if (note.end <= oldStart || note.start >= oldEnd) {\r\n                i++;\r\n                if (note.end <= newStart) noteInsertionIndex = i;\r\n            } else {\r\n                draggedNotes.push(note.clone());\r\n                this.append(new ChangeNoteAdded(doc, pattern, note, i, true));\r\n            }\r\n        }\r\n\r\n        for (const note of draggedNotes) {\r\n            note.start += parts;\r\n            note.end += parts;\r\n            if (note.end <= newStart) continue;\r\n            if (note.start >= newEnd) continue;\r\n\r\n            this.append(new ChangeNoteAdded(doc, pattern, note, noteInsertionIndex++, false));\r\n\r\n            this.append(new ChangeNoteLength(doc, note, Math.max(note.start, newStart), Math.min(newEnd, note.end)));\r\n\r\n            for (let i: number = 0; i < Math.abs(transpose); i++) {\r\n                this.append(new ChangeTransposeNote(doc, channelIndex, note, transpose > 0, doc.prefs.notesOutsideScale));\r\n            }\r\n\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeDuplicateSelectedReusedPatterns extends ChangeGroup {\r\n    constructor(doc: SongDocument, barStart: number, barWidth: number, channelStart: number, channelHeight: number) {\r\n        super();\r\n        for (let channelIndex: number = channelStart; channelIndex < channelStart + channelHeight; channelIndex++) {\r\n            const reusablePatterns: Dictionary<number> = {};\r\n\r\n            for (let bar: number = barStart; bar < barStart + barWidth; bar++) {\r\n                const currentPatternIndex: number = doc.song.channels[channelIndex].bars[bar];\r\n                if (currentPatternIndex == 0) continue;\r\n\r\n                if (reusablePatterns[String(currentPatternIndex)] == undefined) {\r\n                    let isUsedElsewhere = false;\r\n                    for (let bar2: number = 0; bar2 < doc.song.barCount; bar2++) {\r\n                        if (bar2 < barStart || bar2 >= barStart + barWidth) {\r\n                            if (doc.song.channels[channelIndex].bars[bar2] == currentPatternIndex) {\r\n                                isUsedElsewhere = true;\r\n                                break;\r\n                            }\r\n                        }\r\n                    }\r\n                    if (isUsedElsewhere) {\r\n                        // Need to duplicate the pattern.\r\n                        const copiedPattern: Pattern = doc.song.getPattern(channelIndex, bar)!;\r\n                        this.append(new ChangePatternNumbers(doc, 0, bar, channelIndex, 1, 1));\r\n                        this.append(new ChangeEnsurePatternExists(doc, channelIndex, bar));\r\n                        const newPattern: Pattern | null = doc.song.getPattern(channelIndex, bar);\r\n                        if (newPattern == null) throw new Error();\r\n                        this.append(new ChangePaste(doc, newPattern, copiedPattern.notes, 0, Config.partsPerBeat * doc.song.beatsPerBar, Config.partsPerBeat * doc.song.beatsPerBar));\r\n\r\n                        // Copy the instruments into the new pattern.\r\n                        newPattern.instruments.length = 0;\r\n                        newPattern.instruments.push(...copiedPattern.instruments);\r\n\r\n                        reusablePatterns[String(currentPatternIndex)] = doc.song.channels[channelIndex].bars[bar];\r\n                    } else {\r\n                        reusablePatterns[String(currentPatternIndex)] = currentPatternIndex;\r\n                    }\r\n                }\r\n\r\n                this.append(new ChangePatternNumbers(doc, reusablePatterns[String(currentPatternIndex)], bar, channelIndex, 1, 1));\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangePatternScale extends Change {\r\n    constructor(doc: SongDocument, pattern: Pattern, scaleMap: number[]) {\r\n        super();\r\n        if (doc.selection.patternSelectionActive) {\r\n            new ChangeSplitNotesAtSelection(doc, pattern);\r\n        }\r\n        const maxPitch: number = Config.maxPitch;\r\n        for (const note of pattern.notes) {\r\n            if (doc.selection.patternSelectionActive && (note.end <= doc.selection.patternSelectionStart || note.start >= doc.selection.patternSelectionEnd)) {\r\n                continue;\r\n            }\r\n\r\n            const newPitches: number[] = [];\r\n            const newPins: NotePin[] = [];\r\n            for (let i: number = 0; i < note.pitches.length; i++) {\r\n                const pitch: number = note.pitches[i];\r\n                const transformedPitch: number = scaleMap[pitch % 12] + (pitch - (pitch % 12));\r\n                if (newPitches.indexOf(transformedPitch) == -1) {\r\n                    newPitches.push(transformedPitch);\r\n                }\r\n            }\r\n\r\n            let min: number = 0;\r\n            let max: number = maxPitch;\r\n\r\n            for (let i: number = 1; i < newPitches.length; i++) {\r\n                const diff: number = newPitches[0] - newPitches[i];\r\n                if (min < diff) min = diff;\r\n                if (max > diff + maxPitch) max = diff + maxPitch;\r\n            }\r\n\r\n            for (const oldPin of note.pins) {\r\n                let interval: number = oldPin.interval + note.pitches[0];\r\n                if (interval < min) interval = min;\r\n                if (interval > max) interval = max;\r\n                const transformedInterval: number = scaleMap[interval % 12] + (interval - (interval % 12));\r\n                newPins.push(makeNotePin(transformedInterval - newPitches[0], oldPin.time, oldPin.size));\r\n            }\r\n\r\n            if (newPins[0].interval != 0) throw new Error(\"wrong pin start interval\");\r\n\r\n            for (let i: number = 1; i < newPins.length - 1;) {\r\n                if (newPins[i - 1].interval == newPins[i].interval &&\r\n                    newPins[i].interval == newPins[i + 1].interval &&\r\n                    newPins[i - 1].size == newPins[i].size &&\r\n                    newPins[i].size == newPins[i + 1].size) {\r\n                    newPins.splice(i, 1);\r\n                } else {\r\n                    i++;\r\n                }\r\n            }\r\n\r\n            note.pitches = newPitches;\r\n            note.pins = newPins;\r\n        }\r\n        this._didSomething();\r\n        doc.notifier.changed();\r\n    }\r\n}\r\n\r\nexport class ChangeVolume extends Change {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super();\r\n        doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()].volume = newValue;\r\n        // Not used currently as mod is implemented as multiplicative.\r\n        //doc.synth.unsetMod(ModSetting.mstInsVolume, doc.channel, doc.getCurrentInstrument());\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeSongTitle extends Change {\r\n    constructor(doc: SongDocument, oldValue: string, newValue: string) {\r\n        super();\r\n        if (newValue.length > 30) {\r\n            newValue = newValue.substring(0, 30);\r\n        }\r\n\r\n        doc.song.title = newValue;\r\n        document.title = newValue + \" - \" + EditorConfig.versionDisplayName;\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeChannelName extends Change {\r\n    constructor(doc: SongDocument, oldValue: string, newValue: string) {\r\n        super();\r\n        if (newValue.length > 15) {\r\n            newValue = newValue.substring(0, 15);\r\n        }\r\n\r\n        doc.song.channels[doc.muteEditorChannel].name = newValue;\r\n        doc.recalcChannelNames = true;\r\n\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangePan extends Change {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super();\r\n        doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()].pan = newValue;\r\n        doc.synth.unsetMod(Config.modulators.dictionary[\"pan\"].index, doc.channel, doc.getCurrentInstrument());\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangePanDelay extends Change {\r\n    constructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n        super();\r\n        doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()].panDelay = newValue;\r\n        doc.notifier.changed();\r\n        if (oldValue != newValue) this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeSizeBend extends UndoableChange {\r\n    private _doc: SongDocument;\r\n    private _note: Note;\r\n    private _oldPins: NotePin[];\r\n    private _newPins: NotePin[];\r\n    constructor(doc: SongDocument, note: Note, bendPart: number, bendSize: number, bendInterval: number, uniformSize: boolean) {\r\n        super(false);\r\n        this._doc = doc;\r\n        this._note = note;\r\n        this._oldPins = note.pins;\r\n        this._newPins = [];\r\n\r\n        let inserted: boolean = false;\r\n\r\n        for (const pin of note.pins) {\r\n            if (pin.time < bendPart) {\r\n                if (uniformSize) {\r\n                    this._newPins.push(makeNotePin(pin.interval, pin.time, bendSize));\r\n                } else {\r\n                    this._newPins.push(pin);\r\n                }\r\n            } else if (pin.time == bendPart) {\r\n                this._newPins.push(makeNotePin(bendInterval, bendPart, bendSize));\r\n                inserted = true;\r\n            } else {\r\n                if (!uniformSize && !inserted) {\r\n                    this._newPins.push(makeNotePin(bendInterval, bendPart, bendSize));\r\n                    inserted = true;\r\n                }\r\n                if (uniformSize) {\r\n                    this._newPins.push(makeNotePin(pin.interval, pin.time, bendSize));\r\n                } else {\r\n                    this._newPins.push(pin);\r\n                }\r\n            }\r\n        }\r\n\r\n        removeRedundantPins(this._newPins);\r\n\r\n        this._doForwards();\r\n        this._didSomething();\r\n    }\r\n\r\n    protected _doForwards(): void {\r\n        this._note.pins = this._newPins;\r\n        this._doc.notifier.changed();\r\n    }\r\n\r\n    protected _doBackwards(): void {\r\n        this._note.pins = this._oldPins;\r\n        this._doc.notifier.changed();\r\n    }\r\n}\r\n\r\nexport class ChangeChipWave extends Change {\r\n    constructor(doc: SongDocument, newValue: number) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        if (instrument.chipWave != newValue) {\r\n            instrument.chipWave = newValue;\r\n            instrument.preset = instrument.type;\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeNoiseWave extends Change {\r\n    constructor(doc: SongDocument, newValue: number) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        if (instrument.chipNoise != newValue) {\r\n            instrument.chipNoise = newValue;\r\n            instrument.preset = instrument.type;\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeAddEnvelope extends Change {\r\n    constructor(doc: SongDocument) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        instrument.addEnvelope(0, 0, 0);\r\n        instrument.preset = instrument.type;\r\n        doc.notifier.changed();\r\n        this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeRemoveEnvelope extends Change {\r\n    constructor(doc: SongDocument, index: number) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        instrument.envelopeCount--;\r\n        for (let i: number = index; i < instrument.envelopeCount; i++) {\r\n            instrument.envelopes[i].target = instrument.envelopes[i + 1].target;\r\n            instrument.envelopes[i].index = instrument.envelopes[i + 1].index;\r\n            instrument.envelopes[i].envelope = instrument.envelopes[i + 1].envelope;\r\n        }\r\n        // TODO: Shift any envelopes that were targeting other envelope indices after the removed one.\r\n        instrument.preset = instrument.type;\r\n        doc.notifier.changed();\r\n        this._didSomething();\r\n    }\r\n}\r\n\r\nexport class ChangeSetEnvelopeTarget extends Change {\r\n    constructor(doc: SongDocument, envelopeIndex: number, target: number, targetIndex: number) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        const oldTarget: number = instrument.envelopes[envelopeIndex].target;\r\n        const oldIndex: number = instrument.envelopes[envelopeIndex].index;\r\n        if (oldTarget != target || oldIndex != targetIndex) {\r\n            instrument.envelopes[envelopeIndex].target = target;\r\n            instrument.envelopes[envelopeIndex].index = targetIndex;\r\n            instrument.preset = instrument.type;\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n\r\nexport class ChangeSetEnvelopeType extends Change {\r\n    constructor(doc: SongDocument, envelopeIndex: number, newValue: number) {\r\n        super();\r\n        const instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n        const oldValue: number = instrument.envelopes[envelopeIndex].envelope;\r\n        if (oldValue != newValue) {\r\n            instrument.envelopes[envelopeIndex].envelope = newValue;\r\n            instrument.preset = instrument.type;\r\n            doc.notifier.changed();\r\n            this._didSomething();\r\n        }\r\n    }\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { Config } from \"../synth/SynthConfig\";\r\nimport { HTML } from \"imperative-html/dist/esm/elements-strict\";\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { Prompt } from \"./Prompt\";\r\nimport { ChangeBeatsPerBar } from \"./changes\";\r\n\r\n\tconst {button, div, span, h2, input, br, select, option} = HTML;\r\n\r\nexport class BeatsPerBarPrompt implements Prompt {\r\n\tprivate readonly _beatsStepper: HTMLInputElement = input({style: \"width: 3em; margin-left: 1em;\", type: \"number\", step: \"1\"});\r\n\tprivate readonly _conversionStrategySelect: HTMLSelectElement = select({style: \"width: 100%;\"},\r\n\t\toption({value: \"splice\"}, \"Splice beats at end of bars.\"),\r\n\t\toption({value: \"stretch\"}, \"Stretch notes to fit in bars.\"),\r\n\t\toption({value: \"overflow\"}, \"Overflow notes across bars.\"),\r\n\t);\r\n\tprivate readonly _cancelButton: HTMLButtonElement = button({class: \"cancelButton\"});\r\n\tprivate readonly _okayButton: HTMLButtonElement = button({class: \"okayButton\", style: \"width:45%;\"}, \"Okay\");\r\n\t\r\n\tpublic readonly container: HTMLDivElement = div({class: \"prompt noSelection\", style: \"width: 250px;\"},\r\n\t\th2(\"Beats Per Bar\"),\r\n\t\tdiv({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\tdiv({style: \"text-align: right;\"},\r\n\t\t\t\t\"Beats per bar:\",\r\n\t\t\t\tbr(),\r\n\t\t\t\tspan({ style: \"font-size: smaller; color: ${ColorConfig.secondaryText};\" }, \"(Multiples of 3 or 4 are recommended)\"),\r\n\t\t\t),\r\n\t\t\tthis._beatsStepper,\r\n\t\t),\r\n\t\tdiv({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\tdiv({class: \"selectContainer\", style: \"width: 100%;\"}, this._conversionStrategySelect),\r\n\t\t),\r\n\t\tdiv({style: \"display: flex; flex-direction: row-reverse; justify-content: space-between;\"},\r\n\t\t\tthis._okayButton,\r\n\t\t),\r\n\t\tthis._cancelButton,\r\n\t);\r\n\t\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis._beatsStepper.value = this._doc.song.beatsPerBar + \"\";\r\n\t\tthis._beatsStepper.min = Config.beatsPerBarMin + \"\";\r\n\t\tthis._beatsStepper.max = Config.beatsPerBarMax + \"\";\r\n\t\t\t\r\n\t\tconst lastStrategy: string | null = window.localStorage.getItem(\"beatCountStrategy\");\r\n\t\tif (lastStrategy != null) {\r\n\t\t\tthis._conversionStrategySelect.value = lastStrategy;\r\n\t\t}\r\n\t\t\t\r\n\t\tthis._beatsStepper.select();\r\n\t\t\tsetTimeout(()=>this._beatsStepper.focus());\r\n\t\t\t\r\n\t\tthis._okayButton.addEventListener(\"click\", this._saveChanges);\r\n\t\tthis._cancelButton.addEventListener(\"click\", this._close);\r\n\t\tthis._beatsStepper.addEventListener(\"keypress\", BeatsPerBarPrompt._validateKey);\r\n\t\tthis._beatsStepper.addEventListener(\"blur\", BeatsPerBarPrompt._validateNumber);\r\n\t\tthis.container.addEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\t\t\r\n\t\tprivate _close = (): void => { \r\n\t\tthis._doc.undo();\r\n\t}\r\n\t\t\r\n\t\tpublic cleanUp = (): void => { \r\n\t\tthis._okayButton.removeEventListener(\"click\", this._saveChanges);\r\n\t\tthis._cancelButton.removeEventListener(\"click\", this._close);\r\n\t\tthis._beatsStepper.removeEventListener(\"keypress\", BeatsPerBarPrompt._validateKey);\r\n\t\tthis._beatsStepper.removeEventListener(\"blur\", BeatsPerBarPrompt._validateNumber);\r\n\t\tthis.container.removeEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\t\t\r\n\tprivate _whenKeyPressed = (event: KeyboardEvent): void => {\r\n\t\t\tif ((<Element> event.target).tagName != \"BUTTON\" && event.keyCode == 13) { // Enter key\r\n\t\t\tthis._saveChanges();\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tprivate static _validateKey(event: KeyboardEvent): boolean {\r\n\t\tconst charCode = (event.which) ? event.which : event.keyCode;\r\n\t\tif (charCode != 46 && charCode > 31 && (charCode < 48 || charCode > 57)) {\r\n\t\t\tevent.preventDefault();\r\n\t\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\t\t\r\n\tprivate static _validateNumber(event: Event): void {\r\n\t\tconst input: HTMLInputElement = <HTMLInputElement>event.target;\r\n\t\tinput.value = String(BeatsPerBarPrompt._validate(input));\r\n\t}\r\n\t\t\r\n\tprivate static _validate(input: HTMLInputElement): number {\r\n\t\treturn Math.floor(Math.max(Number(input.min), Math.min(Number(input.max), Number(input.value))));\r\n\t}\r\n\t\t\r\n\tprivate _saveChanges = (): void => {\r\n\t\twindow.localStorage.setItem(\"beatCountStrategy\", this._conversionStrategySelect.value);\r\n\t\tthis._doc.prompt = null;\r\n\t\tthis._doc.record(new ChangeBeatsPerBar(this._doc, BeatsPerBarPrompt._validate(this._beatsStepper), this._conversionStrategySelect.value), true);\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { Config } from \"../synth/SynthConfig\";\r\nimport { HTML } from \"imperative-html/dist/esm/elements-strict\";\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { Prompt } from \"./Prompt\";\r\nimport { ChangeGroup } from \"./Change\";\r\nimport {ChangePatternsPerChannel, ChangeInstrumentsFlags, ChangeChannelCount} from \"./changes\";\r\n\r\nconst {button, div, label, br, h2, input} = HTML;\r\n\r\nexport class ChannelSettingsPrompt implements Prompt {\r\n\t\tprivate readonly _patternsStepper: HTMLInputElement = input({style: \"width: 3em; margin-left: 1em;\", type: \"number\", step: \"1\"});\r\n\t\tprivate readonly _pitchChannelStepper: HTMLInputElement = input({style: \"width: 3em; margin-left: 1em;\", type: \"number\", step: \"1\"});\r\n\t\tprivate readonly _drumChannelStepper: HTMLInputElement = input({style: \"width: 3em; margin-left: 1em;\", type: \"number\", step: \"1\"});\r\n\t\tprivate readonly _modChannelStepper: HTMLInputElement = input({ style: \"width: 3em; margin-left: 1em;\", type: \"number\", step: \"1\" });\r\n\t\tprivate readonly _layeredInstrumentsBox: HTMLInputElement = input({style: \"width: 3em; margin-left: 1em;\", type: \"checkbox\"});\r\n\t\tprivate readonly _patternInstrumentsBox: HTMLInputElement = input({style: \"width: 3em; margin-left: 1em;\", type: \"checkbox\"});\r\n\r\n\t\tprivate readonly _cancelButton: HTMLButtonElement = button({class: \"cancelButton\"});\r\n\t\tprivate readonly _okayButton: HTMLButtonElement = button({class: \"okayButton\", style: \"width:45%;\"}, \"Okay\");\r\n\t\t\r\n\tpublic readonly container: HTMLDivElement = div({class: \"prompt noSelection\", style: \"width: 250px; text-align: right;\"},\r\n\t\th2(\"Channel Settings\"),\r\n\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\"Pitch channels:\",\r\n\t\t\tthis._pitchChannelStepper,\r\n\t\t),\r\n\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\"Drum channels:\",\r\n\t\t\tthis._drumChannelStepper,\r\n\t\t),\r\n\t\tdiv({ style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\" },\r\n\t\t\t\"Mod channels:\",\r\n\t\t\tthis._modChannelStepper,\r\n\t\t),\r\n\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\"Available patterns per channel:\",\r\n\t\t\tthis._patternsStepper,\r\n\t\t),\r\n\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\"Simultaneous instruments\",\r\n\t\t\tbr(),\r\n\t\t\t\"per channel:\",\r\n\t\t\tthis._layeredInstrumentsBox,\r\n\t\t),\r\n\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\"Different instruments\",\r\n\t\t\tbr(),\r\n\t\t\t\"per pattern:\",\r\n\t\t\tthis._patternInstrumentsBox,\r\n\t\t),\r\n\t\tlabel({style: \"display: flex; flex-direction: row-reverse; justify-content: space-between;\"},\r\n\t\t\tthis._okayButton,\r\n\t\t),\r\n\t\tthis._cancelButton,\r\n\t);\r\n\t\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis._patternsStepper.value = this._doc.song.patternsPerChannel + \"\";\r\n\t\tthis._patternsStepper.min = \"1\";\r\n\t\tthis._patternsStepper.max = Config.barCountMax + \"\";\r\n\t\t\t\r\n\t\t\t\r\n\t\tthis._pitchChannelStepper.value = this._doc.song.pitchChannelCount + \"\";\r\n\t\tthis._pitchChannelStepper.min = Config.pitchChannelCountMin + \"\";\r\n\t\tthis._pitchChannelStepper.max = Config.pitchChannelCountMax + \"\";\r\n\t\t\t\r\n\t\tthis._drumChannelStepper.value = this._doc.song.noiseChannelCount + \"\";\r\n\t\tthis._drumChannelStepper.min = Config.noiseChannelCountMin + \"\";\r\n\t\tthis._drumChannelStepper.max = Config.noiseChannelCountMax + \"\";\r\n\t\t\t\r\n\t\tthis._modChannelStepper.value = this._doc.song.modChannelCount + \"\";\r\n\t\tthis._modChannelStepper.min = Config.modChannelCountMin + \"\";\r\n\t\tthis._modChannelStepper.max = Config.modChannelCountMax + \"\";\r\n\t\t\r\n\t\tthis._layeredInstrumentsBox.checked = this._doc.song.layeredInstruments;\r\n\t\tthis._patternInstrumentsBox.checked = this._doc.song.patternInstruments;\r\n\t\tthis._pitchChannelStepper.select();\r\n\t\t\tsetTimeout(()=>this._pitchChannelStepper.focus());\r\n\t\t\t\r\n\t\tthis._okayButton.addEventListener(\"click\", this._saveChanges);\r\n\t\tthis._cancelButton.addEventListener(\"click\", this._close);\r\n\t\tthis._patternsStepper.addEventListener(\"keypress\", ChannelSettingsPrompt._validateKey);\r\n\t\tthis._pitchChannelStepper.addEventListener(\"keypress\", ChannelSettingsPrompt._validateKey);\r\n\t\tthis._drumChannelStepper.addEventListener(\"keypress\", ChannelSettingsPrompt._validateKey);\r\n\t\tthis._modChannelStepper.addEventListener(\"keypress\", ChannelSettingsPrompt._validateKey);\r\n\t\tthis._patternsStepper.addEventListener(\"blur\", this._validateNumber);\r\n\t\tthis._pitchChannelStepper.addEventListener(\"blur\", this._validateNumber);\r\n\t\tthis._drumChannelStepper.addEventListener(\"blur\", this._validateNumber);\r\n\t\tthis._modChannelStepper.addEventListener(\"blur\", this._validateNumber);\r\n\t\tthis.container.addEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\t\t\r\n\t\tprivate _close = (): void => { \r\n\t\tthis._doc.undo();\r\n\t}\r\n\t\t\r\n\t\tpublic cleanUp = (): void => { \r\n\t\tthis._okayButton.removeEventListener(\"click\", this._saveChanges);\r\n\t\tthis._cancelButton.removeEventListener(\"click\", this._close);\r\n\t\tthis._patternsStepper.removeEventListener(\"keypress\", ChannelSettingsPrompt._validateKey);\r\n\t\tthis._pitchChannelStepper.removeEventListener(\"keypress\", ChannelSettingsPrompt._validateKey);\r\n\t\tthis._drumChannelStepper.removeEventListener(\"keypress\", ChannelSettingsPrompt._validateKey);\r\n\t\tthis._modChannelStepper.removeEventListener(\"keypress\", ChannelSettingsPrompt._validateKey);\r\n\t\tthis._patternsStepper.removeEventListener(\"blur\", this._validateNumber);\r\n\t\tthis._pitchChannelStepper.removeEventListener(\"blur\", this._validateNumber);\r\n\t\tthis._drumChannelStepper.removeEventListener(\"blur\", this._validateNumber);\r\n\t\tthis._modChannelStepper.removeEventListener(\"blur\", this._validateNumber);\r\n\t\tthis.container.removeEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\t\t\r\n\tprivate _whenKeyPressed = (event: KeyboardEvent): void => {\r\n\t\t\tif ((<Element> event.target).tagName != \"BUTTON\" && event.keyCode == 13) { // Enter key\r\n\t\t\tthis._saveChanges();\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tprivate static _validateKey(event: KeyboardEvent): boolean {\r\n\t\tconst charCode = (event.which) ? event.which : event.keyCode;\r\n\t\tif (charCode != 46 && charCode > 31 && (charCode < 48 || charCode > 57)) {\r\n\t\t\tevent.preventDefault();\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\t\t\r\n\tprivate _validateNumber = (event: Event): void => {\r\n\t\tconst input: HTMLInputElement = <HTMLInputElement>event.target;\r\n\t\tinput.value = String(ChannelSettingsPrompt._validate(input));\r\n\t}\r\n\t\t\r\n\tprivate static _validate(input: HTMLInputElement): number {\r\n\t\treturn Math.floor(Math.max(Number(input.min), Math.min(Number(input.max), Number(input.value))));\r\n\t}\r\n\t\t\r\n\tprivate _saveChanges = (): void => {\r\n\t\tconst group: ChangeGroup = new ChangeGroup();\r\n\t\tgroup.append(new ChangeInstrumentsFlags(this._doc, this._layeredInstrumentsBox.checked, this._patternInstrumentsBox.checked));\r\n\t\tgroup.append(new ChangePatternsPerChannel(this._doc, ChannelSettingsPrompt._validate(this._patternsStepper)));\r\n\t\tgroup.append(new ChangeChannelCount(this._doc, ChannelSettingsPrompt._validate(this._pitchChannelStepper), ChannelSettingsPrompt._validate(this._drumChannelStepper), ChannelSettingsPrompt._validate(this._modChannelStepper)));\r\n\t\tthis._doc.prompt = null;\r\n\t\tthis._doc.record(group, true);\r\n\t}\r\n}\r\n","// Copyright (C) 2020 John Nesky, distributed under the MIT license.\r\n\r\nimport { HTML, SVG } from \"imperative-html/dist/esm/elements-strict\";\r\nimport { Prompt } from \"./Prompt\";\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { ColorConfig } from \"./ColorConfig\";\r\nimport { ChangeCustomWave } from \"./changes\";\r\nimport { SongEditor } from \"./SongEditor\";\r\n\r\n//namespace beepbox {\r\nconst { button, div, h2 } = HTML;\r\n\r\nexport class CustomChipPromptCanvas {\r\n\tprivate readonly _doc: SongDocument;\r\n\tprivate _mouseX: number = 0;\r\n\tprivate _mouseY: number = 0;\r\n\tprivate _lastIndex: number = 0;\r\n\tprivate _lastAmp: number = 0;\r\n\tprivate _mouseDown: boolean = false;\r\n\tpublic chipData: Float32Array = new Float32Array(64);\r\n\tpublic startingChipData: Float32Array = new Float32Array(64);\r\n\tprivate _undoHistoryState: number = 0;\r\n\tprivate _changeQueue: Float32Array[] = [];\r\n\tprivate readonly _editorWidth: number = 768; // 64*12\r\n\tprivate readonly _editorHeight: number = 294; // 49*6\r\n\tprivate readonly _fill: SVGPathElement = SVG.path({ fill: ColorConfig.uiWidgetBackground, \"pointer-events\": \"none\" });\r\n\tprivate readonly _ticks: SVGSVGElement = SVG.svg({ \"pointer-events\": \"none\" });\r\n\tprivate readonly _subticks: SVGSVGElement = SVG.svg({ \"pointer-events\": \"none\" });\r\n\tprivate readonly _blocks: SVGSVGElement = SVG.svg({ \"pointer-events\": \"none\" });\r\n\tprivate readonly _svg: SVGSVGElement = SVG.svg({ style: `background-color: ${ColorConfig.editorBackground}; touch-action: none; overflow: visible;`, width: \"100%\", height: \"100%\", viewBox: \"0 0 \" + this._editorWidth + \" \" + this._editorHeight, preserveAspectRatio: \"none\" },\r\n\t\tthis._fill,\r\n\t\tthis._ticks,\r\n\t\tthis._subticks,\r\n\t\tthis._blocks,\r\n\t);\r\n\r\n\tpublic readonly container: HTMLElement = HTML.div({ class: \"\", style: \"height: 294px; width: 768px; padding-bottom: 1.5em;\" }, this._svg);\r\n\r\n\tconstructor(doc: SongDocument) {\r\n\r\n\t\tthis._doc = doc;\r\n\r\n\t\tfor (let i: number = 0; i <= 4; i += 2) {\r\n\t\t\tthis._ticks.appendChild(SVG.rect({ fill: ColorConfig.tonic, x: (i * this._editorWidth / 4) - 1, y: 0, width: 2, height: this._editorHeight }));\r\n\t\t}\r\n\t\tfor (let i: number = 1; i <= 8; i++) {\r\n\t\t\tthis._subticks.appendChild(SVG.rect({ fill: ColorConfig.fifthNote, x: (i * this._editorWidth / 8) - 1, y: 0, width: 1, height: this._editorHeight }));\r\n\t\t}\r\n\r\n\t\t// Horiz. ticks\r\n\t\tthis._ticks.appendChild(SVG.rect({ fill: ColorConfig.tonic, x: 0, y: (this._editorHeight / 2) - 1, width: this._editorWidth, height: 2 }));\r\n\t\tfor (let i: number = 0; i < 3; i++) {\r\n\t\t\tthis._subticks.appendChild(SVG.rect({ fill: ColorConfig.fifthNote, x: 0, y: i * 8 * (this._editorHeight / 49), width: this._editorWidth, height: 1 }));\r\n\t\t\tthis._subticks.appendChild(SVG.rect({ fill: ColorConfig.fifthNote, x: 0, y: this._editorHeight - 1 - i * 8 * (this._editorHeight / 49), width: this._editorWidth, height: 1 }));\r\n\t\t}\r\n\r\n\r\n\t\tlet col: string = ColorConfig.getChannelColor(this._doc.song, this._doc.channel).primaryNote;\r\n\r\n\t\tfor (let i: number = 0; i <= 64; i++) {\r\n\t\t\tlet val: number = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()].customChipWave[i];\r\n\t\t\tthis.chipData[i] = val;\r\n\t\t\tthis.startingChipData[i] = val;\r\n\t\t\tthis._blocks.appendChild(SVG.rect({ fill: col, x: (i * this._editorWidth / 64), y: (val + 24) * (this._editorHeight / 49), width: this._editorWidth / 64, height: this._editorHeight / 49 }));\r\n\t\t}\r\n\r\n\t\t// Record initial state of the chip data queue\r\n\t\tthis._storeChange();\r\n\r\n\t\tthis.container.addEventListener(\"mousedown\", this._whenMousePressed);\r\n\t\tdocument.addEventListener(\"mousemove\", this._whenMouseMoved);\r\n\t\tdocument.addEventListener(\"mouseup\", this._whenCursorReleased);\r\n\r\n\t\tthis.container.addEventListener(\"touchstart\", this._whenTouchPressed);\r\n\t\tthis.container.addEventListener(\"touchmove\", this._whenTouchMoved);\r\n\t\tthis.container.addEventListener(\"touchend\", this._whenCursorReleased);\r\n\t\tthis.container.addEventListener(\"touchcancel\", this._whenCursorReleased);\r\n\r\n\t\tthis._svg.addEventListener(\"keydown\", this._whenKeyPressed);\r\n\t\tthis.container.addEventListener(\"keydown\", this._whenKeyPressed);\r\n\r\n\t}\r\n\r\n\tprivate _storeChange = (): void => {\r\n\t\t// Check if change is unique compared to the current history state\r\n\t\tvar sameCheck = true;\r\n\t\tif (this._changeQueue.length > 0) {\r\n\t\t\tfor (var i = 0; i < 64; i++) {\r\n\t\t\t\tif (this._changeQueue[this._undoHistoryState][i] != this.chipData[i]) {\r\n\t\t\t\t\tsameCheck = false; i = 64;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (sameCheck == false || this._changeQueue.length == 0) {\r\n\r\n\t\t\t// Create new branch in history, removing all after this in time\r\n\t\t\tthis._changeQueue.splice(0, this._undoHistoryState);\r\n\r\n\t\t\tthis._undoHistoryState = 0;\r\n\r\n\t\t\tthis._changeQueue.unshift(this.chipData.slice());\r\n\r\n\t\t\t// 32 undo max\r\n\t\t\tif (this._changeQueue.length > 32) {\r\n\t\t\t\tthis._changeQueue.pop();\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tpublic undo = (): void => {\r\n\t\t// Go backward, if there is a change to go back to\r\n\t\tif (this._undoHistoryState < this._changeQueue.length - 1) {\r\n\t\t\tthis._undoHistoryState++;\r\n\t\t\tthis.chipData = this._changeQueue[this._undoHistoryState].slice();\r\n\t\t\tnew ChangeCustomWave(this._doc, this.chipData);\r\n\t\t\tthis.render();\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tpublic redo = (): void => {\r\n\t\t// Go forward, if there is a change to go to\r\n\t\tif (this._undoHistoryState > 0) {\r\n\t\t\tthis._undoHistoryState--;\r\n\t\t\tthis.chipData = this._changeQueue[this._undoHistoryState].slice();\r\n\t\t\tnew ChangeCustomWave(this._doc, this.chipData);\r\n\t\t\tthis.render();\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tprivate _whenKeyPressed = (event: KeyboardEvent): void => {\r\n\t\tif (event.keyCode == 90) { // z\r\n\t\t\tthis.undo();\r\n\t\t\tevent.stopPropagation();\r\n\t\t}\r\n\t\telse if (event.keyCode == 89) { // y\r\n\t\t\tthis.redo();\r\n\t\t\tevent.stopPropagation();\r\n\t\t}\r\n\t}\r\n\r\n\tprivate _whenMousePressed = (event: MouseEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = ((event.clientX || event.pageX) - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._lastIndex = -1;\r\n\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\r\n\tprivate _whenTouchPressed = (event: TouchEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.touches[0].clientX - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._lastIndex = -1;\r\n\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\r\n\tprivate _whenMouseMoved = (event: MouseEvent): void => {\r\n\t\tif (this.container.offsetParent == null) return;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = ((event.clientX || event.pageX) - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\r\n\tprivate _whenTouchMoved = (event: TouchEvent): void => {\r\n\t\tif (this.container.offsetParent == null) return;\r\n\t\tif (!this._mouseDown) return;\r\n\t\tevent.preventDefault();\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.touches[0].clientX - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\r\n\tprivate _whenCursorMoved(): void {\r\n\t\tif (this._mouseDown) {\r\n\t\t\tconst index: number = Math.min(63, Math.max(0, Math.floor(this._mouseX * 64 / this._editorWidth)));\r\n\t\t\tconst amp: number = Math.min(48, Math.max(0, Math.floor(this._mouseY * 49 / this._editorHeight)));\r\n\r\n\t\t\t// Paint between mouse drag indices unless a click just happened.\r\n\t\t\tif (this._lastIndex != -1 && this._lastIndex != index) {\r\n\t\t\t\tvar lowest = index;\r\n\t\t\t\tvar highest = this._lastIndex;\r\n\t\t\t\tvar startingAmp = amp;\r\n\t\t\t\tvar endingAmp = this._lastAmp;\r\n\t\t\t\tif (this._lastIndex < index) {\r\n\t\t\t\t\tlowest = this._lastIndex;\r\n\t\t\t\t\thighest = index;\r\n\t\t\t\t\tstartingAmp = this._lastAmp;\r\n\t\t\t\t\tendingAmp = amp;\r\n\t\t\t\t}\r\n\t\t\t\tfor (var i = lowest; i <= highest; i++) {\r\n\t\t\t\t\tconst medAmp: number = Math.round(startingAmp + (endingAmp - startingAmp) * ((i - lowest) / (highest - lowest)));\r\n\t\t\t\t\tthis.chipData[i] = medAmp - 24;\r\n\t\t\t\t\tthis._blocks.children[i].setAttribute(\"y\", \"\" + (medAmp * (this._editorHeight / 49)));\r\n\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tthis.chipData[index] = amp - 24;\r\n\t\t\t\tthis._blocks.children[index].setAttribute(\"y\", \"\" + (amp * (this._editorHeight / 49)));\r\n\r\n\t\t\t}\r\n\r\n\r\n\t\t\t// Make a change to the data but don't record it, since this prompt uses its own undo/redo queue\r\n\t\t\tnew ChangeCustomWave(this._doc, this.chipData);\r\n\r\n\t\t\tthis._lastIndex = index;\r\n\t\t\tthis._lastAmp = amp;\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tprivate _whenCursorReleased = (event: Event): void => {\r\n\t\t// Add current data into queue, if it is unique from last data\r\n\t\tthis._storeChange();\r\n\t\tthis._mouseDown = false;\r\n\t}\r\n\r\n\tpublic render(): void {\r\n\t\tfor (var i = 0; i < 64; i++) {\r\n\t\t\tthis._blocks.children[i].setAttribute(\"y\", \"\" + ((this.chipData[i] + 24) * (this._editorHeight / 49)));\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class CustomChipPrompt implements Prompt {\r\n\r\n\tpublic customChipCanvas: CustomChipPromptCanvas = new CustomChipPromptCanvas(this._doc);\r\n\r\n\tpublic readonly _playButton: HTMLButtonElement = button({ style: \"width: 55%;\", type: \"button\" });\r\n\r\n\tprivate readonly _cancelButton: HTMLButtonElement = button({ class: \"cancelButton\" });\r\n\tprivate readonly _okayButton: HTMLButtonElement = button({ class: \"okayButton\", style: \"width:45%;\" }, \"Okay\");\r\n\r\n\tpublic readonly container: HTMLDivElement = div({ class: \"prompt noSelection\", style: \"width: 600px;\" },\r\n\t\th2(\"Edit Custom Chip Instrument\"),\r\n\t\tdiv({ style: \"display: flex; width: 55%; align-self: center; flex-direction: row; align-items: center; justify-content: center;\" },\r\n\t\t\tthis._playButton,\r\n\t\t),\r\n\t\tdiv({ style: \"display: flex; flex-direction: row; align-items: center; justify-content: center;\" },\r\n\t\t\tthis.customChipCanvas.container,\r\n\t\t),\r\n\t\tdiv({ style: \"display: flex; flex-direction: row-reverse; justify-content: space-between;\" },\r\n\t\t\tthis._okayButton,\r\n\t\t),\r\n\t\tthis._cancelButton,\r\n\t);\r\n\r\n\tconstructor(private _doc: SongDocument, private _songEditor: SongEditor) {\r\n\r\n\t\tthis._okayButton.addEventListener(\"click\", this._saveChanges);\r\n\t\tthis._cancelButton.addEventListener(\"click\", this._close);\r\n\t\tthis.container.addEventListener(\"keydown\", this.whenKeyPressed);\r\n\t\tthis._playButton.addEventListener(\"click\", this._togglePlay);\r\n\t\tthis.updatePlayButton();\r\n\r\n\t\tsetTimeout(() => this._playButton.focus());\r\n\r\n\r\n\t\tthis.customChipCanvas.render();\r\n\t}\r\n\r\n\tprivate _togglePlay = (): void => {\r\n\t\tthis._songEditor.togglePlay();\r\n\t\tthis.updatePlayButton();\r\n\t}\r\n\r\n\tpublic updatePlayButton(): void {\r\n\t\tif (this._doc.synth.playing) {\r\n\t\t\tthis._playButton.classList.remove(\"playButton\");\r\n\t\t\tthis._playButton.classList.add(\"pauseButton\");\r\n\t\t\tthis._playButton.title = \"Pause (Space)\";\r\n\t\t\tthis._playButton.innerText = \"Pause\";\r\n\t\t} else {\r\n\t\t\tthis._playButton.classList.remove(\"pauseButton\");\r\n\t\t\tthis._playButton.classList.add(\"playButton\");\r\n\t\t\tthis._playButton.title = \"Play (Space)\";\r\n\t\t\tthis._playButton.innerText = \"Play\";\r\n\t\t}\r\n\t}\r\n\r\n\tprivate _close = (): void => {\r\n\t\tthis._doc.prompt = null;\r\n\t\tthis._doc.undo();\r\n\t}\r\n\r\n\tpublic cleanUp = (): void => {\r\n\t\tthis._okayButton.removeEventListener(\"click\", this._saveChanges);\r\n\t\tthis._cancelButton.removeEventListener(\"click\", this._close);\r\n\t\tthis.container.removeEventListener(\"keydown\", this.whenKeyPressed);\r\n\r\n\t\tthis._playButton.removeEventListener(\"click\", this._togglePlay);\r\n\t}\r\n\r\n\tpublic whenKeyPressed = (event: KeyboardEvent): void => {\r\n\t\tif ((<Element>event.target).tagName != \"BUTTON\" && event.keyCode == 13) { // Enter key\r\n\t\t\tthis._saveChanges();\r\n\t\t}\r\n\t\telse if (event.keyCode == 32) {\r\n\t\t\tthis._togglePlay();\r\n\t\t\tevent.preventDefault();\r\n\t\t}\r\n\t\telse if (event.keyCode == 90) { // z\r\n\t\t\tthis.customChipCanvas.undo();\r\n\t\t\tevent.stopPropagation();\r\n\t\t}\r\n\t\telse if (event.keyCode == 89) { // y\r\n\t\t\tthis.customChipCanvas.redo();\r\n\t\t\tevent.stopPropagation();\r\n\t\t}\r\n\t\telse if (event.keyCode == 219) { // [\r\n\t\t\tthis._doc.synth.goToPrevBar();\r\n\t\t}\r\n\t\telse if (event.keyCode == 221) { // ]\r\n\t\t\tthis._doc.synth.goToNextBar();\r\n\t\t}\r\n\t}\r\n\r\n\tprivate _saveChanges = (): void => {\r\n\t\tthis._doc.prompt = null;\r\n\t\t// Restore custom chip to starting values\r\n\t\tnew ChangeCustomWave(this._doc, this.customChipCanvas.startingChipData);\r\n\t\tthis._doc.record(new ChangeCustomWave(this._doc, this.customChipCanvas.chipData), true);\r\n\t}\r\n}\r\n//}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { FilterCoefficients, FrequencyResponse } from \"../synth/filtering\";\r\nimport { FilterType, Config } from \"../synth/SynthConfig\";\r\nimport { FilterSettings, FilterControlPoint, Instrument } from \"../synth/synth\";\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { HTML, SVG } from \"imperative-html/dist/esm/elements-strict\";\r\nimport { ColorConfig } from \"./ColorConfig\";\r\nimport { ChangeSequence, UndoableChange } from \"./Change\";\r\nimport { ChangeFilterAddPoint, ChangeFilterMovePoint, ChangeFilterSettings } from \"./changes\";\r\nimport { prettyNumber } from \"./EditorConfig\";\r\n\r\nexport class FilterEditor {\r\n    private _editorWidth: number = 120;\r\n    private _editorHeight: number = 26;\r\n    private readonly _responsePath: SVGPathElement = SVG.path({ fill: ColorConfig.uiWidgetBackground, \"pointer-events\": \"none\" });\r\n    //private readonly _octaves: SVGSVGElement = SVG.svg({\"pointer-events\": \"none\", overflow: \"visible\"});\r\n    private _indicators: SVGTextElement[] = [];\r\n    private _subFilters: FilterSettings[] = [];\r\n    private readonly _controlPointPath: SVGPathElement = SVG.path({ fill: \"currentColor\", \"pointer-events\": \"none\" });\r\n    private readonly _dottedLinePath: SVGPathElement = SVG.path({ fill: \"none\", stroke: \"currentColor\", \"stroke-width\": 1, \"stroke-dasharray\": \"3, 2\", \"pointer-events\": \"none\" });\r\n    private readonly _highlight: SVGCircleElement = SVG.circle({ fill: \"white\", stroke: \"none\", \"pointer-events\": \"none\", r: 4 });\r\n    private readonly _svg: SVGSVGElement = SVG.svg({ style: `background-color: ${ColorConfig.editorBackground}; touch-action: none;`, width: \"100%\", height: \"100%\", viewBox: \"0 0 \" + this._editorWidth + \" \" + this._editorHeight, preserveAspectRatio: \"none\" },\r\n        this._responsePath,\r\n        //this._octaves,\r\n        this._dottedLinePath,\r\n        this._highlight,\r\n        this._controlPointPath,\r\n    );\r\n    private selfUndoSettings: String[] = [];\r\n    private selfUndoHistoryPos: number = 0;\r\n    private readonly _label: HTMLDivElement = HTML.div({ style: \"position: absolute; bottom: 0; left: 2px; font-size: 8px; line-height: 1; pointer-events: none;\" });\r\n\r\n    public coordText: HTMLElement | null = null;\r\n    public readonly container: HTMLElement = HTML.div({ class: \"filterEditor\", style: \"height: 100%; position: relative;\" },\r\n        this._svg,\r\n        this._label,\r\n    );\r\n    private _pointRadius: number = 2;\r\n\r\n    private _useNoteFilter: boolean = false;\r\n    private _larger: boolean = false;\r\n    private _touchMode: boolean = false;\r\n    private _mouseX: number = 0;\r\n    private _mouseY: number = 0;\r\n    private _mouseOver: boolean = false;\r\n    private _mouseDown: boolean = false;\r\n    private _mouseDragging: boolean = false;\r\n    private _addingPoint: boolean = false;\r\n    private _deletingPoint: boolean = false;\r\n    private _addedType: FilterType = FilterType.peak;\r\n    private _selectedIndex: number = 0;\r\n    private _freqStart: number = 0;\r\n    private _gainStart: number = 0;\r\n    private _dragChange: UndoableChange | null = null;\r\n    private _subfilterIndex: number = 0;\r\n\r\n    private _filterSettings: FilterSettings;\r\n    private _renderedSelectedIndex: number = -1;\r\n    private _renderedPointCount: number = -1;\r\n    private _renderedPointTypes: number = -1;\r\n    private _renderedPointFreqs: number = -1;\r\n    private _renderedPointGains: number = -1;\r\n    //private _renderedKey: number = -1;\r\n\r\n    constructor(private _doc: SongDocument, useNoteFilter: boolean = false, larger: boolean = false) {\r\n        this._useNoteFilter = useNoteFilter;\r\n        this._larger = larger;\r\n\r\n        if (this._larger) {\r\n            this.container.addEventListener(\"keydown\", this._whenKeyPressed)\r\n            this._editorWidth = 1200;\r\n            this._editorHeight = 260;\r\n            this._pointRadius = 14;\r\n            // A bit of vertical spacing on viewBox so that numbers will show.\r\n            this._svg.setAttribute(\"viewBox\", \"0 -20 \" + this._editorWidth + \" \" + (this._editorHeight + 30));\r\n            this._label.style.setProperty(\"font-size\", \"16px\");\r\n            this._label.style.setProperty(\"position\", \"\");\r\n            this._label.style.setProperty(\"bottom\", \"-16px\");\r\n            this._label.style.setProperty(\"min-height\", \"1em\");\r\n            this._dottedLinePath.style.setProperty(\"stroke-width\", \"3\");\r\n            this._dottedLinePath.style.setProperty(\"stroke-dasharray\", \"6, 4\");\r\n            this._dottedLinePath.setAttribute(\"color\", ColorConfig.getChannelColor(this._doc.song, this._doc.channel).primaryNote);\r\n            this.container.style.setProperty(\"width\", \"85%\");\r\n            this._highlight.setAttribute(\"r\", \"20\");\r\n            this._controlPointPath.setAttribute(\"fill\", ColorConfig.getChannelColor(this._doc.song, this._doc.channel).primaryNote);\r\n\r\n            for (let i: number = 0; i < Config.filterMaxPoints; i++) {\r\n                this._indicators[i] = SVG.text();\r\n                this._indicators[i].setAttribute(\"fill\", ColorConfig.invertedText);\r\n                this._indicators[i].setAttribute(\"text-anchor\", \"start\");\r\n                this._indicators[i].setAttribute(\"dominant-baseline\", \"central\");\r\n                this._indicators[i].setAttribute(\"pointer-events\", \"none\");\r\n                this._indicators[i].setAttribute(\"font-weight\", \"bolder\");\r\n                this._indicators[i].textContent = \"\" + (i + 1);\r\n                this._indicators[i].style.setProperty(\"display\", \"none\");\r\n                this._indicators[i].style.setProperty(\"font-size\", \"24px\");\r\n                this._svg.appendChild(this._indicators[i]);\r\n            }\r\n\r\n            // Push initial state\r\n            const instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n            const filterSettings: FilterSettings = this._useNoteFilter ? instrument.noteFilter : instrument.eqFilter;\r\n            this.selfUndoSettings.push(JSON.stringify(filterSettings.toJsonObject()));\r\n\r\n            this._subFilters[0] = filterSettings;\r\n            for (let i: number = 1; i < Config.filterMorphCount; i++) {\r\n                const subFilter: FilterSettings | null = this._useNoteFilter ? instrument.noteSubFilters[i] : instrument.eqSubFilters[i];\r\n                if (subFilter != null) {\r\n                    let parsedFilter: FilterSettings = new FilterSettings();\r\n                    parsedFilter.fromJsonObject(subFilter.toJsonObject());\r\n                    this._subFilters[i] = parsedFilter;\r\n                }\r\n            }\r\n        }\r\n\r\n        this.container.addEventListener(\"mousedown\", this._whenMousePressed);\r\n        this.container.addEventListener(\"mouseover\", this._whenMouseOver);\r\n        this.container.addEventListener(\"mouseout\", this._whenMouseOut);\r\n        document.addEventListener(\"mousemove\", this._whenMouseMoved);\r\n        document.addEventListener(\"mouseup\", this._whenCursorReleased);\r\n\r\n        this.container.addEventListener(\"touchstart\", this._whenTouchPressed);\r\n        this.container.addEventListener(\"touchmove\", this._whenTouchMoved);\r\n        this.container.addEventListener(\"touchend\", this._whenCursorReleased);\r\n        this.container.addEventListener(\"touchcancel\", this._whenCursorReleased);\r\n    }\r\n\r\n    private _whenKeyPressed = (event: KeyboardEvent): void => {\r\n        if (event.keyCode == 90) { // z\r\n            this.undo();\r\n            event.stopPropagation();\r\n        }\r\n        if (event.keyCode == 89) { // y\r\n            this.redo();\r\n            event.stopPropagation();\r\n        }\r\n    }\r\n\r\n    private _xToFreq(x: number): number {\r\n        return Config.filterFreqRange * x / this._editorWidth - 0.5;\r\n    }\r\n    private _freqToX(freq: number): number {\r\n        return this._editorWidth * (freq + 0.5) / Config.filterFreqRange;\r\n    }\r\n    private _yToGain(y: number): number {\r\n        return (Config.filterGainRange - 1) * (1 - (y - .5) / (this._editorHeight - 1));\r\n    }\r\n    private _gainToY(gain: number): number {\r\n        return (this._editorHeight - 1) * (1 - gain / (Config.filterGainRange - 1)) + .5;\r\n    }\r\n\r\n    private _whenMouseOver = (event: MouseEvent): void => {\r\n        this._mouseOver = true;\r\n\r\n        if (!this._larger)\r\n            this._controlPointPath.style.setProperty(\"fill\", \"currentColor\");\r\n    }\r\n\r\n    private _whenMouseOut = (event: MouseEvent): void => {\r\n        this._mouseOver = false;\r\n        this._updatePath();\r\n\r\n        if (this.coordText != null) {\r\n            this.coordText.innerText = \"\";\r\n        }\r\n    }\r\n\r\n    private _whenMousePressed = (event: MouseEvent): void => {\r\n        event.preventDefault();\r\n        this._touchMode = false;\r\n        const boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n        this._mouseX = ((event.clientX || event.pageX) - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n        this._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n        if (isNaN(this._mouseX)) this._mouseX = 0;\r\n        if (isNaN(this._mouseY)) this._mouseY = 0;\r\n        this._whenCursorPressed();\r\n    }\r\n\r\n    private _whenTouchPressed = (event: TouchEvent): void => {\r\n        event.preventDefault();\r\n        this._touchMode = true;\r\n        const boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n        this._mouseX = (event.touches[0].clientX - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n        this._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n        if (isNaN(this._mouseX)) this._mouseX = 0;\r\n        if (isNaN(this._mouseY)) this._mouseY = 0;\r\n        this._whenCursorPressed();\r\n    }\r\n\r\n    private _whenMouseMoved = (event: MouseEvent): void => {\r\n        if (this.container.offsetParent == null) return;\r\n        const boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n        this._mouseX = ((event.clientX || event.pageX) - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n        this._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n        if (isNaN(this._mouseX)) this._mouseX = 0;\r\n        if (isNaN(this._mouseY)) this._mouseY = 0;\r\n        if (!this._mouseDown) this._updateCursor();\r\n\r\n        this._whenCursorMoved();\r\n    }\r\n\r\n    private _whenTouchMoved = (event: TouchEvent): void => {\r\n        if (this.container.offsetParent == null) return;\r\n        if (this._mouseDown) event.preventDefault();\r\n        const boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n        this._mouseX = (event.touches[0].clientX - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n        this._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n        if (isNaN(this._mouseX)) this._mouseX = 0;\r\n        if (isNaN(this._mouseY)) this._mouseY = 0;\r\n        if (!this._mouseDown) this._updateCursor();\r\n        this._whenCursorMoved();\r\n    }\r\n\r\n    private _whenCursorPressed(): void {\r\n        this._mouseDown = true;\r\n        const sequence: ChangeSequence = new ChangeSequence();\r\n        this._dragChange = sequence;\r\n        this._doc.setProspectiveChange(this._dragChange);\r\n        this._updateCursor();\r\n        this._whenCursorMoved();\r\n    }\r\n\r\n    private _updateCursor(): void {\r\n        this._freqStart = this._xToFreq(this._mouseX);\r\n        this._gainStart = this._yToGain(this._mouseY);\r\n\r\n        this._addingPoint = true;\r\n        this._selectedIndex = -1;\r\n        let nearestDistance: number = Number.POSITIVE_INFINITY;\r\n        for (let i: number = 0; i < this._filterSettings.controlPointCount; i++) {\r\n            const point: FilterControlPoint = this._filterSettings.controlPoints[i];\r\n            const distance: number = Math.sqrt(Math.pow(this._freqToX(point.freq) - this._mouseX, 2) + Math.pow(this._gainToY(point.gain) - this._mouseY, 2));\r\n            if ((distance <= 13 * (1 + +this._larger) || this._filterSettings.controlPointCount >= Config.filterMaxPoints) && distance < nearestDistance) {\r\n                nearestDistance = distance;\r\n                this._selectedIndex = i;\r\n                this._addingPoint = false;\r\n            }\r\n        }\r\n        if (this._addingPoint) {\r\n            const ratio: number = this._mouseX / this._editorWidth;\r\n            if (ratio < 0.2) {\r\n                this._addedType = FilterType.highPass;\r\n            } else if (ratio < 0.8) {\r\n                this._addedType = FilterType.peak;\r\n            } else {\r\n                this._addedType = FilterType.lowPass;\r\n            }\r\n        }\r\n    }\r\n\r\n    private _whenCursorMoved(): void {\r\n        if (this._dragChange != null && this._doc.lastChangeWas(this._dragChange)) {\r\n            this._dragChange.undo();\r\n        } else {\r\n            this._mouseDown = false;\r\n        }\r\n        this._dragChange = null;\r\n        this._deletingPoint = false;\r\n\r\n        if (this.coordText != null && !this._mouseDown) {\r\n            let gain: number = Math.round(this._yToGain(this._mouseY));\r\n            let freq: number = Math.round(this._xToFreq(this._mouseX));\r\n            if (freq >= 0 && freq < Config.filterFreqRange && gain >= 0 && gain < Config.filterGainRange)\r\n                this.coordText.innerText = \"(\" + freq + \", \" + gain + \")\";\r\n            else\r\n                this.coordText.innerText = \"\";\r\n        }\r\n\r\n        if (this._mouseDown) {\r\n            const sequence: ChangeSequence = new ChangeSequence();\r\n            this._dragChange = sequence;\r\n            this._doc.setProspectiveChange(this._dragChange);\r\n\r\n            if (this._addingPoint) {\r\n                const gain: number = Math.max(0, Math.min(Config.filterGainRange - 1, Math.round(this._yToGain(this._mouseY))));\r\n                const freq: number = this._findNearestFreqSlot(this._filterSettings, this._xToFreq(this._mouseX), -1);\r\n                if (freq >= 0 && freq < Config.filterFreqRange) {\r\n                    const point: FilterControlPoint = new FilterControlPoint();\r\n                    point.type = this._addedType;\r\n                    point.freq = freq;\r\n                    point.gain = gain;\r\n                    sequence.append(new ChangeFilterAddPoint(this._doc, this._filterSettings, point, this._filterSettings.controlPointCount, this._useNoteFilter));\r\n\r\n                    if (this.coordText != null) {\r\n                        this.coordText.innerText = \"(\" + freq + \", \" + gain + \")\";\r\n                    }\r\n                } else {\r\n                    this._deletingPoint = true;\r\n                }\r\n            } else if (this._selectedIndex >= this._filterSettings.controlPointCount || this._selectedIndex == -1) {\r\n                this._dragChange = null;\r\n                this._mouseDown = false;\r\n            } else {\r\n                const freqDelta: number = this._xToFreq(this._mouseX) - this._freqStart;\r\n                const gainDelta: number = this._yToGain(this._mouseY) - this._gainStart;\r\n                const point: FilterControlPoint = this._filterSettings.controlPoints[this._selectedIndex];\r\n                const gain: number = Math.max(0, Math.min(Config.filterGainRange - 1, Math.round(point.gain + gainDelta)));\r\n                const freq: number = this._findNearestFreqSlot(this._filterSettings, point.freq + freqDelta, this._selectedIndex);\r\n\r\n                if (Math.round(freqDelta) != 0.0 || Math.round(gainDelta) != 0.0 || freq != point.freq || gain != point.gain) {\r\n                    this._mouseDragging = true;\r\n                }\r\n\r\n                if (freq >= 0 && freq < Config.filterFreqRange) {\r\n                    sequence.append(new ChangeFilterMovePoint(this._doc, point, point.freq, freq, point.gain, gain));\r\n                    if (this.coordText != null) {\r\n                        this.coordText.innerText = \"(\" + freq + \", \" + gain + \")\";\r\n                    }\r\n                } else {\r\n                    sequence.append(new ChangeFilterAddPoint(this._doc, this._filterSettings, point, this._selectedIndex, this._useNoteFilter, true));\r\n                    this._deletingPoint = true;\r\n                }\r\n            }\r\n        }\r\n        if (this._mouseDown || this._mouseOver) {\r\n            this._updatePath();\r\n        }\r\n    }\r\n\r\n    private _whenCursorReleased = (event: Event): void => {\r\n        if (this.container.offsetParent == null) return;\r\n        if (this._mouseDown && this._doc.lastChangeWas(this._dragChange) && this._dragChange != null) {\r\n            if (!this._addingPoint && !this._mouseDragging && !this._touchMode) {\r\n                if (this._selectedIndex < this._filterSettings.controlPointCount && this._selectedIndex != -1) {\r\n                    const point: FilterControlPoint = this._filterSettings.controlPoints[this._selectedIndex];\r\n                    let change: ChangeFilterAddPoint = new ChangeFilterAddPoint(this._doc, this._filterSettings, point, this._selectedIndex, this._useNoteFilter, true);\r\n                    if (!this._larger) {\r\n                        this._doc.record(change);\r\n                    }\r\n                }\r\n            } else if (!this._larger) {\r\n                this._doc.record(this._dragChange);\r\n            }\r\n            this._updatePath();\r\n            if (this._larger) {\r\n                this.selfUndoSettings.length = this.selfUndoHistoryPos+1;\r\n                this.selfUndoSettings.push(JSON.stringify(this._filterSettings.toJsonObject()));\r\n                this.selfUndoHistoryPos++;\r\n            }\r\n        }\r\n        this._dragChange = null;\r\n        this._mouseDragging = false;\r\n        this._deletingPoint = false;\r\n        this._mouseDown = false;\r\n        this._updateCursor();\r\n    }\r\n\r\n    private _findNearestFreqSlot(filterSettings: FilterSettings, targetFreq: number, ignoreIndex: number): number {\r\n        const roundedFreq: number = Math.round(targetFreq);\r\n        let lowerFreq: number = roundedFreq;\r\n        let upperFreq: number = roundedFreq;\r\n        let tryingLower: boolean = (roundedFreq <= targetFreq);\r\n        while (true) {\r\n            let foundConflict: boolean = false;\r\n            const currentFreq: number = tryingLower ? lowerFreq : upperFreq;\r\n            for (let i: number = 0; i < filterSettings.controlPointCount; i++) {\r\n                if (i == ignoreIndex) continue;\r\n                if (filterSettings.controlPoints[i].freq == currentFreq) {\r\n                    foundConflict = true;\r\n                    break;\r\n                }\r\n            }\r\n            if (!foundConflict) return currentFreq;\r\n            tryingLower = !tryingLower;\r\n            if (tryingLower) lowerFreq--;\r\n            if (!tryingLower) upperFreq++;\r\n        }\r\n    }\r\n\r\n    private static _circlePath(cx: number, cy: number, radius: number, reverse: boolean = false): string {\r\n        return `M ${cx - radius} ${cy} ` +\r\n            `a ${radius} ${radius} 0 1 ${reverse ? 1 : 0} ${radius * 2} 0 ` +\r\n            `a ${radius} ${radius} 0 1 ${reverse ? 1 : 0} ${-radius * 2} 0 `;\r\n    }\r\n\r\n    private _updatePath(): void {\r\n        this._highlight.style.display = \"none\";\r\n        this._label.textContent = \"\";\r\n\r\n        let controlPointPath: string = \"\";\r\n        let dottedLinePath: string = \"\";\r\n        for (let i: number = 0; i < this._filterSettings.controlPointCount; i++) {\r\n            const point: FilterControlPoint = this._filterSettings.controlPoints[i];\r\n            const pointX: number = this._freqToX(point.freq);\r\n            const pointY: number = this._gainToY(point.gain);\r\n\r\n            controlPointPath += FilterEditor._circlePath(pointX, pointY, this._pointRadius);\r\n\r\n            if (point.type == FilterType.highPass) {\r\n                dottedLinePath += \"M \" + 0 + \" \" + pointY + \" L \" + pointX + \" \" + pointY + \" \";\r\n            } else if (point.type == FilterType.lowPass) {\r\n                dottedLinePath += \"M \" + this._editorWidth + \" \" + pointY + \" L \" + pointX + \" \" + pointY + \" \";\r\n            }\r\n\r\n            if (this._selectedIndex == i && this._mouseOver && !this._mouseDown) {\r\n                this._highlight.setAttribute(\"cx\", String(pointX));\r\n                this._highlight.setAttribute(\"cy\", String(pointY));\r\n                this._highlight.style.display = \"\";\r\n\r\n                if (this.coordText != null) {\r\n                    this.coordText.innerText = \"(\" + point.freq + \", \" + point.gain + \")\";\r\n                }\r\n            }\r\n            if ((this._selectedIndex == i || (this._addingPoint && this._mouseDown && i == this._filterSettings.controlPointCount - 1)) && (this._mouseOver || this._mouseDown) && !this._deletingPoint) {\r\n                this._label.textContent = (i + 1) + \": \" + Config.filterTypeNames[point.type] + (this._larger ? \" @\" + prettyNumber(point.getHz()) + \"Hz\" : \"\");\r\n            }\r\n\r\n            if (this._larger) {\r\n                this._indicators[i].style.setProperty(\"display\", \"\");\r\n                this._indicators[i].setAttribute(\"x\", \"\" + (pointX - 7));\r\n                this._indicators[i].setAttribute(\"y\", \"\" + (pointY + 2));\r\n            }\r\n        }\r\n        this._controlPointPath.setAttribute(\"d\", controlPointPath);\r\n        this._dottedLinePath.setAttribute(\"d\", dottedLinePath);\r\n        if (this._addingPoint && !this._mouseDown && this._mouseOver) {\r\n            this._label.textContent = \"+ \" + Config.filterTypeNames[this._addedType];\r\n        }\r\n\r\n        // Hide unused control point labels\r\n        if (this._larger) {\r\n            for (let i: number = this._filterSettings.controlPointCount; i < Config.filterMaxPoints; i++) {\r\n                this._indicators[i].style.setProperty(\"display\", \"none\");\r\n            }\r\n        }\r\n\r\n        //let volumeCompensation: number = 1.0;\r\n        const standardSampleRate: number = 44800;\r\n        const filters: FilterCoefficients[] = [];\r\n        for (let i: number = 0; i < this._filterSettings.controlPointCount; i++) {\r\n            const point: FilterControlPoint = this._filterSettings.controlPoints[i];\r\n            const filter: FilterCoefficients = new FilterCoefficients();\r\n            point.toCoefficients(filter, standardSampleRate);\r\n            filters.push(filter);\r\n            //volumeCompensation *= point.getVolumeCompensationMult();\r\n        }\r\n\r\n        const response: FrequencyResponse = new FrequencyResponse();\r\n        let responsePath: string = \"M 0 \" + this._editorHeight + \" \";\r\n        for (let i: number = -1; i <= Config.filterFreqRange; i++) {\r\n            const hz: number = FilterControlPoint.getHzFromSettingValue(i);\r\n            const cornerRadiansPerSample: number = 2.0 * Math.PI * hz / standardSampleRate;\r\n            const real: number = Math.cos(cornerRadiansPerSample);\r\n            const imag: number = Math.sin(cornerRadiansPerSample);\r\n\r\n            let linearGain: number = 1.0; //volumeCompensation;\r\n            for (const filter of filters) {\r\n                response.analyzeComplex(filter, real, imag);\r\n                linearGain *= response.magnitude();\r\n            }\r\n\r\n            const gainSetting: number = Math.log2(linearGain) / Config.filterGainStep + Config.filterGainCenter;\r\n            const y: number = this._gainToY(gainSetting);\r\n            const x: number = this._freqToX(i);\r\n            responsePath += \"L \" + prettyNumber(x) + \" \" + prettyNumber(y) + \" \";\r\n        }\r\n\r\n        responsePath += \"L \" + this._editorWidth + \" \" + this._editorHeight + \" L 0 \" + this._editorHeight + \" z \";\r\n        this._responsePath.setAttribute(\"d\", responsePath);\r\n    }\r\n\r\n    // Swap to new filter settings all at once.\r\n    public swapToSettings(settings: FilterSettings, useHistory: boolean = false) {\r\n        const instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n        new ChangeFilterSettings(this._doc, settings, this._filterSettings, this._useNoteFilter, this._subFilters, this._useNoteFilter ? instrument.noteSubFilters : instrument.eqSubFilters);\r\n        this._filterSettings = settings;\r\n        this._subFilters[this._subfilterIndex] = settings;\r\n        if (useHistory && this._larger) {\r\n            this.selfUndoSettings.length = this.selfUndoHistoryPos + 1;\r\n            this.selfUndoSettings.push(JSON.stringify((this._filterSettings.toJsonObject())));\r\n            this.selfUndoHistoryPos++;\r\n        }\r\n        this._updatePath();\r\n    }\r\n\r\n    // Save settings on prompt close (record a change from first settings to newest)\r\n    public saveSettings() {\r\n        let firstFilter: FilterSettings = new FilterSettings;\r\n        const instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n        firstFilter.fromJsonObject(JSON.parse(String(this.selfUndoSettings[0])));\r\n        this._doc.record(new ChangeFilterSettings(this._doc, this._subFilters[0], firstFilter, this._useNoteFilter, this._subFilters, this._useNoteFilter ? instrument.noteSubFilters : instrument.eqSubFilters), true);\r\n    }\r\n\r\n    // Self-undo history management\r\n    // Returns the subfilter index to swap to, if any\r\n    public undo(): number {\r\n        if (this.selfUndoHistoryPos > 0) {\r\n            this.selfUndoHistoryPos--;\r\n            // Jump back and load latest state of this subfilter. Also save subfilter settings for current index\r\n            if (this.selfUndoSettings[this.selfUndoHistoryPos + 1] != null && this.selfUndoSettings[this.selfUndoHistoryPos + 1].startsWith(\"jmp\")) {\r\n                let str: String = this.selfUndoSettings[this.selfUndoHistoryPos + 1];\r\n                let jumpIndex = +str.substring(3, str.indexOf(\"|\"));\r\n                this.swapToSubfilter(this._subfilterIndex, jumpIndex);\r\n                return jumpIndex;\r\n            // Jumping to FIRST state of this subfilter\r\n            } else if (this.selfUndoSettings[this.selfUndoHistoryPos].startsWith(\"jmp\")) {\r\n                let savedFilter: FilterSettings = new FilterSettings();\r\n                let str: String = this.selfUndoSettings[this.selfUndoHistoryPos];\r\n                savedFilter.fromJsonObject(JSON.parse(str.substring(str.indexOf(\":\") + 1)));\r\n                this.swapToSettings(savedFilter, false);\r\n            } else {\r\n                let savedFilter: FilterSettings = new FilterSettings();\r\n                savedFilter.fromJsonObject(JSON.parse(String(this.selfUndoSettings[this.selfUndoHistoryPos])));\r\n                this.swapToSettings(savedFilter, false);\r\n            }\r\n        }\r\n        return -1;\r\n    }\r\n\r\n    // Returns the subfilter index to swap to, if any\r\n    public redo(): number {\r\n        if (this.selfUndoHistoryPos < this.selfUndoSettings.length-1) {\r\n            this.selfUndoHistoryPos++;\r\n            // Check if next index in undo queue is a command to jump to a new filter index\r\n            if (this.selfUndoSettings[this.selfUndoHistoryPos].startsWith(\"jmp\")) {\r\n                let str: String = this.selfUndoSettings[this.selfUndoHistoryPos];\r\n                let jumpIndex = +str.substring(str.indexOf(\"|\") + 1, str.indexOf(\":\"));\r\n                this.swapToSubfilter(this._subfilterIndex, jumpIndex, false);\r\n                return jumpIndex;\r\n            } else {\r\n                let savedFilter: FilterSettings = new FilterSettings();\r\n                savedFilter.fromJsonObject(JSON.parse(String(this.selfUndoSettings[this.selfUndoHistoryPos])));\r\n                this.swapToSettings(savedFilter, false);\r\n            }\r\n        }\r\n        return -1;\r\n\r\n    }\r\n\r\n    public resetToInitial() {\r\n        this.selfUndoHistoryPos = 1;\r\n        this.undo();\r\n    }\r\n\r\n    public swapSubfilterIndices(newIndex: number) {\r\n        if (this._selectedIndex == -1)\r\n            return;\r\n\r\n        if (newIndex >= this._filterSettings.controlPointCount)\r\n            return;\r\n\r\n        let tmp: FilterControlPoint = this._filterSettings.controlPoints[this._selectedIndex];\r\n        this._filterSettings.controlPoints[this._selectedIndex] = this._filterSettings.controlPoints[newIndex];\r\n        this._filterSettings.controlPoints[newIndex] = tmp;\r\n\r\n        this.render();\r\n    }\r\n\r\n    public swapToSubfilter(oldIndex: number, newIndex: number, useHistory: boolean = false) {\r\n        if (oldIndex != newIndex) {\r\n            // Save current subfilter\r\n            let currFilter: FilterSettings = new FilterSettings();\r\n            currFilter.fromJsonObject(this._filterSettings.toJsonObject());\r\n            this._subFilters[oldIndex] = currFilter;\r\n\r\n            // Copy main filter at this time\r\n            if (this._subFilters[newIndex] == undefined) {\r\n                let parsedFilter: FilterSettings = new FilterSettings();\r\n                parsedFilter.fromJsonObject(this._subFilters[0].toJsonObject());\r\n                this._subFilters[newIndex] = parsedFilter;\r\n            }\r\n\r\n            // Record the swap in undo history\r\n            if (useHistory) {\r\n                this.selfUndoSettings.length = this.selfUndoHistoryPos + 1;\r\n                // Swap from|to:filterInitSettings\r\n                this.selfUndoSettings.push(\"jmp\" + oldIndex + \"|\" + newIndex + \":\" + JSON.stringify(this._subFilters[newIndex].toJsonObject()));\r\n                this.selfUndoHistoryPos++;\r\n            }\r\n\r\n            this._subfilterIndex = newIndex;\r\n            // Never use history here since the swap action is itself history-generating\r\n            this.swapToSettings(this._subFilters[newIndex], false);\r\n        }\r\n\r\n    }\r\n\r\n    public render(activeMods: boolean = false): void {\r\n        const instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n        const filterSettings: FilterSettings = this._useNoteFilter ? instrument.noteFilter : instrument.eqFilter;\r\n        let displayMods: boolean = (activeMods && !this._larger && !this._mouseOver && !this._mouseDragging && !this._mouseDown && this._doc.synth.playing)\r\n        if (displayMods)\r\n            this._controlPointPath.style.setProperty(\"fill\", `${ColorConfig.overwritingModSlider}`);\r\n        else if (!this._larger)\r\n            this._controlPointPath.style.setProperty(\"fill\", \"currentColor\");\r\n\r\n        if (this._filterSettings != filterSettings) {\r\n            this._dragChange = null;\r\n            this._mouseDown = false;\r\n        }\r\n        this._filterSettings = filterSettings;\r\n        let targetSettings: FilterSettings = filterSettings;\r\n        if (!this._mouseDown) this._updateCursor();\r\n\r\n        // If modulators are active, show synth's current filter point settings instead of real points\r\n        if (displayMods) {\r\n            // TODO: Re-compute default point freqs/gains only when needed\r\n            targetSettings = (this._useNoteFilter) ? instrument.tmpNoteFilterStart! : instrument.tmpEqFilterStart!;\r\n            if (targetSettings == null) targetSettings = (this._useNoteFilter) ? instrument.noteFilter : instrument.eqFilter;\r\n            this._filterSettings = targetSettings!;\r\n        }\r\n\r\n        let pointTypes: number = 0;\r\n        let pointFreqs: number = 0;\r\n        let pointGains: number = 0;\r\n        for (let i: number = 0; i < targetSettings.controlPointCount; i++) {\r\n            const point: FilterControlPoint = targetSettings.controlPoints[i];\r\n            pointTypes = pointTypes * FilterType.length + point.type;\r\n            pointFreqs = pointFreqs * Config.filterFreqRange + point.freq;\r\n            pointGains = pointGains * Config.filterGainRange + point.gain;\r\n        }\r\n        if (this._renderedSelectedIndex != this._selectedIndex ||\r\n            this._renderedPointCount != targetSettings.controlPointCount ||\r\n            this._renderedPointTypes != pointTypes ||\r\n            this._renderedPointFreqs != pointFreqs ||\r\n            this._renderedPointGains != pointGains) {\r\n            this._renderedSelectedIndex = this._selectedIndex;\r\n            this._renderedPointCount = targetSettings.controlPointCount;\r\n            this._renderedPointTypes = pointTypes;\r\n            this._renderedPointFreqs = pointFreqs;\r\n            this._renderedPointGains = pointGains;\r\n            this._updatePath();\r\n        }\r\n\r\n        // Return to normal filter settings\r\n        if (displayMods) {\r\n            this._filterSettings = filterSettings;\r\n        }\r\n\r\n        /*\r\n        if (this._renderedKey != this._doc.song.key) {\r\n            this._renderedKey = this._doc.song.key;\r\n            const tonicHz: number = Instrument.frequencyFromPitch(Config.keys[this._doc.song.key].basePitch);\r\n            const x: number = this._freqToX(FilterControlPoint.getSettingValueFromHz(tonicHz));\r\n            this._octaves.setAttribute(\"x\", String(x));\r\n        }\r\n        */\r\n    }\r\n}\r\n","// Copyright (C) 2020 John Nesky, distributed under the MIT license.\r\n\r\nimport { HTML, SVG } from \"imperative-html/dist/esm/elements-strict\";\r\nimport { Prompt } from \"./Prompt\";\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { Config } from \"../synth/SynthConfig\";\r\nimport { FilterEditor } from \"./FilterEditor\";\r\nimport { SongEditor } from \"./SongEditor\";\r\nimport { FilterSettings } from \"../synth/synth\";\r\nimport { ColorConfig } from \"./ColorConfig\";\r\n\r\n//namespace beepbox {\r\nconst { button, div, h2, p } = HTML;\r\n\r\nexport class CustomFilterPrompt implements Prompt {\r\n\r\n\tpublic filterEditor: FilterEditor;\r\n\r\n\tpublic filterData: FilterSettings = new FilterSettings;\r\n\tpublic startingFilterData: FilterSettings = new FilterSettings;\r\n\r\n\tprivate _subfilterIndex = 0;\r\n\r\n\tpublic readonly _playButton: HTMLButtonElement = button({ style: \"width: 55%;\", type: \"button\" });\r\n\r\n\tpublic readonly _filterButtons: HTMLButtonElement[] = [];\r\n\r\n\tpublic readonly _filterButtonContainer: HTMLDivElement = div({class: \"instrument-bar\", style: \"justify-content: center;\"});\r\n\r\n\tprivate readonly _cancelButton: HTMLButtonElement = button({ class: \"cancelButton\" });\r\n\tprivate readonly _okayButton: HTMLButtonElement = button({ class: \"okayButton\", style: \"width:45%;\" }, \"Okay\");\r\n\r\n\tprivate readonly _filterContainer: HTMLDivElement = div({ style: \"width: 100%; display: flex; flex-direction: row; align-items: center; justify-content: center;\" });\r\n\r\n\tprivate readonly _editorTitle: HTMLDivElement = div({}, h2(\"Edit Filter\"));\r\n\r\n\tprivate readonly _filterCopyButton: HTMLButtonElement = button({ style: \"width:86px; margin-right: 5px;\", class: \"copyButton\" }, [\r\n\t\t\"Copy\",\r\n\t\t// Copy icon:\r\n\t\tSVG.svg({ style: \"flex-shrink: 0; position: absolute; left: 0; top: 50%; margin-top: -1em; pointer-events: none;\", width: \"2em\", height: \"2em\", viewBox: \"-5 -21 26 26\" }, [\r\n\t\t\tSVG.path({ d: \"M 0 -15 L 1 -15 L 1 0 L 13 0 L 13 1 L 0 1 L 0 -15 z M 2 -1 L 2 -17 L 10 -17 L 14 -13 L 14 -1 z M 3 -2 L 13 -2 L 13 -12 L 9 -12 L 9 -16 L 3 -16 z\", fill: \"currentColor\" }),\r\n\t\t]),\r\n\t]);\r\n\tprivate readonly _filterPasteButton: HTMLButtonElement = button({ style: \"width:86px;\", class: \"pasteButton\" }, [\r\n\t\t\"Paste\",\r\n\t\t// Paste icon:\r\n\t\tSVG.svg({ style: \"flex-shrink: 0; position: absolute; left: 0; top: 50%; margin-top: -1em; pointer-events: none;\", width: \"2em\", height: \"2em\", viewBox: \"0 0 26 26\" }, [\r\n\t\t\tSVG.path({ d: \"M 8 18 L 6 18 L 6 5 L 17 5 L 17 7 M 9 8 L 16 8 L 20 12 L 20 22 L 9 22 z\", stroke: \"currentColor\", fill: \"none\" }),\r\n\t\t\tSVG.path({ d: \"M 9 3 L 14 3 L 14 6 L 9 6 L 9 3 z M 16 8 L 20 12 L 16 12 L 16 8 z\", fill: \"currentColor\", }),\r\n\t\t]),\r\n\t]);\r\n\tprivate readonly _filterCopyPasteContainer: HTMLDivElement = div({ style: \"width: 185px;\" }, this._filterCopyButton, this._filterPasteButton);\r\n\r\n\tprivate readonly _filterCoordinateText: HTMLDivElement = div({ style: \"text-align: left; margin-bottom: 0px; font-size: x-small; height: 1.3em; color: \" + ColorConfig.secondaryText + \";\"}, p(\"\"));\r\n\r\n\tpublic readonly container: HTMLDivElement = div({ class: \"prompt noSelection\", style: \"width: 600px;\" },\r\n\t\tthis._editorTitle,\r\n\t\tdiv({ style: \"display: flex; width: 55%; align-self: center; flex-direction: row; align-items: center; justify-content: center;\" },\r\n\t\t\tthis._playButton\r\n\t\t),\r\n\t\tthis._filterButtonContainer,\r\n\t\tthis._filterContainer,\r\n\t\tdiv({ style: \"display: flex; flex-direction: row-reverse; justify-content: space-between;\" },\r\n\t\t\tthis._okayButton,\r\n\t\t\tthis._filterCopyPasteContainer,\r\n\t\t),\r\n\t\tthis._cancelButton,\r\n\t);\r\n\r\n\tconstructor(private _doc: SongDocument, private _songEditor: SongEditor, private _useNoteFilter: boolean) {\r\n\r\n\t\tthis._okayButton.addEventListener(\"click\", this._saveChanges);\r\n\t\tthis._cancelButton.addEventListener(\"click\", this._close);\r\n\t\tthis._playButton.addEventListener(\"click\", this._togglePlay);\r\n\t\tthis._filterCopyButton.addEventListener(\"click\", this._copyFilterSettings);\r\n\t\tthis._filterPasteButton.addEventListener(\"click\", this._pasteFilterSettings);\r\n\t\tthis.updatePlayButton();\r\n\t\tlet colors = ColorConfig.getChannelColor(this._doc.song, this._doc.channel);\r\n\r\n\t\tthis.filterEditor = new FilterEditor(_doc, _useNoteFilter, true);\r\n\t\tthis._filterContainer.appendChild(this.filterEditor.container);\r\n\r\n\t\t// Add coordinates to editor\r\n\t\tthis.filterEditor.container.insertBefore(this._filterCoordinateText, this.filterEditor.container.firstChild);\r\n\t\tthis.filterEditor.coordText = this._filterCoordinateText;\r\n\r\n\t\tthis._editorTitle.children[0].innerHTML = (_useNoteFilter) ? \"Edit Note Filter\" : \"Edit EQ Filter\";\r\n\r\n\t\tlet newButton: HTMLButtonElement = button({ class: \"no-underline\", style: \"max-width: 5em;\"}, \"Main\");\r\n\t\tthis._filterButtonContainer.appendChild(newButton);\r\n\t\tthis._filterButtons.push(newButton);\r\n\t\tnewButton.addEventListener(\"click\", () => { this._setSubfilter(0); });\r\n\t\tfor (let i: number = 1; i < Config.filterMorphCount; i++) {\r\n\t\t\tlet newSubButton: HTMLButtonElement = button({ class: \"no-underline\", style: \"max-width: 2em;\"}, \"\" + i);\r\n\t\t\tthis._filterButtons.push(newSubButton);\r\n\t\t\tthis._filterButtonContainer.appendChild(newSubButton);\r\n\t\t\tnewSubButton.addEventListener(\"click\", () => { this._setSubfilter(i); });\r\n\t\t}\r\n\t\tthis._filterButtons[Config.filterMorphCount - 1].classList.add(\"last-button\");\r\n\t\tthis._filterButtons[0].classList.add(\"selected-instrument\");\r\n\r\n\t\tthis._filterButtonContainer.style.setProperty(\"--text-color-lit\", colors.primaryNote);\r\n\t\tthis._filterButtonContainer.style.setProperty(\"--text-color-dim\", colors.secondaryNote);\r\n\t\tthis._filterButtonContainer.style.setProperty(\"--background-color-lit\", colors.primaryChannel);\r\n\t\tthis._filterButtonContainer.style.setProperty(\"--background-color-dim\", colors.secondaryChannel);\r\n\r\n\t\tthis._filterContainer.addEventListener(\"keydown\", this._whenKeyPressed);\r\n\t\tthis.filterEditor.container.addEventListener(\"keydown\", this._whenKeyPressed);\r\n\t\tthis.container.addEventListener(\"keydown\", this._whenKeyPressed);\r\n\r\n\t\tsetTimeout(() => this._playButton.focus());\r\n\r\n\t\tthis.filterEditor.render();\r\n\t}\r\n\r\n\tprivate _setSubfilter = (index: number, useHistory: boolean = true, doSwap: boolean = true): void => {\r\n\t\tthis._filterButtons[this._subfilterIndex].classList.remove(\"selected-instrument\");\r\n\t\tif ( doSwap ) this.filterEditor.swapToSubfilter(this._subfilterIndex, index, useHistory);\r\n\t\tthis._subfilterIndex = index;\r\n\t\tthis._filterButtons[index].classList.add(\"selected-instrument\");\r\n    }\r\n\r\n\tprivate _copyFilterSettings = (): void => {\r\n\t\tconst filterCopy: any = this._useNoteFilter\r\n\t\t\t? this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()].noteFilter.toJsonObject()\r\n\t\t\t: this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()].eqFilter.toJsonObject();\r\n\t\twindow.localStorage.setItem(\"filterCopy\", JSON.stringify(filterCopy));\r\n\t}\r\n\r\n\tprivate _pasteFilterSettings = (): void => {\r\n\r\n\t\tlet filterCopy: FilterSettings = new FilterSettings();\r\n\t\tfilterCopy.fromJsonObject(JSON.parse(String(window.localStorage.getItem(\"filterCopy\"))));\r\n\t\tif (filterCopy != null) {\r\n\t\t\tthis.filterEditor.swapToSettings(filterCopy, true);\r\n\t\t}\r\n    }\r\n\r\n\tprivate _whenKeyPressed = (event: KeyboardEvent): void => {\r\n\t\tif (event.keyCode == 90) { // z\r\n\t\t\tlet newIdx = this.filterEditor.undo();\r\n\t\t\tif (newIdx >= 0) {\r\n\t\t\t\tthis._setSubfilter(newIdx, false, false);\r\n            }\r\n\t\t\tevent.stopPropagation();\r\n\t\t}\r\n\t\tif (event.keyCode == 89) { // y\r\n\t\t\tlet newIdx = this.filterEditor.redo();\r\n\t\t\tif (newIdx >= 0) {\r\n\t\t\t\tthis._setSubfilter(newIdx, false, false);\r\n\t\t\t}\r\n\t\t\tevent.stopPropagation();\r\n\t\t}\r\n\t\t// Number 1-9\r\n\t\tif (event.keyCode >= 49 && event.keyCode <= 57) {\r\n\t\t\tif (!event.shiftKey) {\r\n\t\t\t\tthis.filterEditor.swapSubfilterIndices(event.keyCode - 49);\r\n\t\t\t\tevent.stopPropagation();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tprivate _togglePlay = (): void => {\r\n\t\tthis._songEditor.togglePlay();\r\n\t\tthis.updatePlayButton();\r\n\t}\r\n\r\n\tpublic updatePlayButton(): void {\r\n\t\tif (this._doc.synth.playing) {\r\n\t\t\tthis._playButton.classList.remove(\"playButton\");\r\n\t\t\tthis._playButton.classList.add(\"pauseButton\");\r\n\t\t\tthis._playButton.title = \"Pause (Space)\";\r\n\t\t\tthis._playButton.innerText = \"Pause\";\r\n\t\t} else {\r\n\t\t\tthis._playButton.classList.remove(\"pauseButton\");\r\n\t\t\tthis._playButton.classList.add(\"playButton\");\r\n\t\t\tthis._playButton.title = \"Play (Space)\";\r\n\t\t\tthis._playButton.innerText = \"Play\";\r\n\t\t}\r\n\t}\r\n\r\n\tprivate _close = (): void => {\r\n\t\tthis._doc.prompt = null;\r\n\t\t// Restore filter settings to default\r\n\t\tthis.filterEditor.resetToInitial();\r\n\t\tthis._doc.undo();\r\n\t}\r\n\r\n\tpublic cleanUp = (): void => {\r\n\t\tthis._okayButton.removeEventListener(\"click\", this._saveChanges);\r\n\t\tthis._cancelButton.removeEventListener(\"click\", this._close);\r\n\t\tthis.container.removeEventListener(\"keydown\", this.whenKeyPressed);\r\n\r\n\t\tthis._playButton.removeEventListener(\"click\", this._togglePlay);\r\n\t}\r\n\r\n\tpublic whenKeyPressed = (event: KeyboardEvent): void => {\r\n\t\tif ((<Element>event.target).tagName != \"BUTTON\" && event.keyCode == 13) { // Enter key\r\n\t\t\tthis._saveChanges();\r\n\t\t}\r\n\t\telse if (event.keyCode == 32) { // space\r\n\t\t\tthis._togglePlay();\r\n\t\t\tevent.preventDefault();\r\n\t\t}\r\n\t\telse if (event.keyCode == 90) { // z\r\n\t\t\tthis.filterEditor.undo();\r\n\t\t\tevent.stopPropagation();\r\n\t\t}\r\n\t\telse if (event.keyCode == 89) { // y\r\n\t\t\tthis.filterEditor.redo();\r\n\t\t\tevent.stopPropagation();\r\n\t\t}\r\n\t\telse if (event.keyCode == 219) { // [\r\n\t\t\tthis._doc.synth.goToPrevBar();\r\n\t\t}\r\n\t\telse if (event.keyCode == 221) { // ]\r\n\t\t\tthis._doc.synth.goToNextBar();\r\n\t\t}\r\n\t\telse if (event.keyCode >= 48 && event.keyCode <= 57) { // 0-9\r\n\t\t\tif (event.shiftKey) {\r\n\t\t\t\tthis._setSubfilter(event.keyCode - 48);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tprivate _saveChanges = (): void => {\r\n\t\tthis._doc.prompt = null;\r\n\t\tthis.filterEditor.saveSettings();\r\n\t}\r\n}\r\n//}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nfunction transfer(source: ArrayBuffer, length: number): ArrayBuffer {\r\n\tconst dest: ArrayBuffer = new ArrayBuffer(length);\r\n\tlet nextOffset = 0;\r\n\tlet leftBytes = Math.min(source.byteLength, dest.byteLength);\r\n\tconst wordSizes = [8, 4, 2, 1];\r\n\tfor (const wordSize of wordSizes) {\r\n\t\tif (leftBytes >= wordSize) {\r\n\t\t\tconst done = transferWith(wordSize, source, dest, nextOffset, leftBytes);\r\n\t\t\tnextOffset = done.nextOffset;\r\n\t\t\tleftBytes = done.leftBytes;\r\n\t\t}\r\n\t}\r\n\treturn dest;\r\n\tfunction transferWith(wordSize: number, source: ArrayBuffer, dest: ArrayBuffer, nextOffset: number, leftBytes: number) {\r\n\t\tlet ViewClass: any = Uint8Array;\r\n\t\tswitch (wordSize) {\r\n\t\t\tcase 8:\r\n\t\t\t\tViewClass = Float64Array;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 4:\r\n\t\t\t\tViewClass = Float32Array;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 2:\r\n\t\t\t\tViewClass = Uint16Array;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 1:\r\n\t\t\t\tViewClass = Uint8Array;\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tViewClass = Uint8Array;\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\t\t\r\n\t\tconst view_source = new ViewClass(source, nextOffset, (leftBytes / wordSize) | 0);\r\n\t\tconst view_dest = new ViewClass(dest, nextOffset, (leftBytes / wordSize) | 0);\r\n\t\tfor (let i: number = 0; i < view_dest.length; i++) {\r\n\t\t\tview_dest[i] = view_source[i];\r\n\t\t}\r\n\t\treturn {\r\n\t\t\tnextOffset: view_source.byteOffset + view_source.byteLength,\r\n\t\t\tleftBytes: leftBytes - view_dest.length * wordSize,\r\n\t\t}\r\n\t}\r\n}\r\n\r\n// Note: All methods are big endian.\r\nexport class ArrayBufferWriter {\r\n\tprivate _writeIndex: number = 0;\r\n\tprivate _fileSize: number = 0;\r\n\tprivate _arrayBuffer: ArrayBuffer;\r\n\tprivate _data: DataView;\r\n\t\t\r\n\tconstructor(initialCapacity: number) {\r\n\t\tthis._arrayBuffer = new ArrayBuffer(initialCapacity);\r\n\t\tthis._data = new DataView(this._arrayBuffer);\r\n\t}\r\n\t\t\r\n\tprivate _addBytes(numBytes: number): void {\r\n\t\tthis._fileSize += numBytes;\r\n\t\tif (this._fileSize > this._arrayBuffer.byteLength) {\r\n\t\t\tthis._arrayBuffer = transfer(this._arrayBuffer, Math.max(this._arrayBuffer.byteLength * 2, this._fileSize));\r\n\t\t\tthis._data = new DataView(this._arrayBuffer);\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tpublic getWriteIndex(): number {\r\n\t\treturn this._writeIndex;\r\n\t}\r\n\t\t\r\n\tpublic rewriteUint32(index: number, value: number): void {\r\n\t\tthis._data.setUint32(index, value >>> 0, false);\r\n\t}\r\n\t\t\r\n\tpublic writeUint32(value: number): void {\r\n\t\tvalue = value >>> 0;\r\n\t\tthis._addBytes(4);\r\n\t\tthis._data.setUint32(this._writeIndex, value, false);\r\n\t\tthis._writeIndex = this._fileSize;\r\n\t}\r\n\t\t\r\n\tpublic writeUint24(value: number): void {\r\n\t\tvalue = value >>> 0;\r\n\t\tthis._addBytes(3);\r\n\t\tthis._data.setUint8(this._writeIndex, (value >> 16) & 0xff);\r\n\t\tthis._data.setUint8(this._writeIndex + 1, (value >> 8) & 0xff);\r\n\t\tthis._data.setUint8(this._writeIndex + 2, (value) & 0xff);\r\n\t\tthis._writeIndex = this._fileSize;\r\n\t}\r\n\t\t\r\n\tpublic writeUint16(value: number): void {\r\n\t\tvalue = value >>> 0;\r\n\t\tthis._addBytes(2);\r\n\t\tthis._data.setUint16(this._writeIndex, value, false);\r\n\t\tthis._writeIndex = this._fileSize;\r\n\t}\r\n\t\t\r\n\tpublic writeUint8(value: number): void {\r\n\t\tvalue = value >>> 0;\r\n\t\tthis._addBytes(1);\r\n\t\tthis._data.setUint8(this._writeIndex, value);\r\n\t\tthis._writeIndex = this._fileSize;\r\n\t}\r\n\t\t\r\n\tpublic writeInt8(value: number): void {\r\n\t\tvalue = value | 0;\r\n\t\tthis._addBytes(1);\r\n\t\tthis._data.setInt8(this._writeIndex, value);\r\n\t\tthis._writeIndex = this._fileSize;\r\n\t}\r\n\t\t\r\n\tpublic writeMidi7Bits(value: number): void {\r\n\t\tvalue = value >>> 0;\r\n\t\tif (value >= 0x80) throw new Error(\"7 bit value contained 8th bit!\");\r\n\t\tthis._addBytes(1);\r\n\t\tthis._data.setUint8(this._writeIndex, value);\r\n\t\tthis._writeIndex = this._fileSize;\r\n\t}\r\n\t\t\r\n\tpublic writeMidiVariableLength(value: number): void {\r\n\t\tvalue = value >>> 0;\r\n\t\tif (value > 0x0fffffff) throw new Error(\"writeVariableLength value too big.\");\r\n\t\tlet startWriting: boolean = false;\r\n\t\tfor (let i: number = 0; i < 4; i++) {\r\n\t\t\tconst shift: number = 21 - i * 7;\r\n\t\t\tconst bits: number = (value >>> shift) & 0x7f;\r\n\t\t\tif (bits != 0 || i == 3) startWriting = true; // skip leading zero bytes, but always write the last byte even if it's zero. \r\n\t\t\tif (startWriting) this.writeUint8((i == 3 ? 0x00 : 0x80) | bits);\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tpublic writeMidiAscii(string: string): void {\r\n\t\tthis.writeMidiVariableLength(string.length);\r\n\t\tfor (let i: number = 0; i < string.length; i++) {\r\n\t\t\tconst charCode: number = string.charCodeAt(i);\r\n\t\t\tif (charCode > 0x7f) throw new Error(\"Trying to write unicode character as ascii.\");\r\n\t\t\tthis.writeUint8(charCode); // technically charCodeAt returns 2 byte values, but this string should contain exclusively 1 byte values.\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tpublic toCompactArrayBuffer(): ArrayBuffer {\r\n\t\treturn transfer(this._arrayBuffer, this._fileSize);\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nexport const defaultMidiExpression: number = 0x7F;\r\nexport const defaultMidiPitchBend: number = 0x2000;\r\n\r\nexport const enum MidiChunkType {\r\n\theader = 0x4D546864, // \"MThd\" as bytes, big endian\r\n\ttrack = 0x4D54726B, // \"MTrk\" as bytes, big endian\r\n}\r\n\r\nexport const enum MidiFileFormat {\r\n\tsingleTrack = 0x0000,\r\n\tsimultaneousTracks = 0x0001,\r\n\tindependentTracks = 0x0002,\r\n}\r\n\r\n// Lower 4 bits indicate channel, except for meta and sysex events.\r\nexport const enum MidiEventType {\r\n\t//channelMode = 0x70,\r\n\tnoteOff = 0x80,\r\n\tnoteOn = 0x90,\r\n\tkeyPressure = 0xA0,\r\n\tcontrolChange = 0xB0,\r\n\tprogramChange = 0xC0,\r\n\tchannelPressure = 0xD0,\r\n\tpitchBend = 0xE0,\r\n\tmetaAndSysex = 0xF0,\r\n\t\t\r\n\t// These events are identified by all 8 bits.\r\n\tmeta = 0xFF,\r\n\t// sysexStart = 0xF0,\r\n\t// sysexEscape = 0xF7,\r\n}\r\n\r\nexport const enum MidiControlEventMessage {\r\n\t\t\r\n\tsetParameterMSB = 0x06,\r\n\tvolumeMSB = 0x07,\r\n\tpanMSB = 0x0A,\r\n\texpressionMSB = 0x0B,\r\n\t\t\r\n\tsetParameterLSB = 0x26,\r\n\t//volumeLSB = 0x27,\r\n\t//expressionLSB = 0x2B,\r\n\t\t\r\n\t//nonRegisteredParameterNumberLSB = 0x62,\r\n\t//nonRegisteredParameterNumberMSB = 0x63,\r\n\tregisteredParameterNumberLSB = 0x64,\r\n\tregisteredParameterNumberMSB = 0x65,\r\n\t\t\r\n\t// Channel mode messages:\r\n\t/*\r\n\tallSoundOff = 0x78,\r\n\tresetControllers = 0x79,\r\n\tlocalControl = 0x7A,\r\n\tallNotesOff = 0x7B,\r\n\tomniModeOff = 0x7C,\r\n\tomniModeOn = 0x7D,\r\n\tmonoMode = 0x7E,\r\n\tpolyphonicMode = 0x7F,\r\n\t*/\r\n}\r\n\r\nexport const enum MidiRegisteredParameterNumberMSB {\r\n\tpitchBendRange = 0x00, // semitones\r\n\tfineTuning = 0x00,\r\n\tcoarseTuning = 0x00,\r\n\ttuningProgramSelect = 0x00,\r\n\ttuningBankSelect = 0x00,\r\n\treset = 0x7f,\r\n}\r\n\r\nexport const enum MidiRegisteredParameterNumberLSB {\r\n\tpitchBendRange = 0x00, // cents\r\n\tfineTuning = 0x01,\r\n\tcoarseTuning = 0x02,\r\n\ttuningProgramSelect = 0x03,\r\n\ttuningBankSelect = 0x04,\r\n\treset = 0x7f,\r\n}\r\n\r\nexport const enum MidiMetaEventMessage {\r\n\tsequenceNumber = 0x00,\r\n\ttext = 0x01,\r\n\tcopyrightNotice = 0x02,\r\n\ttrackName = 0x03,\r\n\tinstrumentName = 0x04,\r\n\tlyricText = 0x05,\r\n\tmarker = 0x06,\r\n\tcuePoint = 0x07,\r\n\tchannelPrefix = 0x20,\r\n\tendOfTrack = 0x2F,\r\n\ttempo = 0x51,\r\n\tsmpteOffset = 0x54,\r\n\ttimeSignature = 0x58,\r\n\tkeySignature = 0x59,\r\n\tsequencerSpecificEvent = 0x7F,\r\n}\r\n\r\n// BeepBox noise channels are very different from Midi drumsets, but here's my attempt at a conversion from Midi to BeepBox.\r\nexport interface AnalogousDrum {\r\n\tfrequency: number;\r\n\tduration: number;\r\n\tvolume: number;\r\n}\r\nexport const analogousDrumMap: { [K: number]: AnalogousDrum } = {\r\n\t\t35: { frequency:  0, duration: 2, volume: 3 }, // Acoustic Bass Drum\r\n\t\t36: { frequency:  0, duration: 2, volume: 3 }, // Bass Drum 1\r\n\t\t37: { frequency:  5, duration: 1, volume: 3 }, // Side Stick\r\n\t\t38: { frequency:  4, duration: 2, volume: 3 }, // Acoustic Snare\r\n\t\t39: { frequency:  5, duration: 2, volume: 3 }, // Hand Clap\r\n\t\t40: { frequency:  4, duration: 2, volume: 3 }, // Electric Snare\r\n\t\t41: { frequency:  1, duration: 2, volume: 3 }, // Low Floor Tom\r\n\t\t42: { frequency:  8, duration: 1, volume: 3 }, // Closed Hi Hat\r\n\t\t43: { frequency:  1, duration: 2, volume: 3 }, // High Floor Tom\r\n\t\t44: { frequency:  8, duration: 1, volume: 2 }, // Pedal Hi-Hat\r\n\t\t45: { frequency:  2, duration: 2, volume: 3 }, // Low Tom\r\n\t\t46: { frequency:  8, duration: 4, volume: 3 }, // Open Hi-Hat\r\n\t\t47: { frequency:  2, duration: 2, volume: 3 }, // Low-Mid Tom\r\n\t\t48: { frequency:  3, duration: 2, volume: 3 }, // Hi-Mid Tom\r\n\t\t49: { frequency:  7, duration: 4, volume: 3 }, // Crash Cymbal 1\r\n\t\t50: { frequency:  3, duration: 2, volume: 3 }, // High Tom\r\n\t\t51: { frequency:  6, duration: 4, volume: 2 }, // Ride Cymbal 1\r\n\t\t52: { frequency:  7, duration: 4, volume: 3 }, // Chinese Cymbal\r\n\t\t53: { frequency:  6, duration: 2, volume: 3 }, // Ride Bell\r\n\t54: { frequency: 11, duration: 2, volume: 3 }, // Tambourine\r\n\t\t55: { frequency:  9, duration: 4, volume: 3 }, // Splash Cymbal\r\n\t\t56: { frequency:  7, duration: 1, volume: 2 }, // Cowbell\r\n\t\t57: { frequency:  7, duration: 4, volume: 3 }, // Crash Cymbal 2\r\n\t58: { frequency: 10, duration: 2, volume: 2 }, // Vibraslap\r\n\t\t59: { frequency:  6, duration: 4, volume: 3 }, // Ride Cymbal 2\r\n\t//60: { frequency:  7, duration: 1, volume: 3 }, // Hi Bongo\r\n\t//61: { frequency:  5, duration: 1, volume: 3 }, // Low Bongo\r\n\t//62: { frequency:  6, duration: 1, volume: 3 }, // Mute Hi Conga\r\n\t//63: { frequency:  5, duration: 1, volume: 3 }, // Open Hi Conga\r\n\t//64: { frequency:  4, duration: 1, volume: 3 }, // Low Conga\r\n\t//65: { frequency:  6, duration: 2, volume: 3 }, // High Timbale\r\n\t//66: { frequency:  4, duration: 2, volume: 3 }, // Low Timbale\r\n\t//67: { frequency: 10, duration: 1, volume: 2 }, // High Agogo\r\n\t//68: { frequency:  9, duration: 1, volume: 2 }, // Low Agogo\r\n\t69: { frequency: 10, duration: 2, volume: 3 }, // Cabasa\r\n\t70: { frequency: 10, duration: 2, volume: 3 }, // Maracas\r\n\t//71: { frequency: 10, duration: 2, volume: 3 }, // Short Whistle\r\n\t//72: { frequency:  9, duration: 2, volume: 3 }, // Long Whistle\r\n\t73: { frequency: 10, duration: 1, volume: 2 }, // Short Guiro\r\n\t74: { frequency: 10, duration: 2, volume: 2 }, // Long Guiro\r\n\t//75: { frequency: 10, duration: 1, volume: 2 }, // Claves\r\n\t//76: { frequency:  6, duration: 1, volume: 2 }, // Hi Wood Block\r\n\t//77: { frequency:  5, duration: 1, volume: 2 }, // Low Wood Block\r\n\t//78: { frequency:  6, duration: 2, volume: 3 }, // Mute Cuica\r\n\t//79: { frequency:  4, duration: 2, volume: 3 }, // Open Cuica\r\n\t//80: { frequency:  7, duration: 1, volume: 2 }, // Mute Triangle\r\n\t//81: { frequency:  7, duration: 4, volume: 2 }, // Open Triangle\r\n};\r\n\r\nexport function midiVolumeToVolumeMult(volume: number): number {\r\n\t// default midi volume is 100, pow(100/127,4)≈0.384 so I'm considering that the baseline volume.\r\n\treturn Math.pow(volume / 127, 4.0) / 0.3844015376046128;\r\n}\r\nexport function volumeMultToMidiVolume(volumeMult: number): number {\r\n\treturn Math.pow(volumeMult * 0.3844015376046128, 0.25) * 127;\r\n}\r\nexport function midiExpressionToVolumeMult(expression: number): number {\r\n\treturn Math.pow(expression / 127, 4.0);\r\n}\r\nexport function volumeMultToMidiExpression(volumeMult: number): number {\r\n\treturn Math.pow(volumeMult, 0.25) * 127;\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { InstrumentType, /*EnvelopeType,*/ Config, getArpeggioPitchIndex } from \"../synth/SynthConfig\";\r\nimport { Instrument, Pattern, Note, Song, Synth } from \"../synth/synth\";\r\nimport { ColorConfig } from \"./ColorConfig\";\r\nimport { Preset, EditorConfig } from \"./EditorConfig\";\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { Prompt } from \"./Prompt\";\r\nimport { HTML } from \"imperative-html/dist/esm/elements-strict\";\r\nimport { ArrayBufferWriter } from \"./ArrayBufferWriter\";\r\nimport { MidiChunkType, MidiFileFormat, MidiControlEventMessage, MidiEventType, MidiMetaEventMessage, MidiRegisteredParameterNumberMSB, MidiRegisteredParameterNumberLSB, volumeMultToMidiVolume, volumeMultToMidiExpression, defaultMidiPitchBend, defaultMidiExpression } from \"./Midi\";\r\n\r\nconst { button, div, h2, input, select, option } = HTML;\r\n\r\nfunction lerp(low: number, high: number, t: number): number {\r\n    return low + t * (high - low);\r\n}\r\n\r\nfunction save(blob: Blob, name: string): void {\r\n    if ((<any>navigator).msSaveOrOpenBlob) {\r\n        (<any>navigator).msSaveOrOpenBlob(blob, name);\r\n        return;\r\n    }\r\n\r\n    const anchor: HTMLAnchorElement = document.createElement(\"a\");\r\n    if (anchor.download != undefined) {\r\n        const url: string = URL.createObjectURL(blob);\r\n        setTimeout(function () { URL.revokeObjectURL(url); }, 60000);\r\n        anchor.href = url;\r\n        anchor.download = name;\r\n        // Chrome bug regression: We need to delay dispatching the click\r\n        // event. Seems to be related to going back in the browser history.\r\n        // https://bugs.chromium.org/p/chromium/issues/detail?id=825100\r\n        setTimeout(function () { anchor.dispatchEvent(new MouseEvent(\"click\")); }, 0);\r\n    } else {\r\n        const url: string = URL.createObjectURL(blob);\r\n        setTimeout(function () { URL.revokeObjectURL(url); }, 60000);\r\n        // if (!window.open(url, \"_blank\")) window.location.href = url;\r\n    }\r\n}\r\n\r\nexport class ExportPrompt implements Prompt {\r\n    private synth: Synth;\r\n    private thenExportTo: string;\r\n    private recordedSamplesL: Float32Array;\r\n    private recordedSamplesR: Float32Array;\r\n    private sampleFrames: number;\r\n    private totalChunks: number;\r\n    private currentChunk: number;\r\n    private outputStarted: boolean = false;\r\n    private readonly _fileName: HTMLInputElement = input({ type: \"text\", style: \"width: 10em;\", value: \"BeepBox-Song\", maxlength: 250, \"autofocus\": \"autofocus\" });\r\n    private readonly _computedSamplesLabel: HTMLDivElement = div({ style: \"width: 10em;\" }, new Text(\"0:00\"));\r\n    private readonly _enableIntro: HTMLInputElement = input({ type: \"checkbox\" });\r\n    private readonly _loopDropDown: HTMLInputElement = input({ style: \"width: 2em;\", type: \"number\", min: \"1\", max: \"4\", step: \"1\" });\r\n    private readonly _enableOutro: HTMLInputElement = input({ type: \"checkbox\" });\r\n    private readonly _formatSelect: HTMLSelectElement = select({ style: \"width: 100%;\" },\r\n        option({ value: \"wav\" }, \"Export to .wav file.\"),\r\n        option({ value: \"mp3\" }, \"Export to .mp3 file.\"),\r\n        option({ value: \"midi\" }, \"Export to .mid file.\"),\r\n        option({ value: \"json\" }, \"Export to .json file.\"),\r\n        option({ value: \"html\" }, \"Export to .html file.\"),\r\n    );\r\n    private readonly _cancelButton: HTMLButtonElement = button({ class: \"cancelButton\" });\r\n    private readonly _exportButton: HTMLButtonElement = button({ class: \"exportButton\", style: \"width:45%;\" }, \"Export\");\r\n    private readonly _outputProgressBar: HTMLDivElement = div({ style: `width: 0%; background: ${ColorConfig.loopAccent}; height: 100%; position: absolute; z-index: 2;` });\r\n    private readonly _outputProgressLabel: HTMLDivElement = div({ style: `position: relative; top: -1px; z-index: 3;` }, \"0%\");\r\n    private readonly _outputProgressContainer: HTMLDivElement = div({ style: `height: 12px; background: ${ColorConfig.uiWidgetBackground}; display: block; position: relative; z-index: 1;` },\r\n        this._outputProgressBar,\r\n        this._outputProgressLabel,\r\n    );\r\n    public static readonly midiChipInstruments: number[] = [\r\n        0x4A, // rounded -> recorder\r\n        0x47, // triangle -> clarinet\r\n        0x50, // square -> square wave\r\n        0x46, // ¹/₄ pulse -> bassoon\r\n        0x44, // ¹/₈ pulse -> oboe\r\n        0x51, // sawtooth -> sawtooth wave\r\n        0x51, // double saw -> sawtooth wave\r\n        0x51, // double pulse -> sawtooth wave\r\n        0x51, // spiky -> sawtooth wave\r\n    ];\r\n\r\n    public readonly container: HTMLDivElement = div({ class: \"prompt noSelection\", style: \"width: 200px;\" },\r\n        h2(\"Export Options\"),\r\n        div({ style: \"display: flex; flex-direction: row; align-items: center; justify-content: space-between;\" },\r\n            \"File name:\",\r\n            this._fileName,\r\n        ),\r\n        div({ style: \"display: flex; flex-direction: row; align-items: center; justify-content: space-between;\" },\r\n            \"Length:\",\r\n            this._computedSamplesLabel,\r\n        ),\r\n        div({ style: \"display: table; width: 100%;\" },\r\n            div({ style: \"display: table-row;\" },\r\n                div({ style: \"display: table-cell;\" }, \"Intro:\"),\r\n                div({ style: \"display: table-cell;\" }, \"Loop Count:\"),\r\n                div({ style: \"display: table-cell;\" }, \"Outro:\"),\r\n            ),\r\n            div({ style: \"display: table-row;\" },\r\n                div({ style: \"display: table-cell; vertical-align: middle;\" }, this._enableIntro),\r\n                div({ style: \"display: table-cell; vertical-align: middle;\" }, this._loopDropDown),\r\n                div({ style: \"display: table-cell; vertical-align: middle;\" }, this._enableOutro),\r\n            ),\r\n        ),\r\n        div({ class: \"selectContainer\", style: \"width: 100%;\" }, this._formatSelect),\r\n        div({ style: \"text-align: left;\" }, \"Exporting can be slow. Reloading the page or clicking the X will cancel it. Please be patient.\"),\r\n        this._outputProgressContainer,\r\n        div({ style: \"display: flex; flex-direction: row-reverse; justify-content: space-between;\" },\r\n            this._exportButton,\r\n        ),\r\n        this._cancelButton,\r\n    );\r\n\r\n    constructor(private _doc: SongDocument) {\r\n        this._loopDropDown.value = \"1\";\r\n\r\n        if (this._doc.song.loopStart == 0) {\r\n            this._enableIntro.checked = false;\r\n            this._enableIntro.disabled = true;\r\n        } else {\r\n            this._enableIntro.checked = true;\r\n            this._enableIntro.disabled = false;\r\n        }\r\n        if (this._doc.song.loopStart + this._doc.song.loopLength == this._doc.song.barCount) {\r\n            this._enableOutro.checked = false;\r\n            this._enableOutro.disabled = true;\r\n        } else {\r\n            this._enableOutro.checked = true;\r\n            this._enableOutro.disabled = false;\r\n        }\r\n\r\n        const lastExportFormat: string | null = window.localStorage.getItem(\"exportFormat\");\r\n        if (lastExportFormat != null) {\r\n            this._formatSelect.value = lastExportFormat;\r\n        }\r\n\r\n        this._fileName.select();\r\n        setTimeout(() => this._fileName.focus());\r\n\r\n        this._fileName.addEventListener(\"input\", ExportPrompt._validateFileName);\r\n        this._loopDropDown.addEventListener(\"blur\", ExportPrompt._validateNumber);\r\n        this._exportButton.addEventListener(\"click\", this._export);\r\n        this._cancelButton.addEventListener(\"click\", this._close);\r\n        this._enableOutro.addEventListener(\"click\", () => { (this._computedSamplesLabel.firstChild as Text).textContent = this.samplesToTime(this._doc.synth.getTotalSamples(this._enableIntro.checked, this._enableOutro.checked, +this._loopDropDown.value - 1)); });\r\n        this._enableIntro.addEventListener(\"click\", () => { (this._computedSamplesLabel.firstChild as Text).textContent = this.samplesToTime(this._doc.synth.getTotalSamples(this._enableIntro.checked, this._enableOutro.checked, +this._loopDropDown.value - 1)); });\r\n        this._loopDropDown.addEventListener(\"change\", () => { (this._computedSamplesLabel.firstChild as Text).textContent = this.samplesToTime(this._doc.synth.getTotalSamples(this._enableIntro.checked, this._enableOutro.checked, +this._loopDropDown.value - 1)); });\r\n        this.container.addEventListener(\"keydown\", this._whenKeyPressed);\r\n\r\n        this._fileName.value = _doc.song.title;\r\n        ExportPrompt._validateFileName(null, this._fileName);\r\n\r\n        (this._computedSamplesLabel.firstChild as Text).textContent = this.samplesToTime(this._doc.synth.getTotalSamples(this._enableIntro.checked, this._enableOutro.checked, +this._loopDropDown.value - 1));\r\n    }\r\n\r\n    // Could probably be moved to doc or synth. Fine here for now until needed by something else.\r\n    private samplesToTime(samples: number): string {\r\n        const rawSeconds: number = Math.round(samples / this._doc.synth.samplesPerSecond);\r\n        const seconds: number = rawSeconds % 60;\r\n        const minutes: number = Math.floor(rawSeconds / 60);\r\n        return minutes + \":\" + (seconds < 10 ? \"0\" : \"\") + seconds;\r\n    }\r\n\r\n    private _close = (): void => {\r\n        if (this.synth != null)\r\n            this.synth.renderingSong = false;\r\n        this.outputStarted = false;\r\n        this._doc.undo();\r\n    }\r\n\r\n    public changeFileName(newValue: string) {\r\n        this._fileName.value = newValue;\r\n    }\r\n\r\n    public cleanUp = (): void => {\r\n        this._fileName.removeEventListener(\"input\", ExportPrompt._validateFileName);\r\n        this._loopDropDown.removeEventListener(\"blur\", ExportPrompt._validateNumber);\r\n        this._exportButton.removeEventListener(\"click\", this._export);\r\n        this._cancelButton.removeEventListener(\"click\", this._close);\r\n        this.container.removeEventListener(\"keydown\", this._whenKeyPressed);\r\n    }\r\n\r\n    private _whenKeyPressed = (event: KeyboardEvent): void => {\r\n        if ((<Element>event.target).tagName != \"BUTTON\" && event.keyCode == 13) { // Enter key\r\n            this._export();\r\n        }\r\n    }\r\n\r\n    private static _validateFileName(event: Event | null, use?: HTMLInputElement): void {\r\n\r\n        let input: HTMLInputElement;\r\n        if (event != null) {\r\n            input = <HTMLInputElement>event.target;\r\n        } else if (use != undefined) {\r\n            input = use;\r\n        }\r\n        else {\r\n            return;\r\n        }\r\n        const deleteChars = /[\\+\\*\\$\\?\\|\\{\\}\\\\\\/<>#%!`&'\"=:@]/gi;\r\n        if (deleteChars.test(input.value)) {\r\n            let cursorPos: number = <number>input.selectionStart;\r\n            input.value = input.value.replace(deleteChars, \"\");\r\n            cursorPos--;\r\n            input.setSelectionRange(cursorPos, cursorPos);\r\n        }\r\n    }\r\n\r\n    private static _validateNumber(event: Event): void {\r\n        const input: HTMLInputElement = <HTMLInputElement>event.target;\r\n        input.value = Math.floor(Math.max(Number(input.min), Math.min(Number(input.max), Number(input.value)))) + \"\";\r\n    }\r\n\r\n    private _export = (): void => {\r\n        if (this.outputStarted == true)\r\n            return;\r\n        window.localStorage.setItem(\"exportFormat\", this._formatSelect.value);\r\n        switch (this._formatSelect.value) {\r\n            case \"wav\":\r\n                this.outputStarted = true;\r\n                this._exportTo(\"wav\");\r\n                break;\r\n            case \"mp3\":\r\n                this.outputStarted = true;\r\n                this._exportTo(\"mp3\");\r\n                break;\r\n            case \"midi\":\r\n                this.outputStarted = true;\r\n                this._exportToMidi();\r\n                break;\r\n            case \"json\":\r\n                this.outputStarted = true;\r\n                this._exportToJson();\r\n                break;\r\n            case \"html\":\r\n                this._exportToHtml();\r\n                break;\r\n            default:\r\n                throw new Error(\"Unhandled file export type.\");\r\n        }\r\n    }\r\n\r\n    private _synthesize(): void {\r\n        //const timer: number = performance.now();\r\n\r\n        // If output was stopped e.g. user clicked the close button, abort.\r\n        if (this.outputStarted == false) {\r\n            return;\r\n        }\r\n\r\n        // Update progress bar UI once per 5 sec of exported data\r\n        const samplesPerChunk: number = this.synth.samplesPerSecond * 5; //e.g. 44100 * 5\r\n        const currentFrame: number = this.currentChunk * samplesPerChunk;\r\n\r\n        const samplesInChunk: number = Math.min(samplesPerChunk, this.sampleFrames - currentFrame);\r\n        const tempSamplesL = new Float32Array(samplesInChunk);\r\n        const tempSamplesR = new Float32Array(samplesInChunk);\r\n\r\n        this.synth.renderingSong = true;\r\n        this.synth.synthesize(tempSamplesL, tempSamplesR, samplesInChunk);\r\n\r\n        // Concatenate chunk data into final array\r\n        this.recordedSamplesL.set(tempSamplesL, currentFrame);\r\n        this.recordedSamplesR.set(tempSamplesR, currentFrame);\r\n\r\n        // Update UI\r\n        this._outputProgressBar.style.setProperty(\"width\", Math.round((this.currentChunk + 1) / this.totalChunks * 100.0) + \"%\");\r\n        this._outputProgressLabel.innerText = Math.round((this.currentChunk + 1) / this.totalChunks * 100.0) + \"%\";\r\n\r\n        // Next call, synthesize the next chunk.\r\n        this.currentChunk++;\r\n\r\n        if (this.currentChunk >= this.totalChunks) {\r\n            // Done, call final function\r\n            this.synth.renderingSong = false;\r\n            this._outputProgressLabel.innerText = \"Encoding...\";\r\n            if (this.thenExportTo == \"wav\") {\r\n                this._exportToWavFinish();\r\n            }\r\n            else if (this.thenExportTo == \"mp3\") {\r\n                this._exportToMp3Finish();\r\n            }\r\n            else {\r\n                throw new Error(\"Unrecognized file export type chosen!\");\r\n            }\r\n        }\r\n        else {\r\n            // Continue batch export\r\n            setTimeout(() => { this._synthesize(); });\r\n        }\r\n\r\n        //console.log(\"export timer\", (performance.now() - timer) / 1000.0);\r\n    }\r\n\r\n    private _exportTo(type: string): void {\r\n        // Batch the export operation\r\n        this.thenExportTo = type;\r\n        this.currentChunk = 0;\r\n        this.synth = new Synth(this._doc.song);\r\n        if (type == \"wav\") {\r\n            this.synth.samplesPerSecond = 48000; // Use professional video editing standard sample rate for .wav file export.\r\n        }\r\n        else if (type == \"mp3\") {\r\n            this.synth.samplesPerSecond = 44100; // Use consumer CD standard sample rate for .mp3 export.\r\n        }\r\n        else {\r\n            throw new Error(\"Unrecognized file export type chosen!\");\r\n        }\r\n\r\n        this._outputProgressBar.style.setProperty(\"width\", \"0%\");\r\n        this._outputProgressLabel.innerText = \"0%\";\r\n\r\n        this.synth.loopRepeatCount = Number(this._loopDropDown.value) - 1;\r\n        if (!this._enableIntro.checked) {\r\n            for (let introIter: number = 0; introIter < this._doc.song.loopStart; introIter++) {\r\n                this.synth.goToNextBar();\r\n            }\r\n        }\r\n\r\n        this.synth.computeLatestModValues();\r\n        this.synth.warmUpSynthesizer(this._doc.song);\r\n\r\n        this.sampleFrames = this.synth.getTotalSamples(this._enableIntro.checked, this._enableOutro.checked, this.synth.loopRepeatCount);\r\n        // Compute how many UI updates will need to run to determine how many \r\n        this.totalChunks = Math.ceil(this.sampleFrames / (this.synth.samplesPerSecond * 5));\r\n        this.recordedSamplesL = new Float32Array(this.sampleFrames);\r\n        this.recordedSamplesR = new Float32Array(this.sampleFrames);\r\n\r\n        // Batch the actual export\r\n        setTimeout(() => { this._synthesize(); });\r\n    }\r\n\r\n    private _exportToWavFinish(): void {\r\n        const sampleFrames: number = this.recordedSamplesL.length;\r\n        const sampleRate: number = this.synth.samplesPerSecond;\r\n\r\n        const wavChannelCount: number = 2;\r\n        const bytesPerSample: number = 2;\r\n        const bitsPerSample: number = 8 * bytesPerSample;\r\n        const sampleCount: number = wavChannelCount * sampleFrames;\r\n\r\n        const totalFileSize: number = 44 + sampleCount * bytesPerSample;\r\n\r\n        let index: number = 0;\r\n        const arrayBuffer: ArrayBuffer = new ArrayBuffer(totalFileSize);\r\n        const data: DataView = new DataView(arrayBuffer);\r\n        data.setUint32(index, 0x52494646, false); index += 4;\r\n        data.setUint32(index, 36 + sampleCount * bytesPerSample, true); index += 4; // size of remaining file\r\n        data.setUint32(index, 0x57415645, false); index += 4;\r\n        data.setUint32(index, 0x666D7420, false); index += 4;\r\n        data.setUint32(index, 0x00000010, true); index += 4; // size of following header\r\n        data.setUint16(index, 0x0001, true); index += 2; // not compressed\r\n        data.setUint16(index, wavChannelCount, true); index += 2; // channel count\r\n        data.setUint32(index, sampleRate, true); index += 4; // sample rate\r\n        data.setUint32(index, sampleRate * bytesPerSample * wavChannelCount, true); index += 4; // bytes per second\r\n        data.setUint16(index, bytesPerSample * wavChannelCount, true); index += 2; // block align\r\n        data.setUint16(index, bitsPerSample, true); index += 2; // bits per sample\r\n        data.setUint32(index, 0x64617461, false); index += 4;\r\n        data.setUint32(index, sampleCount * bytesPerSample, true); index += 4;\r\n\r\n        if (bytesPerSample > 1) {\r\n            // usually samples are signed. \r\n            const range: number = (1 << (bitsPerSample - 1)) - 1;\r\n            for (let i: number = 0; i < sampleFrames; i++) {\r\n                let valL: number = Math.floor(Math.max(-1, Math.min(1, this.recordedSamplesL[i])) * range);\r\n                let valR: number = Math.floor(Math.max(-1, Math.min(1, this.recordedSamplesR[i])) * range);\r\n                if (bytesPerSample == 2) {\r\n                    data.setInt16(index, valL, true); index += 2;\r\n                    data.setInt16(index, valR, true); index += 2;\r\n                } else if (bytesPerSample == 4) {\r\n                    data.setInt32(index, valL, true); index += 4;\r\n                    data.setInt32(index, valR, true); index += 4;\r\n                } else {\r\n                    throw new Error(\"unsupported sample size\");\r\n                }\r\n            }\r\n        } else {\r\n            // 8 bit samples are a special case: they are unsigned.\r\n            for (let i: number = 0; i < sampleFrames; i++) {\r\n                let valL: number = Math.floor(Math.max(-1, Math.min(1, this.recordedSamplesL[i])) * 127 + 128);\r\n                let valR: number = Math.floor(Math.max(-1, Math.min(1, this.recordedSamplesR[i])) * 127 + 128);\r\n                data.setUint8(index, valL > 255 ? 255 : (valL < 0 ? 0 : valL)); index++;\r\n                data.setUint8(index, valR > 255 ? 255 : (valR < 0 ? 0 : valR)); index++;\r\n            }\r\n        }\r\n\r\n        const blob: Blob = new Blob([arrayBuffer], { type: \"audio/wav\" });\r\n        save(blob, this._fileName.value.trim() + \".wav\");\r\n\r\n        this._close();\r\n    }\r\n\r\n    private _exportToMp3Finish(): void {\r\n        const whenEncoderIsAvailable = (): void => {\r\n\r\n            const lamejs: any = (<any>window)[\"lamejs\"];\r\n            const channelCount: number = 2;\r\n            const kbps: number = 192;\r\n            const sampleBlockSize: number = 1152;\r\n            const mp3encoder: any = new lamejs.Mp3Encoder(channelCount, this.synth.samplesPerSecond, kbps);\r\n            const mp3Data: any[] = [];\r\n\r\n            const left: Int16Array = new Int16Array(this.recordedSamplesL.length);\r\n            const right: Int16Array = new Int16Array(this.recordedSamplesR.length);\r\n            const range: number = (1 << 15) - 1;\r\n            for (let i: number = 0; i < this.recordedSamplesL.length; i++) {\r\n                left[i] = Math.floor(Math.max(-1, Math.min(1, this.recordedSamplesL[i])) * range);\r\n                right[i] = Math.floor(Math.max(-1, Math.min(1, this.recordedSamplesR[i])) * range);\r\n            }\r\n\r\n            for (let i: number = 0; i < left.length; i += sampleBlockSize) {\r\n                const leftChunk: Int16Array = left.subarray(i, i + sampleBlockSize);\r\n                const rightChunk: Int16Array = right.subarray(i, i + sampleBlockSize);\r\n                const mp3buf: any = mp3encoder.encodeBuffer(leftChunk, rightChunk);\r\n                if (mp3buf.length > 0) mp3Data.push(mp3buf);\r\n            }\r\n\r\n            const mp3buf: any = mp3encoder.flush();\r\n            if (mp3buf.length > 0) mp3Data.push(mp3buf);\r\n\r\n            const blob: Blob = new Blob(mp3Data, { type: \"audio/mp3\" });\r\n            save(blob, this._fileName.value.trim() + \".mp3\");\r\n            this._close();\r\n        }\r\n\r\n        if (\"lamejs\" in window) {\r\n            whenEncoderIsAvailable();\r\n        } else {\r\n            var script = document.createElement(\"script\");\r\n            script.src = \"https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js\";\r\n            script.onload = whenEncoderIsAvailable;\r\n            document.head.appendChild(script);\r\n        }\r\n    }\r\n\r\n    private _exportToMidi(): void {\r\n        const song: Song = this._doc.song;\r\n        const midiTicksPerBeepBoxTick: number = 2;\r\n        const midiTicksPerBeat: number = midiTicksPerBeepBoxTick * Config.ticksPerPart * Config.partsPerBeat;\r\n        const midiTicksPerPart: number = midiTicksPerBeepBoxTick * Config.ticksPerPart;\r\n        const secondsPerMinute: number = 60;\r\n        const microsecondsPerMinute: number = secondsPerMinute * 1000000;\r\n        const beatsPerMinute: number = song.getBeatsPerMinute();\r\n        const microsecondsPerBeat: number = Math.round(microsecondsPerMinute / beatsPerMinute);\r\n        //const secondsPerMidiTick: number = secondsPerMinute / (midiTicksPerBeat * beatsPerMinute);\r\n        const midiTicksPerBar: number = midiTicksPerBeat * song.beatsPerBar;\r\n        const pitchBendRange: number = 24;\r\n        const defaultNoteVelocity: number = 90;\r\n\r\n        const unrolledBars: number[] = [];\r\n        if (this._enableIntro.checked) {\r\n            for (let bar: number = 0; bar < song.loopStart; bar++) {\r\n                unrolledBars.push(bar);\r\n            }\r\n        }\r\n        for (let loopIndex: number = 0; loopIndex < Number(this._loopDropDown.value); loopIndex++) {\r\n            for (let bar: number = song.loopStart; bar < song.loopStart + song.loopLength; bar++) {\r\n                unrolledBars.push(bar);\r\n            }\r\n        }\r\n        if (this._enableOutro.checked) {\r\n            for (let bar: number = song.loopStart + song.loopLength; bar < song.barCount; bar++) {\r\n                unrolledBars.push(bar);\r\n            }\r\n        }\r\n\r\n        const tracks = [{ isMeta: true, channel: -1, midiChannel: -1, isNoise: false, isDrumset: false }];\r\n        let midiChannelCounter: number = 0;\r\n        let foundADrumset: boolean = false;\r\n        for (let channel: number = 0; channel < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount; channel++) {\r\n            if (!foundADrumset && this._doc.song.channels[channel].instruments[0].type == InstrumentType.drumset) {\r\n                tracks.push({ isMeta: false, channel: channel, midiChannel: 9, isNoise: true, isDrumset: true });\r\n                foundADrumset = true; // There can only be one drumset channel, and it's always channel 9 (seen as 10 in most UIs). :/\r\n            } else {\r\n                if (midiChannelCounter >= 16) continue; // The MIDI standard only supports 16 channels.\r\n                tracks.push({ isMeta: false, channel: channel, midiChannel: midiChannelCounter++, isNoise: this._doc.song.getChannelIsNoise(channel), isDrumset: false });\r\n                if (midiChannelCounter == 9) midiChannelCounter++; // skip midi drum channel.\r\n            }\r\n        }\r\n\r\n        const writer: ArrayBufferWriter = new ArrayBufferWriter(1024);\r\n        writer.writeUint32(MidiChunkType.header);\r\n        writer.writeUint32(6); // length of headers is 6 bytes\r\n        writer.writeUint16(MidiFileFormat.simultaneousTracks);\r\n        writer.writeUint16(tracks.length);\r\n        writer.writeUint16(midiTicksPerBeat); // number of \"ticks\" per beat, independent of tempo\r\n\r\n        for (const track of tracks) {\r\n            writer.writeUint32(MidiChunkType.track);\r\n\r\n            const { isMeta, channel, midiChannel, isNoise, isDrumset } = track;\r\n\r\n            // We're gonna come back here and overwrite this placeholder once we know how many bytes this track is.\r\n            const trackStartIndex: number = writer.getWriteIndex();\r\n            writer.writeUint32(0); // placeholder for track size\r\n\r\n            let prevTime: number = 0;\r\n            let barStartTime: number = 0;\r\n            const writeEventTime = function (time: number): void {\r\n                if (time < prevTime) throw new Error(\"Midi event time cannot go backwards.\");\r\n                writer.writeMidiVariableLength(time - prevTime);\r\n                prevTime = time;\r\n            }\r\n\r\n            const writeControlEvent = function (message: MidiControlEventMessage, value: number): void {\r\n                if (!(value >= 0 && value <= 0x7F)) throw new Error(\"Midi control event value out of range: \" + value);\r\n                writer.writeUint8(MidiEventType.controlChange | midiChannel);\r\n                writer.writeMidi7Bits(message);\r\n                writer.writeMidi7Bits(value | 0);\r\n            }\r\n\r\n            if (isMeta) {\r\n                // for first midi track, include tempo, time signature, and key signature information.\r\n\r\n                writeEventTime(0);\r\n                writer.writeUint8(MidiEventType.meta);\r\n                writer.writeMidi7Bits(MidiMetaEventMessage.text);\r\n                writer.writeMidiAscii(\"Composed with jummbus.bitbucket.io\");\r\n\r\n                writeEventTime(0);\r\n                writer.writeUint8(MidiEventType.meta);\r\n                writer.writeMidi7Bits(MidiMetaEventMessage.tempo);\r\n                writer.writeMidiVariableLength(3); // Tempo message length is 3 bytes.\r\n                writer.writeUint24(microsecondsPerBeat); // Tempo in microseconds per \"quarter\" note, commonly known as a \"beat\"\r\n\r\n                writeEventTime(0);\r\n                writer.writeUint8(MidiEventType.meta);\r\n                writer.writeMidi7Bits(MidiMetaEventMessage.timeSignature);\r\n                writer.writeMidiVariableLength(4); // Time signature message length is 4 bytes.\r\n                writer.writeUint8(song.beatsPerBar); // numerator.\r\n                writer.writeUint8(2); // denominator exponent in 2^E. 2^2 = 4, and we will always use \"quarter\" notes.\r\n                writer.writeUint8(24); // MIDI Clocks per metronome tick (should match beats), standard is 24\r\n                writer.writeUint8(8); // number of 1/32 notes per 24 MIDI Clocks, standard is 8, meaning 24 clocks per \"quarter\" note.\r\n\r\n                const isMinor: boolean = Config.scales[song.scale].flags[3] && !Config.scales[song.scale].flags[4];\r\n                const key: number = song.key; // C=0, C#=1, counting up to B=11\r\n                let numSharps: number = key; // For even key values in major scale, number of sharps/flats is same...\r\n                if ((key & 1) == 1) numSharps += 6; // For odd key values (consider circle of fifths) rotate around the circle... kinda... Look conventional key signatures are just weird, okay?\r\n                if (isMinor) numSharps += 9; // A minor A scale has zero sharps, shift it appropriately\r\n                while (numSharps > 6) numSharps -= 12; // Range is (modulo 12) - 5. Midi supports -7 to +7, but I only have 12 options.\r\n\r\n                writeEventTime(0);\r\n                writer.writeUint8(MidiEventType.meta);\r\n                writer.writeMidi7Bits(MidiMetaEventMessage.keySignature);\r\n                writer.writeMidiVariableLength(2); // Key signature message length is 2 bytes.\r\n                writer.writeInt8(numSharps); // See above calculation. Assumes scale is diatonic. :/\r\n                writer.writeUint8(isMinor ? 1 : 0); // 0: major, 1: minor\r\n\r\n                if (this._enableIntro.checked) barStartTime += midiTicksPerBar * song.loopStart;\r\n                writeEventTime(barStartTime);\r\n                writer.writeUint8(MidiEventType.meta);\r\n                writer.writeMidi7Bits(MidiMetaEventMessage.marker);\r\n                writer.writeMidiAscii(\"Loop Start\");\r\n\r\n                for (let loopIndex: number = 0; loopIndex < parseInt(this._loopDropDown.value); loopIndex++) {\r\n                    barStartTime += midiTicksPerBar * song.loopLength;\r\n                    writeEventTime(barStartTime);\r\n                    writer.writeUint8(MidiEventType.meta);\r\n                    writer.writeMidi7Bits(MidiMetaEventMessage.marker);\r\n                    writer.writeMidiAscii(loopIndex < Number(this._loopDropDown.value) - 1 ? \"Loop Repeat\" : \"Loop End\");\r\n                }\r\n\r\n                if (this._enableOutro.checked) barStartTime += midiTicksPerBar * (song.barCount - song.loopStart - song.loopLength);\r\n                if (barStartTime != midiTicksPerBar * unrolledBars.length) throw new Error(\"Miscalculated number of bars.\");\r\n\r\n            } else {\r\n                // For remaining tracks, set up the instruments and write the notes:\r\n\r\n                let channelName: string = isNoise\r\n                    ? \"noise channel \" + channel\r\n                    : \"pitch channel \" + channel;\r\n                writeEventTime(0);\r\n                writer.writeUint8(MidiEventType.meta);\r\n                writer.writeMidi7Bits(MidiMetaEventMessage.trackName);\r\n                writer.writeMidiAscii(channelName);\r\n\r\n                // This sets up pitch bend range. First we choose the pitch bend RPN (which has MSB and LSB components), then we set the value for that RPN (which also has MSB and LSB components) and finally reset the current RPN to null, which is considered best practice.\r\n                writeEventTime(0); writeControlEvent(MidiControlEventMessage.registeredParameterNumberMSB, MidiRegisteredParameterNumberMSB.pitchBendRange);\r\n                writeEventTime(0); writeControlEvent(MidiControlEventMessage.registeredParameterNumberLSB, MidiRegisteredParameterNumberLSB.pitchBendRange);\r\n                writeEventTime(0); writeControlEvent(MidiControlEventMessage.setParameterMSB, pitchBendRange); // pitch bend semitone range\r\n                writeEventTime(0); writeControlEvent(MidiControlEventMessage.setParameterLSB, 0); // pitch bend cent range\r\n                writeEventTime(0); writeControlEvent(MidiControlEventMessage.registeredParameterNumberMSB, MidiRegisteredParameterNumberMSB.reset);\r\n                writeEventTime(0); writeControlEvent(MidiControlEventMessage.registeredParameterNumberLSB, MidiRegisteredParameterNumberLSB.reset);\r\n\r\n                let prevInstrumentIndex: number = -1;\r\n                function writeInstrumentSettings(instrumentIndex: number): void {\r\n                    const instrument: Instrument = song.channels[channel].instruments[instrumentIndex];\r\n                    const preset: Preset | null = EditorConfig.valueToPreset(instrument.preset);\r\n\r\n                    if (prevInstrumentIndex != instrumentIndex) {\r\n                        prevInstrumentIndex = instrumentIndex;\r\n                        writeEventTime(barStartTime);\r\n                        writer.writeUint8(MidiEventType.meta);\r\n                        writer.writeMidi7Bits(MidiMetaEventMessage.instrumentName);\r\n                        writer.writeMidiAscii(\"Instrument \" + (instrumentIndex + 1));\r\n\r\n                        if (!isDrumset) {\r\n                            let instrumentProgram: number = 81; // default to sawtooth wave. \r\n\r\n                            if (preset != null && preset.midiProgram != undefined) {\r\n                                instrumentProgram = preset.midiProgram;\r\n                            } else if (instrument.type == InstrumentType.drumset) {\r\n                                // The first BeepBox drumset channel is handled as a Midi drumset channel and doesn't need a program, but any subsequent drumsets will just be set to taiko.\r\n                                instrumentProgram = 116; // taiko\r\n                            } else {\r\n                                if (instrument.type == InstrumentType.noise || instrument.type == InstrumentType.spectrum) {\r\n                                    if (isNoise) {\r\n                                        instrumentProgram = 116; // taiko\r\n                                    } else {\r\n                                        instrumentProgram = 75; // pan flute\r\n                                    }\r\n                                } else if (instrument.type == InstrumentType.chip) {\r\n                                    if (ExportPrompt.midiChipInstruments.length > instrument.chipWave) {\r\n                                        instrumentProgram = ExportPrompt.midiChipInstruments[instrument.chipWave];\r\n                                    }\r\n                                } else if (instrument.type == InstrumentType.pwm || instrument.type == InstrumentType.fm || instrument.type == InstrumentType.harmonics) {\r\n                                    instrumentProgram = 81; // sawtooth\r\n                                } else if (instrument.type == InstrumentType.pickedString) {\r\n                                    instrumentProgram = 0x19; // steel guitar\r\n                                } else if (instrument.type == InstrumentType.customChipWave) {\r\n                                    instrumentProgram = 81; // sawtooth\r\n                                } else {\r\n                                    throw new Error(\"Unrecognized instrument type.\");\r\n                                }\r\n                            }\r\n\r\n                            // Program (instrument) change event:\r\n                            writeEventTime(barStartTime);\r\n                            writer.writeUint8(MidiEventType.programChange | midiChannel);\r\n                            writer.writeMidi7Bits(instrumentProgram);\r\n                        }\r\n\r\n                        // Instrument volume:\r\n                        writeEventTime(barStartTime);\r\n                        let instrumentVolume: number = volumeMultToMidiVolume(Synth.instrumentVolumeToVolumeMult(instrument.volume));\r\n                        writeControlEvent(MidiControlEventMessage.volumeMSB, Math.min(0x7f, Math.round(instrumentVolume)));\r\n\r\n                        // Instrument pan:\r\n                        writeEventTime(barStartTime);\r\n                        let instrumentPan: number = (instrument.pan / Config.panCenter - 1) * 0x3f + 0x40;\r\n                        writeControlEvent(MidiControlEventMessage.panMSB, Math.min(0x7f, Math.round(instrumentPan)));\r\n                    }\r\n                }\r\n                if (song.getPattern(channel, 0) == null) {\r\n                    // Go ahead and apply the instrument settings at the beginning of the channel\r\n                    // even if a bar doesn't kick in until later.\r\n                    writeInstrumentSettings(0);\r\n                }\r\n\r\n                let prevPitchBend: number = defaultMidiPitchBend;\r\n                let prevExpression: number = defaultMidiExpression;\r\n                let shouldResetExpressionAndPitchBend: boolean = false;\r\n                //let prevTremolo: number = -1;\r\n                const channelRoot: number = isNoise ? Config.spectrumBasePitch : Config.keys[song.key].basePitch;\r\n                const intervalScale: number = isNoise ? Config.noiseInterval : 1;\r\n\r\n                for (const bar of unrolledBars) {\r\n                    const pattern: Pattern | null = song.getPattern(channel, bar);\r\n\r\n                    if (pattern != null) {\r\n\r\n                        const instrumentIndex: number = pattern.instruments[0]; // Don't bother trying to export multiple instruments per pattern to midi, just pick the first one.\r\n                        const instrument: Instrument = song.channels[channel].instruments[instrumentIndex];\r\n                        const preset: Preset | null = EditorConfig.valueToPreset(instrument.preset);\r\n                        writeInstrumentSettings(instrumentIndex);\r\n\r\n                        let usesArpeggio: boolean = instrument.getChord().arpeggiates;\r\n                        let polyphony: number = usesArpeggio ? 1 : Config.maxChordSize;\r\n                        if (instrument.getChord().customInterval) {\r\n                            if (instrument.type == InstrumentType.chip || instrument.type == InstrumentType.harmonics) {\r\n                                polyphony = 2;\r\n                                usesArpeggio = true;\r\n                            } else if (instrument.type == InstrumentType.fm) {\r\n                                polyphony = Config.operatorCount;\r\n                            } else {\r\n                                console.error(\"Unrecognized instrument type for harmonizing arpeggio: \" + instrument.type);\r\n                            }\r\n                        }\r\n\r\n                        for (let noteIndex: number = 0; noteIndex < pattern.notes.length; noteIndex++) {\r\n                            const note: Note = pattern.notes[noteIndex];\r\n\r\n                            const noteStartTime: number = barStartTime + note.start * midiTicksPerPart;\r\n                            let pinTime: number = noteStartTime;\r\n                            let pinSize: number = note.pins[0].size;\r\n                            let pinInterval: number = note.pins[0].interval;\r\n                            const prevPitches: number[] = [-1, -1, -1, -1];\r\n                            const nextPitches: number[] = [-1, -1, -1, -1];\r\n                            const toneCount: number = Math.min(polyphony, note.pitches.length);\r\n                            const velocity: number = isDrumset ? Math.max(1, Math.round(defaultNoteVelocity * note.pins[0].size / Config.noteSizeMax)) : defaultNoteVelocity;\r\n\r\n                            // The maximum midi pitch bend range is +/- 24 semitones from the base pitch. \r\n                            // To make the most of this, choose a base pitch that is within 24 semitones from as much of the note as possible.\r\n                            // This may involve offsetting this base pitch from BeepBox's note pitch.\r\n                            let mainInterval: number = note.pickMainInterval();\r\n                            let pitchOffset: number = mainInterval * intervalScale;\r\n                            if (!isDrumset) {\r\n                                let maxPitchOffset: number = pitchBendRange;\r\n                                let minPitchOffset: number = -pitchBendRange;\r\n                                for (let pinIndex: number = 1; pinIndex < note.pins.length; pinIndex++) {\r\n                                    const interval = note.pins[pinIndex].interval * intervalScale;\r\n                                    maxPitchOffset = Math.min(maxPitchOffset, interval + pitchBendRange);\r\n                                    minPitchOffset = Math.max(minPitchOffset, interval - pitchBendRange);\r\n                                }\r\n                                /*\r\n                                // I'd like to be able to use pitch bend to implement arpeggio, but the \"custom inverval\" setting in chip instruments combines arpeggio in one tone with another flat tone, and midi can't selectively apply arpeggio to one out of two simultaneous tones. Also it would be hard to reimport. :/\r\n                                if (usesArpeggio && note.pitches.length > polyphony) {\r\n                                    let lowestArpeggioOffset: number = 0;\r\n                                    let highestArpeggioOffset: number = 0;\r\n                                    const basePitch: number = note.pitches[toneCount - 1];\r\n                                    for (let pitchIndex: number = toneCount; pitchIndex < note.pitches.length; pitchIndex++) {\r\n                                        lowestArpeggioOffset = Math.min(note.pitches[pitchIndex] - basePitch);\r\n                                        highestArpeggioOffset = Math.max(note.pitches[pitchIndex] - basePitch);\r\n                                    }\r\n                                    maxPitchOffset -= lowestArpeggioOffset;\r\n                                    minPitchOffset += lowestArpeggioOffset;\r\n                                }\r\n                                */\r\n                                pitchOffset = Math.min(maxPitchOffset, Math.max(minPitchOffset, pitchOffset));\r\n                            }\r\n\r\n                            for (let pinIndex: number = 1; pinIndex < note.pins.length; pinIndex++) {\r\n                                const nextPinTime: number = noteStartTime + note.pins[pinIndex].time * midiTicksPerPart;\r\n                                const nextPinSize: number = note.pins[pinIndex].size;\r\n                                const nextPinInterval: number = note.pins[pinIndex].interval;\r\n\r\n                                const length: number = nextPinTime - pinTime;\r\n                                for (let midiTick: number = 0; midiTick < length; midiTick++) {\r\n                                    const midiTickTime: number = pinTime + midiTick;\r\n                                    const linearSize: number = lerp(pinSize, nextPinSize, midiTick / length);\r\n                                    const linearInterval: number = lerp(pinInterval, nextPinInterval, midiTick / length);\r\n\r\n                                    const interval: number = linearInterval * intervalScale - pitchOffset;\r\n\r\n                                    const pitchBend: number = Math.max(0, Math.min(0x3fff, Math.round(0x2000 * (1.0 + interval / pitchBendRange))));\r\n\r\n                                    const expression: number = Math.min(0x7f, Math.round(volumeMultToMidiExpression(Synth.noteSizeToVolumeMult(linearSize))));\r\n\r\n                                    if (pitchBend != prevPitchBend) {\r\n                                        writeEventTime(midiTickTime);\r\n                                        writer.writeUint8(MidiEventType.pitchBend | midiChannel);\r\n                                        writer.writeMidi7Bits(pitchBend & 0x7f); // least significant bits\r\n                                        writer.writeMidi7Bits((pitchBend >> 7) & 0x7f); // most significant bits\r\n                                        prevPitchBend = pitchBend;\r\n                                    }\r\n\r\n                                    if (expression != prevExpression && !isDrumset) {\r\n                                        writeEventTime(midiTickTime);\r\n                                        writeControlEvent(MidiControlEventMessage.expressionMSB, expression);\r\n                                        prevExpression = expression;\r\n                                    }\r\n\r\n                                    const noteStarting: boolean = midiTickTime == noteStartTime;\r\n                                    for (let toneIndex: number = 0; toneIndex < toneCount; toneIndex++) {\r\n                                        let nextPitch: number = note.pitches[toneIndex];\r\n                                        if (isDrumset) {\r\n                                            nextPitch += mainInterval;\r\n                                            const drumsetMap: number[] = [\r\n                                                36, // Bass Drum 1\r\n                                                41, // Low Floor Tom\r\n                                                45, // Low Tom\r\n                                                48, // Hi-Mid Tom\r\n                                                40, // Electric Snare\r\n                                                39, // Hand Clap\r\n                                                59, // Ride Cymbal 2\r\n                                                49, // Crash Cymbal 1\r\n                                                46, // Open Hi-Hat\r\n                                                55, // Splash Cymbal\r\n                                                69, // Cabasa\r\n                                                54, // Tambourine\r\n                                            ];\r\n                                            if (nextPitch < 0 || nextPitch >= drumsetMap.length) throw new Error(\"Could not find corresponding drumset pitch. \" + nextPitch);\r\n                                            nextPitch = drumsetMap[nextPitch];\r\n                                        } else {\r\n                                            if (usesArpeggio && note.pitches.length > toneIndex + 1 && toneIndex == toneCount - 1) {\r\n                                                const midiTicksSinceBeat = (midiTickTime - barStartTime) % midiTicksPerBeat;\r\n                                                const midiTicksPerArpeggio = Config.ticksPerArpeggio * midiTicksPerPart / Config.ticksPerPart;\r\n                                                const arpeggio: number = Math.floor(midiTicksSinceBeat / midiTicksPerArpeggio);\r\n                                                nextPitch = note.pitches[toneIndex + getArpeggioPitchIndex(note.pitches.length - toneIndex, instrument.fastTwoNoteArp, arpeggio)];\r\n                                            }\r\n                                            nextPitch = channelRoot + nextPitch * intervalScale + pitchOffset;\r\n                                            if (preset != null && preset.midiSubharmonicOctaves != undefined) {\r\n                                                nextPitch += 12 * preset.midiSubharmonicOctaves;\r\n                                            } else if (isNoise) {\r\n                                                nextPitch += 12 * (+EditorConfig.presetCategories.dictionary[\"Drum Presets\"].presets.dictionary[\"taiko drum\"].midiSubharmonicOctaves!);\r\n                                            }\r\n\r\n                                            if (isNoise) nextPitch *= 2;\r\n                                        }\r\n                                        nextPitch = Math.max(0, Math.min(127, nextPitch));\r\n                                        nextPitches[toneIndex] = nextPitch;\r\n\r\n                                        if (!noteStarting && prevPitches[toneIndex] != nextPitches[toneIndex]) {\r\n                                            writeEventTime(midiTickTime);\r\n                                            writer.writeUint8(MidiEventType.noteOff | midiChannel);\r\n                                            writer.writeMidi7Bits(prevPitches[toneIndex]); // old pitch\r\n                                            writer.writeMidi7Bits(velocity); // velocity\r\n                                        }\r\n                                    }\r\n\r\n                                    for (let toneIndex: number = 0; toneIndex < toneCount; toneIndex++) {\r\n                                        if (noteStarting || prevPitches[toneIndex] != nextPitches[toneIndex]) {\r\n                                            writeEventTime(midiTickTime);\r\n                                            writer.writeUint8(MidiEventType.noteOn | midiChannel);\r\n                                            writer.writeMidi7Bits(nextPitches[toneIndex]); // new pitch\r\n                                            writer.writeMidi7Bits(velocity); // velocity\r\n                                            prevPitches[toneIndex] = nextPitches[toneIndex];\r\n                                        }\r\n                                    }\r\n                                }\r\n\r\n                                pinTime = nextPinTime;\r\n                                pinSize = nextPinSize;\r\n                                pinInterval = nextPinInterval;\r\n                            }\r\n\r\n\t\t\t\t\t\t\tconst noteEndTime: number = barStartTime + note.end * midiTicksPerPart;\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t// End all tones.\r\n\t\t\t\t\t\t\tfor (let toneIndex: number = 0; toneIndex < toneCount; toneIndex++) {\r\n\t\t\t\t\t\t\t\t// TODO: If the note at the start of the next pattern has\r\n\t\t\t\t\t\t\t\t// continuesLastPattern and has the same chord, it ought to extend\r\n\t\t\t\t\t\t\t\t// this previous note.\r\n\t\t\t\t\t\t\t\twriteEventTime(noteEndTime);\r\n\t\t\t\t\t\t\t\twriter.writeUint8(MidiEventType.noteOff | midiChannel);\r\n\t\t\t\t\t\t\t\twriter.writeMidi7Bits(prevPitches[toneIndex]); // pitch\r\n\t\t\t\t\t\t\t\twriter.writeMidi7Bits(velocity); // velocity\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tshouldResetExpressionAndPitchBend = true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tif (shouldResetExpressionAndPitchBend) {\r\n\t\t\t\t\t\t\tshouldResetExpressionAndPitchBend = false;\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif (prevExpression != defaultMidiExpression) {\r\n\t\t\t\t\t\t\t\tprevExpression = defaultMidiExpression;\r\n\t\t\t\t\t\t\t\t// Reset expression\r\n\t\t\t\t\t\t\t\twriteEventTime(barStartTime);\r\n\t\t\t\t\t\t\t\twriteControlEvent(MidiControlEventMessage.expressionMSB, prevExpression);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif (prevPitchBend != defaultMidiPitchBend) {\r\n\t\t\t\t\t\t\t\t// Reset pitch bend\r\n\t\t\t\t\t\t\t\tprevPitchBend = defaultMidiPitchBend;\r\n\t\t\t\t\t\t\t\twriteEventTime(barStartTime);\r\n\t\t\t\t\t\t\t\twriter.writeUint8(MidiEventType.pitchBend | midiChannel);\r\n\t\t\t\t\t\t\t\twriter.writeMidi7Bits(prevPitchBend & 0x7f); // least significant bits\r\n\t\t\t\t\t\t\t\twriter.writeMidi7Bits((prevPitchBend >> 7) & 0x7f); // most significant bits\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tbarStartTime += midiTicksPerBar;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\twriteEventTime(barStartTime);\r\n\t\t\twriter.writeUint8(MidiEventType.meta);\r\n\t\t\twriter.writeMidi7Bits(MidiMetaEventMessage.endOfTrack);\r\n\t\t\twriter.writeMidiVariableLength(0x00);\r\n\t\t\t\r\n\t\t\t// Finally, write the length of the track in bytes at the front of the track.\r\n\t\t\twriter.rewriteUint32(trackStartIndex, writer.getWriteIndex() - trackStartIndex - 4);\r\n\t\t}\r\n\t\t\r\n\t\tconst blob: Blob = new Blob([writer.toCompactArrayBuffer()], {type: \"audio/midi\"});\r\n\t\tsave(blob, this._fileName.value.trim() + \".mid\");\r\n\t\t\r\n\t\tthis._close();\r\n\t}\r\n\t\r\n\tprivate _exportToJson(): void {\r\n\t\tconst jsonObject: Object = this._doc.song.toJsonObject(this._enableIntro.checked, Number(this._loopDropDown.value), this._enableOutro.checked);\r\n\t\tconst jsonString: string = JSON.stringify(jsonObject, null, '\\t');\r\n\t\tconst blob: Blob = new Blob([jsonString], {type: \"application/json\"});\r\n\t\tsave(blob, this._fileName.value.trim() + \".json\");\r\n\t\tthis._close();\r\n    }\r\n\r\n    private _exportToHtml(): void {\r\n        const fileContents = `\\\r\n<!DOCTYPE html><meta charset=\"utf-8\">\r\n\r\nYou should be redirected to the song at:<br /><br />\r\n\r\n<a id=\"destination\" href=\"${new URL(\"#\" + this._doc.song.toBase64String(), location.href).href}\"></a>\r\n\r\n<style>\r\n\t:root {\r\n\t\tcolor: white;\r\n\t\tbackground: black;\r\n\t\tfont-family:\r\n\t\tsans-serif;\r\n\t}\r\n\ta {\r\n\t\tcolor: #98f;\r\n\t}\r\n\ta[href]::before {\r\n\t\tcontent: attr(href);\r\n\t}\r\n</style>\r\n\r\n<script>\r\n\tlocation.assign(document.querySelector(\"a#destination\").href);\r\n</script>\r\n`;\r\n        const blob: Blob = new Blob([fileContents], { type: \"text/html\" });\r\n        save(blob, this._fileName.value.trim() + \".html\");\r\n        this._close();\r\n    }\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { HTML } from \"imperative-html/dist/esm/elements-strict\";\r\nimport { ColorConfig } from \"./ColorConfig\";\r\n\r\nexport class Layout {\r\n\tprivate static readonly _layoutMap: {[K: string]: string} = {\r\n\t\t\"small\": \"\",\r\n\t\t\"long\": `\\\r\n\r\n\t\t\t/* long layout */\r\n\t\t\t@media (min-width: 711px) {\r\n\t\t\t\t#beepboxEditorContainer {\r\n\t\t\t\t\tmax-width: initial;\r\n\t\t\t\t\theight: 100vh;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor {\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t\theight: 100vh;\r\n\t\t\t\t\tgrid-template-columns: minmax(0, 1fr) 390px; /* minmax(0, 1fr) min-content; Chrome 80 grid layout regression. https://bugs.chromium.org/p/chromium/issues/detail?id=1050307 */\r\n\t\t\t\t\tgrid-template-rows: minmax(481px, 1fr) minmax(0, min-content);\r\n\t\t\t\t\tgrid-template-areas: \"pattern-area settings-area\" \"track-area track-area\";\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .pattern-area {\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t\theight: 100%;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .track-area {\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t\tdisplay: flex;\r\n\t\t\t\t\tflex-direction: column;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer {\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t\tmin-height: 0;\r\n\t\t\t\t\tflex: 1;\r\n\t\t\t\t\toverflow: auto;\r\n\t\t\t\t\tmax-height: 97.5vh;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .instrument-settings-area {\r\n\t\t\t\t\toverflow-y: auto;\r\n\t\t\t\t\tposition: relative;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .instrument-settings-area > .editor-controls {\r\n\t\t\t\t\tposition: absolute;\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .song-settings-area {\r\n\t\t\t\t\toverflow-y: auto;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t.beepboxEditor .settings-area {\r\n\t\t\t\t\twidth: 390px;\r\n\t\t\t\t\tgrid-template-columns: minmax(0, 1fr) minmax(0, 1fr);\r\n\t\t\t\t\tgrid-template-rows: auto auto auto minmax(0, 1fr);\r\n\t\t\t\t\tgrid-template-areas:\r\n\t\t\t\t\t\t\"instrument-settings-area version-area\"\r\n\t\t\t\t\t\t\"instrument-settings-area play-pause-area\"\r\n\t\t\t\t\t\t\"instrument-settings-area menu-area\"\r\n\t\t\t\t\t\t\"instrument-settings-area song-settings-area\";\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t.beepboxEditor .barScrollBar {\r\n\t\t\t\t\tdisplay: none;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor.selectRow {\r\n\t\t\t\t\theight: 2em;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .operatorRow {\r\n\t\t\t\t\theiht: 2em;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer {\r\n\t\t\t\t\tmax-height: 446px;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t.beepboxEditor .trackContainer {\r\n\t\t\t\t\toverflow: visible;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer {\r\n\t\t\t\t\tscrollbar-width: auto;\r\n\t\t\t\t\tscrollbar-color: ${ColorConfig.uiWidgetBackground} ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar {\r\n\t\t\t\t\twidth: 20px;\r\n\t\t\t\t\theight: 20px;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-track {\r\n\t\t\t\t\tbackground: ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-thumb {\r\n\t\t\t\t\tbackground-color: ${ColorConfig.uiWidgetBackground};\r\n\t\t\t\t\tborder: 3px solid ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-corner {\r\n\t\t\t\t\tbackground-color: ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t`,\r\n\t\t\"tall\": `\\\r\n\t\t\t/* tall layout */\r\n\t\t\t@media (min-width: 711px) {\r\n\t\t\t\t#beepboxEditorContainer {\r\n\t\t\t\t\tmax-width: initial;\r\n\t\t\t\t\theight: 100vh;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor {\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t\theight: 100vh;\r\n\t\t\t\t\tgrid-template-columns: minmax(0, 1fr) minmax(0, 1fr) 192px;\r\n\t\t\t\t\tgrid-template-rows: 1fr;\r\n\t\t\t\t\tgrid-template-areas: \"track-area pattern-area settings-area\";\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .pattern-area {\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t\theight: 100%;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .track-area {\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t\theight: 100%;\r\n\t\t\t\t\tdisplay: flex;\r\n\t\t\t\t\tflex-direction: column;\r\n\t\t\t\t\tjustify-content: center;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer {\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t\tmin-height: 0;\r\n\t\t\t\t\tflex: 0;\r\n\t\t\t\t\toverflow: auto;\r\n\t\t\t\t\tflex-basis: initial;\r\n\t\t\t\t\tflex-grow: 0;\r\n\t\t\t\t\tmax-height: 97.5vh;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .instrument-settings-area > .editor-controls {\r\n\t\t\t\t\tposition: absolute;\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t.beepboxEditor .settings-area {\r\n\t\t\t\t\twidth: 192px;\r\n\t\t\t\t\tposition: relative;\r\n\t\t\t\t\toverflow-y: auto;\r\n\t\t\t\t\tgrid-template-columns: minmax(0, 1fr);\r\n\t\t\t\t\tgrid-template-rows: auto auto auto auto minmax(0, 1fr);\r\n\t\t\t\t\tgrid-template-areas:\r\n\t\t\t\t\t\t\"version-area\"\r\n\t\t\t\t\t\t\"play-pause-area\"\r\n\t\t\t\t\t\t\"menu-area\"\r\n\t\t\t\t\t\t\"song-settings-area\"\r\n\t\t\t\t\t\t\"instrument-settings-area\";\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .version-area {\r\n\t\t\t\t\tposition: sticky;\r\n\t\t\t\t\ttop: 0;\r\n\t\t\t\t\tz-index: 1;\r\n\t\t\t\t\tbackground: ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .play-pause-area {\r\n\t\t\t\t\tposition: sticky;\r\n\t\t\t\t\ttop: 22px;\r\n\t\t\t\t\tz-index: 1;\r\n\t\t\t\t\tbackground: ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .menu-area {\r\n\t\t\t\t\tposition: sticky;\r\n\t\t\t\t\ttop: 82px;\r\n\t\t\t\t\tz-index: 1;\r\n\t\t\t\t\tbackground: ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t.beepboxEditor .barScrollBar {\r\n\t\t\t\t\tdisplay: none;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackContainer {\r\n\t\t\t\t\toverflow: visible;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer {\r\n\t\t\t\t\tscrollbar-width: auto;\r\n\t\t\t\t\tscrollbar-color: ${ColorConfig.uiWidgetBackground} ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar {\r\n\t\t\t\t\twidth: 20px;\r\n\t\t\t\t\theight: 20px;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-track {\r\n\t\t\t\t\tbackground: ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-thumb {\r\n\t\t\t\t\tbackground-color: ${ColorConfig.uiWidgetBackground};\r\n\t\t\t\t\tborder: 3px solid ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-corner {\r\n\t\t\t\t\tbackground-color: ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t`,\r\n\t\t\"wide\": `\\\r\n\t\t\t/* wide (JB) layout */\r\n\t\t\t@media (min-width: 1001px) {\r\n\t\t\t\t#beepboxEditorContainer {\r\n\t\t\t\t\tmax-width: initial;\r\n\t\t\t\t\theight: 100vh;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor {\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t\theight: 100vh;\r\n\t\t\t\t\tgrid-template-columns: 512px minmax(0, 1fr) 30em;\r\n\t\t\t\t\tgrid-template-rows: minmax(481px, 1fr) min-content;\r\n\t\t\t\t\tgrid-template-areas: \"track-area pattern-area settings-area\";\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .pattern-area {\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t\theight: 100%;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .track-area {\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t\theight: 100%;\r\n\t\t\t\t\tmax-height: 100%\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .editor-widget-column {\r\n\t\t\t\t\tflex: 0;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer {\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t\tflex: 0;\r\n\t\t\t\t\tflex-basis: initial;\r\n\t\t\t\t\tflex-grow: 0;\r\n\t\t\t\t\toverflow-y: auto;\r\n\t\t\t\t\tmax-height: 97.5vh;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .instrument-settings-area {\r\n\t\t\t\t\toverflow-y: auto;\r\n\t\t\t\t\tposition: relative;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .instrument-settings-area > .editor-controls {\r\n\t\t\t\t\tposition: absolute;\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t.beepboxEditor .song-settings-area {\r\n\t\t\t\t\toverflow-y: auto;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t.beepboxEditor .settings-area {\r\n\t\t\t\t\twidth: 30em;\r\n\t\t\t\t\tgrid-template-columns: minmax(0, 1fr) minmax(0, 1fr);\r\n\t\t\t\t\tgrid-template-rows: auto auto auto minmax(0, 1fr);\r\n\t\t\t\t\tgrid-template-areas:\r\n\t\t\t\t\t\t\"instrument-settings-area version-area\"\r\n\t\t\t\t\t\t\"instrument-settings-area play-pause-area\"\r\n\t\t\t\t\t\t\"instrument-settings-area menu-area\"\r\n\t\t\t\t\t\t\"instrument-settings-area song-settings-area\";\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .version-area {\r\n\t\t\t\t\tposition: sticky;\r\n\t\t\t\t\ttop: 0;\r\n\t\t\t\t\tz-index: 1;\r\n\t\t\t\t\tbackground: ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .play-pause-area {\r\n\t\t\t\t\tposition: sticky;\r\n\t\t\t\t\ttop: 22px;\r\n\t\t\t\t\tz-index: 1;\r\n\t\t\t\t\tbackground: ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .menu-area {\r\n\t\t\t\t\tposition: sticky;\r\n\t\t\t\t\ttop: 82px;\r\n\t\t\t\t\tz-index: 1;\r\n\t\t\t\t\tbackground: ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t.beepboxEditor .trackContainer {\r\n\t\t\t\t\toverflow: visible;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t`,\r\n\t}\r\n\t\t\r\n\t\tprivate static readonly _styleElement: HTMLStyleElement = document.head.appendChild(HTML.style({type: \"text/css\"}));\r\n\t\t\r\n\tpublic static setLayout(layout: string): void {\r\n\t\tthis._styleElement.textContent = this._layoutMap[layout];\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { Config } from \"../synth/SynthConfig\";\r\nimport { HarmonicsWave, Instrument } from \"../synth/synth\";\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { HTML, SVG } from \"imperative-html/dist/esm/elements-strict\";\r\nimport { ColorConfig } from \"./ColorConfig\";\r\nimport { ChangeHarmonics } from \"./changes\";\r\nimport { prettyNumber } from \"./EditorConfig\";\r\n\r\nexport class HarmonicsEditor {\r\n\tprivate readonly _editorWidth: number = 120;\r\n\tprivate readonly _editorHeight: number = 26;\r\n\t\tprivate readonly _octaves: SVGSVGElement = SVG.svg({\"pointer-events\": \"none\"});\r\n\t\tprivate readonly _fifths: SVGSVGElement = SVG.svg({\"pointer-events\": \"none\"});\r\n\t\tprivate readonly _curve: SVGPathElement = SVG.path({fill: \"none\", stroke: \"currentColor\", \"stroke-width\": 2, \"pointer-events\": \"none\"});\r\n\tprivate readonly _lastControlPoints: SVGRectElement[] = [];\r\n\t\tprivate readonly _lastControlPointContainer: SVGSVGElement = SVG.svg({\"pointer-events\": \"none\"});\r\n\tprivate readonly _svg: SVGSVGElement = SVG.svg({ style: \"background-color: ${ColorConfig.editorBackground}; touch-action: none; cursor: crosshair;\", width: \"100%\", height: \"100%\", viewBox: \"0 0 \" + this._editorWidth + \" \" + this._editorHeight, preserveAspectRatio: \"none\" },\r\n\t\tthis._octaves,\r\n\t\tthis._fifths,\r\n\t\tthis._curve,\r\n\t\tthis._lastControlPointContainer,\r\n\t);\r\n\t\t\r\n\tpublic readonly container: HTMLElement = HTML.div({class: \"harmonics\", style: \"height: 100%;\"}, this._svg);\r\n\t\t\r\n\tprivate _mouseX: number = 0;\r\n\tprivate _mouseY: number = 0;\r\n\tprivate _freqPrev: number = 0;\r\n\tprivate _ampPrev: number = 0;\r\n\tprivate _mouseDown: boolean = false;\r\n\tprivate _change: ChangeHarmonics | null = null;\r\n\tprivate _renderedPath: String = \"\";\r\n\tprivate _renderedFifths: boolean = true;\r\n\t\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tfor (let i: number = 1; i <= Config.harmonicsControlPoints; i = i * 2) {\r\n\t\t\t\tthis._octaves.appendChild(SVG.rect({fill: ColorConfig.tonic, x: (i-0.5) * (this._editorWidth - 8) / (Config.harmonicsControlPoints - 1) - 1, y: 0, width: 2, height: this._editorHeight}));\r\n\t\t}\r\n\t\tfor (let i: number = 3; i <= Config.harmonicsControlPoints; i = i * 2) {\r\n\t\t\t\tthis._fifths.appendChild(SVG.rect({fill: ColorConfig.fifthNote, x: (i-0.5) * (this._editorWidth - 8) / (Config.harmonicsControlPoints - 1) - 1, y: 0, width: 2, height: this._editorHeight}));\r\n\t\t}\r\n\t\tfor (let i: number = 0; i < 4; i++) {\r\n\t\t\t\tconst rect: SVGRectElement = SVG.rect({fill: \"currentColor\", x: (this._editorWidth - i * 2 - 1), y: 0, width: 1, height: this._editorHeight});\r\n\t\t\tthis._lastControlPoints.push(rect);\r\n\t\t\tthis._lastControlPointContainer.appendChild(rect);\r\n\t\t}\r\n\t\t\t\r\n\t\tthis.container.addEventListener(\"mousedown\", this._whenMousePressed);\r\n\t\tdocument.addEventListener(\"mousemove\", this._whenMouseMoved);\r\n\t\tdocument.addEventListener(\"mouseup\", this._whenCursorReleased);\r\n\t\t\t\r\n\t\tthis.container.addEventListener(\"touchstart\", this._whenTouchPressed);\r\n\t\tthis.container.addEventListener(\"touchmove\", this._whenTouchMoved);\r\n\t\tthis.container.addEventListener(\"touchend\", this._whenCursorReleased);\r\n\t\tthis.container.addEventListener(\"touchcancel\", this._whenCursorReleased);\r\n\t}\r\n\t\t\r\n\tprivate _xToFreq(x: number): number {\r\n\t\treturn (Config.harmonicsControlPoints - 1) * x / (this._editorWidth - 8) - 0.5;\r\n\t}\r\n\t\t\r\n\tprivate _yToAmp(y: number): number {\r\n\t\treturn Config.harmonicsMax * (1 - y / this._editorHeight);\r\n\t}\r\n\t\t\r\n\tprivate _whenMousePressed = (event: MouseEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = ((event.clientX || event.pageX) - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\t    \r\n\t\tthis._freqPrev = this._xToFreq(this._mouseX);\r\n\t\tthis._ampPrev = this._yToAmp(this._mouseY);\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\t\r\n\tprivate _whenTouchPressed = (event: TouchEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.touches[0].clientX - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\t    \r\n\t\tthis._freqPrev = this._xToFreq(this._mouseX);\r\n\t\tthis._ampPrev = this._yToAmp(this._mouseY);\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\t\r\n\tprivate _whenMouseMoved = (event: MouseEvent): void => {\r\n\t\tif (this.container.offsetParent == null) return;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = ((event.clientX || event.pageX) - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\t\r\n\tprivate _whenTouchMoved = (event: TouchEvent): void => {\r\n\t\tif (this.container.offsetParent == null) return;\r\n\t\tif (!this._mouseDown) return;\r\n\t\tevent.preventDefault();\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.touches[0].clientX - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\t\r\n\tprivate _whenCursorMoved(): void {\r\n\t\tif (this._mouseDown) {\r\n\t\t\tconst freq: number = this._xToFreq(this._mouseX);\r\n\t\t\tconst amp: number = this._yToAmp(this._mouseY);\r\n\t\t\t\t\r\n\t\t\tconst instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\t\tconst harmonicsWave: HarmonicsWave = instrument.harmonicsWave; //(this._harmonicsIndex == null) ? instrument.harmonicsWave : instrument.drumsetSpectrumWaves[this._harmonicsIndex];\r\n\t\t\t\t\r\n\t\t\tif (freq != this._freqPrev) {\r\n\t\t\t\tconst slope: number = (amp - this._ampPrev) / (freq - this._freqPrev);\r\n\t\t\t\tconst offset: number = this._ampPrev - this._freqPrev * slope;\r\n\t\t\t\tconst lowerFreq: number = Math.ceil(Math.min(this._freqPrev, freq));\r\n\t\t\t\tconst upperFreq: number = Math.floor(Math.max(this._freqPrev, freq));\r\n\t\t\t\tfor (let i: number = lowerFreq; i <= upperFreq; i++) {\r\n\t\t\t\t\tif (i < 0 || i >= Config.harmonicsControlPoints) continue;\r\n\t\t\t\t\tharmonicsWave.harmonics[i] = Math.max(0, Math.min(Config.harmonicsMax, Math.round(i * slope + offset)));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\t\r\n\t\t\tharmonicsWave.harmonics[Math.max(0, Math.min(Config.harmonicsControlPoints - 1, Math.round(freq)))] = Math.max(0, Math.min(Config.harmonicsMax, Math.round(amp)));\r\n\t\t\t\t\r\n\t\t\tthis._freqPrev = freq;\r\n\t\t\tthis._ampPrev = amp;\r\n\t\t\t\t\r\n\t\t\tthis._change = new ChangeHarmonics(this._doc, instrument, harmonicsWave);\r\n\t\t\tthis._doc.setProspectiveChange(this._change);\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tprivate _whenCursorReleased = (event: Event): void => {\r\n\t\tif (this._mouseDown) {\r\n\t\t\tthis._doc.record(this._change!);\r\n\t\t\tthis._change = null;\r\n\t\t}\r\n\t\tthis._mouseDown = false;\r\n\t}\r\n\t\t\r\n\tpublic render(): void {\r\n\t\tconst instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\tconst harmonicsWave: HarmonicsWave = instrument.harmonicsWave; //(this._harmonicsIndex == null) ? instrument.harmonicsWave : instrument.drumsetSpectrumWaves[this._harmonicsIndex];\r\n\t\tconst controlPointToHeight = (point: number): number => {\r\n\t\t\treturn (1 - (point / Config.harmonicsMax)) * this._editorHeight;\r\n\t\t}\r\n\t\t\t\r\n\t\tlet bottom: string = prettyNumber(this._editorHeight);\r\n\t\tlet path: string = \"\";\r\n\t\tfor (let i: number = 0; i < Config.harmonicsControlPoints - 1; i++) {\r\n\t\t\tif (harmonicsWave.harmonics[i] == 0) continue;\r\n\t\t\tlet xPos: string = prettyNumber((i + 0.5) * (this._editorWidth - 8) / (Config.harmonicsControlPoints - 1));\r\n\t\t\tpath += \"M \" + xPos + \" \" + bottom + \" \";\r\n\t\t\tpath += \"L \" + xPos + \" \" + prettyNumber(controlPointToHeight(harmonicsWave.harmonics[i])) + \" \";\r\n\t\t}\r\n\t\t\t\r\n\t\tconst lastHeight: number = controlPointToHeight(harmonicsWave.harmonics[Config.harmonicsControlPoints - 1]);\r\n\t\tfor (let i: number = 0; i < 4; i++) {\r\n\t\t\tconst rect: SVGRectElement = this._lastControlPoints[i];\r\n\t\t\trect.setAttribute(\"y\", prettyNumber(lastHeight));\r\n\t\t\trect.setAttribute(\"height\", prettyNumber(this._editorHeight - lastHeight));\r\n\t\t}\r\n\t\t\t\r\n\t\tif (this._renderedPath != path) {\r\n\t\t\tthis._renderedPath = path;\r\n\t\t\tthis._curve.setAttribute(\"d\", path);\r\n\t\t}\r\n\t\tif (this._renderedFifths != this._doc.prefs.showFifth) {\r\n\t\t\tthis._renderedFifths = this._doc.prefs.showFifth;\r\n\t\t\tthis._fifths.style.display = this._doc.prefs.showFifth ? \"\" : \"none\";\r\n\t\t}\r\n\t}\r\n}\r\n","// Copyright (C) 2020 John Nesky, distributed under the MIT license.\r\n// A few wrapper classes that add functionality onto existing HTML elements, namely binding some events to an implementation-specified change class\r\n\r\nimport { Change } from \"./Change\";\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { HTML } from \"imperative-html/dist/esm/elements-strict\";\r\n\r\nconst { span } = HTML;\r\n\r\nexport class InputBox {\r\n\tprivate _change: Change | null = null;\r\n\tprivate _value: string = \"\";\r\n\tprivate _oldValue: string = \"\";\r\n\r\n\tconstructor(public readonly input: HTMLInputElement, private readonly _doc: SongDocument, private readonly _getChange: (oldValue: string, newValue: string) => Change) {\r\n\t\tinput.addEventListener(\"input\", this._whenInput);\r\n\t\tinput.addEventListener(\"change\", this._whenChange);\r\n\t}\r\n\r\n\tpublic updateValue(value: string): void {\r\n\t\tthis._value = value;\r\n\t\tthis.input.value = String(value);\r\n\t}\r\n\r\n\tprivate _whenInput = (): void => {\r\n\t\tconst continuingProspectiveChange: boolean = this._doc.lastChangeWas(this._change);\r\n\t\tif (!continuingProspectiveChange) this._oldValue = this._value;\r\n\t\tthis._change = this._getChange(this._oldValue, this.input.value);\r\n\t\tthis._doc.setProspectiveChange(this._change);\r\n\t};\r\n\r\n\tprivate _whenChange = (): void => {\r\n\t\tthis._doc.record(this._change!);\r\n\t\tthis._change = null;\r\n\t};\r\n}\r\n\r\nexport class Slider {\r\n\tprivate _change: Change | null = null;\r\n\tprivate _value: number = 0;\r\n\tprivate _oldValue: number = 0;\r\n\tpublic container: HTMLSpanElement;\r\n\r\n\tconstructor(public readonly input: HTMLInputElement, private readonly _doc: SongDocument, private readonly _getChange: ((oldValue: number, newValue: number) => Change) | null, midTick: boolean) {\r\n\t\t// A container is created around the input to allow for spec-compliant pseudo css classes (e.g ::before and ::after, which must be added to containers, not the input itself)\r\n\t\tthis.container = (midTick) ? span({ class: \"midTick\", style: \"position: sticky; width: 61.5%;\" }, input) : span({ style: \"position: sticky;\" }, input);\r\n\t\tinput.addEventListener(\"input\", this._whenInput);\r\n\t\tinput.addEventListener(\"change\", this._whenChange);\r\n\t}\r\n\r\n\tpublic updateValue(value: number): void {\r\n\t\tthis._value = value;\r\n\t\tthis.input.value = String(value);\r\n\t}\r\n\r\n\tprivate _whenInput = (): void => {\r\n\t\tconst continuingProspectiveChange: boolean = this._doc.lastChangeWas(this._change);\r\n\t\tif (!continuingProspectiveChange) this._oldValue = this._value;\r\n\t\tif (this._getChange != null) {\r\n\t\t\tthis._change = this._getChange(this._oldValue, parseInt(this.input.value));\r\n\t\t\tthis._doc.setProspectiveChange(this._change);\r\n\t\t}\r\n\t};\r\n\r\n\tprivate _whenChange = (): void => {\r\n\t\tif (this._getChange != null) {\r\n\t\t\tthis._doc.record(this._change!);\r\n\t\t\tthis._change = null;\r\n\t\t}\r\n\t};\r\n}","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\n// Note: All methods are big endian.\r\nexport class ArrayBufferReader {\r\n\tprivate _readIndex: number = 0;\r\n\tprivate _data: DataView;\r\n\t\t\r\n\tconstructor(data: DataView) {\r\n\t\tthis._data = data;\r\n\t}\r\n\t\t\r\n\tpublic getReadIndex(): number {\r\n\t\treturn this._readIndex;\r\n\t}\r\n\t\t\r\n\tpublic readUint32(): number {\r\n\t\tif (this._readIndex + 4 > this._data.byteLength) throw new Error(\"Reading past the end of the buffer.\");\r\n\t\tconst result: number = this._data.getUint32(this._readIndex, false);\r\n\t\tthis._readIndex += 4;\r\n\t\treturn result;\r\n\t}\r\n\t\t\r\n\tpublic readUint24(): number {\r\n\t\treturn (this.readUint8() << 16) | (this.readUint8() << 8) | (this.readUint8());\r\n\t}\r\n\t\t\r\n\tpublic readUint16(): number {\r\n\t\tif (this._readIndex + 2 > this._data.byteLength) throw new Error(\"Reading past the end of the buffer.\");\r\n\t\tconst result: number = this._data.getUint16(this._readIndex, false);\r\n\t\tthis._readIndex += 2;\r\n\t\treturn result;\r\n\t}\r\n\t\t\r\n\tpublic readUint8(): number {\r\n\t\tif (this._readIndex + 1 > this._data.byteLength) throw new Error(\"Reading past the end of the buffer.\");\r\n\t\tconst result: number = this._data.getUint8(this._readIndex);\r\n\t\tthis._readIndex++;\r\n\t\treturn result;\r\n\t}\r\n\t\t\r\n\tpublic readInt8(): number {\r\n\t\tif (this._readIndex + 1 > this._data.byteLength) throw new Error(\"Reading past the end of the buffer.\");\r\n\t\tconst result: number = this._data.getInt8(this._readIndex);\r\n\t\tthis._readIndex++;\r\n\t\treturn result;\r\n\t}\r\n\t\t\r\n\tpublic peakUint8(): number {\r\n\t\tif (this._readIndex + 1 > this._data.byteLength) throw new Error(\"Reading past the end of the buffer.\");\r\n\t\treturn this._data.getUint8(this._readIndex);\r\n\t}\r\n\t\t\r\n\tpublic readMidi7Bits(): number {\r\n\t\tconst result: number = this.readUint8();\r\n\t\tif (result >= 0x80) console.log(\"7 bit value contained 8th bit! value \" + result + \", index \" + this._readIndex);\r\n\t\treturn result & 0x7f;\r\n\t}\r\n\t\t\r\n\tpublic readMidiVariableLength(): number {\r\n\t\tlet result: number = 0;\r\n\t\tfor (let i: number = 0; i < 4; i++) {\r\n\t\t\tconst nextByte: number = this.readUint8();\r\n\t\t\tresult += nextByte & 0x7f;\r\n\t\t\tif (nextByte & 0x80) {\r\n\t\t\t\tresult = result << 7;\r\n\t\t\t} else {\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn result;\r\n\t}\r\n\t\t\r\n\tpublic skipBytes(length: number): void {\r\n\t\tthis._readIndex += length;\r\n\t}\r\n\t\t\r\n\tpublic hasMore(): boolean {\r\n\t\treturn this._data.byteLength > this._readIndex;\r\n\t}\r\n\t\t\r\n\tpublic getReaderForNextBytes(length: number): ArrayBufferReader {\r\n\t\tif (this._readIndex + length > this._data.byteLength) throw new Error(\"Reading past the end of the buffer.\");\r\n\t\tconst result: ArrayBufferReader = new ArrayBufferReader(new DataView(this._data.buffer, this._data.byteOffset + this._readIndex, length));\r\n\t\tthis.skipBytes(length);\r\n\t\treturn result;\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { InstrumentType, Config } from \"../synth/SynthConfig\";\r\nimport { NotePin, Note, makeNotePin, Pattern, Instrument, Channel, Song, Synth } from \"../synth/synth\";\r\nimport { Preset, EditorConfig } from \"./EditorConfig\";\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { Prompt } from \"./Prompt\";\r\nimport { HTML } from \"imperative-html/dist/esm/elements-strict\";\r\nimport { ChangeGroup } from \"./Change\";\r\nimport { removeDuplicatePatterns, ChangeSong, ChangeReplacePatterns } from \"./changes\";\r\nimport { AnalogousDrum, analogousDrumMap, MidiChunkType, MidiFileFormat, MidiEventType, MidiControlEventMessage, MidiMetaEventMessage, MidiRegisteredParameterNumberMSB, MidiRegisteredParameterNumberLSB, midiVolumeToVolumeMult, midiExpressionToVolumeMult } from \"./Midi\";\r\nimport { ArrayBufferReader } from \"./ArrayBufferReader\";\r\n\r\nconst {button, p, div, h2, input} = HTML;\r\n\r\nexport class ImportPrompt implements Prompt {\r\n\t\tprivate readonly _fileInput: HTMLInputElement = input({type: \"file\", accept: \".json,application/json,.mid,.midi,audio/midi,audio/x-midi\"});\r\n\t\tprivate readonly _cancelButton: HTMLButtonElement = button({class: \"cancelButton\"});\r\n\t\t\r\n\t\tpublic readonly container: HTMLDivElement = div({class: \"prompt noSelection\", style: \"width: 300px;\"},\r\n\t\th2(\"Import\"),\r\n\t\t\tp({style: \"text-align: left; margin: 0.5em 0;\"},\r\n\t\t\t\"BeepBox songs can be exported and re-imported as .json files. You could also use other means to make .json files for BeepBox as long as they follow the same structure.\",\r\n\t\t),\r\n\t\t\tp({style: \"text-align: left; margin: 0.5em 0;\"},\r\n\t\t\t\"BeepBox can also (crudely) import .mid files. There are many tools available for creating .mid files. Shorter and simpler songs are more likely to work well.\",\r\n\t\t),\r\n\t\tthis._fileInput,\r\n\t\tthis._cancelButton,\r\n\t);\r\n\t\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis._fileInput.select();\r\n\t\t\tsetTimeout(()=>this._fileInput.focus());\r\n\t\t\t\r\n\t\tthis._fileInput.addEventListener(\"change\", this._whenFileSelected);\r\n\t\tthis._cancelButton.addEventListener(\"click\", this._close);\r\n\t}\r\n\t\t\r\n\t\tprivate _close = (): void => { \r\n\t\tthis._doc.undo();\r\n\t}\r\n\t\t\r\n\t\tpublic cleanUp = (): void => { \r\n\t\tthis._fileInput.removeEventListener(\"change\", this._whenFileSelected);\r\n\t\tthis._cancelButton.removeEventListener(\"click\", this._close);\r\n\t}\r\n\t\t\r\n\tprivate _whenFileSelected = (): void => {\r\n\t\tconst file: File = this._fileInput.files![0];\r\n\t\tif (!file) return;\r\n\t\t\t\r\n\t\tconst extension: string = file.name.slice((file.name.lastIndexOf(\".\") - 1 >>> 0) + 2);\r\n\t\tif (extension == \"json\") {\r\n\t\t\tconst reader: FileReader = new FileReader();\r\n\t\t\treader.addEventListener(\"load\", (event: Event): void => {\r\n\t\t\t\tthis._doc.prompt = null;\r\n\t\t\t\tthis._doc.goBackToStart();\r\n\t\t\t\tthis._doc.record(new ChangeSong(this._doc, <string>reader.result), true, true);\r\n\t\t\t});\r\n\t\t\treader.readAsText(file);\r\n\t\t} else if (extension == \"midi\" || extension == \"mid\") {\r\n\t\t\tconst reader: FileReader = new FileReader();\r\n\t\t\treader.addEventListener(\"load\", (event: Event): void => {\r\n\t\t\t\tthis._doc.prompt = null;\r\n\t\t\t\tthis._doc.goBackToStart();\r\n\t\t\t\tthis._parseMidiFile(<ArrayBuffer>reader.result);\r\n\t\t\t});\r\n\t\t\treader.readAsArrayBuffer(file);\r\n\t\t} else {\r\n\t\t\tconsole.error(\"Unrecognized file extension.\");\r\n\t\t\tthis._close();\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tprivate _parseMidiFile(buffer: ArrayBuffer): void {\r\n\t\t\t\r\n\t\t// First, split the file into separate buffer readers for each chunk. There should be one header chunk and one or more track chunks.\r\n\t\tconst reader = new ArrayBufferReader(new DataView(buffer));\r\n\t\tlet headerReader: ArrayBufferReader | null = null;\r\n\t\tinterface Track {\r\n\t\t\treader: ArrayBufferReader;\r\n\t\t\tnextEventMidiTick: number;\r\n\t\t\tended: boolean;\r\n\t\t\trunningStatus: number;\r\n\t\t}\r\n\t\tconst tracks: Track[] = [];\r\n\t\t\twhile(reader.hasMore()) {\r\n\t\t\tconst chunkType: number = reader.readUint32();\r\n\t\t\tconst chunkLength: number = reader.readUint32();\r\n\t\t\tif (chunkType == MidiChunkType.header) {\r\n\t\t\t\tif (headerReader == null) {\r\n\t\t\t\t\theaderReader = reader.getReaderForNextBytes(chunkLength);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconsole.error(\"This MIDI file has more than one header chunk.\");\r\n\t\t\t\t}\r\n\t\t\t} else if (chunkType == MidiChunkType.track) {\r\n\t\t\t\tconst trackReader: ArrayBufferReader = reader.getReaderForNextBytes(chunkLength);\r\n\t\t\t\tif (trackReader.hasMore()) {\r\n\t\t\t\t\ttracks.push({\r\n\t\t\t\t\t\treader: trackReader,\r\n\t\t\t\t\t\tnextEventMidiTick: trackReader.readMidiVariableLength(),\r\n\t\t\t\t\t\tended: false,\r\n\t\t\t\t\t\trunningStatus: -1,\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t// Unknown chunk type. Skip it.\r\n\t\t\t\treader.skipBytes(chunkLength);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\t\r\n\t\tif (headerReader == null) {\r\n\t\t\tconsole.error(\"No header chunk found in this MIDI file.\");\r\n\t\t\tthis._close();\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst fileFormat: number = headerReader.readUint16();\r\n\t\t/*const trackCount: number =*/ headerReader.readUint16();\r\n\t\tconst midiTicksPerBeat: number = headerReader.readUint16();\r\n\t\t\t\r\n\t\t// Midi tracks are generally intended to be played in parallel, but in the format\r\n\t\t// MidiFileFormat.independentTracks, they are played in sequence. Make a list of all\r\n\t\t// of the track indices that should be played in parallel (one or all of the tracks).\r\n\t\tlet currentIndependentTrackIndex: number = 0;\r\n\t\tconst currentTrackIndices: number[] = [];\r\n\t\tconst independentTracks: boolean = (fileFormat == MidiFileFormat.independentTracks);\r\n\t\tif (independentTracks) {\r\n\t\t\tcurrentTrackIndices.push(currentIndependentTrackIndex);\r\n\t\t} else {\r\n\t\t\tfor (let trackIndex: number = 0; trackIndex < tracks.length; trackIndex++) {\r\n\t\t\t\tcurrentTrackIndices.push(trackIndex);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\t\r\n\t\tinterface NoteEvent {\r\n\t\t\tmidiTick: number;\r\n\t\t\tpitch: number;\r\n\t\t\tvelocity: number;\r\n\t\t\tprogram: number;\r\n\t\t\tinstrumentVolume: number;\r\n\t\t\tinstrumentPan: number;\r\n\t\t\ton: boolean;\r\n\t\t}\r\n\t\tinterface PitchBendEvent {\r\n\t\t\tmidiTick: number;\r\n\t\t\tinterval: number;\r\n\t\t}\r\n\t\tinterface NoteSizeEvent {\r\n\t\t\tmidiTick: number;\r\n\t\t\tsize: number;\r\n\t\t}\r\n\t\t\t\r\n\t\t// To read a MIDI file we have to simulate state changing over time.\r\n\t\t// Keep a record of various parameters for each channel that may\r\n\t\t// change over time, initialized to default values.\r\n\t\t// Consider making a MidiChannel class and single array of midiChannels.\r\n\t\t\tconst channelRPNMSB: number[] = [0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff];\r\n\t\t\tconst channelRPNLSB: number[] = [0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff];\r\n\t\t\tconst pitchBendRangeMSB: number[] = [2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2]; // pitch bend range defaults to 2 semitones.\r\n\t\t\tconst pitchBendRangeLSB: number[] = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]; // and 0 cents.\r\n\t\t\tconst currentInstrumentProgram: number[] = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];\r\n\t\t\tconst currentInstrumentVolumes: number[] = [100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100];\r\n\t\t\tconst currentInstrumentPans: number[] = [64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64];\r\n\t\t\tconst noteEvents: NoteEvent[][] = [[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]];\r\n\t\t\tconst pitchBendEvents: PitchBendEvent[][] = [[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]];\r\n\t\tconst noteSizeEvents: NoteSizeEvent[][] = [[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]];\r\n\t\tlet microsecondsPerBeat: number = 500000; // Tempo in microseconds per \"quarter\" note, commonly known as a \"beat\", default is equivalent to 120 beats per minute.\r\n\t\tlet beatsPerBar: number = 8;\r\n\t\tlet numSharps: number = 0;\r\n\t\tlet isMinor: boolean = false;\r\n\t\t\t\r\n\t\t// Progress in time through all tracks (in parallel or in sequence) recording state changes and events until all tracks have ended.\r\n\t\tlet currentMidiTick: number = 0;\r\n\t\twhile (true) {\r\n\t\t\tlet nextEventMidiTick: number = Number.MAX_VALUE;\r\n\t\t\tlet anyTrackHasMore: boolean = false;\r\n\t\t\tfor (const trackIndex of currentTrackIndices) {\r\n\t\t\t\t\t\r\n\t\t\t\t// Parse any events in this track that occur at the currentMidiTick.\r\n\t\t\t\tconst track: Track = tracks[trackIndex];\r\n\t\t\t\twhile (!track.ended && track.nextEventMidiTick == currentMidiTick) {\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t// If the most significant bit is set in the first byte\r\n\t\t\t\t\t// of the event, it's a new event status, otherwise\r\n\t\t\t\t\t// reuse the running status and save the next byte for\r\n\t\t\t\t\t// the content of the event. I'm assuming running status\r\n\t\t\t\t\t// is separate for each track.\r\n\t\t\t\t\tconst peakStatus: number = track.reader.peakUint8();\r\n\t\t\t\t\tconst eventStatus: number = (peakStatus & 0x80) ? track.reader.readUint8() : track.runningStatus;\r\n\t\t\t\t\tconst eventType: number = eventStatus & 0xF0;\r\n\t\t\t\t\tconst eventChannel: number = eventStatus & 0x0F;\r\n\t\t\t\t\tif (eventType != MidiEventType.metaAndSysex) {\r\n\t\t\t\t\t\ttrack.runningStatus = eventStatus;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tlet foundTrackEndEvent: boolean = false;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tswitch (eventType) {\r\n\t\t\t\t\t\tcase MidiEventType.noteOff: {\r\n\t\t\t\t\t\t\tconst pitch: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\t/*const velocity: number =*/ track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\t\tnoteEvents[eventChannel].push({midiTick: currentMidiTick, pitch: pitch, velocity: 0.0, program: -1, instrumentVolume: -1, instrumentPan: -1, on: false});\r\n\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\tcase MidiEventType.noteOn: {\r\n\t\t\t\t\t\t\tconst pitch: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\tconst velocity: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\tif (velocity == 0) {\r\n\t\t\t\t\t\t\t\t\tnoteEvents[eventChannel].push({midiTick: currentMidiTick, pitch: pitch, velocity: 0.0, program: -1, instrumentVolume: -1, instrumentPan: -1, on: false});\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tconst volume: number = Math.max(0, Math.min(Config.volumeRange - 1, Math.round(\r\n\t\t\t\t\t\t\t\t\tSynth.volumeMultToInstrumentVolume(midiVolumeToVolumeMult(currentInstrumentVolumes[eventChannel]))\r\n\t\t\t\t\t\t\t\t)));\r\n\t\t\t\t\t\t\t\tconst pan: number = Math.max(0, Math.min(Config.panMax, Math.round(\r\n\t\t\t\t\t\t\t\t\t((currentInstrumentPans[eventChannel] - 64) / 63 + 1) * Config.panCenter\r\n\t\t\t\t\t\t\t\t)));\r\n\t\t\t\t\t\t\t\tnoteEvents[eventChannel].push({\r\n\t\t\t\t\t\t\t\t\tmidiTick: currentMidiTick,\r\n\t\t\t\t\t\t\t\t\tpitch: pitch,\r\n\t\t\t\t\t\t\t\t\tvelocity: Math.max(0.0, Math.min(1.0, (velocity + 14) / 90.0)),\r\n\t\t\t\t\t\t\t\t\tprogram: currentInstrumentProgram[eventChannel],\r\n\t\t\t\t\t\t\t\t\tinstrumentVolume: volume,\r\n\t\t\t\t\t\t\t\t\tinstrumentPan: pan,\r\n\t\t\t\t\t\t\t\t\ton: true,\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\tcase MidiEventType.keyPressure: {\r\n\t\t\t\t\t\t\t/*const pitch: number =*/ track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\t/*const pressure: number =*/ track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\tcase MidiEventType.controlChange: {\r\n\t\t\t\t\t\t\tconst message: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\tconst value: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\t//console.log(\"Control change, message:\", message, \"value:\", value);\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tswitch (message) {\r\n\t\t\t\t\t\t\t\tcase MidiControlEventMessage.setParameterMSB: {\r\n\t\t\t\t\t\t\t\t\tif (channelRPNMSB[eventChannel] == MidiRegisteredParameterNumberMSB.pitchBendRange && channelRPNLSB[eventChannel] == MidiRegisteredParameterNumberLSB.pitchBendRange) {\r\n\t\t\t\t\t\t\t\t\t\tpitchBendRangeMSB[eventChannel] = value;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\t\t\tcase MidiControlEventMessage.volumeMSB: {\r\n\t\t\t\t\t\t\t\t\tcurrentInstrumentVolumes[eventChannel] = value;\r\n\t\t\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\t\t\tcase MidiControlEventMessage.panMSB: {\r\n\t\t\t\t\t\t\t\t\tcurrentInstrumentPans[eventChannel] = value;\r\n\t\t\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\t\t\tcase MidiControlEventMessage.expressionMSB: {\r\n\t\t\t\t\t\t\t\t\tnoteSizeEvents[eventChannel].push({midiTick: currentMidiTick, size: Synth.volumeMultToNoteSize(midiExpressionToVolumeMult(value))});\r\n\t\t\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\t\t\tcase MidiControlEventMessage.setParameterLSB: {\r\n\t\t\t\t\t\t\t\t\tif (channelRPNMSB[eventChannel] == MidiRegisteredParameterNumberMSB.pitchBendRange && channelRPNLSB[eventChannel] == MidiRegisteredParameterNumberLSB.pitchBendRange) {\r\n\t\t\t\t\t\t\t\t\t\tpitchBendRangeLSB[eventChannel] = value;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\t\t\tcase MidiControlEventMessage.registeredParameterNumberLSB: {\r\n\t\t\t\t\t\t\t\t\tchannelRPNLSB[eventChannel] = value;\r\n\t\t\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\t\t\tcase MidiControlEventMessage.registeredParameterNumberMSB: {\r\n\t\t\t\t\t\t\t\t\tchannelRPNMSB[eventChannel] = value;\r\n\t\t\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\tcase MidiEventType.programChange: {\r\n\t\t\t\t\t\t\tconst program: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\tcurrentInstrumentProgram[eventChannel] = program;\r\n\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\tcase MidiEventType.channelPressure: {\r\n\t\t\t\t\t\t\t/*const pressure: number =*/ track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\tcase MidiEventType.pitchBend: {\r\n\t\t\t\t\t\t\tconst lsb: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\tconst msb: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tconst pitchBend: number = (((msb << 7) | lsb) / 0x2000) - 1.0;\r\n\t\t\t\t\t\t\tconst pitchBendRange: number = pitchBendRangeMSB[eventChannel] + pitchBendRangeLSB[eventChannel] * 0.01;\r\n\t\t\t\t\t\t\tconst interval: number = pitchBend * pitchBendRange;\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tpitchBendEvents[eventChannel].push({midiTick: currentMidiTick, interval: interval});\r\n\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\tcase MidiEventType.metaAndSysex: {\r\n\t\t\t\t\t\t\tif (eventStatus == MidiEventType.meta) {\r\n\t\t\t\t\t\t\t\tconst message: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\t\tconst length: number = track.reader.readMidiVariableLength();\r\n\t\t\t\t\t\t\t\t//console.log(\"Meta, message:\", message, \"length:\", length);\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tif (message == MidiMetaEventMessage.endOfTrack) {\r\n\t\t\t\t\t\t\t\t\tfoundTrackEndEvent = true;\r\n\t\t\t\t\t\t\t\t\ttrack.reader.skipBytes(length);\r\n\t\t\t\t\t\t\t\t} else if (message == MidiMetaEventMessage.tempo) {\r\n\t\t\t\t\t\t\t\t\tmicrosecondsPerBeat = track.reader.readUint24();\r\n\t\t\t\t\t\t\t\t\ttrack.reader.skipBytes(length - 3);\r\n\t\t\t\t\t\t\t\t} else if (message == MidiMetaEventMessage.timeSignature) {\r\n\t\t\t\t\t\t\t\t\tconst numerator: number = track.reader.readUint8();\r\n\t\t\t\t\t\t\t\t\tlet denominatorExponent: number = track.reader.readUint8();\r\n\t\t\t\t\t\t\t\t\t/*const midiClocksPerMetronome: number =*/ track.reader.readUint8();\r\n\t\t\t\t\t\t\t\t\t/*const thirtySecondNotesPer24MidiClocks: number =*/ track.reader.readUint8();\r\n\t\t\t\t\t\t\t\t\ttrack.reader.skipBytes(length - 4);\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t// A beat is a quarter note. \r\n\t\t\t\t\t\t\t\t\t// A ratio of 4/4, or 1/1, corresponds to 4 beats per bar.\r\n\t\t\t\t\t\t\t\t\t// Apply the numerator first.\r\n\t\t\t\t\t\t\t\t\tbeatsPerBar = numerator * 4;\r\n\t\t\t\t\t\t\t\t\t// Then apply the denominator, dividing by two until either\r\n\t\t\t\t\t\t\t\t\t// the denominator is satisfied or there's an odd number of\r\n\t\t\t\t\t\t\t\t\t// beats. BeepBox doesn't support fractional beats in a bar.\r\n\t\t\t\t\t\t\t\t\twhile ((beatsPerBar & 1) == 0 && (denominatorExponent > 0 || beatsPerBar > Config.beatsPerBarMax) && beatsPerBar >= Config.beatsPerBarMin * 2) {\r\n\t\t\t\t\t\t\t\t\t\tbeatsPerBar = beatsPerBar >> 1;\r\n\t\t\t\t\t\t\t\t\t\tdenominatorExponent = denominatorExponent - 1;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tbeatsPerBar = Math.max(Config.beatsPerBarMin, Math.min(Config.beatsPerBarMax, beatsPerBar));\r\n\t\t\t\t\t\t\t\t} else if (message == MidiMetaEventMessage.keySignature) {\r\n\t\t\t\t\t\t\t\t\tnumSharps = track.reader.readInt8(); // Note: can be negative for flats.\r\n\t\t\t\t\t\t\t\t\tisMinor = track.reader.readUint8() == 1; // 0: major, 1: minor\r\n\t\t\t\t\t\t\t\t\ttrack.reader.skipBytes(length - 2);\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\t// Ignore other meta event message types.\r\n\t\t\t\t\t\t\t\t\ttrack.reader.skipBytes(length);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t} else if (eventStatus == 0xF0 || eventStatus == 0xF7) {\r\n\t\t\t\t\t\t\t\t// Sysex events, just skip the data.\r\n\t\t\t\t\t\t\t\tconst length: number = track.reader.readMidiVariableLength();\r\n\t\t\t\t\t\t\t\ttrack.reader.skipBytes(length);\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tconsole.error(\"Unrecognized event status: \" + eventStatus);\r\n\t\t\t\t\t\t\t\tthis._close();\r\n\t\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\tdefault: {\r\n\t\t\t\t\t\t\tconsole.error(\"Unrecognized event type: \" + eventType);\r\n\t\t\t\t\t\t\tthis._close();\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tif (!foundTrackEndEvent && track.reader.hasMore()) {\r\n\t\t\t\t\t\ttrack.nextEventMidiTick = currentMidiTick + track.reader.readMidiVariableLength();\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\ttrack.ended = true;\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t// If the tracks are sequential, start the next track when this one ends.\r\n\t\t\t\t\t\tif (independentTracks) {\r\n\t\t\t\t\t\t\tcurrentIndependentTrackIndex++;\r\n\t\t\t\t\t\t\tif (currentIndependentTrackIndex < tracks.length) {\r\n\t\t\t\t\t\t\t\tcurrentTrackIndices[0] = currentIndependentTrackIndex;\r\n\t\t\t\t\t\t\t\ttracks[currentIndependentTrackIndex].nextEventMidiTick += currentMidiTick;\r\n\t\t\t\t\t\t\t\tnextEventMidiTick = Math.min(nextEventMidiTick, tracks[currentIndependentTrackIndex].nextEventMidiTick);\r\n\t\t\t\t\t\t\t\tanyTrackHasMore = true;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\tif (!track.ended) {\r\n\t\t\t\t\tanyTrackHasMore = true;\r\n\t\t\t\t\tnextEventMidiTick = Math.min(nextEventMidiTick, track.nextEventMidiTick);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\t\r\n\t\t\tif (anyTrackHasMore) {\r\n\t\t\t\tcurrentMidiTick = nextEventMidiTick;\r\n\t\t\t} else {\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\t\r\n\t\t// Now the MIDI file is fully parsed. Next, constuct BeepBox channels out of the data.\r\n\t\tconst microsecondsPerMinute: number = 60 * 1000 * 1000;\r\n\t\tconst beatsPerMinute: number = Math.max(Config.tempoMin, Math.min(Config.tempoMax, Math.round(microsecondsPerMinute / microsecondsPerBeat)));\r\n\t\tconst midiTicksPerPart: number = midiTicksPerBeat / Config.partsPerBeat;\r\n\t\tconst partsPerBar: number = Config.partsPerBeat * beatsPerBar;\r\n\t\tconst songTotalBars: number = Math.ceil(currentMidiTick / midiTicksPerPart / partsPerBar);\r\n\t\t\t\r\n\t\tfunction quantizeMidiTickToPart(midiTick: number): number {\r\n\t\t\treturn Math.round(midiTick / midiTicksPerPart);\r\n\t\t}\r\n\r\n\t\tlet key: number = numSharps;\r\n\t\tif (isMinor) key += 3; // Diatonic C Major has the same sharps/flats as A Minor, and these keys are 3 semitones apart.\r\n\t\tif ((key & 1) == 1) key += 6; // If the number of sharps/flats is odd, rotate it halfway around the circle of fifths. The key of C# has little in common with the key of C.\r\n\t\twhile (key < 0) key += 12; // Wrap around to a range from 0 to 11.\r\n\t\tkey = key % 12; // Wrap around to a range from 0 to 11.\r\n\t\t\t\r\n\t\t// Convert each midi channel into a BeepBox channel.\r\n\t\tconst pitchChannels: Channel[] = [];\r\n\t\tconst noiseChannels: Channel[] = [];\r\n\t\tconst modChannels: Channel[] = [];\r\n\t\tfor (let midiChannel: number = 0; midiChannel < 16; midiChannel++) {\r\n\t\t\tif (noteEvents[midiChannel].length == 0) continue;\r\n\t\t\t\t\r\n\t\t\tconst channel: Channel = new Channel();\r\n\t\t\t\t\r\n\t\t\tconst channelPresetValue: number | null = EditorConfig.midiProgramToPresetValue(noteEvents[midiChannel][0].program);\r\n\t\t\tconst channelPreset: Preset | null = (channelPresetValue == null) ? null : EditorConfig.valueToPreset(channelPresetValue);\r\n\t\t\t\t\r\n\t\t\tconst isDrumsetChannel: boolean = (midiChannel == 9);\r\n\t\t\tconst isNoiseChannel: boolean = isDrumsetChannel || (channelPreset != null && channelPreset.isNoise == true);\r\n\t\t\tconst isModChannel: boolean = (channelPreset != null && channelPreset.isMod == true);\r\n\t\t\tconst channelBasePitch: number = isNoiseChannel ? Config.spectrumBasePitch : Config.keys[key].basePitch;\r\n\t\t\tconst intervalScale: number = isNoiseChannel ? Config.noiseInterval : 1;\r\n\t\t\tconst midiIntervalScale: number = isNoiseChannel ? 0.5 : 1;\r\n\t\t\tconst channelMaxPitch: number = isNoiseChannel ? Config.drumCount - 1 : Config.maxPitch;\r\n\t\t\t\t\r\n\t\t\tif (isNoiseChannel) {\r\n\t\t\t\tif (isDrumsetChannel) {\r\n\t\t\t\t\tnoiseChannels.unshift(channel);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tnoiseChannels.push(channel);\r\n\t\t\t\t}\r\n\t\t\t} else if (isModChannel) {\r\n\t\t\t\tmodChannels.push(channel);\r\n\t\t\t} else {\r\n\t\t\t\tpitchChannels.push(channel);\r\n\t\t\t}\r\n\t\t\t\t\r\n\t\t\tlet currentVelocity: number = 1.0;\r\n\t\t\tlet currentProgram: number = 0;\r\n\t\t\tlet currentInstrumentVolume: number = 0;\r\n\t\t\tlet currentInstrumentPan: number = Config.panCenter;\r\n\t\t\t\t\r\n\t\t\tif (isDrumsetChannel) {\r\n\t\t\t\tconst heldPitches: number[] = [];\r\n\t\t\t\tlet currentBar: number = -1;\r\n\t\t\t\tlet pattern: Pattern | null = null;\r\n\t\t\t\tlet prevEventPart: number = 0;\r\n\t\t\t\tlet setInstrumentVolume: boolean = false;\r\n\t\t\t\t\t\r\n\t\t\t\tconst presetValue: number = EditorConfig.nameToPresetValue(\"standard drumset\")!;\r\n\t\t\t\tconst preset: Preset = EditorConfig.valueToPreset(presetValue)!;\r\n\t\t\t\tconst instrument: Instrument = new Instrument(false, false);\r\n\t\t\t\t\tinstrument.fromJsonObject(preset.settings, false, false, false, false, 1);\r\n\t\t\t\t\t\r\n\t\t\t\tinstrument.preset = presetValue;\r\n\t\t\t\tchannel.instruments.push(instrument);\r\n\r\n\t\t\t\tfor (let noteEventIndex: number = 0; noteEventIndex <= noteEvents[midiChannel].length; noteEventIndex++) {\r\n\t\t\t\t\tconst noMoreNotes: boolean = noteEventIndex == noteEvents[midiChannel].length;\r\n\t\t\t\t\tconst noteEvent: NoteEvent | null = noMoreNotes ? null : noteEvents[midiChannel][noteEventIndex];\r\n\t\t\t\t\tconst nextEventPart: number = noteEvent == null ? Number.MAX_SAFE_INTEGER : quantizeMidiTickToPart(noteEvent.midiTick);\r\n\t\t\t\t\tif (heldPitches.length > 0 && nextEventPart > prevEventPart && (noteEvent == null || noteEvent.on)) {\r\n\t\t\t\t\t\tconst bar: number = Math.floor(prevEventPart / partsPerBar);\r\n\t\t\t\t\t\tconst barStartPart: number = bar * partsPerBar;\r\n\t\t\t\t\t\t// Ensure a pattern exists for the current bar before inserting notes into it.\r\n\t\t\t\t\t\tif (currentBar != bar || pattern == null) {\r\n\t\t\t\t\t\t\tcurrentBar++;\r\n\t\t\t\t\t\t\twhile (currentBar < bar) {\r\n\t\t\t\t\t\t\t\tchannel.bars[currentBar] = 0;\r\n\t\t\t\t\t\t\t\tcurrentBar++;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tpattern = new Pattern();\r\n\t\t\t\t\t\t\tchannel.patterns.push(pattern);\r\n\t\t\t\t\t\t\tchannel.bars[currentBar] = channel.patterns.length;\r\n\t\t\t\t\t\t\tpattern.instruments[0] = 0;\r\n\t\t\t\t\t\t\tpattern.instruments.length = 1;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t// Use the loudest volume setting for the instrument, since \r\n\t\t\t\t\t\t// many midis unfortunately use the instrument volume control to fade\r\n\t\t\t\t\t\t// in at the beginning and we don't want to get stuck with the initial\r\n\t\t\t\t\t\t// zero volume.\r\n\t\t\t\t\t\tif (!setInstrumentVolume || instrument.volume > currentInstrumentVolume) {\r\n\t\t\t\t\t\t\tinstrument.volume = currentInstrumentVolume;\r\n\t\t\t\t\t\t\tinstrument.pan = currentInstrumentPan;\r\n\t\t\t\t\t\t\tinstrument.panDelay = 0;\r\n\t\t\t\t\t\t\tsetInstrumentVolume = true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tconst drumFreqs: number[] = [];\r\n\t\t\t\t\t\tlet minDuration: number = channelMaxPitch;\r\n\t\t\t\t\t\tlet maxDuration: number = 0;\r\n\t\t\t\t\t\tlet noteSize: number = 1; // the minimum non-zero note size.\r\n\t\t\t\t\t\tfor (const pitch of heldPitches) {\r\n\t\t\t\t\t\t\tconst drum: AnalogousDrum | undefined = analogousDrumMap[pitch];\r\n\t\t\t\t\t\t\tif (drumFreqs.indexOf(drum.frequency) == -1) {\r\n\t\t\t\t\t\t\t\tdrumFreqs.push(drum.frequency);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tnoteSize = Math.max(noteSize, Math.round(drum.volume * currentVelocity));\r\n\t\t\t\t\t\t\tminDuration = Math.min(minDuration, drum.duration);\r\n\t\t\t\t\t\t\tmaxDuration = Math.max(maxDuration, drum.duration);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tconst duration: number = Math.min(maxDuration, Math.max(minDuration, 2));\r\n\t\t\t\t\t\tconst noteStartPart: number = prevEventPart - barStartPart;\r\n\t\t\t\t\t\tconst noteEndPart: number = Math.min(partsPerBar, Math.min(nextEventPart - barStartPart, noteStartPart + duration * 6));\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tconst note: Note = new Note(-1, noteStartPart, noteEndPart, noteSize, true);\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tnote.pitches.length = 0;\r\n\t\t\t\t\t\tfor (let pitchIndex: number = 0; pitchIndex < Math.min(Config.maxChordSize, drumFreqs.length); pitchIndex++) {\r\n\t\t\t\t\t\t\tconst heldPitch: number = drumFreqs[pitchIndex + Math.max(0, drumFreqs.length - Config.maxChordSize)];\r\n\t\t\t\t\t\t\tif (note.pitches.indexOf(heldPitch) == -1) {\r\n\t\t\t\t\t\t\t\tnote.pitches.push(heldPitch);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tpattern.notes.push(note);\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\theldPitches.length = 0;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t// Process the next midi note event before continuing, updating the list of currently held pitches.\r\n\t\t\t\t\tif (noteEvent != null && noteEvent.on && analogousDrumMap[noteEvent.pitch] != undefined) {\r\n\t\t\t\t\t\theldPitches.push(noteEvent.pitch);\r\n\t\t\t\t\t\tprevEventPart = nextEventPart;\r\n\t\t\t\t\t\tcurrentVelocity = noteEvent.velocity;\r\n\t\t\t\t\t\tcurrentInstrumentVolume = noteEvent.instrumentVolume;\r\n\t\t\t\t\t\tcurrentInstrumentPan = noteEvent.instrumentPan;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t// If not a drumset, handle as a tonal instrument.\r\n\t\t\t\t\t\r\n\t\t\t\t// Advance the pitch bend and note size timelines to the given midiTick, \r\n\t\t\t\t// changing the value of currentMidiInterval or currentMidiNoteSize.\r\n\t\t\t\t// IMPORTANT: These functions can't rewind!\r\n\t\t\t\tlet currentMidiInterval: number = 0.0;\r\n\t\t\t\tlet currentMidiNoteSize: number = Config.noteSizeMax;\r\n\t\t\t\tlet pitchBendEventIndex: number = 0;\r\n\t\t\t\tlet noteSizeEventIndex: number = 0;\r\n\t\t\t\tfunction updateCurrentMidiInterval(midiTick: number) {\r\n\t\t\t\t\twhile (pitchBendEventIndex < pitchBendEvents[midiChannel].length && pitchBendEvents[midiChannel][pitchBendEventIndex].midiTick <= midiTick) {\r\n\t\t\t\t\t\tcurrentMidiInterval = pitchBendEvents[midiChannel][pitchBendEventIndex].interval;\r\n\t\t\t\t\t\tpitchBendEventIndex++;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tfunction updateCurrentMidiNoteSize(midiTick: number) {\r\n\t\t\t\t\twhile (noteSizeEventIndex < noteSizeEvents[midiChannel].length && noteSizeEvents[midiChannel][noteSizeEventIndex].midiTick <= midiTick) {\r\n\t\t\t\t\t\tcurrentMidiNoteSize = noteSizeEvents[midiChannel][noteSizeEventIndex].size;\r\n\t\t\t\t\t\tnoteSizeEventIndex++;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\tconst instrumentByProgram: Instrument[] = [];\r\n\t\t\t\tconst heldPitches: number[] = [];\r\n\t\t\t\tlet currentBar: number = -1;\r\n\t\t\t\tlet pattern: Pattern | null = null;\r\n\t\t\t\tlet prevEventMidiTick: number = 0;\r\n\t\t\t\tlet prevEventPart: number = 0;\r\n\t\t\t\tlet pitchSum: number = 0;\r\n\t\t\t\tlet pitchCount: number = 0;\r\n\t\t\t\t\t\r\n\t\t\t\tfor (let noteEvent of noteEvents[midiChannel]) {\r\n\t\t\t\t\tconst nextEventMidiTick: number = noteEvent.midiTick;\r\n\t\t\t\t\tconst nextEventPart: number = quantizeMidiTickToPart(nextEventMidiTick);\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tif (heldPitches.length > 0 && nextEventPart > prevEventPart) {\r\n\t\t\t\t\t\t// If there are any pitches held between the previous event and the next\r\n\t\t\t\t\t\t// event, iterate over all bars covered by this time period, ensure they\r\n\t\t\t\t\t\t// have a pattern instantiated, and insert notes for these pitches.\r\n\t\t\t\t\t\tconst startBar: number = Math.floor(prevEventPart / partsPerBar);\r\n\t\t\t\t\t\tconst endBar: number = Math.ceil(nextEventPart / partsPerBar);\r\n\t\t\t\t\t\tlet createdNote: boolean = false;\r\n\t\t\t\t\t\tfor (let bar: number = startBar; bar < endBar; bar++) {\r\n\t\t\t\t\t\t\tconst barStartPart: number = bar * partsPerBar;\r\n\t\t\t\t\t\t\tconst barStartMidiTick: number = bar * beatsPerBar * midiTicksPerBeat;\r\n\t\t\t\t\t\t\tconst barEndMidiTick: number = (bar + 1) * beatsPerBar * midiTicksPerBeat;\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tconst noteStartPart: number = Math.max(0, prevEventPart - barStartPart);\r\n\t\t\t\t\t\t\tconst noteEndPart: number = Math.min(partsPerBar, nextEventPart - barStartPart);\r\n\t\t\t\t\t\t\tconst noteStartMidiTick: number = Math.max(barStartMidiTick, prevEventMidiTick);\r\n\t\t\t\t\t\t\tconst noteEndMidiTick: number = Math.min(barEndMidiTick, nextEventMidiTick);\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif (noteStartPart < noteEndPart) {\r\n\t\t\t\t\t\t\t\tconst presetValue: number | null = EditorConfig.midiProgramToPresetValue(currentProgram);\r\n\t\t\t\t\t\t\t\tconst preset: Preset | null = (presetValue == null) ? null : EditorConfig.valueToPreset(presetValue);\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// Ensure a pattern exists for the current bar before inserting notes into it.\r\n\t\t\t\t\t\t\t\tif (currentBar != bar || pattern == null) {\r\n\t\t\t\t\t\t\t\t\tcurrentBar++;\r\n\t\t\t\t\t\t\t\t\twhile (currentBar < bar) {\r\n\t\t\t\t\t\t\t\t\t\tchannel.bars[currentBar] = 0;\r\n\t\t\t\t\t\t\t\t\t\tcurrentBar++;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tpattern = new Pattern();\r\n\t\t\t\t\t\t\t\t\tchannel.patterns.push(pattern);\r\n\t\t\t\t\t\t\t\t\tchannel.bars[currentBar] = channel.patterns.length;\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t// If this is the first time a note is trying to use a specific instrument\r\n\t\t\t\t\t\t\t\t\t// program in this channel, create a new BeepBox instrument for it.\r\n\t\t\t\t\t\t\t\t\tif (instrumentByProgram[currentProgram] == undefined) {\r\n\t\t\t\t\t\t\t\t\t\tconst instrument: Instrument = new Instrument(isNoiseChannel, isModChannel);\r\n\t\t\t\t\t\t\t\t\t\tinstrumentByProgram[currentProgram] = instrument;\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tif (presetValue != null && preset != null && (preset.isNoise == true) == isNoiseChannel) {\r\n\t\t\t\t\t\t\t\t\t\t\t\tinstrument.fromJsonObject(preset.settings, isNoiseChannel, isModChannel, false, false, 1);\r\n\t\t\t\t\t\t\t\t\t\t\tinstrument.preset = presetValue;\r\n\t\t\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\t\t\tinstrument.setTypeAndReset(isModChannel ? InstrumentType.mod : (isNoiseChannel ? InstrumentType.noise : InstrumentType.chip), isNoiseChannel, isModChannel);\r\n\t\t\t\t\t\t\t\t\t\t\tinstrument.chord = 0; // Midi instruments use polyphonic harmony by default.\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tinstrument.volume = currentInstrumentVolume;\r\n\t\t\t\t\t\t\t\t\t\tinstrument.pan = currentInstrumentPan;\r\n\t\t\t\t\t\t\t\t\t\tinstrument.panDelay = 0;\r\n\r\n\t\t\t\t\t\t\t\t\t\tchannel.instruments.push(instrument);\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tpattern.instruments[0] = channel.instruments.indexOf(instrumentByProgram[currentProgram]);\r\n\t\t\t\t\t\t\t\t\tpattern.instruments.length = 1;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// Use the loudest volume setting for the instrument, since \r\n\t\t\t\t\t\t\t\t// many midis unfortunately use the instrument volume control to fade\r\n\t\t\t\t\t\t\t\t// in at the beginning and we don't want to get stuck with the initial\r\n\t\t\t\t\t\t\t\t// zero volume.\r\n\t\t\t\t\t\t\t\tif (instrumentByProgram[currentProgram] != undefined) {\r\n\t\t\t\t\t\t\t\t\tinstrumentByProgram[currentProgram].volume = Math.min(instrumentByProgram[currentProgram].volume, currentInstrumentVolume);\r\n\t\t\t\t\t\t\t\t\tinstrumentByProgram[currentProgram].pan = Math.min(instrumentByProgram[currentProgram].pan, currentInstrumentPan);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// Create a new note, and interpret the pitch bend and note size events\r\n\t\t\t\t\t\t\t\t// to determine where we need to insert pins to control interval and size.\r\n\t\t\t\t\t\t\t\tconst note: Note = new Note(-1, noteStartPart, noteEndPart, Config.noteSizeMax, false);\r\n\t\t\t\t\t\t\t\tnote.pins.length = 0;\r\n\t\t\t\t\t\t\t\tnote.continuesLastPattern = (createdNote && noteStartPart == 0);\r\n\t\t\t\t\t\t\t\tcreatedNote = true;\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tupdateCurrentMidiInterval(noteStartMidiTick);\r\n\t\t\t\t\t\t\t\tupdateCurrentMidiNoteSize(noteStartMidiTick);\r\n\t\t\t\t\t\t\t\tconst shiftedHeldPitch: number = heldPitches[0] * midiIntervalScale - channelBasePitch;\r\n\t\t\t\t\t\t\t\tconst initialBeepBoxPitch: number = Math.round((shiftedHeldPitch + currentMidiInterval) / intervalScale);\r\n\t\t\t\t\t\t\t\tconst heldPitchOffset: number = Math.round(currentMidiInterval - channelBasePitch);\r\n\t\t\t\t\t\t\t\tlet firstPin: NotePin = makeNotePin(0, 0, Math.round(currentVelocity * currentMidiNoteSize));\r\n\t\t\t\t\t\t\t\tnote.pins.push(firstPin);\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tinterface PotentialPin {\r\n\t\t\t\t\t\t\t\t\tpart: number;\r\n\t\t\t\t\t\t\t\t\tpitch: number;\r\n\t\t\t\t\t\t\t\t\tsize: number;\r\n\t\t\t\t\t\t\t\t\tkeyPitch: boolean;\r\n\t\t\t\t\t\t\t\t\tkeySize: boolean;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tconst potentialPins: PotentialPin[] = [\r\n\t\t\t\t\t\t\t\t\t{part: 0, pitch: initialBeepBoxPitch, size: firstPin.size, keyPitch: false, keySize: false}\r\n\t\t\t\t\t\t\t\t];\r\n\t\t\t\t\t\t\t\tlet prevPinIndex: number = 0;\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tlet prevPartPitch: number = (shiftedHeldPitch + currentMidiInterval) / intervalScale;\r\n\t\t\t\t\t\t\t\tlet prevPartSize: number = currentVelocity * currentMidiNoteSize;\r\n\t\t\t\t\t\t\t\tfor (let part: number = noteStartPart + 1; part <= noteEndPart; part++) {\r\n\t\t\t\t\t\t\t\t\tconst midiTick: number = Math.max(noteStartMidiTick, Math.min(noteEndMidiTick - 1, Math.round(midiTicksPerPart * (part + barStartPart))));\r\n\t\t\t\t\t\t\t\t\tconst noteRelativePart: number = part - noteStartPart;\r\n\t\t\t\t\t\t\t\t\tconst lastPart: boolean = (part == noteEndPart);\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t// BeepBox can only add pins at whole number intervals and sizes. Detect places where\r\n\t\t\t\t\t\t\t\t\t// the interval or size are at or cross whole numbers, and add these to the list of\r\n\t\t\t\t\t\t\t\t\t// potential places to insert pins.\r\n\t\t\t\t\t\t\t\t\tupdateCurrentMidiInterval(midiTick);\r\n\t\t\t\t\t\t\t\t\tupdateCurrentMidiNoteSize(midiTick);\r\n\t\t\t\t\t\t\t\t\tconst partPitch: number = (currentMidiInterval + shiftedHeldPitch) / intervalScale;\r\n\t\t\t\t\t\t\t\t\tconst partSize: number = currentVelocity * currentMidiNoteSize;\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tconst nearestPitch: number = Math.round(partPitch);\r\n\t\t\t\t\t\t\t\t\tconst pitchIsNearInteger: boolean = Math.abs(partPitch - nearestPitch) < 0.01;\r\n\t\t\t\t\t\t\t\t\tconst pitchCrossedInteger: boolean = (Math.abs(prevPartPitch - Math.round(prevPartPitch)) < 0.01)\r\n\t\t\t\t\t\t\t\t\t\t? Math.abs(partPitch - prevPartPitch) >= 1.0\r\n\t\t\t\t\t\t\t\t\t\t: Math.floor(partPitch) != Math.floor(prevPartPitch);\r\n\t\t\t\t\t\t\t\t\tconst keyPitch: boolean = pitchIsNearInteger || pitchCrossedInteger;\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tconst nearestSize: number = Math.round(partSize);\r\n\t\t\t\t\t\t\t\t\tconst sizeIsNearInteger: boolean = Math.abs(partSize - nearestSize) < 0.01;\r\n\t\t\t\t\t\t\t\t\tconst sizeCrossedInteger: boolean = (Math.abs(prevPartSize - Math.round(prevPartSize)))\r\n\t\t\t\t\t\t\t\t\t\t? Math.abs(partSize - prevPartSize) >= 1.0\r\n\t\t\t\t\t\t\t\t\t\t: Math.floor(partSize) != Math.floor(prevPartSize);\r\n\t\t\t\t\t\t\t\t\tconst keySize: boolean = sizeIsNearInteger || sizeCrossedInteger;\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tprevPartPitch = partPitch;\r\n\t\t\t\t\t\t\t\t\tprevPartSize = partSize;\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tif (keyPitch || keySize || lastPart) {\r\n\t\t\t\t\t\t\t\t\t\tconst currentPin: PotentialPin = {part: noteRelativePart, pitch: nearestPitch, size: nearestSize, keyPitch: keyPitch || lastPart, keySize: keySize || lastPart};\r\n\t\t\t\t\t\t\t\t\t\tconst prevPin: PotentialPin = potentialPins[prevPinIndex];\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t// At all key points in the list of potential pins, check to see if they\r\n\t\t\t\t\t\t\t\t\t\t// continue the recent slope. If not, insert a pin at the corner, where\r\n\t\t\t\t\t\t\t\t\t\t// the recent recorded values deviate the furthest from the slope.\r\n\t\t\t\t\t\t\t\t\t\tlet addPin: boolean = false;\r\n\t\t\t\t\t\t\t\t\t\tlet addPinAtIndex: number = Number.MAX_VALUE;\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tif (currentPin.keyPitch) {\r\n\t\t\t\t\t\t\t\t\t\t\tconst slope: number = (currentPin.pitch - prevPin.pitch) / (currentPin.part - prevPin.part);\r\n\t\t\t\t\t\t\t\t\t\t\tlet furthestIntervalDistance: number = Math.abs(slope); // minimum distance to make a new pin.\r\n\t\t\t\t\t\t\t\t\t\t\tlet addIntervalPin: boolean = false;\r\n\t\t\t\t\t\t\t\t\t\t\tlet addIntervalPinAtIndex: number = Number.MAX_VALUE;\r\n\t\t\t\t\t\t\t\t\t\t\tfor (let potentialIndex: number = prevPinIndex + 1; potentialIndex < potentialPins.length; potentialIndex++) {\r\n\t\t\t\t\t\t\t\t\t\t\t\tconst potentialPin: PotentialPin = potentialPins[potentialIndex];\r\n\t\t\t\t\t\t\t\t\t\t\t\tif (potentialPin.keyPitch) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tconst interpolatedInterval: number = prevPin.pitch + slope * (potentialPin.part - prevPin.part);\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tconst distance: number = Math.abs(interpolatedInterval - potentialPin.pitch);\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tif (furthestIntervalDistance < distance) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfurthestIntervalDistance = distance;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\taddIntervalPin = true;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\taddIntervalPinAtIndex = potentialIndex;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\tif (addIntervalPin) {\r\n\t\t\t\t\t\t\t\t\t\t\t\taddPin = true;\r\n\t\t\t\t\t\t\t\t\t\t\t\taddPinAtIndex = Math.min(addPinAtIndex, addIntervalPinAtIndex);\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tif (currentPin.keySize) {\r\n\t\t\t\t\t\t\t\t\t\t\tconst slope: number = (currentPin.size - prevPin.size) / (currentPin.part - prevPin.part);\r\n\t\t\t\t\t\t\t\t\t\t\tlet furthestSizeDistance: number = Math.abs(slope); // minimum distance to make a new pin.\r\n\t\t\t\t\t\t\t\t\t\t\tlet addSizePin: boolean = false;\r\n\t\t\t\t\t\t\t\t\t\t\tlet addSizePinAtIndex: number = Number.MAX_VALUE;\r\n\t\t\t\t\t\t\t\t\t\t\tfor (let potentialIndex: number = prevPinIndex + 1; potentialIndex < potentialPins.length; potentialIndex++) {\r\n\t\t\t\t\t\t\t\t\t\t\t\tconst potentialPin: PotentialPin = potentialPins[potentialIndex];\r\n\t\t\t\t\t\t\t\t\t\t\t\tif (potentialPin.keySize) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tconst interpolatedSize: number = prevPin.size + slope * (potentialPin.part - prevPin.part);\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tconst distance: number = Math.abs(interpolatedSize - potentialPin.size);\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tif (furthestSizeDistance < distance) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfurthestSizeDistance = distance;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\taddSizePin = true;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\taddSizePinAtIndex = potentialIndex;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\tif (addSizePin) {\r\n\t\t\t\t\t\t\t\t\t\t\t\taddPin = true;\r\n\t\t\t\t\t\t\t\t\t\t\t\taddPinAtIndex = Math.min(addPinAtIndex, addSizePinAtIndex);\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tif (addPin) {\r\n\t\t\t\t\t\t\t\t\t\t\tconst toBePinned: PotentialPin = potentialPins[addPinAtIndex];\r\n\t\t\t\t\t\t\t\t\t\t\tnote.pins.push(makeNotePin(toBePinned.pitch - initialBeepBoxPitch, toBePinned.part, toBePinned.size));\r\n\t\t\t\t\t\t\t\t\t\t\tprevPinIndex = addPinAtIndex;\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tpotentialPins.push(currentPin);\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// And always add a pin at the end of the note.\r\n\t\t\t\t\t\t\t\tconst lastToBePinned: PotentialPin = potentialPins[potentialPins.length - 1];\r\n\t\t\t\t\t\t\t\tnote.pins.push(makeNotePin(lastToBePinned.pitch - initialBeepBoxPitch, lastToBePinned.part, lastToBePinned.size));\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// Use interval range to constrain min/max pitches so no pin is out of bounds.\r\n\t\t\t\t\t\t\t\tlet maxPitch: number = channelMaxPitch;\r\n\t\t\t\t\t\t\t\tlet minPitch: number = 0;\r\n\t\t\t\t\t\t\t\tfor (const notePin of note.pins) {\r\n\t\t\t\t\t\t\t\t\tmaxPitch = Math.min(maxPitch, channelMaxPitch - notePin.interval);\r\n\t\t\t\t\t\t\t\t\tminPitch = Math.min(minPitch, -notePin.interval);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// Build the note chord out of the current pitches, shifted into BeepBox channelBasePitch relative values.\r\n\t\t\t\t\t\t\t\tnote.pitches.length = 0;\r\n\t\t\t\t\t\t\t\tfor (let pitchIndex: number = 0; pitchIndex < Math.min(Config.maxChordSize, heldPitches.length); pitchIndex++) {\r\n\t\t\t\t\t\t\t\t\tlet heldPitch: number = heldPitches[pitchIndex + Math.max(0, heldPitches.length - Config.maxChordSize)] * midiIntervalScale;\r\n\t\t\t\t\t\t\t\t\tif (preset != null && preset.midiSubharmonicOctaves != undefined) {\r\n\t\t\t\t\t\t\t\t\t\theldPitch -= 12 * preset.midiSubharmonicOctaves;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tconst shiftedPitch: number = Math.max(minPitch, Math.min(maxPitch, Math.round((heldPitch + heldPitchOffset) / intervalScale)));\r\n\t\t\t\t\t\t\t\t\tif (note.pitches.indexOf(shiftedPitch) == -1) {\r\n\t\t\t\t\t\t\t\t\t\tnote.pitches.push(shiftedPitch);\r\n\t\t\t\t\t\t\t\t\t\tconst weight: number = note.end - note.start;\r\n\t\t\t\t\t\t\t\t\t\tpitchSum += shiftedPitch * weight;\r\n\t\t\t\t\t\t\t\t\t\tpitchCount += weight;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tpattern.notes.push(note);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t// Process the next midi note event before continuing, updating the list of currently held pitches.\r\n\t\t\t\t\tif (heldPitches.indexOf(noteEvent.pitch) != -1) {\r\n\t\t\t\t\t\theldPitches.splice(heldPitches.indexOf(noteEvent.pitch), 1);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (noteEvent.on) {\r\n\t\t\t\t\t\theldPitches.push(noteEvent.pitch);\r\n\t\t\t\t\t\tcurrentVelocity = noteEvent.velocity;\r\n\t\t\t\t\t\tcurrentProgram = noteEvent.program;\r\n\t\t\t\t\t\tcurrentInstrumentVolume = noteEvent.instrumentVolume;\r\n\t\t\t\t\t\tcurrentInstrumentPan = noteEvent.instrumentPan;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tprevEventMidiTick = nextEventMidiTick;\r\n\t\t\t\t\tprevEventPart = nextEventPart;\r\n\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\tconst averagePitch: number = pitchSum / pitchCount;\r\n\t\t\t\t\tchannel.octave = (isNoiseChannel || isModChannel) ? 0 : Math.max(0, Math.min(Config.pitchOctaves - 1, Math.floor((averagePitch / 12))));\r\n\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\twhile (channel.bars.length < songTotalBars) {\r\n\t\t\t\tchannel.bars.push(0);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\t\r\n\t\t// For better or for worse, BeepBox has a more limited number of channels than Midi.\r\n\t\t// To compensate, try to merge non-overlapping channels.\r\n\t\tfunction compactChannels(channels: Channel[], maxLength: number): void {\r\n\t\t\twhile (channels.length > maxLength) {\r\n\t\t\t\tlet bestChannelIndexA: number = channels.length - 2;\r\n\t\t\t\tlet bestChannelIndexB: number = channels.length - 1;\r\n\t\t\t\tlet fewestConflicts: number = Number.MAX_VALUE;\r\n\t\t\t\tlet fewestGaps: number = Number.MAX_VALUE;\r\n\t\t\t\tfor (let channelIndexA: number = 0; channelIndexA < channels.length - 1; channelIndexA++) {\r\n\t\t\t\t\tfor (let channelIndexB: number = channelIndexA + 1; channelIndexB < channels.length; channelIndexB++) {\r\n\t\t\t\t\t\tconst channelA: Channel = channels[channelIndexA];\r\n\t\t\t\t\t\tconst channelB: Channel = channels[channelIndexB];\r\n\t\t\t\t\t\tlet conflicts: number = 0;\r\n\t\t\t\t\t\tlet gaps: number = 0;\r\n\t\t\t\t\t\tfor (let barIndex: number = 0; barIndex < channelA.bars.length && barIndex < channelB.bars.length; barIndex++) {\r\n\t\t\t\t\t\t\tif (channelA.bars[barIndex] != 0 && channelB.bars[barIndex] != 0) conflicts++;\r\n\t\t\t\t\t\t\tif (channelA.bars[barIndex] == 0 && channelB.bars[barIndex] == 0) gaps++;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (conflicts <= fewestConflicts) {\r\n\t\t\t\t\t\t\tif (conflicts < fewestConflicts || gaps < fewestGaps) {\r\n\t\t\t\t\t\t\t\tbestChannelIndexA = channelIndexA;\r\n\t\t\t\t\t\t\t\tbestChannelIndexB = channelIndexB;\r\n\t\t\t\t\t\t\t\tfewestConflicts = conflicts;\r\n\t\t\t\t\t\t\t\tfewestGaps = gaps;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t// Merge channelB's patterns, instruments, and bars into channelA.\r\n\t\t\t\tconst channelA: Channel = channels[bestChannelIndexA];\r\n\t\t\t\tconst channelB: Channel = channels[bestChannelIndexB];\r\n\t\t\t\tconst channelAInstrumentCount: number = channelA.instruments.length;\r\n\t\t\t\tconst channelAPatternCount: number = channelA.patterns.length;\r\n\t\t\t\tfor (const instrument of channelB.instruments) {\r\n\t\t\t\t\tchannelA.instruments.push(instrument);\r\n\t\t\t\t}\r\n\t\t\t\tfor (const pattern of channelB.patterns) {\r\n\t\t\t\t\tpattern.instruments[0] += channelAInstrumentCount;\r\n\t\t\t\t\tchannelA.patterns.push(pattern);\r\n\t\t\t\t}\r\n\t\t\t\tfor (let barIndex: number = 0; barIndex < channelA.bars.length && barIndex < channelB.bars.length; barIndex++) {\r\n\t\t\t\t\tif (channelA.bars[barIndex] == 0 && channelB.bars[barIndex] != 0) {\r\n\t\t\t\t\t\tchannelA.bars[barIndex] = channelB.bars[barIndex] + channelAPatternCount;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t// Remove channelB.\r\n\t\t\t\tchannels.splice(bestChannelIndexB, 1);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\t\r\n\t\tcompactChannels(pitchChannels, Config.pitchChannelCountMax);\r\n\t\tcompactChannels(noiseChannels, Config.noiseChannelCountMax);\r\n\t\tcompactChannels(modChannels, Config.modChannelCountMax);\r\n\t\t\t\r\n\t\tclass ChangeImportMidi extends ChangeGroup {\r\n\t\t\tconstructor(doc: SongDocument) {\r\n\t\t\t\tsuper();\r\n\t\t\t\tconst song: Song = doc.song;\r\n\t\t\t\tsong.tempo = beatsPerMinute;\r\n\t\t\t\tsong.beatsPerBar = beatsPerBar;\r\n\t\t\t\tsong.key = key;\r\n\t\t\t\tsong.scale = 11;\r\n\t\t\t\tsong.rhythm = 1;\r\n\t\t\t\tsong.layeredInstruments = false;\r\n\t\t\t\tsong.patternInstruments = pitchChannels.some(channel => channel.instruments.length > 1) || noiseChannels.some(channel => channel.instruments.length > 1);\r\n\t\t\t\t\t\r\n\t\t\t\tremoveDuplicatePatterns(pitchChannels);\r\n\t\t\t\tremoveDuplicatePatterns(noiseChannels);\r\n\t\t\t\tremoveDuplicatePatterns(modChannels);\r\n\t\t\t\t\t\r\n\t\t\t\tthis.append(new ChangeReplacePatterns(doc, pitchChannels, noiseChannels, modChannels));\r\n\t\t\t\tsong.loopStart = 0;\r\n\t\t\t\tsong.loopLength = song.barCount;\r\n\t\t\t\tthis._didSomething();\r\n\t\t\t\tdoc.notifier.changed();\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis._doc.goBackToStart();\r\n\t\tfor (const channel of this._doc.song.channels) channel.muted = false;\r\n\t\tthis._doc.prompt = null;\r\n\t\tthis._doc.record(new ChangeImportMidi(this._doc), true, true);\r\n\t}\r\n}\r\n\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {Layout} from \"./Layout\";\r\nimport {Prompt} from \"./Prompt\";\r\nimport {HTML, SVG} from \"imperative-html/dist/esm/elements-strict\";\r\n\r\nconst {button, label, div, form, h2, input} = HTML;\r\n\r\nexport class LayoutPrompt implements Prompt {\r\n\tprivate readonly _fileInput: HTMLInputElement = input({type: \"file\", accept: \".json,application/json,.mid,.midi,audio/midi,audio/x-midi\"});\r\n\tprivate readonly _okayButton: HTMLButtonElement = button({class: \"okayButton\", style: \"width:45%;\"}, \"Okay\");\r\n\tprivate readonly _cancelButton: HTMLButtonElement = button({class: \"cancelButton\"});\r\n\tprivate readonly _form: HTMLFormElement = form({style: \"display: flex; gap: 10px;\"},\r\n\t\t\tlabel({class: \"layout-option\"},\r\n\t\t\t\tinput({type: \"radio\", name: \"layout\", value: \"small\"}),\r\n\t\t\t\tSVG(`\\\r\n\t\t\t\t\t<svg viewBox=\"-4 -1 28 22\">\r\n\t\t\t\t\t\t<rect x=\"0\" y=\"0\" width=\"20\" height=\"20\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1\"/>\r\n\t\t\t\t\t\t<rect x=\"2\" y=\"2\" width=\"11\" height=\"10\" fill=\"currentColor\"/>\r\n\t\t\t\t\t\t<rect x=\"14\" y=\"2\" width=\"4\" height=\"16\" fill=\"currentColor\"/>\r\n\t\t\t\t\t\t<rect x=\"2\" y=\"13\" width=\"11\" height=\"5\" fill=\"currentColor\"/>\r\n\t\t\t\t\t</svg>\r\n\t\t\t\t`),\r\n\t\t\t\tdiv(\"Small\"),\r\n\t\t\t),\r\n\t\t\tlabel({class: \"layout-option\"},\r\n\t\t\t\tinput({type: \"radio\", name: \"layout\", value: \"long\"}),\r\n\t\t\t\tSVG(`\\\r\n\t\t\t\t\t<svg viewBox=\"-1 -1 28 22\">\r\n\t\t\t\t\t\t<rect x=\"0\" y=\"0\" width=\"26\" height=\"20\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1\"/>\r\n\t\t\t\t\t\t<rect x=\"2\" y=\"2\" width=\"12\" height=\"10\" fill=\"currentColor\"/>\r\n\t\t\t\t\t\t<rect x=\"15\" y=\"2\" width=\"4\" height=\"10\" fill=\"currentColor\"/>\r\n\t\t\t\t\t\t<rect x=\"20\" y=\"2\" width=\"4\" height=\"10\" fill=\"currentColor\"/>\r\n\t\t\t\t\t\t<rect x=\"2\" y=\"13\" width=\"22\" height=\"5\" fill=\"currentColor\"/>\r\n\t\t\t\t\t</svg>\r\n\t\t\t\t`),\r\n\t\t\t\tdiv(\"Long\"),\r\n\t\t\t),\r\n\t\t\tlabel({class: \"layout-option\"},\r\n\t\t\t\tinput({type: \"radio\", name: \"layout\", value: \"tall\"}),\r\n\t\t\t\tSVG(`\\\r\n\t\t\t\t\t<svg viewBox=\"-1 -1 28 22\">\r\n\t\t\t\t\t\t<rect x=\"0\" y=\"0\" width=\"26\" height=\"20\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1\"/>\r\n\t\t\t\t\t\t<rect x=\"11\" y=\"2\" width=\"8\" height=\"16\" fill=\"currentColor\"/>\r\n\t\t\t\t\t\t<rect x=\"20\" y=\"2\" width=\"4\" height=\"16\" fill=\"currentColor\"/>\r\n\t\t\t\t\t\t<rect x=\"2\" y=\"2\" width=\"8\" height=\"16\" fill=\"currentColor\"/>\r\n\t\t\t\t\t</svg>\r\n\t\t\t\t`),\r\n\t\t\t\tdiv(\"Tall\"),\r\n\t\t\t),\r\n\t\t\tlabel({class: \"layout-option\"},\r\n\t\t\t\tinput({type: \"radio\", name: \"layout\", value: \"wide\"}),\r\n\t\t\t\tSVG(`\\\r\n\t\t\t\t\t<svg viewBox=\"-1 -1 28 22\">\r\n\t\t\t\t\t\t<rect x=\"0\" y=\"0\" width=\"26\" height=\"20\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1\"/>\r\n\t\t\t\t\t\t<rect x=\"2\" y=\"2\" width=\"4\" height=\"16\" fill=\"currentColor\"/>\r\n\t\t\t\t\t\t<rect x=\"18\" y=\"2\" width=\"2.5\" height=\"16\" fill=\"currentColor\"/>\r\n\t\t\t\t\t\t<rect x=\"21.5\" y=\"2\" width=\"2.5\" height=\"16\" fill=\"currentColor\"/>\r\n\t\t\t\t\t\t<rect x=\"7\" y=\"2\" width=\"10\" height=\"16\" fill=\"currentColor\"/>\r\n\t\t\t\t\t</svg>\r\n\t\t\t\t`),\r\n\t\t\t\tdiv(\"Wide (JB)\"),\r\n\t\t\t),\r\n\t\t);\r\n\t\r\n\tpublic readonly container: HTMLDivElement = div({class: \"prompt noSelection\", style: \"width: 300px;\"},\r\n\t\th2(\"Layout\"),\r\n\t\tthis._form,\r\n\t\tdiv({style: \"display: flex; flex-direction: row-reverse; justify-content: space-between;\"},\r\n\t\t\tthis._okayButton,\r\n\t\t),\r\n\t\tthis._cancelButton,\r\n\t);\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis._fileInput.select();\r\n\t\tsetTimeout(()=>this._fileInput.focus());\r\n\t\t\r\n\t\tthis._okayButton.addEventListener(\"click\", this._confirm);\r\n\t\tthis._cancelButton.addEventListener(\"click\", this._close);\r\n\t\tthis.container.addEventListener(\"keydown\", this._whenKeyPressed);\r\n\t\t\r\n\t\t(<any> this._form.elements)[\"layout\"].value = this._doc.prefs.layout;\r\n\t}\r\n\t\r\n\tprivate _close = (): void => { \r\n\t\tthis._doc.undo();\r\n\t}\r\n\t\r\n\tpublic cleanUp = (): void => { \r\n\t\tthis._okayButton.removeEventListener(\"click\", this._confirm);\r\n\t\tthis._cancelButton.removeEventListener(\"click\", this._close);\r\n\t\tthis.container.removeEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\t\r\n\tprivate _whenKeyPressed = (event: KeyboardEvent): void => {\r\n\t\tif ((<Element> event.target).tagName != \"BUTTON\" && event.keyCode == 13) { // Enter key\r\n\t\t\tthis._confirm();\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _confirm = (): void => { \r\n\t\tthis._doc.prefs.layout = (<any> this._form.elements)[\"layout\"].value;\r\n\t\tthis._doc.prefs.save();\r\n\t\tLayout.setLayout(this._doc.prefs.layout);\r\n\t\tthis._close();\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {InstrumentType, Config} from \"../synth/SynthConfig\";\r\nimport {Instrument} from \"../synth/synth\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {ChangeSetEnvelopeTarget, ChangeSetEnvelopeType, ChangeRemoveEnvelope} from \"./changes\";\r\nimport {HTML} from \"imperative-html/dist/esm/elements-strict\";\r\n\r\nexport class EnvelopeEditor {\r\n\tpublic readonly container: HTMLElement = HTML.div({class: \"envelopeEditor\"});\r\n\t\r\n\tprivate readonly _rows: HTMLDivElement[] = [];\r\n\tprivate readonly _targetSelects: HTMLSelectElement[] = [];\r\n\tprivate readonly _envelopeSelects: HTMLSelectElement[] = [];\r\n\tprivate readonly _deleteButtons: HTMLButtonElement[] = [];\r\n\tprivate _renderedEnvelopeCount: number = 0;\r\n\tprivate _renderedEqFilterCount: number = -1;\r\n\tprivate _renderedNoteFilterCount: number = -1;\r\n\tprivate _renderedInstrumentType: InstrumentType;\r\n\tprivate _renderedEffects: number = 0;\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis.container.addEventListener(\"change\", this._onChange);\r\n\t\tthis.container.addEventListener(\"click\", this._onClick);\r\n\t}\r\n\t\r\n\tprivate _onChange = (event: Event): void => {\r\n\t\tconst targetSelectIndex: number = this._targetSelects.indexOf(<any> event.target);\r\n\t\tconst envelopeSelectIndex: number = this._envelopeSelects.indexOf(<any> event.target);\r\n\t\tif (targetSelectIndex != -1) {\r\n\t\t\tconst combinedValue: number = parseInt(this._targetSelects[targetSelectIndex].value);\r\n\t\t\tconst target: number = combinedValue % Config.instrumentAutomationTargets.length;\r\n\t\t\tconst index: number = (combinedValue / Config.instrumentAutomationTargets.length) >>> 0;\r\n\t\t\tthis._doc.record(new ChangeSetEnvelopeTarget(this._doc, targetSelectIndex, target, index));\r\n\t\t} else if (envelopeSelectIndex != -1) {\r\n\t\t\tthis._doc.record(new ChangeSetEnvelopeType(this._doc, envelopeSelectIndex, this._envelopeSelects[envelopeSelectIndex].selectedIndex));\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _onClick = (event: MouseEvent): void => {\r\n\t\tconst index: number = this._deleteButtons.indexOf(<any> event.target);\r\n\t\tif (index != -1) {\r\n\t\t\tthis._doc.record(new ChangeRemoveEnvelope(this._doc, index));\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _makeOption(target: number, index: number): HTMLOptionElement {\r\n\t\tlet displayName = Config.instrumentAutomationTargets[target].displayName;\r\n\t\tif (Config.instrumentAutomationTargets[target].maxCount > 1) {\r\n\t\t\tif (displayName.indexOf(\"#\") != -1) {\r\n\t\t\t\tdisplayName = displayName.replace(\"#\", String(index+1));\r\n\t\t\t} else {\r\n\t\t\t\tdisplayName += \" \" + (index+1);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn HTML.option({value: target + index * Config.instrumentAutomationTargets.length}, displayName);\r\n\t}\r\n\t\r\n\tprivate _updateTargetOptionVisibility(menu: HTMLSelectElement, instrument: Instrument): void {\r\n\t\tfor (let optionIndex: number = 0; optionIndex < menu.childElementCount; optionIndex++) {\r\n\t\t\tconst option: HTMLOptionElement = <HTMLOptionElement> menu.children[optionIndex];\r\n\t\t\tconst combinedValue: number = parseInt(option.value);\r\n\t\t\tconst target: number = combinedValue % Config.instrumentAutomationTargets.length;\r\n\t\t\tconst index: number = (combinedValue / Config.instrumentAutomationTargets.length) >>> 0;\r\n\t\t\toption.hidden = !instrument.supportsEnvelopeTarget(target, index);\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic render(): void {\r\n\t\tconst instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\t\r\n\t\tfor (let envelopeIndex: number = this._rows.length; envelopeIndex < instrument.envelopeCount; envelopeIndex++) {\r\n\t\t\tconst targetSelect: HTMLSelectElement = HTML.select();\r\n\t\t\tfor (let target: number = 0; target < Config.instrumentAutomationTargets.length; target++) {\r\n\t\t\t\tconst interleaved: boolean = (Config.instrumentAutomationTargets[target].interleave);\r\n\t\t\t\tfor (let index: number = 0; index < Config.instrumentAutomationTargets[target].maxCount; index++) {\r\n\t\t\t\t\ttargetSelect.appendChild(this._makeOption(target, index));\r\n\t\t\t\t\tif (interleaved) {\r\n\t\t\t\t\t\ttargetSelect.appendChild(this._makeOption(target + 1, index));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (interleaved) target++;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst envelopeSelect: HTMLSelectElement = HTML.select();\r\n\t\t\tfor (let envelope: number = 0; envelope < Config.envelopes.length; envelope++) {\r\n\t\t\t\tenvelopeSelect.appendChild(HTML.option({value: envelope}, Config.envelopes[envelope].name));\r\n\t\t\t} \r\n\t\t\t\r\n\t\t\tconst deleteButton: HTMLButtonElement = HTML.button({type: \"button\", class: \"delete-envelope\"});\r\n\t\t\t\r\n\t\t\tconst row: HTMLDivElement = HTML.div({class: \"envelope-row\"},\r\n\t\t\t\tHTML.div({class: \"selectContainer\", style: \"width: 0; flex: 1;\"}, targetSelect),\r\n\t\t\t\tHTML.div({class: \"selectContainer\", style: \"width: 0; flex: 0.7;\"}, envelopeSelect),\r\n\t\t\t\tdeleteButton,\r\n\t\t\t);\r\n\t\t\t\r\n\t\t\tthis.container.appendChild(row);\r\n\t\t\tthis._rows[envelopeIndex] = row;\r\n\t\t\tthis._targetSelects[envelopeIndex] = targetSelect;\r\n\t\t\tthis._envelopeSelects[envelopeIndex] = envelopeSelect;\r\n\t\t\tthis._deleteButtons[envelopeIndex] = deleteButton;\r\n\t\t}\r\n\t\t\r\n\t\tfor (let envelopeIndex: number = this._renderedEnvelopeCount; envelopeIndex < instrument.envelopeCount; envelopeIndex++) {\r\n\t\t\tthis._rows[envelopeIndex].style.display = \"\";\r\n\t\t\t// For newly visible rows, update target option visibiliy.\r\n\t\t\tthis._updateTargetOptionVisibility(this._targetSelects[envelopeIndex], instrument);\r\n\t\t}\r\n\t\t\r\n\t\tfor (let envelopeIndex: number = instrument.envelopeCount; envelopeIndex < this._renderedEnvelopeCount; envelopeIndex++) {\r\n\t\t\tthis._rows[envelopeIndex].style.display = \"none\";\r\n\t\t}\r\n\r\n\t\tlet useControlPointCount: number = instrument.noteFilter.controlPointCount;\r\n\t\tif (instrument.noteFilterType)\r\n\t\t\tuseControlPointCount = 1;\r\n\t\t\r\n\t\tif (this._renderedEqFilterCount != instrument.eqFilter.controlPointCount ||\r\n\t\t\tthis._renderedNoteFilterCount != useControlPointCount ||\r\n\t\t\tthis._renderedInstrumentType != instrument.type ||\r\n\t\t\tthis._renderedEffects != instrument.effects)\r\n\t\t{\r\n\t\t\t// Update target option visibility for previously visible rows.\r\n\t\t\tfor (let envelopeIndex: number = 0; envelopeIndex < this._renderedEnvelopeCount; envelopeIndex++) {\r\n\t\t\t\tthis._updateTargetOptionVisibility(this._targetSelects[envelopeIndex], instrument);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tfor (let envelopeIndex: number = 0; envelopeIndex < instrument.envelopeCount; envelopeIndex++) {\r\n\t\t\tthis._targetSelects[envelopeIndex].value = String(instrument.envelopes[envelopeIndex].target + instrument.envelopes[envelopeIndex].index * Config.instrumentAutomationTargets.length);\r\n\t\t\tthis._envelopeSelects[envelopeIndex].selectedIndex = instrument.envelopes[envelopeIndex].envelope;\r\n\t\t}\r\n\t\t\r\n\t\tthis._renderedEnvelopeCount = instrument.envelopeCount;\r\n\t\tthis._renderedEqFilterCount = instrument.eqFilter.controlPointCount;\r\n\t\tthis._renderedNoteFilterCount = useControlPointCount;\r\n\t\tthis._renderedInstrumentType = instrument.type;\r\n\t\tthis._renderedEffects = instrument.effects;\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Config} from \"../synth/SynthConfig\";\r\nimport {clamp, Instrument, Synth} from \"../synth/synth\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {HTML, SVG} from \"imperative-html/dist/esm/elements-strict\";\r\nimport {ColorConfig} from \"./ColorConfig\";\r\nimport {ChangeSequence, UndoableChange} from \"./Change\";\r\nimport {ChangeFadeInOut} from \"./changes\";\r\n\r\nexport class FadeInOutEditor {\r\n\tprivate readonly _editorWidth: number = 120;\r\n\tprivate readonly _editorHeight: number = 26;\r\n\tprivate readonly _fadeCurve: SVGPathElement = SVG.path({fill: ColorConfig.uiWidgetBackground, \"pointer-events\": \"none\"});\r\n\tprivate readonly _dottedLinePath: SVGPathElement = SVG.path({fill: \"none\", stroke: \"currentColor\", \"stroke-width\": 1, \"stroke-dasharray\": \"3, 2\", \"pointer-events\": \"none\"});\r\n\tprivate readonly _controlCurve: SVGPathElement = SVG.path({fill: \"none\", stroke: \"currentColor\", \"stroke-width\": 2, \"pointer-events\": \"none\"});\r\n\tprivate readonly _svg: SVGSVGElement = SVG.svg({style: `background-color: ${ColorConfig.editorBackground}; touch-action: none; cursor: crosshair;`, width: \"100%\", height: \"100%\", viewBox: \"0 0 \"+this._editorWidth+\" \"+this._editorHeight, preserveAspectRatio: \"none\"},\r\n\t\tthis._fadeCurve,\r\n\t\tthis._dottedLinePath,\r\n\t\tthis._controlCurve,\r\n\t);\r\n\tpublic readonly container: HTMLElement = HTML.div({class: \"fadeInOut\", style: \"height: 100%;\"}, this._svg);\r\n\t\r\n\tprivate _mouseX: number = 0;\r\n\tprivate _mouseXStart: number = 0;\r\n\tprivate _mouseDown: boolean = false;\r\n\tprivate _mouseDragging: boolean = false;\r\n\tprivate _draggingFadeIn: boolean = false;\r\n\tprivate _dragChange: UndoableChange | null = null;\r\n\tprivate _renderedFadeIn: number = -1;\r\n\tprivate _renderedFadeOut: number = -1;\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tconst dottedLineX: number = this._fadeOutToX(Config.fadeOutNeutral);\r\n\t\tthis._dottedLinePath.setAttribute(\"d\", `M ${dottedLineX} 0 L ${dottedLineX} ${this._editorHeight}`);\r\n\t\t\r\n\t\tthis.container.addEventListener(\"mousedown\", this._whenMousePressed);\r\n\t\tdocument.addEventListener(\"mousemove\", this._whenMouseMoved);\r\n\t\tdocument.addEventListener(\"mouseup\", this._whenCursorReleased);\r\n\t\tthis.container.addEventListener(\"touchstart\", this._whenTouchPressed);\r\n\t\tthis.container.addEventListener(\"touchmove\", this._whenTouchMoved);\r\n\t\tthis.container.addEventListener(\"touchend\", this._whenCursorReleased);\r\n\t\tthis.container.addEventListener(\"touchcancel\", this._whenCursorReleased);\r\n\t}\r\n\t\r\n\tprivate _fadeInToX(fadeIn: number) {\r\n\t\treturn 1.0 + (this._editorWidth - 2.0) * 0.4 * fadeIn / (Config.fadeInRange - 1);\r\n\t}\r\n\tprivate _xToFadeIn(x: number) {\r\n\t\treturn clamp(0, Config.fadeInRange, Math.round((x - 1.0) * (Config.fadeInRange - 1) / (0.4 * this._editorWidth - 2.0)));\r\n\t}\r\n\tprivate _fadeOutToX(fadeOut: number) {\r\n\t\treturn 1.0 + (this._editorWidth - 2.0) * (0.5 + 0.5 * fadeOut / (Config.fadeOutTicks.length - 1));\r\n\t}\r\n\tprivate _xToFadeOut(x: number) {\r\n\t\treturn clamp(0, Config.fadeOutTicks.length, Math.round((Config.fadeOutTicks.length - 1) * ((x - 1.0) / (this._editorWidth - 2.0) - 0.5) / 0.5));\r\n\t}\r\n\t\r\n\tprivate _whenMousePressed = (event: MouseEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = ((event.clientX || event.pageX) - boundingRect.left);\r\n\t\tthis._whenCursorPressed();\r\n\t}\r\n\t\r\n\tprivate _whenTouchPressed = (event: TouchEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.touches[0].clientX - boundingRect.left);\r\n\t\tthis._whenCursorPressed();\r\n\t}\r\n\t\r\n\tprivate _whenCursorPressed(): void {\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tthis._mouseXStart = this._mouseX;\r\n\t\tthis._mouseDown = true;\r\n\t\tthis._mouseDragging = false;\r\n\t\tconst instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\tconst fadeInX: number = this._fadeInToX(instrument.fadeIn);\r\n\t\tconst fadeOutX: number = this._fadeOutToX(instrument.fadeOut);\r\n\t\tthis._draggingFadeIn = this._mouseXStart < (fadeInX + fadeOutX) / 2.0;\r\n\t\tthis._dragChange = new ChangeSequence();\r\n\t\tthis._doc.setProspectiveChange(this._dragChange);\r\n\t}\r\n\t\r\n\tprivate _whenMouseMoved = (event: MouseEvent): void => {\r\n\t\tif (this.container.offsetParent == null) return;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = ((event.clientX || event.pageX) - boundingRect.left);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\r\n\tprivate _whenTouchMoved = (event: TouchEvent): void => {\r\n\t\tif (this.container.offsetParent == null) return;\r\n\t\tif (!this._mouseDown) return;\r\n\t\tevent.preventDefault();\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.touches[0].clientX - boundingRect.left);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\r\n\tprivate _whenCursorMoved(): void {\r\n\t\tif (this._dragChange != null && this._doc.lastChangeWas(this._dragChange)) {\r\n\t\t\tthis._dragChange.undo();\r\n\t\t} else {\r\n\t\t\tthis._mouseDown = false;\r\n\t\t}\r\n\t\tthis._dragChange = null;\r\n\t\t\r\n\t\tif (this._mouseDown) {\r\n\t\t\tconst sequence: ChangeSequence = new ChangeSequence();\r\n\t\t\tthis._dragChange = sequence;\r\n\t\t\tthis._doc.setProspectiveChange(this._dragChange);\r\n\t\t\t\r\n\t\t\tif (Math.abs(this._mouseX - this._mouseXStart) > 4.0) {\r\n\t\t\t\tthis._mouseDragging = true;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (this._mouseDragging) {\r\n\t\t\t\tconst instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\t\t\tif (this._draggingFadeIn) {\r\n\t\t\t\t\tsequence.append(new ChangeFadeInOut(this._doc, this._xToFadeIn(this._fadeInToX(instrument.fadeIn) + this._mouseX - this._mouseXStart), instrument.fadeOut));\r\n\t\t\t\t} else {\r\n\t\t\t\t\tsequence.append(new ChangeFadeInOut(this._doc, instrument.fadeIn, this._xToFadeOut(this._fadeOutToX(instrument.fadeOut) + this._mouseX - this._mouseXStart)));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _whenCursorReleased = (event: Event): void => {\r\n\t\tif (this.container.offsetParent == null) return;\r\n\t\tif (this._mouseDown && this._doc.lastChangeWas(this._dragChange) && this._dragChange != null) {\r\n\t\t\tif (!this._mouseDragging) {\r\n\t\t\t\tconst instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\t\t\tif (this._draggingFadeIn) {\r\n\t\t\t\t\tthis._doc.record(new ChangeFadeInOut(this._doc, this._xToFadeIn(this._mouseX), instrument.fadeOut));\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis._doc.record(new ChangeFadeInOut(this._doc, instrument.fadeIn, this._xToFadeOut(this._mouseX)));\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tthis._doc.record(this._dragChange);\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis._dragChange = null;\r\n\t\tthis._mouseDragging = false;\r\n\t\tthis._mouseDown = false;\r\n\t}\r\n\t\r\n\tpublic render(): void {\r\n\t\tconst instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\t\r\n\t\tif (this._renderedFadeIn == instrument.fadeIn && this._renderedFadeOut == instrument.fadeOut) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\tconst fadeInX: number = this._fadeInToX(instrument.fadeIn);\r\n\t\tconst fadeOutX: number = this._fadeOutToX(instrument.fadeOut);\r\n\t\tthis._controlCurve.setAttribute(\"d\", `M ${fadeInX} 0 L ${fadeInX} ${this._editorHeight} M ${fadeOutX} 0 L ${fadeOutX} ${this._editorHeight}`);\r\n\t\t\r\n\t\tconst dottedLineX: number = this._fadeOutToX(Config.fadeOutNeutral);\r\n\t\tlet fadePath: string = \"\";\r\n\t\tfadePath += `M 0 ${this._editorHeight} `;\r\n\t\tfadePath += `L ${fadeInX} 0 `;\r\n\t\tif (Synth.fadeOutSettingToTicks(instrument.fadeOut) > 0) {\r\n\t\t\tfadePath += `L ${dottedLineX} 0 `;\r\n\t\t\tfadePath += `L ${fadeOutX} ${this._editorHeight} `;\r\n\t\t} else {\r\n\t\t\tfadePath += `L ${fadeOutX} 0 `;\r\n\t\t\tfadePath += `L ${dottedLineX} ${this._editorHeight} `;\r\n\t\t}\r\n\t\tfadePath += \"z\";\r\n\t\tthis._fadeCurve.setAttribute(\"d\", fadePath);\r\n\t}\r\n}\r\n","// Copyright (C) 2020 John Nesky, distributed under the MIT license.\r\n\r\nimport { HTML, SVG } from \"imperative-html/dist/esm/elements-strict\";\r\nimport { Prompt } from \"./Prompt\";\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { ColorConfig } from \"./ColorConfig\";\r\nimport { ChangeLimiterSettings } from \"./changes\";\r\nimport { SongEditor } from \"./SongEditor\";\r\nimport { prettyNumber } from \"./EditorConfig\";\r\n\r\n//namespace beepbox {\r\nconst { button, div, h2, input } = HTML;\r\n\r\nexport class LimiterCanvas {\r\n\tprivate readonly _editorWidth: number = 200; // 112\r\n\tprivate readonly _editorHeight: number = 52; // 26\r\n\tprivate readonly _fill: SVGPathElement = SVG.path({ fill: ColorConfig.uiWidgetBackground, \"pointer-events\": \"none\" });\r\n\tprivate readonly _ticks: SVGSVGElement = SVG.svg({ \"pointer-events\": \"none\" });\r\n\tprivate readonly _subticks: SVGSVGElement = SVG.svg({ \"pointer-events\": \"none\" });\r\n\tprivate readonly _boostCurve: SVGPathElement = SVG.path({ fill: \"none\", stroke: ColorConfig.textSelection, \"stroke-width\": 2, \"pointer-events\": \"none\" });\r\n\tprivate readonly _boostDot: SVGCircleElement = SVG.circle({ fill: ColorConfig.textSelection, stroke: \"none\", r: \"3\" });\r\n\tprivate readonly _midCurve: SVGPathElement = SVG.path({ fill: \"none\", stroke: ColorConfig.primaryText, \"stroke-width\": 2, \"pointer-events\": \"none\" });\r\n\tprivate readonly _limitCurve: SVGPathElement = SVG.path({ fill: \"none\", stroke: ColorConfig.linkAccent, \"stroke-width\": 2, \"pointer-events\": \"none\" });\r\n\tprivate readonly _limitDot: SVGCircleElement = SVG.circle({ fill: ColorConfig.linkAccent, stroke: \"none\", r: \"3\" });\r\n\tprivate readonly _label0: SVGTextElement = SVG.text({ x: \"-1.5%\", y: \"148.5%\", \"pointer-events\": \"none\", \"font-size\": \"7pt\", fill: \"var(--secondary-text)\" }, \"0\");\r\n\tprivate readonly _label1: SVGTextElement = SVG.text({ x: \"48.2%\", y: \"148.5%\", \"pointer-events\": \"none\", \"font-size\": \"7pt\", fill: \"var(--secondary-text)\" }, \"1\");\r\n\tprivate readonly _label2: SVGTextElement = SVG.text({ x: \"98.2%\", y: \"148.5%\", \"pointer-events\": \"none\", \"font-size\": \"7pt\", fill: \"var(--secondary-text)\" }, \"2\");\r\n\tprivate readonly _inLabel: SVGTextElement = SVG.text({ x: \"-5%\", y: \"113.5%\", \"pointer-events\": \"none\", \"font-size\": \"6pt\", fill: \"var(--secondary-text)\" }, \"In\");\r\n\tprivate readonly _outLabel: SVGTextElement = SVG.text({ x: \"-9%\", y: \"131%\", \"pointer-events\": \"none\", \"font-size\": \"6pt\", fill: \"var(--secondary-text)\" }, \"Out\");\r\n\tprivate readonly _xAxisLabel: SVGTextElement = SVG.text({ x: \"42%\", y: \"172%\", \"pointer-events\": \"none\", \"font-size\": \"7pt\", fill: \"var(--primary-text)\" }, \"Volume\");\r\n\tprivate readonly _yAxisLabel: SVGTextElement = SVG.text({ x: \"55.2%\", y: \"160%\", \"pointer-events\": \"none\", \"font-size\": \"7pt\", transform: \"rotate(-90 30,120)\", fill: \"var(--primary-text)\" }, \"Gain\");\r\n\tprivate readonly _inVolumeBg: SVGRectElement = SVG.rect({ \"pointer-events\": \"none\", width: \"100%\", height: \"6px\", x: \"0%\", y: \"105%\", fill: ColorConfig.uiWidgetBackground });\r\n\tprivate readonly _outVolumeBg: SVGRectElement = SVG.rect({ \"pointer-events\": \"none\", width: \"100%\", height: \"6px\", x: \"0%\", y: \"120%\", fill: ColorConfig.uiWidgetBackground });\r\n\tprivate readonly _inVolumeBar: SVGRectElement = SVG.rect({ \"pointer-events\": \"none\", height: \"6px\", x: \"0%\", y: \"105%\", fill: \"url('#volumeGrad')\" });\r\n\tprivate readonly _inVolumeCap: SVGRectElement = SVG.rect({ \"pointer-events\": \"none\", width: \"2px\", height: \"6px\", y: \"105%\", fill: ColorConfig.uiWidgetFocus });\r\n\tprivate readonly _outVolumeBar: SVGRectElement = SVG.rect({ \"pointer-events\": \"none\", height: \"6px\", x: \"0%\", y: \"120%\", fill: \"url('#volumeGrad')\" });\r\n\tprivate readonly _outVolumeCap: SVGRectElement = SVG.rect({ \"pointer-events\": \"none\", width: \"2px\", height: \"6px\", y: \"120%\", fill: ColorConfig.uiWidgetFocus });\r\n\tprivate readonly _stop1: SVGStopElement = SVG.stop({ \"stop-color\": \"lime\", offset: \"30%\" });\r\n\tprivate readonly _stop2: SVGStopElement = SVG.stop({ \"stop-color\": \"orange\", offset: \"45%\" });\r\n\tprivate readonly _stop3: SVGStopElement = SVG.stop({ \"stop-color\": \"red\", offset: \"50%\" });\r\n\tprivate readonly _gradient: SVGGradientElement = SVG.linearGradient({ id: \"volumeGrad\", gradientUnits: \"userSpaceOnUse\" }, this._stop1, this._stop2, this._stop3);\r\n\tprivate readonly _defs: SVGDefsElement = SVG.defs({}, this._gradient);\r\n\tprivate readonly _svg: SVGSVGElement = SVG.svg({ style: `background-color: ${ColorConfig.editorBackground}; touch-action: none; overflow: visible;`, width: \"100%\", height: \"100%\", viewBox: \"0 0 \" + this._editorWidth + \" \" + this._editorHeight, preserveAspectRatio: \"none\" },\r\n\t\tthis._defs,\r\n\t\tthis._fill,\r\n\t\tthis._ticks,\r\n\t\tthis._subticks,\r\n\t\tthis._boostCurve,\r\n\t\tthis._midCurve,\r\n\t\tthis._limitCurve,\r\n\t\tthis._boostDot,\r\n\t\tthis._limitDot,\r\n\t\tthis._label0,\r\n\t\tthis._label1,\r\n\t\tthis._label2,\r\n\t\tthis._inLabel,\r\n\t\tthis._outLabel,\r\n\t\tthis._xAxisLabel,\r\n\t\tthis._yAxisLabel,\r\n\t\tthis._inVolumeBg,\r\n\t\tthis._outVolumeBg,\r\n\t\tthis._inVolumeBar,\r\n\t\tthis._outVolumeBar,\r\n\t\tthis._inVolumeCap,\r\n\t\tthis._outVolumeCap,\r\n\t);\r\n\r\n\tpublic readonly container: HTMLElement = HTML.div({ class: \"\", style: \"height: 4em; width: 80%; padding-bottom: 1.5em;\" }, this._svg);\r\n\r\n\tprivate _limiterPrompt: LimiterPrompt;\r\n\r\n\tconstructor(lim: LimiterPrompt) {\r\n\t\tfor (let i: number = 0; i <= 2; i++) {\r\n\t\t\tthis._ticks.appendChild(SVG.rect({ fill: ColorConfig.tonic, x: (i * this._editorWidth / 2) - 1, y: 0, width: 2, height: this._editorHeight }));\r\n\t\t}\r\n\t\tfor (let i: number = 1; i <= 3; i += 2) {\r\n\t\t\tthis._subticks.appendChild(SVG.rect({ fill: ColorConfig.fifthNote, x: (i * this._editorWidth / 4) - 1, y: 0, width: 1, height: this._editorHeight }));\r\n\t\t}\r\n\r\n\t\tthis._limiterPrompt = lim;\r\n\r\n\t}\r\n\r\n\tpublic animateVolume(inVolumeCap: number, historicInCap: number, outVolumeCap: number, historicOutCap: number): void {\r\n\t\tthis._inVolumeBar.setAttribute(\"width\", \"\" + Math.min(this._editorWidth, inVolumeCap * (this._editorWidth / 2.0)));\r\n\t\tthis._inVolumeCap.setAttribute(\"x\", \"\" + Math.min(this._editorWidth, historicInCap * (this._editorWidth / 2.0)));\r\n\t\tthis._outVolumeBar.setAttribute(\"width\", \"\" + Math.min(this._editorWidth, outVolumeCap * (this._editorWidth / 2.0)));\r\n\t\tthis._outVolumeCap.setAttribute(\"x\", \"\" + Math.min(this._editorWidth, historicOutCap * (this._editorWidth / 2.0)));\r\n\t}\r\n\r\n\tpublic render(): void {\r\n\t\tconst controlPointToHeight = (point: number): number => {\r\n\t\t\treturn Math.max(0, (1 - (point / 5)) * (this._editorHeight - 1) + 1);\r\n\t\t}\r\n\r\n\t\tlet lastValue: number = 0;\r\n\t\tlet currentSubpathIdx: number = 0;\r\n\t\tlet lastSubpathIdx: number = -1;\r\n\t\tlet path: string = \"\";\r\n\t\tlet subPaths: string[] = [\"\", \"\", \"\"];\r\n\t\tfor (let i: number = 0; i < 64; i++) {\r\n\t\t\t// Calculate next value based on limiter settings\r\n\t\t\tlet limiterRatio: number = +this._limiterPrompt.limitRatioSlider.value;\r\n\t\t\tlimiterRatio = (limiterRatio < 10 ? limiterRatio / 10 : (limiterRatio - 9));\r\n\t\t\tlet compressorRatio: number = +this._limiterPrompt.compressionRatioSlider.value;\r\n\t\t\tcompressorRatio = (compressorRatio < 10 ? compressorRatio / 10 : (1 + (compressorRatio - 10) / 60));\r\n\t\t\tlet limiterThreshold: number = +this._limiterPrompt.limitThresholdSlider.value;\r\n\t\t\tlet compressorThreshold: number = +this._limiterPrompt.compressionThresholdSlider.value;\r\n\t\t\tlet useVol: number = i * 2.0 / 64.0; // Scale from 0~2\r\n\t\t\tlet nextValue: number = 1 / 1.05;\r\n\t\t\tif (useVol >= limiterThreshold) {\r\n\t\t\t\t// Limiter falloff\r\n\t\t\t\tnextValue = 1 / (1.05 * (useVol + 1 - limiterThreshold) * limiterRatio + (1 - limiterRatio));\r\n\t\t\t}\r\n\t\t\telse if (useVol < compressorThreshold) {\r\n\t\t\t\t// Compressor boost\r\n\t\t\t\tnextValue = 1 / (((useVol + 1 - compressorThreshold) * 0.8 + 0.25) * compressorRatio + 1.05 * (1 - compressorRatio));\r\n\t\t\t}\r\n\r\n\t\t\t// first point in entire path\r\n\t\t\tif (i == 0) {\r\n\t\t\t\tpath += \"M 0 \" + prettyNumber(controlPointToHeight(nextValue)) + \" \";\r\n\t\t\t}\r\n\r\n\t\t\t// first point in a specific subpath\r\n\t\t\tif (currentSubpathIdx > lastSubpathIdx) {\r\n\t\t\t\tif (lastSubpathIdx >= 0) {\r\n\t\t\t\t\tsubPaths[lastSubpathIdx] += \"L \" + prettyNumber(i * this._editorWidth / 64) + \" \" + prettyNumber(controlPointToHeight(nextValue)) + \" \";\r\n\t\t\t\t}\r\n\t\t\t\tsubPaths[currentSubpathIdx] += \"M \" + prettyNumber(i * this._editorWidth / 64) + \" \" + prettyNumber(controlPointToHeight(nextValue)) + \" \";\r\n\r\n\t\t\t\tif (currentSubpathIdx == 1 || (lastSubpathIdx == 0 && currentSubpathIdx == 2)) {\r\n\t\t\t\t\tthis._boostDot.setAttribute(\"cx\", prettyNumber(i * this._editorWidth / 64));\r\n\t\t\t\t\tthis._boostDot.setAttribute(\"cy\", prettyNumber(controlPointToHeight(nextValue)));\r\n\t\t\t\t}\r\n\t\t\t\tif (currentSubpathIdx == 2) {\r\n\t\t\t\t\tthis._limitDot.setAttribute(\"cx\", prettyNumber(i * this._editorWidth / 64));\r\n\t\t\t\t\tthis._limitDot.setAttribute(\"cy\", prettyNumber(controlPointToHeight(nextValue)));\r\n\t\t\t\t}\r\n\r\n\t\t\t\tlastSubpathIdx = currentSubpathIdx;\r\n\t\t\t}\r\n\r\n\t\t\tif (lastValue != 0 || nextValue != 0) {\r\n\t\t\t\tpath += \"L \";\r\n\t\t\t\tsubPaths[currentSubpathIdx] += \"L \";\r\n\t\t\t} else {\r\n\t\t\t\tpath += \"M \";\r\n\t\t\t\tsubPaths[currentSubpathIdx] += \"M \";\r\n\t\t\t}\r\n\t\t\tpath += prettyNumber(i * this._editorWidth / 64) + \" \" + prettyNumber(controlPointToHeight(nextValue)) + \" \";\r\n\t\t\tsubPaths[currentSubpathIdx] += prettyNumber(i * this._editorWidth / 64) + \" \" + prettyNumber(controlPointToHeight(nextValue)) + \" \";\r\n\t\t\tlastValue = nextValue;\r\n\r\n\t\t\t// Move to next subpath\r\n\t\t\tif (currentSubpathIdx == 0 && (i >= compressorThreshold * 32 - 2)) {\r\n\t\t\t\tcurrentSubpathIdx++;\r\n\t\t\t}\r\n\t\t\tif (currentSubpathIdx == 1 && (i >= limiterThreshold * 32 - 2)) {\r\n\t\t\t\tcurrentSubpathIdx++;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconst lastHeight: number = controlPointToHeight(lastValue);\r\n\t\tif (lastValue > 0) {\r\n\t\t\tpath += \"L \" + (this._editorWidth - 1) + \" \" + prettyNumber(lastHeight) + \" \";\r\n\t\t\tsubPaths[currentSubpathIdx] += \"L \" + (this._editorWidth - 1) + \" \" + prettyNumber(lastHeight) + \" \";\r\n\t\t}\r\n\r\n\t\tthis._boostCurve.setAttribute(\"d\", subPaths[0]);\r\n\t\tthis._midCurve.setAttribute(\"d\", subPaths[1]);\r\n\t\tthis._limitCurve.setAttribute(\"d\", subPaths[2]);\r\n\t\tthis._fill.setAttribute(\"d\", path + \"L \" + this._editorWidth + \" \" + prettyNumber(lastHeight) + \" L \" + this._editorWidth + \" \" + prettyNumber(this._editorHeight) + \" L 0 \" + prettyNumber(this._editorHeight) + \" z \");\r\n\t}\r\n}\r\n\r\nexport class LimiterPrompt implements Prompt {\r\n\r\n\tprivate limiterCanvas: LimiterCanvas = new LimiterCanvas(this);\r\n\r\n\tpublic readonly _playButton: HTMLButtonElement = button({ style: \"width: 55%;\", type: \"button\" });\r\n\r\n\tpublic readonly limitDecaySlider: HTMLInputElement = input({ title: \"limit decay\", style: `width: 5em; flex-grow: 1; margin: 0;`, type: \"range\", min: \"1\", max: \"30\", value: \"4\", step: \"1\" });\r\n\tpublic readonly limitRiseSlider: HTMLInputElement = input({ title: \"limit rise\", style: `width: 5em; flex-grow: 1; margin: 0;`, type: \"range\", min: \"2000\", max: \"10000\", value: \"4000\", step: \"250\" });\r\n\tpublic readonly compressionThresholdSlider: HTMLInputElement = input({ title: \"compressor threshold\", style: `width: 100%; flex-grow: 1; margin: 0;`, type: \"range\", min: \"0\", max: \"1.1\", value: \"1\", step: \"0.05\" });\r\n\tpublic readonly limitThresholdSlider: HTMLInputElement = input({ title: \"limiter threshold\", style: `width: 100%; flex-grow: 1; margin: 0;`, type: \"range\", min: \"0\", max: \"2\", value: \"1\", step: \"0.05\" });\r\n\tpublic readonly compressionRatioSlider: HTMLInputElement = input({ title: \"compressor ratio\", style: `width: 100%; flex-grow: 1; margin: 0;`, type: \"range\", min: \"0\", max: \"20\", value: \"10\", step: \"1\" });\r\n\tpublic readonly limitRatioSlider: HTMLInputElement = input({ title: \"limiter ratio\", style: `width: 100%; flex-grow: 1; margin: 0;`, type: \"range\", min: \"0\", max: \"20\", value: \"10\", step: \"1\" });\r\n\tpublic readonly masterGainSlider: HTMLInputElement = input({ title: \"master gain\", style: `width: 5em; flex-grow: 1; margin: 0;`, type: \"range\", min: \"0\", max: \"5\", value: \"1\", step: \"0.02\" });\r\n\r\n\tprivate startingLimitDecay: number;\r\n\tprivate startingLimitRise: number;\r\n\tprivate startingCompressionThreshold: number;\r\n\tprivate startingLimitThreshold: number;\r\n\tprivate startingCompressionRatio: number;\r\n\tprivate startingLimitRatio: number;\r\n\tprivate startingMasterGain: number;\r\n\r\n\tprivate inVolumeHistoricTimer: number = 0.0;\r\n\tprivate inVolumeHistoricCap: number = 0.0;\r\n\tprivate outVolumeHistoricTimer: number = 0.0;\r\n\tprivate outVolumeHistoricCap: number = 0.0;\r\n\r\n\tprivate readonly _cancelButton: HTMLButtonElement = button({ class: \"cancelButton\" });\r\n\tprivate readonly _okayButton: HTMLButtonElement = button({ class: \"okayButton\", style: \"width:45%;\" }, \"Okay\");\r\n\tprivate readonly _resetButton: HTMLButtonElement = button({ style: \"width:45%;\" }, \"Reset\");\r\n\r\n\tpublic readonly container: HTMLDivElement = div({ class: \"prompt noSelection\", style: \"width: 250px;\" },\r\n\t\th2(\"Limiter Options\"),\r\n\t\tdiv({ style: \"display: flex; width: 55%; align-self: center; flex-direction: row; align-items: center; justify-content: center;\" },\r\n\t\t\tthis._playButton,\r\n\t\t),\r\n\t\tdiv({ style: \"display: flex; flex-direction: row; align-items: center; justify-content: center;\" },\r\n\t\t\tthis.limiterCanvas.container,\r\n\t\t),\r\n\t\tdiv({ style: \"display: flex; flex-direction: row; align-items: center; height: 2em; margin-top: 1.5em; justify-content: flex-end;\" },\r\n\t\t\tdiv({ style: `text-align: right; width: 25%; margin-right: 4.5%; color: ${ColorConfig.primaryText};` },\r\n\t\t\t\t\"\"\r\n\t\t\t),\r\n\t\t\tdiv({ style: `text-align: center; width: 33%; margin-right: 4.5%; color: ${ColorConfig.textSelection};` },\r\n\t\t\t\t\"Boost\"\r\n\t\t\t),\r\n\t\t\tdiv({ style: `text-align: center; width: 33%; margin-right: 0%; color: ${ColorConfig.linkAccent};` },\r\n\t\t\t\t\"Cutoff\"\r\n\t\t\t),\r\n\t\t),\r\n\t\tdiv({ style: \"display: flex; flex-direction: row; align-items: center; height: 2em; margin-top: 0.5em; justify-content: flex-end;\" },\r\n\t\t\tdiv({ style: `text-align: right; width: 25%; margin-right: 4.5%; color: ${ColorConfig.primaryText};` },\r\n\t\t\t\t\"Threshold:\"\r\n\t\t\t),\r\n\t\t\tdiv({ style: `width: 33%; margin-right: 4.5%;` },\r\n\t\t\t\tthis.compressionThresholdSlider,\r\n\t\t\t),\r\n\t\t\tdiv({ style: `width: 33%; margin-right: 0%;` },\r\n\t\t\t\tthis.limitThresholdSlider,\r\n\t\t\t),\r\n\r\n\t\t),\r\n\t\tdiv({ style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\" },\r\n\t\t\tdiv({ style: `text-align: right; width: 25%; margin-right: 4.5%; color: ${ColorConfig.primaryText};` },\r\n\t\t\t\t\"Ratio:\"\r\n\t\t\t),\r\n\t\t\tdiv({ style: `width: 33%; margin-right: 4.5%;` },\r\n\t\t\t\tthis.compressionRatioSlider,\r\n\t\t\t),\r\n\t\t\tdiv({ style: `width: 33%; margin-right: 0%;` },\r\n\t\t\t\tthis.limitRatioSlider,\r\n\t\t\t),\r\n\t\t),\r\n\t\tdiv({ style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\" },\r\n\t\t\tdiv({ style: `text-align: right; width: 8.5em; margin-right: 1em; color: ${ColorConfig.primaryText};` },\r\n\t\t\t\t\"Limit Decay:\"\r\n\t\t\t),\r\n\t\t\tthis.limitDecaySlider,\r\n\t\t),\r\n\t\tdiv({ style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\" },\r\n\t\t\tdiv({ style: `text-align: right; width: 8.5em; margin-right: 1em; color: ${ColorConfig.primaryText};` },\r\n\t\t\t\t\"Limit Rise:\"\r\n\t\t\t),\r\n\t\t\tthis.limitRiseSlider,\r\n\t\t),\r\n\t\tdiv({ style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\" },\r\n\t\t\tdiv({ style: `text-align: right; width: 8.5em; margin-right: 1em; color: ${ColorConfig.primaryText};` },\r\n\t\t\t\t\"Master Gain:\"\r\n\t\t\t),\r\n\t\t\tthis.masterGainSlider,\r\n\t\t),\r\n\t\tdiv({ style: \"display: flex; flex-direction: row-reverse; justify-content: space-between;\" },\r\n\t\t\tthis._okayButton,\r\n\t\t\tthis._resetButton,\r\n\t\t),\r\n\t\tthis._cancelButton,\r\n\t);\r\n\r\n\tconstructor(private _doc: SongDocument, private _songEditor: SongEditor) {\r\n\r\n\t\tthis._okayButton.addEventListener(\"click\", this._saveChanges);\r\n\t\tthis._resetButton.addEventListener(\"click\", this._resetDefaults);\r\n\t\tthis._cancelButton.addEventListener(\"click\", this._close);\r\n\t\tthis.container.addEventListener(\"keydown\", this.whenKeyPressed);\r\n\r\n\t\tthis.limitRatioSlider.value = \"\" + (this._doc.song.limitRatio < 1 ? this._doc.song.limitRatio * 10 : 9 + this._doc.song.limitRatio);\r\n\t\tthis.compressionRatioSlider.value = \"\" + (this._doc.song.compressionRatio < 1 ? this._doc.song.compressionRatio * 10 : 10 + (this._doc.song.compressionRatio - 1) * 60);\r\n\t\tthis.limitThresholdSlider.value = \"\" + this._doc.song.limitThreshold;\r\n\t\tthis.compressionThresholdSlider.value = \"\" + this._doc.song.compressionThreshold;\r\n\t\tthis.limitDecaySlider.value = \"\" + this._doc.song.limitDecay;\r\n\t\tthis.limitRiseSlider.value = \"\" + this._doc.song.limitRise;\r\n\t\tthis.masterGainSlider.value = \"\" + this._doc.song.masterGain;\r\n\r\n\t\tthis.startingLimitRatio = +this.limitRatioSlider.value;\r\n\t\tthis.startingCompressionRatio = +this.compressionRatioSlider.value;\r\n\t\tthis.startingLimitThreshold = +this.limitThresholdSlider.value;\r\n\t\tthis.startingCompressionThreshold = +this.compressionThresholdSlider.value;\r\n\t\tthis.startingLimitDecay = +this.limitDecaySlider.value;\r\n\t\tthis.startingLimitRise = +this.limitRiseSlider.value;\r\n\t\tthis.startingMasterGain = +this.masterGainSlider.value;\r\n\r\n\t\tthis.limitDecaySlider.addEventListener(\"input\", this._whenInput);\r\n\t\tthis.limitRiseSlider.addEventListener(\"input\", this._whenInput);\r\n\t\tthis.limitRatioSlider.addEventListener(\"input\", this._whenInput);\r\n\t\tthis.limitThresholdSlider.addEventListener(\"input\", this._whenInputFavorLimitThreshold);\r\n\t\tthis.compressionRatioSlider.addEventListener(\"input\", this._whenInput);\r\n\t\tthis.compressionThresholdSlider.addEventListener(\"input\", this._whenInput);\r\n\t\tthis.masterGainSlider.addEventListener(\"input\", this._whenInput);\r\n\r\n\t\tthis._playButton.addEventListener(\"click\", this._togglePlay);\r\n\r\n\t\twindow.requestAnimationFrame(this._volumeUpdate);\r\n\r\n\t\tthis.updatePlayButton();\r\n\r\n\t\tsetTimeout(() => this._playButton.focus());\r\n\r\n\t\tthis.limiterCanvas.render();\r\n\t}\r\n\r\n\tprivate _volumeUpdate = (): void => {\r\n\t\tthis.inVolumeHistoricTimer--;\r\n\t\tif (this.inVolumeHistoricTimer <= 0) {\r\n\t\t\tthis.inVolumeHistoricCap -= 0.03;\r\n\t\t}\r\n\t\tif (this._doc.song.inVolumeCap > this.inVolumeHistoricCap) {\r\n\t\t\tthis.inVolumeHistoricCap = this._doc.song.inVolumeCap;\r\n\t\t\tthis.inVolumeHistoricTimer = 50;\r\n\t\t}\r\n\r\n\t\tthis.outVolumeHistoricTimer--;\r\n\t\tif (this.outVolumeHistoricTimer <= 0) {\r\n\t\t\tthis.outVolumeHistoricCap -= 0.03;\r\n\t\t}\r\n\t\tif (this._doc.song.outVolumeCap > this.outVolumeHistoricCap) {\r\n\t\t\tthis.outVolumeHistoricCap = this._doc.song.outVolumeCap;\r\n\t\t\tthis.outVolumeHistoricTimer = 50;\r\n\t\t}\r\n\r\n\t\tthis.limiterCanvas.animateVolume(this._doc.song.inVolumeCap, this.inVolumeHistoricCap, this._doc.song.outVolumeCap, this.outVolumeHistoricCap);\r\n\t\t//console.log(this._doc.song.volumeCap);\r\n\t\twindow.requestAnimationFrame(this._volumeUpdate);\r\n\t}\r\n\r\n\tprivate _togglePlay = (): void => {\r\n\t\tthis._songEditor.togglePlay();\r\n\t\tthis.updatePlayButton();\r\n\t}\r\n\r\n\tpublic updatePlayButton(): void {\r\n\t\tif (this._doc.synth.playing) {\r\n\t\t\tthis._playButton.classList.remove(\"playButton\");\r\n\t\t\tthis._playButton.classList.add(\"pauseButton\");\r\n\t\t\tthis._playButton.title = \"Pause (Space)\";\r\n\t\t\tthis._playButton.innerText = \"Pause\";\r\n\t\t} else {\r\n\t\t\tthis._playButton.classList.remove(\"pauseButton\");\r\n\t\t\tthis._playButton.classList.add(\"playButton\");\r\n\t\t\tthis._playButton.title = \"Play (Space)\";\r\n\t\t\tthis._playButton.innerText = \"Play\";\r\n\t\t}\r\n\t}\r\n\r\n\tprivate _whenInput = (): void => {\r\n\t\tif (+this.limitThresholdSlider.value < +this.compressionThresholdSlider.value) {\r\n\t\t\tthis.limitThresholdSlider.removeEventListener(\"input\", this._whenInputFavorLimitThreshold);\r\n\t\t\tthis.limitThresholdSlider.value = this.compressionThresholdSlider.value;\r\n\t\t\tthis.limitThresholdSlider.addEventListener(\"input\", this._whenInputFavorLimitThreshold);\r\n\t\t}\r\n\t\tthis.limiterCanvas.render();\r\n\t\tthis._updateLimiter();\r\n\t}\r\n\r\n\t// Same as above, but for conflicts between limiter threshold and compressor threshold, favor the limiter\r\n\tprivate _whenInputFavorLimitThreshold = (): void => {\r\n\t\tif (+this.limitThresholdSlider.value < +this.compressionThresholdSlider.value) {\r\n\t\t\tthis.compressionThresholdSlider.removeEventListener(\"input\", this._whenInput);\r\n\t\t\tthis.compressionThresholdSlider.value = this.limitThresholdSlider.value;\r\n\t\t\tthis.compressionThresholdSlider.addEventListener(\"input\", this._whenInput);\r\n\t\t}\r\n\t\tthis.limiterCanvas.render();\r\n\t\tthis._updateLimiter();\r\n\t}\r\n\r\n\tprivate _close = (): void => {\r\n\t\t// Reset all sliders to starting values\r\n\t\tthis.limitRatioSlider.value = \"\" + this.startingLimitRatio;\r\n\t\tthis.compressionRatioSlider.value = \"\" + this.startingCompressionRatio;\r\n\t\tthis.limitThresholdSlider.value = \"\" + this.startingLimitThreshold;\r\n\t\tthis.compressionThresholdSlider.value = \"\" + this.startingCompressionThreshold;\r\n\t\tthis.limitDecaySlider.value = \"\" + this.startingLimitDecay;\r\n\t\tthis.limitRiseSlider.value = \"\" + this.startingLimitRise;\r\n\t\tthis.masterGainSlider.value = \"\" + this.startingMasterGain;\r\n\r\n\t\tthis._updateLimiter();\r\n\t\tthis._doc.prompt = null;\r\n\t}\r\n\r\n\tpublic cleanUp = (): void => {\r\n\t\tthis._okayButton.removeEventListener(\"click\", this._saveChanges);\r\n\t\tthis._resetButton.removeEventListener(\"click\", this._resetDefaults);\r\n\t\tthis._cancelButton.removeEventListener(\"click\", this._close);\r\n\t\tthis.container.removeEventListener(\"keydown\", this.whenKeyPressed);\r\n\t\tthis.limitDecaySlider.removeEventListener(\"input\", this._whenInput);\r\n\t\tthis.limitRiseSlider.removeEventListener(\"input\", this._whenInput);\r\n\t\tthis.limitThresholdSlider.removeEventListener(\"input\", this._whenInputFavorLimitThreshold);\r\n\t\tthis.limitRatioSlider.removeEventListener(\"input\", this._whenInput);\r\n\t\tthis.compressionRatioSlider.removeEventListener(\"input\", this._whenInput);\r\n\t\tthis.compressionThresholdSlider.removeEventListener(\"input\", this._whenInput);\r\n\t\tthis.masterGainSlider.removeEventListener(\"input\", this._whenInput);\r\n\r\n\t\tthis._playButton.removeEventListener(\"click\", this._togglePlay);\r\n\t}\r\n\r\n\tpublic whenKeyPressed = (event: KeyboardEvent): void => {\r\n\t\tif ((<Element>event.target).tagName != \"BUTTON\" && event.keyCode == 13) { // Enter key\r\n\t\t\tthis._saveChanges();\r\n\t\t}\r\n\t\tif (event.keyCode == 32) {\r\n\t\t\tthis._togglePlay();\r\n\t\t\tevent.preventDefault();\r\n\t\t}\r\n\t}\r\n\r\n\tprivate _resetDefaults = (): void => {\r\n\t\t// Set song limiter settings to their default\r\n\t\tif (this.limitRatioSlider.value != \"10\" || this.limitRiseSlider.value != \"4000\" || this.limitDecaySlider.value != \"4\" || this.limitThresholdSlider.value != \"1\" || this.compressionRatioSlider.value != \"10\" || this.compressionThresholdSlider.value != \"1\" || this.masterGainSlider.value != \"1\") {\r\n\r\n\t\t\tthis.limitRatioSlider.value = \"10\";\r\n\t\t\tthis.limitRiseSlider.value = \"4000\";\r\n\t\t\tthis.limitDecaySlider.value = \"4\";\r\n\t\t\tthis.limitThresholdSlider.value = \"1\";\r\n\t\t\tthis.compressionRatioSlider.value = \"10\";\r\n\t\t\tthis.compressionThresholdSlider.value = \"1\";\r\n\t\t\tthis.masterGainSlider.value = \"1\";\r\n\r\n\t\t\tthis._whenInput();\r\n\t\t}\r\n\t}\r\n\r\n\tprivate _updateLimiter = (): void => {\r\n\t\t// Save slider values to song\r\n\t\tthis._doc.record(new ChangeLimiterSettings(this._doc,\r\n\t\t\t(+this.limitRatioSlider.value < 10 ? +this.limitRatioSlider.value / 10 : (+this.limitRatioSlider.value - 9)),\r\n\t\t\t(+this.compressionRatioSlider.value < 10 ? +this.compressionRatioSlider.value / 10 : (1 + (+this.compressionRatioSlider.value - 10) / 60)),\r\n\t\t\t+this.limitThresholdSlider.value,\r\n\t\t\t+this.compressionThresholdSlider.value,\r\n\t\t\t+this.limitRiseSlider.value,\r\n\t\t\t+this.limitDecaySlider.value,\r\n\t\t\t+this.masterGainSlider.value,\r\n\t\t), true);\r\n\t}\r\n\r\n\tprivate _saveChanges = (): void => {\r\n\t\tthis._updateLimiter();\r\n\t\tthis._doc.prompt = null;\r\n\r\n\t}\r\n}\r\n//}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { HTML, SVG } from \"imperative-html/dist/esm/elements-strict\";\r\nimport { ChangeLoop, ChangeChannelBar } from \"./changes\";\r\nimport { ColorConfig } from \"./ColorConfig\";\r\n\r\ninterface Cursor {\r\n\tstartBar: number;\r\n\tmode: number;\r\n}\r\n\r\ninterface Endpoints {\r\n\tstart: number;\r\n\tlength: number;\r\n}\r\n\r\nexport class LoopEditor {\r\n\tprivate readonly _editorHeight: number = 20;\r\n\t\tprivate readonly _startMode:   number = 0;\r\n\t\tprivate readonly _endMode:     number = 1;\r\n\t\tprivate readonly _bothMode:    number = 2;\r\n\t\t\r\n\t\tprivate readonly _loop: SVGPathElement = SVG.path({fill: \"none\", stroke: ColorConfig.loopAccent, \"stroke-width\": 4});\r\n\t\tprivate readonly _highlight: SVGPathElement = SVG.path({fill: ColorConfig.hoverPreview, \"pointer-events\": \"none\"});\r\n\t\t\r\n\tprivate readonly _svg: SVGSVGElement = SVG.svg({style: `touch-action: pan-y; position: absolute;`, height: this._editorHeight},\r\n\t\tthis._loop,\r\n\t\tthis._highlight,\r\n\t);\r\n\t\t\r\n\tpublic readonly container: HTMLElement = HTML.div({class: \"loopEditor\"}, this._svg);\r\n\t\t\r\n\tprivate _barWidth: number = 32;\r\n\tprivate _change: ChangeLoop | null = null;\r\n\t\tprivate _cursor: Cursor = {startBar: -1, mode: -1};\r\n\tprivate _mouseX: number = 0;\r\n\t//private _mouseY: number = 0;\r\n\tprivate _clientStartX: number = 0;\r\n\tprivate _clientStartY: number = 0;\r\n\tprivate _startedScrolling: boolean = false;\r\n\tprivate _draggingHorizontally: boolean = false;\r\n\tprivate _mouseDown: boolean = false;\r\n\tprivate _mouseOver: boolean = false;\r\n\tprivate _renderedLoopStart: number = -1;\r\n\tprivate _renderedLoopStop: number = -1;\r\n\tprivate _renderedBarCount: number = 0;\r\n\tprivate _renderedBarWidth: number = -1;\r\n\t\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis._updateCursorStatus();\r\n\t\tthis._render();\r\n\t\tthis._doc.notifier.watch(this._documentChanged);\r\n\t\t\t\r\n\t\tthis.container.addEventListener(\"mousedown\", this._whenMousePressed);\r\n\t\tdocument.addEventListener(\"mousemove\", this._whenMouseMoved);\r\n\t\tdocument.addEventListener(\"mouseup\", this._whenCursorReleased);\r\n\t\tthis.container.addEventListener(\"mouseover\", this._whenMouseOver);\r\n\t\tthis.container.addEventListener(\"mouseout\", this._whenMouseOut);\r\n\t\t\t\r\n\t\tthis.container.addEventListener(\"touchstart\", this._whenTouchPressed);\r\n\t\tthis.container.addEventListener(\"touchmove\", this._whenTouchMoved);\r\n\t\tthis.container.addEventListener(\"touchend\", this._whenTouchReleased);\r\n\t\tthis.container.addEventListener(\"touchcancel\", this._whenTouchReleased);\r\n\t}\r\n\t\t\r\n\tprivate _updateCursorStatus(): void {\r\n\t\tconst bar: number = this._mouseX / this._barWidth;\r\n\t\tthis._cursor.startBar = bar;\r\n\t\t\t\r\n\t\tif (bar > this._doc.song.loopStart - 0.25 && bar < this._doc.song.loopStart + this._doc.song.loopLength + 0.25) {\r\n\t\t\tif (bar - this._doc.song.loopStart < this._doc.song.loopLength * 0.5) {\r\n\t\t\t\tthis._cursor.mode = this._startMode;\r\n\t\t\t} else {\r\n\t\t\t\tthis._cursor.mode = this._endMode;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tthis._cursor.mode = this._bothMode;\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tprivate _findEndPoints(middle: number): Endpoints {\r\n\t\tlet start: number = Math.round(middle - this._doc.song.loopLength / 2);\r\n\t\tlet end: number = start + this._doc.song.loopLength;\r\n\t\tif (start < 0) {\r\n\t\t\tend -= start;\r\n\t\t\tstart = 0;\r\n\t\t}\r\n\t\tif (end > this._doc.song.barCount) {\r\n\t\t\tstart -= end - this._doc.song.barCount;\r\n\t\t\tend = this._doc.song.barCount;\r\n\t\t}\r\n\t\t\treturn {start: start, length: end - start};\r\n\t}\r\n\t\t\r\n\tprivate _whenMouseOver = (event: MouseEvent): void => {\r\n\t\tif (this._mouseOver) return;\r\n\t\tthis._mouseOver = true;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\t\r\n\tprivate _whenMouseOut = (event: MouseEvent): void => {\r\n\t\tif (!this._mouseOver) return;\r\n\t\tthis._mouseOver = false;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\t\r\n\tprivate _whenMousePressed = (event: MouseEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.clientX || event.pageX) - boundingRect.left;\r\n\t\t//this._mouseY = (event.clientY || event.pageY) - boundingRect.top;\r\n\t\tthis._updateCursorStatus();\r\n\t\tthis._updatePreview();\r\n\t\tthis._whenMouseMoved(event);\r\n\t}\r\n\t\t\r\n\tprivate _whenTouchPressed = (event: TouchEvent): void => {\r\n\t\t//event.preventDefault();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = event.touches[0].clientX - boundingRect.left;\r\n\t\t//this._mouseY = event.touches[0].clientY - boundingRect.top;\r\n\t\tthis._updateCursorStatus();\r\n\t\tthis._updatePreview();\r\n\t\t//this._whenTouchMoved(event);\r\n\t\tthis._clientStartX = event.touches[0].clientX;\r\n\t\tthis._clientStartY = event.touches[0].clientY;\r\n\t\tthis._draggingHorizontally = false;\r\n\t\tthis._startedScrolling = false;\r\n\t}\r\n\t\t\r\n\tprivate _whenMouseMoved = (event: MouseEvent): void => {\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.clientX || event.pageX) - boundingRect.left;\r\n\t\t//this._mouseY = (event.clientY || event.pageY) - boundingRect.top;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\t\r\n\tprivate _whenTouchMoved = (event: TouchEvent): void => {\r\n\t\tif (!this._mouseDown) return;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = event.touches[0].clientX - boundingRect.left;\r\n\t\t//this._mouseY = event.touches[0].clientY - boundingRect.top;\r\n\t\t\t\r\n\t\tif (!this._draggingHorizontally && !this._startedScrolling) {\r\n\t\t\tif (Math.abs(event.touches[0].clientY - this._clientStartY) > 10) {\r\n\t\t\t\tthis._startedScrolling = true;\r\n\t\t\t} else if (Math.abs(event.touches[0].clientX - this._clientStartX) > 10) {\r\n\t\t\t\tthis._draggingHorizontally = true;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\t\r\n\t\tif (this._draggingHorizontally) {\r\n\t\t\tthis._whenCursorMoved();\r\n\t\t\tevent.preventDefault();\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tprivate _whenCursorMoved(): void {\r\n\t\tif (this._mouseDown) {\r\n\t\t\tlet oldStart: number = this._doc.song.loopStart;\r\n\t\t\tlet oldEnd: number = this._doc.song.loopStart + this._doc.song.loopLength;\r\n\t\t\tif (this._change != null && this._doc.lastChangeWas(this._change)) {\r\n\t\t\t\toldStart = this._change.oldStart;\r\n\t\t\t\toldEnd = oldStart + this._change.oldLength;\r\n\t\t\t}\r\n\t\t\t\t\r\n\t\t\tconst bar: number = this._mouseX / this._barWidth;\r\n\t\t\tlet start: number;\r\n\t\t\tlet end: number;\r\n\t\t\tlet temp: number;\r\n\t\t\tif (this._cursor.mode == this._startMode) {\r\n\t\t\t\tstart = oldStart + Math.round(bar - this._cursor.startBar);\r\n\t\t\t\tend = oldEnd;\r\n\t\t\t\tif (start < 0) start = 0;\r\n\t\t\t\tif (start >= this._doc.song.barCount) start = this._doc.song.barCount;\r\n\t\t\t\tif (start == end) {\r\n\t\t\t\t\tstart = end - 1;\r\n\t\t\t\t} else if (start > end) {\r\n\t\t\t\t\ttemp = start;\r\n\t\t\t\t\tstart = end;\r\n\t\t\t\t\tend = temp;\r\n\t\t\t\t}\r\n\t\t\t\tthis._change = new ChangeLoop(this._doc, oldStart, oldEnd - oldStart, start, end - start);\r\n\t\t\t} else if (this._cursor.mode == this._endMode) {\r\n\t\t\t\tstart = oldStart;\r\n\t\t\t\tend = oldEnd + Math.round(bar - this._cursor.startBar);\r\n\t\t\t\tif (end < 0) end = 0;\r\n\t\t\t\tif (end >= this._doc.song.barCount) end = this._doc.song.barCount;\r\n\t\t\t\tif (end == start) {\r\n\t\t\t\t\tend = start + 1;\r\n\t\t\t\t} else if (end < start) {\r\n\t\t\t\t\ttemp = start;\r\n\t\t\t\t\tstart = end;\r\n\t\t\t\t\tend = temp;\r\n\t\t\t\t}\r\n\t\t\t\tthis._change = new ChangeLoop(this._doc, oldStart, oldEnd - oldStart, start, end - start);\r\n\t\t\t} else if (this._cursor.mode == this._bothMode) {\r\n\t\t\t\tconst endPoints: Endpoints = this._findEndPoints(bar);\r\n\t\t\t\tthis._change = new ChangeLoop(this._doc, oldStart, oldEnd - oldStart, endPoints.start, endPoints.length);\r\n\t\t\t}\r\n\t\t\tthis._doc.synth.jumpIntoLoop();\r\n\t\t\tif (this._doc.prefs.autoFollow) {\r\n\t\t\t\tnew ChangeChannelBar(this._doc, this._doc.channel, Math.floor(this._doc.synth.playhead), true);\r\n\t\t\t}\r\n\t\t\tthis._doc.setProspectiveChange(this._change);\r\n\t\t} else {\r\n\t\t\tthis._updateCursorStatus();\r\n\t\t\tthis._updatePreview();\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tprivate _whenTouchReleased = (event: TouchEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tif (!this._startedScrolling) {\r\n\t\t\tthis._whenCursorMoved();\r\n\t\t\tthis._mouseOver = false;\r\n\t\t\tthis._whenCursorReleased(event);\r\n\t\t\tthis._updatePreview();\r\n\t\t}\r\n\r\n\t\tthis._mouseDown = false;\r\n\t}\r\n\t\t\r\n\tprivate _whenCursorReleased = (event: Event): void => {\r\n\t\tif (this._change != null) this._doc.record(this._change);\r\n\t\tthis._change = null;\r\n\t\tthis._mouseDown = false;\r\n\t\tthis._updateCursorStatus();\r\n\t\tthis._render();\r\n\t}\r\n\t\t\r\n\tprivate _updatePreview(): void {\r\n\t\tconst showHighlight: boolean = this._mouseOver && !this._mouseDown;\r\n\t\tthis._highlight.style.visibility = showHighlight ? \"visible\" : \"hidden\";\r\n\t\t\t\r\n\t\tif (showHighlight) {\r\n\t\t\tconst radius: number = this._editorHeight / 2;\r\n\t\t\t\t\r\n\t\t\tlet highlightStart: number = (this._doc.song.loopStart) * this._barWidth;\r\n\t\t\tlet highlightStop: number = (this._doc.song.loopStart + this._doc.song.loopLength) * this._barWidth;\r\n\t\t\tif (this._cursor.mode == this._startMode) {\r\n\t\t\t\thighlightStop = (this._doc.song.loopStart) * this._barWidth + radius * 2;\r\n\t\t\t} else if (this._cursor.mode == this._endMode) {\r\n\t\t\t\thighlightStart = (this._doc.song.loopStart + this._doc.song.loopLength) * this._barWidth - radius * 2;\r\n\t\t\t} else {\r\n\t\t\t\tconst endPoints: Endpoints = this._findEndPoints(this._cursor.startBar);\r\n\t\t\t\thighlightStart = (endPoints.start) * this._barWidth;\r\n\t\t\t\thighlightStop = (endPoints.start + endPoints.length) * this._barWidth;\r\n\t\t\t}\r\n\t\t\t\t\r\n\t\t\tthis._highlight.setAttribute(\"d\",\r\n\t\t\t\t`M ${highlightStart + radius} ${4} ` +\r\n\t\t\t\t`L ${highlightStop - radius} ${4} ` +\r\n\t\t\t\t`A ${radius - 4} ${radius - 4} ${0} ${0} ${1} ${highlightStop - radius} ${this._editorHeight - 4} ` +\r\n\t\t\t\t`L ${highlightStart + radius} ${this._editorHeight - 4} ` +\r\n\t\t\t\t`A ${radius - 4} ${radius - 4} ${0} ${0} ${1} ${highlightStart + radius} ${4} ` +\r\n\t\t\t\t`z`\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tprivate _documentChanged = (): void => {\r\n\t\tthis._render();\r\n\t}\r\n\t\t\r\n\tprivate _render(): void {\r\n\t\tthis._barWidth = this._doc.getBarWidth();\r\n\t\t\t\r\n\t\tconst radius: number = this._editorHeight / 2;\r\n\t\tconst loopStart: number = (this._doc.song.loopStart) * this._barWidth;\r\n\t\tconst loopStop: number = (this._doc.song.loopStart + this._doc.song.loopLength) * this._barWidth;\r\n\t\t\t\r\n\t\tif (this._renderedBarCount != this._doc.song.barCount || this._renderedBarWidth != this._barWidth) {\r\n\t\t\tthis._renderedBarCount = this._doc.song.barCount;\r\n\t\t\tthis._renderedBarWidth = this._barWidth;\r\n\t\t\tconst editorWidth = this._barWidth * this._doc.song.barCount;\r\n\t\t\tthis.container.style.width = editorWidth + \"px\";\r\n\t\t\tthis._svg.setAttribute(\"width\", editorWidth + \"\");\r\n\t\t}\r\n\r\n\t\tif (this._renderedLoopStart != loopStart || this._renderedLoopStop != loopStop) {\r\n\t\t\tthis._renderedLoopStart = loopStart;\r\n\t\t\tthis._renderedLoopStop = loopStop;\r\n\t\t\tthis._loop.setAttribute(\"d\",\r\n\t\t\t\t`M ${loopStart + radius} ${2} ` +\r\n\t\t\t\t`L ${loopStop - radius} ${2} ` +\r\n\t\t\t\t`A ${radius - 2} ${radius - 2} ${0} ${0} ${1} ${loopStop - radius} ${this._editorHeight - 2} ` +\r\n\t\t\t\t`L ${loopStart + radius} ${this._editorHeight - 2} ` +\r\n\t\t\t\t`A ${radius - 2} ${radius - 2} ${0} ${0} ${1} ${loopStart + radius} ${2} ` +\r\n\t\t\t\t`z`\r\n\t\t\t);\r\n\t\t}\r\n\t\t\t\r\n\t\tthis._updatePreview();\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { Config } from \"../synth/SynthConfig\";\r\nimport { HTML } from \"imperative-html/dist/esm/elements-strict\";\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { Prompt } from \"./Prompt\";\r\nimport { ChangeMoveNotesSideways } from \"./changes\";\r\nimport { ColorConfig } from \"./ColorConfig\";\r\n\r\n\tconst {button, div, span, h2, input, br, select, option} = HTML;\r\n\r\nexport class MoveNotesSidewaysPrompt implements Prompt {\r\n\t\tprivate readonly _beatsStepper: HTMLInputElement = input({style: \"width: 3em; margin-left: 1em;\", type: \"number\", step: \"0.01\", value: \"0\"});\r\n\t\tprivate readonly _conversionStrategySelect: HTMLSelectElement = select({style: \"width: 100%;\"},\r\n\t\t\toption({value: \"overflow\"}, \"Overflow notes across bars.\"),\r\n\t\t\toption({value: \"wrapAround\"}, \"Wrap notes around within bars.\"),\r\n\t);\r\n\t\tprivate readonly _cancelButton: HTMLButtonElement = button({class: \"cancelButton\"});\r\n\t\tprivate readonly _okayButton: HTMLButtonElement = button({class: \"okayButton\", style: \"width:45%;\"}, \"Okay\");\r\n\t\t\r\n\t\tpublic readonly container: HTMLDivElement = div({class: \"prompt noSelection\", style: \"width: 250px;\"},\r\n\t\th2(\"Move Notes Sideways\"),\r\n\t\t\tdiv({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\tdiv({style: \"text-align: right;\"},\r\n\t\t\t\t\"Beats to move:\",\r\n\t\t\t\tbr(),\r\n\t\t\t\t\tspan({style: `font-size: smaller; color: ${ColorConfig.secondaryText};`}, \"(Negative is left, positive is right)\"),\r\n\t\t\t),\r\n\t\t\tthis._beatsStepper,\r\n\t\t),\r\n\t\t\tdiv({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\tdiv({class: \"selectContainer\", style: \"width: 100%;\"}, this._conversionStrategySelect),\r\n\t\t),\r\n\t\t\tdiv({style: \"display: flex; flex-direction: row-reverse; justify-content: space-between;\"},\r\n\t\t\tthis._okayButton,\r\n\t\t),\r\n\t\tthis._cancelButton,\r\n\t);\r\n\t\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis._beatsStepper.min = (-this._doc.song.beatsPerBar) + \"\";\r\n\t\tthis._beatsStepper.max = this._doc.song.beatsPerBar + \"\";\r\n\t\t\t\r\n\t\tconst lastStrategy: string | null = window.localStorage.getItem(\"moveNotesSidewaysStrategy\");\r\n\t\tif (lastStrategy != null) {\r\n\t\t\tthis._conversionStrategySelect.value = lastStrategy;\r\n\t\t}\r\n\t\t\t\r\n\t\tthis._beatsStepper.select();\r\n\t\tsetTimeout(() => this._beatsStepper.focus(), 100); // Add 100ms because the key macro (W) gets captured by the stepper...\r\n\t\t\t\r\n\t\tthis._okayButton.addEventListener(\"click\", this._saveChanges);\r\n\t\tthis._cancelButton.addEventListener(\"click\", this._close);\r\n\t\tthis._beatsStepper.addEventListener(\"blur\", MoveNotesSidewaysPrompt._validateNumber);\r\n\t\tthis.container.addEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\t\t\r\n\t\tprivate _close = (): void => { \r\n\t\tthis._doc.undo();\r\n\t}\r\n\t\t\r\n\t\tpublic cleanUp = (): void => { \r\n\t\tthis._okayButton.removeEventListener(\"click\", this._saveChanges);\r\n\t\tthis._cancelButton.removeEventListener(\"click\", this._close);\r\n\t\tthis._beatsStepper.removeEventListener(\"blur\", MoveNotesSidewaysPrompt._validateNumber);\r\n\t\tthis.container.removeEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\t\t\r\n\tprivate _whenKeyPressed = (event: KeyboardEvent): void => {\r\n\t\t\tif ((<Element> event.target).tagName != \"BUTTON\" && event.keyCode == 13) { // Enter key\r\n\t\t\tthis._saveChanges();\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tprivate static _validateNumber(event: Event): void {\r\n\t\tconst input: HTMLInputElement = <HTMLInputElement>event.target;\r\n\t\tlet value: number = +input.value;\r\n\t\tvalue = Math.round(value * Config.partsPerBeat) / Config.partsPerBeat;\r\n\t\tvalue = Math.round(value * 100) / 100;\r\n\t\tinput.value = Math.max(+input.min, Math.min(+input.max, value)) + \"\";\r\n\t}\r\n\t\t\r\n\tprivate _saveChanges = (): void => {\r\n\t\twindow.localStorage.setItem(\"moveNotesSidewaysStrategy\", this._conversionStrategySelect.value);\r\n\t\tthis._doc.prompt = null;\r\n\t\tthis._doc.record(new ChangeMoveNotesSideways(this._doc, +this._beatsStepper.value, this._conversionStrategySelect.value), true);\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { HTML } from \"imperative-html/dist/esm/elements-strict\";\r\nimport { ColorConfig } from \"./ColorConfig\";\r\nimport { InputBox } from \"./HTMLWrapper\";\r\nimport { ChangeChannelOrder, ChangeChannelName, ChangeRemoveChannel } from \"./changes\";\r\nimport { Config } from \"../synth/SynthConfig\";\r\nimport { SongEditor } from \"./SongEditor\";\r\n\r\n//namespace beepbox {\r\nexport class MuteEditor {\r\n\t\r\n\tprivate _cornerFiller: HTMLDivElement = HTML.div({style: `background: ${ColorConfig.editorBackground}; position: sticky; bottom: 0; left: 0; width: 32px; height: 30px;`});\r\n\t\r\n\tprivate readonly _buttons: HTMLDivElement[] = [];\r\n\tprivate readonly _channelCounts: HTMLDivElement[] = [];\r\n\tprivate readonly _channelNameDisplay: HTMLDivElement = HTML.div({ style: `background-color: ${ColorConfig.uiWidgetFocus}; white-space:nowrap; display: none; transform:translate(20px); width: auto; pointer-events: none; position: absolute; border-radius: 0.2em; z-index: 2;`, \"color\": ColorConfig.primaryText }, \"\");\r\n\tpublic readonly _channelNameInput: InputBox = new InputBox(HTML.input({ style: `color: ${ColorConfig.primaryText}; background-color: ${ColorConfig.uiWidgetFocus}; margin-top: -2px; display: none; width: 6em; position: absolute; border-radius: 0.2em; z-index: 2;`, \"color\": ColorConfig.primaryText }, \"\"), this._doc, (oldValue: string, newValue: string) => new ChangeChannelName(this._doc, oldValue, newValue));\r\n\r\n\tprivate readonly _channelDropDown: HTMLSelectElement = HTML.select({ style: \"width: 0px; left: 19px; height: 19px; position:absolute; opacity:0\" },\r\n\r\n\t\tHTML.option({ value: \"rename\" }, \"Rename...\"),\r\n\t\tHTML.option({ value: \"chnUp\" }, \"Move Channel Up\"),\r\n\t\tHTML.option({ value: \"chnDown\" }, \"Move Channel Down\"),\r\n\t\tHTML.option({ value: \"chnMute\" }, \"Mute Channel\"),\r\n\t\tHTML.option({ value: \"chnSolo\" }, \"Solo Channel\"),\r\n\t\tHTML.option({ value: \"chnInsert\" }, \"Insert Channel Below\"),\r\n\t\tHTML.option({ value: \"chnDelete\" }, \"Delete This Channel\"),\r\n\t);\r\n\r\n\tpublic readonly container: HTMLElement = HTML.div({ class: \"muteEditor\", style: \"position: sticky; padding-top: \" + Config.barEditorHeight + \"px;\" }, this._channelNameDisplay, this._channelNameInput.input, this._channelDropDown);\r\n\r\n\tprivate _editorHeight: number = 128;\r\n\tprivate _renderedChannelCount: number = 0;\r\n\tprivate _renderedPitchChannels: number = 0;\r\n\tprivate _renderedNoiseChannels: number = 0;\r\n\tprivate _renderedModChannels: number = 0;\r\n\tprivate _renderedChannelHeight: number = -1;\r\n\tprivate _channelDropDownChannel: number = 0;\r\n\tprivate _channelDropDownOpen: boolean = false;\r\n\tprivate _channelDropDownLastState: boolean = false;\r\n\r\n\tconstructor(private _doc: SongDocument, private _editor: SongEditor) {\r\n\t\tthis.container.addEventListener(\"click\", this._onClick);\r\n\t\tthis.container.addEventListener(\"mousemove\", this._onMouseMove);\r\n\t\tthis.container.addEventListener(\"mouseleave\", this._onMouseLeave);\r\n\r\n\t\tthis._channelDropDown.selectedIndex = -1;\r\n\t\tthis._channelDropDown.addEventListener(\"change\", this._channelDropDownHandler);\r\n\t\tthis._channelDropDown.addEventListener(\"mousedown\", this._channelDropDownGetOpenedPosition);\r\n\t\tthis._channelDropDown.addEventListener(\"blur\", this._channelDropDownBlur);\r\n\t\tthis._channelDropDown.addEventListener(\"click\", this._channelDropDownClick);\r\n\r\n\t\tthis._channelNameInput.input.addEventListener(\"change\", this._channelNameInputHide);\r\n\t\tthis._channelNameInput.input.addEventListener(\"blur\", this._channelNameInputHide);\r\n\t\tthis._channelNameInput.input.addEventListener(\"mousedown\", this._channelNameInputClicked);\r\n\t\tthis._channelNameInput.input.addEventListener(\"input\", this._channelNameInputWhenInput);\r\n\t}\r\n\r\n\tprivate _channelNameInputWhenInput = (): void => {\r\n\t\tlet newValue = this._channelNameInput.input.value;\r\n\t\tif (newValue.length > 15) {\r\n\t\t\tthis._channelNameInput.input.value = newValue.substring(0, 15);\r\n\t\t}\r\n\t}\r\n\r\n\tprivate _channelNameInputClicked = (event: MouseEvent): void => {\r\n\t\tevent.stopPropagation();\r\n\t}\r\n\r\n\tprivate _channelNameInputHide = (): void => {\r\n\t\tthis._channelNameInput.input.style.setProperty(\"display\", \"none\");\r\n\t\tthis._channelNameDisplay.style.setProperty(\"display\", \"none\");\r\n\t}\r\n\r\n\tprivate _channelDropDownClick = (event: MouseEvent): void => {\r\n\t\tthis._channelDropDownOpen = !this._channelDropDownLastState;\r\n\t\tthis._channelDropDownGetOpenedPosition(event);\r\n\t\t//console.log(\"click \" + this._channelDropDownOpen);\r\n\t}\r\n\r\n\tprivate _channelDropDownBlur = (): void => {\r\n\t\tthis._channelDropDownOpen = false;\r\n\t\tthis._channelNameDisplay.style.setProperty(\"display\", \"none\");\r\n\t\t//console.log(\"blur \" + this._channelDropDownOpen);\r\n\t}\r\n\r\n\tprivate _channelDropDownGetOpenedPosition = (event: MouseEvent): void => {\r\n\r\n\t\tthis._channelDropDownLastState = this._channelDropDownOpen;\r\n\r\n\t\tthis._channelDropDownChannel = Math.floor(Math.min(this._renderedChannelCount, Math.max(0, parseInt(this._channelDropDown.style.getPropertyValue(\"top\")) / this._renderedChannelHeight)));\r\n\t\tthis._doc.muteEditorChannel = this._channelDropDownChannel;\r\n\r\n\t\tthis._channelNameDisplay.style.setProperty(\"display\", \"\");\r\n\r\n\t\t// Check if channel is at limit, in which case another can't be inserted\r\n\t\tif ((this._channelDropDownChannel < this._doc.song.pitchChannelCount && this._doc.song.pitchChannelCount == Config.pitchChannelCountMax)\r\n\t\t\t|| (this._channelDropDownChannel >= this._doc.song.pitchChannelCount && this._channelDropDownChannel < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount && this._doc.song.noiseChannelCount == Config.noiseChannelCountMax)\r\n\t\t\t|| (this._channelDropDownChannel >= this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount && this._doc.song.modChannelCount == Config.modChannelCountMax)) {\r\n\t\t\tthis._channelDropDown.options[5].disabled = true;\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthis._channelDropDown.options[5].disabled = false;\r\n\t\t}\r\n\r\n\t\t// Also check if a channel is eligible to move up or down based on the song's channel settings.\r\n\t\tif (this._channelDropDownChannel == 0 || this._channelDropDownChannel == this._doc.song.pitchChannelCount || this._channelDropDownChannel == this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount) {\r\n\t\t\tthis._channelDropDown.options[1].disabled = true;\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthis._channelDropDown.options[1].disabled = false;\r\n\t\t}\r\n\t\tif (this._channelDropDownChannel == this._doc.song.pitchChannelCount - 1 || this._channelDropDownChannel == this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount - 1 || this._channelDropDownChannel == this._doc.song.getChannelCount() - 1) {\r\n\t\t\tthis._channelDropDown.options[2].disabled = true;\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthis._channelDropDown.options[2].disabled = false;\r\n\t\t}\r\n\r\n\t\t// Also, can't delete the last pitch channel.\r\n\t\tif (this._doc.song.pitchChannelCount == 1 && this._channelDropDownChannel == 0) {\r\n\t\t\tthis._channelDropDown.options[6].disabled = true;\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthis._channelDropDown.options[6].disabled = false;\r\n\t\t}\r\n\t}\r\n\r\n\tprivate _channelDropDownHandler = (event: Event): void => {\r\n\t\tthis._channelNameDisplay.style.setProperty(\"display\", \"none\");\r\n\t\tthis._channelDropDown.style.setProperty(\"display\", \"none\");\r\n\t\tthis._channelDropDownOpen = false;\r\n\t\tevent.stopPropagation();\r\n\t\t//console.log(\"handler \" + this._channelDropDownOpen);\r\n\r\n\t\tswitch (this._channelDropDown.value) {\r\n\t\t\tcase \"rename\":\r\n\t\t\t\tthis._channelNameInput.input.style.setProperty(\"display\", \"\");\r\n\t\t\t\tthis._channelNameInput.input.style.setProperty(\"transform\", this._channelNameDisplay.style.getPropertyValue(\"transform\"));\r\n\t\t\t\tif (this._channelNameDisplay.textContent != null) {\r\n\t\t\t\t\tthis._channelNameInput.input.value = this._channelNameDisplay.textContent;\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tthis._channelNameInput.input.value = \"\";\r\n\t\t\t\t}\r\n\t\t\t\tthis._channelNameInput.input.select();\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"chnUp\":\r\n\t\t\t\tthis._doc.record(new ChangeChannelOrder(this._doc, this._channelDropDownChannel, this._channelDropDownChannel, -1));\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"chnDown\":\r\n\t\t\t\tthis._doc.record(new ChangeChannelOrder(this._doc, this._channelDropDownChannel, this._channelDropDownChannel, 1));\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"chnMute\":\r\n\t\t\t\tthis._doc.song.channels[this._channelDropDownChannel].muted = !this._doc.song.channels[this._channelDropDownChannel].muted;\r\n\t\t\t\tthis.render();\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"chnSolo\": {\r\n\t\t\t\t// Check for any channel not matching solo pattern\r\n\t\t\t\tlet shouldSolo: boolean = false;\r\n\t\t\t\tfor (let channel: number = 0; channel < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount; channel++) {\r\n\t\t\t\t\tif (this._doc.song.channels[channel].muted == (channel == this._channelDropDownChannel)) {\r\n\t\t\t\t\t\tshouldSolo = true;\r\n\t\t\t\t\t\tchannel = this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (shouldSolo) {\r\n\t\t\t\t\tfor (let channel: number = 0; channel < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount; channel++) {\r\n\t\t\t\t\t\tthis._doc.song.channels[channel].muted = (channel != this._channelDropDownChannel);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tfor (let channel: number = 0; channel < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount; channel++) {\r\n\t\t\t\t\t\tthis._doc.song.channels[channel].muted = false;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tthis.render();\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tcase \"chnInsert\": {\r\n\t\t\t\tthis._doc.channel = this._channelDropDownChannel;\r\n\t\t\t\tthis._doc.selection.resetBoxSelection();\r\n\t\t\t\tthis._doc.selection.insertChannel();\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tcase \"chnDelete\": {\r\n\t\t\t\tthis._doc.record(new ChangeRemoveChannel(this._doc, this._channelDropDownChannel, this._channelDropDownChannel));\r\n\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (this._channelDropDown.value != \"rename\")\r\n\t\t\tthis._editor.refocusStage();\r\n\r\n\t\tthis._channelDropDown.selectedIndex = -1;\r\n\t}\r\n\r\n\tprivate _onClick = (event: MouseEvent): void => {\r\n\r\n\t\tconst index = this._buttons.indexOf(<HTMLDivElement>event.target);\r\n\t\tif (index == -1) return;\r\n\t\tlet xPos: number = event.clientX - this._buttons[0].getBoundingClientRect().left;\r\n\t\tif (xPos < 21.0) {\r\n\t\t\tthis._doc.song.channels[index].muted = !this._doc.song.channels[index].muted;\r\n\t\t}\r\n\t\tthis._doc.notifier.changed();\r\n\t}\r\n\r\n\tprivate _onMouseMove = (event: MouseEvent): void => {\r\n\t\tconst index = this._buttons.indexOf(<HTMLDivElement>event.target);\r\n\t\tif (index == -1) {\r\n\t\t\tif (!this._channelDropDownOpen && event.target != this._channelNameDisplay && event.target != this._channelDropDown) {\r\n\t\t\t\tthis._channelNameDisplay.style.setProperty(\"display\", \"none\");\r\n\t\t\t\tthis._channelDropDown.style.setProperty(\"display\", \"none\");\r\n\t\t\t\tthis._channelDropDown.style.setProperty(\"width\", \"0px\");\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tlet xPos: number = event.clientX - this._buttons[0].getBoundingClientRect().left;\r\n\t\tif (xPos >= 21.0) {\r\n\t\t\tif (!this._channelDropDownOpen) {\r\n\t\t\t\t// Mouse over chn. number\r\n\t\t\t\tthis._channelDropDown.style.setProperty(\"display\", \"\");\r\n\t\t\t\tvar height = this._doc.getChannelHeight();\r\n\t\t\t\tthis._channelNameDisplay.style.setProperty(\"transform\", \"translate(20px, \" + (height / 4 + height * index) + \"px)\");\r\n\r\n\t\t\t\tif (this._doc.song.channels[index].name != \"\") {\r\n\t\t\t\t\tthis._channelNameDisplay.textContent = this._doc.song.channels[index].name;\r\n\t\t\t\t\tthis._channelNameDisplay.style.setProperty(\"display\", \"\");\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tif (index < this._doc.song.pitchChannelCount) {\r\n\t\t\t\t\t\tthis._channelNameDisplay.textContent = \"Pitch \" + (index + 1);\r\n\t\t\t\t\t} else if (index < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount) {\r\n\t\t\t\t\t\tthis._channelNameDisplay.textContent = \"Noise \" + (index - this._doc.song.pitchChannelCount + 1);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tthis._channelNameDisplay.textContent = \"Mod \" + (index - this._doc.song.pitchChannelCount - this._doc.song.noiseChannelCount + 1);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// The name set will only show up when this becomes visible, e.g. when the dropdown is opened.\r\n\t\t\t\t\tthis._channelNameDisplay.style.setProperty(\"display\", \"none\");\r\n\t\t\t\t}\r\n\r\n\t\t\t\tthis._channelDropDown.style.top = (Config.barEditorHeight + 2 + index * this._renderedChannelHeight) + \"px\";\r\n\t\t\t\tthis._channelDropDown.style.setProperty(\"width\", \"15px\");\r\n\t\t\t}\r\n\t\t}\r\n\t\telse {\r\n\t\t\tif (!this._channelDropDownOpen) {\r\n\t\t\t\tthis._channelNameDisplay.style.setProperty(\"display\", \"none\");\r\n\t\t\t\tthis._channelDropDown.style.setProperty(\"display\", \"none\");\r\n\t\t\t\tthis._channelDropDown.style.setProperty(\"width\", \"0px\");\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tprivate _onMouseLeave = (event: MouseEvent): void => {\r\n\t\tif (!this._channelDropDownOpen) {\r\n\t\t\tthis._channelNameDisplay.style.setProperty(\"display\", \"none\");\r\n\t\t\tthis._channelDropDown.style.setProperty(\"width\", \"0px\");\r\n\t\t}\r\n\t}\r\n\r\n\tpublic onKeyUp(event: KeyboardEvent): void {\r\n\t\tswitch (event.keyCode) {\r\n\t\t\tcase 27: // esc\r\n\t\t\t\tthis._channelDropDownOpen = false;\r\n\t\t\t\t//console.log(\"close\");\r\n\t\t\t\tthis._channelNameDisplay.style.setProperty(\"display\", \"none\");\r\n\t\t\t\tbreak;\r\n\t\t\tcase 13: // enter\r\n\t\t\t\tthis._channelDropDownOpen = false;\r\n\t\t\t\t//console.log(\"close\");\r\n\t\t\t\tthis._channelNameDisplay.style.setProperty(\"display\", \"none\");\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\r\n\tpublic render(): void {\r\n\t\tif (!this._doc.prefs.enableChannelMuting) return;\r\n\t\t\r\n\t\tconst channelHeight = this._doc.getChannelHeight();\r\n\r\n\t\tif (this._renderedChannelCount != this._doc.song.getChannelCount()) {\r\n\t\t\tfor (let y: number = this._renderedChannelCount; y < this._doc.song.getChannelCount(); y++) {\r\n\r\n\t\t\t\tconst channelCountText: HTMLDivElement = HTML.div({ class: \"noSelection muteButtonText\", style: \"display: table-cell; -webkit-text-stroke: 1.5px; vertical-align: middle; text-align: center; -webkit-user-select: none; -webkit-touch-callout: none; -moz-user-select: none; -ms-user-select: none; user-select: none; pointer-events: none; width: 12px; height: 20px; transform: translate(0px, 1px);\" });\r\n\t\t\t\tconst muteButton: HTMLDivElement = HTML.div({ class: \"mute-button\", title: \"Mute (M), Mute All (⇧M), Solo (S), Exclude (⇧S)\", style: `display: block; pointer-events: none; width: 16px; height: 20px; transform: translate(2px, 1px);` });\r\n\r\n\t\t\t\tconst muteContainer: HTMLDivElement = HTML.div({ style: \"align-items: center; height: 20px; margin: 0px; display: table; flex-direction: row; justify-content: space-between;\" }, [\r\n\t\t\t\t\tmuteButton,\r\n\t\t\t\t\tchannelCountText,\r\n\t\t\t\t]);\r\n\t\t\t\tthis.container.appendChild(muteContainer);\r\n\t\t\t\tthis._buttons[y] = muteContainer;\r\n\t\t\t\tthis._channelCounts[y] = channelCountText;\r\n\t\t\t}\r\n\r\n\t\t\tfor (let y: number = this._doc.song.getChannelCount(); y < this._renderedChannelCount; y++) {\r\n\t\t\t\tthis.container.removeChild(this._buttons[y]);\r\n\t\t\t}\r\n\r\n\t\t\tthis._buttons.length = this._doc.song.getChannelCount();\r\n\r\n\t\t\tthis.container.appendChild(this._cornerFiller);\r\n\t\t}\r\n\r\n\t\tfor (let y: number = 0; y < this._doc.song.getChannelCount(); y++) {\r\n\t\t\tif (this._doc.song.channels[y].muted) {\r\n\t\t\t\tthis._buttons[y].children[0].classList.add(\"muted\");\r\n\r\n\t\t\t\tif (y < this._doc.song.pitchChannelCount)\r\n\t\t\t\t\tthis._channelCounts[y].style.color = ColorConfig.trackEditorBgPitchDim;\r\n\t\t\t\telse if (y < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount)\r\n\t\t\t\t\tthis._channelCounts[y].style.color = ColorConfig.trackEditorBgNoiseDim;\r\n\t\t\t\telse\r\n\t\t\t\t\tthis._channelCounts[y].style.color = ColorConfig.trackEditorBgModDim;\r\n\r\n\t\t\t} else {\r\n\t\t\t\tthis._buttons[y].children[0].classList.remove(\"muted\");\r\n\r\n\t\t\t\tif (y < this._doc.song.pitchChannelCount)\r\n\t\t\t\t\tthis._channelCounts[y].style.color = ColorConfig.trackEditorBgPitch;\r\n\t\t\t\telse if (y < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount)\r\n\t\t\t\t\tthis._channelCounts[y].style.color = ColorConfig.trackEditorBgNoise;\r\n\t\t\t\telse\r\n\t\t\t\t\tthis._channelCounts[y].style.color = ColorConfig.trackEditorBgMod;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (this._renderedChannelHeight != channelHeight || this._renderedChannelCount != this._doc.song.getChannelCount()) {\r\n\t\t\tfor (let y: number = 0; y < this._doc.song.getChannelCount(); y++) {\r\n\t\t\t\tthis._buttons[y].style.marginTop = ((channelHeight - 20) / 2) + \"px\";\r\n\t\t\t\tthis._buttons[y].style.marginBottom = ((channelHeight - 20) / 2) + \"px\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (this._renderedModChannels != this._doc.song.modChannelCount || this._renderedChannelCount != this._doc.song.getChannelCount()) {\r\n\t\t\tfor (let y: number = 0; y < this._doc.song.getChannelCount(); y++) {\r\n\t\t\t\tif (y < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount) {\r\n\t\t\t\t\tthis._buttons[y].children[0].classList.remove(\"modMute\");\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tthis._buttons[y].children[0].classList.add(\"modMute\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (this._renderedModChannels != this._doc.song.modChannelCount || this._renderedPitchChannels != this._doc.song.pitchChannelCount || this._renderedNoiseChannels != this._doc.song.noiseChannelCount) {\r\n\t\t\tfor (let y: number = 0; y < this._doc.song.getChannelCount(); y++) {\r\n\t\t\t\tif (y < this._doc.song.pitchChannelCount) {\r\n\t\t\t\t\tlet val: number = (y + 1);\r\n\t\t\t\t\tthis._channelCounts[y].textContent = val + \"\";\r\n\t\t\t\t\tthis._channelCounts[y].style.fontSize = (val >= 10) ? \"xx-small\" : \"inherit\";\r\n\t\t\t\t}\r\n\t\t\t\telse if (y < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount) {\r\n\t\t\t\t\tlet val: number = (y - this._doc.song.pitchChannelCount + 1);\r\n\t\t\t\t\tthis._channelCounts[y].textContent = val + \"\";\r\n\t\t\t\t\tthis._channelCounts[y].style.fontSize = (val >= 10) ? \"xx-small\" : \"inherit\";\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tlet val: number = (y - this._doc.song.pitchChannelCount - this._doc.song.noiseChannelCount + 1);\r\n\t\t\t\t\tthis._channelCounts[y].textContent = val + \"\";\r\n\t\t\t\t\tthis._channelCounts[y].style.fontSize = (val >= 10) ? \"xx-small\" : \"inherit\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis._renderedPitchChannels = this._doc.song.pitchChannelCount;\r\n\t\t\tthis._renderedNoiseChannels = this._doc.song.noiseChannelCount;\r\n\t\t\tthis._renderedModChannels = this._doc.song.modChannelCount;\r\n\t\t}\r\n\r\n\t\tif (this._renderedChannelHeight != channelHeight || this._renderedChannelCount != this._doc.song.getChannelCount()) {\r\n\t\t\tthis._renderedChannelHeight = channelHeight;\r\n\t\t\tthis._renderedChannelCount = this._doc.song.getChannelCount();\r\n\t\t\tthis._editorHeight = Config.barEditorHeight + this._doc.song.getChannelCount() * channelHeight;\r\n\t\t\tthis._channelNameDisplay.style.setProperty(\"display\", \"none\");\r\n\t\t\tthis.container.style.height = (this._editorHeight + 16) + \"px\";\r\n\r\n\t\t\tif (this._renderedChannelHeight < 27) {\r\n\t\t\t\tthis._channelNameDisplay.style.setProperty(\"margin-top\", \"-2px\");\r\n\t\t\t\tthis._channelDropDown.style.setProperty(\"margin-top\", \"-4px\");\r\n\t\t\t\tthis._channelNameInput.input.style.setProperty(\"margin-top\", \"-4px\");\r\n\r\n\t\t\t}\r\n\t\t\telse if (this._renderedChannelHeight < 30) {\r\n\t\t\t\tthis._channelNameDisplay.style.setProperty(\"margin-top\", \"-1px\");\r\n\t\t\t\tthis._channelDropDown.style.setProperty(\"margin-top\", \"-3px\");\r\n\t\t\t\tthis._channelNameInput.input.style.setProperty(\"margin-top\", \"-3px\");\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tthis._channelNameDisplay.style.setProperty(\"margin-top\", \"0px\");\r\n\t\t\t\tthis._channelDropDown.style.setProperty(\"margin-top\", \"0px\");\r\n\t\t\t\tthis._channelNameInput.input.style.setProperty(\"margin-top\", \"-2px\");\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n//}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { Config } from \"../synth/SynthConfig\";\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { HTML, SVG } from \"imperative-html/dist/esm/elements-strict\";\r\nimport { ChangeOctave } from \"./changes\";\r\nimport { ColorConfig } from \"./ColorConfig\";\r\nimport { Piano } from \"./Piano\";\r\n\r\nexport class OctaveScrollBar {\r\n\tprivate readonly _editorWidth: number = 20;\r\n\tprivate readonly _editorHeight: number = 481;\r\n\tprivate readonly _notchHeight: number = 4.0;\r\n\tprivate readonly _octaveCount: number = Config.pitchOctaves;\r\n\tprivate readonly _octaveHeight: number = (this._editorHeight - this._notchHeight) / this._octaveCount;\r\n\t\r\n\tprivate readonly _handle: SVGRectElement = SVG.rect({fill: ColorConfig.uiWidgetBackground, x: 2, y: 0, width: this._editorWidth - 4});\r\n\tprivate readonly _handleHighlight: SVGRectElement = SVG.rect({fill: \"none\", stroke: ColorConfig.hoverPreview, \"stroke-width\": 2, \"pointer-events\": \"none\", x: 1, y: 0, width: this._editorWidth - 2});\r\n\t\tprivate readonly _upHighlight: SVGPathElement = SVG.path({fill: ColorConfig.hoverPreview, \"pointer-events\": \"none\"});\r\n\t\tprivate readonly _downHighlight: SVGPathElement = SVG.path({fill: ColorConfig.hoverPreview, \"pointer-events\": \"none\"});\r\n\t\t\r\n\tprivate readonly _svg: SVGSVGElement = SVG.svg({ style: \"background-color: ${ColorConfig.editorBackground}; touch-action: pan-x; position: absolute;\", width: this._editorWidth, height: \"100%\", viewBox: \"0 0 20 \" + this._editorHeight, preserveAspectRatio: \"none\" });\r\n\t\tpublic readonly container: HTMLDivElement = HTML.div({id: \"octaveScrollBarContainer\", style: \"width: 20px; height: 100%; overflow: hidden; position: relative; flex-shrink: 0;\"}, this._svg);\r\n\t\t\r\n\t//private _mouseX: number = 0;\r\n\tprivate _mouseY: number = 0;\r\n\tprivate _mouseDown: boolean = false;\r\n\tprivate _mouseOver: boolean = false;\r\n\tprivate _dragging: boolean = false;\r\n\tprivate _dragStart: number;\r\n\tprivate _barBottom: number;\r\n\tprivate _barHeight: number;\r\n\tprivate _renderedBarBottom: number = -1;\r\n\tprivate _renderedVisibleOctaveCount: number = -1;\r\n\tprivate _change: ChangeOctave | null = null;\r\n\t\t\r\n\tconstructor(private _doc: SongDocument, private _piano: Piano) {\r\n\t\tthis._doc.notifier.watch(this._documentChanged);\r\n\t\tthis._documentChanged();\r\n\t\t\t\r\n\t\tthis._svg.appendChild(this._handle);\r\n\t\t\t\r\n\t\t// notches:\r\n\t\tfor (let i: number = 0; i <= this._octaveCount; i++) {\r\n\t\t\t\tthis._svg.appendChild(SVG.rect({fill: ColorConfig.tonic, x: 0, y: i * this._octaveHeight, width: this._editorWidth, height: this._notchHeight}));\r\n\t\t}\r\n\t\t\t\r\n\t\tthis._svg.appendChild(this._handleHighlight);\r\n\t\tthis._svg.appendChild(this._upHighlight);\r\n\t\tthis._svg.appendChild(this._downHighlight);\r\n\t\t\t\r\n\t\tconst center: number = this._editorWidth * 0.5;\r\n\t\tconst base: number = 20;\r\n\t\tconst tip: number = 9;\r\n\t\tconst arrowWidth: number = 6;\r\n\t\tthis._upHighlight.setAttribute(\"d\", `M ${center} ${tip} L ${center + arrowWidth} ${base} L ${center - arrowWidth} ${base} z`);\r\n\t\tthis._downHighlight.setAttribute(\"d\", `M ${center} ${this._editorHeight - tip} L ${center + arrowWidth} ${this._editorHeight - base} L ${center - arrowWidth} ${this._editorHeight - base} z`);\r\n\t\t\t\r\n\t\tthis.container.addEventListener(\"mousedown\", this._whenMousePressed);\r\n\t\tdocument.addEventListener(\"mousemove\", this._whenMouseMoved);\r\n\t\tdocument.addEventListener(\"mouseup\", this._whenCursorReleased);\r\n\t\tthis.container.addEventListener(\"mouseover\", this._whenMouseOver);\r\n\t\tthis.container.addEventListener(\"mouseout\", this._whenMouseOut);\r\n\t\t\t\r\n\t\tthis.container.addEventListener(\"touchstart\", this._whenTouchPressed);\r\n\t\tthis.container.addEventListener(\"touchmove\", this._whenTouchMoved);\r\n\t\tthis.container.addEventListener(\"touchend\", this._whenCursorReleased);\r\n\t\tthis.container.addEventListener(\"touchcancel\", this._whenCursorReleased);\r\n\t}\r\n\t\t\r\n\tprivate _whenMouseOver = (event: MouseEvent): void => {\r\n\t\tif (this._mouseOver) return;\r\n\t\tthis._mouseOver = true;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\t\r\n\tprivate _whenMouseOut = (event: MouseEvent): void => {\r\n\t\tif (!this._mouseOver) return;\r\n\t\tthis._mouseOver = false;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\t\r\n\tprivate _whenMousePressed = (event: MouseEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\t//this._mouseX = (event.clientX || event.pageX) - boundingRect.left;\r\n\t\tthis._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tif (this._doc.song.getChannelIsNoise(this._doc.channel) || this._doc.song.getChannelIsMod(this._doc.channel)) return;\r\n\t\tthis._updatePreview();\r\n\t\t\t\r\n\t\tif (this._mouseY >= this._barBottom - this._barHeight && this._mouseY <= this._barBottom) {\r\n\t\t\tthis._dragging = true;\r\n\t\t\tthis._change = null;\r\n\t\t\tthis._dragStart = this._mouseY;\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tprivate _whenTouchPressed = (event: TouchEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\t//this._mouseX = event.touches[0].clientX - boundingRect.left;\r\n\t\tthis._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tif (this._doc.song.getChannelIsNoise(this._doc.channel) || this._doc.song.getChannelIsMod(this._doc.channel)) return;\r\n\t\tthis._updatePreview();\r\n\t\t\t\r\n\t\tif (this._mouseY >= this._barBottom - this._barHeight && this._mouseY <= this._barBottom) {\r\n\t\t\tthis._dragging = true;\r\n\t\t\tthis._change = null;\r\n\t\t\tthis._dragStart = this._mouseY;\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tprivate _whenMouseMoved = (event: MouseEvent): void => {\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\t//this._mouseX = (event.clientX || event.pageX) - boundingRect.left;\r\n\t\tthis._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\t\r\n\tprivate _whenTouchMoved = (event: TouchEvent): void => {\r\n\t\tif (!this._mouseDown) return;\r\n\t\tevent.preventDefault();\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\t//this._mouseX = event.touches[0].clientX - boundingRect.left;\r\n\t\tthis._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\t\r\n\tprivate _whenCursorMoved(): void {\r\n\t\tif (this._doc.song.getChannelIsNoise(this._doc.channel) || this._doc.song.getChannelIsMod(this._doc.channel)) return;\r\n\t\tif (this._dragging) {\r\n\t\t\tconst visibleOctaveCount: number = this._doc.getVisibleOctaveCount();\r\n\t\t\tconst scrollableOctaves: number = Config.pitchOctaves - visibleOctaveCount;\r\n\t\t\tconst continuingProspectiveChange: boolean = this._doc.lastChangeWas(this._change);\r\n\t\t\tconst oldValue: number = continuingProspectiveChange ? this._change!.oldValue : this._doc.song.channels[this._doc.channel].octave;\r\n\t\t\t\r\n\t\t\tconst currentOctave: number = this._doc.getBaseVisibleOctave(this._doc.channel);\r\n\t\t\tlet octave: number = currentOctave;\r\n\t\t\twhile (this._mouseY - this._dragStart < -this._octaveHeight * 0.5) {\r\n\t\t\t\t\tif (octave < scrollableOctaves) {\r\n\t\t\t\t\toctave++;\r\n\t\t\t\t\tthis._dragStart -= this._octaveHeight;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\twhile (this._mouseY - this._dragStart > this._octaveHeight * 0.5) {\r\n\t\t\t\tif (octave > 0) {\r\n\t\t\t\t\toctave--;\r\n\t\t\t\t\tthis._dragStart += this._octaveHeight;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\t\r\n\t\t\tthis._change = new ChangeOctave(this._doc, oldValue, Math.floor(octave + visibleOctaveCount * 0.5));\r\n\t\t\tthis._doc.setProspectiveChange(this._change);\r\n\t\t}\r\n\t\t\t\r\n\t\tif (this._mouseOver) this._updatePreview();\r\n\t}\r\n\t\t\r\n\tprivate _whenCursorReleased = (event: Event): void => {\r\n\t\tif (!this._doc.song.getChannelIsNoise(this._doc.channel) && !this._doc.song.getChannelIsMod(this._doc.channel) && this._mouseDown) {\r\n\t\t\tif (this._dragging) {\r\n\t\t\t\tif (this._change != null) this._doc.record(this._change);\r\n\t\t\t} else {\r\n\t\t\t\tconst visibleOctaveCount: number = this._doc.getVisibleOctaveCount();\r\n\t\t\t\tconst scrollableOctaves: number = Config.pitchOctaves - visibleOctaveCount;\r\n\t\t\t\tconst canReplaceLastChange: boolean = this._doc.lastChangeWas(this._change);\r\n\t\t\t\tconst oldValue: number = canReplaceLastChange ? this._change!.oldValue : this._doc.song.channels[this._doc.channel].octave;\r\n\t\t\t\r\n\t\t\t\tconst currentOctave: number = this._doc.getBaseVisibleOctave(this._doc.channel);\r\n\t\t\t\tif (this._mouseY < this._barBottom - this._barHeight * 0.5) {\r\n\t\t\t\t\tif (currentOctave < scrollableOctaves) {\r\n\t\t\t\t\t\tthis._change = new ChangeOctave(this._doc, oldValue, Math.floor(currentOctave + 1 + visibleOctaveCount * 0.5));\r\n\t\t\t\t\t\tthis._doc.record(this._change, canReplaceLastChange);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (currentOctave > 0) {\r\n\t\t\t\t\t\tthis._change = new ChangeOctave(this._doc, oldValue, Math.floor(currentOctave - 1 + visibleOctaveCount * 0.5));\r\n\t\t\t\t\t\tthis._doc.record(this._change, canReplaceLastChange);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis._mouseDown = false;\r\n\t\tthis._dragging = false;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\t\r\n\tprivate _updatePreview(): void {\r\n\t\tconst showHighlight: boolean = this._mouseOver && !this._mouseDown;\r\n\t\tlet showUpHighlight: boolean = false;\r\n\t\tlet showDownHighlight: boolean = false;\r\n\t\tlet showHandleHighlight: boolean = false;\r\n\t\t\t\r\n\t\tif (showHighlight) {\r\n\t\t\tif (this._mouseY < this._barBottom - this._barHeight) {\r\n\t\t\t\tshowUpHighlight = true;\r\n\t\t\t} else if (this._mouseY > this._barBottom) {\r\n\t\t\t\tshowDownHighlight = true;\r\n\t\t\t} else {\r\n\t\t\t\tshowHandleHighlight = true;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\t\r\n\t\tthis._upHighlight.style.visibility = showUpHighlight ? \"inherit\" : \"hidden\";\r\n\t\tthis._downHighlight.style.visibility = showDownHighlight ? \"inherit\" : \"hidden\";\r\n\t\tthis._handleHighlight.style.visibility = showHandleHighlight ? \"inherit\" : \"hidden\";\r\n\t}\r\n\t\t\r\n\tprivate _documentChanged = (): void => {\r\n\t\tthis._barBottom = this._editorHeight - (this._octaveHeight * this._doc.getBaseVisibleOctave(this._doc.channel));\r\n\t\tthis._svg.style.visibility = (this._doc.song.getChannelIsNoise(this._doc.channel) || this._doc.song.getChannelIsMod(this._doc.channel)) ? \"hidden\" : \"visible\";\r\n\t\tconst visibleOctaveCount: number = this._doc.getVisibleOctaveCount();\r\n\t\tif (this._renderedBarBottom != this._barBottom || this._renderedVisibleOctaveCount != visibleOctaveCount) {\r\n\t\t\tthis._renderedBarBottom = this._barBottom;\r\n\t\t\tthis._renderedVisibleOctaveCount = visibleOctaveCount;\r\n\t\t\tthis._barHeight = (this._octaveHeight * visibleOctaveCount + this._notchHeight);\r\n\t\t\tthis._handle.setAttribute(\"height\", String(this._barHeight));\r\n\t\t\tthis._handleHighlight.setAttribute(\"height\", String(this._barHeight));\r\n\t\t\tthis._handle.setAttribute(\"y\", String(this._barBottom - this._barHeight));\r\n\t\t\tthis._handleHighlight.setAttribute(\"y\", String(this._barBottom - this._barHeight));\r\n\r\n\t\t\tthis._piano.forceRender();\r\n\t\t}\r\n\t\tthis._updatePreview();\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Config} from \"../synth/SynthConfig\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {AnalogousDrum, analogousDrumMap, MidiEventType} from \"./Midi\";\r\n\r\ndeclare global {\r\n\tinterface Navigator {\r\n\t\trequestMIDIAccess?(): Promise<any>;\r\n\t}\r\n}\r\n\r\ninterface MIDIInput extends EventTarget {\r\n\tid: string;\r\n\ttype: \"input\" | \"output\";\r\n\tstate: \"disconnected\" | \"connected\";\r\n}\r\n\r\ninterface MIDIConnectionEvent {\r\n\tport: MIDIInput;\r\n}\r\n\r\ninterface MIDIMessageEvent {\r\n\tdata: [type: number, key: number, velocity: number];\r\n\ttarget: MIDIInput;\r\n}\r\n\r\n// A unique id for this tab.\r\nconst id: string = ((Math.random() * 0xffffffff) >>> 0).toString(16);\r\n\r\nexport class MidiInputHandler {\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis.registerMidiAccessHandler();\r\n\t}\r\n\t\r\n\tprivate async registerMidiAccessHandler() {\r\n\t\tif (navigator.requestMIDIAccess == null) return;\r\n\t\t\r\n\t\ttry {\r\n\t\t\tconst midiAccess = await navigator.requestMIDIAccess();\r\n\t\t\t\r\n\t\t\tmidiAccess.inputs.forEach(this._registerMidiInput);\r\n\t\t\tmidiAccess.addEventListener(\"statechange\", this._handleStateChange);\r\n\t\t\t\r\n\t\t\tthis._takeMidiHandlerFocus();\r\n\t\t\twindow.addEventListener(\"focus\", this._takeMidiHandlerFocus);\r\n\t\t} catch (e) {\r\n\t\t\tconsole.error(\"Failed to get MIDI access\", e);\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _takeMidiHandlerFocus = (event?: Event) => {\r\n\t\t// Record that this browser tab is the one that should handle midi\r\n\t\t// events and any other open tabs should ignore midi events for now.\r\n\t\tlocalStorage.setItem(\"midiHandlerId\", id);\r\n\t}\r\n\t\r\n\tprivate _handleStateChange = (event: MIDIConnectionEvent) => {\r\n\t\tif (event.port.type !== \"input\") return;\r\n\t\t\r\n\t\tswitch (event.port.state) {\r\n\t\t\tcase \"connected\":\r\n\t\t\t\tthis._registerMidiInput(event.port);\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"disconnected\":\r\n\t\t\t\tthis._unregisterMidiInput(event.port);\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _registerMidiInput = (midiInput: MIDIInput) => {\r\n\t\tmidiInput.addEventListener(\"midimessage\", this._onMidiMessage as any);\r\n\t}\r\n\t\r\n\tprivate _unregisterMidiInput = (midiInput: MIDIInput) => {\r\n\t\tmidiInput.removeEventListener(\"midimessage\", this._onMidiMessage as any);\r\n\t\tthis._doc.performance.clearAllPitches();\r\n\t}\r\n\t\r\n\tprivate _onMidiMessage = (event: MIDIMessageEvent) => {\r\n\t\t// Ignore midi events if disabled or a different tab is handling them.\r\n\t\tif (!this._doc.prefs.enableMidi || localStorage.getItem(\"midiHandlerId\") != id) return;\r\n\t\t\r\n\t\tconst isDrum: boolean = this._doc.song.getChannelIsNoise(this._doc.channel);\r\n\t\tlet [eventType, key, velocity] = event.data;\r\n\t\teventType &= 0xF0;\r\n\t\t\r\n\t\tif (isDrum) {\r\n\t\t\tconst drum: AnalogousDrum | undefined = analogousDrumMap[key];\r\n\t\t\tif (drum != undefined) {\r\n\t\t\t\tkey = drum.frequency;\r\n\t\t\t} else {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tkey -= Config.keys[this._doc.song.key].basePitch; // The basePitch of the song key is implicit so don't include it.\r\n\t\t\tif (key < 0 || key > Config.maxPitch) return;\r\n\t\t}\r\n\t\t\r\n\t\tif (eventType == MidiEventType.noteOn && velocity == 0) {\r\n\t\t\teventType = MidiEventType.noteOff;\r\n\t\t}\r\n\t\t\r\n\t\tswitch (eventType) {\r\n\t\t\tcase MidiEventType.noteOn:\r\n\t\t\t\tthis._doc.synth.preferLowerLatency = true;\r\n\t\t\t\tthis._doc.performance.addPerformedPitch(key);\r\n\t\t\t\tbreak;\r\n\t\t\tcase MidiEventType.noteOff:\r\n\t\t\t\tthis._doc.performance.removePerformedPitch(key);\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Config} from \"../synth/SynthConfig\";\r\nimport {SongDocument} from \"./SongDocument\";\r\n\r\nexport class KeyboardLayout {\r\n\tprivate static _pianoAtC: ReadonlyArray<ReadonlyArray<number | null>> = [\r\n\t\t[   0,   2,   4,   5,   7,   9,  11,  12,  14,  16,  17],\r\n\t\t[null,   1,   3,null,   6,   8,  10,null,  13,  15,null,  18],\r\n\t\t[  12,  14,  16,  17,  19,  21,  23,  24,  26,  28,  29,  31,  33],\r\n\t\t[null,  13,  15,null,  18,  20,  22,null,  25,  27,null,  30,  32],\r\n\t];\r\n\tprivate static _pianoAtA: ReadonlyArray<ReadonlyArray<number | null>> = [\r\n\t\t[   0,   2,   3,   5,   7,   8,  10,  12,  14,  15,  17],\r\n\t\t[  -1,   1,null,   4,   6,null,   9,  11,  13,null,  16,  18],\r\n\t\t[  12,  14,  15,  17,  19,  20,  22,  24,  26,  27,  29,  31,  32],\r\n\t\t[  11,  13,null,  16,  18,null,  21,  23,  25,null,  28,  30,null],\r\n\t];\r\n\t\r\n\tpublic static keyPosToPitch(doc: SongDocument, x: number, y: number, keyboardLayout: string): number | null {\r\n\t\tlet pitchOffset: number | null = null;\r\n\t\tlet forcedKey: number | null = null;\r\n\t\tswitch (keyboardLayout) {\r\n\t\t\tcase \"wickiHayden\":\r\n\t\t\t\tpitchOffset = y * 5 + x * 2 - 2;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"songScale\":\r\n\t\t\t\tconst scaleFlags: ReadonlyArray<boolean> = Config.scales[doc.song.scale].flags;\r\n\t\t\t\tconst scaleIndices: number[] = <number[]> scaleFlags.map((flag, index) => flag ? index : null).filter((index) => index != null);\r\n\t\t\t\tpitchOffset = (y - 1 + Math.floor(x / scaleIndices.length)) * Config.pitchesPerOctave + scaleIndices[(x + scaleIndices.length) % scaleIndices.length];\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"pianoAtC\":\r\n\t\t\t\tpitchOffset = KeyboardLayout._pianoAtC[y][x];\r\n\t\t\t\tforcedKey = Config.keys.dictionary[\"C\"].basePitch;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"pianoAtA\":\r\n\t\t\t\tpitchOffset = KeyboardLayout._pianoAtA[y][x];\r\n\t\t\t\tforcedKey = Config.keys.dictionary[\"A\"].basePitch;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"pianoTransposingC\":\r\n\t\t\t\tpitchOffset = KeyboardLayout._pianoAtC[y][x];\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"pianoTransposingA\":\r\n\t\t\t\tpitchOffset = KeyboardLayout._pianoAtA[y][x];\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\t\r\n\t\tif (pitchOffset == null) return null;\r\n\t\t\r\n\t\tconst octaveOffset: number = Math.max(0, doc.song.channels[doc.channel].octave - 1) * Config.pitchesPerOctave;\r\n\t\tlet keyOffset: number = 0; // The basePitch of the song key is implicit.\r\n\t\t\r\n\t\tif (forcedKey != null) {\r\n\t\t\tconst keyBasePitch: number = Config.keys[doc.song.key].basePitch;\r\n\t\t\tkeyOffset = (forcedKey - keyBasePitch + 144) % 12;\r\n\t\t}\r\n\t\t\r\n\t\tconst pitch = octaveOffset + keyOffset + pitchOffset;\r\n\t\tif (pitch < 0 || pitch > Config.maxPitch) return null;\r\n\t\t\t\r\n\t\treturn pitch;\r\n\t}\r\n\t\r\n\tprivate _possiblyPlayingPitchesFromKeyboard: boolean = false;\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\twindow.addEventListener(\"blur\", this._onWindowBlur);\r\n\t}\r\n\t\r\n\tprivate _onWindowBlur = (event: Event) => {\r\n\t\t// Browsers don't explicitly release keys when the page isn't in focus so let's just assume they're all released.\r\n\t\tif (this._possiblyPlayingPitchesFromKeyboard) {\r\n\t\t\tthis._doc.performance.clearAllPitches();\r\n\t\t\tthis._possiblyPlayingPitchesFromKeyboard = false;\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic handleKeyEvent(event: KeyboardEvent, pressed: boolean): void {\r\n\t\t// See: https://www.w3.org/TR/uievents-code/#key-alphanumeric-writing-system\r\n\t\tswitch (event.code) {\r\n\t\t\tcase \"Backquote\": this.handleKey(-1, 3, pressed); break;\r\n\t\t\tcase \"Digit1\": this.handleKey(0, 3, pressed); break;\r\n\t\t\tcase \"Digit2\": this.handleKey(1, 3, pressed); break;\r\n\t\t\tcase \"Digit3\": this.handleKey(2, 3, pressed); break;\r\n\t\t\tcase \"Digit4\": this.handleKey(3, 3, pressed); break;\r\n\t\t\tcase \"Digit5\": this.handleKey(4, 3, pressed); break;\r\n\t\t\tcase \"Digit6\": this.handleKey(5, 3, pressed); break;\r\n\t\t\tcase \"Digit7\": this.handleKey(6, 3, pressed); break;\r\n\t\t\tcase \"Digit8\": this.handleKey(7, 3, pressed); break;\r\n\t\t\tcase \"Digit9\": this.handleKey(8, 3, pressed); break;\r\n\t\t\tcase \"Digit0\": this.handleKey(9, 3, pressed); break;\r\n\t\t\tcase \"Minus\": this.handleKey(10, 3, pressed); break;\r\n\t\t\tcase \"Equal\": this.handleKey(11, 3, pressed); break;\r\n\t\t\tcase \"IntlYen\": this.handleKey(12, 3, pressed); break; // Present on Russian and Japanese keyboards.\r\n\t\t\t\r\n\t\t\tcase \"KeyQ\": this.handleKey(0, 2, pressed); break;\r\n\t\t\tcase \"KeyW\": this.handleKey(1, 2, pressed); break;\r\n\t\t\tcase \"KeyE\": this.handleKey(2, 2, pressed); break;\r\n\t\t\tcase \"KeyR\": this.handleKey(3, 2, pressed); break;\r\n\t\t\tcase \"KeyT\": this.handleKey(4, 2, pressed); break;\r\n\t\t\tcase \"KeyY\": this.handleKey(5, 2, pressed); break;\r\n\t\t\tcase \"KeyU\": this.handleKey(6, 2, pressed); break;\r\n\t\t\tcase \"KeyI\": this.handleKey(7, 2, pressed); break;\r\n\t\t\tcase \"KeyO\": this.handleKey(8, 2, pressed); break;\r\n\t\t\tcase \"KeyP\": this.handleKey(9, 2, pressed); break;\r\n\t\t\tcase \"BracketLeft\": this.handleKey(10, 2, pressed); break;\r\n\t\t\tcase \"BracketRight\": this.handleKey(11, 2, pressed); break;\r\n\t\t\tcase \"Backslash\":\r\n\t\t\t\t// Present on US keyboards... but on non-US keyboards it's also used at a different location, see \"IntlHash\" below. :/\r\n\t\t\t\tif (event.key == \"\\\\\" || event.key == \"|\") {\r\n\t\t\t\t\tthis.handleKey(12, 2, pressed);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.handleKey(11, 1, pressed);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\t\r\n\t\t\tcase \"KeyA\": this.handleKey(0, 1, pressed); break;\r\n\t\t\tcase \"KeyS\": this.handleKey(1, 1, pressed); break;\r\n\t\t\tcase \"KeyD\": this.handleKey(2, 1, pressed); break;\r\n\t\t\tcase \"KeyF\": this.handleKey(3, 1, pressed); break;\r\n\t\t\tcase \"KeyG\": this.handleKey(4, 1, pressed); break;\r\n\t\t\tcase \"KeyH\": this.handleKey(5, 1, pressed); break;\r\n\t\t\tcase \"KeyJ\": this.handleKey(6, 1, pressed); break;\r\n\t\t\tcase \"KeyK\": this.handleKey(7, 1, pressed); break;\r\n\t\t\tcase \"KeyL\": this.handleKey(8, 1, pressed); break;\r\n\t\t\tcase \"Semicolon\": this.handleKey(9, 1, pressed); break;\r\n\t\t\tcase \"Quote\": this.handleKey(10, 1, pressed); break;\r\n\t\t\tcase \"IntlHash\": this.handleKey(11, 1, pressed); break; // Present on non-US keyboards... but in practice it is actually represented as \"Backslash\" so this is obsolete. Oh well. :/\r\n\t\t\t\r\n\t\t\tcase \"IntlBackslash\": this.handleKey(-1, 0, pressed); break; // Present on Brazillian and many European keyboards.\r\n\t\t\tcase \"KeyZ\": this.handleKey(0, 0, pressed); break;\r\n\t\t\tcase \"KeyX\": this.handleKey(1, 0, pressed); break;\r\n\t\t\tcase \"KeyC\": this.handleKey(2, 0, pressed); break;\r\n\t\t\tcase \"KeyV\": this.handleKey(3, 0, pressed); break;\r\n\t\t\tcase \"KeyB\": this.handleKey(4, 0, pressed); break;\r\n\t\t\tcase \"KeyN\": this.handleKey(5, 0, pressed); break;\r\n\t\t\tcase \"KeyM\": this.handleKey(6, 0, pressed); break;\r\n\t\t\tcase \"Comma\": this.handleKey(7, 0, pressed); break;\r\n\t\t\tcase \"Period\": this.handleKey(8, 0, pressed); break;\r\n\t\t\tcase \"Slash\": this.handleKey(9, 0, pressed); break;\r\n\t\t\tcase \"IntlRo\": this.handleKey(10, 0, pressed); break; // Present on Brazillian and Japanese keyboards.\r\n\t\t\t\r\n\t\t\tdefault: return; //unhandled, don't prevent default.\r\n\t\t}\r\n\t\t\r\n\t\t// If the key event was handled as a note, prevent default behavior.\r\n\t\tevent.preventDefault();\r\n\t}\r\n\t\r\n\tpublic handleKey(x: number, y: number, pressed: boolean): void {\r\n\t\t\r\n\t\tconst isDrum: boolean = this._doc.song.getChannelIsNoise(this._doc.channel);\r\n\t\tif (isDrum) {\r\n\t\t\tif (x >= 0 && x < Config.drumCount) {\r\n\t\t\t\tif (pressed) {\r\n\t\t\t\t\tthis._doc.synth.preferLowerLatency = true;\r\n\t\t\t\t\tthis._doc.performance.addPerformedPitch(x);\r\n\t\t\t\t\tthis._possiblyPlayingPitchesFromKeyboard = true;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis._doc.performance.removePerformedPitch(x);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\tconst pitch: number | null = KeyboardLayout.keyPosToPitch(this._doc, x, y, this._doc.prefs.keyboardLayout);\r\n\t\t\r\n\t\tif (pitch != null) {\r\n\t\t\tif (pressed) {\r\n\t\t\t\tthis._doc.synth.preferLowerLatency = true;\r\n\t\t\t\tthis._doc.performance.addPerformedPitch(pitch);\r\n\t\t\t\tthis._possiblyPlayingPitchesFromKeyboard = true;\r\n\t\t\t} else {\r\n\t\t\t\tthis._doc.performance.removePerformedPitch(pitch);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { Chord, Transition, Config } from \"../synth/SynthConfig\";\r\nimport { NotePin, Note, makeNotePin, Pattern, Instrument } from \"../synth/synth\";\r\nimport { ColorConfig } from \"./ColorConfig\";\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { HTML, SVG } from \"imperative-html/dist/esm/elements-strict\";\r\nimport { ChangeSequence, UndoableChange } from \"./Change\";\r\nimport { ChangeChannelBar, ChangeDragSelectedNotes, ChangeEnsurePatternExists, ChangeNoteTruncate, ChangeNoteAdded, ChangePatternSelection, ChangePinTime, ChangeSizeBend, ChangePitchBend, ChangePitchAdded } from \"./changes\";\r\nimport { prettyNumber } from \"./EditorConfig\";\r\n\r\nfunction makeEmptyReplacementElement<T extends Node>(node: T): T {\r\n    const clone: T = <T>node.cloneNode(false);\r\n    node.parentNode!.replaceChild(clone, node);\r\n    return clone;\r\n}\r\n\r\nclass PatternCursor {\r\n    public valid: boolean = false;\r\n    public prevNote: Note | null = null;\r\n    public curNote: Note | null = null;\r\n    public nextNote: Note | null = null;\r\n    public pitch: number = 0;\r\n    public pitchIndex: number = -1;\r\n    public curIndex: number = 0;\r\n    public start: number = 0;\r\n    public end: number = 0;\r\n    public part: number = 0;\r\n    public exactPart: number = 0;\r\n    public nearPinIndex: number = 0;\r\n    public pins: NotePin[] = [];\r\n}\r\n\r\nexport class PatternEditor {\r\n    public controlMode: boolean = false;\r\n    public shiftMode: boolean = false;\r\n    private readonly _svgNoteBackground: SVGPatternElement = SVG.pattern({ id: \"patternEditorNoteBackground\" + this._barOffset, x: \"0\", y: \"0\", patternUnits: \"userSpaceOnUse\" });\r\n    private readonly _svgDrumBackground: SVGPatternElement = SVG.pattern({ id: \"patternEditorDrumBackground\" + this._barOffset, x: \"0\", y: \"0\", patternUnits: \"userSpaceOnUse\" });\r\n    private readonly _svgModBackground: SVGPatternElement = SVG.pattern({ id: \"patternEditorModBackground\" + this._barOffset, x: \"0\", y: \"0\", patternUnits: \"userSpaceOnUse\" });\r\n    private readonly _svgBackground: SVGRectElement = SVG.rect({ x: \"0\", y: \"0\", \"pointer-events\": \"none\", fill: \"url(#patternEditorNoteBackground\" + this._barOffset + \")\" });\r\n    private _svgNoteContainer: SVGSVGElement = SVG.svg();\r\n    private readonly _svgPlayhead: SVGRectElement = SVG.rect({ x: \"0\", y: \"0\", width: \"4\", fill: ColorConfig.playhead, \"pointer-events\": \"none\" });\r\n    private readonly _selectionRect: SVGRectElement = SVG.rect({ class: \"dashed-line dash-move\", fill: ColorConfig.boxSelectionFill, stroke: ColorConfig.hoverPreview, \"stroke-width\": 2, \"stroke-dasharray\": \"5, 3\", \"fill-opacity\": \"0.4\", \"pointer-events\": \"none\", visibility: \"hidden\" });\r\n    private readonly _svgPreview: SVGPathElement = SVG.path({ fill: \"none\", stroke: ColorConfig.hoverPreview, \"stroke-width\": \"2\", \"pointer-events\": \"none\" });\r\n    public modDragValueLabel: HTMLDivElement = HTML.div({ width: \"90\", \"text-anchor\": \"start\", contenteditable: \"true\", style: \"display: flex, justify-content: center; align-items:center; position:absolute; pointer-events: none;\", \"dominant-baseline\": \"central\", });\r\n    private readonly _svg: SVGSVGElement = SVG.svg({ style: `background-color: ${ColorConfig.editorBackground}; touch-action: none; position: absolute;`, width: \"100%\", height: \"100%\" },\r\n        SVG.defs(\r\n            this._svgNoteBackground,\r\n            this._svgDrumBackground,\r\n            this._svgModBackground,\r\n        ),\r\n        this._svgBackground,\r\n        this._selectionRect,\r\n        this._svgNoteContainer,\r\n        this._svgPreview,\r\n        this._svgPlayhead,\r\n    );\r\n    public readonly container: HTMLDivElement = HTML.div({ style: \"height: 100%; overflow:hidden; position: relative; flex-grow: 1;\" }, this._svg, this.modDragValueLabel);\r\n\r\n    private readonly _defaultModBorder: number = 34;\r\n    private readonly _backgroundPitchRows: SVGRectElement[] = [];\r\n    private readonly _backgroundDrumRow: SVGRectElement = SVG.rect();\r\n    private readonly _backgroundModRow: SVGRectElement = SVG.rect();\r\n\r\n    private _editorWidth: number;\r\n\r\n    private _modDragValueLabelLeft: number = 0;\r\n    private _modDragValueLabelTop: number = 0;\r\n    private _modDragValueLabelWidth: number = 0;\r\n    public editingModLabel: boolean = false;\r\n    private _modDragStartValue: number = 0;\r\n    private _modDragPin: NotePin;\r\n    private _modDragNote: Note;\r\n    private _modDragSetting: number;\r\n    private _modDragLowerBound: number = 0;\r\n    private _modDragUpperBound: number = 6;\r\n\r\n    private _editorHeight: number;\r\n    private _partWidth: number;\r\n    private _pitchHeight: number = -1;\r\n    private _pitchBorder: number;\r\n    private _pitchCount: number;\r\n    private _mouseX: number = 0;\r\n    private _mouseY: number = 0;\r\n    private _mouseDown: boolean = false;\r\n    private _mouseOver: boolean = false;\r\n    private _mouseDragging: boolean = false;\r\n    private _mouseHorizontal: boolean = false;\r\n    private _usingTouch: boolean = false;\r\n    private _copiedPinChannels: NotePin[][] = [];\r\n    private _copiedPins: NotePin[];\r\n    private _mouseXStart: number = 0;\r\n    private _mouseYStart: number = 0;\r\n    private _touchTime: number = 0;\r\n    private _shiftHeld: boolean = false;\r\n    private _dragConfirmed: boolean = false;\r\n    private _draggingStartOfSelection: boolean = false;\r\n    private _draggingEndOfSelection: boolean = false;\r\n    private _draggingSelectionContents: boolean = false;\r\n    private _dragTime: number = 0;\r\n    private _dragPitch: number = 0;\r\n    private _dragSize: number = 0;\r\n    private _dragVisible: boolean = false;\r\n    private _dragChange: UndoableChange | null = null;\r\n    private _changePatternSelection: UndoableChange | null = null;\r\n    private _lastChangeWasPatternSelection: boolean = false;\r\n    private _cursor: PatternCursor = new PatternCursor();\r\n    private _stashCursorPinVols: number[][] = [];\r\n    private _pattern: Pattern | null = null;\r\n    private _playheadX: number = 0.0;\r\n    private _octaveOffset: number = 0;\r\n    private _renderedWidth: number = -1;\r\n    private _renderedHeight: number = -1;\r\n    private _renderedBeatWidth: number = -1;\r\n    private _renderedPitchHeight: number = -1;\r\n    private _renderedFifths: boolean = false;\r\n    private _renderedDrums: boolean = false;\r\n    private _renderedMod: boolean = false;\r\n    private _renderedRhythm: number = -1;\r\n    private _renderedPitchChannelCount: number = -1;\r\n    private _renderedNoiseChannelCount: number = -1;\r\n    private _renderedModChannelCount: number = -1;\r\n    private _followPlayheadBar: number = -1;\r\n\r\n    constructor(private _doc: SongDocument, private _interactive: boolean, private _barOffset: number) {\r\n        for (let i: number = 0; i < Config.pitchesPerOctave; i++) {\r\n            const rectangle: SVGRectElement = SVG.rect();\r\n            rectangle.setAttribute(\"x\", \"1\");\r\n            rectangle.setAttribute(\"fill\", (i == 0) ? ColorConfig.tonic : ColorConfig.pitchBackground);\r\n            this._svgNoteBackground.appendChild(rectangle);\r\n            this._backgroundPitchRows[i] = rectangle;\r\n        }\r\n\r\n        this._backgroundDrumRow.setAttribute(\"x\", \"1\");\r\n        this._backgroundDrumRow.setAttribute(\"y\", \"1\");\r\n        this._backgroundDrumRow.setAttribute(\"fill\", ColorConfig.pitchBackground);\r\n        this._svgDrumBackground.appendChild(this._backgroundDrumRow);\r\n        this._backgroundModRow.setAttribute(\"fill\", ColorConfig.pitchBackground);\r\n        this._svgModBackground.appendChild(this._backgroundModRow);\r\n\r\n        if (this._interactive) {\r\n            this._updateCursorStatus();\r\n            this._updatePreview();\r\n            window.requestAnimationFrame(this._animatePlayhead);\r\n            this._svg.addEventListener(\"mousedown\", this._whenMousePressed);\r\n            document.addEventListener(\"mousemove\", this._whenMouseMoved);\r\n            document.addEventListener(\"mouseup\", this._whenCursorReleased);\r\n            this._svg.addEventListener(\"mouseover\", this._whenMouseOver);\r\n            this._svg.addEventListener(\"mouseout\", this._whenMouseOut);\r\n\r\n            this._svg.addEventListener(\"touchstart\", this._whenTouchPressed);\r\n            this._svg.addEventListener(\"touchmove\", this._whenTouchMoved);\r\n            this._svg.addEventListener(\"touchend\", this._whenCursorReleased);\r\n            this._svg.addEventListener(\"touchcancel\", this._whenCursorReleased);\r\n\r\n            this.modDragValueLabel.addEventListener(\"input\", this._validateModDragLabelInput);\r\n        } else {\r\n            this._svgPlayhead.style.display = \"none\";\r\n            this._svg.appendChild(SVG.rect({ x: 0, y: 0, width: 10000, height: 10000, fill: ColorConfig.editorBackground, style: \"opacity: 0.5;\" }));\r\n        }\r\n\r\n        this.resetCopiedPins();\r\n    }\r\n\r\n    private _validateModDragLabelInput = (event: Event): void => {\r\n        const label: HTMLDivElement = <HTMLDivElement>event.target;\r\n\r\n        // Special case - when user is typing a number between zero and min, allow it (the alternative is quite annoying, when min is nonzero)\r\n        let converted: number = Number(label.innerText);\r\n        if (!isNaN(converted) && converted >= 0 && converted < this._modDragLowerBound)\r\n            return;\r\n\r\n        // Another special case - allow \"\" e.g. the empty string and a single negative sign, but don't do anything about it.\r\n        if (label.innerText != \"\" && label.innerText != \"-\") {\r\n            // Force NaN results to be 0\r\n            if (isNaN(converted)) {\r\n                converted = this._modDragLowerBound;\r\n                label.innerText = \"\" + this._modDragLowerBound;\r\n            }\r\n\r\n            let presValue: number = Math.floor(Math.max(Number(this._modDragLowerBound), Math.min(Number(this._modDragUpperBound), converted)));\r\n            if (label.innerText != presValue + \"\")\r\n                label.innerText = presValue + \"\";\r\n\r\n            // This is me being too lazy to fiddle with the css to get it to align center.\r\n            let xOffset: number = (+(presValue >= 10.0)) + (+(presValue >= 100.0)) + (+(presValue < 0.0)) + (+(presValue <= -10.0));\r\n            this._modDragValueLabelLeft = +prettyNumber(Math.max(Math.min(this._editorWidth - 10 - xOffset * 8, this._partWidth * (this._modDragNote.start + this._modDragPin.time) - 4 - xOffset * 4), 2));\r\n            this.modDragValueLabel.style.setProperty(\"left\", \"\" + this._modDragValueLabelLeft + \"px\");\r\n\r\n            const sequence: ChangeSequence = new ChangeSequence();\r\n            this._dragChange = sequence;\r\n            this._doc.setProspectiveChange(this._dragChange);\r\n\r\n            sequence.append(new ChangeSizeBend(this._doc, this._modDragNote, this._modDragPin.time, presValue- Config.modulators[this._modDragSetting].convertRealFactor, this._modDragPin.interval, this.shiftMode));\r\n\r\n        }\r\n    }\r\n\r\n    private _getMaxDivision(): number {\r\n        const rhythmStepsPerBeat: number = Config.rhythms[this._doc.song.rhythm].stepsPerBeat;\r\n        if (rhythmStepsPerBeat % 4 == 0) {\r\n            // Beat is divisible by 2 (and 4).\r\n            return Config.partsPerBeat / 2;\r\n        } else if (rhythmStepsPerBeat % 3 == 0) {\r\n            // Beat is divisible by 3.\r\n            return Config.partsPerBeat / 3;\r\n        } else if (rhythmStepsPerBeat % 2 == 0) {\r\n            // Beat is divisible by 2.\r\n            return Config.partsPerBeat / 2;\r\n        }\r\n        return Config.partsPerBeat;\r\n    }\r\n\r\n    private _getMinDivision(): number {\r\n        return Config.partsPerBeat / Config.rhythms[this._doc.song.rhythm].stepsPerBeat;\r\n    }\r\n\r\n    private _snapToMinDivision(input: number): number {\r\n        const minDivision: number = this._getMinDivision();\r\n        return Math.floor(input / minDivision) * minDivision;\r\n    }\r\n\r\n    private _updateCursorStatus(): void {\r\n        this._cursor = new PatternCursor();\r\n\r\n        if (this._mouseX < 0 || this._mouseX > this._editorWidth || this._mouseY < 0 || this._mouseY > this._editorHeight || this._pitchHeight <= 0) return;\r\n\r\n        const minDivision: number = this._getMinDivision();\r\n        this._cursor.exactPart = this._mouseX / this._partWidth;\r\n        this._cursor.part =\r\n            Math.floor(\r\n                Math.max(0,\r\n                    Math.min(this._doc.song.beatsPerBar * Config.partsPerBeat - minDivision, this._cursor.exactPart)\r\n                )\r\n                / minDivision) * minDivision;\r\n\r\n        let foundNote: boolean = false;\r\n\r\n        if (this._pattern != null) {\r\n            for (const note of this._pattern.notes) {\r\n                if (note.end <= this._cursor.exactPart) {\r\n                    if (this._doc.song.getChannelIsMod(this._doc.channel)) {\r\n                        if (note.pitches[0] == Math.floor(this._findMousePitch(this._mouseY))) {\r\n                            this._cursor.prevNote = note;\r\n                        }\r\n                        if (!foundNote)\r\n                            this._cursor.curIndex++;\r\n\r\n                    } else {\r\n                        this._cursor.prevNote = note;\r\n                        this._cursor.curIndex++;\r\n                    }\r\n                } else if (note.start <= this._cursor.exactPart && note.end > this._cursor.exactPart) {\r\n                    if (this._doc.song.getChannelIsMod(this._doc.channel)) {\r\n                        if (note.pitches[0] == Math.floor(this._findMousePitch(this._mouseY))) {\r\n                            this._cursor.curNote = note;\r\n                            foundNote = true;\r\n                        }\r\n                        // Only increment index if the sought note has been found... or if this note truly starts before the other\r\n                        else if (!foundNote || (this._cursor.curNote != null && note.start < this._cursor.curNote.start))\r\n                            this._cursor.curIndex++;\r\n                    }\r\n                    else {\r\n                        this._cursor.curNote = note;\r\n                    }\r\n                } else if (note.start > this._cursor.exactPart) {\r\n                    if (this._doc.song.getChannelIsMod(this._doc.channel)) {\r\n                        if (note.pitches[0] == Math.floor(this._findMousePitch(this._mouseY))) {\r\n                            this._cursor.nextNote = note;\r\n                            break;\r\n                        }\r\n                    } else {\r\n                        this._cursor.nextNote = note;\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n\r\n            if (this._doc.song.getChannelIsMod(this._doc.channel) && !this.editingModLabel) {\r\n\r\n                if (this._pattern.notes[this._cursor.curIndex] != null && this._cursor.curNote != null) {\r\n\r\n                    let pinIdx: number = 0;\r\n\r\n                    while (this._cursor.curNote.start + this._cursor.curNote.pins[pinIdx].time < this._cursor.exactPart && pinIdx < this._cursor.curNote.pins.length) {\r\n                        pinIdx++;\r\n                    }\r\n                    // Decide if the previous pin is closer\r\n                    if (pinIdx > 0) {\r\n                        if (this._cursor.curNote.start + this._cursor.curNote.pins[pinIdx].time - this._cursor.exactPart > this._cursor.exactPart - (this._cursor.curNote.start + this._cursor.curNote.pins[pinIdx - 1].time)) {\r\n                            pinIdx--;\r\n                        }\r\n                    }\r\n\r\n                    this.modDragValueLabel.style.setProperty(\"color\", \"#666688\");\r\n                    this.modDragValueLabel.style.setProperty(\"display\", \"\");\r\n                    const mod: number = Math.max( 0, Config.modCount - 1 - this._cursor.curNote.pitches[0]);\r\n\r\n                    let setting: number = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument(this._barOffset)].modulators[mod];\r\n\r\n                    let presValue: number = this._cursor.curNote.pins[pinIdx].size + Config.modulators[setting].convertRealFactor;\r\n\r\n                    // This is me being too lazy to fiddle with the css to get it to align center.\r\n                    let xOffset: number = (+(presValue >= 10.0)) + (+(presValue >= 100.0)) + (+(presValue < 0.0)) + (+(presValue <= -10.0));\r\n\r\n                    this._modDragValueLabelWidth = 8 + xOffset * 8;\r\n                    this._modDragValueLabelLeft = +prettyNumber(Math.max(Math.min(this._editorWidth - 10 - xOffset * 8, this._partWidth * (this._cursor.curNote.start + this._cursor.curNote.pins[pinIdx].time) - 4 - xOffset * 4), 2));\r\n                    this._modDragValueLabelTop = +prettyNumber(this._pitchToPixelHeight(this._cursor.curNote.pitches[0] - this._octaveOffset) - 17 - (this._pitchHeight - this._pitchBorder) / 2);\r\n\r\n                    this._modDragStartValue = this._cursor.curNote.pins[pinIdx].size;\r\n                    this._modDragNote = this._cursor.curNote;\r\n                    this._modDragPin = this._cursor.curNote.pins[pinIdx];\r\n                    this._modDragLowerBound = Config.modulators[setting].convertRealFactor;\r\n                    this._modDragUpperBound = Config.modulators[setting].convertRealFactor + Config.modulators[setting].maxRawVol;\r\n                    this._modDragSetting = setting;\r\n\r\n                    this.modDragValueLabel.style.setProperty(\"left\", \"\" + this._modDragValueLabelLeft + \"px\");\r\n                    this.modDragValueLabel.style.setProperty(\"top\", \"\" + this._modDragValueLabelTop + \"px\");\r\n                    this.modDragValueLabel.textContent = \"\" + presValue;\r\n\r\n                }\r\n                else {\r\n                    this.modDragValueLabel.style.setProperty(\"display\", \"none\");\r\n                    this.modDragValueLabel.style.setProperty(\"pointer-events\", \"none\");\r\n                    this.modDragValueLabel.setAttribute(\"contenteditable\", \"false\");\r\n                }\r\n            }\r\n            else if (!this.editingModLabel) {\r\n                this.modDragValueLabel.style.setProperty(\"display\", \"none\");\r\n                this.modDragValueLabel.style.setProperty(\"pointer-events\", \"none\");\r\n                this.modDragValueLabel.setAttribute(\"contenteditable\", \"false\");\r\n            }\r\n        }\r\n        else {\r\n            this.modDragValueLabel.style.setProperty(\"display\", \"none\");\r\n            this.modDragValueLabel.style.setProperty(\"pointer-events\", \"none\");\r\n            this.modDragValueLabel.setAttribute(\"contenteditable\", \"false\");\r\n        }\r\n\r\n        let mousePitch: number = this._findMousePitch(this._mouseY);\r\n\r\n        if (this._cursor.curNote != null) {\r\n\r\n            this._cursor.start = this._cursor.curNote.start;\r\n            this._cursor.end = this._cursor.curNote.end;\r\n            this._cursor.pins = this._cursor.curNote.pins;\r\n\r\n            let interval: number = 0;\r\n            let error: number = 0;\r\n            let prevPin: NotePin;\r\n            let nextPin: NotePin = this._cursor.curNote.pins[0];\r\n            for (let j: number = 1; j < this._cursor.curNote.pins.length; j++) {\r\n                prevPin = nextPin;\r\n                nextPin = this._cursor.curNote.pins[j];\r\n                const leftSide: number = this._partWidth * (this._cursor.curNote.start + prevPin.time);\r\n                const rightSide: number = this._partWidth * (this._cursor.curNote.start + nextPin.time);\r\n                if (this._mouseX > rightSide) continue;\r\n                if (this._mouseX < leftSide) throw new Error();\r\n                const intervalRatio: number = (this._mouseX - leftSide) / (rightSide - leftSide);\r\n                const arc: number = Math.sqrt(1.0 / Math.sqrt(4.0) - Math.pow(intervalRatio - 0.5, 2.0)) - 0.5;\r\n                const bendHeight: number = Math.abs(nextPin.interval - prevPin.interval);\r\n                interval = prevPin.interval * (1.0 - intervalRatio) + nextPin.interval * intervalRatio;\r\n                error = arc * bendHeight + 0.95;\r\n                break;\r\n            }\r\n\r\n            let minInterval: number = Number.MAX_VALUE;\r\n            let maxInterval: number = -Number.MAX_VALUE;\r\n            let bestDistance: number = Number.MAX_VALUE;\r\n            for (const pin of this._cursor.curNote.pins) {\r\n                if (minInterval > pin.interval) minInterval = pin.interval;\r\n                if (maxInterval < pin.interval) maxInterval = pin.interval;\r\n                const pinDistance: number = Math.abs(this._cursor.curNote.start + pin.time - this._mouseX / this._partWidth);\r\n                if (bestDistance > pinDistance) {\r\n                    bestDistance = pinDistance;\r\n                    this._cursor.nearPinIndex = this._cursor.curNote.pins.indexOf(pin);\r\n                }\r\n            }\r\n\r\n            mousePitch -= interval;\r\n            const maxPitch: number = this._doc.song.getChannelIsNoise(this._doc.channel) ? Config.drumCount - 1 :\r\n                    this._doc.song.getChannelIsMod(this._doc.channel) ? Config.modCount - 1 : Config.maxPitch;\r\n            this._cursor.pitch = this._snapToPitch(mousePitch, -minInterval, maxPitch - maxInterval);\r\n\r\n            // Snap to nearby existing note if present.\r\n            if (!this._doc.song.getChannelIsNoise(this._doc.channel) && !this._doc.song.getChannelIsMod(this._doc.channel)) {\r\n                let nearest: number = error;\r\n                for (let i: number = 0; i < this._cursor.curNote.pitches.length; i++) {\r\n                    const distance: number = Math.abs(this._cursor.curNote.pitches[i] - mousePitch + 0.5);\r\n                    if (distance > nearest) continue;\r\n                    nearest = distance;\r\n                    this._cursor.pitch = this._cursor.curNote.pitches[i];\r\n                }\r\n            }\r\n\r\n            for (let i: number = 0; i < this._cursor.curNote.pitches.length; i++) {\r\n                if (this._cursor.curNote.pitches[i] == this._cursor.pitch) {\r\n                    this._cursor.pitchIndex = i;\r\n                    break;\r\n                }\r\n            }\r\n        } else {\r\n\r\n            const maxPitch: number = this._doc.song.getChannelIsNoise(this._doc.channel) ? Config.drumCount - 1 :\r\n                this._doc.song.getChannelIsMod(this._doc.channel) ? Config.modCount : Config.maxPitch;\r\n            this._cursor.pitch = this._snapToPitch(mousePitch, 0, maxPitch);\r\n            const defaultLength: number = this._copiedPins[this._copiedPins.length - 1].time;\r\n            const fullBeats: number = Math.floor(this._cursor.part / Config.partsPerBeat);\r\n            const maxDivision: number = this._getMaxDivision();\r\n            const modMouse: number = this._cursor.part % Config.partsPerBeat;\r\n            if (defaultLength == 1) {\r\n                this._cursor.start = this._cursor.part;\r\n            } else if (defaultLength > Config.partsPerBeat) {\r\n                this._cursor.start = fullBeats * Config.partsPerBeat;\r\n            } else if (defaultLength == Config.partsPerBeat) {\r\n                this._cursor.start = fullBeats * Config.partsPerBeat;\r\n                if (maxDivision < Config.partsPerBeat && modMouse > maxDivision) {\r\n                    this._cursor.start += Math.floor(modMouse / maxDivision) * maxDivision;\r\n                }\r\n            } else {\r\n                this._cursor.start = fullBeats * Config.partsPerBeat;\r\n                let division = Config.partsPerBeat % defaultLength == 0 ? defaultLength : Math.min(defaultLength, maxDivision);\r\n                while (division < maxDivision && Config.partsPerBeat % division != 0) {\r\n                    division++;\r\n                }\r\n                this._cursor.start += Math.floor(modMouse / division) * division;\r\n            }\r\n            this._cursor.end = this._cursor.start + defaultLength;\r\n            let forceStart: number = 0;\r\n            let forceEnd: number = this._doc.song.beatsPerBar * Config.partsPerBeat;\r\n            if (this._cursor.prevNote != null) {\r\n                forceStart = this._cursor.prevNote.end;\r\n            }\r\n            if (this._cursor.nextNote != null) {\r\n                forceEnd = this._cursor.nextNote.start;\r\n            }\r\n            if (this._cursor.start < forceStart) {\r\n                this._cursor.start = forceStart;\r\n                this._cursor.end = this._cursor.start + defaultLength;\r\n                if (this._cursor.end > forceEnd) {\r\n                    this._cursor.end = forceEnd;\r\n                }\r\n            } else if (this._cursor.end > forceEnd) {\r\n                this._cursor.end = forceEnd;\r\n                this._cursor.start = this._cursor.end - defaultLength;\r\n                if (this._cursor.start < forceStart) {\r\n                    this._cursor.start = forceStart;\r\n                }\r\n            }\r\n\r\n            if (this._cursor.end - this._cursor.start == defaultLength) {\r\n                this._copiedPins = this._copiedPinChannels[this._doc.channel];\r\n                this._cursor.pins = this._copiedPins;\r\n            } else {\r\n                this._cursor.pins = [];\r\n                for (const oldPin of this._copiedPins) {\r\n                    if (oldPin.time <= this._cursor.end - this._cursor.start) {\r\n                        this._cursor.pins.push(makeNotePin(0, oldPin.time, oldPin.size));\r\n                        if (oldPin.time == this._cursor.end - this._cursor.start) break;\r\n                    } else {\r\n                        this._cursor.pins.push(makeNotePin(0, this._cursor.end - this._cursor.start, oldPin.size));\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n\r\n            if (this._doc.song.getChannelIsMod(this._doc.channel)) {\r\n\r\n                this._cursor.pitch = Math.max(0, Math.min(Config.modCount - 1, this._cursor.pitch));\r\n\r\n                // Return cursor to stashed cursor volumes (so pins aren't destroyed by moving the preview around several volume scales.)\r\n                if (this._stashCursorPinVols != null && this._stashCursorPinVols[this._doc.channel] != null) {\r\n                    for (let pin: number = 0; pin < this._cursor.pins.length; pin++) {\r\n                        this._cursor.pins[pin].size = this._stashCursorPinVols[this._doc.channel][pin];\r\n                    }\r\n                }\r\n\r\n                // Scale volume of copied pin to cap for this row\r\n                let maxHeight: number = this._doc.song.getVolumeCap(this._doc.song.getChannelIsMod(this._doc.channel), this._doc.channel, this._doc.getCurrentInstrument(this._barOffset), this._cursor.pitch);\r\n                let maxFoundHeight: number = 0;\r\n                for (const pin of this._cursor.pins) {\r\n                    if (pin.size > maxFoundHeight) {\r\n                        maxFoundHeight = pin.size;\r\n                    }\r\n                }\r\n                // Apply scaling if the max height is below any pin setting.\r\n                if (maxFoundHeight > maxHeight) {\r\n                    for (const pin of this._cursor.pins) {\r\n                        pin.size = Math.round(pin.size * (maxHeight / maxFoundHeight));\r\n                    }\r\n                }\r\n            }\r\n\r\n        }\r\n\r\n        this._cursor.valid = true;\r\n\r\n    }\r\n\r\n    private _cursorIsInSelection(): boolean {\r\n        return this._cursor.valid && this._doc.selection.patternSelectionActive && this._doc.selection.patternSelectionStart <= this._cursor.exactPart && this._cursor.exactPart <= this._doc.selection.patternSelectionEnd;\r\n    }\r\n\r\n    private _cursorAtStartOfSelection(): boolean {\r\n        return this._cursor.valid && this._doc.selection.patternSelectionActive && this._cursor.pitchIndex == -1 && this._doc.selection.patternSelectionStart - 3 <= this._cursor.exactPart && this._cursor.exactPart <= this._doc.selection.patternSelectionStart + 1.25;\r\n    }\r\n\r\n    private _cursorAtEndOfSelection(): boolean {\r\n        return this._cursor.valid && this._doc.selection.patternSelectionActive && this._cursor.pitchIndex == -1 && this._doc.selection.patternSelectionEnd - 1.25 <= this._cursor.exactPart && this._cursor.exactPart <= this._doc.selection.patternSelectionEnd + 3;\r\n    }\r\n\r\n    private _findMousePitch(pixelY: number): number {\r\n        return Math.max(0, Math.min(this._pitchCount - 1, this._pitchCount - (pixelY / this._pitchHeight))) + this._octaveOffset;\r\n    }\r\n\r\n    private _snapToPitch(guess: number, min: number, max: number): number {\r\n        if (guess < min) guess = min;\r\n        if (guess > max) guess = max;\r\n        const scale: ReadonlyArray<boolean> = this._doc.prefs.notesOutsideScale ? Config.scales.dictionary[\"Free\"].flags : Config.scales[this._doc.song.scale].flags;\r\n        if (scale[Math.floor(guess) % Config.pitchesPerOctave] || this._doc.song.getChannelIsNoise(this._doc.channel) || this._doc.song.getChannelIsMod(this._doc.channel)) {\r\n\r\n            return Math.floor(guess);\r\n        } else {\r\n            let topPitch: number = Math.floor(guess) + 1;\r\n            let bottomPitch: number = Math.floor(guess) - 1;\r\n            while (!scale[topPitch % Config.pitchesPerOctave]) {\r\n                topPitch++;\r\n            }\r\n            while (!scale[(bottomPitch) % Config.pitchesPerOctave]) {\r\n                bottomPitch--;\r\n            }\r\n            if (topPitch > max) {\r\n                if (bottomPitch < min) {\r\n                    return min;\r\n                } else {\r\n                    return bottomPitch;\r\n                }\r\n            } else if (bottomPitch < min) {\r\n                return topPitch;\r\n            }\r\n            let topRange: number = topPitch;\r\n            let bottomRange: number = bottomPitch + 1;\r\n            if (topPitch % Config.pitchesPerOctave == 0 || topPitch % Config.pitchesPerOctave == 7) {\r\n                topRange -= 0.5;\r\n            }\r\n            if (bottomPitch % Config.pitchesPerOctave == 0 || bottomPitch % Config.pitchesPerOctave == 7) {\r\n                bottomRange += 0.5;\r\n            }\r\n            return guess - bottomRange > topRange - guess ? topPitch : bottomPitch;\r\n        }\r\n    }\r\n\r\n    private _copyPins(note: Note): void {\r\n        this._copiedPins = [];\r\n        for (const oldPin of note.pins) {\r\n            this._copiedPins.push(makeNotePin(0, oldPin.time, oldPin.size));\r\n        }\r\n        for (let i: number = 1; i < this._copiedPins.length - 1;) {\r\n            if (this._copiedPins[i - 1].size == this._copiedPins[i].size &&\r\n                this._copiedPins[i].size == this._copiedPins[i + 1].size) {\r\n                this._copiedPins.splice(i, 1);\r\n            } else {\r\n                i++;\r\n            }\r\n        }\r\n        this._copiedPinChannels[this._doc.channel] = this._copiedPins;\r\n\r\n        this._stashCursorPinVols[this._doc.channel] = [];\r\n        for (let pin: number = 0; pin < this._copiedPins.length; pin++) {\r\n            this._stashCursorPinVols[this._doc.channel].push(this._copiedPins[pin].size);\r\n        }\r\n    }\r\n\r\n    public movePlayheadToMouse(): boolean {\r\n\t\tif (this._mouseOver) {\r\n\t\t\tthis._doc.synth.playhead = this._doc.bar + this._barOffset + (this._mouseX / this._editorWidth);\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\r\n    public resetCopiedPins = (): void => {\r\n        const maxDivision: number = this._getMaxDivision();\r\n        let cap: number = this._doc.song.getVolumeCap(false);\r\n        this._copiedPinChannels.length = this._doc.song.getChannelCount();\r\n        this._stashCursorPinVols.length = this._doc.song.getChannelCount();\r\n        for (let i: number = 0; i < this._doc.song.pitchChannelCount; i++) {\r\n            this._copiedPinChannels[i] = [makeNotePin(0, 0, cap), makeNotePin(0, maxDivision, cap)];\r\n            this._stashCursorPinVols[i] = [cap, cap];\r\n        }\r\n        for (let i: number = this._doc.song.pitchChannelCount; i < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount; i++) {\r\n            this._copiedPinChannels[i] = [makeNotePin(0, 0, cap), makeNotePin(0, maxDivision, 0)];\r\n            this._stashCursorPinVols[i] = [cap, 0];\r\n        }\r\n        for (let i: number = this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount; i < this._doc.song.getChannelCount(); i++) {\r\n            this._copiedPinChannels[i] = [makeNotePin(0, 0, cap), makeNotePin(0, maxDivision, 0)];\r\n            this._stashCursorPinVols[i] = [cap, 0];\r\n        }\r\n    }\r\n\r\n    private _animatePlayhead = (timestamp: number): void => {\r\n\r\n        if (this._usingTouch && !this.shiftMode && !this._mouseDragging && this._mouseDown && performance.now() > this._touchTime + 1000 && this._cursor.valid && this._doc.lastChangeWas(this._dragChange)) {\r\n            // On a mobile device, the pattern editor supports using a long stationary touch to activate selection.\r\n            this._dragChange!.undo();\r\n            this._shiftHeld = true;\r\n            this._dragConfirmed = false;\r\n            this._whenCursorPressed();\r\n            // The full interface is usually only rerendered in response to user input events, not animation events, but in this case go ahead and rerender everything.\r\n            this._doc.notifier.notifyWatchers();\r\n        }\r\n\r\n        const playheadBar: number = Math.floor(this._doc.synth.playhead);\r\n\r\n        if (this._doc.synth.playing && ((this._pattern != null && this._doc.song.getPattern(this._doc.channel, Math.floor(this._doc.synth.playhead)) == this._pattern) || Math.floor(this._doc.synth.playhead) == this._doc.bar + this._barOffset)) {\r\n            this._svgPlayhead.setAttribute(\"visibility\", \"visible\");\r\n            const modPlayhead: number = this._doc.synth.playhead - playheadBar;\r\n            if (Math.abs(modPlayhead - this._playheadX) > 0.1) {\r\n                this._playheadX = modPlayhead;\r\n            } else {\r\n                this._playheadX += (modPlayhead - this._playheadX) * 0.2;\r\n            }\r\n            this._svgPlayhead.setAttribute(\"x\", \"\" + prettyNumber(this._playheadX * this._editorWidth - 2));\r\n        } else {\r\n            this._svgPlayhead.setAttribute(\"visibility\", \"hidden\");\r\n        }\r\n\r\n        if (this._doc.synth.playing && (this._doc.synth.recording || this._doc.prefs.autoFollow) && this._followPlayheadBar != playheadBar) {\r\n            // When autofollow is enabled, select the current bar (but don't record it in undo history).\r\n            new ChangeChannelBar(this._doc, this._doc.channel, playheadBar);\r\n            // The full interface is usually only rerendered in response to user input events, not animation events, but in this case go ahead and rerender everything.\r\n            this._doc.notifier.notifyWatchers();\r\n        }\r\n        this._followPlayheadBar = playheadBar;\r\n\r\n        if (this._doc.currentPatternIsDirty) {\r\n            this._redrawNotePatterns();\r\n        }\r\n\r\n        window.requestAnimationFrame(this._animatePlayhead);\r\n    }\r\n\r\n    private _whenMouseOver = (event: MouseEvent): void => {\r\n        if (this._mouseOver) return;\r\n        this._mouseOver = true;\r\n        this._usingTouch = false;\r\n    }\r\n\r\n    private _whenMouseOut = (event: MouseEvent): void => {\r\n        if (!this._mouseOver) return;\r\n        this._mouseOver = false;\r\n    }\r\n\r\n    private _whenMousePressed = (event: MouseEvent): void => {\r\n        event.preventDefault();\r\n        const boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n        this._mouseX = ((event.clientX || event.pageX) - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n        this._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n        if (isNaN(this._mouseX)) this._mouseX = 0;\r\n        if (isNaN(this._mouseY)) this._mouseY = 0;\r\n        this._usingTouch = false;\r\n        this._shiftHeld = event.shiftKey;\r\n        this._dragConfirmed = false;\r\n        this._whenCursorPressed();\r\n    }\r\n\r\n    private _whenTouchPressed = (event: TouchEvent): void => {\r\n        event.preventDefault();\r\n        const boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n        this._mouseX = (event.touches[0].clientX - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n        this._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n        if (isNaN(this._mouseX)) this._mouseX = 0;\r\n        if (isNaN(this._mouseY)) this._mouseY = 0;\r\n        this._usingTouch = true;\r\n        this._shiftHeld = event.shiftKey;\r\n        this._dragConfirmed = false;\r\n        this._touchTime = performance.now();\r\n        this._whenCursorPressed();\r\n    }\r\n\r\n    public stopEditingModLabel(discardChanges: boolean) {\r\n        if (this.editingModLabel) {\r\n            this.editingModLabel = false;\r\n            this.modDragValueLabel.style.setProperty(\"pointer-events\", \"none\");\r\n\r\n            if (window.getSelection) {\r\n                let sel: Selection | null = window.getSelection();\r\n                if (sel != null)\r\n                    sel.removeAllRanges();\r\n            }\r\n            // Return pin to its state before text editing\r\n            if (discardChanges) {\r\n                this._modDragPin.size = this._modDragStartValue;\r\n\r\n                let presValue: number = this._modDragStartValue + Config.modulators[this._modDragSetting].convertRealFactor;\r\n\r\n                // This is me being too lazy to fiddle with the css to get it to align center.\r\n                let xOffset: number = (+(presValue >= 10.0)) + (+(presValue >= 100.0)) + (+(presValue < 0.0)) + (+(presValue <= -10.0));\r\n                this._modDragValueLabelLeft = +prettyNumber(Math.max(Math.min(this._editorWidth - 10 - xOffset * 8, this._partWidth * (this._modDragNote.start + this._modDragPin.time) - 4 - xOffset * 4), 2));\r\n                this.modDragValueLabel.style.setProperty(\"left\", \"\" + this._modDragValueLabelLeft + \"px\");\r\n\r\n                const sequence: ChangeSequence = new ChangeSequence();\r\n                this._dragChange = sequence;\r\n                this._doc.setProspectiveChange(this._dragChange);\r\n\r\n                sequence.append(new ChangeSizeBend(this._doc, this._modDragNote, this._modDragPin.time, this._modDragStartValue, this._modDragPin.interval, this.shiftMode));\r\n\r\n                this._dragChange = null;\r\n            }\r\n\r\n            const continuousState: boolean = this._doc.lastChangeWas(this._dragChange);\r\n            if (continuousState) {\r\n                if (this._dragChange != null) {\r\n                    this._doc.record(this._dragChange);\r\n                    this._dragChange = null;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    private _whenCursorPressed(): void {\r\n        // Check for click on mod value label\r\n        if (this._doc.song.getChannelIsMod(this._doc.channel) && this.modDragValueLabel.style.getPropertyValue(\"display\") != \"none\" &&\r\n            this._mouseX > +this._modDragValueLabelLeft - 6 &&\r\n            this._mouseX < +this._modDragValueLabelLeft + this._modDragValueLabelWidth + 6 &&\r\n            this._mouseY > +this._modDragValueLabelTop - 8 &&\r\n            this._mouseY < +this._modDragValueLabelTop + 11) {\r\n            // Mod value label clicked, select it\r\n            this.modDragValueLabel.style.setProperty(\"pointer-events\", \"fill\");\r\n            this.modDragValueLabel.setAttribute(\"contenteditable\", \"true\");\r\n            if (window.getSelection) {\r\n                let sel: Selection | null = window.getSelection();\r\n                if (sel != null)\r\n                    sel.selectAllChildren(this.modDragValueLabel);\r\n            }\r\n\r\n            window.setTimeout(() => { this.modDragValueLabel.focus(); });\r\n            this.editingModLabel = true;\r\n        } else {\r\n            this.stopEditingModLabel(false);\r\n            if (this._doc.prefs.enableNotePreview) this._doc.synth.maintainLiveInput();\r\n            this._mouseDown = true;\r\n            this._mouseXStart = this._mouseX;\r\n            this._mouseYStart = this._mouseY;\r\n            this._updateCursorStatus();\r\n            this._updatePreview();\r\n            const sequence: ChangeSequence = new ChangeSequence();\r\n            this._dragChange = sequence;\r\n            this._lastChangeWasPatternSelection = this._doc.lastChangeWas(this._changePatternSelection);\r\n            this._doc.setProspectiveChange(this._dragChange);\r\n\r\n            if (this._cursorAtStartOfSelection()) {\r\n                this._draggingStartOfSelection = true;\r\n            } else if (this._cursorAtEndOfSelection()) {\r\n                this._draggingEndOfSelection = true;\r\n            } else if (this._shiftHeld) {\r\n                if ((this._doc.selection.patternSelectionActive && this._cursor.pitchIndex == -1) || this._cursorIsInSelection()) {\r\n                    sequence.append(new ChangePatternSelection(this._doc, 0, 0));\r\n                } else {\r\n                    if (this._cursor.curNote != null) {\r\n                        sequence.append(new ChangePatternSelection(this._doc, this._cursor.curNote.start, this._cursor.curNote.end));\r\n                    } else {\r\n                        const start: number = Math.max(0, Math.min((this._doc.song.beatsPerBar - 1) * Config.partsPerBeat, Math.floor(this._cursor.exactPart / Config.partsPerBeat) * Config.partsPerBeat));\r\n                        const end: number = start + Config.partsPerBeat;\r\n                        sequence.append(new ChangePatternSelection(this._doc, start, end));\r\n                    }\r\n                }\r\n            } else if (this._cursorIsInSelection()) {\r\n                this._draggingSelectionContents = true;\r\n            } else if (this._cursor.valid && this._cursor.curNote == null) {\r\n                sequence.append(new ChangePatternSelection(this._doc, 0, 0));\r\n\r\n                // If clicking in empty space, the result will be adding a note,\r\n                // so we can safely add it immediately. Note that if clicking on\r\n                // or near an existing note, the result will depend on whether\r\n                // a drag follows, so we couldn't add the note yet without being\r\n                // confusing.\r\n\r\n                const note: Note = new Note(this._cursor.pitch, this._cursor.start, this._cursor.end, Config.noteSizeMax, this._doc.song.getChannelIsNoise(this._doc.channel));\r\n                note.pins = [];\r\n                for (const oldPin of this._cursor.pins) {\r\n                    note.pins.push(makeNotePin(0, oldPin.time, oldPin.size));\r\n                }\r\n                sequence.append(new ChangeEnsurePatternExists(this._doc, this._doc.channel, this._doc.bar));\r\n                const pattern: Pattern | null = this._doc.getCurrentPattern(this._barOffset);\r\n                if (pattern == null) throw new Error();\r\n                sequence.append(new ChangeNoteAdded(this._doc, pattern, note, this._cursor.curIndex));\r\n\r\n                if (this._doc.prefs.enableNotePreview && !this._doc.synth.playing) {\r\n                    // Play the new note out loud if enabled.\r\n                    const duration: number = Math.min(Config.partsPerBeat, this._cursor.end - this._cursor.start);\r\n                    this._doc.performance.setTemporaryPitches([this._cursor.pitch], duration);\r\n                }\r\n            }\r\n            this._updateSelection();\r\n        }\r\n    }\r\n\r\n    private _whenMouseMoved = (event: MouseEvent): void => {\r\n        this.controlMode = event.ctrlKey;\r\n        this.shiftMode = event.shiftKey;\r\n\r\n        const boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n        this._mouseX = ((event.clientX || event.pageX) - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n        this._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n        if (isNaN(this._mouseX)) this._mouseX = 0;\r\n        if (isNaN(this._mouseY)) this._mouseY = 0;\r\n        this._usingTouch = false;\r\n        this._whenCursorMoved();\r\n    }\r\n\r\n    private _whenTouchMoved = (event: TouchEvent): void => {\r\n        if (!this._mouseDown) return;\r\n        event.preventDefault();\r\n        const boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n        this._mouseX = (event.touches[0].clientX - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n        this._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n        if (isNaN(this._mouseX)) this._mouseX = 0;\r\n        if (isNaN(this._mouseY)) this._mouseY = 0;\r\n        this._whenCursorMoved();\r\n    }\r\n\r\n    private _whenCursorMoved(): void {\r\n        if (this._doc.prefs.enableNotePreview && this._mouseOver) this._doc.synth.maintainLiveInput();\r\n\r\n        // HACK: Undoable pattern changes rely on persistent instance\r\n        // references. Loading song from hash via undo/redo breaks that,\r\n        // so changes are no longer undoable and the cursor status may be\r\n        // invalid. Abort further drag changes until the mouse is released.\r\n        const continuousState: boolean = this._doc.lastChangeWas(this._dragChange);\r\n\r\n        if (!this._mouseDragging && this._mouseDown && this._cursor.valid && continuousState) {\r\n            const dx: number = this._mouseX - this._mouseXStart;\r\n            const dy: number = this._mouseY - this._mouseYStart;\r\n            if (Math.sqrt(dx * dx + dy * dy) > 5) {\r\n                this._mouseDragging = true;\r\n                this._mouseHorizontal = Math.abs(dx) >= Math.abs(dy);\r\n            }\r\n        }\r\n\r\n        if (this._shiftHeld && this._mouseHorizontal && Math.abs(this._mouseXStart - this._mouseX) > 5) {\r\n            this._dragConfirmed = true;\r\n        }\r\n\r\n        if (this._mouseDragging && this._mouseDown && this._cursor.valid && continuousState) {\r\n            this._dragChange!.undo();\r\n            const sequence: ChangeSequence = new ChangeSequence();\r\n            this._dragChange = sequence;\r\n            this._doc.setProspectiveChange(this._dragChange);\r\n\r\n            const minDivision: number = this._getMinDivision();\r\n            const currentPart: number = this._snapToMinDivision(this._mouseX / this._partWidth);\r\n            if (this._draggingStartOfSelection) {\r\n                sequence.append(new ChangePatternSelection(this._doc, Math.max(0, Math.min(this._doc.song.beatsPerBar * Config.partsPerBeat, currentPart)), this._doc.selection.patternSelectionEnd));\r\n                this._updateSelection();\r\n            } else if (this._draggingEndOfSelection) {\r\n                sequence.append(new ChangePatternSelection(this._doc, this._doc.selection.patternSelectionStart, Math.max(0, Math.min(this._doc.song.beatsPerBar * Config.partsPerBeat, currentPart))));\r\n                this._updateSelection();\r\n            } else if (this._draggingSelectionContents) {\r\n                const pattern: Pattern | null = this._doc.getCurrentPattern(this._barOffset);\r\n                if (this._mouseDragging && pattern != null) {\r\n                    this._dragChange!.undo();\r\n                    const sequence: ChangeSequence = new ChangeSequence();\r\n                    this._dragChange = sequence;\r\n                    this._doc.setProspectiveChange(this._dragChange);\r\n\r\n                    const notesInScale: number = Config.scales[this._doc.song.scale].flags.filter(x => x).length;\r\n                    const pitchRatio: number = this._doc.song.getChannelIsNoise(this._doc.channel) ? 1 : 12 / notesInScale;\r\n                    const draggedParts: number = Math.round((this._mouseX - this._mouseXStart) / (this._partWidth * minDivision)) * minDivision;\r\n                    const draggedTranspose: number = Math.round((this._mouseYStart - this._mouseY) / (this._pitchHeight * pitchRatio));\r\n                    sequence.append(new ChangeDragSelectedNotes(this._doc, this._doc.channel, pattern, draggedParts, draggedTranspose));\r\n                }\r\n\r\n            } else if (this._shiftHeld && this._dragConfirmed) {\r\n\r\n                if (this._mouseDragging) {\r\n                    let start: number = Math.max(0, Math.min((this._doc.song.beatsPerBar - 1) * Config.partsPerBeat, Math.floor(this._cursor.exactPart / Config.partsPerBeat) * Config.partsPerBeat));\r\n                    let end: number = start + Config.partsPerBeat;\r\n                    if (this._cursor.curNote != null) {\r\n                        start = Math.max(start, this._cursor.curNote.start);\r\n                        end = Math.min(end, this._cursor.curNote.end);\r\n                    }\r\n\r\n                    // Todo: The following two conditional blocks could maybe be refactored.\r\n                    if (currentPart < start) {\r\n                        start = 0;\r\n                        const pattern: Pattern | null = this._doc.getCurrentPattern(this._barOffset);\r\n                        if (pattern != null) {\r\n                            for (let i: number = 0; i < pattern.notes.length; i++) {\r\n                                if (pattern.notes[i].start <= currentPart) {\r\n                                    start = pattern.notes[i].start;\r\n                                }\r\n                                if (pattern.notes[i].end <= currentPart) {\r\n                                    start = pattern.notes[i].end;\r\n                                }\r\n                            }\r\n                        }\r\n                        for (let beat: number = 0; beat <= this._doc.song.beatsPerBar; beat++) {\r\n                            const part: number = beat * Config.partsPerBeat;\r\n                            if (start <= part && part <= currentPart) {\r\n                                start = part;\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    if (currentPart > end) {\r\n                        end = Config.partsPerBeat * this._doc.song.beatsPerBar;\r\n                        const pattern: Pattern | null = this._doc.getCurrentPattern(this._barOffset);\r\n                        if (pattern != null) {\r\n                            for (let i: number = 0; i < pattern.notes.length; i++) {\r\n                                if (pattern.notes[i].start >= currentPart) {\r\n                                    end = pattern.notes[i].start;\r\n                                    break;\r\n                                }\r\n                                if (pattern.notes[i].end >= currentPart) {\r\n                                    end = pattern.notes[i].end;\r\n                                    break;\r\n                                }\r\n                            }\r\n                        }\r\n                        for (let beat: number = 0; beat <= this._doc.song.beatsPerBar; beat++) {\r\n                            const part: number = beat * Config.partsPerBeat;\r\n                            if (currentPart < part && part < end) {\r\n                                end = part;\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    sequence.append(new ChangePatternSelection(this._doc, start, end));\r\n                    this._updateSelection();\r\n                }\r\n            } else {\r\n\r\n                if (this._cursor.curNote == null) {\r\n                    sequence.append(new ChangePatternSelection(this._doc, 0, 0));\r\n\r\n\r\n                    let backwards: boolean;\r\n                    let directLength: number;\r\n                    if (currentPart < this._cursor.start) {\r\n                        backwards = true;\r\n                        directLength = this._cursor.start - currentPart;\r\n                    } else {\r\n                        backwards = false;\r\n                        directLength = currentPart - this._cursor.start + minDivision;\r\n                    }\r\n\r\n                    let defaultLength: number = minDivision;\r\n                    for (let i: number = minDivision; i <= this._doc.song.beatsPerBar * Config.partsPerBeat; i += minDivision) {\r\n                        if (minDivision == 1) {\r\n                            if (i < 5) {\r\n                                // Allow small lengths.\r\n                            } else if (i <= Config.partsPerBeat / 2.0) {\r\n                                if (i % 3 != 0 && i % 4 != 0) {\r\n                                    continue;\r\n                                }\r\n                            } else if (i <= Config.partsPerBeat * 1.5) {\r\n                                if (i % 6 != 0 && i % 8 != 0) {\r\n                                    continue;\r\n                                }\r\n                            } else if (i % Config.partsPerBeat != 0) {\r\n                                continue;\r\n                            }\r\n                        } else {\r\n                            if (i >= 5 * minDivision &&\r\n                                i % Config.partsPerBeat != 0 &&\r\n                                i != Config.partsPerBeat * 3.0 / 4.0 &&\r\n                                i != Config.partsPerBeat * 3.0 / 2.0 &&\r\n                                i != Config.partsPerBeat * 4.0 / 3.0) {\r\n                                continue;\r\n                            }\r\n                        }\r\n\r\n                        const blessedLength: number = i;\r\n                        if (blessedLength == directLength) {\r\n                            defaultLength = blessedLength;\r\n                            break;\r\n                        }\r\n                        if (blessedLength < directLength) {\r\n                            defaultLength = blessedLength;\r\n                        }\r\n\r\n                        if (blessedLength > directLength) {\r\n                            if (defaultLength < directLength - minDivision) {\r\n                                defaultLength = blessedLength;\r\n                            }\r\n                            break;\r\n                        }\r\n                    }\r\n\r\n                    let start: number;\r\n                    let end: number;\r\n\r\n                    if (backwards) {\r\n                        end = this._cursor.start;\r\n                        start = end - defaultLength;\r\n                    } else {\r\n                        start = this._cursor.start;\r\n                        end = start + defaultLength;\r\n                    }\r\n                    const continuesLastPattern: boolean = (start < 0 && this._doc.channel < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount);\r\n                    if (start < 0) start = 0;\r\n                    if (end > this._doc.song.beatsPerBar * Config.partsPerBeat) end = this._doc.song.beatsPerBar * Config.partsPerBeat;\r\n\r\n                    if (start < end) {\r\n                        sequence.append(new ChangeEnsurePatternExists(this._doc, this._doc.channel, this._doc.bar));\r\n                        const pattern: Pattern | null = this._doc.getCurrentPattern(this._barOffset);\r\n                        if (pattern == null) throw new Error();\r\n                        // Using parameter skipNote to force proper \"collision\" checking vis-a-vis pitch for mod channels.\r\n                        sequence.append(new ChangeNoteTruncate(this._doc, pattern, start, end, new Note(this._cursor.pitch, 0, 0, 0)));\r\n                        let i: number;\r\n                        for (i = 0; i < pattern.notes.length; i++) {\r\n                            if (pattern.notes[i].start >= end) break;\r\n                        }\r\n                        const theNote: Note = new Note(this._cursor.pitch, start, end,\r\n                            this._doc.song.getNewNoteVolume(this._doc.song.getChannelIsMod(this._doc.channel), this._doc.channel, this._doc.getCurrentInstrument(this._barOffset), this._cursor.pitch),\r\n                            this._doc.song.getChannelIsNoise(this._doc.channel));\r\n                        theNote.continuesLastPattern = continuesLastPattern;\r\n                        sequence.append(new ChangeNoteAdded(this._doc, pattern, theNote, i));\r\n                        this._copyPins(theNote);\r\n\r\n                        this._dragTime = backwards ? start : end;\r\n                        this._dragPitch = this._cursor.pitch;\r\n                        this._dragSize = theNote.pins[backwards ? 0 : 1].size;\r\n                        this._dragVisible = true;\r\n                    }\r\n\r\n                    let prevPattern: Pattern | null = this._pattern;\r\n\r\n                    this._pattern = this._doc.getCurrentPattern(this._barOffset);\r\n\r\n                    if (this._pattern != null && this._doc.song.getChannelIsMod(this._doc.channel) && this._interactive && prevPattern != this._pattern) {\r\n                        // Need to re-sort the notes by start time as they might change order if user drags them around.\r\n                        this._pattern.notes.sort(function (a, b) { return (a.start == b.start) ? a.pitches[0] - b.pitches[0] : a.start - b.start; });\r\n                    }\r\n\r\n                } else if (this._mouseHorizontal) {\r\n\r\n                    sequence.append(new ChangePatternSelection(this._doc, 0, 0));\r\n\r\n                    const shift: number = (this._mouseX - this._mouseXStart) / this._partWidth;\r\n\r\n                    const shiftedPin: NotePin = this._cursor.curNote.pins[this._cursor.nearPinIndex];\r\n                    let shiftedTime: number = Math.round((this._cursor.curNote.start + shiftedPin.time + shift) / minDivision) * minDivision;\r\n                    const continuesLastPattern: boolean = (shiftedTime < 0.0 && this._doc.channel < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount);\r\n                    if (shiftedTime < 0) shiftedTime = 0;\r\n                    if (shiftedTime > this._doc.song.beatsPerBar * Config.partsPerBeat) shiftedTime = this._doc.song.beatsPerBar * Config.partsPerBeat;\r\n\r\n                    if (this._pattern == null) throw new Error();\r\n\r\n                    if (shiftedTime <= this._cursor.curNote.start && this._cursor.nearPinIndex == this._cursor.curNote.pins.length - 1 ||\r\n                        shiftedTime >= this._cursor.curNote.end && this._cursor.nearPinIndex == 0) {\r\n\r\n                        sequence.append(new ChangeNoteAdded(this._doc, this._pattern, this._cursor.curNote, this._cursor.curIndex, true));\r\n\r\n                        this._dragVisible = false;\r\n                    } else {\r\n                        const start: number = Math.min(this._cursor.curNote.start, shiftedTime);\r\n                        const end: number = Math.max(this._cursor.curNote.end, shiftedTime);\r\n\r\n                        this._dragTime = shiftedTime;\r\n                        this._dragPitch = this._cursor.curNote.pitches[this._cursor.pitchIndex == -1 ? 0 : this._cursor.pitchIndex] + this._cursor.curNote.pins[this._cursor.nearPinIndex].interval;\r\n                        this._dragSize = this._cursor.curNote.pins[this._cursor.nearPinIndex].size;\r\n                        this._dragVisible = true;\r\n\r\n                        sequence.append(new ChangeNoteTruncate(this._doc, this._pattern, start, end, this._cursor.curNote));\r\n                        sequence.append(new ChangePinTime(this._doc, this._cursor.curNote, this._cursor.nearPinIndex, shiftedTime, continuesLastPattern));\r\n                        this._copyPins(this._cursor.curNote);\r\n                    }\r\n                } else if (this._cursor.pitchIndex == -1 || this._doc.song.getChannelIsMod(this._doc.channel)) {\r\n\r\n                    if (!this._mouseDragging)\r\n                    sequence.append(new ChangePatternSelection(this._doc, 0, 0));\r\n\r\n                    const bendPart: number =\r\n                        Math.max(this._cursor.curNote.start,\r\n                            Math.min(this._cursor.curNote.end,\r\n                                Math.round(this._mouseX / (this._partWidth * minDivision)) * minDivision\r\n                            )\r\n                        ) - this._cursor.curNote.start;\r\n\r\n                    let prevPin: NotePin;\r\n                    let nextPin: NotePin = this._cursor.curNote.pins[0];\r\n                    let bendSize: number = 0;\r\n                    let bendInterval: number = 0;\r\n                    let cap: number = this._doc.song.getVolumeCap(this._doc.song.getChannelIsMod(this._doc.channel), this._doc.channel, this._doc.getCurrentInstrument(this._barOffset), this._cursor.pitch);\r\n\r\n                    // Dragging gets a bit faster after difference in drag counts is >8.\r\n                    let dragFactorSlow: number = 25.0 / Math.pow(cap, 0.4);\r\n                    let dragFactorFast: number = 22.0 / Math.pow(cap, 0.5);\r\n                    let dragSign: number = (this._mouseYStart > this._mouseY ? 1 : -1);\r\n                    let dragCounts: number = Math.min(Math.abs(this._mouseYStart - this._mouseY) / dragFactorSlow, 8) + Math.max(0, Math.abs(this._mouseYStart - this._mouseY) / dragFactorFast - 8);\r\n\r\n                    // Note volume drag overrides attempts to make a pattern selection\r\n                    if (dragCounts > 0) {\r\n                        this._shiftHeld = false;\r\n                    }\r\n\r\n                    for (let i: number = 1; i < this._cursor.curNote.pins.length; i++) {\r\n                        prevPin = nextPin;\r\n                        nextPin = this._cursor.curNote.pins[i];\r\n                        if (bendPart > nextPin.time) continue;\r\n                        if (bendPart < prevPin.time) throw new Error();\r\n                        const sizeRatio: number = (bendPart - prevPin.time) / (nextPin.time - prevPin.time);\r\n                        bendSize = Math.round(prevPin.size * (1.0 - sizeRatio) + nextPin.size * sizeRatio + dragSign * dragCounts);\r\n                        // If not in fine control mode, round to 0~2~4~6 (normal 4 settings)\r\n                        if (!this.controlMode && !this._doc.prefs.alwaysFineNoteVol && !this._doc.song.getChannelIsMod(this._doc.channel)) {\r\n                            bendSize = Math.floor(bendSize / 2) * 2;\r\n                        }\r\n                        if (bendSize < 0) bendSize = 0;\r\n                        if (bendSize > cap) bendSize = cap;\r\n                        bendInterval = this._snapToPitch(prevPin.interval * (1.0 - sizeRatio) + nextPin.interval * sizeRatio + this._cursor.curNote.pitches[0], 0, Config.maxPitch) - this._cursor.curNote.pitches[0];\r\n                        break;\r\n                    }\r\n                    if (this._doc.song.getChannelIsMod(this._doc.channel) && this.controlMode) {\r\n                        // Link bend to the next note over\r\n                        if (bendPart >= this._cursor.curNote.pins[this._cursor.curNote.pins.length - 1].time) {\r\n                            if (this._cursor.curNote.start + this._cursor.curNote.pins[this._cursor.curNote.pins.length - 1].time < this._doc.song.beatsPerBar * Config.partsPerBeat) {\r\n                                for (const note of this._pattern!.notes) {\r\n                                    if (note.start == this._cursor.curNote.start + this._cursor.curNote.pins[this._cursor.curNote.pins.length - 1].time && note.pitches[0] == this._cursor.curNote.pitches[0]) {\r\n                                        sequence.append(new ChangeSizeBend(this._doc, note, note.pins[0].time, bendSize, bendInterval, this.shiftMode));\r\n                                    }\r\n                                }\r\n                            }\r\n                            else {\r\n                                // Try to bend to the next pattern over. Only do this if a note starts at 0, and instrument is identical in next pattern.\r\n                                const nextPattern: Pattern | null = this._doc.getCurrentPattern(1);\r\n\r\n                                if (nextPattern != null && nextPattern.instruments[0] == this._pattern!.instruments[0]) {\r\n                                    for (const note of nextPattern.notes) {\r\n                                        if (note.start == 0 && note.pitches[0] == this._cursor.curNote.pitches[0]) {\r\n                                            sequence.append(new ChangeSizeBend(this._doc, note, note.pins[0].time, bendSize, bendInterval, this.shiftMode));\r\n                                        }\r\n                                    }\r\n                                }\r\n\r\n                            }\r\n                        }\r\n                        // Link bend to the previous note\r\n                        else if (bendPart <= this._cursor.curNote.pins[0].time) {\r\n                            if (this._cursor.curNote.start > 0) {\r\n                                for (const note of this._pattern!.notes) {\r\n                                    if (note.end == this._cursor.curNote.start && note.pitches[0] == this._cursor.curNote.pitches[0]) {\r\n                                        sequence.append(new ChangeSizeBend(this._doc, note, note.pins[note.pins.length - 1].time, bendSize, bendInterval, this.shiftMode));\r\n                                    }\r\n                                }\r\n                            }\r\n                            else {\r\n                                // Try to bend to the previous pattern over. Only do this if a note starts at the end, and instrument is identical in previous pattern.\r\n                                const prevPattern: Pattern | null = this._doc.getCurrentPattern(-1);\r\n\r\n                                if (prevPattern != null && prevPattern.instruments[0] == this._pattern!.instruments[0]) {\r\n                                    for (const note of prevPattern.notes) {\r\n                                        if (note.end == this._doc.song.beatsPerBar * Config.partsPerBeat && note.pitches[0] == this._cursor.curNote.pitches[0]) {\r\n                                            sequence.append(new ChangeSizeBend(this._doc, note, note.pins[note.pins.length - 1].time, bendSize, bendInterval, this.shiftMode));\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    this._dragTime = this._cursor.curNote.start + bendPart;\r\n                    this._dragPitch = this._cursor.curNote.pitches[this._cursor.pitchIndex == -1 ? 0 : this._cursor.pitchIndex] + bendInterval;\r\n                    this._dragSize = bendSize;\r\n                    this._dragVisible = true;\r\n\r\n                    sequence.append(new ChangeSizeBend(this._doc, this._cursor.curNote, bendPart, bendSize, bendInterval, this.shiftMode));\r\n                    this._copyPins(this._cursor.curNote);\r\n                } else {\r\n                    sequence.append(new ChangePatternSelection(this._doc, 0, 0));\r\n\r\n                    this._dragSize = this._cursor.curNote.pins[this._cursor.nearPinIndex].size;\r\n\r\n                    if (this._pattern == null) throw new Error();\r\n\r\n                    let bendStart: number;\r\n                    let bendEnd: number;\r\n                    if (this._mouseX >= this._mouseXStart) {\r\n                        bendStart = Math.max(this._cursor.curNote.start, this._cursor.part);\r\n                        bendEnd = currentPart + minDivision;\r\n                    } else {\r\n                        bendStart = Math.min(this._cursor.curNote.end, this._cursor.part + minDivision);\r\n                        bendEnd = currentPart;\r\n                    }\r\n                    if (bendEnd < 0) bendEnd = 0;\r\n                    if (bendEnd > this._doc.song.beatsPerBar * Config.partsPerBeat) bendEnd = this._doc.song.beatsPerBar * Config.partsPerBeat;\r\n                    if (bendEnd > this._cursor.curNote.end) {\r\n                        sequence.append(new ChangeNoteTruncate(this._doc, this._pattern, this._cursor.curNote.start, bendEnd, this._cursor.curNote));\r\n                    }\r\n                    if (bendEnd < this._cursor.curNote.start) {\r\n                        sequence.append(new ChangeNoteTruncate(this._doc, this._pattern, bendEnd, this._cursor.curNote.end, this._cursor.curNote));\r\n                    }\r\n\r\n                    let minPitch: number = Number.MAX_VALUE;\r\n                    let maxPitch: number = -Number.MAX_VALUE;\r\n                    for (const pitch of this._cursor.curNote.pitches) {\r\n                        if (minPitch > pitch) minPitch = pitch;\r\n                        if (maxPitch < pitch) maxPitch = pitch;\r\n                    }\r\n                    minPitch -= this._cursor.curNote.pitches[this._cursor.pitchIndex];\r\n                    maxPitch -= this._cursor.curNote.pitches[this._cursor.pitchIndex];\r\n\r\n                    if (!this._doc.song.getChannelIsMod(this._doc.channel)) {\r\n                        const bendTo: number = this._snapToPitch(this._findMousePitch(this._mouseY), -minPitch, (this._doc.song.getChannelIsNoise(this._doc.channel) ? Config.drumCount - 1 : Config.maxPitch) - maxPitch);\r\n                        sequence.append(new ChangePitchBend(this._doc, this._cursor.curNote, bendStart, bendEnd, bendTo, this._cursor.pitchIndex));\r\n                        this._dragPitch = bendTo;\r\n                    }\r\n                    else {\r\n                        const bendTo: number = this._snapToPitch(this._dragPitch, -minPitch, Config.modCount - 1);\r\n                        sequence.append(new ChangePitchBend(this._doc, this._cursor.curNote, bendStart, bendEnd, bendTo, this._cursor.pitchIndex));\r\n                        this._dragPitch = bendTo;\r\n                    }\r\n                    this._copyPins(this._cursor.curNote);\r\n\r\n                    this._dragTime = bendEnd;\r\n                    this._dragVisible = true;\r\n                }\r\n            }\r\n        }\r\n\r\n        if (!(this._mouseDown && this._cursor.valid && continuousState)) {\r\n            this._updateCursorStatus();\r\n            this._updatePreview();\r\n        }\r\n    }\r\n\r\n    private _whenCursorReleased = (event: Event | null): void => {\r\n        if (!this._cursor.valid) return;\r\n\r\n        const continuousState: boolean = this._doc.lastChangeWas(this._dragChange);\r\n        if (this._mouseDown && continuousState && this._dragChange != null) {\r\n\r\n            if (this._draggingSelectionContents) {\r\n                this._doc.record(this._dragChange);\r\n                this._dragChange = null;\r\n                // Need to re-sort the notes by start time as they might change order if user drags them around.\r\n                if (this._pattern != null && this._doc.song.getChannelIsMod(this._doc.channel)) this._pattern.notes.sort(function (a, b) { return (a.start == b.start) ? a.pitches[0] - b.pitches[0] : a.start - b.start; });\r\n\r\n            } else if (this._draggingStartOfSelection || this._draggingEndOfSelection || this._shiftHeld) {\r\n                this._setPatternSelection(this._dragChange);\r\n                this._dragChange = null;\r\n            } else if (this._mouseDragging || this._cursor.curNote == null || !this._dragChange.isNoop() || this._draggingStartOfSelection || this._draggingEndOfSelection || this._draggingSelectionContents || this._shiftHeld) {\r\n                this._doc.record(this._dragChange);\r\n                this._dragChange = null;\r\n                // Need to re-sort the notes by start time as they might change order if user drags them around.\r\n                if (this._pattern != null && this._doc.song.getChannelIsMod(this._doc.channel)) this._pattern.notes.sort(function (a, b) { return (a.start == b.start) ? a.pitches[0] - b.pitches[0] : a.start - b.start; });\r\n\r\n            } else {\r\n\r\n                if (this._pattern == null) throw new Error();\r\n\r\n                const sequence: ChangeSequence = new ChangeSequence();\r\n                sequence.append(new ChangePatternSelection(this._doc, 0, 0));\r\n\r\n                if (this._cursor.pitchIndex == -1) {\r\n                    if (this._cursor.curNote.pitches.length == Config.maxChordSize) {\r\n                        sequence.append(new ChangePitchAdded(this._doc, this._cursor.curNote, this._cursor.curNote.pitches[0], 0, true));\r\n                    }\r\n                    sequence.append(new ChangePitchAdded(this._doc, this._cursor.curNote, this._cursor.pitch, this._cursor.curNote.pitches.length));\r\n                    this._copyPins(this._cursor.curNote);\r\n\r\n                    if (this._doc.prefs.enableNotePreview && !this._doc.synth.playing) {\r\n                        const duration: number = Math.min(Config.partsPerBeat, this._cursor.end - this._cursor.start);\r\n                        this._doc.performance.setTemporaryPitches(this._cursor.curNote.pitches, duration);\r\n                    }\r\n                } else {\r\n                    if (this._cursor.curNote.pitches.length == 1) {\r\n                        sequence.append(new ChangeNoteAdded(this._doc, this._pattern, this._cursor.curNote, this._cursor.curIndex, true));\r\n                    } else {\r\n                        sequence.append(new ChangePitchAdded(this._doc, this._cursor.curNote, this._cursor.pitch, this._cursor.curNote.pitches.indexOf(this._cursor.pitch), true));\r\n                    }\r\n                }\r\n\r\n                this._doc.record(sequence);\r\n            }\r\n        }\r\n\r\n        this._mouseDown = false;\r\n        this._mouseDragging = false;\r\n        this._draggingStartOfSelection = false;\r\n        this._draggingEndOfSelection = false;\r\n        this._draggingSelectionContents = false;\r\n        this._lastChangeWasPatternSelection = false;\r\n        this.modDragValueLabel.setAttribute(\"fill\", ColorConfig.secondaryText);\r\n        this._updateCursorStatus();\r\n        this._updatePreview();\r\n    }\r\n\r\n    private _setPatternSelection(change: UndoableChange): void {\r\n        this._changePatternSelection = change;\r\n        this._doc.record(this._changePatternSelection, this._lastChangeWasPatternSelection);\r\n    }\r\n\r\n\r\n    private _updatePreview(): void {\r\n        if (this._usingTouch) {\r\n            if (!this._mouseDown || !this._cursor.valid || !this._mouseDragging || !this._dragVisible || this._shiftHeld || this._draggingStartOfSelection || this._draggingEndOfSelection || this._draggingSelectionContents) {\r\n                this._svgPreview.setAttribute(\"visibility\", \"hidden\");\r\n\r\n                if (!this.editingModLabel) {\r\n                    this.modDragValueLabel.style.setProperty(\"display\", \"none\");\r\n                    this.modDragValueLabel.style.setProperty(\"pointer-events\", \"none\");\r\n                    this.modDragValueLabel.setAttribute(\"contenteditable\", \"false\");\r\n                }\r\n\r\n            } else {\r\n                this._svgPreview.setAttribute(\"visibility\", \"visible\");\r\n\r\n                const x: number = this._partWidth * this._dragTime;\r\n                const y: number = this._pitchToPixelHeight(this._dragPitch - this._octaveOffset);\r\n                const radius: number = (this._pitchHeight - this._pitchBorder) / 2;\r\n                const width: number = 80;\r\n                const height: number = 60;\r\n                const cap: number = this._doc.song.getVolumeCap(this._doc.song.getChannelIsMod(this._doc.channel), this._doc.channel, this._doc.getCurrentInstrument(this._barOffset), this._cursor.pitch);\r\n                //this._drawNote(this._svgPreview, this._cursor.pitch, this._cursor.start, this._cursor.pins, this._pitchHeight / 2 + 1, true, this._octaveOffset);\r\n\r\n                let pathString: string = \"\";\r\n\r\n                pathString += \"M \" + prettyNumber(x) + \" \" + prettyNumber(y - radius * (this._dragSize / cap)) + \" \";\r\n                pathString += \"L \" + prettyNumber(x) + \" \" + prettyNumber(y - radius * (this._dragSize / cap) - height) + \" \";\r\n                pathString += \"M \" + prettyNumber(x) + \" \" + prettyNumber(y + radius * (this._dragSize / cap)) + \" \";\r\n                pathString += \"L \" + prettyNumber(x) + \" \" + prettyNumber(y + radius * (this._dragSize / cap) + height) + \" \";\r\n                pathString += \"M \" + prettyNumber(x) + \" \" + prettyNumber(y - radius * (this._dragSize / cap)) + \" \";\r\n                pathString += \"L \" + prettyNumber(x + width) + \" \" + prettyNumber(y - radius * (this._dragSize / cap)) + \" \";\r\n                pathString += \"M \" + prettyNumber(x) + \" \" + prettyNumber(y + radius * (this._dragSize / cap)) + \" \";\r\n                pathString += \"L \" + prettyNumber(x + width) + \" \" + prettyNumber(y + radius * (this._dragSize / cap)) + \" \";\r\n                pathString += \"M \" + prettyNumber(x) + \" \" + prettyNumber(y - radius * (this._dragSize / cap)) + \" \";\r\n                pathString += \"L \" + prettyNumber(x - width) + \" \" + prettyNumber(y - radius * (this._dragSize / cap)) + \" \";\r\n                pathString += \"M \" + prettyNumber(x) + \" \" + prettyNumber(y + radius * (this._dragSize / cap)) + \" \";\r\n                pathString += \"L \" + prettyNumber(x - width) + \" \" + prettyNumber(y + radius * (this._dragSize / cap)) + \" \";\r\n\r\n                this._svgPreview.setAttribute(\"d\", pathString);\r\n            }\r\n        } else {\r\n            if (!this._mouseOver || this._mouseDown || !this._cursor.valid) {\r\n                this._svgPreview.setAttribute(\"visibility\", \"hidden\");\r\n                if (!this.editingModLabel) {\r\n                    this.modDragValueLabel.style.setProperty(\"display\", \"none\");\r\n                    this.modDragValueLabel.style.setProperty(\"pointer-events\", \"none\");\r\n                    this.modDragValueLabel.setAttribute(\"contenteditable\", \"false\");\r\n                }\r\n            } else {\r\n                this._svgPreview.setAttribute(\"visibility\", \"visible\");\r\n\r\n                if (this._cursorAtStartOfSelection()) {\r\n                    const center: number = this._partWidth * this._doc.selection.patternSelectionStart;\r\n                    const left: string = prettyNumber(center - 4);\r\n                    const right: string = prettyNumber(center + 4);\r\n                    const bottom: number = this._pitchToPixelHeight(-0.5);\r\n                    this._svgPreview.setAttribute(\"d\", \"M \" + left + \" 0 L \" + left + \" \" + bottom + \" L \" + right + \" \" + bottom + \" L \" + right + \" 0 z\");\r\n                } else if (this._cursorAtEndOfSelection()) {\r\n                    const center: number = this._partWidth * this._doc.selection.patternSelectionEnd;\r\n                    const left: string = prettyNumber(center - 4);\r\n                    const right: string = prettyNumber(center + 4);\r\n                    const bottom: number = this._pitchToPixelHeight(-0.5);\r\n                    this._svgPreview.setAttribute(\"d\", \"M \" + left + \" 0 L \" + left + \" \" + bottom + \" L \" + right + \" \" + bottom + \" L \" + right + \" 0 z\");\r\n                } else if (this._cursorIsInSelection()) {\r\n                    const left: string = prettyNumber(this._partWidth * this._doc.selection.patternSelectionStart - 2);\r\n                    const right: string = prettyNumber(this._partWidth * this._doc.selection.patternSelectionEnd + 2);\r\n                    const bottom: number = this._pitchToPixelHeight(-0.5);\r\n                    this._svgPreview.setAttribute(\"d\", \"M \" + left + \" 0 L \" + left + \" \" + bottom + \" L \" + right + \" \" + bottom + \" L \" + right + \" 0 z\");\r\n                } else {\r\n                    this._drawNote(this._svgPreview, this._cursor.pitch, this._cursor.start, this._cursor.pins, (this._pitchHeight - this._pitchBorder) / 2 + 1, true, this._octaveOffset);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    private _updateSelection(): void {\r\n        if (this._doc.selection.patternSelectionActive) {\r\n            this._selectionRect.setAttribute(\"visibility\", \"visible\");\r\n            this._selectionRect.setAttribute(\"x\", String(this._partWidth * this._doc.selection.patternSelectionStart));\r\n            this._selectionRect.setAttribute(\"width\", String(this._partWidth * (this._doc.selection.patternSelectionEnd - this._doc.selection.patternSelectionStart)));\r\n        } else {\r\n            this._selectionRect.setAttribute(\"visibility\", \"hidden\");\r\n        }\r\n    }\r\n\r\n    public render(): void {\r\n        const nextPattern: Pattern | null = this._doc.getCurrentPattern(this._barOffset);\r\n\r\n        if (this._pattern != nextPattern && this._pattern != null) {\r\n            if (this._doc.song.getChannelIsMod(this._doc.channel) && this._interactive && nextPattern != null) {\r\n                // Need to re-sort the notes by start time as they might change order if user drags them around.\r\n                nextPattern.notes.sort(function (a, b) { return (a.start == b.start) ? a.pitches[0] - b.pitches[0] : a.start - b.start; });\r\n            }\r\n            this._dragChange = null;\r\n            this._whenCursorReleased(null);\r\n        }\r\n        this._pattern = nextPattern;\r\n\r\n        this._editorWidth = this.container.clientWidth;\r\n        this._editorHeight = this.container.clientHeight;\r\n        this._partWidth = this._editorWidth / (this._doc.song.beatsPerBar * Config.partsPerBeat);\r\n        this._octaveOffset = (this._doc.channel >= this._doc.song.pitchChannelCount) ? 0 : this._doc.song.channels[this._doc.channel].octave * Config.pitchesPerOctave;\r\n\r\n        if (this._doc.song.getChannelIsNoise(this._doc.channel)) {\r\n            this._pitchBorder = 0;\r\n            this._pitchCount = Config.drumCount;\r\n        }\r\n        else if (this._doc.song.getChannelIsMod(this._doc.channel)) {\r\n            this._pitchBorder = this._defaultModBorder;\r\n            this._pitchCount = Config.modCount;\r\n\r\n            if (this._pattern != null) {\r\n                // Force max height of mod channels to conform to settings.\r\n                for (const note of this._pattern.notes) {\r\n                    let pitch = note.pitches[0]; // No pitch bend possible in mod channels.\r\n                    let maxHeight: number = this._doc.song.getVolumeCap(true, this._doc.channel, this._doc.getCurrentInstrument(this._barOffset), pitch);\r\n                    let maxFoundHeight: number = 0;\r\n                    for (const pin of note.pins) {\r\n                        if (pin.size > maxFoundHeight) {\r\n                            maxFoundHeight = pin.size;\r\n                        }\r\n                    }\r\n                    // Apply scaling if the max height is below any pin setting.\r\n                    if (maxFoundHeight > maxHeight) {\r\n                        for (const pin of note.pins) {\r\n                            pin.size = Math.round(pin.size * (maxHeight / maxFoundHeight));\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        else {\r\n            this._pitchBorder = 0;\r\n            this._pitchCount = this._doc.getVisiblePitchCount();\r\n        }\r\n\r\n        this._pitchHeight = this._editorHeight / this._pitchCount;\r\n        this._octaveOffset = (this._doc.channel >= this._doc.song.pitchChannelCount) ? 0 : this._doc.getBaseVisibleOctave(this._doc.channel) * Config.pitchesPerOctave;\r\n\r\n        if (this._renderedRhythm != this._doc.song.rhythm ||\r\n            this._renderedPitchChannelCount != this._doc.song.pitchChannelCount ||\r\n            this._renderedNoiseChannelCount != this._doc.song.noiseChannelCount ||\r\n            this._renderedModChannelCount != this._doc.song.modChannelCount) {\r\n            this._renderedRhythm = this._doc.song.rhythm;\r\n            this._renderedPitchChannelCount = this._doc.song.pitchChannelCount;\r\n            this._renderedNoiseChannelCount = this._doc.song.noiseChannelCount;\r\n            this._renderedModChannelCount = this._doc.song.modChannelCount;\r\n            this.resetCopiedPins();\r\n        }\r\n\r\n        this._copiedPins = this._copiedPinChannels[this._doc.channel];\r\n\r\n        if (this._renderedWidth != this._editorWidth || this._renderedHeight != this._editorHeight) {\r\n            this._renderedWidth = this._editorWidth;\r\n            this._renderedHeight = this._editorHeight;\r\n            this._svgBackground.setAttribute(\"width\", \"\" + this._editorWidth);\r\n            this._svgBackground.setAttribute(\"height\", \"\" + this._editorHeight);\r\n            this._svgPlayhead.setAttribute(\"height\", \"\" + this._editorHeight);\r\n            this._selectionRect.setAttribute(\"y\", \"0\");\r\n            this._selectionRect.setAttribute(\"height\", \"\" + this._editorHeight);\r\n        }\r\n\r\n        const beatWidth = this._editorWidth / this._doc.song.beatsPerBar;\r\n        if (this._renderedBeatWidth != beatWidth || this._renderedPitchHeight != this._pitchHeight) {\r\n            this._renderedBeatWidth = beatWidth;\r\n            this._renderedPitchHeight = this._pitchHeight;\r\n            this._svgNoteBackground.setAttribute(\"width\", \"\" + beatWidth);\r\n            this._svgNoteBackground.setAttribute(\"height\", \"\" + (this._pitchHeight * Config.pitchesPerOctave));\r\n            this._svgDrumBackground.setAttribute(\"width\", \"\" + beatWidth);\r\n            this._svgDrumBackground.setAttribute(\"height\", \"\" + this._pitchHeight);\r\n            this._svgModBackground.setAttribute(\"width\", \"\" + beatWidth);\r\n            this._svgModBackground.setAttribute(\"height\", \"\" + (this._pitchHeight));\r\n            this._svgModBackground.setAttribute(\"y\", \"\" + (this._pitchBorder / 2));\r\n            this._backgroundDrumRow.setAttribute(\"width\", \"\" + (beatWidth - 2));\r\n            this._backgroundDrumRow.setAttribute(\"height\", \"\" + (this._pitchHeight - 2));\r\n            if (this._pitchHeight > this._pitchBorder) {\r\n                this._backgroundModRow.setAttribute(\"width\", \"\" + (beatWidth - 2));\r\n                this._backgroundModRow.setAttribute(\"height\", \"\" + (this._pitchHeight - this._pitchBorder));\r\n            }\r\n\r\n\r\n\r\n            for (let j: number = 0; j < Config.pitchesPerOctave; j++) {\r\n                const rectangle: SVGRectElement = this._backgroundPitchRows[j];\r\n                const y: number = (Config.pitchesPerOctave - j) % Config.pitchesPerOctave;\r\n                rectangle.setAttribute(\"width\", \"\" + (beatWidth - 2));\r\n                rectangle.setAttribute(\"y\", \"\" + (y * this._pitchHeight + 1));\r\n                rectangle.setAttribute(\"height\", \"\" + (this._pitchHeight - 2));\r\n            }\r\n        }\r\n\r\n        if (this._interactive) {\r\n            if (!this._mouseDown) this._updateCursorStatus();\r\n            this._updatePreview();\r\n            this._updateSelection();\r\n        }\r\n\r\n        if (this._renderedFifths != this._doc.prefs.showFifth) {\r\n            this._renderedFifths = this._doc.prefs.showFifth;\r\n            this._backgroundPitchRows[7].setAttribute(\"fill\", this._doc.prefs.showFifth ? ColorConfig.fifthNote : ColorConfig.pitchBackground);\r\n        }\r\n\r\n        for (let j: number = 0; j < Config.pitchesPerOctave; j++) {\r\n\r\n            this._backgroundPitchRows[j].style.visibility = Config.scales[this._doc.song.scale].flags[j] ? \"visible\" : \"hidden\";\r\n        }\r\n\r\n        if (this._doc.song.getChannelIsNoise(this._doc.channel)) {\r\n            if (!this._renderedDrums) {\r\n                this._renderedDrums = true;\r\n                this._renderedMod = false;\r\n                this._svgBackground.setAttribute(\"fill\", \"url(#patternEditorDrumBackground\" + this._barOffset + \")\");\r\n            }\r\n        } else if (this._doc.song.getChannelIsMod(this._doc.channel)) {\r\n            if (!this._renderedMod) {\r\n                this._renderedDrums = false;\r\n                this._renderedMod = true;\r\n                this._svgBackground.setAttribute(\"fill\", \"url(#patternEditorModBackground\" + this._barOffset + \")\");\r\n            }\r\n        } else {\r\n            if (this._renderedDrums || this._renderedMod) {\r\n                this._renderedDrums = false;\r\n                this._renderedMod = false;\r\n                this._svgBackground.setAttribute(\"fill\", \"url(#patternEditorNoteBackground\" + this._barOffset + \")\");\r\n            }\r\n        }\r\n\r\n        this._redrawNotePatterns();\r\n    }\r\n\r\n    private _redrawNotePatterns(): void {\r\n        this._svgNoteContainer = makeEmptyReplacementElement(this._svgNoteContainer);\r\n\r\n        if (this._doc.prefs.showChannels) {\r\n            if (!this._doc.song.getChannelIsMod(this._doc.channel)) {\r\n                for (let channel: number = this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount - 1; channel >= 0; channel--) {\r\n                    if (channel == this._doc.channel) continue;\r\n                    if (this._doc.song.getChannelIsNoise(channel) != this._doc.song.getChannelIsNoise(this._doc.channel)) continue;\r\n\r\n                    const pattern2: Pattern | null = this._doc.song.getPattern(channel, this._doc.bar + this._barOffset);\r\n                    if (pattern2 == null) continue;\r\n\r\n                    const octaveOffset: number = this._doc.getBaseVisibleOctave(channel) * Config.pitchesPerOctave;\r\n                    for (const note of pattern2.notes) {\r\n                        for (const pitch of note.pitches) {\r\n                            const notePath: SVGPathElement = SVG.path();\r\n                            notePath.setAttribute(\"fill\", ColorConfig.getChannelColor(this._doc.song, channel).secondaryNote);\r\n                            notePath.setAttribute(\"pointer-events\", \"none\");\r\n                            this._drawNote(notePath, pitch, note.start, note.pins, this._pitchHeight * 0.19, false, octaveOffset);\r\n                            this._svgNoteContainer.appendChild(notePath);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        if (this._pattern != null) {\r\n            const instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument(this._barOffset)];\r\n            const chord: Chord = instrument.getChord();\r\n            const transition: Transition = instrument.getTransition();\r\n            const displayNumberedChords: boolean = chord.customInterval || chord.arpeggiates || chord.strumParts > 0 || transition.slides;\r\n            for (const note of this._pattern.notes) {\r\n                let disabled: boolean = false;\r\n                if (this._doc.song.getChannelIsMod(this._doc.channel)) {\r\n                    const modIndex: number = instrument.modulators[Config.modCount - 1 - note.pitches[0]];\r\n                    if ((modIndex == Config.modulators.dictionary[\"none\"].index)\r\n                    || instrument.invalidModulators[Config.modCount - 1 - note.pitches[0]])\r\n                        disabled = true;\r\n                }\r\n                for (let i: number = 0; i < note.pitches.length; i++) {\r\n                    const pitch: number = note.pitches[i];\r\n                    let notePath: SVGPathElement = SVG.path();\r\n                    let colorPrimary: string = (disabled ? ColorConfig.disabledNotePrimary : ColorConfig.getChannelColor(this._doc.song, this._doc.channel).primaryNote);\r\n                    let colorSecondary: string = (disabled ? ColorConfig.disabledNoteSecondary : ColorConfig.getChannelColor(this._doc.song, this._doc.channel).secondaryNote);\r\n                    notePath.setAttribute(\"fill\", colorSecondary);\r\n                    notePath.setAttribute(\"pointer-events\", \"none\");\r\n                    this._drawNote(notePath, pitch, note.start, note.pins, (this._pitchHeight - this._pitchBorder) / 2 + 1, false, this._octaveOffset);\r\n                    this._svgNoteContainer.appendChild(notePath);\r\n                    notePath = SVG.path();\r\n                    notePath.setAttribute(\"fill\", colorPrimary);\r\n                    notePath.setAttribute(\"pointer-events\", \"none\");\r\n                    this._drawNote(notePath, pitch, note.start, note.pins, (this._pitchHeight - this._pitchBorder) / 2 + 1, true, this._octaveOffset);\r\n                    this._svgNoteContainer.appendChild(notePath);\r\n\r\n                    let indicatorOffset: number = 2;\r\n                    if (note.continuesLastPattern) {\r\n                        const arrowHeight: number = Math.min(this._pitchHeight, 20);\r\n                        let arrowPath: string;\r\n                        arrowPath = \"M \" + prettyNumber(this._partWidth * note.start + indicatorOffset) + \" \" + prettyNumber(this._pitchToPixelHeight(pitch - this._octaveOffset) - 0.1 * arrowHeight);\r\n                        arrowPath += \"L \" + prettyNumber(this._partWidth * note.start + indicatorOffset) + \" \" + prettyNumber(this._pitchToPixelHeight(pitch - this._octaveOffset) + 0.1 * arrowHeight);\r\n                        arrowPath += \"L \" + prettyNumber(this._partWidth * note.start + indicatorOffset + 4) + \" \" + prettyNumber(this._pitchToPixelHeight(pitch - this._octaveOffset) + 0.1 * arrowHeight);\r\n                        arrowPath += \"L \" + prettyNumber(this._partWidth * note.start + indicatorOffset + 4) + \" \" + prettyNumber(this._pitchToPixelHeight(pitch - this._octaveOffset) + 0.3 * arrowHeight);\r\n                        arrowPath += \"L \" + prettyNumber(this._partWidth * note.start + indicatorOffset + 12) + \" \" + prettyNumber(this._pitchToPixelHeight(pitch - this._octaveOffset));\r\n                        arrowPath += \"L \" + prettyNumber(this._partWidth * note.start + indicatorOffset + 4) + \" \" + prettyNumber(this._pitchToPixelHeight(pitch - this._octaveOffset) - 0.3 * arrowHeight);\r\n                        arrowPath += \"L \" + prettyNumber(this._partWidth * note.start + indicatorOffset + 4) + \" \" + prettyNumber(this._pitchToPixelHeight(pitch - this._octaveOffset) - 0.1 * arrowHeight);\r\n                        const arrow: SVGPathElement = SVG.path();\r\n                        arrow.setAttribute(\"d\", arrowPath);\r\n                        arrow.setAttribute(\"fill\", ColorConfig.invertedText);\r\n                        this._svgNoteContainer.appendChild(arrow);\r\n                        indicatorOffset += 12;\r\n                    }\r\n\r\n                    if (note.pitches.length > 1) {\r\n                        if (displayNumberedChords) {\r\n                            const oscillatorLabel: SVGTextElement = SVG.text();\r\n                            oscillatorLabel.setAttribute(\"x\", \"\" + prettyNumber(this._partWidth * note.start + indicatorOffset));\r\n                            oscillatorLabel.setAttribute(\"y\", \"\" + prettyNumber(this._pitchToPixelHeight(pitch - this._octaveOffset)));\r\n                            oscillatorLabel.setAttribute(\"width\", \"30\");\r\n                            oscillatorLabel.setAttribute(\"fill\", ColorConfig.invertedText);\r\n                            oscillatorLabel.setAttribute(\"text-anchor\", \"start\");\r\n                            oscillatorLabel.setAttribute(\"dominant-baseline\", \"central\");\r\n                            oscillatorLabel.setAttribute(\"pointer-events\", \"none\");\r\n                            oscillatorLabel.textContent = \"\" + (i + 1);\r\n                            this._svgNoteContainer.appendChild(oscillatorLabel);\r\n                        }\r\n                    }\r\n                }\r\n\r\n\r\n                if (this._doc.song.getChannelIsMod(this._doc.channel) && this._mouseDragging && !this._mouseHorizontal && note == this._cursor.curNote) {\r\n\r\n                    this.modDragValueLabel.style.setProperty(\"display\", \"\");\r\n                    this.modDragValueLabel.style.setProperty(\"pointer-events\", \"none\");\r\n                    this.modDragValueLabel.setAttribute(\"contenteditable\", \"false\");\r\n                    this.modDragValueLabel.style.setProperty(\"color\", \"#FFFFFF\");\r\n                    let setting: number = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument(this._barOffset)].modulators[Config.modCount - 1 - note.pitches[0]];\r\n                    let presValue: number = this._dragSize + Config.modulators[setting].convertRealFactor;\r\n\r\n                    // This is me being too lazy to fiddle with the css to get it to align center.\r\n                    let xOffset: number = (+(presValue >= 10.0)) + (+(presValue >= 100.0)) + (+(presValue < 0.0)) + (+(presValue <= -10.0));\r\n\r\n                    this._modDragValueLabelWidth = 8 + xOffset * 8;\r\n                    this._modDragValueLabelLeft = +prettyNumber(Math.max(Math.min(this._editorWidth - 10 - xOffset * 8, this._partWidth * this._dragTime - 4 - xOffset * 4), 2));\r\n                    this._modDragValueLabelTop = +prettyNumber(this._pitchToPixelHeight(note.pitches[0] - this._octaveOffset) - 17 - (this._pitchHeight - this._pitchBorder) / 2);\r\n\r\n                    this.modDragValueLabel.style.setProperty(\"left\", \"\" + this._modDragValueLabelLeft + \"px\");\r\n                    this.modDragValueLabel.style.setProperty(\"top\", \"\" + this._modDragValueLabelTop + \"px\");\r\n                    this.modDragValueLabel.textContent = \"\" + presValue;\r\n\r\n                }\r\n            }\r\n        }\r\n\r\n        this._doc.currentPatternIsDirty = false;\r\n    }\r\n\r\n    private _drawNote(svgElement: SVGPathElement, pitch: number, start: number, pins: NotePin[], radius: number, showSize: boolean, offset: number): void {\r\n        const totalWidth: number = this._partWidth * (pins[pins.length - 1].time + pins[0].time);\r\n        const endOffset: number = 0.5 * Math.min(2, totalWidth - 1);\r\n\r\n        let nextPin: NotePin = pins[0];\r\n\r\n        const cap: number = this._doc.song.getVolumeCap(this._doc.song.getChannelIsMod(this._doc.channel), this._doc.channel, this._doc.getCurrentInstrument(this._barOffset), pitch);\r\n\r\n        let pathString: string = \"M \" + prettyNumber(this._partWidth * (start + nextPin.time) + endOffset) + \" \" + prettyNumber(this._pitchToPixelHeight(pitch - offset) + radius * (showSize ? nextPin.size / cap : 1.0)) + \" \";\r\n\r\n        for (let i: number = 1; i < pins.length; i++) {\r\n            let prevPin: NotePin = nextPin;\r\n            nextPin = pins[i];\r\n            let prevSide: number = this._partWidth * (start + prevPin.time) + (i == 1 ? endOffset : 0);\r\n            let nextSide: number = this._partWidth * (start + nextPin.time) - (i == pins.length - 1 ? endOffset : 0);\r\n            let prevHeight: number = this._pitchToPixelHeight(pitch + prevPin.interval - offset);\r\n            let nextHeight: number = this._pitchToPixelHeight(pitch + nextPin.interval - offset);\r\n            let prevSize: number = showSize ? prevPin.size / cap : 1.0;\r\n            let nextSize: number = showSize ? nextPin.size / cap : 1.0;\r\n            pathString += \"L \" + prettyNumber(prevSide) + \" \" + prettyNumber(prevHeight - radius * prevSize) + \" \";\r\n            if (prevPin.interval > nextPin.interval) pathString += \"L \" + prettyNumber(prevSide + 1) + \" \" + prettyNumber(prevHeight - radius * prevSize) + \" \";\r\n            if (prevPin.interval < nextPin.interval) pathString += \"L \" + prettyNumber(nextSide - 1) + \" \" + prettyNumber(nextHeight - radius * nextSize) + \" \";\r\n            pathString += \"L \" + prettyNumber(nextSide) + \" \" + prettyNumber(nextHeight - radius * nextSize) + \" \";\r\n        }\r\n        for (let i: number = pins.length - 2; i >= 0; i--) {\r\n            let prevPin: NotePin = nextPin;\r\n            nextPin = pins[i];\r\n            let prevSide: number = this._partWidth * (start + prevPin.time) - (i == pins.length - 2 ? endOffset : 0);\r\n            let nextSide: number = this._partWidth * (start + nextPin.time) + (i == 0 ? endOffset : 0);\r\n            let prevHeight: number = this._pitchToPixelHeight(pitch + prevPin.interval - offset);\r\n            let nextHeight: number = this._pitchToPixelHeight(pitch + nextPin.interval - offset);\r\n            let prevSize: number = showSize ? prevPin.size / cap : 1.0;\r\n            let nextSize: number = showSize ? nextPin.size / cap : 1.0;\r\n            pathString += \"L \" + prettyNumber(prevSide) + \" \" + prettyNumber(prevHeight + radius * prevSize) + \" \";\r\n            if (prevPin.interval < nextPin.interval) pathString += \"L \" + prettyNumber(prevSide - 1) + \" \" + prettyNumber(prevHeight + radius * prevSize) + \" \";\r\n            if (prevPin.interval > nextPin.interval) pathString += \"L \" + prettyNumber(nextSide + 1) + \" \" + prettyNumber(nextHeight + radius * nextSize) + \" \";\r\n            pathString += \"L \" + prettyNumber(nextSide) + \" \" + prettyNumber(nextHeight + radius * nextSize) + \" \";\r\n        }\r\n        pathString += \"z\";\r\n\r\n        svgElement.setAttribute(\"d\", pathString);\r\n    }\r\n\r\n    private _pitchToPixelHeight(pitch: number): number {\r\n        return this._pitchHeight * (this._pitchCount - (pitch) - 0.5);\r\n    }\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { Config } from \"../synth/SynthConfig\";\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { HTML, SVG } from \"imperative-html/dist/esm/elements-strict\";\r\nimport { ColorConfig } from \"./ColorConfig\";\r\nimport { Instrument } from \"../synth/synth\";\r\n\r\nexport class Piano {\r\n\t\tprivate readonly _pianoContainer: HTMLDivElement = HTML.div({style: \"width: 100%; height: 100%; display: flex; flex-direction: column-reverse; align-items: stretch;\"});\r\n\t\tprivate readonly _drumContainer: HTMLDivElement = HTML.div({style: \"width: 100%; height: 100%; display: flex; flex-direction: column-reverse; align-items: stretch;\"});\r\n\t\tprivate readonly _modContainer: HTMLDivElement = HTML.div({ style: \"width: 100%; height: 100%; display: flex; flex-direction: column-reverse; align-items: stretch;\" });\r\n\t\tprivate readonly _preview: HTMLDivElement = HTML.div({style: `width: 100%; height: 40px; border: 2px solid ${ColorConfig.primaryText}; position: absolute; box-sizing: border-box; pointer-events: none;`});\r\n\t\tpublic readonly container: HTMLDivElement = HTML.div({style: \"width: 32px; height: 100%; overflow: hidden; position: relative; flex-shrink: 0; touch-action: none;\"},\r\n\t\tthis._pianoContainer,\r\n\t\tthis._drumContainer,\r\n\t\tthis._modContainer,\r\n\t\tthis._preview,\r\n\t);\r\n\tprivate readonly _editorHeight: number = 481;\r\n\tprivate readonly _pianoKeys: HTMLDivElement[] = [];\r\n\tprivate readonly _pianoLabels: HTMLDivElement[] = [];\r\n\tprivate readonly _modFirstLabels: SVGTextElement[] = [];\r\n\tprivate readonly _modSecondLabels: SVGTextElement[] = [];\r\n\tprivate readonly _modCountLabels: SVGTextElement[] = [];\r\n\tprivate readonly _modCountRects: SVGRectElement[] = [];\r\n\t\t\r\n\tprivate _pitchHeight: number;\r\n\tprivate _pitchCount: number;\r\n\t//private _mouseX: number = 0;\r\n\tprivate _mouseY: number = 0;\r\n\tprivate _mouseDown: boolean = false;\r\n\tprivate _mouseOver: boolean = false;\r\n\tprivate _cursorPitch: number;\r\n\tprivate _playedPitch: number = -1;\r\n\tprivate _renderedScale: number = -1;\r\n\tprivate _renderedDrums: boolean = false;\r\n\tprivate _renderedMod: boolean = false;\r\n\tprivate _renderedKey: number = -1;\r\n\tprivate _renderedPitchCount: number = -1;\r\n\tprivate readonly _renderedLiveInputPitches: number[] = [];\r\n\t\r\n\t\t\r\n\tpublic forceRender(): void {\r\n\t\tthis._renderedScale = -1;\r\n\t\tthis._documentChanged();\r\n\t}\r\n\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\t\t\r\n\t\tfor (let i: number = 0; i < Config.drumCount; i++) {\r\n\t\t\tconst scale: number = (1.0 - (i / Config.drumCount) * 0.35) * 100;\r\n\t\t\tthis._drumContainer.appendChild(HTML.div({class: \"drum-button\", style: `background-size: ${scale}% ${scale}%;`}));\r\n\t\t}\r\n\t\t\t\r\n\t\tfor (let i: number = 0; i < Config.modCount; i++) {\r\n\r\n\r\n\t\t\tconst firstRowText: SVGTextElement = SVG.text({ class: \"modulator-label\", \"text-anchor\": \"left\", fill: ColorConfig.modLabelPrimaryText, style: \"font-weight: bold; align-self: flex-start; transform-origin: center; transform: rotate(-90deg) translate(-19px, 39px); font-size: 11px; font-family: sans-serif;\" });\r\n\t\t\tconst secondRowText: SVGTextElement = SVG.text({ class: \"modulator-label\", \"text-anchor\": \"left\", fill: ColorConfig.modLabelPrimaryText, style: \"font-weight: bold; align-self: flex-end; transform-origin: center; transform: rotate(-90deg) translate(-26px, 42px); font-size: 11px; font-family: sans-serif;\" });\r\n\t\t\tconst countText: SVGTextElement = SVG.text({ class: \"modulator-inverse-label\", fill: ColorConfig.modLabelPrimary, style: \"font-weight: bold; align-self: flex-start; transform-origin: center; transform: rotate(-90deg) translate(4px, 13px); font-size: 11px; font-family: sans-serif;\" });\r\n\t\t\tconst countRect: SVGRectElement = SVG.rect({ width: \"12px\", height: \"9px\", fill: ColorConfig.indicatorPrimary, style: \"pointer-events: none; transform: translate(4px, 4px);\" });\r\n\r\n\t\t\tconst firstRowSVG: SVGSVGElement = SVG.svg({ viewBox: \"0 0 16 66\", width: \"16px\", style: \"pointer-events: none; flex-grow: 1;\" }, [\r\n\t\t\t\tfirstRowText,\r\n\t\t\t]);\r\n\t\t\tconst countSVG: SVGSVGElement = SVG.svg({ viewBox: \"0 0 16 14\", width: \"16px\", style: \"pointer-events: none;\" }, [\r\n\t\t\t\tcountRect,\r\n\t\t\t\tcountText,\r\n\t\t\t]);\r\n\t\t\tconst secondRowSVG: SVGSVGElement = SVG.svg({ viewBox: \"0 0 16 80\", width: \"16px\", style: \"pointer-events: none;\" }, [\r\n\t\t\t\tsecondRowText,\r\n\t\t\t]);\r\n\r\n\t\t\tconst flexRow1: HTMLDivElement = HTML.div({ style: \"display: flex; flex-direction: column; justify-content: space-between; pointer-events: none;\" }, [\r\n\t\t\t\tcountSVG,\r\n\t\t\t\tfirstRowSVG,\r\n\t\t\t]);\r\n\t\t\tconst flexRow2: HTMLDivElement = HTML.div({ style: \"display: flex; flex-direction: column-reverse; justify-content: space-between; pointer-events: none;\" }, [\r\n\t\t\t\tsecondRowSVG,\r\n\t\t\t]);\r\n\r\n\t\t\tconst flexContainer: HTMLDivElement = HTML.div({ style: \"display: flex; flex-direction: row; justify-content: space-between; padding: 0px; width: 32px; height: 100%; overflow: hidden; pointer-events: none;\" }, [\r\n\t\t\t\tflexRow1,\r\n\t\t\t\tflexRow2,\r\n\t\t\t]);\r\n\r\n\t\t\tconst modKey: HTMLDivElement = HTML.div({ class: \"modulator-button\", style: \"background: \" + ColorConfig.modLabelPrimary + \";\" }, flexContainer);\r\n\t\t\tthis._modContainer.appendChild(modKey);\r\n\t\t\tthis._modFirstLabels.push(firstRowText);\r\n\t\t\tthis._modSecondLabels.push(secondRowText);\r\n\t\t\tthis._modCountLabels.push(countText);\r\n\t\t\tthis._modCountRects.push(countRect);\r\n\t\t}\r\n\r\n\t\tthis.container.addEventListener(\"mousedown\", this._whenMousePressed);\r\n\t\tdocument.addEventListener(\"mousemove\", this._whenMouseMoved);\r\n\t\tdocument.addEventListener(\"mouseup\", this._whenMouseReleased);\r\n\t\tthis.container.addEventListener(\"mouseover\", this._whenMouseOver);\r\n\t\tthis.container.addEventListener(\"mouseout\", this._whenMouseOut);\r\n\t\t\t\r\n\t\tthis.container.addEventListener(\"touchstart\", this._whenTouchPressed);\r\n\t\tthis.container.addEventListener(\"touchmove\", this._whenTouchMoved);\r\n\t\tthis.container.addEventListener(\"touchend\", this._whenTouchReleased);\r\n\t\tthis.container.addEventListener(\"touchcancel\", this._whenTouchReleased);\r\n\t\t\t\r\n\t\tthis._doc.notifier.watch(this._documentChanged);\r\n\t\tthis._documentChanged();\r\n\t\t\r\n\t\twindow.requestAnimationFrame(this._onAnimationFrame);\r\n\t}\r\n\t\t\r\n\tprivate _updateCursorPitch(): void {\r\n\t\tconst scale: ReadonlyArray<boolean> = Config.scales[this._doc.song.scale].flags;\r\n\t\t\tconst mousePitch: number = Math.max(0, Math.min(this._pitchCount-1, this._pitchCount - (this._mouseY / this._pitchHeight)));\r\n\t\tif (scale[Math.floor(mousePitch) % Config.pitchesPerOctave] || this._doc.song.getChannelIsNoise(this._doc.channel)) {\r\n\t\t\tthis._cursorPitch = Math.floor(mousePitch);\r\n\t\t} else {\r\n\t\t\tlet topPitch: number = Math.floor(mousePitch) + 1;\r\n\t\t\tlet bottomPitch: number = Math.floor(mousePitch) - 1;\r\n\t\t\twhile (!scale[topPitch % Config.pitchesPerOctave]) {\r\n\t\t\t\ttopPitch++;\r\n\t\t\t}\r\n\t\t\twhile (!scale[(bottomPitch) % Config.pitchesPerOctave]) {\r\n\t\t\t\tbottomPitch--;\r\n\t\t\t}\r\n\t\t\tlet topRange: number = topPitch;\r\n\t\t\tlet bottomRange: number = bottomPitch + 1;\r\n\t\t\tif (topPitch % Config.pitchesPerOctave == 0 || topPitch % Config.pitchesPerOctave == 7) {\r\n\t\t\t\ttopRange -= 0.5;\r\n\t\t\t}\r\n\t\t\tif (bottomPitch % Config.pitchesPerOctave == 0 || bottomPitch % Config.pitchesPerOctave == 7) {\r\n\t\t\t\tbottomRange += 0.5;\r\n\t\t\t}\r\n\t\t\tthis._cursorPitch = mousePitch - bottomRange > topRange - mousePitch ? topPitch : bottomPitch;\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tprivate _playLiveInput(): void {\r\n\t\tconst octaveOffset: number = this._doc.getBaseVisibleOctave(this._doc.channel) * Config.pitchesPerOctave;\r\n\t\tconst currentPitch: number = this._cursorPitch + octaveOffset;\r\n\t\tif (this._playedPitch == currentPitch) return;\r\n\t\tthis._doc.performance.removePerformedPitch(this._playedPitch);\r\n\t\tthis._playedPitch = currentPitch;\r\n\t\tthis._doc.performance.addPerformedPitch(currentPitch);\r\n\t}\r\n\t\t\r\n\tprivate _releaseLiveInput(): void {\r\n\t\tthis._doc.performance.removePerformedPitch(this._playedPitch);\r\n\t\tthis._playedPitch = -1;\r\n\t}\r\n\t\t\r\n\tprivate _whenMouseOver = (event: MouseEvent): void => {\r\n\t\tif (this._mouseOver) return;\r\n\t\tthis._mouseOver = true;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\t\r\n\tprivate _whenMouseOut = (event: MouseEvent): void => {\r\n\t\tif (!this._mouseOver) return;\r\n\t\tthis._mouseOver = false;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\t\r\n\tprivate _whenMousePressed = (event: MouseEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._doc.synth.maintainLiveInput();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this.container.getBoundingClientRect();\r\n\t\t//this._mouseX = (event.clientX || event.pageX) - boundingRect.left;\r\n\t\tthis._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._updateCursorPitch();\r\n\t\tthis._playLiveInput();\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\t\r\n\tprivate _whenMouseMoved = (event: MouseEvent): void => {\r\n\t\tif (this._mouseDown || this._mouseOver) this._doc.synth.maintainLiveInput();\r\n\t\tconst boundingRect: ClientRect = this.container.getBoundingClientRect();\r\n\t\t//this._mouseX = (event.clientX || event.pageX) - boundingRect.left;\r\n\t\tthis._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._updateCursorPitch();\r\n\t\tif (this._mouseDown) this._playLiveInput();\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\t\r\n\tprivate _whenMouseReleased = (event: MouseEvent): void => {\r\n\t\tif (this._mouseDown) this._releaseLiveInput();\r\n\t\tthis._mouseDown = false;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\t\r\n\tprivate _whenTouchPressed = (event: TouchEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._doc.synth.maintainLiveInput();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this.container.getBoundingClientRect();\r\n\t\t//this._mouseX = event.touches[0].clientX - boundingRect.left;\r\n\t\tthis._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._updateCursorPitch();\r\n\t\tthis._playLiveInput();\r\n\t}\r\n\t\t\r\n\tprivate _whenTouchMoved = (event: TouchEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._doc.synth.maintainLiveInput();\r\n\t\tconst boundingRect: ClientRect = this.container.getBoundingClientRect();\r\n\t\t//this._mouseX = event.touches[0].clientX - boundingRect.left;\r\n\t\tthis._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._updateCursorPitch();\r\n\t\tif (this._mouseDown) this._playLiveInput();\r\n\t}\r\n\t\t\r\n\tprivate _whenTouchReleased = (event: TouchEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._mouseDown = false;\r\n\t\tthis._releaseLiveInput();\r\n\t}\r\n\t\r\n\tprivate _onAnimationFrame = (): void => {\r\n\t\twindow.requestAnimationFrame(this._onAnimationFrame);\r\n\t\t\r\n\t\tlet liveInputChanged: boolean = false;\r\n\t\tconst liveInputPitchCount: number = !this._doc.performance.pitchesAreTemporary() ? this._doc.synth.liveInputPitches.length : 0;\r\n\t\tif (this._renderedLiveInputPitches.length != liveInputPitchCount) {\r\n\t\t\tliveInputChanged = true;\r\n\t\t}\r\n\t\tfor (let i: number = 0; i < liveInputPitchCount; i++) {\r\n\t\t\tif (this._renderedLiveInputPitches[i] != this._doc.synth.liveInputPitches[i]) {\r\n\t\t\t\tthis._renderedLiveInputPitches[i] = this._doc.synth.liveInputPitches[i];\r\n\t\t\t\tliveInputChanged = true;\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis._renderedLiveInputPitches.length = liveInputPitchCount;\r\n\t\t\r\n\t\tif (liveInputChanged) {\r\n\t\t\tthis._updatePreview();\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _updatePreview(): void {\r\n\t\tthis._preview.style.visibility = (!this._mouseOver || this._mouseDown) ? \"hidden\" : \"visible\";\r\n\t\t\r\n\t\tif (this._mouseOver && !this._mouseDown) {\r\n\t\t\tconst boundingRect: ClientRect = this.container.getBoundingClientRect();\r\n\t\t\tconst pitchHeight: number = this._pitchHeight / (this._editorHeight / (boundingRect.bottom - boundingRect.top));\r\n\t\t\t\r\n\t\t\tthis._preview.style.left = \"0px\";\r\n\t\t\tthis._preview.style.top = pitchHeight * (this._pitchCount - this._cursorPitch - 1) + \"px\";\r\n\t\t\tthis._preview.style.height = pitchHeight + \"px\";\r\n\t\t}\r\n\t\t\r\n\t\tconst octaveOffset: number = this._doc.getBaseVisibleOctave(this._doc.channel) * Config.pitchesPerOctave;\r\n\t\tconst container: HTMLDivElement = this._doc.song.getChannelIsNoise(this._doc.channel) ? this._drumContainer : this._pianoContainer;\r\n\t\tconst children: HTMLCollection = container.children;\r\n\t\tfor (let i: number = 0; i < children.length; i++) {\r\n\t\t\tconst child: Element = children[i];\r\n\t\t\tif (this._renderedLiveInputPitches.indexOf(i + octaveOffset) == -1) {\r\n\t\t\t\tchild.classList.remove(\"pressed\");\r\n\t\t\t} else {\r\n\t\t\t\tchild.classList.add(\"pressed\");\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _documentChanged = (): void => {\r\n\t\tconst isDrum: boolean = this._doc.song.getChannelIsNoise(this._doc.channel);\r\n\t\tconst isMod: boolean = this._doc.song.getChannelIsMod(this._doc.channel);\r\n\t\tthis._pitchCount = isMod ? Config.modCount : ( isDrum ? Config.drumCount : this._doc.getVisiblePitchCount() );\r\n\r\n\t\tthis._pitchHeight = this._editorHeight / this._pitchCount;\r\n\t\tthis._updateCursorPitch();\r\n\t\tif (this._mouseDown) this._playLiveInput();\r\n\t\t\r\n\t\tif (!this._doc.prefs.showLetters) return;\r\n\t\tif (this._renderedScale == this._doc.song.scale && this._renderedKey == this._doc.song.key && this._renderedDrums == isDrum && this._renderedMod == isMod && this._renderedPitchCount == this._pitchCount) return;\r\n\t\t\r\n\t\tthis._renderedScale = this._doc.song.scale;\r\n\t\tthis._renderedKey = this._doc.song.key;\r\n\t\tthis._renderedDrums = isDrum;\r\n\t\tthis._renderedMod = isMod;\r\n\t\tconst instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\t\r\n\t\tthis._pianoContainer.style.display = (isDrum || isMod) ? \"none\" : \"flex\";\r\n\t\tthis._drumContainer.style.display = isDrum ? \"flex\" : \"none\";\r\n\t\tthis._modContainer.style.display = isMod ? \"flex\" : \"none\";\r\n\t\t\r\n\t\tif (!isDrum && !isMod) {\r\n\t\t\tif (this._renderedPitchCount != this._pitchCount) {\r\n\t\t\t\tthis._pianoContainer.innerHTML = \"\";\r\n\t\t\t\tfor (let i: number = 0; i < this._pitchCount; i++) {\r\n\t\t\t\t\tconst pianoLabel: HTMLDivElement = HTML.div({class: \"piano-label\", style: \"font-weight: bold; -webkit-text-stroke-width: 0; font-size: 11px; font-family: sans-serif; position: absolute; padding-left: 15px;\"});\r\n\t\t\t\t\tconst pianoKey: HTMLDivElement = HTML.div({class: \"piano-button\", style: \"background: gray;\"}, pianoLabel);\r\n\t\t\t\t\tthis._pianoContainer.appendChild(pianoKey);\r\n\t\t\t\t\tthis._pianoLabels[i] = pianoLabel;\r\n\t\t\t\t\tthis._pianoKeys[i] = pianoKey;\r\n\t\t\t\t}\r\n\t\t\t\tthis._pianoLabels.length = this._pitchCount;\r\n\t\t\t\tthis._pianoKeys.length = this._pitchCount;\r\n\t\t\t\tthis._renderedPitchCount = this._pitchCount;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tfor (let j: number = 0; j < this._pitchCount; j++) {\r\n\t\t\t\tconst pitchNameIndex: number = (j + Config.keys[this._doc.song.key].basePitch) % Config.pitchesPerOctave;\r\n\t\t\t\tconst isWhiteKey: boolean = Config.keys[pitchNameIndex].isWhiteKey;\r\n\t\t\t\tthis._pianoKeys[j].style.background = isWhiteKey ? ColorConfig.whitePianoKey : ColorConfig.blackPianoKey;\r\n\t\t\t\tif (!Config.scales[this._doc.song.scale].flags[j % Config.pitchesPerOctave]) {\r\n\t\t\t\t\tthis._pianoKeys[j].classList.add(\"disabled\");\r\n\t\t\t\t\tthis._pianoLabels[j].style.display = \"none\";\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis._pianoKeys[j].classList.remove(\"disabled\");\r\n\t\t\t\t\tthis._pianoLabels[j].style.display = \"\";\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tconst label: HTMLDivElement = this._pianoLabels[j];\r\n\r\n\t\t\t\t\tif ((j % 12) == 0) {\r\n\t\t\t\t\t\tlabel.style.transform = \"translate(-5px, 0px)\";\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tlabel.style.transform = \"translate(0px, 0px)\";\r\n\t\t\t\t\t}\r\n\r\n\r\n\t\t\t\t\tlabel.style.color = Config.keys[pitchNameIndex].isWhiteKey ? \"black\" : \"white\";\r\n\t\t\t\t\tlabel.textContent = Piano.getPitchName(pitchNameIndex, j, this._doc.getBaseVisibleOctave(this._doc.channel));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\telse if (isMod) {\r\n\t\t\tlet firstRow: string = \"\";\r\n\t\t\tlet secondRow: string = \"\";\r\n\t\t\tlet useFirstColor: string = ColorConfig.modLabelPrimaryText;\r\n\t\t\tlet useSecondColor: string = ColorConfig.modLabelSecondaryText;\r\n\t\t\tfor (let j: number = 0; j < Config.modCount; j++) {\r\n\r\n\t\t\t\tlet usingSecondRow: boolean = true;\r\n\t\t\t\tlet usingMod: boolean = true;\r\n\t\t\t\tlet instrumentVal: number = instrument.modInstruments[Config.modCount - j - 1] + 1;\r\n\t\t\t\tlet channelVal: number = instrument.modChannels[Config.modCount - j - 1] + 1;\r\n\t\t\t\tlet modulator: number = instrument.modulators[Config.modCount - j - 1];\r\n\t\t\t\tlet status: number = 1 + +(channelVal - 1 >= this._doc.song.pitchChannelCount);\r\n\t\t\t\tif (instrument.modChannels[Config.modCount - j - 1] == -2)\r\n\t\t\t\t\tstatus = 0;\r\n\t\t\t\telse if (instrument.modChannels[Config.modCount - j - 1] == -1)\r\n\t\t\t\t\tstatus = 3;\r\n\t\t\t\tlet instrumentsLength: number = this._doc.song.channels[Math.max(0,channelVal - 1)].instruments.length;\r\n\t\t\t\t// 0 - none\r\n\t\t\t\t// 1 - pitch\r\n\t\t\t\t// 2 - noise\r\n\t\t\t\t// 3 - song\r\n\r\n\r\n\t\t\t\tswitch (status) {\r\n\t\t\t\t\tcase 0:\r\n\t\t\t\t\t\tfirstRow = \"Mod\"\r\n\t\t\t\t\t\tusingSecondRow = false;\r\n\t\t\t\t\t\tuseSecondColor = ColorConfig.modLabelSecondaryText;\r\n\t\t\t\t\t\tusingMod = false;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 1:\r\n\t\t\t\t\t\tif (this._doc.song.channels[channelVal - 1].name == \"\") {\r\n\r\n\t\t\t\t\t\t\tif (instrumentsLength > 1) {\r\n\t\t\t\t\t\t\t\tif (channelVal >= 10 || instrumentVal >= 10) {\r\n\t\t\t\t\t\t\t\t\tfirstRow = \"P\" + channelVal;\r\n\t\t\t\t\t\t\t\t\tif (instrumentVal - 1 == instrumentsLength) {\r\n\t\t\t\t\t\t\t\t\t\tfirstRow += \" All\";\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\telse if (instrumentVal - 1 > instrumentsLength) {\r\n\t\t\t\t\t\t\t\t\t\tfirstRow += \" Act\";\r\n\t\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\t\tfirstRow += \" I\" + instrumentVal;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\t\tfirstRow = \"Pitch\" + channelVal;\r\n\t\t\t\t\t\t\t\t\tif (instrumentVal-1 == instrumentsLength) {\r\n\t\t\t\t\t\t\t\t\t\tfirstRow += \" All\";\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\telse if (instrumentVal - 1 > instrumentsLength) {\r\n\t\t\t\t\t\t\t\t\t\tfirstRow += \" Act\";\r\n\t\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\t\tfirstRow += \" Ins\" + instrumentVal;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\tfirstRow = \"Pitch \" + channelVal;\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t} else {\r\n\r\n\t\t\t\t\t\t\t// Channel name display\r\n\t\t\t\t\t\t\tlet insText: string;\r\n\t\t\t\t\t\t\tif (instrumentVal - 1 == instrumentsLength) {\r\n\t\t\t\t\t\t\t\tinsText = \" All\";\r\n\t\t\t\t\t\t\t} else if (instrumentVal - 1 > instrumentsLength) {\r\n\t\t\t\t\t\t\t\tinsText = \" Act\";\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tinsText = \" I\" + instrumentVal;\r\n                            }\r\n\t\t\t\t\t\t\tif (instrumentsLength > 1) {\r\n\t\t\t\t\t\t\t\tfirstRow = \"P\" + channelVal + \" \" + this._doc.song.channels[channelVal - 1].name + insText;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\tfirstRow = \"P\" + channelVal + \" \" + this._doc.song.channels[channelVal - 1].name;\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 2:\r\n\t\t\t\t\t\tchannelVal = instrument.modChannels[Config.modCount - j - 1] + 1 - this._doc.song.pitchChannelCount;\r\n\t\t\t\t\t\tinstrumentsLength = this._doc.song.channels[channelVal - 1].instruments.length;\r\n\r\n\t\t\t\t\t\tif (this._doc.song.channels[channelVal - 1].name == \"\") {\r\n\r\n\t\t\t\t\t\t\tif (instrumentsLength > 1) {\r\n\r\n\t\t\t\t\t\t\t\tif (channelVal >= 10 || instrumentVal >= 10) {\r\n\t\t\t\t\t\t\t\t\tfirstRow = \"N\" + channelVal;\r\n\t\t\t\t\t\t\t\t\tif (instrumentVal - 1 == instrumentsLength) {\r\n\t\t\t\t\t\t\t\t\t\tfirstRow += \" All\";\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\telse if (instrumentVal - 1 > instrumentsLength) {\r\n\t\t\t\t\t\t\t\t\t\tfirstRow += \" Act\";\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\t\t\tfirstRow += \" I\" + instrumentVal;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\t\tfirstRow = \"Noise\" + channelVal;\r\n\t\t\t\t\t\t\t\t\tif (instrumentVal - 1 == instrumentsLength) {\r\n\t\t\t\t\t\t\t\t\t\tfirstRow += \" All\";\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\telse if (instrumentVal - 1 > instrumentsLength) {\r\n\t\t\t\t\t\t\t\t\t\tfirstRow += \" Act\";\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\t\t\tfirstRow += \" Ins\" + instrumentVal;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\tfirstRow = \"Noise \" + channelVal;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} else {\r\n\r\n\t\t\t\t\t\t\t// Channel name display\r\n\t\t\t\t\t\t\tif (instrumentsLength > 1) {\r\n\t\t\t\t\t\t\t\tlet insText: string;\r\n\t\t\t\t\t\t\t\tif (instrumentVal - 1 == instrumentsLength) {\r\n\t\t\t\t\t\t\t\t\tinsText = \" All\";\r\n\t\t\t\t\t\t\t\t} else if (instrumentVal - 1 > instrumentsLength) {\r\n\t\t\t\t\t\t\t\t\tinsText = \" Act\";\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tinsText = \" I\" + instrumentVal;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tfirstRow = \"N\" + channelVal + \" \" + this._doc.song.channels[channelVal - 1].name + insText;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\tfirstRow = \"N\" + channelVal + \" \" + this._doc.song.channels[channelVal - 1].name;\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 3:\r\n\t\t\t\t\t\tfirstRow = \"Song\";\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// When unused, show name of mod on second row\r\n\t\t\t\tif (usingSecondRow) {\r\n\t\t\t\t\tsecondRow = Config.modulators[modulator].pianoName;\r\n\t\t\t\t\tif (modulator == Config.modulators.dictionary[\"none\"].index) {\r\n\t\t\t\t\t\tuseSecondColor = ColorConfig.modLabelSecondaryText;\r\n\t\t\t\t\t\tusingMod = false;\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if (modulator == Config.modulators.dictionary[\"eq filter\"].index || modulator == Config.modulators.dictionary[\"note filter\"].index) {\r\n\t\t\t\t\t\tvar text = \" Morph\";\r\n\t\t\t\t\t\tvar filterVal = instrument.modFilterTypes[Config.modCount - j - 1];\r\n\t\t\t\t\t\tif (filterVal > 0 && (filterVal % 2)) {\r\n\t\t\t\t\t\t\ttext = \" Dot\" + Math.ceil(filterVal / 2) + \"X\";\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse if (filterVal > 0) {\r\n\t\t\t\t\t\t\ttext = \" Dot\" + Math.ceil(filterVal / 2) + \"Y\";\r\n                        }\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tsecondRow += text;\r\n                    }\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst firstLabel: SVGTextElement = this._modFirstLabels[j];\r\n\t\t\t\tconst secondLabel: SVGTextElement = this._modSecondLabels[j];\r\n\t\t\t\tconst modCountLabel: SVGTextElement = this._modCountLabels[j];\r\n\t\t\t\tconst modCountRect: SVGRectElement = this._modCountRects[j];\r\n\t\t\t\tfirstLabel.style.fill = useFirstColor;\r\n\t\t\t\tfirstLabel.textContent = firstRow;\r\n\t\t\t\tsecondLabel.style.fill = useSecondColor;\r\n\t\t\t\tsecondLabel.textContent = usingSecondRow ? secondRow : \"Not set\";\r\n\t\t\t\tmodCountLabel.textContent = \"\" + (Config.modCount - j);\r\n\t\t\t\tmodCountRect.style.fill = usingMod ? ColorConfig.indicatorPrimary : ColorConfig.modLabelSecondaryText;\r\n\r\n\t\t\t\t// Check if text is too long, if name is set\r\n\t\t\t\tif (this._doc.song.channels[Math.max(0,instrument.modChannels[Config.modCount - j - 1])].name != \"\") {\r\n\t\t\t\t\tlet scaleFactor: string = \"1\";\r\n\t\t\t\t\tlet height: number = firstLabel.parentElement!.parentElement!.getBoundingClientRect().height;\r\n\t\t\t\t\tlet length: number = firstLabel.getComputedTextLength();\r\n\t\t\t\t\tlet squeeze: number = 0;\r\n\t\t\t\t\tif (length > height - 8) {\r\n\t\t\t\t\t\tscaleFactor = \"0.65\";\r\n\t\t\t\t\t\tsqueeze = 2;\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if (length > height - 24) {\r\n\t\t\t\t\t\tscaleFactor = \"0.8\";\r\n\t\t\t\t\t\tsqueeze = 1;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfirstLabel.style.transform = \"rotate(-90deg) translate(\" + (-20 - squeeze - Math.round(Math.max(0, (height - 80) / 2))) + \"px, 39px) scale(\" + scaleFactor + \", 1)\";\r\n\t\t\t\t\t// Truncate end of string if it's too long, but keep instrument num\r\n\t\t\t\t\twhile (scaleFactor == \"0.65\" && firstLabel.getComputedTextLength() > height + 8) {\r\n\t\t\t\t\t\tvar offset = 4 + (instrumentVal >= 10 ? 1 : 0);\r\n\t\t\t\t\t\tfirstLabel.textContent = firstLabel.textContent.substr(0, firstLabel.textContent.length - offset) + firstLabel.textContent.substr(firstLabel.textContent.length - offset + 1);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tlet height: number = firstLabel.parentElement!.parentElement!.getBoundingClientRect().height;\r\n\t\t\t\t\tfirstLabel.style.transform = \"rotate(-90deg) translate(\" + (-20 - Math.round(Math.max(0, (height - 80) / 2))) + \"px, 39px) scale(1, 1)\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis._updatePreview();\r\n\t}\r\n\r\n\tpublic static getPitchName(pitchNameIndex: number, scaleIndex: number, baseVisibleOctave: number): string {\r\n\t\tlet text: string;\r\n\r\n\t\tif (Config.keys[pitchNameIndex].isWhiteKey) {\r\n\t\t\ttext = Config.keys[pitchNameIndex].name;\r\n\t\t} else {\r\n\t\t\tconst shiftDir: number = Config.blackKeyNameParents[scaleIndex % Config.pitchesPerOctave];\r\n\t\t\ttext = Config.keys[(pitchNameIndex + Config.pitchesPerOctave + shiftDir) % Config.pitchesPerOctave].name;\r\n\t\t\tif (shiftDir == 1) {\r\n\t\t\t\ttext += \"♭\";\r\n\t\t\t} else if (shiftDir == -1) {\r\n\t\t\t\ttext += \"♯\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (scaleIndex % 12 == 0) {\r\n\t\t\ttext += Math.floor(scaleIndex / 12) + baseVisibleOctave;\r\n\t\t}\r\n\r\n\t\treturn text;\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { Config } from \"../synth/SynthConfig\";\r\nimport { HTML } from \"imperative-html/dist/esm/elements-strict\";\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { Prompt } from \"./Prompt\";\r\nimport { ChangeGroup } from \"./Change\";\r\nimport { ChangeBarCount } from \"./changes\";\r\nimport { ColorConfig } from \"./ColorConfig\";\r\n\r\n\tconst {button, div, span, h2, input, br, select, option} = HTML;\r\n\r\nexport class SongDurationPrompt implements Prompt {\r\n\t\tprivate readonly _barsStepper: HTMLInputElement = input({style: \"width: 3em; margin-left: 1em;\", type: \"number\", step: \"1\"});\r\n\t\tprivate readonly _positionSelect: HTMLSelectElement = select({style: \"width: 100%;\"},\r\n\t\t\toption({value: \"end\"},       \"Apply change at end of song.\"),\r\n\t\t\toption({value: \"beginning\"}, \"Apply change at beginning of song.\"),\r\n\t);\r\n\t\tprivate readonly _cancelButton: HTMLButtonElement = button({class: \"cancelButton\"});\r\n\t\tprivate readonly _okayButton: HTMLButtonElement = button({class: \"okayButton\", style: \"width:45%;\"}, \"Okay\");\r\n\t\t\r\n\t\tpublic readonly container: HTMLDivElement = div({class: \"prompt noSelection\", style: \"width: 250px;\"},\r\n\t\th2(\"Song Length\"),\r\n\t\t\tdiv({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\tdiv({style: \"display: inline-block; text-align: right;\"},\r\n\t\t\t\t\"Bars per song:\",\r\n\t\t\t\tbr(),\r\n\t\t\t\t\tspan({style: `font-size: smaller; color: ${ColorConfig.secondaryText};`}, \"(Multiples of 4 are recommended)\"),\r\n\r\n\t\t\t),\r\n\t\t\tthis._barsStepper,\r\n\t\t),\r\n\t\t\tdiv({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\tdiv({class: \"selectContainer\", style: \"width: 100%;\"}, this._positionSelect),\r\n\t\t),\r\n\t\t\tdiv({style: \"display: flex; flex-direction: row-reverse; justify-content: space-between;\"},\r\n\t\t\tthis._okayButton,\r\n\t\t),\r\n\t\tthis._cancelButton,\r\n\t);\r\n\t\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\r\n\t\tthis._barsStepper.value = this._doc.song.barCount + \"\";\r\n\t\tthis._barsStepper.min = Config.barCountMin + \"\";\r\n\t\tthis._barsStepper.max = Config.barCountMax + \"\";\r\n\t\t\t\r\n\t\tconst lastPosition: string | null = window.localStorage.getItem(\"barCountPosition\");\r\n\t\tif (lastPosition != null) {\r\n\t\t\tthis._positionSelect.value = lastPosition;\r\n\t\t}\r\n\t\t\t\r\n\t\tthis._barsStepper.select();\r\n\t\t\tsetTimeout(()=>this._barsStepper.focus());\r\n\t\t\t\r\n\t\tthis._okayButton.addEventListener(\"click\", this._saveChanges);\r\n\t\tthis._cancelButton.addEventListener(\"click\", this._close);\r\n\t\tthis._barsStepper.addEventListener(\"keypress\", SongDurationPrompt._validateKey);\r\n\t\tthis._barsStepper.addEventListener(\"blur\", SongDurationPrompt._validateNumber);\r\n\t\tthis.container.addEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\t\t\r\n\t\tprivate _close = (): void => { \r\n\t\tthis._doc.undo();\r\n\t}\r\n\t\t\r\n\tpublic cleanUp = (): void => {\r\n\t\tthis._okayButton.removeEventListener(\"click\", this._saveChanges);\r\n\t\tthis._cancelButton.removeEventListener(\"click\", this._close);\r\n\t\tthis._barsStepper.removeEventListener(\"keypress\", SongDurationPrompt._validateKey);\r\n\t\tthis._barsStepper.removeEventListener(\"blur\", SongDurationPrompt._validateNumber);\r\n\t\tthis.container.removeEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\t\t\r\n\tprivate _whenKeyPressed = (event: KeyboardEvent): void => {\r\n\t\t\tif ((<Element> event.target).tagName != \"BUTTON\" && event.keyCode == 13) { // Enter key\r\n\t\t\tthis._saveChanges();\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tprivate static _validateKey(event: KeyboardEvent): boolean {\r\n\t\tconst charCode = (event.which) ? event.which : event.keyCode;\r\n\t\tif (charCode != 46 && charCode > 31 && (charCode < 48 || charCode > 57)) {\r\n\t\t\tevent.preventDefault();\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\t\t\r\n\tprivate static _validateNumber(event: Event): void {\r\n\t\tconst input: HTMLInputElement = <HTMLInputElement>event.target;\r\n\t\tinput.value = String(SongDurationPrompt._validate(input));\r\n\t}\r\n\t\t\r\n\tprivate static _validate(input: HTMLInputElement): number {\r\n\t\treturn Math.floor(Math.max(Number(input.min), Math.min(Number(input.max), Number(input.value))));\r\n\t}\r\n\t\t\r\n\tprivate _saveChanges = (): void => {\r\n\t\twindow.localStorage.setItem(\"barCountPosition\", this._positionSelect.value);\r\n\t\tconst group: ChangeGroup = new ChangeGroup();\r\n\t\tgroup.append(new ChangeBarCount(this._doc, SongDurationPrompt._validate(this._barsStepper), this._positionSelect.value == \"beginning\"));\r\n\t\tthis._doc.prompt = null;\r\n\t\tthis._doc.record(group, true);\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { Dictionary } from \"../synth/SynthConfig\";\r\nimport { Song } from \"../synth/synth\";\r\n\r\n\t\r\nexport interface RecoveredVersion {\r\n\tuid: string;\r\n\ttime: number;\r\n\tname: string;\r\n\twork: number;\r\n}\r\n\r\nexport interface RecoveredSong {\r\n\tversions: RecoveredVersion[];\r\n}\r\n\r\nconst versionPrefix = \"songVersion: \";\r\nconst maximumSongCount = 8;\r\nconst maximumWorkPerVersion = 3 * 60 * 1000; // 3 minutes\r\nconst minimumWorkPerSpan = 1 * 60 * 1000; // 1 minute\r\n\r\nfunction keyIsVersion(key: string): boolean {\r\n\treturn key.indexOf(versionPrefix) == 0;\r\n}\r\n\r\nfunction keyToVersion(key: string): RecoveredVersion {\r\n\treturn JSON.parse(key.substring(versionPrefix.length));\r\n}\r\n\r\nexport function versionToKey(version: RecoveredVersion): string {\r\n\treturn versionPrefix + JSON.stringify(version);\r\n}\r\n\r\nexport function generateUid(): string {\r\n\t// Not especially robust, but simple and effective!\r\n\treturn ((Math.random() * (-1 >>> 0)) >>> 0).toString(32);\r\n}\r\n\r\nfunction compareSongs(a: RecoveredSong, b: RecoveredSong): number {\r\n\treturn b.versions[0].time - a.versions[0].time;\r\n}\r\n\r\nfunction compareVersions(a: RecoveredVersion, b: RecoveredVersion): number {\r\n\treturn b.time - a.time;\r\n}\r\n\t\t\r\nexport class SongRecovery {\r\n\tprivate _saveVersionTimeoutHandle: ReturnType<typeof setTimeout>;\r\n\t\t\r\n\tprivate _song: Song = new Song();\r\n\t\t\r\n\tpublic static getAllRecoveredSongs(): RecoveredSong[] {\r\n\t\tconst songs: RecoveredSong[] = [];\r\n\t\tconst songsByUid: Dictionary<RecoveredSong> = {};\r\n\t\tfor (let i = 0; i < localStorage.length; i++) {\r\n\t\t\tconst itemKey: string = localStorage.key(i)!;\r\n\t\t\tif (keyIsVersion(itemKey)) {\r\n\t\t\t\tconst version: RecoveredVersion = keyToVersion(itemKey);\r\n\t\t\t\tlet song: RecoveredSong | undefined = songsByUid[version.uid];\r\n\t\t\t\tif (song == undefined) {\r\n\t\t\t\t\t\tsong = {versions: []};\r\n\t\t\t\t\tsongsByUid[version.uid] = song;\r\n\t\t\t\t\tsongs.push(song);\r\n\t\t\t\t}\r\n\t\t\t\tsong.versions.push(version);\r\n\t\t\t}\r\n\t\t}\r\n\t\tfor (const song of songs) {\r\n\t\t\tsong.versions.sort(compareVersions);\r\n\t\t}\r\n\t\tsongs.sort(compareSongs);\r\n\t\treturn songs;\r\n\t}\r\n\t\t\r\n\tpublic saveVersion(uid: string, name: string, songData: string): void {\r\n\t\tconst newName: string = name;\r\n\t\tconst newTime: number = Math.round(Date.now());\r\n\t\t\t\r\n\t\tclearTimeout(this._saveVersionTimeoutHandle);\r\n\t\tthis._saveVersionTimeoutHandle = setTimeout((): void => {\r\n\t\t\ttry {\r\n\t\t\t\t// Ensure that the song is not corrupted.\r\n\t\t\t\tthis._song.fromBase64String(songData);\r\n\t\t\t} catch (error) {\r\n\t\t\t\twindow.alert(\"Whoops, the song data appears to have been corrupted! Please try to recover the last working version of the song from the \\\"Recover Recent Song...\\\" option in BeepBox's \\\"File\\\" menu.\");\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t\t\r\n\t\t\tconst songs: RecoveredSong[] = SongRecovery.getAllRecoveredSongs();\r\n\t\t\tlet currentSong: RecoveredSong | null = null;\r\n\t\t\tfor (const song of songs) {\r\n\t\t\t\tif (song.versions[0].uid == uid) {\r\n\t\t\t\t\tcurrentSong = song;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (currentSong == null) {\r\n\t\t\t\t\tcurrentSong = {versions: []};\r\n\t\t\t\tsongs.unshift(currentSong);\r\n\t\t\t}\r\n\t\t\tlet versions: RecoveredVersion[] = currentSong.versions;\r\n\t\t\t\t\r\n\t\t\tlet newWork: number = 1000; // default to 1 second of work for the first change.\r\n\t\t\tif (versions.length > 0) {\r\n\t\t\t\tconst mostRecentTime: number = versions[0].time;\r\n\t\t\t\tconst mostRecentWork: number = versions[0].work;\r\n\t\t\t\tnewWork = mostRecentWork + Math.min(maximumWorkPerVersion, newTime - mostRecentTime);\r\n\t\t\t}\r\n\t\t\t\t\r\n\t\t\tconst newVersion: RecoveredVersion = { uid: uid, name: newName, time: newTime, work: newWork };\r\n\t\t\tconst newKey: string = versionToKey(newVersion);\r\n\t\t\tversions.unshift(newVersion);\r\n\t\t\tlocalStorage.setItem(newKey, songData);\r\n\t\t\t\t\r\n\t\t\t// Consider deleting an old version to free up space.\r\n\t\t\tlet minSpan: number = minimumWorkPerSpan; // start out with a gap between versions.\r\n\t\t\tconst spanMult: number = Math.pow(2, 1 / 2); // Double the span every 2 versions back.\r\n\t\t\tfor (var i: number = 1; i < versions.length; i++) {\r\n\t\t\t\tconst currentWork: number = versions[i].work;\r\n\t\t\t\tconst olderWork: number = (i == versions.length - 1) ? 0.0 : versions[i + 1].work;\r\n\t\t\t\t// If not enough work happened between two versions, discard one of them.\r\n\t\t\t\tif (currentWork - olderWork < minSpan) {\r\n\t\t\t\t\tlet indexToDiscard: number = i;\r\n\t\t\t\t\tif (i < versions.length - 1) {\r\n\t\t\t\t\t\tconst currentTime: number = versions[i].time;\r\n\t\t\t\t\t\tconst newerTime: number = versions[i - 1].time;\r\n\t\t\t\t\t\tconst olderTime: number = versions[i + 1].time;\r\n\t\t\t\t\t\t// Weird heuristic: Between the three adjacent versions, prefer to keep\r\n\t\t\t\t\t\t// the newest and the oldest, discarding the middle one (i), unless\r\n\t\t\t\t\t\t// there is a large gap of time between the newest and middle one, in\r\n\t\t\t\t\t\t// which case the middle one represents the end of a span of work and is\r\n\t\t\t\t\t\t// thus more memorable.\r\n\t\t\t\t\t\tif ((currentTime - olderTime) < 0.5 * (newerTime - currentTime)) {\r\n\t\t\t\t\t\t\tindexToDiscard = i + 1;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tlocalStorage.removeItem(versionToKey(versions[indexToDiscard]));\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tminSpan *= spanMult;\r\n\t\t\t}\r\n\t\t\t\t\r\n\t\t\t// If there are too many songs, discard the least important ones.\r\n\t\t\t// Songs that are older, or have less work, are less important.\r\n\t\t\twhile (songs.length > maximumSongCount) {\r\n\t\t\t\tlet leastImportantSong: RecoveredSong | null = null;\r\n\t\t\t\tlet leastImportance: number = Number.POSITIVE_INFINITY;\r\n\t\t\t\tfor (let i: number = Math.round(maximumSongCount / 2); i < songs.length; i++) {\r\n\t\t\t\t\tconst song: RecoveredSong = songs[i];\r\n\t\t\t\t\tconst timePassed: number = newTime - song.versions[0].time;\r\n\t\t\t\t\t// Convert the time into a factor of 12 hours, add one, then divide by the result.\r\n\t\t\t\t\t// This creates a curve that starts at 1, and then gradually drops off.\r\n\t\t\t\t\tconst timeScale: number = 1.0 / ((timePassed / (12 * 60 * 60 * 1000)) + 1.0);\r\n\t\t\t\t\t// Add 5 minutes of work, to balance out simple songs a little bit.\r\n\t\t\t\t\tconst adjustedWork: number = song.versions[0].work + 5 * 60 * 1000;\r\n\t\t\t\t\tconst weight: number = adjustedWork * timeScale;\r\n\t\t\t\t\tif (leastImportance > weight) {\r\n\t\t\t\t\t\tleastImportance = weight;\r\n\t\t\t\t\t\tleastImportantSong = song;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tfor (const version of leastImportantSong!.versions) {\r\n\t\t\t\t\tlocalStorage.removeItem(versionToKey(version));\r\n\t\t\t\t}\r\n\t\t\t\tsongs.splice(songs.indexOf(leastImportantSong!), 1);\r\n\t\t\t}\r\n\t\t}, 750); // Wait 3/4 of a second before saving a version.\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { RecoveredSong, RecoveredVersion, SongRecovery, versionToKey } from \"./SongRecovery\";\r\nimport { Prompt } from \"./Prompt\";\r\nimport { HTML } from \"imperative-html/dist/esm/elements-strict\";\r\n\r\n\tconst {button, div, h2, p, select, option, iframe} = HTML;\r\n\r\nexport class SongRecoveryPrompt implements Prompt {\r\n\tprivate readonly _songContainer: HTMLDivElement = div();\r\n\t\tprivate readonly _cancelButton: HTMLButtonElement = button({class: \"cancelButton\"});\r\n\t\t\r\n\t\tpublic readonly container: HTMLDivElement = div({class: \"prompt\", style: \"width: 300px;\"},\r\n\t\th2(\"Song Recovery\"),\r\n\t\t\tdiv({style: \"max-height: 385px; overflow-y: auto;\"},\r\n\t\t\tp(\"This is a TEMPORARY list of songs you have recently modified. Please keep your own backups of songs you care about!\"),\r\n\t\t\tthis._songContainer,\r\n\t\t\tp(\"(If \\\"Display Song Data in URL\\\" is enabled in your preferences, then you may also be able to find song versions in your browser history. However, song recovery won't work if you were browsing in private/incognito mode.)\"),\r\n\t\t),\r\n\t\tthis._cancelButton,\r\n\t);\r\n\t\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis._cancelButton.addEventListener(\"click\", this._close);\r\n\t\t\t\r\n\t\tconst songs: RecoveredSong[] = SongRecovery.getAllRecoveredSongs();\r\n\t\t\t\r\n\t\tif (songs.length == 0) {\r\n\t\t\tthis._songContainer.appendChild(p(\"There are no recovered songs available yet. Try making a song!\"));\r\n\t\t}\r\n\t\t\t\r\n\t\tfor (const song of songs) {\r\n\t\t\t\tconst versionMenu: HTMLSelectElement = select({style: \"width: 100%;\"});\r\n\t\t\t\t\r\n\t\t\tfor (const version of song.versions) {\r\n\t\t\t\tversionMenu.appendChild(option({ value: version.time }, version.name + \": \" + new Date(version.time).toLocaleString()));\r\n\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tconst player: HTMLIFrameElement = iframe({style: \"width: 100%; height: 60px; border: none; display: block;\"});\r\n\t\t\t//player.src = \"player/#song=\" + window.localStorage.getItem(versionToKey(song.versions[0]));\r\n\t\t\t\tconst container: HTMLDivElement = div({style: \"margin: 4px 0;\"}, div({class: \"selectContainer\", style: \"width: 100%; margin: 2px 0;\"}, versionMenu), player);\r\n\t\t\tthis._songContainer.appendChild(container);\r\n\t\t\t\t\r\n\t\t\tversionMenu.addEventListener(\"change\", () => {\r\n\t\t\t\tconst version: RecoveredVersion = song.versions[versionMenu.selectedIndex];\r\n\t\t\t\t//player.contentWindow!.location.replace(\"player/#song=\" + window.localStorage.getItem(versionToKey(version)));\r\n\t\t\t\t//player.contentWindow!.dispatchEvent(new Event(\"hashchange\"));\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\t\t\r\n\t\tprivate _close = (): void => { \r\n\t\tthis._doc.undo();\r\n\t}\r\n\t\t\r\n\t\tpublic cleanUp = (): void => { \r\n\t\tthis._cancelButton.removeEventListener(\"click\", this._close);\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Config} from \"../synth/SynthConfig\";\r\nimport {EditorConfig} from \"./EditorConfig\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {Prompt} from \"./Prompt\";\r\nimport {HTML} from \"imperative-html/dist/esm/elements-strict\";\r\nimport {ColorConfig} from \"./ColorConfig\";\r\nimport {KeyboardLayout} from \"./KeyboardLayout\";\r\nimport {Piano} from \"./Piano\";\r\n\r\nconst {button, label, div, p, a, h2, input, select, option} = HTML;\r\n\r\nexport class RecordingSetupPrompt implements Prompt {\r\n\tprivate readonly _keyboardMode: HTMLSelectElement = select({style: \"width: 100%;\"},\r\n\t\toption({value: \"useCapsLockForNotes\"}, \"simple shortcuts, use caps lock to play notes\"),\r\n\t\toption({value: \"pressControlForShortcuts\"}, \"simple notes, press \" + EditorConfig.ctrlName + \" for shortcuts\"),\r\n\t);\r\n\tprivate readonly _keyboardLayout: HTMLSelectElement = select({style: \"width: 100%;\"},\r\n\t\toption({value: \"wickiHayden\"}, \"Wicki-Hayden\"),\r\n\t\toption({value: \"songScale\"}, \"selected song scale\"),\r\n\t\toption({value: \"pianoAtC\"}, \"piano starting at C :)\"),\r\n\t\toption({value: \"pianoAtA\"}, \"piano starting at A :(\"),\r\n\t\toption({value: \"pianoTransposingC\"}, \"piano transposing C :) to song key\"),\r\n\t\toption({value: \"pianoTransposingA\"}, \"piano transposing A :( to song key\"),\r\n\t);\r\n\tprivate readonly _keyboardLayoutPreview: HTMLDivElement = div({style: \"display: grid; row-gap: 4px; margin: 4px auto; font-size: 10px;\"});\r\n\tprivate readonly _enableMidi: HTMLInputElement = input({style: \"width: 2em; margin-left: 1em;\", type: \"checkbox\"});\r\n\tprivate readonly _showRecordButton: HTMLInputElement = input({style: \"width: 2em; margin-left: 1em;\", type: \"checkbox\"});\r\n\tprivate readonly _snapRecordedNotesToRhythm: HTMLInputElement = input({style: \"width: 2em; margin-left: 1em;\", type: \"checkbox\"});\r\n\tprivate readonly _ignorePerformedNotesNotInScale: HTMLInputElement = input({style: \"width: 2em; margin-left: 1em;\", type: \"checkbox\"});\r\n\tprivate readonly _metronomeCountIn: HTMLInputElement = input({style: \"width: 2em; margin-left: 1em;\", type: \"checkbox\"});\r\n\tprivate readonly _metronomeWhileRecording: HTMLInputElement = input({style: \"width: 2em; margin-left: 1em;\", type: \"checkbox\"});\r\n\t\r\n\tprivate readonly _okayButton: HTMLButtonElement = button({class: \"okayButton\", style: \"width:45%;\"}, \"Okay\");\r\n\tprivate readonly _cancelButton: HTMLButtonElement = button({class: \"cancelButton\"});\r\n\tpublic readonly container: HTMLDivElement = div({class: \"prompt noSelection recordingSetupPrompt\", style: \"width: 333px; text-align: right; max-height: 90%;\"},\r\n\t\th2(\"Note Recording Setup\"),\r\n\t\tdiv({style: \"display: grid; overflow-y: auto; overflow-x: hidden; flex-shrink: 1;\"},\r\n\t\t\tp(\"BeepBox can record notes as you perform them. You can start recording by pressing Ctrl+Space (or \" + EditorConfig.ctrlSymbol + \"P).\"),\r\n\t\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\t\"Add ● record button next to ▶ play button:\",\r\n\t\t\t\tthis._showRecordButton,\r\n\t\t\t),\r\n\t\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\t\"Snap recorded notes to the song's rhythm:\",\r\n\t\t\t\tthis._snapRecordedNotesToRhythm,\r\n\t\t\t),\r\n\t\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\t\"Ignore notes not in the song's scale:\",\r\n\t\t\t\tthis._ignorePerformedNotesNotInScale,\r\n\t\t\t),\r\n\t\t\tp(\"While recording, you can perform notes on your keyboard!\"),\r\n\t\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\t\"Keyboard layout:\",\r\n\t\t\t\tdiv({class: \"selectContainer\", style: \"width: 65%; margin-left: 1em;\"}, this._keyboardLayout),\r\n\t\t\t),\r\n\t\t\tthis._keyboardLayoutPreview,\r\n\t\t\tp(\"When not recording, you can use the computer keyboard either for shortcuts (like C and V for copy and paste) or for performing notes, depending on this mode:\"),\r\n\t\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\tdiv({class: \"selectContainer\", style: \"width: 100%;\"}, this._keyboardMode),\r\n\t\t\t),\r\n\t\t\tp(\"Performing music takes practice! Try slowing the tempo and using this metronome to help you keep a rhythm.\"),\r\n\t\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\t\"Hear metronome while recording:\",\r\n\t\t\t\tthis._metronomeWhileRecording,\r\n\t\t\t),\r\n\t\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\t\"Count-in 1 bar of metronome before recording:\",\r\n\t\t\t\tthis._metronomeCountIn,\r\n\t\t\t),\r\n\t\t\tp(\"If you have a \", a({href: \"https://caniuse.com/midi\", target: \"_blank\"}, \"compatible browser\"), \" on a device connected to a MIDI keyboard, you can use it to perform notes in BeepBox! (Or you could buy \", a({href: \"https://imitone.com/\", target: \"_blank\"}, \"Imitone\"), \" or \", a({href: \"https://vochlea.com/\", target: \"_blank\"}, \"Dubler\"), \" to hum notes into a microphone while wearing headphones!)\"),\r\n\t\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\t\"Enable MIDI performance:\",\r\n\t\t\t\tthis._enableMidi,\r\n\t\t\t),\r\n\t\t\tp(\"Tip: Recorded notes often overlap such that one note ends after the next note already started. In BeepBox, these notes get split into two notes which may sound different when re-played than they did when you were recording. To fix the sound, you can either manually clean up the notes in the pattern editor, or you could try enabling the \\\"transition type\\\" effect on the instrument and setting it to \\\"continue\\\".\"),\r\n\t\t\tdiv({style: `width: 100%; height: 80px; background: linear-gradient(rgba(0,0,0,0), ${ColorConfig.editorBackground}); position: sticky; bottom: 0; pointer-events: none;`}),\r\n\t\t),\r\n\t\tlabel({style: \"display: flex; flex-direction: row-reverse; justify-content: space-between;\"},\r\n\t\t\tthis._okayButton,\r\n\t\t),\r\n\t\tthis._cancelButton,\r\n\t);\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis._keyboardMode.value = this._doc.prefs.pressControlForShortcuts ? \"pressControlForShortcuts\" : \"useCapsLockForNotes\";\r\n\t\tthis._keyboardLayout.value = this._doc.prefs.keyboardLayout;\r\n\t\tthis._enableMidi.checked = this._doc.prefs.enableMidi;\r\n\t\tthis._showRecordButton.checked = this._doc.prefs.showRecordButton;\r\n\t\tthis._snapRecordedNotesToRhythm.checked = this._doc.prefs.snapRecordedNotesToRhythm;\r\n\t\tthis._ignorePerformedNotesNotInScale.checked = this._doc.prefs.ignorePerformedNotesNotInScale;\r\n\t\tthis._metronomeCountIn.checked = this._doc.prefs.metronomeCountIn;\r\n\t\tthis._metronomeWhileRecording.checked = this._doc.prefs.metronomeWhileRecording;\r\n\t\t\r\n\t\tsetTimeout(()=>this._showRecordButton.focus());\r\n\t\t\r\n\t\tthis._okayButton.addEventListener(\"click\", this._confirm);\r\n\t\tthis._cancelButton.addEventListener(\"click\", this._close);\r\n\t\tthis.container.addEventListener(\"keydown\", this._whenKeyPressed);\r\n\t\t\r\n\t\tthis._renderKeyboardLayoutPreview();\r\n\t\tthis._keyboardLayout.addEventListener(\"change\", this._renderKeyboardLayoutPreview);\r\n\t}\r\n\t\r\n\tprivate _close = (): void => { \r\n\t\tthis._doc.undo();\r\n\t}\r\n\t\r\n\tpublic cleanUp = (): void => { \r\n\t\tthis._okayButton.removeEventListener(\"click\", this._confirm);\r\n\t\tthis._cancelButton.removeEventListener(\"click\", this._close);\r\n\t\tthis.container.removeEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\t\r\n\tprivate _whenKeyPressed = (event: KeyboardEvent): void => {\r\n\t\tif ((<Element> event.target).tagName != \"BUTTON\" && event.keyCode == 13) { // Enter key\r\n\t\t\tthis._confirm();\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _confirm = (): void => { \r\n\t\tthis._doc.prefs.pressControlForShortcuts = (this._keyboardMode.value == \"pressControlForShortcuts\");\r\n\t\tthis._doc.prefs.keyboardLayout = this._keyboardLayout.value;\r\n\t\tthis._doc.prefs.enableMidi = this._enableMidi.checked;\r\n\t\tthis._doc.prefs.showRecordButton = this._showRecordButton.checked;\r\n\t\tthis._doc.prefs.snapRecordedNotesToRhythm = this._snapRecordedNotesToRhythm.checked;\r\n\t\tthis._doc.prefs.ignorePerformedNotesNotInScale = this._ignorePerformedNotesNotInScale.checked;\r\n\t\tthis._doc.prefs.metronomeCountIn = this._metronomeCountIn.checked;\r\n\t\tthis._doc.prefs.metronomeWhileRecording = this._metronomeWhileRecording.checked;\r\n\t\tthis._doc.prefs.save();\r\n\t\tthis._close();\r\n\t}\r\n\t\r\n\tprivate _renderKeyboardLayoutPreview = (): void => {\r\n\t\twhile (this._keyboardLayoutPreview.firstChild) {\r\n\t\t\tthis._keyboardLayoutPreview.removeChild(this._keyboardLayoutPreview.firstChild);\r\n\t\t}\r\n\t\tconst rowLengths: number[] = [12, 12, 11, 10];\r\n\t\tconst scale: ReadonlyArray<boolean> = Config.scales[this._doc.song.scale].flags;\r\n\t\tfor (let rowIndex: number = 0; rowIndex < 4; rowIndex++) {\r\n\t\t\tconst row: HTMLDivElement = div({style: \"display: flex;\"});\r\n\t\t\tthis._keyboardLayoutPreview.appendChild(row);\r\n\t\t\tconst spacer: HTMLDivElement = div({style: \"width: \" + (rowIndex * 12) + \"px; height: 20px; flex-shrink: 0;\"});\r\n\t\t\trow.appendChild(spacer);\r\n\t\t\tfor (let colIndex: number = 0; colIndex < rowLengths[rowIndex]; colIndex++) {\r\n\t\t\t\tconst key: HTMLDivElement = div({style: `width: 20px; height: 20px; margin: 0 2px; box-sizing: border-box; flex-shrink: 0; display: flex; justify-content: center; align-items: center;`});\r\n\t\t\t\trow.appendChild(key);\r\n\t\t\t\tconst pitch: number | null = KeyboardLayout.keyPosToPitch(this._doc, colIndex, 3 - rowIndex, this._keyboardLayout.value);\r\n\t\t\t\tif (pitch != null) {\r\n\t\t\t\t\tconst scalePitch: number = pitch % 12;\r\n\t\t\t\t\tif (scale[scalePitch]) {\r\n\t\t\t\t\t\tif (scalePitch == 0) {\r\n\t\t\t\t\t\t\tkey.style.background = ColorConfig.tonic;\r\n\t\t\t\t\t\t} else if (scalePitch == 7 && this._doc.prefs.showFifth) {\r\n\t\t\t\t\t\t\tkey.style.background = ColorConfig.fifthNote;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tkey.style.background = ColorConfig.pitchBackground;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tkey.style.border = \"2px solid \" + ColorConfig.pitchBackground;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst pitchNameIndex: number = (scalePitch + Config.keys[this._doc.song.key].basePitch) % Config.pitchesPerOctave;\r\n\t\t\t\t\tkey.textContent = Piano.getPitchName(pitchNameIndex, scalePitch, Math.floor(pitch / 12));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { Config } from \"../synth/SynthConfig\";\r\nimport { SpectrumWave, Instrument } from \"../synth/synth\";\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { HTML, SVG } from \"imperative-html/dist/esm/elements-strict\";\r\nimport { ColorConfig } from \"./ColorConfig\";\r\nimport { ChangeSpectrum } from \"./changes\";\r\nimport { prettyNumber } from \"./EditorConfig\";\r\n\r\nexport class SpectrumEditor {\r\n\tprivate readonly _editorWidth: number = 120;\r\n\tprivate readonly _editorHeight: number = 26;\r\n\t\tprivate readonly _fill: SVGPathElement = SVG.path({fill: ColorConfig.uiWidgetBackground, \"pointer-events\": \"none\"});\r\n\t\tprivate readonly _octaves: SVGSVGElement = SVG.svg({\"pointer-events\": \"none\"});\r\n\t\tprivate readonly _fifths: SVGSVGElement = SVG.svg({\"pointer-events\": \"none\"});\r\n\t\tprivate readonly _curve: SVGPathElement = SVG.path({fill: \"none\", stroke: \"currentColor\", \"stroke-width\": 2, \"pointer-events\": \"none\"});\r\n\t\tprivate readonly _arrow: SVGPathElement = SVG.path({fill: \"currentColor\", \"pointer-events\": \"none\"});\r\n\t\tprivate readonly _svg: SVGSVGElement = SVG.svg({style: `background-color: ${ColorConfig.editorBackground}; touch-action: none; cursor: crosshair;`, width: \"100%\", height: \"100%\", viewBox: \"0 0 \"+this._editorWidth+\" \"+this._editorHeight, preserveAspectRatio: \"none\"},\r\n\t\tthis._fill,\r\n\t\tthis._octaves,\r\n\t\tthis._fifths,\r\n\t\tthis._curve,\r\n\t\tthis._arrow,\r\n\t);\r\n\t\t\r\n\tpublic readonly container: HTMLElement = HTML.div({class: \"spectrum\", style: \"height: 100%;\"}, this._svg);\r\n\t\t\r\n\tprivate _mouseX: number = 0;\r\n\tprivate _mouseY: number = 0;\r\n\tprivate _freqPrev: number = 0;\r\n\tprivate _ampPrev: number = 0;\r\n\tprivate _mouseDown: boolean = false;\r\n\tprivate _change: ChangeSpectrum | null = null;\r\n\tprivate _renderedPath: String = \"\";\r\n\tprivate _renderedFifths: boolean = true;\r\n\t\t\r\n\tconstructor(private _doc: SongDocument, private _spectrumIndex: number | null) {\r\n\t\tfor (let i: number = 0; i < Config.spectrumControlPoints; i += Config.spectrumControlPointsPerOctave) {\r\n\t\t\t\tthis._octaves.appendChild(SVG.rect({fill: ColorConfig.tonic, x: (i+1) * this._editorWidth / (Config.spectrumControlPoints + 2) - 1, y: 0, width: 2, height: this._editorHeight}));\r\n\t\t}\r\n\t\tfor (let i: number = 4; i <= Config.spectrumControlPoints; i += Config.spectrumControlPointsPerOctave) {\r\n\t\t\t\tthis._fifths.appendChild(SVG.rect({fill: ColorConfig.fifthNote, x: (i+1) * this._editorWidth / (Config.spectrumControlPoints + 2) - 1, y: 0, width: 2, height: this._editorHeight}));\r\n\t\t}\r\n\t\t\t\r\n\t\tthis.container.addEventListener(\"mousedown\", this._whenMousePressed);\r\n\t\tdocument.addEventListener(\"mousemove\", this._whenMouseMoved);\r\n\t\tdocument.addEventListener(\"mouseup\", this._whenCursorReleased);\r\n\t\t\t\r\n\t\tthis.container.addEventListener(\"touchstart\", this._whenTouchPressed);\r\n\t\tthis.container.addEventListener(\"touchmove\", this._whenTouchMoved);\r\n\t\tthis.container.addEventListener(\"touchend\", this._whenCursorReleased);\r\n\t\tthis.container.addEventListener(\"touchcancel\", this._whenCursorReleased);\r\n\t}\r\n\t\t\r\n\tprivate _xToFreq(x: number): number {\r\n\t\treturn (Config.spectrumControlPoints + 2) * x / this._editorWidth - 1;\r\n\t}\r\n\t\t\r\n\tprivate _yToAmp(y: number): number {\r\n\t\treturn Config.spectrumMax * (1 - (y - 1) / (this._editorHeight - 2));\r\n\t}\r\n\t\t\r\n\tprivate _whenMousePressed = (event: MouseEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = ((event.clientX || event.pageX) - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\t    \r\n\t\tthis._freqPrev = this._xToFreq(this._mouseX);\r\n\t\tthis._ampPrev = this._yToAmp(this._mouseY);\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\t\r\n\tprivate _whenTouchPressed = (event: TouchEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.touches[0].clientX - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\t    \r\n\t\tthis._freqPrev = this._xToFreq(this._mouseX);\r\n\t\tthis._ampPrev = this._yToAmp(this._mouseY);\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\t\r\n\tprivate _whenMouseMoved = (event: MouseEvent): void => {\r\n\t\tif (this.container.offsetParent == null) return;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = ((event.clientX || event.pageX) - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\t\r\n\tprivate _whenTouchMoved = (event: TouchEvent): void => {\r\n\t\tif (this.container.offsetParent == null) return;\r\n\t\tif (!this._mouseDown) return;\r\n\t\tevent.preventDefault();\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.touches[0].clientX - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\t\r\n\tprivate _whenCursorMoved(): void {\r\n\t\tif (this._mouseDown) {\r\n\t\t\tconst freq: number = this._xToFreq(this._mouseX);\r\n\t\t\tconst amp: number = this._yToAmp(this._mouseY);\r\n\t\t\t\t\r\n\t\t\tconst instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\t\tconst spectrumWave: SpectrumWave = (this._spectrumIndex == null) ? instrument.spectrumWave : instrument.drumsetSpectrumWaves[this._spectrumIndex];\r\n\t\t\t\t\r\n\t\t\tif (freq != this._freqPrev) {\r\n\t\t\t\tconst slope: number = (amp - this._ampPrev) / (freq - this._freqPrev);\r\n\t\t\t\tconst offset: number = this._ampPrev - this._freqPrev * slope;\r\n\t\t\t\tconst lowerFreq: number = Math.ceil(Math.min(this._freqPrev, freq));\r\n\t\t\t\tconst upperFreq: number = Math.floor(Math.max(this._freqPrev, freq));\r\n\t\t\t\tfor (let i: number = lowerFreq; i <= upperFreq; i++) {\r\n\t\t\t\t\tif (i < 0 || i >= Config.spectrumControlPoints) continue;\r\n\t\t\t\t\tspectrumWave.spectrum[i] = Math.max(0, Math.min(Config.spectrumMax, Math.round(i * slope + offset)));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\t\r\n\t\t\tspectrumWave.spectrum[Math.max(0, Math.min(Config.spectrumControlPoints - 1, Math.round(freq)))] = Math.max(0, Math.min(Config.spectrumMax, Math.round(amp)));\r\n\t\t\t\t\r\n\t\t\tthis._freqPrev = freq;\r\n\t\t\tthis._ampPrev = amp;\r\n\t\t\t\t\r\n\t\t\tthis._change = new ChangeSpectrum(this._doc, instrument, spectrumWave);\r\n\t\t\tthis._doc.setProspectiveChange(this._change);\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tprivate _whenCursorReleased = (event: Event): void => {\r\n\t\tif (this._mouseDown) {\r\n\t\t\tthis._doc.record(this._change!);\r\n\t\t\tthis._change = null;\r\n\t\t}\r\n\t\tthis._mouseDown = false;\r\n\t}\r\n\t\t\r\n\tpublic render(): void {\r\n\t\tconst instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\tconst spectrumWave: SpectrumWave = (this._spectrumIndex == null) ? instrument.spectrumWave : instrument.drumsetSpectrumWaves[this._spectrumIndex];\r\n\t\tconst controlPointToHeight = (point: number): number => {\r\n\t\t\treturn (1 - (point / Config.spectrumMax)) * (this._editorHeight - 1) + 1;\r\n\t\t}\r\n\t\t\t\r\n\t\tlet lastValue: number = 0;\r\n\t\tlet path: string = \"M 0 \" + prettyNumber(this._editorHeight) + \" \";\r\n\t\tfor (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n\t\t\tlet nextValue: number = spectrumWave.spectrum[i];\r\n\t\t\tif (lastValue != 0 || nextValue != 0) {\r\n\t\t\t\tpath += \"L \";\r\n\t\t\t} else {\r\n\t\t\t\tpath += \"M \";\r\n\t\t\t}\r\n\t\t\tpath += prettyNumber((i + 1) * this._editorWidth / (Config.spectrumControlPoints + 2)) + \" \" + prettyNumber(controlPointToHeight(nextValue)) + \" \";\r\n\t\t\tlastValue = nextValue;\r\n\t\t}\r\n\t\t\t\r\n\t\tconst lastHeight: number = controlPointToHeight(lastValue);\r\n\t\tif (lastValue > 0) {\r\n\t\t\tpath += \"L \" + (this._editorWidth - 1) + \" \" + prettyNumber(lastHeight) + \" \";\r\n\t\t}\r\n\t\t\t\r\n\t\tif (this._renderedPath != path) {\r\n\t\t\tthis._renderedPath = path;\r\n\t\t\tthis._curve.setAttribute(\"d\", path);\r\n\t\t\tthis._fill.setAttribute(\"d\", path + \"L \" + this._editorWidth + \" \" + prettyNumber(lastHeight) + \" L \" + this._editorWidth + \" \" + prettyNumber(this._editorHeight) + \" L 0 \" + prettyNumber(this._editorHeight) + \" z \");\r\n\t\t\t\t\r\n\t\t\tthis._arrow.setAttribute(\"d\", \"M \" + this._editorWidth + \" \" + prettyNumber(lastHeight) + \" L \" + (this._editorWidth - 4) + \" \" + prettyNumber(lastHeight - 4) + \" L \" + (this._editorWidth - 4) + \" \" + prettyNumber(lastHeight + 4) + \" z\");\r\n\t\t\tthis._arrow.style.display = (lastValue > 0) ? \"\" : \"none\";\r\n\t\t}\r\n\t\tif (this._renderedFifths != this._doc.prefs.showFifth) {\r\n\t\t\tthis._renderedFifths = this._doc.prefs.showFifth;\r\n\t\t\tthis._fifths.style.display = this._doc.prefs.showFifth ? \"\" : \"none\";\r\n\t\t}\r\n\t}\r\n}\r\n","// Copyright (C) 2020 John Nesky, distributed under the MIT license.\r\n\r\nimport { HTML } from \"imperative-html/dist/esm/elements-strict\";\r\nimport { Prompt } from \"./Prompt\";\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { ColorConfig } from \"./ColorConfig\";\r\n\r\n//namespace beepbox {\r\nconst { button, div, h2, select, option } = HTML;\r\n\r\nexport class ThemePrompt implements Prompt {\r\n\tprivate readonly _themeSelect: HTMLSelectElement = select({ style: \"width: 100%;\" },\r\n\t\toption({ value: \"dark classic\" }, \"BeepBox Dark\"),\r\n\t\toption({ value: \"light classic\" }, \"BeepBox Light\"),\r\n\t\toption({ value: \"dark competition\" }, \"BeepBox Competition Dark\"),\r\n\t\toption({ value: \"jummbox classic\" }, \"JummBox Dark\"),\r\n\t\t// option({ value: \"jummbox light\" }, \"JummBox Light\"), // It's not ready to see the world yet...\r\n\t\toption({ value: \"forest\" }, \"Forest\"),\r\n\t\toption({ value: \"canyon\" }, \"Canyon\"),\r\n\t\toption({ value: \"midnight\" }, \"Midnight\"),\r\n\t\toption({ value: \"beachcombing\" }, \"Beachcombing\"),\r\n\t\toption({ value: \"violet verdant\" }, \"Violet Verdant\"),\r\n\t\toption({ value: \"sunset\" }, \"Sunset\"),\r\n\t\toption({ value: \"autumn\" }, \"Autumn\"),\r\n\t\toption({ value: \"fruit\" }, \"Shadowfruit\"),\r\n\t\toption({ value: \"toxic\" }, \"Toxic\"),\r\n\t\toption({ value: \"roe\" }, \"Roe\"),\r\n\t\toption({ value: \"moonlight\" }, \"Moonlight\"),\r\n\t\toption({ value: \"portal\" }, \"Portal\"),\r\n\t\toption({ value: \"fusion\" }, \"Fusion\"),\r\n\t\toption({ value: \"inverse\" }, \"Inverse\"),\r\n\t\toption({ value: \"nebula\" }, \"Nebula\"),\r\n\t\toption({ value: \"roe light\" }, \"Roe Light\"),\r\n\t\toption({ value: \"energized\" }, \"Energized\"),\r\n\t\toption({ value: \"neapolitan\" }, \"Neapolitan\"),\r\n\t\toption({ value: \"mono\" }, \"Mono\"),\r\n\t);\r\n\tprivate readonly _cancelButton: HTMLButtonElement = button({ class: \"cancelButton\" });\r\n\tprivate readonly _okayButton: HTMLButtonElement = button({ class: \"okayButton\", style: \"width:45%;\" }, \"Okay\");\r\n\r\n\tpublic readonly container: HTMLDivElement = div({ class: \"prompt noSelection\", style: \"width: 220px;\" },\r\n\t\th2(\"Set Theme\"),\r\n\t\tdiv({ style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\" },\r\n\t\t\tdiv({ class: \"selectContainer\", style: \"width: 100%;\" }, this._themeSelect),\r\n\t\t),\r\n\t\tdiv({ style: \"display: flex; flex-direction: row-reverse; justify-content: space-between;\" },\r\n\t\t\tthis._okayButton,\r\n\t\t),\r\n\t\tthis._cancelButton,\r\n\t);\r\n\tprivate readonly lastTheme: string | null = window.localStorage.getItem(\"colorTheme\")\r\n\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tif (this.lastTheme != null) {\r\n\t\t\tthis._themeSelect.value = this.lastTheme;\r\n\t\t}\r\n\t\tthis._okayButton.addEventListener(\"click\", this._saveChanges);\r\n\t\tthis._cancelButton.addEventListener(\"click\", this._close);\r\n\t\tthis.container.addEventListener(\"keydown\", this._whenKeyPressed);\r\n\t\tthis._themeSelect.addEventListener(\"change\", this._previewTheme);\r\n\t}\r\n\r\n\tprivate _close = (): void => {\r\n\t\tif (this.lastTheme != null) {\r\n\t\t\tColorConfig.setTheme(this.lastTheme);\r\n\t\t} else {\r\n\t\t\tColorConfig.setTheme(\"dark classic\");\r\n\t\t}\r\n\t\tthis._doc.undo();\r\n\t}\r\n\r\n\tpublic cleanUp = (): void => {\r\n\t\tthis._okayButton.removeEventListener(\"click\", this._saveChanges);\r\n\t\tthis._cancelButton.removeEventListener(\"click\", this._close);\r\n\t\tthis.container.removeEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\r\n\tprivate _whenKeyPressed = (event: KeyboardEvent): void => {\r\n\t\tif ((<Element>event.target).tagName != \"BUTTON\" && event.keyCode == 13) { // Enter key\r\n\t\t\tthis._saveChanges();\r\n\t\t}\r\n\t}\r\n\r\n\tprivate _saveChanges = (): void => {\r\n\t\twindow.localStorage.setItem(\"colorTheme\", this._themeSelect.value);\r\n\t\tthis._doc.prompt = null;\r\n\t\tthis._doc.prefs.colorTheme = this._themeSelect.value;\r\n\t\tthis._doc.undo();\r\n\t}\r\n\r\n\tprivate _previewTheme = (): void => {\r\n\t\tColorConfig.setTheme(this._themeSelect.value);\r\n\t\tthis._doc.notifier.changed();\r\n\t}\r\n}\r\n//}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { HTML } from \"imperative-html/dist/esm/elements-strict\";\r\nimport { Prompt } from \"./Prompt\";\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { Config } from \"../synth/SynthConfig\";\r\n\r\nconst { button, div, p, h2, h3 } = HTML;\r\n\r\nexport class TipPrompt implements Prompt {\r\n\t\tprivate readonly _closeButton: HTMLButtonElement = button({class: \"cancelButton\"});\r\n\t\t\r\n\tpublic readonly container: HTMLDivElement;\r\n\t\t\r\n\tconstructor(private _doc: SongDocument, type: string) {\r\n\t\tlet message: HTMLDivElement;\r\n\t\t\t\r\n\t\tswitch (type) {\r\n\t\t\tcase \"scale\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Scale\"),\r\n\t\t\t\t\tp(\"This setting limits the available pitches for adding notes. You may think that there's no point in limiting your choices, but the set of pitches you use has a strong influence on the mood and feel of your song, and these scales serve as guides to help you choose appropriate pitches. Don't worry, you can change the scale at any time, so you're not locked into it. Try making little melodies using all the available pitches of a scale to get a sense for how it sounds.\"),\r\n\t\t\t\t\tp(\"The most common scales are major and minor. Assuming your song uses all pitches in the scale and especially \\\"tonic\\\" pitches (the purple rows in the pattern editor) then major scales tend to sound more playful or optimistic, whereas minor scales sound more serious or sad.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"key\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Song Key\"),\r\n\t\t\t\t\tp(\"This setting can shift the frequency of every note in your entire song up or down, keeping the \\\"tonic\\\" pitches (the brown rows in the pattern editor) aligned with the selected \\\"key\\\" pitch.\"),\r\n\t\t\t\t\tp(\"If you've already placed some notes but they don't emphasize \\\"tonic\\\" pitches then the selected key isn't very meaningful. You can select the \\\"Detect Key\\\" option in the key menu to automatically align the most emphasized notes with \\\"tonic\\\" pitches.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"tempo\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Song Tempo\"),\r\n\t\t\t\t\tp(\"This setting controls the speed of your song, measured in beats-per-minute. A \\\"beat\\\" is the duration of the little gray rectangles in the pattern editor. (In conventional music notation, a \\\"quarter note\\\" is usually equivalent to \\\"beat\\\".)\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"reverb\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Reverb\"),\r\n\t\t\t\t\tp(\"Reverb is like a continuous echo effect. A little bit helps instruments sound more natural. Adding a lot of reverb can add sense of depth or mystery, but too much reverb can kinda \\\"smear\\\" sounds so that it's harder to distinguish notes or instruments, especially for lower \\\"bass\\\" notes.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"rhythm\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Rhythm\"),\r\n\t\t\t\t\tp(\"This setting determines how beats are divided. The pattern editor helps you align notes to fractions of a beat based on this setting.\"),\r\n\t\t\t\t\tp(\"If you've already placed some notes but they don't align with the selected rhythm, you can select the \\\"Snap Notes To Rhythm\\\" option in the rhythm menu to force the notes in the currently selected pattern(s) to align with the selected rhythm.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"instrumentIndex\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Instrument Number\"),\r\n\t\t\t\t\tp(\"In the \\\"Channel Settings\\\" option from JummBox's \\\"File\\\" menu, there are a few ways to enable multiple instruments per channel.\"),\r\n\t\t\t\t\tp(\"First, you could enable multiple simultaneous instruments per channel. All of the channel's instruments will play all of the notes in the channel at the same time, and you can click an instrument number to view and edit its settings.\"),\r\n\t\t\t\t\tp(\"Second, you could enable different instruments per pattern. Only one of the instruments will play at any given time, but you can click the instrument number to change which instrument is used for the currently selected pattern(s).\"),\r\n\t\t\t\t\tp(\"Finally, you can enable them both, in which case you can click an instrument number once to view it, and again to toggle whether the instrument is used for the currently selected pattern(s).\"),\r\n\t\t\t\t\tp(\"Either way, you can click the + button to add more instruments to a channel, and you can press shift and a number key on your keyboard to select an instrument as if you had clicked the corresponding button here.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"instrumentVolume\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Instrument Volume\"),\r\n\t\t\t\t\tp(\"This setting controls the volume of the selected instrument without affecting the volume of the other instruments. This allows you to balance the loudness of each instrument relative to each other.\"),\r\n\t\t\t\t\tp(\"Please be careful when using volume settings above 0. This indicates amplification and too much of that can trip the audio limiter built into this tool. This can lead to your song sounding muffled if overused. But when used carefully, amplification can be a powerful tool!\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"pan\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Instrument Panning\"),\r\n\t\t\t\t\tp(\"If you're listening through headphones or some other stereo sound system, this controls the position of the instrument and where the sound is coming from, ranging from left to right.\"),\r\n\t\t\t\t\tp(\"As a suggestion, composers often put lead melodies, drums, and basses in the center, and spread other instruments toward either side. If too many instruments seem like they're coming from the same place, it can feel crowded and harder to distinguish individual sounds, especially if they cover a similar pitch range.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"panDelay\":\r\n\t\t\t\t{\r\n\t\t\t\t\tmessage = div(\r\n\t\t\t\t\t\th2(\"Stereo Delay\"),\r\n\t\t\t\t\t\tp(\"When panning, a slight delay is often added between the left and right ear to help make a sound feel more 'directional'. For example, in the real world your left ear will hear a sound coming from the left just slightly before the right ear.\"),\r\n\t\t\t\t\t\tp(\"This setting controls how much delay is added. When this is set to minimum, panning only affects the volume of the left/right ear without changing the delay. This can help to get a more 'uniform' feeling sound, which can be desirable for making 8-bit music.\")\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"arpeggioSpeed\":\r\n\t\t\t\t{\r\n\t\t\t\t\tmessage = div(\r\n\t\t\t\t\t\th2(\"Arpeggio Speed\"),\r\n\t\t\t\t\t\tp(\"This setting affects how fast your chord will 'arpeggiate', or cycle between notes. With a fast arpeggio speed it will sound rapid-fire, with a slow speed you can hear each note one after another.\")\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"twoNoteArpeggio\":\r\n\t\t\t\t{\r\n\t\t\t\t\tmessage = div(\r\n\t\t\t\t\t\th2(\"Faster Two-Note Arpeggio\"),\r\n\t\t\t\t\t\tp(\"This setting makes arpeggios with only two notes in them happen twice as fast. Arpeggios with more notes in them are unaffected.\")\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"detune\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Detune\"),\r\n\t\t\t\t\tp(\"This setting can be used to finely control the pitch of your instrument. It is in units of 'cents', 100 of which equal a pitch shift of one semitone.\"),\r\n\t\t\t\t\tp(\"Careful - you can quickly get very dissonant sounding songs by using this setting.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"instrumentType\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Instrument Type\"),\r\n\t\t\t\t\tp(\"JummBox comes with many instrument presets, try them out! You can also create your own custom instruments!\"),\r\n\t\t\t\t\tp(\"There are also options for copying and pasting instrument settings and for generating random instruments at the top of the instrument type menu.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"eqFilter\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"EQ Filter\"),\r\n\t\t\t\t\tp(\"Filters are a way of emphasizing or diminishing different parts of a sound. Musical notes have a fundamental (base) frequency, but the sound of a musical note also has parts at higher frequencies and filters can adjust the volume of each of these parts based on their frequency.\"),\r\n\t\t\t\t\tp(\"Click in the filter editor to insert, delete, or drag a filter control point. The horizontal position of the point determines which frequencies it affects, and the vertical position determines how the volume is affected at that frequency.\"),\r\n\t\t\t\t\tp(\"Insert a new point on the left side of the filter editor to add a \\\"high-pass\\\" filter point, which additionally reduces the volume of lower frequencies, or insert a new point on the right side to add a \\\"low-pass\\\" filter point which reduces the volume of higher frequencies.\"),\r\n\t\t\t\t\tp(\"You can also enable a \\\"Note Filter\\\" as an effect. EQ and note filters are mostly the same, but have different purposes. EQ filters are for overall adjustments, whereas note filters are for dynamic control and can be moved with envelopes. Note filters also change how the distortion effect sounds.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"noteFilter\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Note Filter\"),\r\n\t\t\t\t\tp(\"Note filters are mostly the same as EQ filters, but have a different purpose. EQ filters are for overall adjustments, whereas note filters are for dynamic control and can be moved with envelopes. Note filters also change how the distortion effect sounds.\"),\r\n\t\t\t\t\tp(\"Filters are a way of emphasizing or diminishing different parts of a sound. Musical notes have a fundamental (base) frequency, but the sound of a musical note also has parts at higher frequencies and filters can adjust the volume of each of these parts based on their frequency.\"),\r\n\t\t\t\t\tp(\"Click in the filter editor to insert, delete, or drag a filter control point. The horizontal position of the point determines which frequencies it affects, and the vertical position determines how the volume is affected at that frequency.\"),\r\n\t\t\t\t\tp(\"Insert a new point on the left side of the filter editor to add a \\\"high-pass\\\" filter point, which additionally reduces the volume of lower frequencies, or insert a new point on the right side to add a \\\"low-pass\\\" filter point which reduces the volume of higher frequencies.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"fadeInOut\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Fade In/Out\"),\r\n\t\t\t\t\tp(\"This setting controls how long it takes for notes to reach full volume at the beginning or decay to silence at the end.\"),\r\n\t\t\t\t\tp(\"An instant fade-in sounds like instruments that are played by hitting or plucking, whereas slower fade-ins sound like instruments that are played by blowing air.\"),\r\n\t\t\t\t\tp(\"You can also make the fade-out start before the note ends to leave a gap before the next note starts, or after the note ends to allow the sound of the end of the note to overlap with the start of the next note.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"transition\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Transition\"),\r\n\t\t\t\t\tp(\"Usually, when one note ends at the same time another begins, the old note will fade out and the new note will fade in based on the fade in/out settings, but this setting can override that, connecting the end of one note to the beginning of the next.\"),\r\n\t\t\t\t\tp(\"The \\\"interrupt\\\" transition makes the wave suddenly change from the old note's frequency to the new note's frequency without any fading, but still restarts envelopes at the beginning of the new note. The \\\"continue\\\" transition is similar but it doesn't even restart envelopes, and can be used to make each of the notes in a chord start or stop at different times!\"),\r\n\t\t\t\t\tp(\"The \\\"slide\\\" transition makes the pitch shift quickly but not instantaneously from the old note's frequency to the new note's frequency, and softly restarts envelopes. The \\\"slide in pattern\\\" transition is the same except it doesn't connect the last note in a pattern to the first note in the next pattern.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"chipWave\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Chip Wave\"),\r\n\t\t\t\t\tp(\"JummBox comes with some sound waves based on classic electronic sound chips, as well as several unique waves. This is the basic source of the sound of the instrument, which is modified by the other instrument settings.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"chipNoise\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Noise\"),\r\n\t\t\t\t\tp(\"JummBox comes with several basic noise sounds. These do not have any distinct musical pitch, and can be used like drums to create beats and emphasize your song's rhythm.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"pulseWidth\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Pulse Wave Width\"),\r\n\t\t\t\t\tp(\"This setting controls the shape and sound of a pulse wave. At the minimum width, it sounds light and buzzy. At the maximum width, it is shaped like a classic square wave.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"unison\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Unison\"),\r\n\t\t\t\t\tp(\"This instrument can play two identical waves at different frequencies. When two waves play at slightly different frequencies, they move in and out of phase with each other over time as different parts of the waves line up. This creates a dynamic, shifting sound. Pianos are a common example of this kind of sound, because each piano key strikes multiple strings that are tuned to slightly different frequencies.\"),\r\n\t\t\t\t\tp(\"The distance between two frequencies is called an \\\"interval\\\", and this setting controls how large it is. If the interval is too wide, then the waves may sound out-of-tune and \\\"dissonant\\\". However, if the interval is even larger, then the two frequencies can even be distinct pitches.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"chords\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Chords\"),\r\n\t\t\t\t\tp(\"When multiple different notes occur at the same time, this is called a chord. Chords can be created in JummBox's pattern editor by adding notes above or below another note.\"),\r\n\t\t\t\t\tp(\"This setting determines how chords are played. The standard option is \\\"simultaneous\\\" which starts playing all of the pitches in a chord at the same instant. The \\\"strum\\\" option is similar, but plays the notes starting at slightly different times. The \\\"arpeggio\\\" option is used in \\\"chiptune\\\" style music and plays a single tone that rapidly alternates between all of the pitches in the chord.\"),\r\n\t\t\t\t\tp(\"Some JummBox instruments have an option called \\\"custom interval\\\" which uses the chord notes to control the interval between the waves of a single tone. This can create strange sound effects when combined with FM modulators.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"vibrato\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Vibrato\"),\r\n\t\t\t\t\tp(\"This setting causes the frequency of a note to wobble slightly. Singers and violinists often use vibrato.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"vibratoDepth\":\r\n\t\t\t\t{\r\n\t\t\t\t\tmessage = div(\r\n\t\t\t\t\t\th2(\"Vibrato Depth\"),\r\n\t\t\t\t\t\tp(\"This setting affects the depth of your instrument's vibrato, making the wobbling effect sound stronger or weaker.\")\r\n\t\t\t\t\t);\r\n\t\t\t\t} break;\r\n\t\t\tcase \"vibratoDelay\":\r\n\t\t\t\t{\r\n\t\t\t\t\tmessage = div(\r\n\t\t\t\t\t\th2(\"Vibrato Delay\"),\r\n\t\t\t\t\t\tp(\"This setting changes when vibrato starts to kick in after a note is played. Vibrato is most common for long held notes and less common in short notes, so this can help you achieve that effect.\")\r\n\t\t\t\t\t);\r\n\t\t\t\t} break;\r\n\t\t\tcase \"vibratoSpeed\":\r\n\t\t\t\t{\r\n\t\t\t\t\tmessage = div(\r\n\t\t\t\t\t\th2(\"Vibrato Speed\"),\r\n\t\t\t\t\t\tp(\"This setting determines how fast the vibrato's up-and-down wobble effect will happen for your instrument.\")\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"vibratoType\":\r\n\t\t\t\t{\r\n\t\t\t\t\tmessage = div(\r\n\t\t\t\t\t\th2(\"Vibrato Type\"),\r\n\t\t\t\t\t\tp(\"This determines the way vibrato causes your instrument's pitch to wobble. The normal type is smooth up and down, the shaky type is chaotic.\")\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"algorithm\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"FM Algorithm\"),\r\n\t\t\t\t\tp('FM Synthesis is a mysterious but powerful technique for crafting sounds, popularized by Yamaha keyboards and the Sega Genesis/Mega Drive. It may seem confusing, but try playing around with the options until you get a feel for it, or check out some of the preset examples!'),\r\n\t\t\t\t\tp('This FM synthesizer uses up to four waves, numbered 1, 2, 3, and 4. Each wave may have its own frequency and volume.'),\r\n\t\t\t\t\tp('There are two kinds of waves: \"carrier\" waves play a tone out loud, but \"modulator\" waves distort other waves instead. Wave 1 is always a carrier and plays a tone, but other waves may distort it. The \"Algorithm\" setting determines which waves are modulators, and which other waves those modulators distort. For example, \"1←2\" means that wave 2 modulates wave 1, and wave 1 plays out loud.'),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"feedbackType\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Feedback Type\"),\r\n\t\t\t\t\tp('Modulators distort in one direction (like 1←2), but you can also use the feedback setting to make any wave distort in the opposite direction (1→2), or even itself (1⟲).'),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"feedbackVolume\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Feedback Distortion\"),\r\n\t\t\t\t\tp(\"This setting controls the amount of feedback distortion based on the feedback type setting.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"operatorFrequency\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Operator Frequency\"),\r\n\t\t\t\t\tp('This setting controls the frequency of an individual FM wave, relative to the fundamental frequency of the note. The multiplier 1× is the same as the fundamental frequency, whereas 2x would be an octave (12 semitones) above it. The frequencies with a \"~\" are slightly detuned and shift in and out of phase over time compared to the other frequencies.'),\r\n\t\t\t\t\tp('Try different combinations of a \"carrier\" wave and a \"modulator\" wave with different frequencies to get a feel for how they sound together.'),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"operatorVolume\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Operator Volume\"),\r\n\t\t\t\t\tp(\"This setting controls the volume of \\\"carrier\\\" waves, or the amount of distortion that \\\"modulator\\\" waves apply to other waves.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"spectrum\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Spectrum\"),\r\n\t\t\t\t\tp(\"This setting allows you to draw your own noise spectrum! This is good for making drum sounds.\"),\r\n\t\t\t\t\tp(\"If you only use certain frequencies and a soft fade in/out, it's also possible to make howling wind sounds or even musical wind instruments.\"),\r\n\t\t\t\t\tp(\"The left side of the spectrum editor controls the noise energy at lower frequencies, and the right side controls higher frequencies.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"harmonics\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Harmonics\"),\r\n\t\t\t\t\tp(\"This setting allows you to design your own sound wave! Most musical waves are actually a combination of sine waves at certain frequencies, and this lets you control the volume of each sine wave individually.\"),\r\n\t\t\t\t\tp(\"The left side of the harmonics editor controls the sine wave volumes at lower frequencies, and the right side controls higher frequencies.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"effects\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Effects\"),\r\n\t\t\t\t\tp(\"JummBox has many different kinds of special effects you can add to instruments. You can turn on multiple effects at once, and they can be configured individually. Try them all out!\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"drumsetEnvelope\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Drumset Envelope\"),\r\n\t\t\t\t\tp(\"This drumset comes with a low-pass filter, and this setting can dynamically change the low-pass filter frequency over time. Each row in the pattern editor can have a different envelope shape.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"drumsetSpectrum\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Drumset Spectrum\"),\r\n\t\t\t\t\tp(\"This setting allows you to draw your own noise spectrum! This is good for making drumsets. Each row in the pattern editor gets its own spectrum.\"),\r\n\t\t\t\t\tp(\"The left side of the spectrum editor controls the noise energy at lower frequencies, and the right side controls higher frequencies.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"chorus\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Chorus\"),\r\n\t\t\t\t\tp(\"The chorus effect combines multiple copies of the instrument's sound and adds a bit of vibrato to simulate an ensemble of instruments or voices. Drag the slider to control how much chorus is added.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"echoSustain\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Echo Volume\"),\r\n\t\t\t\t\tp(\"The echo effect repeats the instrument's sound after a delay. Each echo is a little bit quieter than the last, and this setting controls how much quieter.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"echoDelay\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Echo Delay\"),\r\n\t\t\t\t\tp(\"The echo effect repeats the instrument's sound after a delay, and this setting controls how long the delay is.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"pitchShift\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Pitch Shift\"),\r\n\t\t\t\t\tp(\"This setting makes instruments play higher or lower pitches than the ones displayed in the pattern editor. Be careful that you don't confuse yourself!\"),\r\n\t\t\t\t\tp(\"You can combine this with envelopes to bend pitch over time, or play multiple simultaneous instruments with different pitch shifts for interesting layered sounds.\"),\r\n\t\t\t\t\tp(\"The intervals created by this setting are in \\\"just intonation\\\" which means they stay in phase with the original pitch instead of shifting in and out of phase over time. If you want the shifting, add the detune effect!\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"detune\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Detune\"),\r\n\t\t\t\t\tp(\"This setting slightly adjusts the frequency of notes played by the instrument. You can use a little bit to add a pleasing shifting sound similar to the \\\"unison\\\" feature when combined with other instruments. If you use too much, then the instrument may sound unpleasantly out-of-tune.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"distortion\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Distortion\"),\r\n\t\t\t\t\tp(\"This is the famous electric guitar effect! However, there are some things to be aware of.\"),\r\n\t\t\t\t\tp(\"First, most chords don't sound right when combined with heavy distortion. The only chords commonly used with distorted electric guitars are \\\"power chords\\\" which consist of a root note, a \\\"fifth\\\" note above that, and/or any octaves of those two notes.\"),\r\n\t\t\t\t\tp(\"Second, the distortion sound depends a lot on filtering. In particular, I recommend enabling the note filter effect, and adding both high-pass and low-pass points to the note filter. (Note filters are applied first, then distortion which transforms the sound based on that filtering, then the EQ filter is applied last.)\"),\r\n\t\t\t\t\tp(\"Finally, I recommend adjusting the fade-out setting to allow the end of each note to overlap a little bit with the beginning of the next, but not too much!\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"bitcrusherQuantization\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Bitcrusher Quantization\"),\r\n\t\t\t\t\tp(\"This effect makes stuff sounds harsher, artificial, and \\\"low quality\\\", which is great if that's what you're going for!\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"bitcrusherFreq\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Frequency Quantization\"),\r\n\t\t\t\t\tp(\"The bitcrusher effect comes with an additional frequency quantization effect! This is a fun one to play with, especially when combined with the note filter effect.\"),\r\n\t\t\t\t\tp(\"Every other notch on this slider is aligned with the currently selected key of the song, and the in-between notches are aligned with the tritones of the key.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"stringSustain\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"String sustain\"),\r\n\t\t\t\t\tp(\"This setting controls how quickly the picked string vibration decays.\"),\r\n\t\t\t\t\tp(\"Unlike most of BeepBox's instrument synthesizer features, a picked string cannot change frequency suddenly while maintaining its decay. If a tone's pitch changes suddenly (e.g. if the chord type is set to \\\"arpeggio\\\" or the transition type is set to \\\"continues\\\") then the string will be re-picked and start decaying from the beginning again, even if the envelopes don't otherwise restart.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"envelopes\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Envelopes\"),\r\n\t\t\t\t\tp(\"Envelopes are a way to dynamically adjust various other settings over time, usually based on how long the note lasts. Press the + button to add an envelope, then use the menus below to select which setting to control and the curve of the envelope. Try different combinations to see how they sound!\"),\r\n\t\t\t\t\tp(\"Most envelope curves restart from the beginning every time a new note plays. The \\\"note size\\\" option is based on the note width as drawn in the pattern editor.\"),\r\n\t\t\t\t\tp(\"Envelope curves move in the range from 0 to 1 (or vice versa), where 0 means as quiet as possible and 1 is the same as the corresponding position selected in the instrument settings above. If multiple envelopes are targetting the same setting, they are multiplied before applying to the setting.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"usedInstrument\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th3(\"'Is this instrument used somewhere else?'\"),\r\n\t\t\t\t\tp(\"This indicator will light up when the instrument you're currently looking at is used in another place in your song (outside the selection).\"),\r\n\t\t\t\t\tp(\"This can be useful when you're not sure if you've used the instrument before and making edits carelessly could change other parts of the song.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"usedPattern\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th3(\"'Is this pattern used somewhere else?'\"),\r\n\t\t\t\t\tp(\"This indicator will light up when the pattern you're currently looking at is used in another place in your song (outside the selection).\"),\r\n\t\t\t\t\tp(\"This can be useful when you're not sure if you've used the pattern before and making edits carelessly could change other parts of the song.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"modChannel\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Modulator Channel\"),\r\n\t\t\t\t\tp(\"Modulators can be used to change settings in your song automatically over time. This technique is also known as automation.\"),\r\n\t\t\t\t\tp(\"This setting controls which channel the modulators will take effect for. If you choose 'Song', you can change song-wide settings too!\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"modInstrument\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Modulator Instrument\"),\r\n\t\t\t\t\tp(\"Modulators can be used to change settings in your song automatically over time. This technique is also known as automation.\"),\r\n\t\t\t\t\tp(\"This setting controls which instrument your modulator will apply to within the given channel you've chosen.\"),\r\n\t\t\t\t\tp(\"If you choose 'all', every instrument in the channel will be affected. If you choose 'active', just the current ones used in this pattern will be instead.\"),\r\n\t\t\t\t\tp(\"Note that with 'all' or 'active', effects will only be applied to instruments that the effect is applicable on. For example if an instrument does not have panning effects, modulating panning will not affect it.\")\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"modSet\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Modulator Setting\"),\r\n\t\t\t\t\tp(\"This is the parameter that you want to change with this modulator. For example, if you set this to 'Tempo', you can speed up or slow down your song by laying notes in the pattern editor.\"),\r\n\t\t\t\t\tp(\"Note that you'll see different options if your channel is set to 'Song' versus a channel number. With 'Song', you'll see song-wide settings such as tempo. With a channel, you'll see specific instrument settings. Adding more effects to the instrument causes modulators for them to be available, so be sure to experiment!\"),\r\n\t\t\t\t\tp(\"Most modulators behave as you'd expect and work just as if you were moving their associated slider. Click the '?' when you have a setting selected to get more info about it!\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"modFilter\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Filter Target\"),\r\n\t\t\t\t\tp(\"This setting specifies which parameter of your targeted filter you would like to change.\"),\r\n\t\t\t\t\tp(\"With the 'morph' setting, the note value for your modulator represents the number of a subfilter to 'morph' into over time. For example, dragging a note from 0 to 7 will morph from your main filter to the 7th subfilter. To change how your subfilters are set up, click the '+' button on the target filter.\"),\r\n\t\t\t\t\tp(\"With a Dot setting, you can fine-tune the exact location of every dot on your filter graph. Note that this is extremely intensive if you want to modulate all dots - a morph is better in that case - but this can come in handy for small adjustments.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"transitionBar\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Tie Notes Over Bars\"),\r\n\t\t\t\t\tp(\"With this option ticked, notes won't transition across bars if you put notes with the same pitches at the start of the next bar. Instead they will 'tie over' and sound like one long note.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"clicklessTransition\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Clickless Transition\"),\r\n\t\t\t\t\tp(\"Sometimes, seamless and other transition types can make audible 'clicks' when changing between notes. Ticking this option will cause those clicks to be silenced as much as possible.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"aliases\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Aliasing\"),\r\n\t\t\t\t\tp(\"JummBox applies a technique called 'anti-aliasing' to instruments normally to help them sound cleaner even at high frequencies and low sample rates.\"),\r\n\t\t\t\t\tp(\"When this setting is ticked that technique is disabled, so you may hear strange audio artifacts especially at high pitches and when bending notes. However, this can lend a grungy sound to an instrument that could be desirable.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"operatorWaveform\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Operator Waveform\"),\r\n\t\t\t\t\tp('This setting controls the what kind of sound wave an individual FM wave uses. By defualt the FM synth only uses sinewaves.'),\r\n\t\t\t\t\tp('This feature was ported from Aury system`s GoldBox!'),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"filterType\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Filter Type\"),\r\n\t\t\t\t\tp('Toggling these buttons lets you choose between a simple filter interface with two sliders, or the more advanced filter graph.'),\r\n\t\t\t\t\tp('The two-slider version controls a single low-pass filter and was used in legacy versions. It is not as powerful, but if you feel overwhelmed you can start with this.'),\r\n\t\t\t\t\tp('Note that switching from the simple interface to the advanced interface will convert your current settings, so you can also use it as a basis for later tweaking.'),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"filterCutoff\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Low-Pass Filter Cutoff Frequency\"),\r\n\t\t\t\t\tp(\"The lowest setting feels \\\"muffled\\\" or \\\"dark\\\", and the highest setting feels \\\"harsh\\\" or \\\"bright\\\".\"),\r\n\t\t\t\t\tp(\"Most sounds include a range of frequencies from low to high. JummBox instruments have a filter that allows the lowest frequencies to pass through at full volume, but can reduce the volume of the higher frequencies that are above a cutoff frequency. This setting controls the cutoff frequency and thus the range of higher frequencies that are reduced.\"),\r\n\t\t\t\t\tp(\"This cutoff setting also determines which frequency resonates when the resonance peak setting is used.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"filterResonance\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Low-Pass Filter Resonance Peak\"),\r\n\t\t\t\t\tp(\"Increasing this setting emphasizes a narrow range of frequencies, based on the position of the filter cutoff setting. This can be used to imitate the resonant bodies of acoustic instruments and other interesting effects.\"),\r\n\t\t\t\t\tp(\"The filter preserves the volume of frequencies that are below the cutoff frequency, and reduces the volume of frequencies that are above the cutoff. If this setting is used, the filter also increases the volume of frequencies that are near the cutoff.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\r\n\t\t\tdefault:\r\n\t\t\t\t// Check for modSetinfo#\r\n\t\t\t\tif (type.indexOf(\"modSetInfo\") >= 0) {\r\n\t\t\t\t\tlet modNum: number = +type[type.length - 1];\r\n\t\t\t\t\tlet modulator: number = _doc.song.channels[_doc.channel].instruments[_doc.getCurrentInstrument()].modulators[modNum];\r\n\t\t\t\t\tlet pList: HTMLParagraphElement[] = [];\r\n\t\t\t\t\tfor (let s: number = 0; s < Config.modulators[modulator].promptDesc.length; s++) {\r\n\t\t\t\t\t\tpList.push(p(\r\n\t\t\t\t\t\t\tConfig.modulators[modulator].promptDesc[s]\r\n\t\t\t\t\t\t\t\t.replace(\"$LO\", \"\" + Config.modulators[modulator].convertRealFactor)\r\n\t\t\t\t\t\t\t\t.replace(\"$MID\", \"\" + (Config.modulators[modulator].convertRealFactor + Config.modulators[modulator].maxRawVol / 2))\r\n\t\t\t\t\t\t\t\t.replace(\"$HI\", \"\" + (Config.modulators[modulator].convertRealFactor + Config.modulators[modulator].maxRawVol))\r\n\r\n\t\t\t\t\t\t));\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// Last element for mod settings is just some miscellaneous data for nerds like me.\r\n\t\t\t\t\tpList[pList.length-1].style.setProperty(\"color\", \"var(--secondary-text)\");\r\n\t\t\t\t\tmessage = div(\r\n\t\t\t\t\t\th2(Config.modulators[modulator].promptName),\r\n\t\t\t\t\t\tpList,\r\n\t\t\t\t\t);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tthrow new Error(\"Unhandled TipPrompt type: \" + type);\r\n\t\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tthis.container = div({class: \"prompt\", style: \"width: 300px;\"},\r\n\t\t\tmessage,\r\n\t\t\tthis._closeButton,\r\n\t\t);\r\n\t\t\t\r\n\t\t\tsetTimeout(()=>this._closeButton.focus());\r\n\t\t\t\r\n\t\tthis._closeButton.addEventListener(\"click\", this._close);\r\n\t}\r\n\t\t\r\n\t\tprivate _close = (): void => { \r\n\t\tthis._doc.undo();\r\n\t}\r\n\t\t\r\n\t\tpublic cleanUp = (): void => { \r\n\t\tthis._closeButton.removeEventListener(\"click\", this._close);\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { Pattern } from \"../synth/synth\";\r\nimport { ColorConfig, ChannelColors } from \"./ColorConfig\";\r\nimport { Config } from \"../synth/SynthConfig\";\r\nimport { isMobile } from \"./EditorConfig\";\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { SongEditor } from \"./SongEditor\";\r\nimport { HTML, SVG } from \"imperative-html/dist/esm/elements-strict\";\r\n\r\n\r\nclass Box {\r\n\tprivate readonly _text: Text = document.createTextNode(\"1\");\r\n\t\tprivate readonly _label: SVGTextElement = SVG.text({\"font-family\": \"sans-serif\", \"font-size\": 20, \"text-anchor\": \"middle\", \"font-weight\": \"bold\", fill: \"red\"}, this._text);\r\n\t\tprivate readonly _rect: SVGRectElement = SVG.rect({x: 1, y: 1});\r\n\tpublic readonly container: SVGSVGElement = SVG.svg(this._rect, this._label);\r\n\tprivate _renderedIndex: number = 1;\r\n\tprivate _renderedDim: boolean = true;\r\n\tprivate _renderedSelected: boolean = false;\r\n\tprivate _renderedColor: string = \"\";\r\n\r\n\tconstructor(channel: number, private readonly _x: number, private readonly _y: number, color: string) {\r\n\t\tthis._rect.setAttribute(\"fill\", ColorConfig.uiWidgetBackground);\r\n\t\tthis._label.setAttribute(\"fill\", color);\r\n\t}\r\n\t\t\r\n\tpublic setSize(width: number, height: number): void {\r\n\t\tthis.container.setAttribute(\"x\", \"\" + (this._x * width));\r\n\t\tthis.container.setAttribute(\"y\", \"\" + (Config.barEditorHeight + this._y * height));\r\n\t\tthis._rect.setAttribute(\"width\", \"\" + (width - 2));\r\n\t\tthis._rect.setAttribute(\"height\", \"\" + (height - 2));\r\n\t\tthis._label.setAttribute(\"x\", \"\" + (width / 2));\r\n\t\tthis._label.setAttribute(\"y\", \"\" + Math.round(height / 2 + 7));\r\n\t}\r\n\t\t\r\n\tpublic setIndex(index: number, dim: boolean, selected: boolean, color: string, isNoise: boolean, isMod: boolean): void {\r\n\t\tif (this._renderedIndex != index) {\r\n\t\t\tif (!this._renderedSelected && ((index == 0) != (this._renderedIndex == 0))) {\r\n\t\t\t\tif (index == 0) {\r\n\t\t\t\t\tthis._rect.setAttribute(\"fill\", \"none\");\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tif (isNoise)\r\n\t\t\t\t\t\tthis._rect.setAttribute(\"fill\", dim ? ColorConfig.trackEditorBgNoiseDim : ColorConfig.trackEditorBgNoise);\r\n\t\t\t\t\telse if (isMod)\r\n\t\t\t\t\t\tthis._rect.setAttribute(\"fill\", dim ? ColorConfig.trackEditorBgModDim : ColorConfig.trackEditorBgMod);\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tthis._rect.setAttribute(\"fill\", dim ? ColorConfig.trackEditorBgPitchDim : ColorConfig.trackEditorBgPitch);\r\n\r\n\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (index >= 100) {\r\n\t\t\t\tthis._label.setAttribute(\"font-size\", \"16\");\r\n\t\t\t\tthis._label.setAttribute(\"style\", \"transform: translate(0px, -1.5px);\");\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tthis._label.setAttribute(\"font-size\", \"20\");\r\n\t\t\t\tthis._label.setAttribute(\"style\", \"transform: translate(0px, 0px);\");\r\n\t\t\t}\r\n\r\n\t\t\tthis._renderedIndex = index;\r\n\t\t\t\tthis._text.data = \"\"+index;\r\n\t\t}\r\n\t\t\t\r\n\t\tif (this._renderedDim != dim || this._renderedColor != color) {\r\n\t\t\tthis._renderedDim = dim;\r\n\t\t\tif (selected) {\r\n\t\t\t\tthis._label.setAttribute(\"fill\", ColorConfig.invertedText);\r\n\t\t\t} else {\r\n\t\t\t\tthis._label.setAttribute(\"fill\", color);\r\n\r\n\t\t\t\tif (this._renderedIndex == 0) {\r\n\t\t\t\t\tthis._rect.setAttribute(\"fill\", ColorConfig.editorBackground);\r\n\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tif (isNoise)\r\n\t\t\t\t\t\tthis._rect.setAttribute(\"fill\", dim ? ColorConfig.trackEditorBgNoiseDim : ColorConfig.trackEditorBgNoise);\r\n\t\t\t\t\telse if (isMod)\r\n\t\t\t\t\t\tthis._rect.setAttribute(\"fill\", dim ? ColorConfig.trackEditorBgModDim : ColorConfig.trackEditorBgMod);\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tthis._rect.setAttribute(\"fill\", dim ? ColorConfig.trackEditorBgPitchDim : ColorConfig.trackEditorBgPitch);\r\n\t\t\t\t}\r\n\t\t}\r\n\t\t}\r\n\t\t\t\r\n\t\tif (this._renderedSelected != selected || this._renderedColor != color) {\r\n\t\t\tthis._renderedSelected = selected;\r\n\t\t\tif (selected) {\r\n\t\t\t\tthis._rect.setAttribute(\"fill\", color);\r\n\t\t\t\tthis._label.setAttribute(\"fill\", ColorConfig.invertedText);\r\n\t\t\t} else {\r\n\t\t\t\tthis._label.setAttribute(\"fill\", color);\r\n\r\n\t\t\t\tif (this._renderedIndex == 0) {\r\n\t\t\t\t\tthis._rect.setAttribute(\"fill\", ColorConfig.editorBackground);\r\n\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tif (isNoise)\r\n\t\t\t\t\t\tthis._rect.setAttribute(\"fill\", dim ? ColorConfig.trackEditorBgNoiseDim : ColorConfig.trackEditorBgNoise);\r\n\t\t\t\t\telse if (isMod)\r\n\t\t\t\t\t\tthis._rect.setAttribute(\"fill\", dim ? ColorConfig.trackEditorBgModDim : ColorConfig.trackEditorBgMod);\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tthis._rect.setAttribute(\"fill\", dim ? ColorConfig.trackEditorBgPitchDim : ColorConfig.trackEditorBgPitch);\r\n\t\t\t\t}\r\n\t\t}\r\n\t\t}\r\n\t\t\t\r\n\t\tthis._renderedColor = color;\r\n\t}\r\n}\r\n\r\nexport class TrackEditor {\r\n\tpublic readonly _barDropDown: HTMLSelectElement = HTML.select({ style: \"width: 32px; height: \" + Config.barEditorHeight + \"px; top: 0px; position: absolute; opacity: 0\" },\r\n\r\n\t\tHTML.option({ value: \"barBefore\" }, \"Insert Bar Before\"),\r\n\t\tHTML.option({ value: \"barAfter\" }, \"Insert Bar After\"),\r\n\t\tHTML.option({ value: \"deleteBar\" }, \"Delete This Bar\"),\r\n\t);\r\n\tprivate readonly _boxContainer: SVGGElement = SVG.g();\r\n\tprivate readonly _barNumberContainer: SVGGElement = SVG.g();\r\n\t\tprivate readonly _playhead: SVGRectElement = SVG.rect({fill: ColorConfig.playhead, x: 0, y: 0, width: 4, height: 128});\r\n\t\tprivate readonly _boxHighlight: SVGRectElement = SVG.rect({fill: \"none\", stroke: ColorConfig.hoverPreview, \"stroke-width\": 2, \"pointer-events\": \"none\", x: 1, y: 1, width: 30, height: 30});\r\n\t\tprivate readonly _upHighlight: SVGPathElement = SVG.path({fill: ColorConfig.invertedText, stroke: ColorConfig.invertedText, \"stroke-width\": 1, \"pointer-events\": \"none\"});\r\n\t\tprivate readonly _downHighlight: SVGPathElement = SVG.path({fill: ColorConfig.invertedText, stroke: ColorConfig.invertedText, \"stroke-width\": 1, \"pointer-events\": \"none\"});\r\n\tprivate readonly _barEditorPath: SVGPathElement = SVG.path({ fill: ColorConfig.uiWidgetBackground, stroke: ColorConfig.uiWidgetBackground, \"stroke-width\": 1, \"pointer-events\": \"none\" });\r\n\tprivate readonly _selectionRect: SVGRectElement = SVG.rect({ class: \"dashed-line dash-move\", fill: ColorConfig.boxSelectionFill, stroke: ColorConfig.hoverPreview, \"stroke-width\": 2, \"stroke-dasharray\": \"5, 3\", \"fill-opacity\": \"0.4\", \"pointer-events\": \"none\", visibility: \"hidden\", x: 1, y: 1, width: 62, height: 62 });\r\n\t\tprivate readonly _svg: SVGSVGElement = SVG.svg({style: `background-color: ${ColorConfig.editorBackground}; position: absolute;`, height: 128},\r\n\t\tthis._boxContainer,\r\n\t\tthis._barEditorPath,\r\n\t\tthis._selectionRect,\r\n\t\tthis._barNumberContainer,\r\n\t\tthis._boxHighlight,\r\n\t\tthis._upHighlight,\r\n\t\tthis._downHighlight,\r\n\t\tthis._playhead,\r\n\t);\r\n\t\tprivate readonly _select: HTMLSelectElement = HTML.select({class: \"trackSelectBox\", style: \"background: none; border: none; appearance: none; border-radius: initial; box-shadow: none; color: transparent; position: absolute; touch-action: none;\"});\r\n\tpublic readonly container: HTMLElement = HTML.div({ class: \"noSelection\", style: \"height: 128px; position: relative; overflow:hidden;\" }, this._svg, this._select, this._barDropDown);\r\n\t\t\r\n\tprivate readonly _grid: Box[][] = [];\r\n\tprivate readonly _barNumbers: SVGTextElement[] = [];\r\n\tprivate _mouseX: number = 0;\r\n\tprivate _mouseY: number = 0;\r\n\t//private _lastScrollTime: number = 0;\r\n\t//private _selecting: boolean = false;\r\n\t//private _selectionStartBar: number = 0;\r\n\t//private _selectionStartChannel: number = 0;\r\n\t//private _pattern: Pattern | null = null;\r\n\tprivate _mouseStartBar: number = 0;\r\n\tprivate _mouseStartChannel: number = 0;\r\n\tprivate _mouseBar: number = 0;\r\n\tprivate _mouseChannel: number = 0;\r\n\tprivate _mouseOver: boolean = false;\r\n\tprivate _mousePressed: boolean = false;\r\n\tprivate _mouseDragging = false;\r\n\tprivate _barWidth: number = 32;\r\n\tprivate _channelHeight: number = 32;\r\n\tprivate _renderedChannelCount: number = 0;\r\n\tprivate _renderedBarCount: number = 0;\r\n\tprivate _renderedPatternCount: number = 0;\r\n\tprivate _renderedPlayhead: number = -1;\r\n\tprivate _renderedBarWidth: number = -1;\r\n\tprivate _renderedChannelHeight: number = -1;\r\n\tprivate _touchMode: boolean = isMobile;\r\n\tprivate _barDropDownBar: number = 0;\r\n\tprivate _lastScrollTime: number = 0;\r\n\t\t\r\n\tconstructor(private _doc: SongDocument, private _songEditor: SongEditor) {\r\n\t\twindow.requestAnimationFrame(this._animatePlayhead);\r\n\t\tthis._svg.addEventListener(\"mousedown\", this._whenMousePressed);\r\n\t\tdocument.addEventListener(\"mousemove\", this._whenMouseMoved);\r\n\t\tdocument.addEventListener(\"mouseup\", this._whenMouseReleased);\r\n\t\tthis._svg.addEventListener(\"mouseover\", this._whenMouseOver);\r\n\t\tthis._svg.addEventListener(\"mouseout\", this._whenMouseOut);\r\n\t\t\t\r\n\t\tthis._select.addEventListener(\"change\", this._whenSelectChanged);\r\n\t\tthis._select.addEventListener(\"touchstart\", this._whenSelectPressed);\r\n\t\tthis._select.addEventListener(\"touchmove\", this._whenSelectMoved);\r\n\t\tthis._select.addEventListener(\"touchend\", this._whenSelectReleased);\r\n\t\tthis._select.addEventListener(\"touchcancel\", this._whenSelectReleased);\r\n\t\t\t\r\n\t\tlet determinedCursorType: boolean = false;\r\n\t\tdocument.addEventListener(\"mousedown\", () => {\r\n\t\t\tif (!determinedCursorType) {\r\n\t\t\t\tthis._touchMode = false;\r\n\t\t\t\tthis._updatePreview();\r\n\t\t\t}\r\n\t\t\tdeterminedCursorType = true;\r\n\t\t}, true);\r\n\t\tdocument.addEventListener(\"touchstart\", () => {\r\n\t\t\tif (!determinedCursorType) {\r\n\t\t\t\tthis._touchMode = true;\r\n\t\t\t\tthis._updatePreview();\r\n\t\t\t}\r\n\t\t\tdeterminedCursorType = true;\r\n\t\t}, true);\r\n\r\n\t\tthis._barDropDown.selectedIndex = -1;\r\n\t\tthis._barDropDown.addEventListener(\"change\", this._barDropDownHandler);\r\n\t\tthis._barDropDown.addEventListener(\"mousedown\", this._barDropDownGetOpenedPosition);\r\n\r\n\t}\r\n\r\n\tprivate _barDropDownGetOpenedPosition = (event: MouseEvent): void => {\r\n\t\tthis._barDropDownBar = Math.floor(Math.min(this._doc.song.barCount - 1, Math.max(0, this._mouseX / this._barWidth)));\r\n\t}\r\n\r\n\tprivate _barDropDownHandler = (event: Event): void => {\r\n\r\n\t\tvar moveBarOffset = (this._barDropDown.value == \"barBefore\") ? 0 : 1;\r\n\r\n\t\tif (this._barDropDown.value == \"barBefore\" || this._barDropDown.value == \"barAfter\") {\r\n\r\n\t\t\t//var prevBar = this._doc.bar;\r\n\r\n\t\t\tthis._doc.bar = this._barDropDownBar - 1 + moveBarOffset;\r\n\r\n\t\t\tthis._doc.selection.resetBoxSelection();\r\n\t\t\tthis._doc.selection.insertBars();\r\n\r\n\t\t\t// This moves doc.bar back. I kind of like moving it to the inserted zone, though.\r\n\t\t\t// this._doc.bar = prevBar + ((prevBar < this._barDropDownBar + moveBarOffset) ? 0 : 1);\r\n\r\n\t\t\t// Adjust song playhead\r\n\t\t\tif (this._doc.synth.playhead >= this._barDropDownBar + moveBarOffset) {\r\n\t\t\t\tthis._doc.synth.playhead++;\r\n\t\t\t\tthis._songEditor._barScrollBar.animatePlayhead();\r\n\t\t\t}\r\n\r\n\t}\r\n\t\telse if (this._barDropDown.value == \"deleteBar\") {\r\n\t\t\r\n\t\t\t//var prevBar = this._doc.bar;\r\n\r\n\t\t\tthis._doc.bar = this._barDropDownBar;\r\n\r\n\t\t\tthis._doc.selection.resetBoxSelection();\r\n\t\t\tthis._doc.selection.deleteBars();\r\n\r\n\t\t\t// This moves doc.bar back. I kind of like moving it to the deleted zone, though.\r\n\t\t\t// this._doc.bar = prevBar - ((prevBar <= this._barDropDownBar) ? 0 : 1);\r\n\r\n\t\t\t// Adjust song playhead\r\n\t\t\tif (this._doc.synth.playhead > this._barDropDownBar) {\r\n\t\t\t\tthis._doc.synth.playhead--;\r\n\t\t\t\tthis._songEditor._barScrollBar.animatePlayhead();\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\tthis._barDropDown.selectedIndex = -1;\r\n\t}\r\n\r\n\tprivate _whenSelectChanged = (): void => {\r\n\t\tthis._doc.selection.setPattern(this._select.selectedIndex);\r\n\t}\r\n\t\t\r\n\tprivate _animatePlayhead = (timestamp: number): void => {\r\n\t\tconst playhead = (this._barWidth * this._doc.synth.playhead - 2);\r\n\t\tif (this._renderedPlayhead != playhead) {\r\n\t\t\tthis._renderedPlayhead = playhead;\r\n\t\t\tthis._playhead.setAttribute(\"x\", \"\" + playhead);\r\n\t\t}\r\n\t\twindow.requestAnimationFrame(this._animatePlayhead);\r\n\t}\r\n\t\r\n\tpublic movePlayheadToMouse(): boolean {\r\n\t\tif (this._mouseOver) {\r\n\t\t\tthis._doc.synth.playhead = this._mouseBar + (this._mouseX % this._barWidth) / this._barWidth;\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\t\r\n\tprivate _dragBoxSelection(): void {\r\n\t\tthis._doc.selection.setTrackSelection(this._doc.selection.boxSelectionX0, this._mouseBar, this._doc.selection.boxSelectionY0, this._mouseChannel);\r\n\t\tthis._doc.selection.selectionUpdated();\r\n\t}\r\n\t\t\r\n\tprivate _updateSelectPos(event: TouchEvent): void {\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = event.touches[0].clientX - boundingRect.left;\r\n\t\tthis._mouseY = event.touches[0].clientY - boundingRect.top;\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._mouseBar = Math.floor(Math.min(this._doc.song.barCount - 1, Math.max(0, this._mouseX / this._barWidth)));\r\n\t\tthis._mouseChannel = Math.floor(Math.min(this._doc.song.getChannelCount() - 1, Math.max(0, (this._mouseY - Config.barEditorHeight) / this._channelHeight)));\r\n\t}\r\n\t\t\r\n\tprivate _whenSelectPressed = (event: TouchEvent): void => {\r\n\t\tthis._mousePressed = true;\r\n\t\tthis._mouseDragging = true;\r\n\t\tthis._updateSelectPos(event);\r\n\t\tthis._mouseStartBar = this._mouseBar;\r\n\t\tthis._mouseStartChannel = this._mouseChannel;\r\n\t}\r\n\t\t\r\n\tprivate _whenSelectMoved = (event: TouchEvent): void => {\r\n\t\tthis._updateSelectPos(event);\r\n\t\tif (this._mouseStartBar != this._mouseBar || this._mouseStartChannel != this._mouseChannel) {\r\n\t\t\t// if the touch has started dragging, cancel opening the select menu.\r\n\t\t\tevent.preventDefault();\r\n\t\t}\r\n\t\tif (this._mousePressed) this._dragBoxSelection();\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\t\r\n\tprivate _whenSelectReleased = (event: TouchEvent): void => {\r\n\t\tthis._mousePressed = false;\r\n\t\tthis._mouseDragging = false;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\t\r\n\tprivate _whenMouseOver = (event: MouseEvent): void => {\r\n\t\tif (this._mouseOver) return;\r\n\t\tthis._mouseOver = true;\r\n\t}\r\n\t\t\r\n\tprivate _whenMouseOut = (event: MouseEvent): void => {\r\n\t\tif (!this._mouseOver) return;\r\n\t\tthis._mouseOver = false;\r\n\t}\r\n\t\t\r\n\tprivate _updateMousePos(event: MouseEvent): void {\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.clientX || event.pageX) - boundingRect.left;\r\n\t\tthis._mouseY = (event.clientY || event.pageY) - boundingRect.top;\r\n\t\tthis._mouseBar = Math.floor(Math.min(this._doc.song.barCount - 1, Math.max(0, this._mouseX / this._barWidth)));\r\n\t\tthis._mouseChannel = Math.floor(Math.min(this._doc.song.getChannelCount() - 1, Math.max(0, (this._mouseY - Config.barEditorHeight) / this._channelHeight)));\r\n\t}\r\n\t\t\r\n\tprivate _whenMousePressed = (event: MouseEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._mousePressed = true;\r\n\t\tthis._updateMousePos(event);\r\n\t\tthis._mouseStartBar = this._mouseBar;\r\n\t\tthis._mouseStartChannel = this._mouseChannel;\r\n\r\n\t\t// Act on track portion\r\n\t\tif (this._mouseY >= Config.barEditorHeight) {\r\n\r\n\t\tif (event.shiftKey) {\r\n\t\t\tthis._mouseDragging = true;\r\n\t\t\tthis._doc.selection.setTrackSelection(this._doc.selection.boxSelectionX0, this._mouseBar, this._doc.selection.boxSelectionY0, this._mouseChannel);\r\n\t\t\tthis._doc.selection.selectionUpdated();\r\n\t\t} else {\r\n\t\t\tthis._mouseDragging = false;\r\n\t\t\tif (this._doc.channel != this._mouseChannel || this._doc.bar != this._mouseBar) {\r\n\t\t\t\tthis._doc.selection.setChannelBar(this._mouseChannel, this._mouseBar);\r\n\t\t\t\tthis._mouseDragging = true;\r\n\t\t\t}\r\n\t\t\tthis._doc.selection.resetBoxSelection();\r\n\t\t}\r\n\t}\r\n\t}\r\n\t\t\r\n\tprivate _whenMouseMoved = (event: MouseEvent): void => {\r\n\t\tthis._updateMousePos(event);\r\n\t\tif (this._mousePressed) {\r\n\t\t\tif (this._mouseStartBar != this._mouseBar || this._mouseStartChannel != this._mouseChannel) {\r\n\t\t\t\tthis._mouseDragging = true;\r\n\t\t\t}\r\n\t\t\tthis._dragBoxSelection();\r\n\t\t}\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\t\r\n\tprivate _whenMouseReleased = (event: MouseEvent): void => {\r\n\t\tif (this._mousePressed && !this._mouseDragging) {\r\n\t\t\tif (this._doc.channel == this._mouseChannel && this._doc.bar == this._mouseBar) {\r\n\t\t\t\tconst up: boolean = ((this._mouseY - Config.barEditorHeight) % this._channelHeight) < this._channelHeight / 2;\r\n\t\t\t\tconst patternCount: number = this._doc.song.patternsPerChannel;\r\n\t\t\t\tthis._doc.selection.setPattern((this._doc.song.channels[this._mouseChannel].bars[this._mouseBar] + (up ? 1 : patternCount)) % (patternCount + 1));\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis._mousePressed = false;\r\n\t\tthis._mouseDragging = false;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\t\r\n\tprivate _updatePreview(): void {\r\n\t\tlet channel: number = this._mouseChannel;\r\n\t\tlet bar: number = this._mouseBar;\r\n\t\t\t\r\n\t\tif (this._touchMode) {\r\n\t\t\tbar = this._doc.bar;\r\n\t\t\tchannel = this._doc.channel;\r\n\t\t}\r\n\t\t\t\r\n\t\tconst selected: boolean = (bar == this._doc.bar && channel == this._doc.channel);\r\n\t\tconst overTrackEditor: boolean = (this._mouseY >= Config.barEditorHeight);\r\n\t\t\t\r\n\t\tif (this._mouseDragging && this._mouseStartBar != this._mouseBar) {\r\n\r\n\t\t\t// Handle auto-scroll in selection. Only @50ms or slower.\r\n\t\t\tvar timestamp: number = Date.now();\r\n\r\n\t\t\tif (timestamp - this._lastScrollTime >= 50) {\r\n\r\n\t\t\t\tif (bar > this._doc.barScrollPos + this._doc.trackVisibleBars - 1 && this._doc.barScrollPos < this._doc.song.barCount - this._doc.trackVisibleBars) {\r\n\r\n\t\t\t\t\tthis._songEditor.changeBarScrollPos(1);\r\n\t\t\t\t}\r\n\t\t\t\tif (bar < this._doc.barScrollPos && this._doc.barScrollPos > 0) {\r\n\r\n\t\t\t\t\tthis._songEditor.changeBarScrollPos(-1);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tthis._lastScrollTime = timestamp;\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\tif (this._mouseOver && !this._mousePressed && !selected && overTrackEditor) {\r\n\t\t\tthis._boxHighlight.setAttribute(\"x\", \"\" + (1 + this._barWidth * bar));\r\n\t\t\tthis._boxHighlight.setAttribute(\"y\", \"\" + (1 + Config.barEditorHeight + (this._channelHeight * channel)));\r\n\t\t\tthis._boxHighlight.setAttribute(\"height\", \"\" + (this._channelHeight - 2));\r\n\t\t\tthis._boxHighlight.setAttribute(\"width\", \"\" + (this._barWidth - 2));\r\n\t\t\tthis._boxHighlight.style.visibility = \"visible\";\r\n\t\t} else if ((this._mouseOver || ((this._mouseX >= bar * this._barWidth) && (this._mouseX < bar * this._barWidth + this._barWidth) && (this._mouseY > 0))) && (!overTrackEditor)) {\r\n\t\t\tthis._boxHighlight.setAttribute(\"x\", \"\" + (1 + this._barWidth * bar));\r\n\t\t\tthis._boxHighlight.setAttribute(\"y\", \"1\"); // The y is set to 1 instead of 0 due to the thickness of the box causing it to go slightly outside the frame at y=0.\r\n\t\t\tthis._boxHighlight.setAttribute(\"height\", \"\" + (Config.barEditorHeight - 3));\r\n\t\t\tthis._boxHighlight.style.visibility = \"visible\";\r\n\t\t} else {\r\n\t\t\tthis._boxHighlight.style.visibility = \"hidden\";\r\n\t\t}\r\n\t\t\t\r\n\t\tif ((this._mouseOver || this._touchMode) && selected && overTrackEditor) {\r\n\t\t\tconst up: boolean = ((this._mouseY - Config.barEditorHeight) % this._channelHeight) < this._channelHeight / 2;\r\n\t\t\tconst center: number = this._barWidth * (bar + 0.8);\r\n\t\t\tconst middle: number = Config.barEditorHeight + this._channelHeight * (channel + 0.5);\r\n\t\t\tconst base: number = this._channelHeight * 0.1;\r\n\t\t\tconst tip: number = this._channelHeight * 0.4;\r\n\t\t\tconst width: number = this._channelHeight * 0.175;\r\n\t\t\t\t\r\n\t\t\tthis._upHighlight.setAttribute(\"fill\", up && !this._touchMode ? ColorConfig.hoverPreview : ColorConfig.invertedText);\r\n\t\t\tthis._downHighlight.setAttribute(\"fill\", !up && !this._touchMode ? ColorConfig.hoverPreview : ColorConfig.invertedText);\r\n\t\t\t\t\r\n\t\t\tthis._upHighlight.setAttribute(\"d\", `M ${center} ${middle - tip} L ${center + width} ${middle - base} L ${center - width} ${middle - base} z`);\r\n\t\t\tthis._downHighlight.setAttribute(\"d\", `M ${center} ${middle + tip} L ${center + width} ${middle + base} L ${center - width} ${middle + base} z`);\r\n\t\t\t\t\r\n\t\t\tthis._upHighlight.style.visibility = \"visible\";\r\n\t\t\tthis._downHighlight.style.visibility = \"visible\";\r\n\t\t} else {\r\n\t\t\tthis._upHighlight.style.visibility = \"hidden\";\r\n\t\t\tthis._downHighlight.style.visibility = \"hidden\";\r\n\t\t}\r\n\t\t\t\r\n\t\tthis._selectionRect.style.left = (this._barWidth * this._doc.bar) + \"px\";\r\n\t\tthis._selectionRect.style.top = (Config.barEditorHeight + (this._channelHeight * this._doc.channel)) + \"px\";\r\n\r\n\t\tthis._select.style.left = (this._barWidth * this._doc.bar) + \"px\";\r\n\r\n\t\tthis._select.style.width = this._barWidth + \"px\";\r\n\t\tthis._select.style.top = (Config.barEditorHeight + this._channelHeight * this._doc.channel) + \"px\";\r\n\t\tthis._select.style.height = this._channelHeight + \"px\";\r\n\t\t\t\r\n\t\tthis._barDropDown.style.left = (this._barWidth * bar) + \"px\";\r\n\r\n\t\tconst patternCount: number = this._doc.song.patternsPerChannel + 1;\r\n\t\tfor (let i: number = this._renderedPatternCount; i < patternCount; i++) {\r\n\t\t\t\tthis._select.appendChild(HTML.option({value: i}, i));\r\n\t\t}\r\n\t\tfor (let i: number = patternCount; i < this._renderedPatternCount; i++) {\r\n\t\t\t\tthis._select.removeChild(<Node> this._select.lastChild);\r\n\t\t}\r\n\t\tthis._renderedPatternCount = patternCount;\r\n\t\tconst selectedPattern: number = this._doc.song.channels[this._doc.channel].bars[this._doc.bar];\r\n\t\tif (this._select.selectedIndex != selectedPattern) this._select.selectedIndex = selectedPattern;\r\n\t}\r\n\t\t\r\n\tpublic render(): void {\r\n\r\n\t\tthis._barWidth = this._doc.getBarWidth();\r\n\t\tthis._channelHeight = this._doc.getChannelHeight();\r\n\t\t\t\r\n\t\tif (this._renderedChannelCount != this._doc.song.getChannelCount()) {\r\n\r\n\t\t\t// Add new channel boxes if needed\r\n\t\t\tfor (let y: number = this._renderedChannelCount; y < this._doc.song.getChannelCount(); y++) {\r\n\t\t\t\tthis._grid[y] = [];\r\n\t\t\t\tfor (let x: number = 0; x < this._renderedBarCount; x++) {\r\n\t\t\t\t\tconst box: Box = new Box(y, x, y, ColorConfig.getChannelColor(this._doc.song, y).secondaryChannel);\r\n\t\t\t\t\tbox.setSize(this._barWidth, this._channelHeight);\r\n\t\t\t\t\tthis._boxContainer.appendChild(box.container);\r\n\t\t\t\t\tthis._grid[y][x] = box;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\t\r\n\t\t\t// Remove old channel boxes\r\n\t\t\tfor (let y: number = this._doc.song.getChannelCount(); y < this._renderedChannelCount; y++) {\r\n\t\t\t\tfor (let x: number = 0; x < this._renderedBarCount; x++) {\r\n\t\t\t\t\tthis._boxContainer.removeChild(this._grid[y][x].container);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\t\r\n\t\t\tthis._grid.length = this._doc.song.getChannelCount();\r\n\t\t\tthis._mousePressed = false;\r\n\t\t}\r\n\t\t\t\r\n\t\tif (this._renderedBarCount != this._doc.song.barCount || this._renderedBarWidth != this._barWidth) {\r\n\t\t\tfor (let y: number = 0; y < this._doc.song.getChannelCount(); y++) {\r\n\t\t\t\tfor (let x: number = this._renderedBarCount; x < this._doc.song.barCount; x++) {\r\n\t\t\t\t\tconst box: Box = new Box(y, x, y, ColorConfig.getChannelColor(this._doc.song, y).secondaryChannel);\r\n\t\t\t\t\tbox.setSize(this._barWidth, this._channelHeight);\r\n\t\t\t\t\tthis._boxContainer.appendChild(box.container);\r\n\t\t\t\t\tthis._grid[y][x] = box;\r\n\t\t\t\t}\r\n\t\t\t\tfor (let x: number = this._doc.song.barCount; x < this._renderedBarCount; x++) {\r\n\t\t\t\t\tthis._boxContainer.removeChild(this._grid[y][x].container);\r\n\t\t\t\t}\r\n\t\t\t\tthis._grid[y].length = this._doc.song.barCount;\r\n\t\t\t}\r\n\r\n\t\t\t// Update bar editor's SVG\r\n\t\t\t// this._upHighlight.setAttribute(\"d\", `M ${center} ${middle - tip} L ${center + width} ${middle - base} L ${center - width} ${middle - base} z`);\r\n\t\t\t//this._downHighlight.setAttribute(\"d\", `M ${center} ${middle + tip} L ${center + width} ${middle + base} L ${center - width} ${middle + base} z`);\r\n\r\n\t\t\tvar pathString = \"\";\r\n\r\n\t\t\tfor (let x: number = 0; x < this._doc.song.barCount; x++) {\r\n\t\t\t\tvar pathLeft = x * this._barWidth + 2;\r\n\t\t\t\tvar pathTop = 1;\r\n\t\t\t\tvar pathRight = x * this._barWidth + this._barWidth - 2;\r\n\t\t\t\tvar pathBottom = Config.barEditorHeight - 3;\r\n\r\n\t\t\t\tpathString += `M ${pathLeft} ${pathTop} H ${pathRight} V ${pathBottom} H ${pathLeft} V ${pathTop} Z `;\r\n\t\t}\r\n\t\t\t\r\n\t\t\tthis._barEditorPath.setAttribute(\"d\", pathString);\r\n\r\n\t\t\tif (this._renderedBarCount < this._doc.song.barCount) {\r\n\t\t\t\tthis._barNumbers.length = this._doc.song.barCount;\r\n\t\t\t\tfor (var pos = this._renderedBarCount; pos < this._barNumbers.length; pos++) {\r\n\t\t\t\t\tthis._barNumbers[pos] = SVG.text({ \"font-family\": \"sans-serif\", \"font-size\": \"8px\", \"text-anchor\": \"middle\", \"font-weight\": \"bold\", \"x\": (pos * this._barWidth + this._barWidth / 2) + \"px\", \"y\": \"7px\", fill: ColorConfig.secondaryText }, \"\" + (pos + 1));\r\n\t\t\t\t\tif (pos % 4 == 0) {\r\n\t\t\t\t\t\t// Highlighting every 4 bars\r\n\t\t\t\t\t\tthis._barNumbers[pos].setAttribute(\"fill\", ColorConfig.primaryText);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis._barNumberContainer.appendChild(this._barNumbers[pos]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse if (this._renderedBarCount > this._doc.song.barCount) {\r\n\t\t\t\tfor (var pos = this._renderedBarCount - 1; pos >= this._doc.song.barCount; pos--) {\r\n\t\t\t\t\tthis._barNumberContainer.removeChild(this._barNumbers[pos]);\r\n\t\t\t\t}\r\n\t\t\t\tthis._barNumbers.length = this._doc.song.barCount;\r\n\t\t\t}\r\n\r\n\t\t\t// Update x of bar editor numbers\r\n\t\t\tif (this._renderedBarWidth != this._barWidth) {\r\n\t\t\t\tfor (var pos = 0; pos < this._barNumbers.length; pos++) {\r\n\t\t\t\t\tthis._barNumbers[pos].setAttribute(\"x\", (pos * this._barWidth + this._barWidth / 2) + \"px\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\r\n\t\t\tthis._renderedBarCount = this._doc.song.barCount;\r\n\t\t\tconst editorWidth = this._barWidth * this._doc.song.barCount;\r\n\t\t\tthis.container.style.width = editorWidth + \"px\";\r\n\t\t\tthis._svg.setAttribute(\"width\", editorWidth + \"\");\r\n\t\t\tthis._mousePressed = false;\r\n\t\t}\r\n\t\t\t\r\n\t\tif (this._renderedChannelHeight != this._channelHeight || this._renderedBarWidth != this._barWidth) {\r\n\t\t\tthis._renderedBarWidth = this._barWidth;\r\n\t\t\tfor (let y: number = 0; y < this._doc.song.getChannelCount(); y++) {\r\n\t\t\t\tfor (let x: number = 0; x < this._renderedBarCount; x++) {\r\n\t\t\t\t\tthis._grid[y][x].setSize(this._barWidth, this._channelHeight);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis._mousePressed = false;\r\n\t\t}\r\n\t\t\t\r\n\t\tif (this._renderedChannelHeight != this._channelHeight || this._renderedChannelCount != this._doc.song.getChannelCount()) {\r\n\t\t\tthis._renderedChannelHeight = this._channelHeight;\r\n\t\t\tthis._renderedChannelCount = this._doc.song.getChannelCount();\r\n\t\t\tconst editorHeight: number = Config.barEditorHeight + this._doc.song.getChannelCount() * this._channelHeight;\r\n\t\t\tthis._svg.setAttribute(\"height\", \"\" + editorHeight);\r\n\t\t\tthis._playhead.setAttribute(\"height\", \"\" + editorHeight);\r\n\t\t\tthis.container.style.height = editorHeight + \"px\";\r\n\t\t}\r\n\t\t\t\r\n\t\tfor (let j: number = 0; j < this._doc.song.getChannelCount(); j++) {\r\n\t\t\tfor (let i: number = 0; i < this._renderedBarCount; i++) {\r\n\t\t\t\tconst pattern: Pattern | null = this._doc.song.getPattern(j, i);\r\n\t\t\t\tconst selected: boolean = (i == this._doc.bar && j == this._doc.channel);\r\n\t\t\t\tconst dim: boolean = (pattern == null || pattern.notes.length == 0);\r\n\t\t\t\t\t\r\n\t\t\t\tconst box: Box = this._grid[j][i];\r\n\t\t\t\tif (i < this._doc.song.barCount) {\r\n\t\t\t\t\tconst colors: ChannelColors = ColorConfig.getChannelColor(this._doc.song, j);\r\n\t\t\t\t\tbox.setIndex(this._doc.song.channels[j].bars[i], dim, selected, dim && !selected ? colors.secondaryChannel : colors.primaryChannel, j >= this._doc.song.pitchChannelCount && j < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount, j >= this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount);\r\n\t\t\t\t\tbox.container.style.visibility = \"visible\";\r\n\t\t\t\t} else {\r\n\t\t\t\t\tbox.container.style.visibility = \"hidden\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t\t\t\r\n\t\tthis._select.style.display = this._touchMode ? \"\" : \"none\";\r\n\t\t\r\n\t\tif (this._doc.selection.boxSelectionActive) {\r\n\t\t\t// TODO: This causes the selection rectangle to repaint every time the\r\n\t\t\t// editor renders and the selection is visible. Check if anything changed\r\n\t\t\t// before overwriting the attributes?\r\n\t\t\tthis._selectionRect.setAttribute(\"x\", String(this._barWidth * this._doc.selection.boxSelectionBar + 1));\r\n\t\t\tthis._selectionRect.setAttribute(\"y\", String(Config.barEditorHeight + this._channelHeight * this._doc.selection.boxSelectionChannel + 1));\r\n\t\t\tthis._selectionRect.setAttribute(\"width\", String(this._barWidth * this._doc.selection.boxSelectionWidth - 2));\r\n\t\t\tthis._selectionRect.setAttribute(\"height\", String(this._channelHeight * this._doc.selection.boxSelectionHeight - 2));\r\n\t\t\tthis._selectionRect.setAttribute(\"visibility\", \"visible\");\r\n\t\t} else {\r\n\t\t\tthis._selectionRect.setAttribute(\"visibility\", \"hidden\");\r\n\t\t}\r\n\t\t\t\r\n\t\tthis._updatePreview();\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\n//import {Layout} from \"./Layout\";\r\nimport { InstrumentType, EffectType, Config, effectsIncludeTransition, effectsIncludeChord, effectsIncludePitchShift, effectsIncludeDetune, effectsIncludeVibrato, effectsIncludeNoteFilter, effectsIncludeDistortion, effectsIncludeBitcrusher, effectsIncludePanning, effectsIncludeChorus, effectsIncludeEcho, effectsIncludeReverb, DropdownID } from \"../synth/SynthConfig\";\r\nimport { BarScrollBar } from \"./BarScrollBar\";\r\nimport { BeatsPerBarPrompt } from \"./BeatsPerBarPrompt\";\r\nimport { Change, ChangeGroup } from \"./Change\";\r\nimport { ChannelSettingsPrompt } from \"./ChannelSettingsPrompt\";\r\nimport { ColorConfig, ChannelColors } from \"./ColorConfig\";\r\nimport { CustomChipPrompt } from \"./CustomChipPrompt\";\r\nimport { CustomFilterPrompt } from \"./CustomFilterPrompt\";\r\nimport { EditorConfig, isMobile, prettyNumber, Preset, PresetCategory } from \"./EditorConfig\";\r\nimport { ExportPrompt } from \"./ExportPrompt\";\r\nimport \"./Layout\"; // Imported here for the sake of ensuring this code is transpiled early.\r\nimport { Instrument, Channel, Synth } from \"../synth/synth\";\r\nimport { HTML, SVG } from \"imperative-html/dist/esm/elements-strict\";\r\nimport { Preferences } from \"./Preferences\";\r\nimport { HarmonicsEditor } from \"./HarmonicsEditor\";\r\nimport { InputBox, Slider } from \"./HTMLWrapper\";\r\nimport { ImportPrompt } from \"./ImportPrompt\";\r\nimport { LayoutPrompt } from \"./LayoutPrompt\";\r\nimport { EnvelopeEditor } from \"./EnvelopeEditor\";\r\nimport { FadeInOutEditor } from \"./FadeInOutEditor\";\r\nimport { FilterEditor } from \"./FilterEditor\";\r\nimport { LimiterPrompt } from \"./LimiterPrompt\";\r\nimport { LoopEditor } from \"./LoopEditor\";\r\nimport { MoveNotesSidewaysPrompt } from \"./MoveNotesSidewaysPrompt\";\r\nimport { MuteEditor } from \"./MuteEditor\";\r\nimport { OctaveScrollBar } from \"./OctaveScrollBar\";\r\nimport { MidiInputHandler } from \"./MidiInput\";\r\nimport { KeyboardLayout } from \"./KeyboardLayout\";\r\nimport { PatternEditor } from \"./PatternEditor\";\r\nimport { Piano } from \"./Piano\";\r\nimport { Prompt } from \"./Prompt\";\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { SongDurationPrompt } from \"./SongDurationPrompt\";\r\nimport { SongRecoveryPrompt } from \"./SongRecoveryPrompt\";\r\nimport { RecordingSetupPrompt } from \"./RecordingSetupPrompt\";\r\nimport { SpectrumEditor } from \"./SpectrumEditor\";\r\nimport { ThemePrompt } from \"./ThemePrompt\";\r\nimport { TipPrompt } from \"./TipPrompt\";\r\nimport { ChangeTempo, ChangeChorus, ChangeEchoDelay, ChangeEchoSustain, ChangeReverb, ChangeVolume, ChangePan, ChangePatternSelection, ChangePatternsPerChannel, ChangePatternNumbers, ChangePulseWidth, ChangeFeedbackAmplitude, ChangeOperatorAmplitude, ChangeOperatorFrequency, ChangeDrumsetEnvelope, ChangePasteInstrument, ChangePreset, pickRandomPresetValue, ChangeRandomGeneratedInstrument, ChangeEQFilterType, ChangeNoteFilterType, ChangeEQFilterSimpleCut, ChangeEQFilterSimplePeak, ChangeNoteFilterSimpleCut, ChangeNoteFilterSimplePeak, ChangeScale, ChangeDetectKey, ChangeKey, ChangeRhythm, ChangeFeedbackType, ChangeAlgorithm, ChangeChipWave, ChangeNoiseWave, ChangeTransition, ChangeToggleEffects, ChangeVibrato, ChangeUnison, ChangeChord, ChangeSong, ChangePitchShift, ChangeDetune, ChangeDistortion, ChangeStringSustain, ChangeBitcrusherFreq, ChangeBitcrusherQuantization, ChangeAddEnvelope, ChangeAddChannelInstrument, ChangeRemoveChannelInstrument, ChangeCustomWave, ChangeOperatorWaveform, ChangeOperatorPulseWidth, ChangeSongTitle, ChangeVibratoDepth, ChangeVibratoSpeed, ChangeVibratoDelay, ChangeVibratoType, ChangePanDelay, ChangeArpeggioSpeed, ChangeFastTwoNoteArp, ChangeClicklessTransition, ChangeAliasing } from \"./changes\";\r\n\r\nimport { ArrayBufferWriter } from \"./ArrayBufferWriter\";\r\nimport { Pattern, Note, Song } from \"../synth/synth\";\r\nimport { MidiChunkType, MidiFileFormat, MidiControlEventMessage, MidiEventType, MidiMetaEventMessage, MidiRegisteredParameterNumberMSB, MidiRegisteredParameterNumberLSB, volumeMultToMidiVolume, volumeMultToMidiExpression, defaultMidiPitchBend, defaultMidiExpression } from \"./Midi\";\r\nimport { getArpeggioPitchIndex } from \"../synth/SynthConfig\";\r\n\r\nimport { TrackEditor } from \"./TrackEditor\";\r\n\r\nconst { button, div, input, select, span, optgroup, option, canvas } = HTML;\r\n\r\nfunction buildOptions(menu: HTMLSelectElement, items: ReadonlyArray<string | number>): HTMLSelectElement {\r\n    for (let index: number = 0; index < items.length; index++) {\r\n        menu.appendChild(option({ value: index }, items[index]));\r\n    }\r\n    return menu;\r\n}\r\n\r\n// Similar to the above, but adds a non-interactive header to the list.\r\n// @jummbus: Honestly not necessary with new HTML options interface, but not exactly necessary to change either!\r\n\r\nfunction buildHeaderedOptions(header: string, menu: HTMLSelectElement, items: ReadonlyArray<string | number>): HTMLSelectElement {\r\n    menu.appendChild(option({ selected: true, disabled: true, value: header }, header));\r\n\r\n    for (const item of items) {\r\n        menu.appendChild(option({ value: item }, item));\r\n    }\r\n    return menu;\r\n}\r\n\r\nfunction buildPresetOptions(isNoise: boolean, idSet: string): HTMLSelectElement {\r\n    const menu: HTMLSelectElement = select({ id: idSet });\r\n\r\n\r\n    // Show the \"spectrum\" custom type in both pitched and noise channels.\r\n    //const customTypeGroup: HTMLElement = optgroup({label: EditorConfig.presetCategories[0].name});\r\n    if (isNoise) {\r\n        menu.appendChild(option({ value: InstrumentType.noise }, EditorConfig.valueToPreset(InstrumentType.noise)!.name));\r\n        menu.appendChild(option({ value: InstrumentType.spectrum }, EditorConfig.valueToPreset(InstrumentType.spectrum)!.name));\r\n        menu.appendChild(option({ value: InstrumentType.drumset }, EditorConfig.valueToPreset(InstrumentType.drumset)!.name));\r\n    } else {\r\n        menu.appendChild(option({ value: InstrumentType.chip }, EditorConfig.valueToPreset(InstrumentType.chip)!.name));\r\n        menu.appendChild(option({ value: InstrumentType.pwm }, EditorConfig.valueToPreset(InstrumentType.pwm)!.name));\r\n        menu.appendChild(option({ value: InstrumentType.harmonics }, EditorConfig.valueToPreset(InstrumentType.harmonics)!.name));\r\n        menu.appendChild(option({ value: InstrumentType.pickedString }, EditorConfig.valueToPreset(InstrumentType.pickedString)!.name));\r\n        menu.appendChild(option({ value: InstrumentType.spectrum }, EditorConfig.valueToPreset(InstrumentType.spectrum)!.name));\r\n        menu.appendChild(option({ value: InstrumentType.fm }, EditorConfig.valueToPreset(InstrumentType.fm)!.name));\r\n        menu.appendChild(option({ value: InstrumentType.customChipWave }, EditorConfig.valueToPreset(InstrumentType.customChipWave)!.name));\r\n    }\r\n\r\n    const randomGroup: HTMLElement = optgroup({ label: \"Randomize ▾\" });\r\n    randomGroup.appendChild(option({ value: \"randomPreset\" }, \"Random Preset\"));\r\n    randomGroup.appendChild(option({ value: \"randomGenerated\" }, \"Random Generated\"));\r\n    menu.appendChild(randomGroup);\r\n\r\n\r\n    for (let categoryIndex: number = 1; categoryIndex < EditorConfig.presetCategories.length; categoryIndex++) {\r\n        const category: PresetCategory = EditorConfig.presetCategories[categoryIndex];\r\n        const group: HTMLElement = optgroup({ label: category.name + \" ▾\" });\r\n        let foundAny: boolean = false;\r\n        for (let presetIndex: number = 0; presetIndex < category.presets.length; presetIndex++) {\r\n            const preset: Preset = category.presets[presetIndex];\r\n            if ((preset.isNoise == true) == isNoise) {\r\n                group.appendChild(option({ value: (categoryIndex << 6) + presetIndex }, preset.name));\r\n                foundAny = true;\r\n            }\r\n        }\r\n\r\n        // Need to re-sort some elements for readability. Can't just do this in the menu, because indices are saved in URLs and would get broken if the ordering actually changed.\r\n        if (category.name == \"String Presets\" && foundAny) {\r\n\r\n            // Put violin 2 after violin 1\r\n            let moveViolin2 = group.removeChild(group.children[11]);\r\n            group.insertBefore(moveViolin2, group.children[1]);\r\n        }\r\n\r\n        if (category.name == \"Flute Presets\" && foundAny) {\r\n\r\n            // Put flute 2 after flute 1\r\n            let moveFlute2 = group.removeChild(group.children[11]);\r\n            group.insertBefore(moveFlute2, group.children[1]);\r\n        }\r\n\r\n        if (category.name == \"Keyboard Presets\" && foundAny) {\r\n\r\n            // Put grand piano 2 after grand piano 1\r\n            let moveGrandPiano2 = group.removeChild(group.children[9]);\r\n            group.insertBefore(moveGrandPiano2, group.children[1]);\r\n        }\r\n\r\n        if (foundAny) menu.appendChild(group);\r\n    }\r\n\r\n    return menu;\r\n}\r\n\r\nfunction setSelectedValue(menu: HTMLSelectElement, value: number): void {\r\n    const stringValue = value.toString();\r\n    if (menu.value != stringValue) menu.value = stringValue;\r\n\r\n    // Change select2 value, if this select is a member of that class.\r\n    if ($(menu).data('select2')) {\r\n        $(menu).val(value).trigger('change.select2');\r\n    }\r\n}\r\n\r\nclass CustomChipCanvas {\r\n    private mouseDown: boolean;\r\n    private continuousEdit: boolean;\r\n    private lastX: number;\r\n    private lastY: number;\r\n    public newArray: Float32Array;\r\n\r\n    private _change: Change | null = null;\r\n\r\n    constructor(public readonly canvas: HTMLCanvasElement, private readonly _doc: SongDocument, private readonly _getChange: (newArray: Float32Array) => Change) {\r\n        //canvas.addEventListener(\"input\", this._whenInput);\r\n        //canvas.addEventListener(\"change\", this._whenChange);\r\n        canvas.addEventListener(\"mousemove\", this._onMouseMove);\r\n        canvas.addEventListener(\"mousedown\", this._onMouseDown);\r\n        canvas.addEventListener(\"mouseup\", this._onMouseUp);\r\n        canvas.addEventListener(\"mouseleave\", this._onMouseUp);\r\n\r\n        this.mouseDown = false;\r\n        this.continuousEdit = false;\r\n        this.lastX = 0;\r\n        this.lastY = 0;\r\n\r\n        this.newArray = new Float32Array(64);\r\n\r\n        // Init waveform\r\n        this.redrawCanvas();\r\n\r\n    }\r\n\r\n    public redrawCanvas(): void {\r\n        var ctx = this.canvas.getContext(\"2d\") as CanvasRenderingContext2D;\r\n\r\n        // Black BG\r\n        ctx.fillStyle = ColorConfig.getComputed(\"--editor-background\");\r\n        ctx.fillRect(0, 0, 128, 52);\r\n\r\n        // Mid-bar\r\n        ctx.fillStyle = ColorConfig.getComputed(\"--ui-widget-background\");\r\n        ctx.fillRect(0, 25, 128, 2);\r\n\r\n        // 25-75 bars\r\n        ctx.fillStyle = ColorConfig.getComputed(\"--track-editor-bg-pitch-dim\");\r\n        ctx.fillRect(0, 13, 128, 1);\r\n        ctx.fillRect(0, 39, 128, 1);\r\n\r\n        // Waveform\r\n        ctx.fillStyle = ColorConfig.getComputedChannelColor(this._doc.song, this._doc.channel).primaryNote;\r\n\r\n        for (let x: number = 0; x < 64; x++) {\r\n            var y: number = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()].customChipWave[x] + 26;\r\n            ctx.fillRect(x * 2, y - 2, 2, 4);\r\n\r\n            this.newArray[x] = y - 26;\r\n        }\r\n    }\r\n\r\n    private _onMouseMove = (event: MouseEvent): void => {\r\n        if (this.mouseDown) {\r\n\r\n            var x = (event.clientX || event.pageX) - this.canvas.getBoundingClientRect().left;\r\n            var y = Math.floor((event.clientY || event.pageY) - this.canvas.getBoundingClientRect().top);\r\n\r\n            if (y < 2) y = 2;\r\n            if (y > 50) y = 50;\r\n\r\n            var ctx = this.canvas.getContext(\"2d\") as CanvasRenderingContext2D;\r\n\r\n            if (this.continuousEdit == true && Math.abs(this.lastX - x) < 40) {\r\n\r\n                var lowerBound = (x < this.lastX) ? x : this.lastX;\r\n                var upperBound = (x < this.lastX) ? this.lastX : x;\r\n\r\n                for (let i = lowerBound; i <= upperBound; i += 2) {\r\n\r\n                    var progress = (Math.abs(x - this.lastX) > 2.0) ? ((x > this.lastX) ?\r\n                        1.0 - ((i - lowerBound) / (upperBound - lowerBound))\r\n                        : ((i - lowerBound) / (upperBound - lowerBound))) : 0.0;\r\n                    var j = Math.round(y + (this.lastY - y) * progress);\r\n\r\n                    ctx.fillStyle = ColorConfig.getComputed(\"--editor-background\");\r\n                    ctx.fillRect(Math.floor(i / 2) * 2, 0, 2, 53);\r\n                    ctx.fillStyle = ColorConfig.getComputed(\"--ui-widget-background\");\r\n                    ctx.fillRect(Math.floor(i / 2) * 2, 25, 2, 2);\r\n                    ctx.fillStyle = ColorConfig.getComputed(\"--track-editor-bg-pitch-dim\");\r\n                    ctx.fillRect(Math.floor(i / 2) * 2, 13, 2, 1);\r\n                    ctx.fillRect(Math.floor(i / 2) * 2, 39, 2, 1);\r\n                    ctx.fillStyle = ColorConfig.getComputedChannelColor(this._doc.song, this._doc.channel).primaryNote;\r\n                    ctx.fillRect(Math.floor(i / 2) * 2, j - 2, 2, 4);\r\n\r\n                    // Actually update current instrument's custom waveform\r\n                    this.newArray[Math.floor(i / 2)] = (j - 26);\r\n                }\r\n\r\n            }\r\n            else {\r\n\r\n                ctx.fillStyle = ColorConfig.getComputed(\"--editor-background\");\r\n                ctx.fillRect(Math.floor(x / 2) * 2, 0, 2, 52);\r\n                ctx.fillStyle = ColorConfig.getComputed(\"--ui-widget-background\");\r\n                ctx.fillRect(Math.floor(x / 2) * 2, 25, 2, 2);\r\n                ctx.fillStyle = ColorConfig.getComputed(\"--track-editor-bg-pitch-dim\");\r\n                ctx.fillRect(Math.floor(x / 2) * 2, 13, 2, 1);\r\n                ctx.fillRect(Math.floor(x / 2) * 2, 39, 2, 1);\r\n                ctx.fillStyle = ColorConfig.getComputedChannelColor(this._doc.song, this._doc.channel).primaryNote;\r\n                ctx.fillRect(Math.floor(x / 2) * 2, y - 2, 2, 4);\r\n\r\n                // Actually update current instrument's custom waveform\r\n                this.newArray[Math.floor(x / 2)] = (y - 26);\r\n\r\n            }\r\n\r\n            this.continuousEdit = true;\r\n            this.lastX = x;\r\n            this.lastY = y;\r\n\r\n            // Preview - update integral used for sound synthesis based on new array, not actual stored array. When mouse is released, real update will happen.\r\n            let instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\r\n            let sum: number = 0.0;\r\n            for (let i: number = 0; i < this.newArray.length; i++) {\r\n                sum += this.newArray[i];\r\n            }\r\n            const average: number = sum / this.newArray.length;\r\n\r\n            // Perform the integral on the wave. The chipSynth will perform the derivative to get the original wave back but with antialiasing.\r\n            let cumulative: number = 0;\r\n            let wavePrev: number = 0;\r\n            for (let i: number = 0; i < this.newArray.length; i++) {\r\n                cumulative += wavePrev;\r\n                wavePrev = this.newArray[i] - average;\r\n                instrument.customChipWaveIntegral[i] = cumulative;\r\n            }\r\n\r\n            instrument.customChipWaveIntegral[64] = 0.0;\r\n        }\r\n\r\n    }\r\n\r\n    private _onMouseDown = (event: MouseEvent): void => {\r\n        this.mouseDown = true;\r\n\r\n        // Allow single-click edit\r\n        this._onMouseMove(event);\r\n    }\r\n    private _onMouseUp = (): void => {\r\n        this.mouseDown = false;\r\n        this.continuousEdit = false;\r\n\r\n        this._whenChange();\r\n    }\r\n\r\n    private _whenChange = (): void => {\r\n        this._change = this._getChange(this.newArray);\r\n\r\n        this._doc.record(this._change!);\r\n\r\n        this._change = null;\r\n    };\r\n\r\n}\r\n\r\nexport class SongEditor {\r\n    public prompt: Prompt | null = null;\r\n\r\n    private readonly _fileInput: HTMLInputElement = input({id: \"injectMIDI\", type: \"file\", accept: \".mid,.midi,audio/midi,audio/x-midi\"});\r\n    private readonly _pausePlayer: HTMLElement = div({id: \"pausePlayer\"});\r\n\r\n    private readonly _keyboardLayout: KeyboardLayout = new KeyboardLayout(this._doc);\r\n    private readonly _patternEditorPrev: PatternEditor = new PatternEditor(this._doc, false, -1);\r\n    private readonly _patternEditor: PatternEditor = new PatternEditor(this._doc, true, 0);\r\n    private readonly _patternEditorNext: PatternEditor = new PatternEditor(this._doc, false, 1);\r\n    private readonly _trackEditor: TrackEditor = new TrackEditor(this._doc, this);\r\n    private readonly _muteEditor: MuteEditor = new MuteEditor(this._doc, this);\r\n    private readonly _loopEditor: LoopEditor = new LoopEditor(this._doc);\r\n    private readonly _piano: Piano = new Piano(this._doc);\r\n    private readonly _octaveScrollBar: OctaveScrollBar = new OctaveScrollBar(this._doc, this._piano);\r\n    private readonly _playButton: HTMLButtonElement = button({ class: \"playButton\", type: \"button\", title: \"Play (Space)\" }, span(\"Play\"));\r\n    private readonly _pauseButton: HTMLButtonElement = button({ class: \"pauseButton\", style: \"display: none;\", type: \"button\", title: \"Pause (Space)\" }, \"Pause\");\r\n    private readonly _recordButton: HTMLButtonElement = button({ class: \"recordButton\", style: \"display: none;\", type: \"button\", title: \"Record (Ctrl+Space)\" }, span(\"Record\"));\r\n    private readonly _stopButton: HTMLButtonElement = button({ class: \"stopButton\", style: \"display: none;\", type: \"button\", title: \"Stop Recording (Space)\" }, \"Stop Recording\");\r\n    private readonly _prevBarButton: HTMLButtonElement = button({ class: \"prevBarButton\", type: \"button\", title: \"Previous Bar (left bracket)\" });\r\n    private readonly _nextBarButton: HTMLButtonElement = button({ class: \"nextBarButton\", type: \"button\", title: \"Next Bar (right bracket)\" });\r\n    private readonly _volumeSlider: Slider = new Slider(input({ title: \"main volume\", style: \"width: 5em; flex-grow: 1; margin: 0;\", type: \"range\", min: \"0\", max: \"75\", value: \"50\", step: \"1\" }), this._doc, null, false);\r\n    private readonly _outVolumeBarBg: SVGRectElement = SVG.rect({ \"pointer-events\": \"none\", width: \"90%\", height: \"50%\", x: \"5%\", y: \"25%\", fill: ColorConfig.uiWidgetBackground });\r\n    private readonly _outVolumeBar: SVGRectElement = SVG.rect({ \"pointer-events\": \"none\", height: \"50%\", width: \"0%\", x: \"5%\", y: \"25%\", fill: \"url('#volumeGrad2')\" });\r\n    private readonly _outVolumeCap: SVGRectElement = SVG.rect({ \"pointer-events\": \"none\", width: \"2px\", height: \"50%\", x: \"5%\", y: \"25%\", fill: ColorConfig.uiWidgetFocus });\r\n    private readonly _stop1: SVGStopElement = SVG.stop({ \"stop-color\": \"lime\", offset: \"60%\" });\r\n    private readonly _stop2: SVGStopElement = SVG.stop({ \"stop-color\": \"orange\", offset: \"90%\" });\r\n    private readonly _stop3: SVGStopElement = SVG.stop({ \"stop-color\": \"red\", offset: \"100%\" });\r\n    private readonly _gradient: SVGGradientElement = SVG.linearGradient({ id: \"volumeGrad2\", gradientUnits: \"userSpaceOnUse\" }, this._stop1, this._stop2, this._stop3);\r\n    private readonly _defs: SVGDefsElement = SVG.defs({}, this._gradient);\r\n    private readonly _volumeBarContainer: SVGSVGElement = SVG.svg({ style: `touch-action: none; overflow: visible; margin: auto; max-width: 20vw;`, width: \"160px\", height: \"100%\", preserveAspectRatio: \"none\", viewBox: \"0 0 160 12\" },\r\n        this._defs,\r\n        this._outVolumeBarBg,\r\n        this._outVolumeBar,\r\n        this._outVolumeCap,\r\n    );\r\n    private readonly _volumeBarBox: HTMLDivElement = div({ class: \"playback-volume-bar\", style: \"height: 12px; align-self: center;\" },\r\n        this._volumeBarContainer,\r\n    );\r\n    private readonly _fileMenu: HTMLSelectElement = select({ style: \"width: 100%;\" },\r\n        option({ selected: true, disabled: true, hidden: false }, \"File\"), // todo: \"hidden\" should be true but looks wrong on mac chrome, adds checkmark next to first visible option even though it's not selected. :(\r\n        option({ value: \"new\" }, \"+ New Blank Song\"),\r\n        option({ value: \"import\" }, \"↑ Import Song... (\" + EditorConfig.ctrlSymbol + \"O)\"),\r\n        option({ value: \"export\" }, \"↓ Export Song... (\" + EditorConfig.ctrlSymbol + \"S)\"),\r\n        option({ value: \"copyUrl\" }, \"⎘ Copy Song URL\"),\r\n        option({ value: \"shareUrl\" }, \"⤳ Share Song URL\"),\r\n        option({ value: \"shortenUrl\" }, \"… Shorten Song URL\"),\r\n        option({ value: \"viewPlayer\" }, \"▶ View in Song Player\"),\r\n        option({ value: \"copyEmbed\" }, \"⎘ Copy HTML Embed Code\"),\r\n        option({ value: \"songRecovery\" }, \"⚠ Recover Recent Song...\"),\r\n    );\r\n    private readonly _editMenu: HTMLSelectElement = select({ style: \"width: 100%;\" },\r\n        option({ selected: true, disabled: true, hidden: false }, \"Edit\"), // todo: \"hidden\" should be true but looks wrong on mac chrome, adds checkmark next to first visible option even though it's not selected. :(\r\n        option({ value: \"undo\" }, \"Undo (Z)\"),\r\n        option({ value: \"redo\" }, \"Redo (Y)\"),\r\n        option({ value: \"copy\" }, \"Copy Pattern (C)\"),\r\n        option({ value: \"pasteNotes\" }, \"Paste Pattern Notes (V)\"),\r\n        option({ value: \"pasteNumbers\" }, \"Paste Pattern Numbers (\" + EditorConfig.ctrlSymbol + \"⇧V)\"),\r\n        option({ value: \"insertBars\" }, \"Insert Bar (⏎)\"),\r\n        option({ value: \"deleteBars\" }, \"Delete Selected Bars (⌫)\"),\r\n        option({ value: \"insertChannel\" }, \"Insert Channel (\" + EditorConfig.ctrlSymbol + \"⏎)\"),\r\n        option({ value: \"deleteChannel\" }, \"Delete Selected Channels (\" + EditorConfig.ctrlSymbol + \"⌫)\"),\r\n        option({ value: \"selectChannel\" }, \"Select Channel (⇧A)\"),\r\n        option({ value: \"selectAll\" }, \"Select All (A)\"),\r\n        option({ value: \"duplicatePatterns\" }, \"Duplicate Reused Patterns (D)\"),\r\n        option({ value: \"transposeUp\" }, \"Move Notes Up (+ or ⇧+)\"),\r\n        option({ value: \"transposeDown\" }, \"Move Notes Down (- or ⇧-)\"),\r\n        option({ value: \"moveNotesSideways\" }, \"Move All Notes Sideways... (W)\"),\r\n        option({ value: \"beatsPerBar\" }, \"Change Beats Per Bar...\"),\r\n        option({ value: \"barCount\" }, \"Change Song Length... (L)\"),\r\n        option({ value: \"channelSettings\" }, \"Channel Settings... (Q)\"),\r\n        option({ value: \"limiterSettings\" }, \"Limiter Settings... (⇧L)\"),\r\n    );\r\n    private readonly _optionsMenu: HTMLSelectElement = select({ style: \"width: 100%;\" },\r\n        option({ selected: true, disabled: true, hidden: false }, \"Preferences\"), // todo: \"hidden\" should be true but looks wrong on mac chrome, adds checkmark next to first visible option even though it's not selected. :(\r\n        option({ value: \"autoPlay\" }, \"Auto Play on Load\"),\r\n        option({ value: \"autoFollow\" }, \"Keep Current Pattern Selected\"),\r\n        option({ value: \"enableNotePreview\" }, \"Hear Preview of Added Notes\"),\r\n        option({ value: \"showLetters\" }, \"Show Piano Keys\"),\r\n        option({ value: \"showFifth\" }, 'Highlight \"Fifth\" of Song Key'),\r\n        option({ value: \"notesOutsideScale\" }, \"Allow Adding Notes Not in Scale\"),\r\n        option({ value: \"setDefaultScale\" }, \"Use Current Scale as Default\"),\r\n        option({ value: \"showChannels\" }, \"Show Notes From All Channels\"),\r\n        option({ value: \"showScrollBar\" }, \"Show Octave Scroll Bar\"),\r\n        option({ value: \"alwaysFineNoteVol\" }, \"Always Fine Note Volume\"),\r\n        option({ value: \"enableChannelMuting\" }, \"Enable Channel Muting\"),\r\n        option({ value: \"displayBrowserUrl\" }, \"Display Song Data in URL\"),\r\n        option({ value: \"displayVolumeBar\" }, \"Show Playback Volume\"),\r\n        option({ value: \"layout\" }, \"Set Layout...\"),\r\n        option({ value: \"colorTheme\" }, \"Set Theme...\"),\r\n        option({ value: \"recordingSetup\" }, \"Set Up Note Recording...\"),\r\n    );\r\n    private readonly _scaleSelect: HTMLSelectElement = buildOptions(select(), Config.scales.map(scale => scale.name));\r\n    private readonly _keySelect: HTMLSelectElement = buildOptions(select(), Config.keys.map(key => key.name).reverse());\r\n    private readonly _tempoSlider: Slider = new Slider(input({ style: \"margin: 0; vertical-align: middle;\", type: \"range\", min: \"30\", max: \"320\", value: \"160\", step: \"1\" }), this._doc, (oldValue: number, newValue: number) => new ChangeTempo(this._doc, oldValue, newValue), false);\r\n    private readonly _tempoStepper: HTMLInputElement = input({ style: \"width: 4em; font-size: 80%; margin-left: 0.4em; vertical-align: middle;\", type: \"number\", step: \"1\" });\r\n    private readonly _chorusSlider: Slider = new Slider(input({ style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.chorusRange - 1, value: \"0\", step: \"1\" }), this._doc, (oldValue: number, newValue: number) => new ChangeChorus(this._doc, oldValue, newValue), false);\r\n    private readonly _chorusRow: HTMLDivElement = div({ class: \"selectRow\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"chorus\") }, \"Chorus:\"), this._chorusSlider.container);\r\n    private readonly _reverbSlider: Slider = new Slider(input({ style: \"margin: 0; position: sticky,\", type: \"range\", min: \"0\", max: Config.reverbRange - 1, value: \"0\", step: \"1\" }), this._doc, (oldValue: number, newValue: number) => new ChangeReverb(this._doc, oldValue, newValue), false);\r\n    private readonly _reverbRow: HTMLDivElement = div({ class: \"selectRow\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"reverb\") }, \"Reverb:\"), this._reverbSlider.container);\r\n    private readonly _echoSustainSlider: Slider = new Slider(input({ style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.echoSustainRange - 1, value: \"0\", step: \"1\" }), this._doc, (oldValue: number, newValue: number) => new ChangeEchoSustain(this._doc, oldValue, newValue), false);\r\n    private readonly _echoSustainRow: HTMLDivElement = div({ class: \"selectRow\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"echoSustain\") }, \"Echo:\"), this._echoSustainSlider.container);\r\n    private readonly _echoDelaySlider: Slider = new Slider(input({ style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.echoDelayRange - 1, value: \"0\", step: \"1\" }), this._doc, (oldValue: number, newValue: number) => new ChangeEchoDelay(this._doc, oldValue, newValue), false);\r\n    private readonly _echoDelayRow: HTMLDivElement = div({ class: \"selectRow\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"echoDelay\") }, \"Echo Delay:\"), this._echoDelaySlider.container);\r\n    private readonly _rhythmSelect: HTMLSelectElement = buildOptions(select(), Config.rhythms.map(rhythm => rhythm.name));\r\n    private readonly _pitchedPresetSelect: HTMLSelectElement = buildPresetOptions(false, \"pitchPresetSelect\");\r\n    private readonly _drumPresetSelect: HTMLSelectElement = buildPresetOptions(true, \"drumPresetSelect\");\r\n    private readonly _algorithmSelect: HTMLSelectElement = buildOptions(select(), Config.algorithms.map(algorithm => algorithm.name));\r\n    private readonly _algorithmSelectRow: HTMLDivElement = div({ class: \"selectRow\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"algorithm\") }, \"Algorithm: \"), div({ class: \"selectContainer\" }, this._algorithmSelect));\r\n    private readonly _instrumentButtons: HTMLButtonElement[] = [];\r\n    private readonly _instrumentAddButton: HTMLButtonElement = button({ type: \"button\", class: \"add-instrument last-button\" });\r\n    private readonly _instrumentRemoveButton: HTMLButtonElement = button({ type: \"button\", class: \"remove-instrument\" });\r\n    private readonly _instrumentsButtonBar: HTMLDivElement = div({ class: \"instrument-bar\" }, this._instrumentRemoveButton, this._instrumentAddButton);\r\n    private readonly _instrumentsButtonRow: HTMLDivElement = div({ class: \"selectRow\", style: \"display: none;\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"instrumentIndex\") }, \"Instrument:\"), this._instrumentsButtonBar);\r\n    private readonly _instrumentVolumeSlider: Slider = new Slider(input({ style: \"margin: 0; position: sticky;\", type: \"range\", min: Math.floor(-Config.volumeRange / 2), max: Math.floor(Config.volumeRange / 2), value: \"0\", step: \"1\" }), this._doc, (oldValue: number, newValue: number) => new ChangeVolume(this._doc, oldValue, newValue), true);\r\n    private readonly _instrumentVolumeSliderInputBox: HTMLInputElement = input({ style: \"width: 4em; font-size: 80%\", id: \"volumeSliderInputBox\", type: \"number\", step: \"1\", min: Math.floor(-Config.volumeRange / 2), max: Math.floor(Config.volumeRange / 2), value: \"0\" });\r\n    private readonly _instrumentVolumeSliderTip: HTMLDivElement = div({ class: \"selectRow\", style: \"height: 1em\" }, span({ class: \"tip\", style: \"font-size: smaller;\", onclick: () => this._openPrompt(\"instrumentVolume\") }, \"Volume: \"));\r\n    private readonly _instrumentVolumeSliderRow: HTMLDivElement = div({ class: \"selectRow\" }, div({},\r\n        div({ style: \"color: \" + ColorConfig.secondaryText + \";\" }, span({ class: \"tip\" }, this._instrumentVolumeSliderTip)),\r\n        div({ style: \"color: \" + ColorConfig.secondaryText + \"; margin-top: -3px;\" }, this._instrumentVolumeSliderInputBox),\r\n    ), this._instrumentVolumeSlider.container);\r\n    private readonly _panSlider: Slider = new Slider(input({ style: \"margin: 0; position: sticky;\", type: \"range\", min: \"0\", max: Config.panMax, value: Config.panCenter, step: \"1\" }), this._doc, (oldValue: number, newValue: number) => new ChangePan(this._doc, oldValue, newValue), true);\r\n    private readonly _panDropdown: HTMLButtonElement = button({ style: \"margin-left:0em; height:1.5em; width: 10px; padding: 0px; font-size: 8px;\", onclick: () => this._toggleDropdownMenu(DropdownID.Pan) }, \"▼\");\r\n    private readonly _panSliderInputBox: HTMLInputElement = input({ style: \"width: 4em; font-size: 80%; \", id: \"panSliderInputBox\", type: \"number\", step: \"1\", min: \"0\", max: \"100\", value: \"0\" });\r\n    private readonly _panSliderRow: HTMLDivElement = div({ class: \"selectRow\" }, div({},\r\n        span({ class: \"tip\", tabindex: \"0\", style: \"height:1em; font-size: smaller;\", onclick: () => this._openPrompt(\"pan\") }, \"Pan: \"),\r\n        div({ style: \"color: \" + ColorConfig.secondaryText + \"; margin-top: -3px;\" }, this._panSliderInputBox),\r\n    ), this._panDropdown, this._panSlider.container);\r\n    private readonly _panDelaySlider: Slider = new Slider(input({ style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.modulators.dictionary[\"pan delay\"].maxRawVol, value: \"0\", step: \"1\" }), this._doc, (oldValue: number, newValue: number) => new ChangePanDelay(this._doc, oldValue, newValue), false);\r\n    private readonly _panDelayRow: HTMLElement = div({ class: \"selectRow\" }, span({ class: \"tip\", style: \"margin-left:10px;\", onclick: () => this._openPrompt(\"panDelay\") }, \"Delay:\"), this._panDelaySlider.container);\r\n    private readonly _panDropdownGroup: HTMLElement = div({ class: \"editor-controls\", style: \"display: none;\" }, this._panDelayRow);\r\n    private readonly _chipWaveSelect: HTMLSelectElement = buildOptions(select(), Config.chipWaves.map(wave => wave.name));\r\n    private readonly _chipNoiseSelect: HTMLSelectElement = buildOptions(select(), Config.chipNoises.map(wave => wave.name));\r\n    private readonly _chipWaveSelectRow: HTMLDivElement = div({ class: \"selectRow\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"chipWave\") }, \"Wave: \"), div({ class: \"selectContainer\" }, this._chipWaveSelect));\r\n    private readonly _chipNoiseSelectRow: HTMLDivElement = div({ class: \"selectRow\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"chipNoise\") }, \"Noise: \"), div({ class: \"selectContainer\" }, this._chipNoiseSelect));\r\n    private readonly _fadeInOutEditor: FadeInOutEditor = new FadeInOutEditor(this._doc);\r\n    private readonly _fadeInOutRow: HTMLElement = div({ class: \"selectRow\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"fadeInOut\") }, \"Fade:\"), this._fadeInOutEditor.container);\r\n    private readonly _transitionSelect: HTMLSelectElement = buildOptions(select(), Config.transitions.map(transition => transition.name));\r\n    private readonly _transitionDropdown: HTMLButtonElement = button({ style: \"margin-left:0em; height:1.5em; width: 10px; padding: 0px; font-size: 8px;\", onclick: () => this._toggleDropdownMenu(DropdownID.Transition) }, \"▼\");\r\n    private readonly _transitionRow: HTMLDivElement = div({ class: \"selectRow\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"transition\") }, \"Transition:\"), this._transitionDropdown, div({ class: \"selectContainer\", style: \"width: 52.5%;\" }, this._transitionSelect));\r\n    private readonly _clicklessTransitionBox: HTMLInputElement = input({ type: \"checkbox\", style: \"width: 1em; padding: 0; margin-right: 4em;\" });\r\n    private readonly _clicklessTransitionRow: HTMLElement = div({ class: \"selectRow\" }, span({ class: \"tip\", style: \"margin-left:10px;\", onclick: () => this._openPrompt(\"clicklessTransition\") }, \"Clickless:\"), this._clicklessTransitionBox);\r\n    private readonly _transitionDropdownGroup: HTMLElement = div({ class: \"editor-controls\", style: \"display: none;\" }, this._clicklessTransitionRow);\r\n\r\n    private readonly _effectsSelect: HTMLSelectElement = select(option({ selected: true, disabled: true, hidden: false })); // todo: \"hidden\" should be true but looks wrong on mac chrome, adds checkmark next to first visible option even though it's not selected. :(\r\n    private readonly _eqFilterSimpleButton: HTMLButtonElement = button({ style: \"font-size: x-small; width: 50%; height: 40%\", class: \"no-underline\", onclick: () => this._switchEQFilterType(true) }, \"simple\");\r\n    private readonly _eqFilterAdvancedButton: HTMLButtonElement = button({ style: \"font-size: x-small; width: 50%; height: 40%\", class: \"last-button no-underline\", onclick: () => this._switchEQFilterType(false) }, \"advanced\");\r\n    private readonly _eqFilterTypeRow: HTMLElement = div({ class: \"selectRow\", style: \"padding-top: 4px; margin-bottom: 0px;\" }, span({ style: \"font-size: x-small;\", class: \"tip\", onclick: () => this._openPrompt(\"filterType\") }, \"EQ Filt.Type:\"), div({ class: \"instrument-bar\" }, this._eqFilterSimpleButton, this._eqFilterAdvancedButton));\r\n    private readonly _eqFilterEditor: FilterEditor = new FilterEditor(this._doc);\r\n    private readonly _eqFilterZoom: HTMLButtonElement = button({ style: \"margin-left:0em; padding-left:0.2em; height:1.5em; max-width: 12px;\", onclick: () => this._openPrompt(\"customEQFilterSettings\") }, \"+\");\r\n    private readonly _eqFilterRow: HTMLElement = div({ class: \"selectRow\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"eqFilter\") }, \"EQ Filt:\"), this._eqFilterZoom, this._eqFilterEditor.container);\r\n    private readonly _eqFilterSimpleCutSlider: Slider = new Slider(input({ style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.filterSimpleCutRange - 1, value: \"6\", step: \"1\" }), this._doc, (oldValue: number, newValue: number) => new ChangeEQFilterSimpleCut(this._doc, oldValue, newValue), false);\r\n    private _eqFilterSimpleCutRow: HTMLDivElement = div({ class: \"selectRow\", title: \"Low-pass Filter Cutoff Frequency\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"filterCutoff\") }, \"Filter Cut:\"), this._eqFilterSimpleCutSlider.container);\r\n    private readonly _eqFilterSimplePeakSlider: Slider = new Slider(input({ style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.filterSimplePeakRange - 1, value: \"6\", step: \"1\" }), this._doc, (oldValue: number, newValue: number) => new ChangeEQFilterSimplePeak(this._doc, oldValue, newValue), false);\r\n    private _eqFilterSimplePeakRow: HTMLDivElement = div({ class: \"selectRow\", title: \"Low-pass Filter Peak Resonance\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"filterResonance\") }, \"Filter Peak:\"), this._eqFilterSimplePeakSlider.container);\r\n\r\n    private readonly _noteFilterSimpleButton: HTMLButtonElement = button({ style: \"font-size: x-small; width: 50%; height: 40%\", class: \"no-underline\", onclick: () => this._switchNoteFilterType(true) }, \"simple\");\r\n    private readonly _noteFilterAdvancedButton: HTMLButtonElement = button({ style: \"font-size: x-small; width: 50%; height: 40%\", class: \"last-button no-underline\", onclick: () => this._switchNoteFilterType(false) }, \"advanced\");\r\n    private readonly _noteFilterTypeRow: HTMLElement = div({ class: \"selectRow\", style: \"padding-top: 4px; margin-bottom: 0px;\" }, span({ style: \"font-size: x-small;\", class: \"tip\", onclick: () => this._openPrompt(\"filterType\") }, \"Note Filt.Type:\"), div({ class: \"instrument-bar\" }, this._noteFilterSimpleButton, this._noteFilterAdvancedButton));\r\n    private readonly _noteFilterEditor: FilterEditor = new FilterEditor(this._doc, true);\r\n    private readonly _noteFilterZoom: HTMLButtonElement = button({ style: \"margin-left:0em; padding-left:0.2em; height:1.5em; max-width: 12px;\", onclick: () => this._openPrompt(\"customNoteFilterSettings\") }, \"+\");\r\n    private readonly _noteFilterRow: HTMLElement = div({ class: \"selectRow\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"noteFilter\") }, \"Note Filt:\"), this._noteFilterZoom, this._noteFilterEditor.container);\r\n    private readonly _noteFilterSimpleCutSlider: Slider = new Slider(input({ style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.filterSimpleCutRange - 1, value: \"6\", step: \"1\" }), this._doc, (oldValue: number, newValue: number) => new ChangeNoteFilterSimpleCut(this._doc, oldValue, newValue), false);\r\n    private _noteFilterSimpleCutRow: HTMLDivElement = div({ class: \"selectRow\", title: \"Low-pass Filter Cutoff Frequency\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"filterCutoff\") }, \"Filter Cut:\"), this._noteFilterSimpleCutSlider.container);\r\n    private readonly _noteFilterSimplePeakSlider: Slider = new Slider(input({ style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.filterSimplePeakRange - 1, value: \"6\", step: \"1\" }), this._doc, (oldValue: number, newValue: number) => new ChangeNoteFilterSimplePeak(this._doc, oldValue, newValue), false);\r\n    private _noteFilterSimplePeakRow: HTMLDivElement = div({ class: \"selectRow\", title: \"Low-pass Filter Peak Resonance\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"filterResonance\") }, \"Filter Peak:\"), this._noteFilterSimplePeakSlider.container);\r\n\r\n    private readonly _pulseWidthSlider: Slider = new Slider(input({ style: \"margin: 0;\", type: \"range\", min: \"1\", max: Config.pulseWidthRange, value: \"1\", step: \"1\" }), this._doc, (oldValue: number, newValue: number) => new ChangePulseWidth(this._doc, oldValue, newValue), false);\r\n    private readonly _pulseWidthRow: HTMLDivElement = div({ class: \"selectRow\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"pulseWidth\") }, \"Pulse Width:\"), this._pulseWidthSlider.container);\r\n    private readonly _pitchShiftSlider: Slider = new Slider(input({ style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.pitchShiftRange - 1, value: \"0\", step: \"1\" }), this._doc, (oldValue: number, newValue: number) => new ChangePitchShift(this._doc, oldValue, newValue), true);\r\n    private readonly _pitchShiftTonicMarkers: HTMLDivElement[] = [div({ class: \"pitchShiftMarker\", style: { color: ColorConfig.tonic } }), div({ class: \"pitchShiftMarker\", style: { color: ColorConfig.tonic, left: \"50%\" } }), div({ class: \"pitchShiftMarker\", style: { color: ColorConfig.tonic, left: \"100%\" } })];\r\n    private readonly _pitchShiftFifthMarkers: HTMLDivElement[] = [div({ class: \"pitchShiftMarker\", style: { color: ColorConfig.fifthNote, left: (100 * 7 / 24) + \"%\" } }), div({ class: \"pitchShiftMarker\", style: { color: ColorConfig.fifthNote, left: (100 * 19 / 24) + \"%\" } })];\r\n    private readonly _pitchShiftMarkerContainer: HTMLDivElement = div({ style: \"display: flex; position: relative;\" }, this._pitchShiftSlider.container, div({ class: \"pitchShiftMarkerContainer\" }, this._pitchShiftTonicMarkers, this._pitchShiftFifthMarkers));\r\n    private readonly _pitchShiftRow: HTMLDivElement = div({ class: \"selectRow\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"pitchShift\") }, \"Pitch Shift:\"), this._pitchShiftMarkerContainer);\r\n    private readonly _detuneSlider: Slider = new Slider(input({ style: \"margin: 0;\", type: \"range\", min: Config.detuneMin - Config.detuneCenter, max: Config.detuneMax - Config.detuneCenter, value: 0, step: \"4\" }), this._doc, (oldValue: number, newValue: number) => new ChangeDetune(this._doc, oldValue, newValue), true);\r\n    private readonly _detuneSliderInputBox: HTMLInputElement = input({ style: \"width: 4em; font-size: 80%; \", id: \"detuneSliderInputBox\", type: \"number\", step: \"1\", min: Config.detuneMin - Config.detuneCenter, max: Config.detuneMax - Config.detuneCenter, value: 0 });\r\n    private readonly _detuneSliderRow: HTMLDivElement = div({ class: \"selectRow\" }, div({},\r\n        span({ class: \"tip\", style: \"height:1em; font-size: smaller;\", onclick: () => this._openPrompt(\"detune\") }, \"Detune: \"),\r\n        div({ style: \"color: \" + ColorConfig.secondaryText + \"; margin-top: -3px;\" }, this._detuneSliderInputBox),\r\n    ), this._detuneSlider.container);\r\n    private readonly _distortionSlider: Slider = new Slider(input({ style: \"margin: 0; position: sticky;\", type: \"range\", min: \"0\", max: Config.distortionRange - 1, value: \"0\", step: \"1\" }), this._doc, (oldValue: number, newValue: number) => new ChangeDistortion(this._doc, oldValue, newValue), false);\r\n    private readonly _distortionRow: HTMLDivElement = div({ class: \"selectRow\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"distortion\") }, \"Distortion:\"), this._distortionSlider.container);\r\n    private readonly _aliasingBox: HTMLInputElement = input({ type: \"checkbox\", style: \"width: 1em; padding: 0; margin-right: 4em;\" });\r\n    private readonly _aliasingRow: HTMLElement = div({ class: \"selectRow\" }, span({ class: \"tip\", style: \"margin-left:10px;\", onclick: () => this._openPrompt(\"aliases\") }, \"Aliasing:\"), this._aliasingBox);\r\n    private readonly _bitcrusherQuantizationSlider: Slider = new Slider(input({ style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.bitcrusherQuantizationRange - 1, value: \"0\", step: \"1\" }), this._doc, (oldValue: number, newValue: number) => new ChangeBitcrusherQuantization(this._doc, oldValue, newValue), false);\r\n    private readonly _bitcrusherQuantizationRow: HTMLDivElement = div({ class: \"selectRow\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"bitcrusherQuantization\") }, \"Bit Crush:\"), this._bitcrusherQuantizationSlider.container);\r\n    private readonly _bitcrusherFreqSlider: Slider = new Slider(input({ style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.bitcrusherFreqRange - 1, value: \"0\", step: \"1\" }), this._doc, (oldValue: number, newValue: number) => new ChangeBitcrusherFreq(this._doc, oldValue, newValue), false);\r\n    private readonly _bitcrusherFreqRow: HTMLDivElement = div({ class: \"selectRow\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"bitcrusherFreq\") }, \"Freq Crush:\"), this._bitcrusherFreqSlider.container);\r\n    private readonly _stringSustainSlider: Slider = new Slider(input({ style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.stringSustainRange - 1, value: \"0\", step: \"1\" }), this._doc, (oldValue: number, newValue: number) => new ChangeStringSustain(this._doc, oldValue, newValue), false);\r\n    private readonly _stringSustainRow: HTMLDivElement = div({ class: \"selectRow\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"stringSustain\") }, \"Sustain:\"), this._stringSustainSlider.container);\r\n    private readonly _unisonSelect: HTMLSelectElement = buildOptions(select(), Config.unisons.map(unison => unison.name));\r\n    private readonly _unisonSelectRow: HTMLElement = div({ class: \"selectRow\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"unison\") }, \"Unison:\"), div({ class: \"selectContainer\" }, this._unisonSelect));\r\n    private readonly _chordSelect: HTMLSelectElement = buildOptions(select(), Config.chords.map(chord => chord.name));\r\n    private readonly _chordDropdown: HTMLButtonElement = button({ style: \"margin-left:0em; height:1.5em; width: 10px; padding: 0px; font-size: 8px;\", onclick: () => this._toggleDropdownMenu(DropdownID.Chord) }, \"▼\");\r\n\r\n    private readonly _chordSelectRow: HTMLElement = div({ class: \"selectRow\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"chords\") }, \"Chords:\"), this._chordDropdown, div({ class: \"selectContainer\" }, this._chordSelect));\r\n    private readonly _arpeggioSpeedSlider: Slider = new Slider(input({ style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.modulators.dictionary[\"arp speed\"].maxRawVol, value: \"0\", step: \"1\" }), this._doc, (oldValue: number, newValue: number) => new ChangeArpeggioSpeed(this._doc, oldValue, newValue), false);\r\n    private readonly _arpeggioSpeedRow: HTMLElement = div({ class: \"selectRow\" }, span({ class: \"tip\", style: \"margin-left:10px;\", onclick: () => this._openPrompt(\"arpeggioSpeed\") }, \"Speed:\"), this._arpeggioSpeedSlider.container);\r\n    private readonly _twoNoteArpBox: HTMLInputElement = input({ type: \"checkbox\", style: \"width: 1em; padding: 0; margin-right: 4em;\" });\r\n    private readonly _twoNoteArpRow: HTMLElement = div({ class: \"selectRow\" }, span({ class: \"tip\", style: \"margin-left:10px;\", onclick: () => this._openPrompt(\"twoNoteArpeggio\") }, \"Fast Two-Note:\"), this._twoNoteArpBox);\r\n    private readonly _chordDropdownGroup: HTMLElement = div({ class: \"editor-controls\", style: \"display: none;\" }, this._arpeggioSpeedRow, this._twoNoteArpRow);\r\n\r\n    private readonly _vibratoSelect: HTMLSelectElement = buildOptions(select(), Config.vibratos.map(vibrato => vibrato.name));\r\n    private readonly _vibratoDropdown: HTMLButtonElement = button({ style: \"margin-left:0em; height:1.5em; width: 10px; padding: 0px; font-size: 8px;\", onclick: () => this._toggleDropdownMenu(DropdownID.Vibrato) }, \"▼\");\r\n    private readonly _vibratoSelectRow: HTMLElement = div({ class: \"selectRow\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"vibrato\") }, \"Vibrato:\"), this._vibratoDropdown, div({ class: \"selectContainer\", style: \"width: 61.5%;\" }, this._vibratoSelect));\r\n    private readonly _vibratoDepthSlider: Slider = new Slider(input({ style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.modulators.dictionary[\"vibrato depth\"].maxRawVol, value: \"0\", step: \"1\" }), this._doc, (oldValue: number, newValue: number) => new ChangeVibratoDepth(this._doc, oldValue, newValue), false);\r\n    private readonly _vibratoDepthRow: HTMLElement = div({ class: \"selectRow\" }, span({ class: \"tip\", style: \"margin-left:10px;\", onclick: () => this._openPrompt(\"vibratoDepth\") }, \"Depth:\"), this._vibratoDepthSlider.container);\r\n    private readonly _vibratoSpeedSlider: Slider = new Slider(input({ style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.modulators.dictionary[\"vibrato speed\"].maxRawVol, value: \"0\", step: \"1\" }), this._doc, (oldValue: number, newValue: number) => new ChangeVibratoSpeed(this._doc, oldValue, newValue), false);\r\n    private readonly _vibratoSpeedRow: HTMLElement = div({ class: \"selectRow\" }, span({ class: \"tip\", style: \"margin-left:10px;\", onclick: () => this._openPrompt(\"vibratoSpeed\") }, \"Speed:\"), this._vibratoSpeedSlider.container);\r\n    private readonly _vibratoDelaySlider: Slider = new Slider(input({ style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.modulators.dictionary[\"vibrato delay\"].maxRawVol, value: \"0\", step: \"1\" }), this._doc, (oldValue: number, newValue: number) => new ChangeVibratoDelay(this._doc, oldValue, newValue), false);\r\n    private readonly _vibratoDelayRow: HTMLElement = div({ class: \"selectRow\" }, span({ class: \"tip\", style: \"margin-left:10px;\", onclick: () => this._openPrompt(\"vibratoDelay\") }, \"Delay:\"), this._vibratoDelaySlider.container);\r\n    private readonly _vibratoTypeSelect: HTMLSelectElement = buildOptions(select(), Config.vibratoTypes.map(vibrato => vibrato.name));\r\n    private readonly _vibratoTypeSelectRow: HTMLElement = div({ class: \"selectRow\" }, span({ class: \"tip\", style: \"margin-left:10px;\", onclick: () => this._openPrompt(\"vibratoType\") }, \"Type:\"), div({ class: \"selectContainer\", style: \"width: 61.5%;\" }, this._vibratoTypeSelect));\r\n    private readonly _vibratoDropdownGroup: HTMLElement = div({ class: \"editor-controls\", style: \"display: none;\" }, this._vibratoDepthRow, this._vibratoSpeedRow, this._vibratoDelayRow, this._vibratoTypeSelectRow);\r\n    private readonly _phaseModGroup: HTMLElement = div({ class: \"editor-controls\" });\r\n    private readonly _feedbackTypeSelect: HTMLSelectElement = buildOptions(select(), Config.feedbacks.map(feedback => feedback.name));\r\n    private readonly _feedbackRow1: HTMLDivElement = div({ class: \"selectRow\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"feedbackType\") }, \"Feedback:\"), div({ class: \"selectContainer\" }, this._feedbackTypeSelect));\r\n    private readonly _spectrumEditor: SpectrumEditor = new SpectrumEditor(this._doc, null);\r\n    private readonly _spectrumRow: HTMLElement = div({ class: \"selectRow\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"spectrum\") }, \"Spectrum:\"), this._spectrumEditor.container);\r\n    private readonly _harmonicsEditor: HarmonicsEditor = new HarmonicsEditor(this._doc);\r\n    private readonly _harmonicsRow: HTMLElement = div({ class: \"selectRow\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"harmonics\") }, \"Harmonics:\"), this._harmonicsEditor.container);\r\n    private readonly _envelopeEditor: EnvelopeEditor = new EnvelopeEditor(this._doc);\r\n    private readonly _drumsetGroup: HTMLElement = div({ class: \"editor-controls\" });\r\n    private readonly _modulatorGroup: HTMLElement = div({ class: \"editor-controls\" });\r\n    private readonly _modNameRows: HTMLElement[];\r\n    private readonly _modChannelBoxes: HTMLSelectElement[];\r\n    private readonly _modInstrumentBoxes: HTMLSelectElement[];\r\n    private readonly _modSetRows: HTMLElement[];\r\n    private readonly _modSetBoxes: HTMLSelectElement[];\r\n    private readonly _modFilterRows: HTMLElement[];\r\n    private readonly _modFilterBoxes: HTMLSelectElement[];\r\n    private readonly _modTargetIndicators: SVGElement[];\r\n\r\n    private readonly _instrumentCopyButton: HTMLButtonElement = button({ style: \"max-width:86px; width: 86px;\", class: \"copyButton\" }, [\r\n        \"Copy\",\r\n        // Copy icon:\r\n        SVG.svg({ style: \"flex-shrink: 0; position: absolute; left: 0; top: 50%; margin-top: -1em; pointer-events: none;\", width: \"2em\", height: \"2em\", viewBox: \"-5 -21 26 26\" }, [\r\n            SVG.path({ d: \"M 0 -15 L 1 -15 L 1 0 L 13 0 L 13 1 L 0 1 L 0 -15 z M 2 -1 L 2 -17 L 10 -17 L 14 -13 L 14 -1 z M 3 -2 L 13 -2 L 13 -12 L 9 -12 L 9 -16 L 3 -16 z\", fill: \"currentColor\" }),\r\n        ]),\r\n    ]);\r\n    private readonly _instrumentPasteButton: HTMLButtonElement = button({ style: \"max-width:86px;\", class: \"pasteButton\" }, [\r\n        \"Paste\",\r\n        // Paste icon:\r\n        SVG.svg({ style: \"flex-shrink: 0; position: absolute; left: 0; top: 50%; margin-top: -1em; pointer-events: none;\", width: \"2em\", height: \"2em\", viewBox: \"0 0 26 26\" }, [\r\n            SVG.path({ d: \"M 8 18 L 6 18 L 6 5 L 17 5 L 17 7 M 9 8 L 16 8 L 20 12 L 20 22 L 9 22 z\", stroke: \"currentColor\", fill: \"none\" }),\r\n            SVG.path({ d: \"M 9 3 L 14 3 L 14 6 L 9 6 L 9 3 z M 16 8 L 20 12 L 16 12 L 16 8 z\", fill: \"currentColor\", }),\r\n        ]),\r\n    ]);\r\n\r\n    private readonly _customWaveDrawCanvas: CustomChipCanvas = new CustomChipCanvas(canvas({ width: 128, height: 52, style: \"border:2px solid \" + ColorConfig.uiWidgetBackground, id: \"customWaveDrawCanvas\" }), this._doc, (newArray: Float32Array) => new ChangeCustomWave(this._doc, newArray));\r\n    private readonly _customWavePresetDrop: HTMLSelectElement = buildHeaderedOptions(\"Load Preset\", select({ style: \"width: 50%; height:1.5em; text-align: center; text-align-last: center;\" }),\r\n        Config.chipWaves.map(wave => wave.name)\r\n    );\r\n    private readonly _customWaveZoom: HTMLButtonElement = button({ style: \"margin-left:0.5em; height:1.5em; max-width: 20px;\", onclick: () => this._openPrompt(\"customChipSettings\") }, \"+\");\r\n\r\n    private readonly _customWaveDraw: HTMLDivElement = div({ style: \"height:80px; margin-top:10px; margin-bottom:5px\" }, [\r\n        div({ style: \"height:54px; display:flex; justify-content:center;\" }, [this._customWaveDrawCanvas.canvas]),\r\n        div({ style: \"margin-top:5px; display:flex; justify-content:center;\" }, [this._customWavePresetDrop, this._customWaveZoom]),\r\n    ]);\r\n\r\n    private readonly _songTitleInputBox: InputBox = new InputBox(input({ style: \"font-weight:bold; border:none; width: 100%; background-color:${ColorConfig.editorBackground}; color:${ColorConfig.primaryText}; text-align:center\", maxlength: \"30\", type: \"text\", value: EditorConfig.versionDisplayName }), this._doc, (oldValue: string, newValue: string) => new ChangeSongTitle(this._doc, oldValue, newValue));\r\n\r\n\r\n    private readonly _feedbackAmplitudeSlider: Slider = new Slider(input({ type: \"range\", min: \"0\", max: Config.operatorAmplitudeMax, value: \"0\", step: \"1\", title: \"Feedback Amplitude\" }), this._doc, (oldValue: number, newValue: number) => new ChangeFeedbackAmplitude(this._doc, oldValue, newValue), false);\r\n    private readonly _feedbackRow2: HTMLDivElement = div({ class: \"selectRow\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"feedbackVolume\") }, \"Fdback Vol:\"), this._feedbackAmplitudeSlider.container);\r\n    /*\r\n     * @jummbus - my very real, valid reason for cutting this button: I don't like it.\r\n     * \r\n    private readonly _customizeInstrumentButton: HTMLButtonElement = button({type: \"button\", style: \"margin: 2px 0\"},\r\n\r\n        \"Customize Instrument\",\r\n    );\r\n    */\r\n    private readonly _addEnvelopeButton: HTMLButtonElement = button({ type: \"button\", class: \"add-envelope\" });\r\n    private readonly _customInstrumentSettingsGroup: HTMLDivElement = div({ class: \"editor-controls\" },\r\n        this._panSliderRow,\r\n        this._panDropdownGroup,\r\n        this._chipWaveSelectRow,\r\n        this._chipNoiseSelectRow,\r\n        this._customWaveDraw,\r\n        this._eqFilterTypeRow,\r\n        this._eqFilterRow,\r\n        this._eqFilterSimpleCutRow,\r\n        this._eqFilterSimplePeakRow,\r\n        this._fadeInOutRow,\r\n        this._algorithmSelectRow,\r\n        this._phaseModGroup,\r\n        this._feedbackRow1,\r\n        this._feedbackRow2,\r\n        this._spectrumRow,\r\n        this._harmonicsRow,\r\n        this._drumsetGroup,\r\n        this._pulseWidthRow,\r\n        this._stringSustainRow,\r\n        this._unisonSelectRow,\r\n        div({ style: `padding: 2px 0; margin-left: 2em; display: flex; align-items: center;` },\r\n            span({ style: `flex-grow: 1; text-align: center;` }, span({ class: \"tip\", onclick: () => this._openPrompt(\"effects\") }, \"Effects\")),\r\n            div({ class: \"effects-menu\" }, this._effectsSelect),\r\n        ),\r\n        this._transitionRow,\r\n        this._transitionDropdownGroup,\r\n        this._chordSelectRow,\r\n        this._chordDropdownGroup,\r\n        this._pitchShiftRow,\r\n        this._detuneSliderRow,\r\n        this._vibratoSelectRow,\r\n        this._vibratoDropdownGroup,\r\n        this._noteFilterTypeRow,\r\n        this._noteFilterRow,\r\n        this._noteFilterSimpleCutRow,\r\n        this._noteFilterSimplePeakRow,\r\n        this._distortionRow,\r\n        this._aliasingRow,\r\n        this._bitcrusherQuantizationRow,\r\n        this._bitcrusherFreqRow,\r\n        this._chorusRow,\r\n        this._echoSustainRow,\r\n        this._echoDelayRow,\r\n        this._reverbRow,\r\n        div({ style: `padding: 2px 0; margin-left: 2em; display: flex; align-items: center;` },\r\n            span({ style: `flex-grow: 1; text-align: center;` }, span({ class: \"tip\", onclick: () => this._openPrompt(\"envelopes\") }, \"Envelopes\")),\r\n            this._addEnvelopeButton,\r\n        ),\r\n        this._envelopeEditor.container,\r\n    );\r\n    private readonly _instrumentCopyGroup: HTMLDivElement = div({ class: \"editor-controls\" },\r\n        div({ class: \"selectRow\" },\r\n            this._instrumentCopyButton,\r\n            this._instrumentPasteButton,\r\n        ),\r\n    );\r\n    private readonly _instrumentSettingsTextRow: HTMLDivElement = div({ id: \"instrumentSettingsText\", style: `padding: 3px 0; max-width: 15em; text-align: center; color: ${ColorConfig.secondaryText};` },\r\n        \"Instrument Settings\"\r\n    );\r\n    private readonly _instrumentTypeSelectRow: HTMLDivElement = div({ class: \"selectRow\", id: \"typeSelectRow\" },\r\n        span({ class: \"tip\", onclick: () => this._openPrompt(\"instrumentType\") }, \"Type:\"),\r\n        div(\r\n            div({ class: \"pitchSelect\" }, this._pitchedPresetSelect),\r\n            div({ class: \"drumSelect\" }, this._drumPresetSelect)\r\n        ),\r\n    );\r\n    private readonly _instrumentSettingsGroup: HTMLDivElement = div({ class: \"editor-controls\" },\r\n        this._instrumentSettingsTextRow,\r\n        this._instrumentsButtonRow,\r\n        this._instrumentTypeSelectRow,\r\n        this._instrumentVolumeSliderRow,\r\n        //this._customizeInstrumentButton,\r\n        this._customInstrumentSettingsGroup,\r\n    );\r\n    private readonly _usedPatternIndicator: SVGElement = SVG.path({ d: \"M -6 -6 H 6 V 6 H -6 V -6 M -2 -3 L -2 -3 L -1 -4 H 1 V 4 H -1 V -1.2 L -1.2 -1 H -2 V -3 z\", fill: ColorConfig.indicatorSecondary, \"fill-rule\": \"evenodd\" });\r\n    private readonly _usedInstrumentIndicator: SVGElement = SVG.path({ d: \"M -6 -0.8 H -3.8 V -6 H 0.8 V 4.4 H 2.2 V -0.8 H 6 V 0.8 H 3.8 V 6 H -0.8 V -4.4 H -2.2 V 0.8 H -6 z\", fill: ColorConfig.indicatorSecondary });\r\n    private readonly _jumpToModIndicator: SVGElement = SVG.svg({ style: \"width: 92%; height: 1.3em; flex-shrink: 0; position: absolute;\", viewBox: \"0 0 200 200\" }, [\r\n        SVG.path({ d: \"M90 155 l0 -45 -45 0 c-25 0 -45 -4 -45 -10 0 -5 20 -10 45 -10 l45 0 0 -45 c0 -25 5 -45 10 -45 6 0 10 20 10 45 l0 45 45 0 c25 0 45 5 45 10 0 6 -20 10 -45 10 l -45 0 0 45 c0 25 -4 45 -10 45 -5 0 -10 -20 -10 -45z\" }),\r\n        SVG.path({ d: \"M42 158 c-15 -15 -16 -38 -2 -38 6 0 10 7 10 15 0 8 7 15 15 15 8 0 15 5 15 10 0 14 -23 13 -38 -2z\" }),\r\n        SVG.path({ d: \"M120 160 c0 -5 7 -10 15 -10 8 0 15 -7 15 -15 0 -8 5 -15 10 -15 14 0 13 23 -2 38 -15 15 -38 16 -38 2z\" }),\r\n        SVG.path({ d: \"M32 58 c3 -23 48 -40 48 -19 0 6 -7 11 -15 11 -8 0 -15 7 -15 15 0 8 -5 15 -11 15 -6 0 -9 -10 -7 -22z\" }),\r\n        SVG.path({ d: \"M150 65 c0 -8 -7 -15 -15 -15 -8 0 -15 -4 -15 -10 0 -14 23 -13 38 2 15 15 16 38 2 38 -5 0 -10 -7 -10 -15z\" })]);\r\n\r\n    private readonly _promptContainer: HTMLDivElement = div({ class: \"promptContainer\", style: \"display: none;\" });\r\n    private readonly _zoomInButton: HTMLButtonElement = button({ class: \"zoomInButton\", type: \"button\", title: \"Zoom In\" });\r\n    private readonly _zoomOutButton: HTMLButtonElement = button({ class: \"zoomOutButton\", type: \"button\", title: \"Zoom Out\" });\r\n    private readonly _patternEditorRow: HTMLDivElement = div({ style: \"flex: 1; height: 100%; display: flex; overflow: hidden; justify-content: center;\" },\r\n        this._patternEditorPrev.container,\r\n        this._patternEditor.container,\r\n        this._patternEditorNext.container,\r\n    );\r\n    private readonly _patternArea: HTMLDivElement = div({ class: \"pattern-area\" },\r\n        this._piano.container,\r\n        this._patternEditorRow,\r\n        this._octaveScrollBar.container,\r\n        this._zoomInButton,\r\n        this._zoomOutButton,\r\n    );\r\n    private readonly _trackContainer: HTMLDivElement = div({ class: \"trackContainer\" },\r\n        this._trackEditor.container,\r\n        this._loopEditor.container,\r\n    );\r\n    private readonly _trackVisibleArea: HTMLDivElement = div({ style: \"position: absolute; width: 100%; height: 100%; pointer-events: none;\" });\r\n    private readonly _trackAndMuteContainer: HTMLDivElement = div({ class: \"trackAndMuteContainer\" },\r\n        this._muteEditor.container,\r\n        this._trackContainer,\r\n        this._trackVisibleArea,\r\n    );\r\n    public readonly _barScrollBar: BarScrollBar = new BarScrollBar(this._doc, this._trackAndMuteContainer);\r\n    private readonly _trackArea: HTMLDivElement = div({ class: \"track-area\" },\r\n        this._trackAndMuteContainer,\r\n        this._barScrollBar.container,\r\n    );\r\n\r\n    private readonly _menuArea: HTMLDivElement = div({ class: \"menu-area\" },\r\n        div({ class: \"selectContainer menu file\" },\r\n            this._fileMenu,\r\n        ),\r\n        div({ class: \"selectContainer menu edit\" },\r\n            this._editMenu,\r\n        ),\r\n        div({ class: \"selectContainer menu preferences\" },\r\n            this._optionsMenu,\r\n        ),\r\n    );\r\n    private readonly _songSettingsArea: HTMLDivElement = div({ class: \"song-settings-area\" },\r\n        div({ class: \"editor-controls\" },\r\n            div({ class: \"editor-song-settings\" },\r\n                div({ style: \"margin: 3px 0; position: relative; text-align: center; color: ${ColorConfig.secondaryText};\" },\r\n                    div({ class: \"tip\", style: \"flex-shrink: 0; position:absolute; left: 0; top: 0; width: 12px; height: 12px\", onclick: () => this._openPrompt(\"usedPattern\") },\r\n                        SVG.svg({ style: \"flex-shrink: 0; position: absolute; left: 0; top: 0; pointer-events: none;\", width: \"12px\", height: \"12px\", \"margin-right\": \"0.5em\", viewBox: \"-6 -6 12 12\" },\r\n                            this._usedPatternIndicator,\r\n                        ),\r\n                    ),\r\n                    div({ class: \"tip\", style: \"flex-shrink: 0; position: absolute; left: 14px; top: 0; width: 12px; height: 12px\", onclick: () => this._openPrompt(\"usedInstrument\") },\r\n                        SVG.svg({ style: \"flex-shrink: 0; position: absolute; left: 0; top: 0; pointer-events: none;\", width: \"12px\", height: \"12px\", \"margin-right\": \"1em\", viewBox: \"-6 -6 12 12\" },\r\n                            this._usedInstrumentIndicator,\r\n                        ),\r\n                    ),\r\n                    \"Song Settings\",\r\n                    div({ style: \"width: 100%; left: 0; top: -1px; position:absolute; overflow-x:clip;\" }, this._jumpToModIndicator),\r\n                ),\r\n            ),\r\n            div({ class: \"selectRow\" },\r\n                span({ class: \"tip\", onclick: () => this._openPrompt(\"scale\") }, \"Scale: \"),\r\n                div({ class: \"selectContainer\" }, this._scaleSelect),\r\n            ),\r\n            div({ class: \"selectRow\" },\r\n                span({ class: \"tip\", onclick: () => this._openPrompt(\"key\") }, \"Key: \"),\r\n                div({ class: \"selectContainer\" }, this._keySelect),\r\n            ),\r\n            div({ class: \"selectRow\" },\r\n                span({ class: \"tip\", onclick: () => this._openPrompt(\"tempo\") }, \"Tempo: \"),\r\n                span({ style: \"display: flex;\" },\r\n                    this._tempoSlider.container,\r\n                    this._tempoStepper,\r\n                ),\r\n            ),\r\n            div({ class: \"selectRow\" },\r\n                span({ class: \"tip\", onclick: () => this._openPrompt(\"rhythm\") }, \"Rhythm: \"),\r\n                div({ class: \"selectContainer\" }, this._rhythmSelect),\r\n            ),\r\n        ),\r\n    );\r\n    private readonly _instrumentSettingsArea: HTMLDivElement = div({ class: \"instrument-settings-area\" },\r\n        this._instrumentSettingsGroup,\r\n        this._modulatorGroup);\r\n    public readonly _settingsArea: HTMLDivElement = div({ class: \"settings-area noSelection\" },\r\n        div({ class: \"version-area\" },\r\n            div({ style: `text-align: center; margin: 3px 0; color: ${ColorConfig.secondaryText};` },\r\n                this._songTitleInputBox.input,\r\n            ),\r\n        ),\r\n        div({ class: \"play-pause-area\" },\r\n            this._volumeBarBox,\r\n            div({ class: \"playback-bar-controls\" },\r\n                this._pausePlayer,\r\n                this._fileInput,\r\n                this._playButton,\r\n                this._pauseButton,\r\n                this._recordButton,\r\n                this._stopButton,\r\n                this._prevBarButton,\r\n                this._nextBarButton,\r\n            ),\r\n            div({ class: \"playback-volume-controls\" },\r\n                span({ class: \"volume-speaker\" }),\r\n                this._volumeSlider.container,\r\n            ),\r\n        ),\r\n        this._menuArea,\r\n        this._songSettingsArea,\r\n        this._instrumentSettingsArea,\r\n    );\r\n\r\n    public readonly mainLayer: HTMLDivElement = div({ class: \"beepboxEditor\", tabIndex: \"0\" },\r\n        this._patternArea,\r\n        this._trackArea,\r\n        this._settingsArea,\r\n        this._promptContainer,\r\n    );\r\n\r\n    private _wasPlaying: boolean = false;\r\n    private _currentPromptName: string | null = null;\r\n    private _highlightedInstrumentIndex: number = -1;\r\n    private _renderedInstrumentCount: number = 0;\r\n    private _renderedIsPlaying: boolean = false;\r\n    private _renderedIsRecording: boolean = false;\r\n    private _renderedShowRecordButton: boolean = false;\r\n    private _renderedCtrlHeld: boolean = false;\r\n    private _ctrlHeld: boolean = false;\r\n    private _deactivatedInstruments: boolean = false;\r\n    private readonly _operatorRows: HTMLDivElement[] = [];\r\n    private readonly _operatorAmplitudeSliders: Slider[] = [];\r\n    private readonly _operatorFrequencySelects: HTMLSelectElement[] = [];\r\n    private readonly _operatorDropdowns: HTMLButtonElement[] = [];\r\n    private readonly _operatorWaveformSelects: HTMLSelectElement[] = [];\r\n    private readonly _operatorWaveformHints: HTMLSpanElement[] = [];\r\n    private readonly _operatorWaveformPulsewidthSliders: Slider[] = [];\r\n    private readonly _operatorDropdownRows: HTMLElement[] = []\r\n    private readonly _operatorDropdownGroups: HTMLDivElement[] = [];\r\n    private readonly _drumsetSpectrumEditors: SpectrumEditor[] = [];\r\n    private readonly _drumsetEnvelopeSelects: HTMLSelectElement[] = [];\r\n    private _showModSliders: boolean[] = [];\r\n    private _newShowModSliders: boolean[] = [];\r\n    private _modSliderValues: number[] = [];\r\n    private _hasActiveModSliders: boolean = false;\r\n\r\n    private _openPanDropdown: boolean = false;\r\n    private _openVibratoDropdown: boolean = false;\r\n    private _openChordDropdown: boolean = false;\r\n    private _openTransitionDropdown: boolean = false;\r\n    private _openOperatorDropdowns: boolean[] = [];\r\n\r\n    private outVolumeHistoricTimer: number = 0;\r\n    private outVolumeHistoricCap: number = 0;\r\n    private lastOutVolumeCap: number = 0;\r\n\r\n    constructor(private _doc: SongDocument) {\r\n\r\n        this._doc.notifier.watch(this.whenUpdated);\r\n        new MidiInputHandler(this._doc);\r\n        window.addEventListener(\"resize\", this.whenUpdated);\r\n        window.requestAnimationFrame(this.updatePlayButton);\r\n        window.requestAnimationFrame(this._animate);\r\n\r\n        if (!(\"share\" in navigator)) {\r\n            this._fileMenu.removeChild(this._fileMenu.querySelector(\"[value='shareUrl']\")!);\r\n        }\r\n\r\n        this._scaleSelect.appendChild(optgroup({ label: \"Edit\" },\r\n            option({ value: \"forceScale\" }, \"Snap Notes To Scale\"),\r\n        ));\r\n        this._keySelect.appendChild(optgroup({ label: \"Edit\" },\r\n            option({ value: \"detectKey\" }, \"Detect Key\"),\r\n        ));\r\n        this._rhythmSelect.appendChild(optgroup({ label: \"Edit\" },\r\n            option({ value: \"forceRhythm\" }, \"Snap Notes To Rhythm\"),\r\n        ));\r\n\r\n        this._vibratoSelect.appendChild(option({ hidden: true, value: 5 }, \"custom\"));\r\n\r\n        this._showModSliders = new Array<boolean>(Config.modulators.length);\r\n        this._modSliderValues = new Array<number>(Config.modulators.length);\r\n\r\n        this._phaseModGroup.appendChild(div({ class: \"selectRow\", style: `color: ${ColorConfig.secondaryText}; height: 1em; margin-top: 0.5em;` },\r\n            div({ style: \"margin-right: .1em; visibility: hidden;\" }, 1 + \".\"),\r\n            div({ style: \"width: 3em; margin-right: .3em;\", class: \"tip\", onclick: () => this._openPrompt(\"operatorFrequency\") }, \"Freq:\"),\r\n            div({ class: \"tip\", onclick: () => this._openPrompt(\"operatorVolume\") }, \"Volume:\"),\r\n        ));\r\n        for (let i: number = 0; i < Config.operatorCount; i++) {\r\n            const operatorIndex: number = i;\r\n            const operatorNumber: HTMLDivElement = div({ style: \"margin-right: 0px; color: \" + ColorConfig.secondaryText + \";\" }, i + 1 + \"\");\r\n            const frequencySelect: HTMLSelectElement = buildOptions(select({ style: \"width: 100%;\", title: \"Frequency\" }), Config.operatorFrequencies.map(freq => freq.name));\r\n            const amplitudeSlider: Slider = new Slider(input({ type: \"range\", min: \"0\", max: Config.operatorAmplitudeMax, value: \"0\", step: \"1\", title: \"Volume\" }), this._doc, (oldValue: number, newValue: number) => new ChangeOperatorAmplitude(this._doc, operatorIndex, oldValue, newValue), false);\r\n            const waveformSelect: HTMLSelectElement = buildOptions(select({ style: \"width: 100%;\", title: \"Waveform\" }), Config.operatorWaves.map(wave => wave.name));\r\n            const waveformDropdown: HTMLButtonElement = button({ style: \"margin-left:0em; margin-right: 2px; height:1.5em; width: 8px; max-width: 10px; padding: 0px; font-size: 8px;\", onclick: () => this._toggleDropdownMenu(DropdownID.FM, i) }, \"▼\");\r\n            const waveformDropdownHint: HTMLSpanElement = span({ class: \"tip\", style: \"margin-left: 10px;\", onclick: () => this._openPrompt(\"operatorWaveform\") }, \"Wave:\");\r\n            const waveformPulsewidthSlider: Slider = new Slider(input({ style: \"margin-left: 10px; width: 85%;\", type: \"range\", min: \"0\", max: Config.pwmOperatorWaves.length - 1, value: \"0\", step: \"1\", title: \"Pulse Width\" }), this._doc, (oldValue: number, newValue: number) => new ChangeOperatorPulseWidth(this._doc, operatorIndex, oldValue, newValue), true);\r\n            const waveformDropdownRow: HTMLElement = div({ class: \"selectRow\" }, waveformDropdownHint, waveformPulsewidthSlider.container,\r\n                div({ class: \"selectContainer\", style: \"width: 6em; margin-left: .3em;\" }, waveformSelect));\r\n            const waveformDropdownGroup: HTMLDivElement = div({ class: \"operatorRow\" }, waveformDropdownRow);\r\n            const row: HTMLDivElement = div({ class: \"selectRow\" },\r\n                operatorNumber,\r\n                waveformDropdown,\r\n                div({ class: \"selectContainer\", style: \"width: 3em; margin-right: .3em;\" }, frequencySelect),\r\n                amplitudeSlider.container,\r\n            );\r\n            this._phaseModGroup.appendChild(row);\r\n            this._operatorRows[i] = row;\r\n            this._operatorAmplitudeSliders[i] = amplitudeSlider;\r\n            this._operatorFrequencySelects[i] = frequencySelect;\r\n            this._operatorDropdowns[i] = waveformDropdown;\r\n            this._operatorWaveformHints[i] = waveformDropdownHint;\r\n            this._operatorWaveformSelects[i] = waveformSelect;\r\n            this._operatorWaveformPulsewidthSliders[i] = waveformPulsewidthSlider;\r\n            this._operatorDropdownRows[i] = waveformDropdownRow;\r\n            this._phaseModGroup.appendChild(waveformDropdownGroup);\r\n            this._operatorDropdownGroups[i] = waveformDropdownGroup;\r\n            this._openOperatorDropdowns[i] = false;\r\n\r\n            waveformSelect.addEventListener(\"change\", () => {\r\n                this._doc.record(new ChangeOperatorWaveform(this._doc, operatorIndex, waveformSelect.selectedIndex));\r\n            });\r\n\r\n            frequencySelect.addEventListener(\"change\", () => {\r\n                this._doc.record(new ChangeOperatorFrequency(this._doc, operatorIndex, frequencySelect.selectedIndex));\r\n            });\r\n        }\r\n\r\n        this._drumsetGroup.appendChild(\r\n            div({ class: \"selectRow\" },\r\n                span({ class: \"tip\", onclick: () => this._openPrompt(\"drumsetEnvelope\") }, \"Envelope:\"),\r\n                span({ class: \"tip\", onclick: () => this._openPrompt(\"drumsetSpectrum\") }, \"Spectrum:\"),\r\n            ),\r\n        );\r\n        for (let i: number = Config.drumCount - 1; i >= 0; i--) {\r\n            const drumIndex: number = i;\r\n            const spectrumEditor: SpectrumEditor = new SpectrumEditor(this._doc, drumIndex);\r\n            spectrumEditor.container.addEventListener(\"mousedown\", this.refocusStage);\r\n            this._drumsetSpectrumEditors[i] = spectrumEditor;\r\n\r\n            const envelopeSelect: HTMLSelectElement = buildOptions(select({ style: \"width: 100%;\", title: \"Filter Envelope\" }), Config.envelopes.map(envelope => envelope.name));\r\n            this._drumsetEnvelopeSelects[i] = envelopeSelect;\r\n            envelopeSelect.addEventListener(\"change\", () => {\r\n                this._doc.record(new ChangeDrumsetEnvelope(this._doc, drumIndex, envelopeSelect.selectedIndex));\r\n            });\r\n\r\n            const row: HTMLDivElement = div({ class: \"selectRow\" },\r\n                div({ class: \"selectContainer\", style: \"width: 5em; margin-right: .3em;\" }, envelopeSelect),\r\n                this._drumsetSpectrumEditors[i].container,\r\n            );\r\n            this._drumsetGroup.appendChild(row);\r\n        }\r\n\r\n        this._modNameRows = [];\r\n        this._modChannelBoxes = [];\r\n        this._modInstrumentBoxes = [];\r\n        this._modSetRows = [];\r\n        this._modSetBoxes = [];\r\n        this._modFilterRows = [];\r\n        this._modFilterBoxes = [];\r\n        this._modTargetIndicators = [];\r\n        for (let mod: number = 0; mod < Config.modCount; mod++) {\r\n\r\n            let modChannelBox: HTMLSelectElement = select({ style: \"width: 100%; color: currentColor; text-overflow:ellipsis;\" });\r\n            let modInstrumentBox: HTMLSelectElement = select({ style: \"width: 100%; color: currentColor;\" });\r\n\r\n            let modNameRow: HTMLDivElement = div({ class: \"operatorRow\", style: \"height: 1em; margin-bottom: 0.65em;\" },\r\n                div({ class: \"tip\", style: \"width: 10%; max-width: 5.4em;\", id: \"modChannelText\" + mod, onclick: () => this._openPrompt(\"modChannel\") }, \"Ch:\"),\r\n                div({ class: \"selectContainer\", style: 'width: 35%;' }, modChannelBox),\r\n                div({ class: \"tip\", style: \"width: 1.2em; margin-left: 0.8em;\", id: \"modInstrumentText\" + mod, onclick: () => this._openPrompt(\"modInstrument\") }, \"Ins:\"),\r\n                div({ class: \"selectContainer\", style: \"width: 10%;\" }, modInstrumentBox),\r\n            );\r\n\r\n            let modSetBox: HTMLSelectElement = select();\r\n            let modFilterBox: HTMLSelectElement = select();\r\n            let modSetRow: HTMLDivElement = div({ class: \"selectRow\", id: \"modSettingText\" + mod, style: \"margin-bottom: 0.9em; color: currentColor;\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"modSet\") }, \"Setting: \"), span({ class: \"tip\", style: \"font-size:x-small;\", onclick: () => this._openPrompt(\"modSetInfo\" + mod) }, \"?\"), div({ class: \"selectContainer\" }, modSetBox));\r\n            let modFilterRow: HTMLDivElement = div({ class: \"selectRow\", id: \"modFilterText\" + mod, style: \"margin-bottom: 0.9em; color: currentColor;\" }, span({ class: \"tip\", onclick: () => this._openPrompt(\"modFilter\" + mod) }, \"Target: \"), div({ class: \"selectContainer\" }, modFilterBox));\r\n\r\n            // @jummbus: I could template this up above and simply create from the template, especially since I also reuse it in song settings, but unsure how to do that with imperative-html :P\r\n            let modTarget: SVGElement = SVG.svg({ style: \"transform: translate(0px, 1px);\", width: \"1.5em\", height: \"1em\", viewBox: \"0 0 200 200\" }, [\r\n                SVG.path({ d: \"M90 155 l0 -45 -45 0 c-25 0 -45 -4 -45 -10 0 -5 20 -10 45 -10 l45 0 0 -45 c0 -25 5 -45 10 -45 6 0 10 20 10 45 l0 45 45 0 c25 0 45 5 45 10 0 6 -20 10 -45 10 l -45 0 0 45 c0 25 -4 45 -10 45 -5 0 -10 -20 -10 -45z\" }),\r\n                SVG.path({ d: \"M42 158 c-15 -15 -16 -38 -2 -38 6 0 10 7 10 15 0 8 7 15 15 15 8 0 15 5 15 10 0 14 -23 13 -38 -2z\" }),\r\n                SVG.path({ d: \"M120 160 c0 -5 7 -10 15 -10 8 0 15 -7 15 -15 0 -8 5 -15 10 -15 14 0 13 23 -2 38 -15 15 -38 16 -38 2z\" }),\r\n                SVG.path({ d: \"M32 58 c3 -23 48 -40 48 -19 0 6 -7 11 -15 11 -8 0 -15 7 -15 15 0 8 -5 15 -11 15 -6 0 -9 -10 -7 -22z\" }),\r\n                SVG.path({ d: \"M150 65 c0 -8 -7 -15 -15 -15 -8 0 -15 -4 -15 -10 0 -14 23 -13 38 2 15 15 16 38 2 38 -5 0 -10 -7 -10 -15z\" })]);\r\n\r\n            this._modNameRows.push(modNameRow);\r\n            this._modChannelBoxes.push(modChannelBox);\r\n            this._modInstrumentBoxes.push(modInstrumentBox);\r\n            this._modSetRows.push(modSetRow);\r\n            this._modSetBoxes.push(modSetBox);\r\n            this._modFilterRows.push(modFilterRow);\r\n            this._modFilterBoxes.push(modFilterBox);\r\n            this._modTargetIndicators.push(modTarget);\r\n\r\n            this._modulatorGroup.appendChild(div({ style: \"margin: 3px 0; font-weight: bold; margin-bottom: 0.7em; text-align: center; color: \" + ColorConfig.secondaryText + \"; background: \" + ColorConfig.uiWidgetBackground + \";\" }, [\"Modulator \" + (mod + 1), modTarget]));\r\n            this._modulatorGroup.appendChild(modNameRow);\r\n            this._modulatorGroup.appendChild(modSetRow);\r\n            this._modulatorGroup.appendChild(modFilterRow);\r\n\r\n        }\r\n\r\n        // @jummbus - Unsure why this hack is needed for alignment, but I've never been a css wiz...\r\n        this._pitchShiftSlider.container.style.setProperty(\"transform\", \"translate(0px, 3px)\");\r\n        this._pitchShiftSlider.container.style.setProperty(\"width\", \"100%\");\r\n\r\n        this._fileMenu.addEventListener(\"change\", this._fileMenuHandler);\r\n        this._editMenu.addEventListener(\"change\", this._editMenuHandler);\r\n        this._optionsMenu.addEventListener(\"change\", this._optionsMenuHandler);\r\n        this._customWavePresetDrop.addEventListener(\"change\", this._customWavePresetHandler);\r\n        this._tempoStepper.addEventListener(\"change\", this._whenSetTempo);\r\n        this._scaleSelect.addEventListener(\"change\", this._whenSetScale);\r\n        this._keySelect.addEventListener(\"change\", this._whenSetKey);\r\n        this._rhythmSelect.addEventListener(\"change\", this._whenSetRhythm);\r\n        //this._pitchedPresetSelect.addEventListener(\"change\", this._whenSetPitchedPreset);\r\n        //this._drumPresetSelect.addEventListener(\"change\", this._whenSetDrumPreset);\r\n        this._algorithmSelect.addEventListener(\"change\", this._whenSetAlgorithm);\r\n        this._instrumentsButtonBar.addEventListener(\"click\", this._whenSelectInstrument);\r\n        //this._customizeInstrumentButton.addEventListener(\"click\", this._whenCustomizePressed);\r\n        this._feedbackTypeSelect.addEventListener(\"change\", this._whenSetFeedbackType);\r\n        this._chipWaveSelect.addEventListener(\"change\", this._whenSetChipWave);\r\n        this._chipNoiseSelect.addEventListener(\"change\", this._whenSetNoiseWave);\r\n        this._transitionSelect.addEventListener(\"change\", this._whenSetTransition);\r\n        this._effectsSelect.addEventListener(\"change\", this._whenSetEffects);\r\n        this._unisonSelect.addEventListener(\"change\", this._whenSetUnison);\r\n        this._chordSelect.addEventListener(\"change\", this._whenSetChord);\r\n        this._vibratoSelect.addEventListener(\"change\", this._whenSetVibrato);\r\n        this._vibratoTypeSelect.addEventListener(\"change\", this._whenSetVibratoType);\r\n        this._playButton.addEventListener(\"click\", this.togglePlay);\r\n        this._pauseButton.addEventListener(\"click\", this.togglePlay);\r\n        this._recordButton.addEventListener(\"click\", this._toggleRecord);\r\n        this._stopButton.addEventListener(\"click\", this._toggleRecord);\r\n\r\n        // !!! Important !!!\r\n        this._fileInput.addEventListener(\"inject_MIDI\", this._changeSong);\r\n        this._fileInput.addEventListener(\"clear_track\", this._clearSong);\r\n        this._fileInput.addEventListener(\"fetch_track\", this._fetchSong);\r\n        // !!! Important !!!\r\n\r\n\r\n        this._pausePlayer.addEventListener(\"deactivateEditor\", this._deactivate);\r\n\r\n        // Start recording instead of opening context menu when control-clicking the record button on a Mac.\r\n        this._recordButton.addEventListener(\"contextmenu\", (event: MouseEvent) => {\r\n            if (event.ctrlKey) {\r\n                event.preventDefault();\r\n                this._toggleRecord();\r\n            }\r\n        });\r\n        this._stopButton.addEventListener(\"contextmenu\", (event: MouseEvent) => {\r\n            if (event.ctrlKey) {\r\n                event.preventDefault();\r\n                this._toggleRecord();\r\n            }\r\n        });\r\n        this._prevBarButton.addEventListener(\"click\", this._whenPrevBarPressed);\r\n        this._nextBarButton.addEventListener(\"click\", this._whenNextBarPressed);\r\n        this._volumeSlider.input.addEventListener(\"input\", this._setVolumeSlider);\r\n        this._zoomInButton.addEventListener(\"click\", this._zoomIn);\r\n        this._zoomOutButton.addEventListener(\"click\", this._zoomOut);\r\n        this._patternArea.addEventListener(\"mousedown\", this._refocusStageNotEditing);\r\n        this._trackArea.addEventListener(\"mousedown\", this.refocusStage);\r\n\r\n        // The song volume slider is styled slightly different than the class' default.\r\n        this._volumeSlider.container.style.setProperty(\"flex-grow\", \"1\");\r\n        this._volumeSlider.container.style.setProperty(\"display\", \"flex\");\r\n\r\n        this._volumeBarContainer.style.setProperty(\"flex-grow\", \"1\");\r\n        this._volumeBarContainer.style.setProperty(\"display\", \"flex\");\r\n\r\n        // Also, any slider with a multiplicative effect instead of a replacement effect gets a different mod color, and a round slider.\r\n        this._volumeSlider.container.style.setProperty(\"--mod-color\", ColorConfig.multiplicativeModSlider);\r\n        this._volumeSlider.container.style.setProperty(\"--mod-border-radius\", \"50%\");\r\n        this._instrumentVolumeSlider.container.style.setProperty(\"--mod-color\", ColorConfig.multiplicativeModSlider);\r\n        this._instrumentVolumeSlider.container.style.setProperty(\"--mod-border-radius\", \"50%\");\r\n        this._feedbackAmplitudeSlider.container.style.setProperty(\"--mod-color\", ColorConfig.multiplicativeModSlider);\r\n        this._feedbackAmplitudeSlider.container.style.setProperty(\"--mod-border-radius\", \"50%\");\r\n        for (let i: number = 0; i < Config.operatorCount; i++) {\r\n            this._operatorAmplitudeSliders[i].container.style.setProperty(\"--mod-color\", ColorConfig.multiplicativeModSlider);\r\n            this._operatorAmplitudeSliders[i].container.style.setProperty(\"--mod-border-radius\", \"50%\");\r\n        }\r\n\r\n        let thisRef: SongEditor = this;\r\n        for (let mod: number = 0; mod < Config.modCount; mod++) {\r\n            this._modChannelBoxes[mod].addEventListener(\"change\", function () { thisRef._whenSetModChannel(mod); });\r\n            this._modInstrumentBoxes[mod].addEventListener(\"change\", function () { thisRef._whenSetModInstrument(mod); });\r\n            this._modSetBoxes[mod].addEventListener(\"change\", function () { thisRef._whenSetModSetting(mod); });\r\n            this._modFilterBoxes[mod].addEventListener(\"change\", function () { thisRef._whenSetModFilter(mod); });\r\n            this._modTargetIndicators[mod].addEventListener(\"click\", function () { thisRef._whenClickModTarget(mod); });\r\n        }\r\n\r\n        this._jumpToModIndicator.addEventListener(\"click\", function () { thisRef._whenClickJumpToModTarget() });\r\n\r\n        this._patternArea.addEventListener(\"mousedown\", this.refocusStage);\r\n        this._fadeInOutEditor.container.addEventListener(\"mousedown\", this.refocusStage);\r\n        this._spectrumEditor.container.addEventListener(\"mousedown\", this.refocusStage);\r\n        this._eqFilterEditor.container.addEventListener(\"mousedown\", this.refocusStage);\r\n        this._noteFilterEditor.container.addEventListener(\"mousedown\", this.refocusStage);\r\n        this._harmonicsEditor.container.addEventListener(\"mousedown\", this.refocusStage);\r\n        this._tempoStepper.addEventListener(\"keydown\", this._tempoStepperCaptureNumberKeys, false);\r\n        this._addEnvelopeButton.addEventListener(\"click\", this._addNewEnvelope);\r\n        this._patternArea.addEventListener(\"contextmenu\", this._disableCtrlContextMenu);\r\n        this._trackArea.addEventListener(\"contextmenu\", this._disableCtrlContextMenu);\r\n        this.mainLayer.addEventListener(\"keydown\", this._whenKeyPressed);\r\n        this.mainLayer.addEventListener(\"keyup\", this._whenKeyReleased);\r\n        this.mainLayer.addEventListener(\"focusin\", this._onFocusIn);\r\n        this._instrumentCopyButton.addEventListener(\"click\", this._copyInstrument.bind(this));\r\n        this._instrumentPasteButton.addEventListener(\"click\", this._pasteInstrument.bind(this));\r\n\r\n        this._instrumentVolumeSliderInputBox.addEventListener(\"input\", () => { this._doc.record(new ChangeVolume(this._doc, this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()].volume, Math.min(25.0, Math.max(-25.0, Math.round(+this._instrumentVolumeSliderInputBox.value))))) });\r\n        this._panSliderInputBox.addEventListener(\"input\", () => { this._doc.record(new ChangePan(this._doc, this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()].pan, Math.min(100.0, Math.max(0.0, Math.round(+this._panSliderInputBox.value))))) });\r\n        this._detuneSliderInputBox.addEventListener(\"input\", () => { this._doc.record(new ChangeDetune(this._doc, this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()].detune, Math.min(Config.detuneMax - Config.detuneCenter, Math.max(Config.detuneMin - Config.detuneCenter, Math.round(+this._detuneSliderInputBox.value))))) });\r\n        this._customWaveDraw.addEventListener(\"input\", () => { this._doc.record(new ChangeCustomWave(this._doc, this._customWaveDrawCanvas.newArray)) });\r\n        this._twoNoteArpBox.addEventListener(\"input\", () => { this._doc.record(new ChangeFastTwoNoteArp(this._doc, this._twoNoteArpBox.checked)) });\r\n        this._clicklessTransitionBox.addEventListener(\"input\", () => { this._doc.record(new ChangeClicklessTransition(this._doc, this._clicklessTransitionBox.checked)) });\r\n        this._aliasingBox.addEventListener(\"input\", () => { this._doc.record(new ChangeAliasing(this._doc, this._aliasingBox.checked)) });\r\n\r\n        this._promptContainer.addEventListener(\"click\", (event) => {\r\n            if (event.target == this._promptContainer) {\r\n                this._doc.undo();\r\n            }\r\n        });\r\n\r\n        if (isMobile) {\r\n            const autoPlayOption: HTMLOptionElement = <HTMLOptionElement>this._optionsMenu.querySelector(\"[value=autoPlay]\");\r\n            autoPlayOption.disabled = true;\r\n            autoPlayOption.setAttribute(\"hidden\", \"\");\r\n        }\r\n\r\n        // Beepbox uses availHeight too, but I have a display that fails the check even when one of the other layouts would look better on it. -jummbus\r\n        if (window.screen.availWidth < 710 /*|| window.screen.availHeight < 710*/) {\r\n            const layoutOption: HTMLOptionElement = <HTMLOptionElement>this._optionsMenu.querySelector(\"[value=layout]\");\r\n            layoutOption.disabled = true;\r\n            layoutOption.setAttribute(\"hidden\", \"\");\r\n        }\r\n    }\r\n\r\n    // !!! Custom functions to adapt the component\r\n    private _deactivate = (e: Event): void => {\r\n        if (!(e.target instanceof HTMLElement)){\r\n            console.error(\"Not HTMLInputElement\");\r\n            return;\r\n        }\r\n\r\n        this._doc.performance.pause();\r\n        this.outVolumeHistoricCap = 0;\r\n    }\r\n    \r\n    private _changeSong = (e: Event): void => {\r\n        if (!(e.target instanceof HTMLInputElement)){\r\n            console.error(\"Not HTMLInputElement\");\r\n            return;\r\n        }\r\n\r\n        const target = e.target as HTMLInputElement;\r\n        const files  = target.files;\r\n        if (files == null){\r\n            console.error(\"Injected Files are null\");\r\n            return;\r\n        }\r\n        var file = files[0]\r\n\r\n        var url = URL.createObjectURL(file)\r\n\r\n\t\tif (url == null){\r\n\t\t\tconsole.error(\"NULL URL\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tfetch(url)\r\n\t\t\t.then(res => res.blob()) // Gets the response and returns it as a blob\r\n\t\t\t.then(blob => {\r\n\r\n\t\t\t\tif (!blob){\r\n\t\t\t\t\tconsole.error(\"NULL Blob from URL\");\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst reader: FileReader = new FileReader();\r\n\t\t\t\treader.addEventListener(\"load\", (event: Event): void => {\r\n                    console.log(this._doc)\r\n\r\n\t\t\t\t\tthis.prompt = null;\r\n\t\t\t\t\tthis._doc.goBackToStart();\r\n\t\t\t\t\tthis._doc._parseMidiFile(<ArrayBuffer>reader.result);\r\n                    this._doc.song.title = file.name.replace(/\\.[^/.]+$/, \"\");\r\n\t\t\t\t});\r\n\t\t\t\treader.readAsArrayBuffer(blob);\r\n\t\t\t});\r\n\t}\r\n\r\n    private _clearSong = (e: Event): void => {\r\n        if (!(e.target instanceof HTMLInputElement)){\r\n            console.error(\"Not HTMLInputElement\");\r\n            return;\r\n        }\r\n\r\n        this._doc.goBackToStart();\r\n        this._doc.song.restoreLimiterDefaults();\r\n        for (const channel of this._doc.song.channels) {\r\n            channel.muted = false;\r\n            channel.name = \"\";\r\n        }\r\n        this._doc.record(new ChangeSong(this._doc, \"\"), false, true);\r\n\t}\r\n\r\n    private _fetchSong = (e: Event): void => {\r\n        console.log(\"!!! fetch\")\r\n        if (!(e.target instanceof HTMLInputElement)){\r\n            console.error(\"Not HTMLInputElement\");\r\n            return;\r\n        }\r\n        const exportedBuffer = this._exportCurrentToMidi(false, false, 1)\r\n        const base64 = SongEditor._arrayBufferToBase64(exportedBuffer)\r\n        e.target.setAttribute(\"track_base64\", base64);\r\n\r\n        // console.log(\"BASE64 generated: \" + base64)\r\n\t}\r\n\r\n    private static _arrayBufferToBase64( buffer: ArrayBuffer ): string {\r\n        var binary = '';\r\n        var bytes = new Uint8Array( buffer );\r\n        var len = bytes.byteLength;\r\n        for (var i = 0; i < len; i++) {\r\n            binary += String.fromCharCode( bytes[ i ] );\r\n        }\r\n        return window.btoa( binary );\r\n    }\r\n\r\n    private lerp(low: number, high: number, t: number): number {\r\n        return low + t * (high - low);\r\n    }\r\n\r\n    private _exportCurrentToMidi(isIntro: Boolean, isOutro: Boolean, loops: Number): ArrayBuffer {\r\n        const song: Song = this._doc.song;\r\n        const midiTicksPerBeepBoxTick: number = 2;\r\n        const midiTicksPerBeat: number = midiTicksPerBeepBoxTick * Config.ticksPerPart * Config.partsPerBeat;\r\n        const midiTicksPerPart: number = midiTicksPerBeepBoxTick * Config.ticksPerPart;\r\n        const secondsPerMinute: number = 60;\r\n        const microsecondsPerMinute: number = secondsPerMinute * 1000000;\r\n        const beatsPerMinute: number = song.getBeatsPerMinute();\r\n        const microsecondsPerBeat: number = Math.round(microsecondsPerMinute / beatsPerMinute);\r\n        //const secondsPerMidiTick: number = secondsPerMinute / (midiTicksPerBeat * beatsPerMinute);\r\n        const midiTicksPerBar: number = midiTicksPerBeat * song.beatsPerBar;\r\n        const pitchBendRange: number = 24;\r\n        const defaultNoteVelocity: number = 90;\r\n\r\n        const unrolledBars: number[] = [];\r\n        if (isIntro) {\r\n            for (let bar: number = 0; bar < song.loopStart; bar++) {\r\n                unrolledBars.push(bar);\r\n            }\r\n        }\r\n        for (let loopIndex: number = 0; loopIndex < Number(loops); loopIndex++) {\r\n            for (let bar: number = song.loopStart; bar < song.loopStart + song.loopLength; bar++) {\r\n                unrolledBars.push(bar);\r\n            }\r\n        }\r\n        if (isOutro) {\r\n            for (let bar: number = song.loopStart + song.loopLength; bar < song.barCount; bar++) {\r\n                unrolledBars.push(bar);\r\n            }\r\n        }\r\n\r\n        const tracks = [{ isMeta: true, channel: -1, midiChannel: -1, isNoise: false, isDrumset: false }];\r\n        let midiChannelCounter: number = 0;\r\n        let foundADrumset: boolean = false;\r\n        for (let channel: number = 0; channel < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount; channel++) {\r\n            if (!foundADrumset && this._doc.song.channels[channel].instruments[0].type == InstrumentType.drumset) {\r\n                tracks.push({ isMeta: false, channel: channel, midiChannel: 9, isNoise: true, isDrumset: true });\r\n                foundADrumset = true; // There can only be one drumset channel, and it's always channel 9 (seen as 10 in most UIs). :/\r\n            } else {\r\n                if (midiChannelCounter >= 16) continue; // The MIDI standard only supports 16 channels.\r\n                tracks.push({ isMeta: false, channel: channel, midiChannel: midiChannelCounter++, isNoise: this._doc.song.getChannelIsNoise(channel), isDrumset: false });\r\n                if (midiChannelCounter == 9) midiChannelCounter++; // skip midi drum channel.\r\n            }\r\n        }\r\n\r\n        const writer: ArrayBufferWriter = new ArrayBufferWriter(1024);\r\n        writer.writeUint32(MidiChunkType.header);\r\n        writer.writeUint32(6); // length of headers is 6 bytes\r\n        writer.writeUint16(MidiFileFormat.simultaneousTracks);\r\n        writer.writeUint16(tracks.length);\r\n        writer.writeUint16(midiTicksPerBeat); // number of \"ticks\" per beat, independent of tempo\r\n\r\n        for (const track of tracks) {\r\n            writer.writeUint32(MidiChunkType.track);\r\n\r\n            const { isMeta, channel, midiChannel, isNoise, isDrumset } = track;\r\n\r\n            // We're gonna come back here and overwrite this placeholder once we know how many bytes this track is.\r\n            const trackStartIndex: number = writer.getWriteIndex();\r\n            writer.writeUint32(0); // placeholder for track size\r\n\r\n            let prevTime: number = 0;\r\n            let barStartTime: number = 0;\r\n            const writeEventTime = function (time: number): void {\r\n                if (time < prevTime) throw new Error(\"Midi event time cannot go backwards.\");\r\n                writer.writeMidiVariableLength(time - prevTime);\r\n                prevTime = time;\r\n            }\r\n\r\n            const writeControlEvent = function (message: MidiControlEventMessage, value: number): void {\r\n                if (!(value >= 0 && value <= 0x7F)) throw new Error(\"Midi control event value out of range: \" + value);\r\n                writer.writeUint8(MidiEventType.controlChange | midiChannel);\r\n                writer.writeMidi7Bits(message);\r\n                writer.writeMidi7Bits(value | 0);\r\n            }\r\n\r\n            if (isMeta) {\r\n                // for first midi track, include tempo, time signature, and key signature information.\r\n\r\n                writeEventTime(0);\r\n                writer.writeUint8(MidiEventType.meta);\r\n                writer.writeMidi7Bits(MidiMetaEventMessage.text);\r\n                writer.writeMidiAscii(\"Composed with jummbus.bitbucket.io\");\r\n\r\n                writeEventTime(0);\r\n                writer.writeUint8(MidiEventType.meta);\r\n                writer.writeMidi7Bits(MidiMetaEventMessage.tempo);\r\n                writer.writeMidiVariableLength(3); // Tempo message length is 3 bytes.\r\n                writer.writeUint24(microsecondsPerBeat); // Tempo in microseconds per \"quarter\" note, commonly known as a \"beat\"\r\n\r\n                writeEventTime(0);\r\n                writer.writeUint8(MidiEventType.meta);\r\n                writer.writeMidi7Bits(MidiMetaEventMessage.timeSignature);\r\n                writer.writeMidiVariableLength(4); // Time signature message length is 4 bytes.\r\n                writer.writeUint8(song.beatsPerBar); // numerator.\r\n                writer.writeUint8(2); // denominator exponent in 2^E. 2^2 = 4, and we will always use \"quarter\" notes.\r\n                writer.writeUint8(24); // MIDI Clocks per metronome tick (should match beats), standard is 24\r\n                writer.writeUint8(8); // number of 1/32 notes per 24 MIDI Clocks, standard is 8, meaning 24 clocks per \"quarter\" note.\r\n\r\n                const isMinor: boolean = Config.scales[song.scale].flags[3] && !Config.scales[song.scale].flags[4];\r\n                const key: number = song.key; // C=0, C#=1, counting up to B=11\r\n                let numSharps: number = key; // For even key values in major scale, number of sharps/flats is same...\r\n                if ((key & 1) == 1) numSharps += 6; // For odd key values (consider circle of fifths) rotate around the circle... kinda... Look conventional key signatures are just weird, okay?\r\n                if (isMinor) numSharps += 9; // A minor A scale has zero sharps, shift it appropriately\r\n                while (numSharps > 6) numSharps -= 12; // Range is (modulo 12) - 5. Midi supports -7 to +7, but I only have 12 options.\r\n\r\n                writeEventTime(0);\r\n                writer.writeUint8(MidiEventType.meta);\r\n                writer.writeMidi7Bits(MidiMetaEventMessage.keySignature);\r\n                writer.writeMidiVariableLength(2); // Key signature message length is 2 bytes.\r\n                writer.writeInt8(numSharps); // See above calculation. Assumes scale is diatonic. :/\r\n                writer.writeUint8(isMinor ? 1 : 0); // 0: major, 1: minor\r\n\r\n                if (isIntro) barStartTime += midiTicksPerBar * song.loopStart;\r\n                writeEventTime(barStartTime);\r\n                writer.writeUint8(MidiEventType.meta);\r\n                writer.writeMidi7Bits(MidiMetaEventMessage.marker);\r\n                writer.writeMidiAscii(\"Loop Start\");\r\n\r\n                for (let loopIndex: number = 0; loopIndex < loops; loopIndex++) {\r\n                    barStartTime += midiTicksPerBar * song.loopLength;\r\n                    writeEventTime(barStartTime);\r\n                    writer.writeUint8(MidiEventType.meta);\r\n                    writer.writeMidi7Bits(MidiMetaEventMessage.marker);\r\n                    writer.writeMidiAscii(loopIndex < Number(loops) - 1 ? \"Loop Repeat\" : \"Loop End\");\r\n                }\r\n\r\n                if (isOutro) barStartTime += midiTicksPerBar * (song.barCount - song.loopStart - song.loopLength);\r\n                if (barStartTime != midiTicksPerBar * unrolledBars.length) throw new Error(\"Miscalculated number of bars.\");\r\n\r\n            } else {\r\n                // For remaining tracks, set up the instruments and write the notes:\r\n\r\n                let channelName: string = isNoise\r\n                    ? \"noise channel \" + channel\r\n                    : \"pitch channel \" + channel;\r\n                writeEventTime(0);\r\n                writer.writeUint8(MidiEventType.meta);\r\n                writer.writeMidi7Bits(MidiMetaEventMessage.trackName);\r\n                writer.writeMidiAscii(channelName);\r\n\r\n                // This sets up pitch bend range. First we choose the pitch bend RPN (which has MSB and LSB components), then we set the value for that RPN (which also has MSB and LSB components) and finally reset the current RPN to null, which is considered best practice.\r\n                writeEventTime(0); writeControlEvent(MidiControlEventMessage.registeredParameterNumberMSB, MidiRegisteredParameterNumberMSB.pitchBendRange);\r\n                writeEventTime(0); writeControlEvent(MidiControlEventMessage.registeredParameterNumberLSB, MidiRegisteredParameterNumberLSB.pitchBendRange);\r\n                writeEventTime(0); writeControlEvent(MidiControlEventMessage.setParameterMSB, pitchBendRange); // pitch bend semitone range\r\n                writeEventTime(0); writeControlEvent(MidiControlEventMessage.setParameterLSB, 0); // pitch bend cent range\r\n                writeEventTime(0); writeControlEvent(MidiControlEventMessage.registeredParameterNumberMSB, MidiRegisteredParameterNumberMSB.reset);\r\n                writeEventTime(0); writeControlEvent(MidiControlEventMessage.registeredParameterNumberLSB, MidiRegisteredParameterNumberLSB.reset);\r\n\r\n                let prevInstrumentIndex: number = -1;\r\n                function writeInstrumentSettings(instrumentIndex: number): void {\r\n                    const instrument: Instrument = song.channels[channel].instruments[instrumentIndex];\r\n                    const preset: Preset | null = EditorConfig.valueToPreset(instrument.preset);\r\n\r\n                    if (prevInstrumentIndex != instrumentIndex) {\r\n                        prevInstrumentIndex = instrumentIndex;\r\n                        writeEventTime(barStartTime);\r\n                        writer.writeUint8(MidiEventType.meta);\r\n                        writer.writeMidi7Bits(MidiMetaEventMessage.instrumentName);\r\n                        writer.writeMidiAscii(\"Instrument \" + (instrumentIndex + 1));\r\n\r\n                        if (!isDrumset) {\r\n                            let instrumentProgram: number = 81; // default to sawtooth wave. \r\n\r\n                            if (preset != null && preset.midiProgram != undefined) {\r\n                                instrumentProgram = preset.midiProgram;\r\n                            } else if (instrument.type == InstrumentType.drumset) {\r\n                                // The first BeepBox drumset channel is handled as a Midi drumset channel and doesn't need a program, but any subsequent drumsets will just be set to taiko.\r\n                                instrumentProgram = 116; // taiko\r\n                            } else {\r\n                                if (instrument.type == InstrumentType.noise || instrument.type == InstrumentType.spectrum) {\r\n                                    if (isNoise) {\r\n                                        instrumentProgram = 116; // taiko\r\n                                    } else {\r\n                                        instrumentProgram = 75; // pan flute\r\n                                    }\r\n                                } else if (instrument.type == InstrumentType.chip) {\r\n                                    if (ExportPrompt.midiChipInstruments.length > instrument.chipWave) {\r\n                                        instrumentProgram = ExportPrompt.midiChipInstruments[instrument.chipWave];\r\n                                    }\r\n                                } else if (instrument.type == InstrumentType.pwm || instrument.type == InstrumentType.fm || instrument.type == InstrumentType.harmonics) {\r\n                                    instrumentProgram = 81; // sawtooth\r\n                                } else if (instrument.type == InstrumentType.pickedString) {\r\n                                    instrumentProgram = 0x19; // steel guitar\r\n                                } else if (instrument.type == InstrumentType.customChipWave) {\r\n                                    instrumentProgram = 81; // sawtooth\r\n                                } else {\r\n                                    throw new Error(\"Unrecognized instrument type.\");\r\n                                }\r\n                            }\r\n\r\n                            // Program (instrument) change event:\r\n                            writeEventTime(barStartTime);\r\n                            writer.writeUint8(MidiEventType.programChange | midiChannel);\r\n                            writer.writeMidi7Bits(instrumentProgram);\r\n                        }\r\n\r\n                        // Instrument volume:\r\n                        writeEventTime(barStartTime);\r\n                        let instrumentVolume: number = volumeMultToMidiVolume(Synth.instrumentVolumeToVolumeMult(instrument.volume));\r\n                        writeControlEvent(MidiControlEventMessage.volumeMSB, Math.min(0x7f, Math.round(instrumentVolume)));\r\n\r\n                        // Instrument pan:\r\n                        writeEventTime(barStartTime);\r\n                        let instrumentPan: number = (instrument.pan / Config.panCenter - 1) * 0x3f + 0x40;\r\n                        writeControlEvent(MidiControlEventMessage.panMSB, Math.min(0x7f, Math.round(instrumentPan)));\r\n                    }\r\n                }\r\n                if (song.getPattern(channel, 0) == null) {\r\n                    // Go ahead and apply the instrument settings at the beginning of the channel\r\n                    // even if a bar doesn't kick in until later.\r\n                    writeInstrumentSettings(0);\r\n                }\r\n\r\n                let prevPitchBend: number = defaultMidiPitchBend;\r\n                let prevExpression: number = defaultMidiExpression;\r\n                let shouldResetExpressionAndPitchBend: boolean = false;\r\n                //let prevTremolo: number = -1;\r\n                const channelRoot: number = isNoise ? Config.spectrumBasePitch : Config.keys[song.key].basePitch;\r\n                const intervalScale: number = isNoise ? Config.noiseInterval : 1;\r\n\r\n                for (const bar of unrolledBars) {\r\n                    const pattern: Pattern | null = song.getPattern(channel, bar);\r\n\r\n                    if (pattern != null) {\r\n\r\n                        const instrumentIndex: number = pattern.instruments[0]; // Don't bother trying to export multiple instruments per pattern to midi, just pick the first one.\r\n                        const instrument: Instrument = song.channels[channel].instruments[instrumentIndex];\r\n                        const preset: Preset | null = EditorConfig.valueToPreset(instrument.preset);\r\n                        writeInstrumentSettings(instrumentIndex);\r\n\r\n                        let usesArpeggio: boolean = instrument.getChord().arpeggiates;\r\n                        let polyphony: number = usesArpeggio ? 1 : Config.maxChordSize;\r\n                        if (instrument.getChord().customInterval) {\r\n                            if (instrument.type == InstrumentType.chip || instrument.type == InstrumentType.harmonics) {\r\n                                polyphony = 2;\r\n                                usesArpeggio = true;\r\n                            } else if (instrument.type == InstrumentType.fm) {\r\n                                polyphony = Config.operatorCount;\r\n                            } else {\r\n                                console.error(\"Unrecognized instrument type for harmonizing arpeggio: \" + instrument.type);\r\n                            }\r\n                        }\r\n\r\n                        for (let noteIndex: number = 0; noteIndex < pattern.notes.length; noteIndex++) {\r\n                            const note: Note = pattern.notes[noteIndex];\r\n\r\n                            const noteStartTime: number = barStartTime + note.start * midiTicksPerPart;\r\n                            let pinTime: number = noteStartTime;\r\n                            let pinSize: number = note.pins[0].size;\r\n                            let pinInterval: number = note.pins[0].interval;\r\n                            const prevPitches: number[] = [-1, -1, -1, -1];\r\n                            const nextPitches: number[] = [-1, -1, -1, -1];\r\n                            const toneCount: number = Math.min(polyphony, note.pitches.length);\r\n                            const velocity: number = isDrumset ? Math.max(1, Math.round(defaultNoteVelocity * note.pins[0].size / Config.noteSizeMax)) : defaultNoteVelocity;\r\n\r\n                            // The maximum midi pitch bend range is +/- 24 semitones from the base pitch. \r\n                            // To make the most of this, choose a base pitch that is within 24 semitones from as much of the note as possible.\r\n                            // This may involve offsetting this base pitch from BeepBox's note pitch.\r\n                            let mainInterval: number = note.pickMainInterval();\r\n                            let pitchOffset: number = mainInterval * intervalScale;\r\n                            if (!isDrumset) {\r\n                                let maxPitchOffset: number = pitchBendRange;\r\n                                let minPitchOffset: number = -pitchBendRange;\r\n                                for (let pinIndex: number = 1; pinIndex < note.pins.length; pinIndex++) {\r\n                                    const interval = note.pins[pinIndex].interval * intervalScale;\r\n                                    maxPitchOffset = Math.min(maxPitchOffset, interval + pitchBendRange);\r\n                                    minPitchOffset = Math.max(minPitchOffset, interval - pitchBendRange);\r\n                                }\r\n                                /*\r\n                                // I'd like to be able to use pitch bend to implement arpeggio, but the \"custom inverval\" setting in chip instruments combines arpeggio in one tone with another flat tone, and midi can't selectively apply arpeggio to one out of two simultaneous tones. Also it would be hard to reimport. :/\r\n                                if (usesArpeggio && note.pitches.length > polyphony) {\r\n                                    let lowestArpeggioOffset: number = 0;\r\n                                    let highestArpeggioOffset: number = 0;\r\n                                    const basePitch: number = note.pitches[toneCount - 1];\r\n                                    for (let pitchIndex: number = toneCount; pitchIndex < note.pitches.length; pitchIndex++) {\r\n                                        lowestArpeggioOffset = Math.min(note.pitches[pitchIndex] - basePitch);\r\n                                        highestArpeggioOffset = Math.max(note.pitches[pitchIndex] - basePitch);\r\n                                    }\r\n                                    maxPitchOffset -= lowestArpeggioOffset;\r\n                                    minPitchOffset += lowestArpeggioOffset;\r\n                                }\r\n                                */\r\n                                pitchOffset = Math.min(maxPitchOffset, Math.max(minPitchOffset, pitchOffset));\r\n                            }\r\n\r\n                            for (let pinIndex: number = 1; pinIndex < note.pins.length; pinIndex++) {\r\n                                const nextPinTime: number = noteStartTime + note.pins[pinIndex].time * midiTicksPerPart;\r\n                                const nextPinSize: number = note.pins[pinIndex].size;\r\n                                const nextPinInterval: number = note.pins[pinIndex].interval;\r\n\r\n                                const length: number = nextPinTime - pinTime;\r\n                                for (let midiTick: number = 0; midiTick < length; midiTick++) {\r\n                                    const midiTickTime: number = pinTime + midiTick;\r\n                                    const linearSize: number = this.lerp(pinSize, nextPinSize, midiTick / length);\r\n                                    const linearInterval: number = this.lerp(pinInterval, nextPinInterval, midiTick / length);\r\n\r\n                                    const interval: number = linearInterval * intervalScale - pitchOffset;\r\n\r\n                                    const pitchBend: number = Math.max(0, Math.min(0x3fff, Math.round(0x2000 * (1.0 + interval / pitchBendRange))));\r\n\r\n                                    const expression: number = Math.min(0x7f, Math.round(volumeMultToMidiExpression(Synth.noteSizeToVolumeMult(linearSize))));\r\n\r\n                                    if (pitchBend != prevPitchBend) {\r\n                                        writeEventTime(midiTickTime);\r\n                                        writer.writeUint8(MidiEventType.pitchBend | midiChannel);\r\n                                        writer.writeMidi7Bits(pitchBend & 0x7f); // least significant bits\r\n                                        writer.writeMidi7Bits((pitchBend >> 7) & 0x7f); // most significant bits\r\n                                        prevPitchBend = pitchBend;\r\n                                    }\r\n\r\n                                    if (expression != prevExpression && !isDrumset) {\r\n                                        writeEventTime(midiTickTime);\r\n                                        writeControlEvent(MidiControlEventMessage.expressionMSB, expression);\r\n                                        prevExpression = expression;\r\n                                    }\r\n\r\n                                    const noteStarting: boolean = midiTickTime == noteStartTime;\r\n                                    for (let toneIndex: number = 0; toneIndex < toneCount; toneIndex++) {\r\n                                        let nextPitch: number = note.pitches[toneIndex];\r\n                                        if (isDrumset) {\r\n                                            nextPitch += mainInterval;\r\n                                            const drumsetMap: number[] = [\r\n                                                36, // Bass Drum 1\r\n                                                41, // Low Floor Tom\r\n                                                45, // Low Tom\r\n                                                48, // Hi-Mid Tom\r\n                                                40, // Electric Snare\r\n                                                39, // Hand Clap\r\n                                                59, // Ride Cymbal 2\r\n                                                49, // Crash Cymbal 1\r\n                                                46, // Open Hi-Hat\r\n                                                55, // Splash Cymbal\r\n                                                69, // Cabasa\r\n                                                54, // Tambourine\r\n                                            ];\r\n                                            if (nextPitch < 0 || nextPitch >= drumsetMap.length) throw new Error(\"Could not find corresponding drumset pitch. \" + nextPitch);\r\n                                            nextPitch = drumsetMap[nextPitch];\r\n                                        } else {\r\n                                            if (usesArpeggio && note.pitches.length > toneIndex + 1 && toneIndex == toneCount - 1) {\r\n                                                const midiTicksSinceBeat = (midiTickTime - barStartTime) % midiTicksPerBeat;\r\n                                                const midiTicksPerArpeggio = Config.ticksPerArpeggio * midiTicksPerPart / Config.ticksPerPart;\r\n                                                const arpeggio: number = Math.floor(midiTicksSinceBeat / midiTicksPerArpeggio);\r\n                                                nextPitch = note.pitches[toneIndex + getArpeggioPitchIndex(note.pitches.length - toneIndex, instrument.fastTwoNoteArp, arpeggio)];\r\n                                            }\r\n                                            nextPitch = channelRoot + nextPitch * intervalScale + pitchOffset;\r\n                                            if (preset != null && preset.midiSubharmonicOctaves != undefined) {\r\n                                                nextPitch += 12 * preset.midiSubharmonicOctaves;\r\n                                            } else if (isNoise) {\r\n                                                nextPitch += 12 * (+EditorConfig.presetCategories.dictionary[\"Drum Presets\"].presets.dictionary[\"taiko drum\"].midiSubharmonicOctaves!);\r\n                                            }\r\n\r\n                                            if (isNoise) nextPitch *= 2;\r\n                                        }\r\n                                        nextPitch = Math.max(0, Math.min(127, nextPitch));\r\n                                        nextPitches[toneIndex] = nextPitch;\r\n\r\n                                        if (!noteStarting && prevPitches[toneIndex] != nextPitches[toneIndex]) {\r\n                                            writeEventTime(midiTickTime);\r\n                                            writer.writeUint8(MidiEventType.noteOff | midiChannel);\r\n                                            writer.writeMidi7Bits(prevPitches[toneIndex]); // old pitch\r\n                                            writer.writeMidi7Bits(velocity); // velocity\r\n                                        }\r\n                                    }\r\n\r\n                                    for (let toneIndex: number = 0; toneIndex < toneCount; toneIndex++) {\r\n                                        if (noteStarting || prevPitches[toneIndex] != nextPitches[toneIndex]) {\r\n                                            writeEventTime(midiTickTime);\r\n                                            writer.writeUint8(MidiEventType.noteOn | midiChannel);\r\n                                            writer.writeMidi7Bits(nextPitches[toneIndex]); // new pitch\r\n                                            writer.writeMidi7Bits(velocity); // velocity\r\n                                            prevPitches[toneIndex] = nextPitches[toneIndex];\r\n                                        }\r\n                                    }\r\n                                }\r\n\r\n                                pinTime = nextPinTime;\r\n                                pinSize = nextPinSize;\r\n                                pinInterval = nextPinInterval;\r\n                            }\r\n\r\n\t\t\t\t\t\t\tconst noteEndTime: number = barStartTime + note.end * midiTicksPerPart;\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t// End all tones.\r\n\t\t\t\t\t\t\tfor (let toneIndex: number = 0; toneIndex < toneCount; toneIndex++) {\r\n\t\t\t\t\t\t\t\t// TODO: If the note at the start of the next pattern has\r\n\t\t\t\t\t\t\t\t// continuesLastPattern and has the same chord, it ought to extend\r\n\t\t\t\t\t\t\t\t// this previous note.\r\n\t\t\t\t\t\t\t\twriteEventTime(noteEndTime);\r\n\t\t\t\t\t\t\t\twriter.writeUint8(MidiEventType.noteOff | midiChannel);\r\n\t\t\t\t\t\t\t\twriter.writeMidi7Bits(prevPitches[toneIndex]); // pitch\r\n\t\t\t\t\t\t\t\twriter.writeMidi7Bits(velocity); // velocity\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tshouldResetExpressionAndPitchBend = true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tif (shouldResetExpressionAndPitchBend) {\r\n\t\t\t\t\t\t\tshouldResetExpressionAndPitchBend = false;\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif (prevExpression != defaultMidiExpression) {\r\n\t\t\t\t\t\t\t\tprevExpression = defaultMidiExpression;\r\n\t\t\t\t\t\t\t\t// Reset expression\r\n\t\t\t\t\t\t\t\twriteEventTime(barStartTime);\r\n\t\t\t\t\t\t\t\twriteControlEvent(MidiControlEventMessage.expressionMSB, prevExpression);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif (prevPitchBend != defaultMidiPitchBend) {\r\n\t\t\t\t\t\t\t\t// Reset pitch bend\r\n\t\t\t\t\t\t\t\tprevPitchBend = defaultMidiPitchBend;\r\n\t\t\t\t\t\t\t\twriteEventTime(barStartTime);\r\n\t\t\t\t\t\t\t\twriter.writeUint8(MidiEventType.pitchBend | midiChannel);\r\n\t\t\t\t\t\t\t\twriter.writeMidi7Bits(prevPitchBend & 0x7f); // least significant bits\r\n\t\t\t\t\t\t\t\twriter.writeMidi7Bits((prevPitchBend >> 7) & 0x7f); // most significant bits\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tbarStartTime += midiTicksPerBar;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\twriteEventTime(barStartTime);\r\n\t\t\twriter.writeUint8(MidiEventType.meta);\r\n\t\t\twriter.writeMidi7Bits(MidiMetaEventMessage.endOfTrack);\r\n\t\t\twriter.writeMidiVariableLength(0x00);\r\n\t\t\t\r\n\t\t\t// Finally, write the length of the track in bytes at the front of the track.\r\n\t\t\twriter.rewriteUint32(trackStartIndex, writer.getWriteIndex() - trackStartIndex - 4);\r\n\t\t}\r\n\t\t\r\n\t\tconst blob: Blob = new Blob([writer.toCompactArrayBuffer()], {type: \"audio/midi\"});\r\n        console.log(\"SOME TEST !!!! \" + SongEditor._arrayBufferToBase64(writer.toCompactArrayBuffer()))\r\n\r\n\t\t// this.save(blob, \"test\" + \".mid\");\r\n        return writer.toCompactArrayBuffer();\r\n    }\r\n\r\n    private save(blob: Blob, name: string): void {\r\n        if ((<any>navigator).msSaveOrOpenBlob) {\r\n            (<any>navigator).msSaveOrOpenBlob(blob, name);\r\n            return;\r\n        }\r\n    \r\n        const anchor: HTMLAnchorElement = document.createElement(\"a\");\r\n        if (anchor.download != undefined) {\r\n            const url: string = URL.createObjectURL(blob);\r\n            setTimeout(function () { URL.revokeObjectURL(url); }, 60000);\r\n            anchor.href = url;\r\n            anchor.download = name;\r\n            // Chrome bug regression: We need to delay dispatching the click\r\n            // event. Seems to be related to going back in the browser history.\r\n            // https://bugs.chromium.org/p/chromium/issues/detail?id=825100\r\n            setTimeout(function () { anchor.dispatchEvent(new MouseEvent(\"click\")); }, 0);\r\n        } else {\r\n            const url: string = URL.createObjectURL(blob);\r\n            setTimeout(function () { URL.revokeObjectURL(url); }, 60000);\r\n            // if (!window.open(url, \"_blank\")) window.location.href = url;\r\n        }\r\n    }\r\n\r\n    private _toggleDropdownMenu(dropdown: DropdownID, submenu: number = 0): void {\r\n        let target: HTMLButtonElement = this._vibratoDropdown;\r\n        let group: HTMLElement = this._vibratoDropdownGroup;\r\n        switch (dropdown) {\r\n            case DropdownID.Vibrato:\r\n                target = this._vibratoDropdown;\r\n                this._openVibratoDropdown = this._openVibratoDropdown ? false : true;\r\n                group = this._vibratoDropdownGroup;\r\n                break;\r\n            case DropdownID.Pan:\r\n                target = this._panDropdown;\r\n                this._openPanDropdown = this._openPanDropdown ? false : true;\r\n                group = this._panDropdownGroup;\r\n                break;\r\n            case DropdownID.Chord:\r\n                target = this._chordDropdown;\r\n                this._openChordDropdown = this._openChordDropdown ? false : true;\r\n                group = this._chordDropdownGroup;\r\n                break;\r\n            case DropdownID.Transition:\r\n                target = this._transitionDropdown;\r\n                this._openTransitionDropdown = this._openTransitionDropdown ? false : true;\r\n                group = this._transitionDropdownGroup;\r\n                break;\r\n            case DropdownID.FM:\r\n                target = this._operatorDropdowns[submenu];\r\n                this._openOperatorDropdowns[submenu] = this._openOperatorDropdowns[submenu] ? false : true;\r\n                group = this._operatorDropdownGroups[submenu];\r\n                break;\r\n        }\r\n\r\n        if (target.textContent == \"▼\") {\r\n            let instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n            target.textContent = \"▲\";\r\n            if (group != this._chordDropdownGroup) {\r\n                group.style.display = \"\";\r\n            } // Only show arpeggio dropdown if chord arpeggiates\r\n            else if (instrument.chord == Config.chords.dictionary[\"arpeggio\"].index) {\r\n                group.style.display = \"\";\r\n            }\r\n\r\n        }\r\n        else {\r\n            target.textContent = \"▼\";\r\n            group.style.display = \"none\";\r\n        }\r\n    }\r\n\r\n    private _modSliderUpdate(): void {\r\n\r\n        if (!this._doc.synth.playing) {\r\n            this._hasActiveModSliders = false;\r\n\r\n            for (let setting: number = 0; setting < Config.modulators.length; setting++) {\r\n                if (this._showModSliders[setting] == true) {\r\n                    this._showModSliders[setting] = false;\r\n                    this._newShowModSliders[setting] = false;\r\n                    let slider: Slider | null = this._getSliderForModSetting(setting);\r\n\r\n                    if (slider != null) {\r\n                        slider.container.classList.remove(\"modSlider\");\r\n\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        else {\r\n\r\n            let instrument: number = this._doc.getCurrentInstrument();\r\n            const anyModActive: boolean = this._doc.synth.isAnyModActive(this._doc.channel, instrument);\r\n\r\n            // Check and update mod values on sliders\r\n            if (anyModActive) {\r\n\r\n                let instrument: number = this._doc.getCurrentInstrument();\r\n\r\n                function updateModSlider(editor: SongEditor, slider: Slider, setting: number, channel: number, instrument: number): boolean {\r\n                    if (editor._doc.synth.isModActive(setting, channel, instrument)) {\r\n                        let currentVal: number = (editor._doc.synth.getModValue(setting, channel, instrument, false) - Config.modulators[setting].convertRealFactor) / Config.modulators[setting].maxRawVol;\r\n                        if (currentVal != editor._modSliderValues[setting]) {\r\n                            editor._modSliderValues[setting] = currentVal;\r\n                            slider.container.style.setProperty(\"--mod-position\", (currentVal * 96.0 + 2.0) + \"%\");\r\n                        }\r\n                        return true;\r\n                    }\r\n                    return false;\r\n                }\r\n\r\n                // Set mod sliders to present values\r\n                for (let setting: number = 0; setting < Config.modulators.length; setting++) {\r\n                    // Set to last value\r\n                    this._newShowModSliders[setting] = this._showModSliders[setting];\r\n\r\n                    // Check for newer value\r\n                    let slider: Slider | null = this._getSliderForModSetting(setting);\r\n                    if (slider != null) {\r\n                        this._newShowModSliders[setting] = updateModSlider(this, slider, setting, this._doc.channel, instrument);\r\n                    }\r\n                }\r\n\r\n            }\r\n            else if (this._hasActiveModSliders) {\r\n                // Zero out show-mod-slider settings (since none are active) to kill active mod slider flag\r\n                for (let setting: number = 0; setting < Config.modulators.length; setting++) {\r\n                    this._newShowModSliders[setting] = false;\r\n                }\r\n            }\r\n\r\n            // Class or unclass mod sliders based on present status\r\n            if (anyModActive || this._hasActiveModSliders) {\r\n\r\n                let anySliderActive: boolean = false;\r\n\r\n                for (let setting: number = 0; setting < Config.modulators.length; setting++) {\r\n                    if (this._newShowModSliders[setting] != this._showModSliders[setting]) {\r\n                        this._showModSliders[setting] = this._newShowModSliders[setting];\r\n                        let slider: Slider | null = this._getSliderForModSetting(setting);\r\n\r\n                        if (slider != null) {\r\n\r\n                            if (this._showModSliders[setting] == true) {\r\n                                slider.container.classList.add(\"modSlider\");\r\n                            }\r\n                            else {\r\n                                slider.container.classList.remove(\"modSlider\");\r\n                            }\r\n\r\n                        }\r\n                    }\r\n\r\n                    if (this._newShowModSliders[setting] == true)\r\n                        anySliderActive = true;\r\n                }\r\n\r\n                this._hasActiveModSliders = anySliderActive;\r\n\r\n            }\r\n\r\n        }\r\n\r\n    }\r\n\r\n    private _getSliderForModSetting(setting: number): Slider | null {\r\n        switch (setting) {\r\n            case Config.modulators.dictionary[\"pan\"].index:\r\n                return this._panSlider;\r\n            case Config.modulators.dictionary[\"detune\"].index:\r\n                return this._detuneSlider;\r\n            case Config.modulators.dictionary[\"fm slider 1\"].index:\r\n                return this._operatorAmplitudeSliders[0];\r\n            case Config.modulators.dictionary[\"fm slider 2\"].index:\r\n                return this._operatorAmplitudeSliders[1];\r\n            case Config.modulators.dictionary[\"fm slider 3\"].index:\r\n                return this._operatorAmplitudeSliders[2];\r\n            case Config.modulators.dictionary[\"fm slider 4\"].index:\r\n                return this._operatorAmplitudeSliders[3];\r\n            case Config.modulators.dictionary[\"fm feedback\"].index:\r\n                return this._feedbackAmplitudeSlider;\r\n            case Config.modulators.dictionary[\"pulse width\"].index:\r\n                return this._pulseWidthSlider;\r\n            case Config.modulators.dictionary[\"reverb\"].index:\r\n                return this._reverbSlider;\r\n            case Config.modulators.dictionary[\"distortion\"].index:\r\n                return this._distortionSlider;\r\n            case Config.modulators.dictionary[\"note volume\"].index:\r\n                // So, this should technically not affect this slider, but it will look better as legacy songs used this mod as 'volume'.\r\n                // In the case that mix volume is used as well, they'd fight for the display, so just don't use this.\r\n                if (!this._showModSliders[Config.modulators.dictionary[\"mix volume\"].index])\r\n                    return this._instrumentVolumeSlider;\r\n                return null;\r\n            case Config.modulators.dictionary[\"mix volume\"].index:\r\n                return this._instrumentVolumeSlider;\r\n            case Config.modulators.dictionary[\"vibrato depth\"].index:\r\n                return this._vibratoDepthSlider;\r\n            case Config.modulators.dictionary[\"vibrato speed\"].index:\r\n                return this._vibratoSpeedSlider;\r\n            case Config.modulators.dictionary[\"vibrato delay\"].index:\r\n                return this._vibratoDelaySlider;\r\n            case Config.modulators.dictionary[\"arp speed\"].index:\r\n                return this._arpeggioSpeedSlider;\r\n            case Config.modulators.dictionary[\"pan delay\"].index:\r\n                return this._panDelaySlider;\r\n            case Config.modulators.dictionary[\"tempo\"].index:\r\n                return this._tempoSlider;\r\n            case Config.modulators.dictionary[\"song volume\"].index:\r\n                return this._volumeSlider;\r\n            case Config.modulators.dictionary[\"eq filt cut\"].index:\r\n                return this._eqFilterSimpleCutSlider;\r\n            case Config.modulators.dictionary[\"eq filt peak\"].index:\r\n                return this._eqFilterSimplePeakSlider;\r\n            case Config.modulators.dictionary[\"note filt cut\"].index:\r\n                return this._noteFilterSimpleCutSlider;\r\n            case Config.modulators.dictionary[\"note filt peak\"].index:\r\n                return this._noteFilterSimplePeakSlider;\r\n            case Config.modulators.dictionary[\"bit crush\"].index:\r\n                return this._bitcrusherQuantizationSlider;\r\n            case Config.modulators.dictionary[\"freq crush\"].index:\r\n                return this._bitcrusherFreqSlider;\r\n            case Config.modulators.dictionary[\"pitch shift\"].index:\r\n                return this._pitchShiftSlider;\r\n            case Config.modulators.dictionary[\"chorus\"].index:\r\n                return this._chorusSlider;\r\n            case Config.modulators.dictionary[\"echo\"].index:\r\n                return this._echoSustainSlider;\r\n            case Config.modulators.dictionary[\"echo delay\"].index:\r\n                return this._echoDelaySlider;\r\n            case Config.modulators.dictionary[\"sustain\"].index:\r\n                return this._stringSustainSlider;\r\n            default:\r\n                return null;\r\n        }\r\n\r\n    }\r\n\r\n    private _openPrompt(promptName: string): void {\r\n        this._doc.openPrompt(promptName);\r\n        this._setPrompt(promptName);\r\n    }\r\n\r\n    private _setPrompt(promptName: string | null): void {\r\n        if (this._currentPromptName == promptName) return;\r\n        this._currentPromptName = promptName;\r\n\r\n        if (this.prompt) {\r\n            if (this._wasPlaying && !(this.prompt instanceof TipPrompt || this.prompt instanceof LimiterPrompt || this.prompt instanceof CustomChipPrompt || this.prompt instanceof CustomFilterPrompt)) {\r\n                this._doc.performance.play();\r\n            }\r\n            this._wasPlaying = false;\r\n            this._promptContainer.style.display = \"none\";\r\n            this._promptContainer.removeChild(this.prompt.container);\r\n            this.prompt.cleanUp();\r\n            this.prompt = null;\r\n            this.refocusStage();\r\n        }\r\n\r\n        if (promptName) {\r\n            switch (promptName) {\r\n                case \"export\":\r\n                    this.prompt = new ExportPrompt(this._doc);\r\n                    break;\r\n                case \"import\":\r\n                    this.prompt = new ImportPrompt(this._doc);\r\n                    break;\r\n                case \"songRecovery\":\r\n                    this.prompt = new SongRecoveryPrompt(this._doc);\r\n                    break;\r\n                case \"barCount\":\r\n                    this.prompt = new SongDurationPrompt(this._doc);\r\n                    break;\r\n                case \"beatsPerBar\":\r\n                    this.prompt = new BeatsPerBarPrompt(this._doc);\r\n                    break;\r\n                case \"moveNotesSideways\":\r\n                    this.prompt = new MoveNotesSidewaysPrompt(this._doc);\r\n                    break;\r\n                case \"channelSettings\":\r\n                    this.prompt = new ChannelSettingsPrompt(this._doc);\r\n                    break;\r\n                case \"limiterSettings\":\r\n                    this.prompt = new LimiterPrompt(this._doc, this);\r\n                    break;\r\n                case \"customChipSettings\":\r\n                    this.prompt = new CustomChipPrompt(this._doc, this);\r\n                    break;\r\n                case \"customEQFilterSettings\":\r\n                    this.prompt = new CustomFilterPrompt(this._doc, this, false);\r\n                    break;\r\n                case \"customNoteFilterSettings\":\r\n                    this.prompt = new CustomFilterPrompt(this._doc, this, true);\r\n                    break;\r\n                case \"theme\":\r\n                    this.prompt = new ThemePrompt(this._doc);\r\n                    break;\r\n                case \"layout\":\r\n                    this.prompt = new LayoutPrompt(this._doc);\r\n                    break;\r\n                case \"recordingSetup\":\r\n                    this.prompt = new RecordingSetupPrompt(this._doc);\r\n                    break;\r\n                default:\r\n                    this.prompt = new TipPrompt(this._doc, promptName);\r\n                    break;\r\n            }\r\n\r\n            if (this.prompt) {\r\n                if (!(this.prompt instanceof TipPrompt || this.prompt instanceof LimiterPrompt || this.prompt instanceof CustomChipPrompt || this.prompt instanceof CustomFilterPrompt)) {\r\n                    this._wasPlaying = this._doc.synth.playing;\r\n                    this._doc.performance.pause();\r\n                }\r\n                this._promptContainer.style.display = \"\";\r\n                this._promptContainer.appendChild(this.prompt.container);\r\n            }\r\n        }\r\n    }\r\n\r\n    public refocusStage = (): void => {\r\n        this.mainLayer.focus({ preventScroll: true });\r\n    }\r\n\r\n    private _onFocusIn = (event: Event): void => {\r\n        if (this._doc.synth.recording && event.target != this.mainLayer && event.target != this._stopButton && event.target != this._volumeSlider.input) {\r\n            // Don't allow using tab to focus on the song settings while recording,\r\n            // since interacting with them while recording would mess up the recording.\r\n            this.refocusStage();\r\n        }\r\n    }\r\n\r\n    // Refocus stage if a sub-element that needs focus isn't being edited.\r\n    private _refocusStageNotEditing = (): void => {\r\n        if (!this._patternEditor.editingModLabel)\r\n            this.mainLayer.focus({ preventScroll: true });\r\n    }\r\n\r\n    public changeBarScrollPos(offset: number) {\r\n        this._barScrollBar.changePos(offset);\r\n    }\r\n\r\n    public whenUpdated = (): void => {\r\n        const prefs: Preferences = this._doc.prefs;\r\n        this._muteEditor.container.style.display = prefs.enableChannelMuting ? \"\" : \"none\";\r\n        const trackBounds: DOMRect = this._trackVisibleArea.getBoundingClientRect();\r\n        this._doc.trackVisibleBars = Math.floor((trackBounds.right - trackBounds.left - (prefs.enableChannelMuting ? 32 : 0)) / this._doc.getBarWidth());\r\n        this._doc.trackVisibleChannels = Math.floor((trackBounds.bottom - trackBounds.top - 30) / this._doc.getChannelHeight());\r\n        for (let i: number = this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount; i < this._doc.song.channels.length; i++) {\r\n            const channel: Channel = this._doc.song.channels[i];\r\n            for (let j: number = 0; j < channel.instruments.length; j++) {\r\n                this._doc.synth.determineInvalidModulators(channel.instruments[j]);\r\n            }\r\n        }\r\n        this._barScrollBar.render();\r\n        this._muteEditor.render();\r\n        this._trackEditor.render();\r\n\r\n        if (document.activeElement != this._patternEditor.modDragValueLabel && this._patternEditor.editingModLabel) {\r\n            this._patternEditor.stopEditingModLabel(false);\r\n        }\r\n\r\n        this._piano.container.style.display = prefs.showLetters ? \"\" : \"none\";\r\n        this._octaveScrollBar.container.style.display = prefs.showScrollBar ? \"\" : \"none\";\r\n        this._barScrollBar.container.style.display = this._doc.song.barCount > this._doc.trackVisibleBars ? \"\" : \"none\";\r\n        this._volumeBarBox.style.display = this._doc.prefs.displayVolumeBar ? \"\" : \"none\";\r\n\r\n        if (this._doc.getFullScreen()) {\r\n            const semitoneHeight: number = this._patternEditorRow.clientHeight / this._doc.getVisiblePitchCount();\r\n            const targetBeatWidth: number = semitoneHeight * 5;\r\n            const minBeatWidth: number = this._patternEditorRow.clientWidth / (this._doc.song.beatsPerBar * 3);\r\n            const maxBeatWidth: number = this._patternEditorRow.clientWidth / (this._doc.song.beatsPerBar + 2);\r\n            const beatWidth: number = Math.max(minBeatWidth, Math.min(maxBeatWidth, targetBeatWidth));\r\n            const patternEditorWidth: number = beatWidth * this._doc.song.beatsPerBar;\r\n\r\n            this._patternEditorPrev.container.style.width = patternEditorWidth + \"px\";\r\n            this._patternEditor.container.style.width = patternEditorWidth + \"px\";\r\n            this._patternEditorNext.container.style.width = patternEditorWidth + \"px\";\r\n            this._patternEditorPrev.container.style.flexShrink = \"0\";\r\n            this._patternEditor.container.style.flexShrink = \"0\";\r\n            this._patternEditorNext.container.style.flexShrink = \"0\";\r\n            this._patternEditorPrev.container.style.display = \"\";\r\n            this._patternEditorNext.container.style.display = \"\";\r\n            this._patternEditorPrev.render();\r\n            this._patternEditorNext.render();\r\n            this._zoomInButton.style.display = (this._doc.channel < this._doc.song.pitchChannelCount) ? \"\" : \"none\";\r\n            this._zoomOutButton.style.display = (this._doc.channel < this._doc.song.pitchChannelCount) ? \"\" : \"none\";\r\n            this._zoomInButton.style.right = prefs.showScrollBar ? \"24px\" : \"4px\";\r\n            this._zoomOutButton.style.right = prefs.showScrollBar ? \"24px\" : \"4px\";\r\n        } else {\r\n            this._patternEditor.container.style.width = \"\";\r\n            this._patternEditor.container.style.flexShrink = \"\";\r\n            this._patternEditorPrev.container.style.display = \"none\";\r\n            this._patternEditorNext.container.style.display = \"none\";\r\n            this._zoomInButton.style.display = \"none\";\r\n            this._zoomOutButton.style.display = \"none\";\r\n        }\r\n        this._patternEditor.render();\r\n\r\n        const optionCommands: ReadonlyArray<string> = [\r\n            (prefs.autoPlay ? \"✓ \" : \"　\") + \"Auto Play on Load\",\r\n            (prefs.autoFollow ? \"✓ \" : \"　\") + \"Keep Current Pattern Selected\",\r\n            (prefs.enableNotePreview ? \"✓ \" : \"　\") + \"Hear Preview of Added Notes\",\r\n            (prefs.showLetters ? \"✓ \" : \"　\") + \"Show Piano Keys\",\r\n            (prefs.showFifth ? \"✓ \" : \"　\") + 'Highlight \"Fifth\" of Song Key',\r\n            (prefs.notesOutsideScale ? \"✓ \" : \"　\") + \"Allow Adding Notes Not in Scale\",\r\n            (prefs.defaultScale == this._doc.song.scale ? \"✓ \" : \"　\") + \"Use Current Scale as Default\",\r\n            (prefs.showChannels ? \"✓ \" : \"　\") + \"Show Notes From All Channels\",\r\n            (prefs.showScrollBar ? \"✓ \" : \"　\") + \"Show Octave Scroll Bar\",\r\n            (prefs.alwaysFineNoteVol ? \"✓ \" : \"\") + \"Always Fine Note Volume\",\r\n            (prefs.enableChannelMuting ? \"✓ \" : \"　\") + \"Enable Channel Muting\",\r\n            (prefs.displayBrowserUrl ? \"✓ \" : \"　\") + \"Display Song Data in URL\",\r\n            (prefs.displayVolumeBar ? \"✓ \" : \"　\") + \"Show Playback Volume\",\r\n            \"　Set Layout...\",\r\n            \"　Set Theme...\",\r\n            \"　Set Up Note Recording...\",\r\n        ];\r\n        for (let i: number = 0; i < optionCommands.length; i++) {\r\n            const option: HTMLOptionElement = <HTMLOptionElement>this._optionsMenu.children[i + 1];\r\n            if (option.textContent != optionCommands[i]) option.textContent = optionCommands[i];\r\n        }\r\n\r\n        const channel: Channel = this._doc.song.channels[this._doc.channel];\r\n        const instrumentIndex: number = this._doc.getCurrentInstrument();\r\n        const instrument: Instrument = channel.instruments[instrumentIndex];\r\n        const wasActive: boolean = this.mainLayer.contains(document.activeElement);\r\n        const activeElement: Element | null = document.activeElement;\r\n        const colors: ChannelColors = ColorConfig.getChannelColor(this._doc.song, this._doc.channel);\r\n\r\n        for (let i: number = this._effectsSelect.childElementCount - 1; i < Config.effectOrder.length; i++) {\r\n            this._effectsSelect.appendChild(option({ value: i }));\r\n        }\r\n        this._effectsSelect.selectedIndex = -1;\r\n        for (let i: number = 0; i < Config.effectOrder.length; i++) {\r\n            let effectFlag: number = Config.effectOrder[i];\r\n            const selected: boolean = ((instrument.effects & (1 << effectFlag)) != 0);\r\n            const label: string = (selected ? \"✓ \" : \"　\") + Config.effectNames[effectFlag];\r\n            const option: HTMLOptionElement = <HTMLOptionElement>this._effectsSelect.children[i + 1];\r\n            if (option.textContent != label) option.textContent = label;\r\n        }\r\n\r\n        setSelectedValue(this._scaleSelect, this._doc.song.scale);\r\n        this._scaleSelect.title = Config.scales[this._doc.song.scale].realName;\r\n        setSelectedValue(this._keySelect, Config.keys.length - 1 - this._doc.song.key);\r\n        this._tempoSlider.updateValue(Math.max(0, Math.round(this._doc.song.tempo)));\r\n        this._tempoStepper.value = Math.round(this._doc.song.tempo).toString();\r\n        this._songTitleInputBox.updateValue(this._doc.song.title);\r\n\r\n        this._eqFilterTypeRow.style.setProperty(\"--text-color-lit\", colors.primaryNote);\r\n        this._eqFilterTypeRow.style.setProperty(\"--text-color-dim\", colors.secondaryNote);\r\n        this._eqFilterTypeRow.style.setProperty(\"--background-color-lit\", colors.primaryChannel);\r\n        this._eqFilterTypeRow.style.setProperty(\"--background-color-dim\", colors.secondaryChannel);\r\n\r\n        if (instrument.eqFilterType) {\r\n            this._eqFilterSimpleButton.classList.remove(\"deactivated\");\r\n            this._eqFilterAdvancedButton.classList.add(\"deactivated\");\r\n            this._eqFilterRow.style.display = \"none\";\r\n            this._eqFilterSimpleCutRow.style.display = \"\";\r\n            this._eqFilterSimplePeakRow.style.display = \"\";\r\n        } else {\r\n            this._eqFilterSimpleButton.classList.add(\"deactivated\");\r\n            this._eqFilterAdvancedButton.classList.remove(\"deactivated\");\r\n            this._eqFilterRow.style.display = \"\";\r\n            this._eqFilterSimpleCutRow.style.display = \"none\";\r\n            this._eqFilterSimplePeakRow.style.display = \"none\";\r\n        }\r\n\r\n        setSelectedValue(this._rhythmSelect, this._doc.song.rhythm);\r\n\r\n        if (!this._doc.song.getChannelIsMod(this._doc.channel)) {\r\n\r\n            this._customInstrumentSettingsGroup.style.display = \"\";\r\n            this._panSliderRow.style.display = \"\";\r\n            this._panDropdownGroup.style.display = (this._openPanDropdown ? \"\" : \"none\");\r\n            this._detuneSliderRow.style.display = \"\";\r\n            this._instrumentVolumeSliderRow.style.display = \"\";\r\n            this._instrumentTypeSelectRow.style.setProperty(\"display\", \"\");\r\n            this._instrumentSettingsGroup.appendChild(this._instrumentCopyGroup);\r\n            this._instrumentSettingsGroup.insertBefore(this._instrumentsButtonRow, this._instrumentSettingsGroup.firstChild);\r\n            this._instrumentSettingsGroup.insertBefore(this._instrumentSettingsTextRow, this._instrumentSettingsGroup.firstChild);\r\n\r\n            if (this._doc.song.channels[this._doc.channel].name == \"\") {\r\n                this._instrumentSettingsTextRow.textContent = \"Instrument Settings\";\r\n            }\r\n            else {\r\n                this._instrumentSettingsTextRow.textContent = this._doc.song.channels[this._doc.channel].name;\r\n            }\r\n\r\n            this._modulatorGroup.style.display = \"none\";\r\n\r\n            // Check if current viewed pattern on channel is used anywhere\r\n            // + Check if current instrument on channel is used anywhere\r\n            // + Check if a mod targets this\r\n            this._usageCheck(this._doc.channel, instrumentIndex);\r\n\r\n            if (this._doc.song.getChannelIsNoise(this._doc.channel)) {\r\n                this._pitchedPresetSelect.style.display = \"none\";\r\n                this._drumPresetSelect.style.display = \"\";\r\n                // Also hide select2\r\n                $(\"#pitchPresetSelect\").parent().hide();\r\n                $(\"#drumPresetSelect\").parent().show();\r\n\r\n                setSelectedValue(this._drumPresetSelect, instrument.preset);\r\n            } else {\r\n                this._pitchedPresetSelect.style.display = \"\";\r\n                this._drumPresetSelect.style.display = \"none\";\r\n\r\n                // Also hide select2\r\n                $(\"#pitchPresetSelect\").parent().show();\r\n                $(\"#drumPresetSelect\").parent().hide();\r\n\r\n                setSelectedValue(this._pitchedPresetSelect, instrument.preset);\r\n            }\r\n\r\n            if (instrument.type == InstrumentType.noise) {\r\n                this._chipWaveSelectRow.style.display = \"none\";\r\n                this._chipNoiseSelectRow.style.display = \"\";\r\n                setSelectedValue(this._chipNoiseSelect, instrument.chipNoise);\r\n            } else {\r\n                this._chipNoiseSelectRow.style.display = \"none\";\r\n            }\r\n            if (instrument.type == InstrumentType.spectrum) {\r\n                this._chipWaveSelectRow.style.display = \"none\";\r\n                this._spectrumRow.style.display = \"\";\r\n                this._spectrumEditor.render();\r\n            } else {\r\n                this._spectrumRow.style.display = \"none\";\r\n            }\r\n            if (instrument.type == InstrumentType.harmonics || instrument.type == InstrumentType.pickedString) {\r\n                this._chipWaveSelectRow.style.display = \"none\";\r\n                this._harmonicsRow.style.display = \"\";\r\n                this._harmonicsEditor.render();\r\n            } else {\r\n                this._harmonicsRow.style.display = \"none\";\r\n            }\r\n            if (instrument.type == InstrumentType.pickedString) {\r\n                this._chipWaveSelectRow.style.display = \"none\";\r\n                this._stringSustainRow.style.display = \"\";\r\n                this._stringSustainSlider.updateValue(instrument.stringSustain);\r\n            } else {\r\n                this._stringSustainRow.style.display = \"none\";\r\n            }\r\n            if (instrument.type == InstrumentType.drumset) {\r\n                this._drumsetGroup.style.display = \"\";\r\n                this._chipWaveSelectRow.style.display = \"none\";\r\n                this._fadeInOutRow.style.display = \"none\";\r\n                for (let i: number = 0; i < Config.drumCount; i++) {\r\n                    setSelectedValue(this._drumsetEnvelopeSelects[i], instrument.drumsetEnvelopes[i]);\r\n                    this._drumsetSpectrumEditors[i].render();\r\n                }\r\n            } else {\r\n                this._drumsetGroup.style.display = \"none\";\r\n                this._fadeInOutRow.style.display = \"\";\r\n                this._fadeInOutEditor.render();\r\n            }\r\n\r\n            if (instrument.type == InstrumentType.chip) {\r\n                this._chipWaveSelectRow.style.display = \"\";\r\n                setSelectedValue(this._chipWaveSelect, instrument.chipWave);\r\n            }\r\n\r\n            if (instrument.type == InstrumentType.customChipWave) {\r\n                this._customWaveDraw.style.display = \"\";\r\n                this._chipWaveSelectRow.style.display = \"none\";\r\n            }\r\n            else {\r\n                this._customWaveDraw.style.display = \"none\";\r\n            }\r\n\r\n            if (instrument.type == InstrumentType.pwm) {\r\n                this._chipWaveSelectRow.style.display = \"none\";\r\n                this._pulseWidthRow.style.display = \"\";\r\n                this._pulseWidthSlider.input.title = prettyNumber(instrument.pulseWidth) + \"%\";\r\n                this._pulseWidthSlider.updateValue(instrument.pulseWidth);\r\n            } else {\r\n                this._pulseWidthRow.style.display = \"none\";\r\n            }\r\n\r\n\r\n            if (instrument.type == InstrumentType.fm) {\r\n                this._algorithmSelectRow.style.display = \"\";\r\n                this._phaseModGroup.style.display = \"\";\r\n                this._feedbackRow1.style.display = \"\";\r\n                this._feedbackRow2.style.display = \"\";\r\n                this._chipWaveSelectRow.style.display = \"none\";\r\n                setSelectedValue(this._algorithmSelect, instrument.algorithm);\r\n                setSelectedValue(this._feedbackTypeSelect, instrument.feedbackType);\r\n                this._feedbackAmplitudeSlider.updateValue(instrument.feedbackAmplitude);\r\n                for (let i: number = 0; i < Config.operatorCount; i++) {\r\n                    const isCarrier: boolean = (i < Config.algorithms[instrument.algorithm].carrierCount);\r\n                    this._operatorRows[i].style.color = isCarrier ? ColorConfig.primaryText : \"\";\r\n                    setSelectedValue(this._operatorFrequencySelects[i], instrument.operators[i].frequency);\r\n                    this._operatorAmplitudeSliders[i].updateValue(instrument.operators[i].amplitude);\r\n                    setSelectedValue(this._operatorWaveformSelects[i], instrument.operators[i].waveform);\r\n                    this._operatorWaveformPulsewidthSliders[i].updateValue(instrument.operators[i].pulseWidth);\r\n                    this._operatorWaveformPulsewidthSliders[i].input.title = \"\" + Config.pwmOperatorWaves[instrument.operators[i].pulseWidth].name;\r\n                    this._operatorDropdownGroups[i].style.color = isCarrier ? ColorConfig.primaryText : \"\";\r\n                    const operatorName: string = (isCarrier ? \"Voice \" : \"Modulator \") + (i + 1);\r\n                    this._operatorFrequencySelects[i].title = operatorName + \" Frequency\";\r\n                    this._operatorAmplitudeSliders[i].input.title = operatorName + (isCarrier ? \" Volume\" : \" Amplitude\");\r\n                    this._operatorDropdownGroups[i].style.display = (this._openOperatorDropdowns[i] ? \"\" : \"none\");\r\n                    if (instrument.operators[i].waveform == 3) {\r\n                        this._operatorWaveformPulsewidthSliders[i].container.style.display = \"\";\r\n                        this._operatorWaveformHints[i].style.display = \"none\";\r\n                    } else {\r\n                        this._operatorWaveformPulsewidthSliders[i].container.style.display = \"none\";\r\n                        this._operatorWaveformHints[i].style.display = \"\";\r\n                    }\r\n                }\r\n            }\r\n            else {\r\n                this._algorithmSelectRow.style.display = \"none\";\r\n                this._phaseModGroup.style.display = \"none\";\r\n                this._feedbackRow1.style.display = \"none\";\r\n                this._feedbackRow2.style.display = \"none\";\r\n            }\r\n            this._pulseWidthSlider.input.title = prettyNumber(instrument.pulseWidth) + \"%\";\r\n\r\n\r\n            if (effectsIncludeTransition(instrument.effects)) {\r\n                this._transitionRow.style.display = \"\";\r\n                if (this._openTransitionDropdown)\r\n                    this._transitionDropdownGroup.style.display = \"\";\r\n                setSelectedValue(this._transitionSelect, instrument.transition);\r\n            } else {\r\n                this._transitionDropdownGroup.style.display = \"none\";\r\n                this._transitionRow.style.display = \"none\";\r\n            }\r\n\r\n            if (effectsIncludeChord(instrument.effects)) {\r\n                this._chordSelectRow.style.display = \"\";\r\n                this._chordDropdown.style.display = (instrument.chord == Config.chords.dictionary[\"arpeggio\"].index) ? \"\" : \"none\";\r\n                this._chordDropdownGroup.style.display = (instrument.chord == Config.chords.dictionary[\"arpeggio\"].index && this._openChordDropdown) ? \"\" : \"none\";\r\n                setSelectedValue(this._chordSelect, instrument.chord);\r\n            } else {\r\n                this._chordSelectRow.style.display = \"none\";\r\n                this._chordDropdown.style.display = \"none\";\r\n                this._chordDropdownGroup.style.display = \"none\";\r\n            }\r\n\r\n            if (effectsIncludePitchShift(instrument.effects)) {\r\n                this._pitchShiftRow.style.display = \"\";\r\n                this._pitchShiftSlider.updateValue(instrument.pitchShift);\r\n                this._pitchShiftSlider.input.title = (instrument.pitchShift - Config.pitchShiftCenter) + \" semitone(s)\";\r\n                for (const marker of this._pitchShiftFifthMarkers) {\r\n                    marker.style.display = prefs.showFifth ? \"\" : \"none\";\r\n                }\r\n            } else {\r\n                this._pitchShiftRow.style.display = \"none\";\r\n            }\r\n\r\n            if (effectsIncludeDetune(instrument.effects)) {\r\n                this._detuneSliderRow.style.display = \"\";\r\n                this._detuneSlider.updateValue(instrument.detune - Config.detuneCenter);\r\n                this._detuneSlider.input.title = (Synth.detuneToCents(instrument.detune)) + \" cent(s)\";\r\n            } else {\r\n                this._detuneSliderRow.style.display = \"none\";\r\n            }\r\n\r\n            if (effectsIncludeVibrato(instrument.effects)) {\r\n                this._vibratoSelectRow.style.display = \"\";\r\n                if (this._openVibratoDropdown)\r\n                    this._vibratoDropdownGroup.style.display = \"\";\r\n                setSelectedValue(this._vibratoSelect, instrument.vibrato);\r\n            } else {\r\n                this._vibratoDropdownGroup.style.display = \"none\";\r\n                this._vibratoSelectRow.style.display = \"none\";\r\n            }\r\n\r\n            if (effectsIncludeNoteFilter(instrument.effects)) {\r\n\r\n                this._noteFilterTypeRow.style.setProperty(\"--text-color-lit\", colors.primaryNote);\r\n                this._noteFilterTypeRow.style.setProperty(\"--text-color-dim\", colors.secondaryNote);\r\n                this._noteFilterTypeRow.style.setProperty(\"--background-color-lit\", colors.primaryChannel);\r\n                this._noteFilterTypeRow.style.setProperty(\"--background-color-dim\", colors.secondaryChannel);\r\n                this._noteFilterTypeRow.style.display = \"\";\r\n\r\n                this._noteFilterEditor.render();\r\n\r\n                if (instrument.noteFilterType) {\r\n                    this._noteFilterSimpleButton.classList.remove(\"deactivated\");\r\n                    this._noteFilterAdvancedButton.classList.add(\"deactivated\");\r\n                    this._noteFilterRow.style.display = \"none\";\r\n                    this._noteFilterSimpleCutRow.style.display = \"\";\r\n                    this._noteFilterSimplePeakRow.style.display = \"\";\r\n                } else {\r\n                    this._noteFilterSimpleButton.classList.add(\"deactivated\");\r\n                    this._noteFilterAdvancedButton.classList.remove(\"deactivated\");\r\n                    this._noteFilterRow.style.display = \"\";\r\n                    this._noteFilterSimpleCutRow.style.display = \"none\";\r\n                    this._noteFilterSimplePeakRow.style.display = \"none\";\r\n                }\r\n            } else {\r\n                this._noteFilterRow.style.display = \"none\";\r\n                this._noteFilterSimpleCutRow.style.display = \"none\";\r\n                this._noteFilterSimplePeakRow.style.display = \"none\";\r\n                this._noteFilterTypeRow.style.display = \"none\";\r\n            }\r\n\r\n            if (effectsIncludeDistortion(instrument.effects)) {\r\n                this._distortionRow.style.display = \"\";\r\n                if (instrument.type == InstrumentType.chip || instrument.type == InstrumentType.customChipWave || instrument.type == InstrumentType.pwm)\r\n                    this._aliasingRow.style.display = \"\";\r\n                else\r\n                    this._aliasingRow.style.display = \"none\";\r\n                this._distortionSlider.updateValue(instrument.distortion);\r\n            } else {\r\n                this._distortionRow.style.display = \"none\";\r\n                this._aliasingRow.style.display = \"none\";\r\n            }\r\n\r\n            if (effectsIncludeBitcrusher(instrument.effects)) {\r\n                this._bitcrusherQuantizationRow.style.display = \"\";\r\n                this._bitcrusherFreqRow.style.display = \"\";\r\n                this._bitcrusherQuantizationSlider.updateValue(instrument.bitcrusherQuantization);\r\n                this._bitcrusherFreqSlider.updateValue(instrument.bitcrusherFreq);\r\n            } else {\r\n                this._bitcrusherQuantizationRow.style.display = \"none\";\r\n                this._bitcrusherFreqRow.style.display = \"none\";\r\n            }\r\n\r\n            if (effectsIncludePanning(instrument.effects)) {\r\n                this._panSliderRow.style.display = \"\";\r\n                if (this._openPanDropdown)\r\n                    this._panDropdownGroup.style.display = \"\";\r\n                this._panSlider.updateValue(instrument.pan);\r\n            } else {\r\n                this._panSliderRow.style.display = \"none\";\r\n                this._panDropdownGroup.style.display = \"none\";\r\n            }\r\n\r\n            if (effectsIncludeChorus(instrument.effects)) {\r\n                this._chorusRow.style.display = \"\";\r\n                this._chorusSlider.updateValue(instrument.chorus);\r\n            } else {\r\n                this._chorusRow.style.display = \"none\";\r\n            }\r\n\r\n            if (effectsIncludeEcho(instrument.effects)) {\r\n                this._echoSustainRow.style.display = \"\";\r\n                this._echoSustainSlider.updateValue(instrument.echoSustain);\r\n                this._echoDelayRow.style.display = \"\";\r\n                this._echoDelaySlider.updateValue(instrument.echoDelay);\r\n                this._echoDelaySlider.input.title = (Math.round((instrument.echoDelay + 1) * Config.echoDelayStepTicks / (Config.ticksPerPart * Config.partsPerBeat) * 1000) / 1000) + \" beat(s)\";\r\n            } else {\r\n                this._echoSustainRow.style.display = \"none\";\r\n                this._echoDelayRow.style.display = \"none\";\r\n            }\r\n\r\n            if (effectsIncludeReverb(instrument.effects)) {\r\n                this._reverbRow.style.display = \"\";\r\n                this._reverbSlider.updateValue(instrument.reverb);\r\n            } else {\r\n                this._reverbRow.style.display = \"none\";\r\n            }\r\n\r\n            if (instrument.type == InstrumentType.chip || instrument.type == InstrumentType.customChipWave || instrument.type == InstrumentType.harmonics || instrument.type == InstrumentType.pickedString) {\r\n                this._unisonSelectRow.style.display = \"\";\r\n                setSelectedValue(this._unisonSelect, instrument.unison);\r\n            } else {\r\n                this._unisonSelectRow.style.display = \"none\";\r\n            }\r\n\r\n            this._envelopeEditor.render();\r\n\r\n            for (let chordIndex: number = 0; chordIndex < Config.chords.length; chordIndex++) {\r\n                let hidden: boolean = (!Config.instrumentTypeHasSpecialInterval[instrument.type] && Config.chords[chordIndex].customInterval);\r\n                const option: Element = this._chordSelect.children[chordIndex];\r\n                if (hidden) {\r\n                    if (!option.hasAttribute(\"hidden\")) {\r\n                        option.setAttribute(\"hidden\", \"\");\r\n                    }\r\n                } else {\r\n                    option.removeAttribute(\"hidden\");\r\n                }\r\n            }\r\n\r\n            this._instrumentSettingsGroup.style.color = ColorConfig.getChannelColor(this._doc.song, this._doc.channel).primaryNote;\r\n\r\n            setSelectedValue(this._transitionSelect, instrument.transition);\r\n            setSelectedValue(this._vibratoSelect, instrument.vibrato);\r\n            setSelectedValue(this._vibratoTypeSelect, instrument.vibratoType);\r\n            setSelectedValue(this._chordSelect, instrument.chord);\r\n            this._panSliderInputBox.value = instrument.pan + \"\";\r\n            this._detuneSliderInputBox.value = (instrument.detune - Config.detuneCenter) + \"\";\r\n            this._instrumentVolumeSlider.updateValue(instrument.volume);\r\n            this._instrumentVolumeSliderInputBox.value = \"\" + (instrument.volume);\r\n            this._vibratoDepthSlider.updateValue(Math.round(instrument.vibratoDepth * 25));\r\n            this._vibratoDelaySlider.updateValue(Math.round(instrument.vibratoDelay));\r\n            this._vibratoSpeedSlider.updateValue(instrument.vibratoSpeed);\r\n            setSelectedValue(this._vibratoTypeSelect, instrument.vibratoType);\r\n            this._arpeggioSpeedSlider.updateValue(instrument.arpeggioSpeed);\r\n            this._panDelaySlider.updateValue(instrument.panDelay);\r\n            this._vibratoDelaySlider.input.title = \"\" + Math.round(instrument.vibratoDelay);\r\n            this._vibratoDepthSlider.input.title = \"\" + instrument.vibratoDepth;\r\n            this._vibratoSpeedSlider.input.title = \"\" + instrument.vibratoSpeed;\r\n            this._panDelaySlider.input.title = \"\" + instrument.panDelay;\r\n            this._arpeggioSpeedSlider.input.title = \"x\" + prettyNumber(Config.arpSpeedScale[instrument.arpeggioSpeed]);\r\n            this._eqFilterSimpleCutSlider.updateValue(instrument.eqFilterSimpleCut);\r\n            this._eqFilterSimplePeakSlider.updateValue(instrument.eqFilterSimplePeak);\r\n            this._noteFilterSimpleCutSlider.updateValue(instrument.noteFilterSimpleCut);\r\n            this._noteFilterSimplePeakSlider.updateValue(instrument.noteFilterSimplePeak);\r\n\r\n            if (instrument.type == InstrumentType.customChipWave) {\r\n                this._customWaveDrawCanvas.redrawCanvas();\r\n\r\n                if (this.prompt instanceof CustomChipPrompt) {\r\n                    this.prompt.customChipCanvas.render();\r\n                }\r\n            }\r\n\r\n            this._renderInstrumentBar(channel, instrumentIndex, colors);\r\n        }\r\n        // Options for mod channel\r\n        else {\r\n            this._usageCheck(this._doc.channel, instrumentIndex);\r\n\r\n            this._pitchedPresetSelect.style.display = \"none\";\r\n            this._drumPresetSelect.style.display = \"none\";\r\n            $(\"#pitchPresetSelect\").parent().hide();\r\n            $(\"#drumPresetSelect\").parent().hide();\r\n            this._modulatorGroup.appendChild(this._instrumentCopyGroup);\r\n\r\n            this._modulatorGroup.insertBefore(this._instrumentsButtonRow, this._modulatorGroup.firstChild);\r\n            this._modulatorGroup.insertBefore(this._instrumentSettingsTextRow, this._modulatorGroup.firstChild);\r\n            if (this._doc.song.channels[this._doc.channel].name == \"\") {\r\n                this._instrumentSettingsTextRow.textContent = \"Modulator Settings\";\r\n            }\r\n            else {\r\n                this._instrumentSettingsTextRow.textContent = this._doc.song.channels[this._doc.channel].name;\r\n            }\r\n\r\n            this._chipNoiseSelectRow.style.display = \"none\";\r\n            this._chipWaveSelectRow.style.display = \"none\";\r\n            this._spectrumRow.style.display = \"none\";\r\n            this._harmonicsRow.style.display = \"none\";\r\n            this._transitionRow.style.display = \"none\";\r\n            this._chordSelectRow.style.display = \"none\";\r\n            this._chordDropdownGroup.style.display = \"none\";\r\n            //this._filterCutoffRow.style.display = \"none\";\r\n            //this._filterResonanceRow.style.display = \"none\";\r\n            //this._filterEnvelopeRow.style.display = \"none\";\r\n            this._drumsetGroup.style.display = \"none\";\r\n            this._customWaveDraw.style.display = \"none\";\r\n            this._algorithmSelectRow.style.display = \"none\";\r\n            this._phaseModGroup.style.display = \"none\";\r\n            this._feedbackRow1.style.display = \"none\";\r\n            this._feedbackRow2.style.display = \"none\";\r\n            //this._pulseEnvelopeRow.style.display = \"none\";\r\n            this._pulseWidthRow.style.display = \"none\";\r\n            this._vibratoSelectRow.style.display = \"none\";\r\n            this._vibratoDropdownGroup.style.display = \"none\";\r\n            //this._intervalSelectRow.style.display = \"none\";\r\n            this._detuneSliderRow.style.display = \"none\";\r\n            this._panSliderRow.style.display = \"none\";\r\n            this._panDropdownGroup.style.display = \"none\";\r\n\r\n            this._modulatorGroup.style.display = \"\";\r\n            this._modulatorGroup.style.color = ColorConfig.getChannelColor(this._doc.song, this._doc.channel).primaryNote;\r\n\r\n            for (let mod: number = 0; mod < Config.modCount; mod++) {\r\n\r\n                let instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n                let modChannel: number = Math.max(0, instrument.modChannels[mod]);\r\n                let modInstrument: number = instrument.modInstruments[mod];\r\n\r\n                // Boundary checking\r\n                if (modInstrument >= this._doc.song.channels[modChannel].instruments.length + 2 || (modInstrument > 0 && this._doc.song.channels[modChannel].instruments.length <= 1)) {\r\n                    modInstrument = 0;\r\n                    instrument.modInstruments[mod] = 0;\r\n                    instrument.modulators[mod] = 0;\r\n                }\r\n                if (modChannel >= this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount) {\r\n                    instrument.modInstruments[mod] = 0;\r\n                    instrument.modulators[mod] = 0;\r\n                }\r\n\r\n                // Build options for modulator channels (make sure it has the right number).\r\n                if (this._doc.recalcChannelNames || (this._modChannelBoxes[mod].children.length != 2 + this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount)) {\r\n                    while (this._modChannelBoxes[mod].firstChild) this._modChannelBoxes[mod].remove(0);\r\n                    const channelList: string[] = [];\r\n                    channelList.push(\"none\");\r\n                    channelList.push(\"song\");\r\n                    for (let i: number = 0; i < this._doc.song.pitchChannelCount; i++) {\r\n                        if (this._doc.song.channels[i].name == \"\") {\r\n                            channelList.push(\"pitch \" + (i + 1));\r\n                        }\r\n                        else {\r\n                            channelList.push(this._doc.song.channels[i].name);\r\n                        }\r\n                    }\r\n                    for (let i: number = 0; i < this._doc.song.noiseChannelCount; i++) {\r\n                        if (this._doc.song.channels[i + this._doc.song.pitchChannelCount].name == \"\") {\r\n                            channelList.push(\"noise \" + (i + 1));\r\n                        }\r\n                        else {\r\n                            channelList.push(this._doc.song.channels[i + this._doc.song.pitchChannelCount].name);\r\n                        }\r\n                    }\r\n                    buildOptions(this._modChannelBoxes[mod], channelList);\r\n                }\r\n\r\n                // Set selected index based on channel info.\r\n\r\n                this._modChannelBoxes[mod].selectedIndex = instrument.modChannels[mod] + 2; // Offset to get to first pitch channel\r\n\r\n                let channel: Channel = this._doc.song.channels[modChannel];\r\n\r\n                // Build options for modulator instruments (make sure it has the right number).\r\n                if (this._modInstrumentBoxes[mod].children.length != channel.instruments.length + 2) {\r\n                    while (this._modInstrumentBoxes[mod].firstChild) this._modInstrumentBoxes[mod].remove(0);\r\n                    const instrumentList: string[] = [];\r\n                    for (let i: number = 0; i < channel.instruments.length; i++) {\r\n                        instrumentList.push(\"\" + i + 1);\r\n                    }\r\n                    instrumentList.push(\"all\");\r\n                    instrumentList.push(\"active\");\r\n                    buildOptions(this._modInstrumentBoxes[mod], instrumentList);\r\n                }\r\n\r\n                // If non-zero pattern, point to which instrument(s) is/are the current\r\n                if (channel.bars[this._doc.bar] > 0) {\r\n\r\n                    let usedInstruments: number[] = channel.patterns[channel.bars[this._doc.bar] - 1].instruments;\r\n\r\n                    for (let i: number = 0; i < channel.instruments.length; i++) {\r\n\r\n                        if (usedInstruments.includes(i)) {\r\n                            this._modInstrumentBoxes[mod].options[i].label = \"🢒\" + (i + 1);\r\n                        }\r\n                        else {\r\n                            this._modInstrumentBoxes[mod].options[i].label = \"\" + (i + 1);\r\n                        }\r\n                    }\r\n                }\r\n                else {\r\n                    for (let i: number = 0; i < channel.instruments.length; i++) {\r\n                        this._modInstrumentBoxes[mod].options[i].label = \"\" + (i + 1);\r\n                    }\r\n                }\r\n\r\n                // Set selected index based on instrument info.\r\n                this._modInstrumentBoxes[mod].selectedIndex = instrument.modInstruments[mod];\r\n\r\n                // Build options for modulator settings (based on channel settings)\r\n\r\n                if (instrument.modChannels[mod] != -2) {\r\n                    while (this._modSetBoxes[mod].firstChild) this._modSetBoxes[mod].remove(0);\r\n                    const settingList: string[] = [];\r\n                    const unusedSettingList: string[] = [];\r\n\r\n                    // Make sure these names match the names declared for modulators in SynthConfig.ts.\r\n\r\n                    settingList.push(\"none\");\r\n\r\n                    // Populate mod setting options for the song scope.\r\n                    if (instrument.modChannels[mod] == -1) {\r\n                        settingList.push(\"song volume\");\r\n                        settingList.push(\"tempo\");\r\n                        settingList.push(\"song reverb\");\r\n                        settingList.push(\"next bar\");\r\n                        settingList.push(\"song detune\");\r\n                    }\r\n                    // Populate mod setting options for instrument scope.\r\n                    else {\r\n\r\n                        settingList.push(\"note volume\");\r\n                        settingList.push(\"mix volume\");\r\n\r\n                        // Build a list of target instrument indices, types and other info. It will be a single type for a single instrument, but with \"all\" and \"active\" it could be more.\r\n                        // All or active are included together. Active allows any to be set, just in case the user fiddles with which are active later.\r\n                        let tgtInstrumentTypes: InstrumentType[] = [];\r\n                        let anyInstrumentAdvancedEQ:   boolean = false,\r\n                            anyInstrumentSimpleEQ:     boolean = false,\r\n                            anyInstrumentAdvancedNote: boolean = false,\r\n                            anyInstrumentSimpleNote:   boolean = false,\r\n                            anyInstrumentArps:         boolean = false,\r\n                            anyInstrumentPitchShifts:  boolean = false,\r\n                            anyInstrumentDetunes:      boolean = false,\r\n                            anyInstrumentVibratos:     boolean = false,\r\n                            anyInstrumentNoteFilters:  boolean = false,\r\n                            anyInstrumentDistorts:     boolean = false,\r\n                            anyInstrumentBitcrushes:   boolean = false,\r\n                            anyInstrumentPans:         boolean = false,\r\n                            anyInstrumentChorus:       boolean = false,\r\n                            anyInstrumentEchoes:       boolean = false,\r\n                            anyInstrumentReverbs:      boolean = false;\r\n                        let allInstrumentPitchShifts:  boolean = true,\r\n                            allInstrumentNoteFilters:  boolean = true,\r\n                            allInstrumentDetunes:      boolean = true,\r\n                            allInstrumentVibratos:     boolean = true,\r\n                            allInstrumentDistorts:     boolean = true,\r\n                            allInstrumentBitcrushes:   boolean = true,\r\n                            allInstrumentPans:         boolean = true,\r\n                            allInstrumentChorus:       boolean = true,\r\n                            allInstrumentEchoes:       boolean = true,\r\n                            allInstrumentReverbs:      boolean = true;\r\n                        let instrumentCandidates: number[] = [];\r\n                        if (modInstrument >= channel.instruments.length) {\r\n                            for (let i: number = 0; i < channel.instruments.length; i++) {\r\n                                instrumentCandidates.push(i);\r\n                            }\r\n                        } else {\r\n                            instrumentCandidates.push(modInstrument);\r\n                        }\r\n                        for (let i: number = 0; i < instrumentCandidates.length; i++) {\r\n                            let instrumentIndex = instrumentCandidates[i];\r\n\r\n                            if (!tgtInstrumentTypes.includes(channel.instruments[instrumentIndex].type))\r\n                                tgtInstrumentTypes.push(channel.instruments[instrumentIndex].type);\r\n                            if (channel.instruments[instrumentIndex].eqFilterType)\r\n                                anyInstrumentSimpleEQ = true;\r\n                            else\r\n                                anyInstrumentAdvancedEQ = true;\r\n                            if (effectsIncludeChord(channel.instruments[instrumentIndex].effects) && channel.instruments[instrumentIndex].getChord().arpeggiates) {\r\n                                anyInstrumentArps = true;\r\n                            }\r\n                            if (effectsIncludePitchShift(channel.instruments[instrumentIndex].effects)) {\r\n                                anyInstrumentPitchShifts = true;\r\n                            }\r\n                            if (effectsIncludeDetune(channel.instruments[instrumentIndex].effects)) {\r\n                                anyInstrumentDetunes = true;\r\n                            }\r\n                            else {\r\n                                allInstrumentDetunes = false;\r\n                            }\r\n                            if (effectsIncludeVibrato(channel.instruments[instrumentIndex].effects)) {\r\n                                anyInstrumentVibratos = true;\r\n                            }\r\n                            else {\r\n                                allInstrumentVibratos = false;\r\n                            }\r\n                            if (effectsIncludeNoteFilter(channel.instruments[instrumentIndex].effects)) {\r\n                                anyInstrumentNoteFilters = true;\r\n                                if (channel.instruments[instrumentIndex].noteFilterType)\r\n                                    anyInstrumentSimpleNote = true;\r\n                                else\r\n                                    anyInstrumentAdvancedNote = true;\r\n                            }\r\n                            else {\r\n                                allInstrumentNoteFilters = false;\r\n                            }\r\n                            if (effectsIncludeDistortion(channel.instruments[instrumentIndex].effects)) {\r\n                                anyInstrumentDistorts = true;\r\n                            }\r\n                            else {\r\n                                allInstrumentDistorts = false;\r\n                            }\r\n                            if (effectsIncludeBitcrusher(channel.instruments[instrumentIndex].effects)) {\r\n                                anyInstrumentBitcrushes = true;\r\n                            }\r\n                            else {\r\n                                allInstrumentBitcrushes = false;\r\n                            }\r\n                            if (effectsIncludePanning(channel.instruments[instrumentIndex].effects)) {\r\n                                anyInstrumentPans = true;\r\n                            }\r\n                            else {\r\n                                allInstrumentPans = false;\r\n                            }\r\n                            if (effectsIncludeChorus(channel.instruments[instrumentIndex].effects)) {\r\n                                anyInstrumentChorus = true;\r\n                            }\r\n                            else {\r\n                                allInstrumentChorus = false;\r\n                            }\r\n                            if (effectsIncludeEcho(channel.instruments[instrumentIndex].effects)) {\r\n                                anyInstrumentEchoes = true;\r\n                            }\r\n                            else {\r\n                                allInstrumentEchoes = false;\r\n                            }\r\n                            if (effectsIncludeReverb(channel.instruments[instrumentIndex].effects)) {\r\n                                anyInstrumentReverbs = true;\r\n                            }\r\n                            else {\r\n                                allInstrumentReverbs = false;\r\n                            }\r\n\r\n                        }\r\n                        if (anyInstrumentAdvancedEQ) {\r\n                            settingList.push(\"eq filter\");\r\n                        }\r\n                        if (anyInstrumentSimpleEQ) {\r\n                            settingList.push(\"eq filt cut\");\r\n                            settingList.push(\"eq filt peak\");\r\n                        }\r\n                        if (tgtInstrumentTypes.includes(InstrumentType.fm)) {\r\n                            settingList.push(\"fm slider 1\");\r\n                            settingList.push(\"fm slider 2\");\r\n                            settingList.push(\"fm slider 3\");\r\n                            settingList.push(\"fm slider 4\");\r\n                            settingList.push(\"fm feedback\");\r\n                        }\r\n                        if (tgtInstrumentTypes.includes(InstrumentType.pwm)) {\r\n                            settingList.push(\"pulse width\");\r\n                        }\r\n                        if (tgtInstrumentTypes.includes(InstrumentType.pickedString)) {\r\n                            settingList.push(\"sustain\");\r\n                        }\r\n                        if (anyInstrumentArps) {\r\n                            settingList.push(\"arp speed\");\r\n                            settingList.push(\"reset arp\");\r\n                        }\r\n                        if (anyInstrumentPitchShifts) {\r\n                            settingList.push(\"pitch shift\");\r\n                        }\r\n                        if (!allInstrumentPitchShifts) {\r\n                            unusedSettingList.push(\"+ pitch shift\");\r\n                        }\r\n                        if (anyInstrumentDetunes) {\r\n                            settingList.push(\"detune\");\r\n                        }\r\n                        if (!allInstrumentDetunes) {\r\n                            unusedSettingList.push(\"+ detune\");\r\n                        }\r\n                        if (anyInstrumentVibratos) {\r\n                            settingList.push(\"vibrato depth\");\r\n                            settingList.push(\"vibrato speed\");\r\n                            settingList.push(\"vibrato delay\");\r\n                        }\r\n                        if (!allInstrumentVibratos) {\r\n                            unusedSettingList.push(\"+ vibrato depth\");\r\n                            unusedSettingList.push(\"+ vibrato speed\");\r\n                            unusedSettingList.push(\"+ vibrato delay\");\r\n                        }\r\n                        if (anyInstrumentNoteFilters) {\r\n                            if (anyInstrumentAdvancedNote) {\r\n                                settingList.push(\"note filter\");\r\n                            }\r\n                            if (anyInstrumentSimpleNote) {\r\n                                settingList.push(\"note filt cut\");\r\n                                settingList.push(\"note filt peak\");\r\n                            }\r\n                        }\r\n                        if (!allInstrumentNoteFilters) {\r\n                            unusedSettingList.push(\"+ note filter\");\r\n                        }\r\n                        if (anyInstrumentDistorts) {\r\n                            settingList.push(\"distortion\");\r\n                        }\r\n                        if (!allInstrumentDistorts) {\r\n                            unusedSettingList.push(\"+ distortion\");\r\n                        }\r\n                        if (anyInstrumentBitcrushes) {\r\n                            settingList.push(\"bit crush\");\r\n                            settingList.push(\"freq crush\");\r\n                        }\r\n                        if (!allInstrumentBitcrushes) {\r\n                            unusedSettingList.push(\"+ bit crush\");\r\n                            unusedSettingList.push(\"+ freq crush\");\r\n                        }\r\n                        if (anyInstrumentPans) {\r\n                            settingList.push(\"pan\");\r\n                            settingList.push(\"pan delay\");\r\n                        }\r\n                        if (!allInstrumentPans) {\r\n                            unusedSettingList.push(\"+ pan\");\r\n                            unusedSettingList.push(\"+ pan delay\");\r\n                        }\r\n                        if (anyInstrumentChorus) {\r\n                            settingList.push(\"chorus\");\r\n                        }\r\n                        if (!allInstrumentChorus) {\r\n                            unusedSettingList.push(\"+ chorus\");\r\n                        }\r\n                        if (anyInstrumentEchoes) {\r\n                            settingList.push(\"echo\");\r\n                            // Disabled currently!\r\n                            //settingList.push(\"echo delay\");\r\n                        }\r\n                        if (!allInstrumentEchoes) {\r\n                            unusedSettingList.push(\"+ echo\");\r\n                            //unusedSettingList.push(\"echo delay\");\r\n                        }\r\n                        if (anyInstrumentReverbs) {\r\n                            settingList.push(\"reverb\");\r\n                        }\r\n                        if (!allInstrumentReverbs) {\r\n                            unusedSettingList.push(\"+ reverb\");\r\n                        }\r\n\r\n                    }\r\n\r\n                    buildOptions(this._modSetBoxes[mod], settingList);\r\n                    if (unusedSettingList.length > 0) {\r\n                        this._modSetBoxes[mod].appendChild(option({ selected: false, disabled: true, value: \"Add Effect\" }, \"Add Effect\"));\r\n                        buildOptions(this._modSetBoxes[mod], unusedSettingList);\r\n                    }\r\n\r\n                    let setIndex: number = settingList.indexOf(Config.modulators[instrument.modulators[mod]].name);\r\n\r\n                    // Catch instances where invalid set forced setting to \"none\"\r\n                    if (setIndex == -1) {\r\n                        this._modSetBoxes[mod].insertBefore(option({ value: Config.modulators[instrument.modulators[mod]].name, style: \"color: red;\" }, Config.modulators[instrument.modulators[mod]].name), this._modSetBoxes[mod].children[0]);\r\n                        this._modSetBoxes[mod].selectedIndex = 0;\r\n                        //instrument.modulators[mod] = 0;\r\n                        //instrument.modInstruments[mod] = 0;\r\n                        this._whenSetModSetting(mod, true);\r\n                    }\r\n                    else {\r\n                        this._modSetBoxes[mod].selectedIndex = setIndex;\r\n                        this._modSetBoxes[mod].classList.remove(\"invalidSetting\");\r\n                        instrument.invalidModulators[mod] = false;\r\n                    }\r\n\r\n                } else if (this._modSetBoxes[mod].selectedIndex > 0) {\r\n                    this._modSetBoxes[mod].selectedIndex = 0;\r\n                    this._whenSetModSetting(mod);\r\n                }\r\n\r\n                //Hide instrument select if channel is \"none\" or \"song\"\r\n                if (instrument.modChannels[mod] < 0) {\r\n                    ((this._modInstrumentBoxes[mod].parentElement) as HTMLDivElement).style.display = \"none\";\r\n                    $(\"#modInstrumentText\" + mod).get(0).style.display = \"none\";\r\n                    $(\"#modChannelText\" + mod).get(0).innerText = \"Channel:\";\r\n\r\n                    //Hide setting select if channel is \"none\"\r\n                    if (instrument.modChannels[mod] == -2) {\r\n                        $(\"#modSettingText\" + mod).get(0).style.display = \"none\";\r\n                        ((this._modSetBoxes[mod].parentElement) as HTMLDivElement).style.display = \"none\";\r\n                    }\r\n                    else {\r\n                        $(\"#modSettingText\" + mod).get(0).style.display = \"\";\r\n                        ((this._modSetBoxes[mod].parentElement) as HTMLDivElement).style.display = \"\";\r\n                    }\r\n\r\n                    this._modTargetIndicators[mod].style.setProperty(\"fill\", ColorConfig.uiWidgetFocus);\r\n                    this._modTargetIndicators[mod].classList.remove(\"modTarget\");\r\n\r\n                }\r\n                else {\r\n                    ((this._modInstrumentBoxes[mod].parentElement) as HTMLDivElement).style.display = (channel.instruments.length > 1) ? \"\" : \"none\";\r\n                    $(\"#modInstrumentText\" + mod).get(0).style.display = (channel.instruments.length > 1) ? \"\" : \"none\";\r\n                    $(\"#modChannelText\" + mod).get(0).innerText = (channel.instruments.length > 1) ? \"Ch:\" : \"Channel:\";\r\n                    $(\"#modSettingText\" + mod).get(0).style.display = \"\";\r\n                    ((this._modSetBoxes[mod].parentElement) as HTMLDivElement).style.display = \"\";\r\n\r\n                    this._modTargetIndicators[mod].style.setProperty(\"fill\", ColorConfig.indicatorPrimary);\r\n                    this._modTargetIndicators[mod].classList.add(\"modTarget\");\r\n                }\r\n\r\n                let filterType: string = Config.modulators[instrument.modulators[mod]].name;\r\n                if (filterType == \"eq filter\" || filterType == \"note filter\") {\r\n                    $(\"#modFilterText\" + mod).get(0).style.display = \"\";\r\n                    $(\"#modSettingText\" + mod).get(0).style.setProperty(\"margin-bottom\", \"2px\");\r\n\r\n                    let useInstrument: number = instrument.modInstruments[mod];\r\n                    let modChannel: Channel = this._doc.song.channels[Math.max(0, instrument.modChannels[mod])];\r\n                    let tmpCount: number = -1;\r\n                    if (useInstrument >= modChannel.instruments.length) {\r\n                        // Use greatest number of dots among all instruments if setting is 'all' or 'active'. If it won't have an effect on one, no worry.\r\n                        for (let i: number = 0; i < modChannel.instruments.length; i++) {\r\n                            if (filterType == \"eq filter\") {\r\n                                if (modChannel.instruments[i].eqFilter.controlPointCount > tmpCount) {\r\n                                    tmpCount = modChannel.instruments[i].eqFilter.controlPointCount;\r\n                                    useInstrument = i;\r\n                                }\r\n                            } else {\r\n                                if (modChannel.instruments[i].noteFilter.controlPointCount > tmpCount) {\r\n                                    tmpCount = modChannel.instruments[i].noteFilter.controlPointCount;\r\n                                    useInstrument = i;\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    // Build options for modulator filters (make sure it has the right number of filter dots).\r\n                    let dotCount: number = (filterType == \"eq filter\")\r\n                        ? channel.instruments[useInstrument].eqFilter.controlPointCount\r\n                        : channel.instruments[useInstrument].noteFilter.controlPointCount;\r\n\r\n                    const isSimple: boolean = (filterType == \"eq filter\" ? channel.instruments[useInstrument].eqFilterType : channel.instruments[useInstrument].noteFilterType);\r\n                    if (isSimple)\r\n                        dotCount = 0;\r\n\r\n                    if (isSimple || this._modFilterBoxes[mod].children.length != 1 + dotCount * 2) {\r\n                        while (this._modFilterBoxes[mod].firstChild) this._modFilterBoxes[mod].remove(0);\r\n                        const dotList: string[] = [];\r\n                        if (!isSimple)\r\n                            dotList.push(\"morph\");\r\n                        for (let i: number = 0; i < dotCount; i++) {\r\n                            dotList.push(\"dot \" + (i + 1) + \" x\");\r\n                            dotList.push(\"dot \" + (i + 1) + \" y\");\r\n                        }\r\n                        buildOptions(this._modFilterBoxes[mod], dotList);\r\n                    }\r\n\r\n                    if (isSimple || instrument.modFilterTypes[mod] >= this._modFilterBoxes[mod].length) {\r\n                        this._modFilterBoxes[mod].classList.add(\"invalidSetting\");\r\n                        instrument.invalidModulators[mod] = true;\r\n                        let useName: string = ((instrument.modFilterTypes[mod] - 1) % 2 == 1) ?\r\n                            \"dot \" + (Math.floor((instrument.modFilterTypes[mod] - 1) / 2) + 1) + \" y\"\r\n                            : \"dot \" + (Math.floor((instrument.modFilterTypes[mod] - 1) / 2) + 1) + \" x\";\r\n                        if (instrument.modFilterTypes[mod] == 0)\r\n                            useName = \"morph\";\r\n                        this._modFilterBoxes[mod].insertBefore(option({ value: useName, style: \"color: red;\" }, useName), this._modFilterBoxes[mod].children[0]);\r\n                        this._modFilterBoxes[mod].selectedIndex = 0;\r\n\r\n                    }\r\n                    else {\r\n                        this._modFilterBoxes[mod].classList.remove(\"invalidSetting\");\r\n                        instrument.invalidModulators[mod] = false;\r\n                        this._modFilterBoxes[mod].selectedIndex = instrument.modFilterTypes[mod];\r\n                    }\r\n\r\n\r\n\r\n                } else {\r\n                    $(\"#modFilterText\" + mod).get(0).style.display = \"none\";\r\n                    $(\"#modSettingText\" + mod).get(0).style.setProperty(\"margin-bottom\", \"0.9em\");\r\n\r\n                }\r\n            }\r\n\r\n            this._doc.recalcChannelNames = false;\r\n\r\n            for (let chordIndex: number = 0; chordIndex < Config.chords.length; chordIndex++) {\r\n                const option: Element = this._chordSelect.children[chordIndex];\r\n                if (!option.hasAttribute(\"hidden\")) {\r\n                    option.setAttribute(\"hidden\", \"\");\r\n                }\r\n\r\n            }\r\n\r\n            //this._instrumentSelectRow.style.display = \"none\";\r\n\r\n            this._customInstrumentSettingsGroup.style.display = \"none\";\r\n            this._panSliderRow.style.display = \"none\";\r\n            this._panDropdownGroup.style.display = \"none\";\r\n            this._instrumentVolumeSliderRow.style.display = \"none\";\r\n            this._instrumentTypeSelectRow.style.setProperty(\"display\", \"none\");\r\n\r\n            this._instrumentSettingsGroup.style.color = ColorConfig.getChannelColor(this._doc.song, this._doc.channel).primaryNote;\r\n\r\n            // Force piano to re-show, if channel is modulator\r\n            if (this._doc.channel >= this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount) {\r\n                this._piano.forceRender();\r\n            }\r\n\r\n            this._renderInstrumentBar(channel, instrumentIndex, colors);\r\n\r\n        }\r\n\r\n        this._instrumentSettingsGroup.style.color = colors.primaryNote;\r\n\r\n        this._eqFilterEditor.render();\r\n        this._instrumentVolumeSlider.updateValue(instrument.volume);\r\n        this._detuneSlider.updateValue(instrument.detune - Config.detuneCenter);\r\n        this._twoNoteArpBox.checked = instrument.fastTwoNoteArp ? true : false;\r\n        this._clicklessTransitionBox.checked = instrument.clicklessTransition ? true : false;\r\n        this._aliasingBox.checked = instrument.aliases ? true : false;\r\n        this._addEnvelopeButton.disabled = (instrument.envelopeCount >= Config.maxEnvelopeCount);\r\n\r\n        this._volumeSlider.updateValue(prefs.volume);\r\n\r\n        // If an interface element was selected, but becomes invisible (e.g. an instrument\r\n        // select menu) just select the editor container so keyboard commands still work.\r\n        if (wasActive && activeElement != null && activeElement.clientWidth == 0) {\r\n            this.refocusStage();\r\n        }\r\n\r\n        this._setPrompt(this._doc.prompt);\r\n\r\n        if (prefs.autoFollow && !this._doc.synth.playing) {\r\n            this._doc.synth.goToBar(this._doc.bar);\r\n        }\r\n\r\n        // When adding effects or envelopes to an instrument in fullscreen modes,\r\n        // auto-scroll the settings areas to ensure the new settings are visible.\r\n        if (this._doc.addedEffect) {\r\n            const envButtonRect: DOMRect = this._addEnvelopeButton.getBoundingClientRect();\r\n            const instSettingsRect: DOMRect = this._instrumentSettingsArea.getBoundingClientRect();\r\n            const settingsRect: DOMRect = this._settingsArea.getBoundingClientRect();\r\n            this._instrumentSettingsArea.scrollTop += Math.max(0, envButtonRect.top - (instSettingsRect.top + instSettingsRect.height));\r\n            this._settingsArea.scrollTop += Math.max(0, envButtonRect.top - (settingsRect.top + settingsRect.height));\r\n            this._doc.addedEffect = false;\r\n        }\r\n        if (this._doc.addedEnvelope) {\r\n            this._instrumentSettingsArea.scrollTop = this._instrumentSettingsArea.scrollHeight;\r\n            this._settingsArea.scrollTop = this._settingsArea.scrollHeight;\r\n            this._doc.addedEnvelope = false;\r\n        }\r\n    }\r\n\r\n    private _renderInstrumentBar(channel: Channel, instrumentIndex: number, colors: ChannelColors) {\r\n        if (this._doc.song.layeredInstruments || this._doc.song.patternInstruments) {\r\n            this._instrumentsButtonRow.style.display = \"\";\r\n            this._instrumentsButtonBar.style.setProperty(\"--text-color-lit\", colors.primaryNote);\r\n            this._instrumentsButtonBar.style.setProperty(\"--text-color-dim\", colors.secondaryNote);\r\n            this._instrumentsButtonBar.style.setProperty(\"--background-color-lit\", colors.primaryChannel);\r\n            this._instrumentsButtonBar.style.setProperty(\"--background-color-dim\", colors.secondaryChannel);\r\n\r\n            const maxInstrumentsPerChannel = this._doc.song.getMaxInstrumentsPerChannel();\r\n            while (this._instrumentButtons.length < channel.instruments.length) {\r\n                const instrumentButton: HTMLButtonElement = button(String(this._instrumentButtons.length + 1));\r\n                this._instrumentButtons.push(instrumentButton);\r\n                this._instrumentsButtonBar.insertBefore(instrumentButton, this._instrumentRemoveButton);\r\n            }\r\n            for (let i: number = this._renderedInstrumentCount; i < channel.instruments.length; i++) {\r\n                this._instrumentButtons[i].style.display = \"\";\r\n            }\r\n            for (let i: number = channel.instruments.length; i < this._renderedInstrumentCount; i++) {\r\n                this._instrumentButtons[i].style.display = \"none\";\r\n            }\r\n            this._renderedInstrumentCount = channel.instruments.length;\r\n            while (this._instrumentButtons.length > maxInstrumentsPerChannel) {\r\n                this._instrumentsButtonBar.removeChild(this._instrumentButtons.pop()!);\r\n            }\r\n\r\n            this._instrumentRemoveButton.style.display = (channel.instruments.length > Config.instrumentCountMin) ? \"\" : \"none\";\r\n            this._instrumentAddButton.style.display = (channel.instruments.length < maxInstrumentsPerChannel) ? \"\" : \"none\";\r\n            if (channel.instruments.length < maxInstrumentsPerChannel) {\r\n                this._instrumentRemoveButton.classList.remove(\"last-button\");\r\n            } else {\r\n                this._instrumentRemoveButton.classList.add(\"last-button\");\r\n            }\r\n            if (channel.instruments.length > 1) {\r\n                if (this._highlightedInstrumentIndex != instrumentIndex) {\r\n                    const oldButton: HTMLButtonElement = this._instrumentButtons[this._highlightedInstrumentIndex];\r\n                    if (oldButton != null) oldButton.classList.remove(\"selected-instrument\");\r\n                    const newButton: HTMLButtonElement = this._instrumentButtons[instrumentIndex];\r\n                    newButton.classList.add(\"selected-instrument\");\r\n                    this._highlightedInstrumentIndex = instrumentIndex;\r\n                }\r\n            } else {\r\n                const oldButton: HTMLButtonElement = this._instrumentButtons[this._highlightedInstrumentIndex];\r\n                if (oldButton != null) oldButton.classList.remove(\"selected-instrument\");\r\n                this._highlightedInstrumentIndex = -1;\r\n            }\r\n\r\n            if (this._doc.song.layeredInstruments && this._doc.song.patternInstruments && (this._doc.channel < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount)) {\r\n                //const pattern: Pattern | null = this._doc.getCurrentPattern();\r\n                for (let i: number = 0; i < channel.instruments.length; i++) {\r\n                    if (this._doc.recentPatternInstruments[this._doc.channel].indexOf(i) != -1) {\r\n                        this._instrumentButtons[i].classList.remove(\"deactivated\");\r\n                    } else {\r\n                        this._instrumentButtons[i].classList.add(\"deactivated\");\r\n                    }\r\n                }\r\n                this._deactivatedInstruments = true;\r\n            } else if (this._deactivatedInstruments || (this._doc.channel >= this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount)) {\r\n                for (let i: number = 0; i < channel.instruments.length; i++) {\r\n\r\n                    this._instrumentButtons[i].classList.remove(\"deactivated\");\r\n                }\r\n                this._deactivatedInstruments = false;\r\n            }\r\n\r\n            if ((this._doc.song.layeredInstruments && this._doc.song.patternInstruments) && channel.instruments.length > 1 && (this._doc.channel < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount)) {\r\n                for (let i: number = 0; i < channel.instruments.length; i++) {\r\n                    this._instrumentButtons[i].classList.remove(\"no-underline\");\r\n                }\r\n            }\r\n            else {\r\n                for (let i: number = 0; i < channel.instruments.length; i++) {\r\n                    this._instrumentButtons[i].classList.add(\"no-underline\");\r\n                }\r\n            }\r\n        } else {\r\n            this._instrumentsButtonRow.style.display = \"none\";\r\n        }\r\n    }\r\n\r\n    public updatePlayButton = (): void => {\r\n        if (this._renderedIsPlaying != this._doc.synth.playing || this._renderedIsRecording != this._doc.synth.recording || this._renderedShowRecordButton != this._doc.prefs.showRecordButton || this._renderedCtrlHeld != this._ctrlHeld) {\r\n            this._renderedIsPlaying = this._doc.synth.playing;\r\n            this._renderedIsRecording = this._doc.synth.recording;\r\n            this._renderedShowRecordButton = this._doc.prefs.showRecordButton;\r\n            this._renderedCtrlHeld = this._ctrlHeld;\r\n\r\n            if (document.activeElement == this._playButton || document.activeElement == this._pauseButton || document.activeElement == this._recordButton || document.activeElement == this._stopButton) {\r\n                // When a focused element is hidden, focus is transferred to the document, so let's refocus the editor instead to make sure we can still capture keyboard input.\r\n                this.refocusStage();\r\n            }\r\n\r\n            this._fileInput.style.display = \"none\";\r\n            this._pausePlayer.style.display = \"none\";\r\n\r\n            this._playButton.style.display = \"none\";\r\n            this._pauseButton.style.display = \"none\";\r\n            this._recordButton.style.display = \"none\";\r\n            this._stopButton.style.display = \"none\";\r\n            this._prevBarButton.style.display = \"\";\r\n            this._nextBarButton.style.display = \"\";\r\n            this._playButton.classList.remove(\"shrunk\");\r\n            this._recordButton.classList.remove(\"shrunk\");\r\n            this._patternEditorRow.style.pointerEvents = \"\";\r\n            this._octaveScrollBar.container.style.pointerEvents = \"\";\r\n            this._octaveScrollBar.container.style.opacity = \"\";\r\n            this._trackContainer.style.pointerEvents = \"\";\r\n            this._loopEditor.container.style.opacity = \"\";\r\n            this._instrumentSettingsArea.style.pointerEvents = \"\";\r\n            this._instrumentSettingsArea.style.opacity = \"\";\r\n            this._menuArea.style.pointerEvents = \"\";\r\n            this._menuArea.style.opacity = \"\";\r\n            this._songSettingsArea.style.pointerEvents = \"\";\r\n            this._songSettingsArea.style.opacity = \"\";\r\n\r\n            if (this._doc.synth.recording) {\r\n                this._stopButton.style.display = \"\";\r\n                this._prevBarButton.style.display = \"none\";\r\n                this._nextBarButton.style.display = \"none\";\r\n                this._patternEditorRow.style.pointerEvents = \"none\";\r\n                this._octaveScrollBar.container.style.pointerEvents = \"none\";\r\n                this._octaveScrollBar.container.style.opacity = \"0.5\";\r\n                this._trackContainer.style.pointerEvents = \"none\";\r\n                this._loopEditor.container.style.opacity = \"0.5\";\r\n                this._instrumentSettingsArea.style.pointerEvents = \"none\";\r\n                this._instrumentSettingsArea.style.opacity = \"0.5\";\r\n                this._menuArea.style.pointerEvents = \"none\";\r\n                this._menuArea.style.opacity = \"0.5\";\r\n                this._songSettingsArea.style.pointerEvents = \"none\";\r\n                this._songSettingsArea.style.opacity = \"0.5\";\r\n            } else if (this._doc.synth.playing) {\r\n                this._pauseButton.style.display = \"\";\r\n            } else if (this._doc.prefs.showRecordButton) {\r\n                this._playButton.style.display = \"\";\r\n                this._recordButton.style.display = \"\";\r\n                this._playButton.classList.add(\"shrunk\");\r\n                this._recordButton.classList.add(\"shrunk\");\r\n            } else if (this._ctrlHeld) {\r\n                this._recordButton.style.display = \"\";\r\n            } else {\r\n                this._playButton.style.display = \"\";\r\n            }\r\n        }\r\n        window.requestAnimationFrame(this.updatePlayButton);\r\n    }\r\n\r\n    private _disableCtrlContextMenu = (event: MouseEvent): boolean => {\r\n        // On a Mac, clicking while holding control opens the right-click context menu.\r\n        // But in the pattern and track editors I'd rather prevent that and instead allow\r\n        // custom behaviors such as setting the volume of a note.\r\n        if (event.ctrlKey) {\r\n            event.preventDefault();\r\n            return false;\r\n        }\r\n        return true;\r\n    }\r\n\r\n    private _usageCheck(channelIndex: number, instrumentIndex: number): void {\r\n        var instrumentUsed = false;\r\n        var patternUsed = false;\r\n        var modUsed = false;\r\n        const channel: Channel = this._doc.song.channels[channelIndex];\r\n\r\n        if (channelIndex < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount) {\r\n            for (let modChannelIdx: number = this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount; modChannelIdx < this._doc.song.channels.length; modChannelIdx++) {\r\n                const modChannel: Channel = this._doc.song.channels[modChannelIdx];\r\n                const patternIdx = modChannel.bars[this._doc.bar];\r\n                if (patternIdx > 0) {\r\n                    const modInstrumentIdx: number = modChannel.patterns[patternIdx - 1].instruments[0];\r\n                    const modInstrument: Instrument = modChannel.instruments[modInstrumentIdx];\r\n                    for (let mod: number = 0; mod < Config.modCount; mod++) {\r\n                        if (modInstrument.modChannels[mod] == channelIndex && (modInstrument.modInstruments[mod] == instrumentIndex || modInstrument.modInstruments[mod] >= channel.instruments.length)) {\r\n                            modUsed = true;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        if (channel.bars[this._doc.bar] != 0) {\r\n\r\n            let lowestSelX: number = Math.min(this._doc.selection.boxSelectionX0, this._doc.selection.boxSelectionX1);\r\n            let highestSelX: number = Math.max(this._doc.selection.boxSelectionX0, this._doc.selection.boxSelectionX1);\r\n            let lowestSelY: number = Math.min(this._doc.selection.boxSelectionY0, this._doc.selection.boxSelectionY1);\r\n            let highestSelY: number = Math.max(this._doc.selection.boxSelectionY0, this._doc.selection.boxSelectionY1);\r\n\r\n            for (let i: number = 0; i < this._doc.song.barCount; i++) {\r\n                // Check for this exact bar in another place, but only count it if it's not within the selection\r\n                if (channel.bars[i] == channel.bars[this._doc.bar] && i != this._doc.bar &&\r\n                    (i < lowestSelX || i > highestSelX || this._doc.channel < lowestSelY || this._doc.channel > highestSelY)) {\r\n\r\n                    patternUsed = true;\r\n                    i = this._doc.song.barCount;\r\n                }\r\n            }\r\n\r\n            for (let i: number = 0; i < this._doc.song.barCount; i++) {\r\n                // Check for this exact instrument in another place, but only count it if it's not within the selection\r\n                if (channel.bars[i] != 0 && channel.bars[i] != channel.bars[this._doc.bar] &&\r\n                    channel.patterns[channel.bars[i] - 1].instruments.includes(instrumentIndex) && i != this._doc.bar &&\r\n                    (i < lowestSelX || i > highestSelX || this._doc.channel < lowestSelY || this._doc.channel > highestSelY)) {\r\n\r\n                    instrumentUsed = true;\r\n                    i = this._doc.song.barCount;\r\n                }\r\n            }\r\n\r\n        }\r\n\r\n        if (patternUsed) {\r\n            this._usedPatternIndicator.style.setProperty(\"fill\", ColorConfig.indicatorPrimary);\r\n        }\r\n        else {\r\n            this._usedPatternIndicator.style.setProperty(\"fill\", ColorConfig.indicatorSecondary);\r\n        }\r\n        if (instrumentUsed) {\r\n            this._usedInstrumentIndicator.style.setProperty(\"fill\", ColorConfig.indicatorPrimary);\r\n        }\r\n        else {\r\n            this._usedInstrumentIndicator.style.setProperty(\"fill\", ColorConfig.indicatorSecondary);\r\n        }\r\n        if (modUsed) {\r\n            this._jumpToModIndicator.style.setProperty(\"display\", \"\");\r\n            this._jumpToModIndicator.style.setProperty(\"fill\", ColorConfig.indicatorPrimary);\r\n            this._jumpToModIndicator.classList.add(\"modTarget\");\r\n        }\r\n        else if (channelIndex < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount) {\r\n            this._jumpToModIndicator.style.setProperty(\"display\", \"\");\r\n            this._jumpToModIndicator.style.setProperty(\"fill\", ColorConfig.indicatorSecondary);\r\n            this._jumpToModIndicator.classList.remove(\"modTarget\");\r\n        } else {\r\n            this._jumpToModIndicator.style.setProperty(\"display\", \"none\");\r\n        }\r\n\r\n    }\r\n\r\n    private _tempoStepperCaptureNumberKeys = (event: KeyboardEvent): void => {\r\n        // When the number input is in focus, allow some keyboard events to\r\n        // edit the input without accidentally editing the song otherwise.\r\n        switch (event.keyCode) {\r\n            case 8: // backspace/delete\r\n            case 13: // enter/return\r\n            case 38: // up\r\n            case 40: // down\r\n            case 37: // left\r\n            case 39: // right\r\n            case 48: // 0\r\n            case 49: // 1\r\n            case 50: // 2\r\n            case 51: // 3\r\n            case 52: // 4\r\n            case 53: // 5\r\n            case 54: // 6\r\n            case 55: // 7\r\n            case 56: // 8\r\n            case 57: // 9\r\n                event.stopPropagation();\r\n                break;\r\n        }\r\n    }\r\n\r\n    private _whenKeyPressed = (event: KeyboardEvent): void => {\r\n        this._ctrlHeld = event.ctrlKey;\r\n\r\n        if (this.prompt) {\r\n            if (this.prompt instanceof CustomChipPrompt || this.prompt instanceof LimiterPrompt || this.prompt instanceof CustomFilterPrompt) {\r\n                this.prompt.whenKeyPressed(event);\r\n            }\r\n            if (event.keyCode == 27) { // ESC key\r\n                // close prompt.\r\n                this._doc.undo();\r\n            }\r\n            return;\r\n        }\r\n\r\n        // Defer to actively editing song title, channel name, or mod label\r\n        if (document.activeElement == this._songTitleInputBox.input || this._patternEditor.editingModLabel || document.activeElement == this._muteEditor._channelNameInput.input) {\r\n            // Enter/esc returns focus to form\r\n            if (event.keyCode == 13 || event.keyCode == 27) {\r\n                this.mainLayer.focus();\r\n                this._patternEditor.stopEditingModLabel(event.keyCode == 27);\r\n            }\r\n\r\n            return;\r\n        }\r\n\r\n        // Defer to actively editing volume/pan rows\r\n        if (document.activeElement == this._panSliderInputBox || document.activeElement == this._detuneSliderInputBox || document.activeElement == this._instrumentVolumeSliderInputBox) {\r\n            // Enter/esc returns focus to form\r\n            if (event.keyCode == 13 || event.keyCode == 27) {\r\n                this.mainLayer.focus();\r\n            }\r\n\r\n            return;\r\n        }\r\n\r\n        if (this._doc.synth.recording) {\r\n            // The only valid keyboard interactions when recording are playing notes or pressing space OR P to stop.\r\n            if (!event.ctrlKey && !event.metaKey) {\r\n                this._keyboardLayout.handleKeyEvent(event, true);\r\n            }\r\n            if (event.keyCode == 32) { // space\r\n                this._toggleRecord();\r\n                event.preventDefault();\r\n                this.refocusStage();\r\n            } else if (event.keyCode == 80 && (event.ctrlKey || event.metaKey)) { // p\r\n                this._toggleRecord();\r\n                event.preventDefault();\r\n                this.refocusStage();\r\n            }\r\n            return;\r\n        }\r\n\r\n        const needControlForShortcuts: boolean = (this._doc.prefs.pressControlForShortcuts != event.getModifierState(\"CapsLock\"));\r\n        const canPlayNotes: boolean = (!event.ctrlKey && !event.metaKey && needControlForShortcuts);\r\n        if (canPlayNotes) this._keyboardLayout.handleKeyEvent(event, true);\r\n\r\n        //this._trackEditor.onKeyPressed(event);\r\n        switch (event.keyCode) {\r\n            case 27: // ESC key\r\n                if (!event.ctrlKey && !event.metaKey) {\r\n                    new ChangePatternSelection(this._doc, 0, 0);\r\n                    this._doc.selection.resetBoxSelection();\r\n                }\r\n                break;\r\n            case 16: // Shift\r\n                this._patternEditor.shiftMode = true;\r\n                break;\r\n            case 17: // Ctrl\r\n                this._patternEditor.controlMode = true;\r\n                break;\r\n            case 32: // space\r\n                if (event.ctrlKey) {\r\n                    this._toggleRecord();\r\n                } else if (event.shiftKey) {\r\n                    // Jump to mouse\r\n                    if (this._trackEditor.movePlayheadToMouse() || this._patternEditor.movePlayheadToMouse()) {\r\n                        if (!this._doc.synth.playing) this._doc.performance.play();\r\n                    }\r\n                } else {\r\n                    this.togglePlay();\r\n                }\r\n                event.preventDefault();\r\n                this.refocusStage();\r\n                break;\r\n            case 80: // p\r\n                if (canPlayNotes) break;\r\n                if (event.ctrlKey || event.metaKey) {\r\n                    this._toggleRecord();\r\n                    event.preventDefault();\r\n                    this.refocusStage();\r\n                }\r\n                break;\r\n            case 90: // z\r\n                if (canPlayNotes) break;\r\n                if (event.shiftKey) {\r\n                    this._doc.redo();\r\n                } else {\r\n                    this._doc.undo();\r\n                }\r\n                event.preventDefault();\r\n                break;\r\n            case 89: // y\r\n                if (canPlayNotes) break;\r\n                this._doc.redo();\r\n                event.preventDefault();\r\n                break;\r\n            case 67: // c\r\n                if (canPlayNotes) break;\r\n                if (event.shiftKey) {\r\n                    this._copyInstrument();\r\n                } else {\r\n                    this._doc.selection.copy();\r\n                }\r\n                this._doc.selection.resetBoxSelection();\r\n                this._doc.selection.selectionUpdated();\r\n                event.preventDefault();\r\n                break;\r\n            case 13: // enter/return\r\n                if (event.ctrlKey || event.metaKey) {\r\n                    this._doc.selection.insertChannel();\r\n                } else {\r\n                    this._doc.selection.insertBars();\r\n                }\r\n                event.preventDefault();\r\n                break;\r\n            case 8: // backspace/delete\r\n                if (event.ctrlKey || event.metaKey) {\r\n                    this._doc.selection.deleteChannel();\r\n                } else {\r\n                    this._doc.selection.deleteBars();\r\n                }\r\n                this._barScrollBar.animatePlayhead();\r\n                event.preventDefault();\r\n                break;\r\n            case 65: // a\r\n                if (canPlayNotes) break;\r\n                if (event.shiftKey) {\r\n                    this._doc.selection.selectChannel();\r\n                } else {\r\n                    this._doc.selection.selectAll();\r\n                }\r\n                event.preventDefault();\r\n                break;\r\n            case 68: // d\r\n                if (canPlayNotes) break;\r\n                if (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n                    this._doc.selection.duplicatePatterns();\r\n                    event.preventDefault();\r\n                }\r\n                break;\r\n            case 69: // e (+shift: eq filter settings)\r\n                if (event.shiftKey) {\r\n                    const instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n                    if (!instrument.eqFilterType && this._doc.channel < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount)\r\n                        this._openPrompt(\"customEQFilterSettings\");\r\n                }\r\n                break;\r\n            case 70: // f\r\n                if (canPlayNotes) break;\r\n                if (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n                    this._doc.synth.snapToStart();\r\n                    this._doc.synth.computeLatestModValues();\r\n                    if (this._doc.prefs.autoFollow) {\r\n                        this._doc.selection.setChannelBar(this._doc.channel, Math.floor(this._doc.synth.playhead));\r\n                    }\r\n                    event.preventDefault();\r\n                }\r\n                break;\r\n            case 72: // h\r\n                if (canPlayNotes) break;\r\n                if (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n                    this._doc.synth.goToBar(this._doc.bar);\r\n                    this._doc.synth.snapToBar();\r\n                    this._doc.synth.computeLatestModValues();\r\n                    if (this._doc.prefs.autoFollow) {\r\n                        this._doc.selection.setChannelBar(this._doc.channel, Math.floor(this._doc.synth.playhead));\r\n                    }\r\n                    event.preventDefault();\r\n                }\r\n                break;\r\n            case 74: // j\r\n                if (canPlayNotes) break;\r\n                // Ctrl Alt Shift J: Jummbify - set all prefs to my preferred ones lol\r\n                if (event.shiftKey && event.ctrlKey && event.altKey) {\r\n                    this._doc.prefs.autoPlay = false;\r\n                    this._doc.prefs.autoFollow = false;\r\n                    this._doc.prefs.enableNotePreview = true;\r\n                    this._doc.prefs.showFifth = true;\r\n                    this._doc.prefs.notesOutsideScale = false;\r\n                    this._doc.prefs.defaultScale = 0;\r\n                    this._doc.prefs.showLetters = true;\r\n                    this._doc.prefs.showChannels = true;\r\n                    this._doc.prefs.showScrollBar = true;\r\n                    this._doc.prefs.alwaysFineNoteVol = false;\r\n                    this._doc.prefs.enableChannelMuting = true;\r\n                    this._doc.prefs.displayBrowserUrl = false;\r\n                    this._doc.prefs.displayVolumeBar = true;\r\n                    this._doc.prefs.layout = \"wide\";\r\n                    this._doc.prefs.visibleOctaves = 5;\r\n                    this._doc.prefs.save();\r\n                    event.preventDefault();\r\n                    location.reload();\r\n                }\r\n                break;\r\n            case 76: // l\r\n                if (canPlayNotes) break;\r\n                if (event.shiftKey) {\r\n                    this._openPrompt(\"limiterSettings\");\r\n                }\r\n                else {\r\n                    this._openPrompt(\"barCount\");\r\n                }\r\n                break;\r\n            case 77: // m\r\n                if (canPlayNotes) break;\r\n                if (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n                    if (this._doc.prefs.enableChannelMuting) {\r\n                        this._doc.selection.muteChannels(event.shiftKey);\r\n                        event.preventDefault();\r\n                    }\r\n                }\r\n                break;\r\n            case 78: // n\r\n                if (canPlayNotes) break;\r\n                // Find lowest-index unused pattern for current channel\r\n                // Ctrl+n - lowest-index completely empty pattern\r\n                // Shift+n - note filter settings\r\n\r\n                const group: ChangeGroup = new ChangeGroup();\r\n\r\n                if (event.shiftKey) {\r\n                    const instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n                    if (effectsIncludeNoteFilter(instrument.effects) && !instrument.noteFilterType && this._doc.channel < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount)\r\n                        this._openPrompt(\"customNoteFilterSettings\");\r\n                    break;\r\n                }\r\n                else if (event.ctrlKey) {\r\n                    let nextEmpty: number = 0;\r\n                    while (nextEmpty < this._doc.song.patternsPerChannel && this._doc.song.channels[this._doc.channel].patterns[nextEmpty].notes.length > 0)\r\n                        nextEmpty++;\r\n\r\n                    nextEmpty++; // The next empty pattern is actually the one after the found one\r\n\r\n                    // Can't set anything if we're at the absolute limit.\r\n                    if (nextEmpty <= Config.barCountMax) {\r\n\r\n                        if (nextEmpty > this._doc.song.patternsPerChannel) {\r\n\r\n                            // Add extra empty pattern, if all the rest have something in them.\r\n                            group.append(new ChangePatternsPerChannel(this._doc, nextEmpty));\r\n                        }\r\n\r\n                        // Change pattern number to lowest-index unused\r\n                        group.append(new ChangePatternNumbers(this._doc, nextEmpty, this._doc.bar, this._doc.channel, 1, 1));\r\n\r\n\r\n                    }\r\n                }\r\n                else {\r\n                    let nextUnused: number = 1;\r\n                    while (this._doc.song.channels[this._doc.channel].bars.indexOf(nextUnused) != -1\r\n                        && nextUnused <= this._doc.song.patternsPerChannel)\r\n                        nextUnused++;\r\n\r\n                    // Can't set anything if we're at the absolute limit.\r\n                    if (nextUnused <= Config.barCountMax) {\r\n\r\n                        if (nextUnused > this._doc.song.patternsPerChannel) {\r\n\r\n                            // Add extra empty pattern, if all the rest are used.\r\n                            group.append(new ChangePatternsPerChannel(this._doc, nextUnused));\r\n                        }\r\n\r\n                        // Change pattern number to lowest-index unused\r\n                        group.append(new ChangePatternNumbers(this._doc, nextUnused, this._doc.bar, this._doc.channel, 1, 1));\r\n\r\n                    }\r\n                }\r\n\r\n                this._doc.record(group);\r\n\r\n                event.preventDefault();\r\n                break;\r\n            case 81: // q\r\n                if (canPlayNotes) break;\r\n                if (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n                    this._openPrompt(\"channelSettings\");\r\n                    event.preventDefault();\r\n                }\r\n                break;\r\n            case 83: // s\r\n                if (canPlayNotes) break;\r\n                if (event.ctrlKey || event.metaKey) {\r\n                    this._openPrompt(\"export\");\r\n                    event.preventDefault();\r\n                } else {\r\n                    if (this._doc.prefs.enableChannelMuting) {\r\n                        // JummBox deviation: I like shift+s as just another mute toggle personally.\r\n                        // Easier to reach than M and the shift+s invert functionality I am overwriting could be \r\n                        // obtained with M anyway. Useability-wise you very often want to 'add' channels on to a solo as you work.\r\n                        if (event.shiftKey) {\r\n                            this._doc.selection.muteChannels(false);\r\n                        } else {\r\n                            this._doc.selection.soloChannels(false);\r\n                        }\r\n                        event.preventDefault();\r\n                    }\r\n                }\r\n                break;\r\n            case 79: // o\r\n                if (canPlayNotes) break;\r\n                if (event.ctrlKey || event.metaKey) {\r\n                    this._openPrompt(\"import\");\r\n                    event.preventDefault();\r\n                }\r\n                break;\r\n            case 86: // v\r\n                if (canPlayNotes) break;\r\n                if ((event.ctrlKey || event.metaKey) && event.shiftKey && !needControlForShortcuts) {\r\n                    this._doc.selection.pasteNumbers();\r\n                } else if (event.shiftKey) {\r\n                    this._pasteInstrument();\r\n                } else {\r\n                    this._doc.selection.pasteNotes();\r\n                }\r\n                event.preventDefault();\r\n                break;\r\n            case 87: // w\r\n                if (canPlayNotes) break;\r\n                this._openPrompt(\"moveNotesSideways\");\r\n                break;\r\n            case 73: // i\r\n                if (canPlayNotes) break;\r\n                if (needControlForShortcuts == (event.ctrlKey || event.metaKey) && event.shiftKey) {\r\n                    // Copy the current instrument as a preset to the clipboard.\r\n                    const instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n                    const instrumentObject: any = instrument.toJsonObject();\r\n                    delete instrumentObject[\"preset\"];\r\n                    // Volume and the panning effect are not included in presets.\r\n                    delete instrumentObject[\"volume\"];\r\n                    delete instrumentObject[\"pan\"];\r\n                    const panningEffectIndex: number = instrumentObject[\"effects\"].indexOf(Config.effectNames[EffectType.panning]);\r\n                    if (panningEffectIndex != -1) instrumentObject[\"effects\"].splice(panningEffectIndex, 1);\r\n                    for (let i: number = 0; i < instrumentObject[\"envelopes\"].length; i++) {\r\n                        const envelope: any = instrumentObject[\"envelopes\"][i];\r\n                        // If there are any envelopes targeting panning or none, remove those too.\r\n                        if (envelope[\"target\"] == \"panning\" || envelope[\"target\"] == \"none\" || envelope[\"envelope\"] == \"none\") {\r\n                            instrumentObject[\"envelopes\"].splice(i, 1);\r\n                            i--;\r\n                        }\r\n                    }\r\n                    this._copyTextToClipboard(JSON.stringify(instrumentObject));\r\n                    event.preventDefault();\r\n                }\r\n                break;\r\n            case 82: // r\r\n                if (canPlayNotes) break;\r\n                if (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n                    if (event.shiftKey) {\r\n                        this._randomGenerated();\r\n                    } else {\r\n                        this._randomPreset();\r\n                    }\r\n                    event.preventDefault();\r\n                }\r\n                break;\r\n            case 219: // left brace\r\n                if (canPlayNotes) break;\r\n                if (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n                    this._doc.synth.goToPrevBar();\r\n                    if (this._doc.prefs.autoFollow) {\r\n                        this._doc.selection.setChannelBar(this._doc.channel, Math.floor(this._doc.synth.playhead));\r\n                    }\r\n                    event.preventDefault();\r\n                }\r\n                break;\r\n            case 221: // right brace\r\n                if (canPlayNotes) break;\r\n                if (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n                    this._doc.synth.goToNextBar();\r\n                    if (this._doc.prefs.autoFollow) {\r\n                        this._doc.selection.setChannelBar(this._doc.channel, Math.floor(this._doc.synth.playhead));\r\n                    }\r\n                    event.preventDefault();\r\n                }\r\n                break;\r\n            case 189: // -\r\n            case 173: // Firefox -\r\n                if (canPlayNotes) break;\r\n                if (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n                    this._doc.selection.transpose(false, event.shiftKey);\r\n                    event.preventDefault();\r\n                }\r\n                break;\r\n            case 187: // +\r\n            case 61: // Firefox +\r\n            case 171: // Some users have this as +? Hmm.\r\n                if (canPlayNotes) break;\r\n                if (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n                    this._doc.selection.transpose(true, event.shiftKey);\r\n                    event.preventDefault();\r\n                }\r\n                break;\r\n            case 38: // up\r\n                if (event.ctrlKey || event.metaKey) {\r\n                    this._doc.selection.swapChannels(-1);\r\n                } else if (event.shiftKey) {\r\n                    this._doc.selection.boxSelectionY1 = Math.max(0, this._doc.selection.boxSelectionY1 - 1);\r\n                    this._doc.selection.scrollToEndOfSelection();\r\n                    this._doc.selection.selectionUpdated();\r\n                } else {\r\n                    this._doc.selection.setChannelBar((this._doc.channel - 1 + this._doc.song.getChannelCount()) % this._doc.song.getChannelCount(), this._doc.bar);\r\n                    this._doc.selection.resetBoxSelection();\r\n                }\r\n                event.preventDefault();\r\n                break;\r\n            case 40: // down\r\n                if (event.ctrlKey || event.metaKey) {\r\n                    this._doc.selection.swapChannels(1);\r\n                } else if (event.shiftKey) {\r\n                    this._doc.selection.boxSelectionY1 = Math.min(this._doc.song.getChannelCount() - 1, this._doc.selection.boxSelectionY1 + 1);\r\n                    this._doc.selection.scrollToEndOfSelection();\r\n                    this._doc.selection.selectionUpdated();\r\n                } else {\r\n                    this._doc.selection.setChannelBar((this._doc.channel + 1) % this._doc.song.getChannelCount(), this._doc.bar);\r\n                    this._doc.selection.resetBoxSelection();\r\n                }\r\n                event.preventDefault();\r\n                break;\r\n            case 37: // left\r\n                if (event.shiftKey) {\r\n                    this._doc.selection.boxSelectionX1 = Math.max(0, this._doc.selection.boxSelectionX1 - 1);\r\n                    this._doc.selection.scrollToEndOfSelection();\r\n                    this._doc.selection.selectionUpdated();\r\n                } else {\r\n                    this._doc.selection.setChannelBar(this._doc.channel, (this._doc.bar + this._doc.song.barCount - 1) % this._doc.song.barCount);\r\n                    this._doc.selection.resetBoxSelection();\r\n                }\r\n                event.preventDefault();\r\n                break;\r\n            case 39: // right\r\n                if (event.shiftKey) {\r\n                    this._doc.selection.boxSelectionX1 = Math.min(this._doc.song.barCount - 1, this._doc.selection.boxSelectionX1 + 1);\r\n                    this._doc.selection.scrollToEndOfSelection();\r\n                    this._doc.selection.selectionUpdated();\r\n                } else {\r\n                    this._doc.selection.setChannelBar(this._doc.channel, (this._doc.bar + 1) % this._doc.song.barCount);\r\n                    this._doc.selection.resetBoxSelection();\r\n                }\r\n                event.preventDefault();\r\n                break;\r\n            case 46: // Delete\r\n                this._doc.selection.digits = \"\";\r\n                this._doc.selection.nextDigit(\"0\", false, false);\r\n                break;\r\n            case 48: // 0\r\n                if (canPlayNotes) break;\r\n                this._doc.selection.nextDigit(\"0\", needControlForShortcuts != (event.shiftKey || event.ctrlKey || event.metaKey), event.altKey);\r\n                this._renderInstrumentBar(this._doc.song.channels[this._doc.channel], this._doc.getCurrentInstrument(), ColorConfig.getChannelColor(this._doc.song, this._doc.channel));\r\n                event.preventDefault();\r\n                break;\r\n            case 49: // 1\r\n                if (canPlayNotes) break;\r\n                this._doc.selection.nextDigit(\"1\", needControlForShortcuts != (event.shiftKey || event.ctrlKey || event.metaKey), event.altKey);\r\n                this._renderInstrumentBar(this._doc.song.channels[this._doc.channel], this._doc.getCurrentInstrument(), ColorConfig.getChannelColor(this._doc.song, this._doc.channel));\r\n                event.preventDefault();\r\n                break;\r\n            case 50: // 2\r\n                if (canPlayNotes) break;\r\n                this._doc.selection.nextDigit(\"2\", needControlForShortcuts != (event.shiftKey || event.ctrlKey || event.metaKey), event.altKey);\r\n                this._renderInstrumentBar(this._doc.song.channels[this._doc.channel], this._doc.getCurrentInstrument(), ColorConfig.getChannelColor(this._doc.song, this._doc.channel));\r\n                event.preventDefault();\r\n                break;\r\n            case 51: // 3\r\n                if (canPlayNotes) break;\r\n                this._doc.selection.nextDigit(\"3\", needControlForShortcuts != (event.shiftKey || event.ctrlKey || event.metaKey), event.altKey);\r\n                this._renderInstrumentBar(this._doc.song.channels[this._doc.channel], this._doc.getCurrentInstrument(), ColorConfig.getChannelColor(this._doc.song, this._doc.channel));\r\n                event.preventDefault();\r\n                break;\r\n            case 52: // 4\r\n                if (canPlayNotes) break;\r\n                this._doc.selection.nextDigit(\"4\", needControlForShortcuts != (event.shiftKey || event.ctrlKey || event.metaKey), event.altKey);\r\n                this._renderInstrumentBar(this._doc.song.channels[this._doc.channel], this._doc.getCurrentInstrument(), ColorConfig.getChannelColor(this._doc.song, this._doc.channel));\r\n                event.preventDefault();\r\n                break;\r\n            case 53: // 5\r\n                if (canPlayNotes) break;\r\n                this._doc.selection.nextDigit(\"5\", needControlForShortcuts != (event.shiftKey || event.ctrlKey || event.metaKey), event.altKey);\r\n                this._renderInstrumentBar(this._doc.song.channels[this._doc.channel], this._doc.getCurrentInstrument(), ColorConfig.getChannelColor(this._doc.song, this._doc.channel));\r\n                event.preventDefault();\r\n                break;\r\n            case 54: // 6\r\n                if (canPlayNotes) break;\r\n                this._doc.selection.nextDigit(\"6\", needControlForShortcuts != (event.shiftKey || event.ctrlKey || event.metaKey), event.altKey);\r\n                this._renderInstrumentBar(this._doc.song.channels[this._doc.channel], this._doc.getCurrentInstrument(), ColorConfig.getChannelColor(this._doc.song, this._doc.channel));\r\n                event.preventDefault();\r\n                break;\r\n            case 55: // 7\r\n                if (canPlayNotes) break;\r\n                this._doc.selection.nextDigit(\"7\", needControlForShortcuts != (event.shiftKey || event.ctrlKey || event.metaKey), event.altKey);\r\n                this._renderInstrumentBar(this._doc.song.channels[this._doc.channel], this._doc.getCurrentInstrument(), ColorConfig.getChannelColor(this._doc.song, this._doc.channel));\r\n                event.preventDefault();\r\n                break;\r\n            case 56: // 8\r\n                if (canPlayNotes) break;\r\n                this._doc.selection.nextDigit(\"8\", needControlForShortcuts != (event.shiftKey || event.ctrlKey || event.metaKey), event.altKey);\r\n                this._renderInstrumentBar(this._doc.song.channels[this._doc.channel], this._doc.getCurrentInstrument(), ColorConfig.getChannelColor(this._doc.song, this._doc.channel));\r\n                event.preventDefault();\r\n                break;\r\n            case 57: // 9\r\n                if (canPlayNotes) break;\r\n                this._doc.selection.nextDigit(\"9\", needControlForShortcuts != (event.shiftKey || event.ctrlKey || event.metaKey), event.altKey);\r\n                this._renderInstrumentBar(this._doc.song.channels[this._doc.channel], this._doc.getCurrentInstrument(), ColorConfig.getChannelColor(this._doc.song, this._doc.channel));\r\n                event.preventDefault();\r\n                break;\r\n            default:\r\n                this._doc.selection.digits = \"\";\r\n                this._doc.selection.instrumentDigits = \"\";\r\n                break;\r\n        }\r\n\r\n        if (canPlayNotes) {\r\n            this._doc.selection.digits = \"\";\r\n            this._doc.selection.instrumentDigits = \"\";\r\n        }\r\n    }\r\n\r\n\r\n    private _whenKeyReleased = (event: KeyboardEvent): void => {\r\n        this._muteEditor.onKeyUp(event);\r\n        if (!event.ctrlKey) { // Ctrl\r\n            this._patternEditor.controlMode = false;\r\n        }\r\n        if (!event.shiftKey) { // Shift\r\n            this._patternEditor.shiftMode = false;\r\n        }\r\n\r\n        this._ctrlHeld = event.ctrlKey;\r\n        // Release live pitches regardless of control or caps lock so that any pitches played before will get released even if the modifier keys changed.\r\n        this._keyboardLayout.handleKeyEvent(event, false);\r\n    }\r\n\r\n    private _copyTextToClipboard(text: string): void {\r\n        // Set as any to allow compilation without clipboard types (since, uh, I didn't write this bit and don't know the proper types library) -jummbus\r\n        let nav: any;\r\n        nav = navigator;\r\n\r\n        if (nav.clipboard && nav.clipboard.writeText) {\r\n            nav.clipboard.writeText(text).catch(() => {\r\n                window.prompt(\"Copy to clipboard:\", text);\r\n            });\r\n            return;\r\n        }\r\n        const textField: HTMLTextAreaElement = document.createElement(\"textarea\");\r\n        textField.textContent = text;\r\n        document.body.appendChild(textField);\r\n        textField.select();\r\n        const succeeded: boolean = document.execCommand(\"copy\");\r\n        textField.remove();\r\n        this.refocusStage();\r\n        if (!succeeded) window.prompt(\"Copy this:\", text);\r\n    }\r\n\r\n    private _whenPrevBarPressed = (): void => {\r\n        this._doc.synth.goToPrevBar();\r\n        this._barScrollBar.animatePlayhead();\r\n    }\r\n\r\n    private _whenNextBarPressed = (): void => {\r\n        this._doc.synth.goToNextBar();\r\n        this._barScrollBar.animatePlayhead();\r\n    }\r\n\r\n    public togglePlay = (): void => {\r\n        if (this._doc.synth.playing) {\r\n            this._doc.performance.pause();\r\n            this.outVolumeHistoricCap = 0;\r\n        } else {\r\n            this._doc.synth.snapToBar();\r\n            this._doc.performance.play();\r\n        }\r\n    }\r\n\r\n    private _toggleRecord = (): void => {\r\n        if (this._doc.synth.playing) {\r\n            this._doc.performance.pause();\r\n        } else {\r\n            this._doc.performance.record();\r\n        }\r\n    }\r\n\r\n    public _animate = (): void => {\r\n        // Need to update mods once more to clear the slider display\r\n        this._modSliderUpdate();\r\n        // Same for volume display\r\n        if (this._doc.prefs.displayVolumeBar) {\r\n            this._volumeUpdate();\r\n        }\r\n        // ...and barscrollbar playhead\r\n        this._barScrollBar.animatePlayhead();\r\n        // ...and filters\r\n        if (this._doc.synth.isFilterModActive(false, this._doc.channel, this._doc.getCurrentInstrument())) {\r\n            this._eqFilterEditor.render(true);\r\n        }\r\n        if (this._doc.synth.isFilterModActive(true, this._doc.channel, this._doc.getCurrentInstrument())) {\r\n            this._noteFilterEditor.render(true);\r\n        }\r\n\r\n\r\n        window.requestAnimationFrame(this._animate);\r\n    }\r\n\r\n    public _volumeUpdate = (): void => {\r\n        this.outVolumeHistoricTimer--;\r\n        if (this.outVolumeHistoricTimer <= 0) {\r\n            this.outVolumeHistoricCap -= 0.03;\r\n        }\r\n        if (this._doc.song.outVolumeCap > this.outVolumeHistoricCap) {\r\n            this.outVolumeHistoricCap = this._doc.song.outVolumeCap;\r\n            this.outVolumeHistoricTimer = 50;\r\n        }\r\n\r\n        if (this._doc.song.outVolumeCap != this.lastOutVolumeCap) {\r\n            this.lastOutVolumeCap = this._doc.song.outVolumeCap;\r\n            this._animateVolume(this._doc.song.outVolumeCap, this.outVolumeHistoricCap);\r\n        }\r\n    }\r\n\r\n    private _animateVolume(outVolumeCap: number, historicOutCap: number): void {\r\n        this._outVolumeBar.setAttribute(\"width\", \"\" + Math.min(144, outVolumeCap * 144));\r\n        this._outVolumeCap.setAttribute(\"x\", \"\" + (8 + Math.min(144, historicOutCap * 144)));\r\n    }\r\n\r\n    private _setVolumeSlider = (): void => {\r\n        this._doc.setVolume(Number(this._volumeSlider.input.value));\r\n    }\r\n\r\n    private _copyInstrument = (): void => {\r\n        const channel: Channel = this._doc.song.channels[this._doc.channel];\r\n        const instrument: Instrument = channel.instruments[this._doc.getCurrentInstrument()];\r\n        const instrumentCopy: any = instrument.toJsonObject();\r\n        instrumentCopy[\"isDrum\"] = this._doc.song.getChannelIsNoise(this._doc.channel);\r\n        window.localStorage.setItem(\"instrumentCopy\", JSON.stringify(instrumentCopy));\r\n        this.refocusStage();\r\n    }\r\n\r\n    private _pasteInstrument = (): void => {\r\n        const channel: Channel = this._doc.song.channels[this._doc.channel];\r\n        const instrument: Instrument = channel.instruments[this._doc.getCurrentInstrument()];\r\n        const instrumentCopy: any = JSON.parse(String(window.localStorage.getItem(\"instrumentCopy\")));\r\n        if (instrumentCopy != null && instrumentCopy[\"isDrum\"] == this._doc.song.getChannelIsNoise(this._doc.channel)) {\r\n            this._doc.record(new ChangePasteInstrument(this._doc, instrument, instrumentCopy));\r\n        }\r\n        this.refocusStage();\r\n    }\r\n\r\n    private _switchEQFilterType(toSimple: boolean) {\r\n        const channel: Channel = this._doc.song.channels[this._doc.channel];\r\n        const instrument: Instrument = channel.instruments[this._doc.getCurrentInstrument()];\r\n        if (instrument.eqFilterType != toSimple) {\r\n            this._doc.record(new ChangeEQFilterType(this._doc, instrument, toSimple));\r\n        }\r\n    }\r\n\r\n    private _switchNoteFilterType(toSimple: boolean) {\r\n        const channel: Channel = this._doc.song.channels[this._doc.channel];\r\n        const instrument: Instrument = channel.instruments[this._doc.getCurrentInstrument()];\r\n        if (instrument.noteFilterType != toSimple) {\r\n            this._doc.record(new ChangeNoteFilterType(this._doc, instrument, toSimple));\r\n        }\r\n    }\r\n\r\n    private _randomPreset(): void {\r\n        const isNoise: boolean = this._doc.song.getChannelIsNoise(this._doc.channel);\r\n        this._doc.record(new ChangePreset(this._doc, pickRandomPresetValue(isNoise)));\r\n    }\r\n\r\n    private _randomGenerated(): void {\r\n        this._doc.record(new ChangeRandomGeneratedInstrument(this._doc));\r\n    }\r\n\r\n\r\n    private _whenSetTempo = (): void => {\r\n        this._doc.record(new ChangeTempo(this._doc, -1, parseInt(this._tempoStepper.value) | 0));\r\n    }\r\n\r\n    private _whenSetScale = (): void => {\r\n        if (isNaN(<number><unknown>this._scaleSelect.value)) {\r\n            switch (this._scaleSelect.value) {\r\n                case \"forceScale\":\r\n                    this._doc.selection.forceScale();\r\n                    break;\r\n            }\r\n            this._doc.notifier.changed();\r\n        } else {\r\n            this._doc.record(new ChangeScale(this._doc, this._scaleSelect.selectedIndex));\r\n        }\r\n    }\r\n\r\n    private _whenSetKey = (): void => {\r\n        if (isNaN(<number><unknown>this._keySelect.value)) {\r\n            switch (this._keySelect.value) {\r\n                case \"detectKey\":\r\n                    this._doc.record(new ChangeDetectKey(this._doc));\r\n                    break;\r\n            }\r\n            this._doc.notifier.changed();\r\n        } else {\r\n            this._doc.record(new ChangeKey(this._doc, Config.keys.length - 1 - this._keySelect.selectedIndex));\r\n        }\r\n    }\r\n\r\n    private _whenSetRhythm = (): void => {\r\n        if (isNaN(<number><unknown>this._rhythmSelect.value)) {\r\n            switch (this._rhythmSelect.value) {\r\n                case \"forceRhythm\":\r\n                    this._doc.selection.forceRhythm();\r\n                    break;\r\n            }\r\n            this._doc.notifier.changed();\r\n        } else {\r\n            this._doc.record(new ChangeRhythm(this._doc, this._rhythmSelect.selectedIndex));\r\n        }\r\n    }\r\n\r\n    public _refocus = (): void => {\r\n        // Waits a bit because select2 \"steals\" back focus even after the close event fires.\r\n        var selfRef = this;\r\n        setTimeout(function () { selfRef.mainLayer.focus(); }, 20);\r\n    }\r\n\r\n    public _whenSetPitchedPreset = (): void => {\r\n        this._setPreset($('#pitchPresetSelect').val() + \"\");\r\n    }\r\n\r\n    public _whenSetDrumPreset = (): void => {\r\n        this._setPreset($('#drumPresetSelect').val() + \"\");\r\n    }\r\n\r\n    private _setPreset(preset: string): void {\r\n        if (isNaN(<number><unknown>preset)) {\r\n            switch (preset) {\r\n                case \"copyInstrument\":\r\n                    this._copyInstrument();\r\n                    break;\r\n                case \"pasteInstrument\":\r\n                    this._pasteInstrument();\r\n                    break;\r\n                case \"randomPreset\":\r\n                    this._randomPreset();\r\n                    break;\r\n                case \"randomGenerated\":\r\n                    this._randomGenerated();\r\n                    break;\r\n            }\r\n            this._doc.notifier.changed();\r\n        } else {\r\n            this._doc.record(new ChangePreset(this._doc, parseInt(preset)));\r\n        }\r\n    }\r\n\r\n    private _whenSetFeedbackType = (): void => {\r\n        this._doc.record(new ChangeFeedbackType(this._doc, this._feedbackTypeSelect.selectedIndex));\r\n    }\r\n\r\n\r\n    private _whenSetAlgorithm = (): void => {\r\n        this._doc.record(new ChangeAlgorithm(this._doc, this._algorithmSelect.selectedIndex));\r\n    }\r\n\r\n    private _whenSelectInstrument = (event: MouseEvent): void => {\r\n        if (event.target == this._instrumentAddButton) {\r\n            this._doc.record(new ChangeAddChannelInstrument(this._doc));\r\n        } else if (event.target == this._instrumentRemoveButton) {\r\n            this._doc.record(new ChangeRemoveChannelInstrument(this._doc));\r\n        } else {\r\n            const index: number = this._instrumentButtons.indexOf(<any>event.target);\r\n            if (index != -1) {\r\n                this._doc.selection.selectInstrument(index);\r\n            }\r\n            // Force piano to re-show, if channel is modulator\r\n            if (this._doc.channel >= this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount) {\r\n                this._piano.forceRender();\r\n            }\r\n            this._renderInstrumentBar(this._doc.song.channels[this._doc.channel], index, ColorConfig.getChannelColor(this._doc.song, this._doc.channel));\r\n        }\r\n\r\n        this.refocusStage();\r\n    }\r\n\r\n    private _whenSetModChannel = (mod: number): void => {\r\n\r\n        let instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n        let previouslyUnset: boolean = (instrument.modulators[mod] == 0 || Config.modulators[instrument.modulators[mod]].forSong);\r\n\r\n        this._doc.selection.setModChannel(mod, this._modChannelBoxes[mod].selectedIndex);\r\n\r\n        const modChannel: number = Math.max(0, instrument.modChannels[mod]);\r\n\r\n        // Check if setting was 'song' or 'none' and is changing to a channel number, in which case suggested instrument to mod will auto-set to the current one.\r\n        if (this._doc.song.channels[modChannel].instruments.length > 1 && previouslyUnset && this._modChannelBoxes[mod].selectedIndex >= 2) {\r\n            if (this._doc.song.channels[modChannel].bars[this._doc.bar] > 0) {\r\n                this._doc.selection.setModInstrument(mod, this._doc.song.channels[modChannel].patterns[this._doc.song.channels[modChannel].bars[this._doc.bar] - 1].instruments[0]);\r\n            }\r\n        }\r\n\r\n        // Force piano to re-show\r\n        this._piano.forceRender();\r\n    }\r\n\r\n    private _whenSetModInstrument = (mod: number): void => {\r\n        this._doc.selection.setModInstrument(mod, this._modInstrumentBoxes[mod].selectedIndex);\r\n\r\n        // Force piano to re-show\r\n        this._piano.forceRender();\r\n    }\r\n\r\n    private _whenSetModSetting = (mod: number, invalidIndex: boolean = false): void => {\r\n        let text: string = \"none\";\r\n        if (this._modSetBoxes[mod].selectedIndex != -1) {\r\n            text = this._modSetBoxes[mod].children[this._modSetBoxes[mod].selectedIndex].textContent as string;\r\n\r\n            if (invalidIndex) {\r\n                // A setting is invalid (not in instrument's effects). It will be the first index. Allow it, but mark it as red.\r\n                this._modSetBoxes[mod].selectedOptions.item(0)!.style.setProperty(\"color\", \"red\");\r\n                this._modSetBoxes[mod].classList.add(\"invalidSetting\");\r\n                this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()].invalidModulators[mod] = true;\r\n            } else {\r\n                this._modSetBoxes[mod].classList.remove(\"invalidSetting\");\r\n                this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()].invalidModulators[mod] = false;\r\n            }\r\n        }\r\n        if (!invalidIndex) // Invalid index means a set is actually not occurring, just the same index and a warning.\r\n            this._doc.selection.setModSetting(mod, text);\r\n\r\n        // Force piano to re-show if channel is modulator, as text shown on it needs to update\r\n        this._piano.forceRender();\r\n\r\n    }\r\n\r\n    private _whenClickModTarget = (mod: number): void => {\r\n        if (this._modChannelBoxes[mod].selectedIndex >= 2) {\r\n            this._doc.selection.setChannelBar(this._modChannelBoxes[mod].selectedIndex - 2, this._doc.bar);\r\n        }\r\n    }\r\n\r\n    private _whenClickJumpToModTarget = (): void => {\r\n        const channelIndex: number = this._doc.channel;\r\n        const instrumentIndex: number = this._doc.getCurrentInstrument();\r\n        if (channelIndex < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount) {\r\n            for (let modChannelIdx: number = this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount; modChannelIdx < this._doc.song.channels.length; modChannelIdx++) {\r\n                const modChannel: Channel = this._doc.song.channels[modChannelIdx];\r\n                const patternIdx = modChannel.bars[this._doc.bar];\r\n                if (patternIdx > 0) {\r\n                    const modInstrumentIdx: number = modChannel.patterns[patternIdx - 1].instruments[0];\r\n                    const modInstrument: Instrument = modChannel.instruments[modInstrumentIdx];\r\n                    for (let mod: number = 0; mod < Config.modCount; mod++) {\r\n                        if (modInstrument.modChannels[mod] == channelIndex && (modInstrument.modInstruments[mod] == instrumentIndex || modInstrument.modInstruments[mod] >= this._doc.song.channels[channelIndex].instruments.length)) {\r\n                            this._doc.selection.setChannelBar(modChannelIdx, this._doc.bar);\r\n                            return;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    private _whenSetModFilter = (mod: number): void => {\r\n        this._doc.selection.setModFilter(mod, this._modFilterBoxes[mod].selectedIndex);\r\n    }\r\n\r\n    private _whenSetChipWave = (): void => {\r\n        this._doc.record(new ChangeChipWave(this._doc, this._chipWaveSelect.selectedIndex));\r\n    }\r\n\r\n    private _whenSetNoiseWave = (): void => {\r\n        this._doc.record(new ChangeNoiseWave(this._doc, this._chipNoiseSelect.selectedIndex));\r\n    }\r\n\r\n\r\n\r\n    private _whenSetTransition = (): void => {\r\n        this._doc.record(new ChangeTransition(this._doc, this._transitionSelect.selectedIndex));\r\n    }\r\n\r\n    private _whenSetEffects = (): void => {\r\n        const instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n        const oldValue: number = instrument.effects;\r\n        const toggleFlag: number = Config.effectOrder[this._effectsSelect.selectedIndex - 1];\r\n        this._doc.record(new ChangeToggleEffects(this._doc, toggleFlag, null));\r\n        this._effectsSelect.selectedIndex = 0;\r\n        if (instrument.effects > oldValue) {\r\n            this._doc.addedEffect = true;\r\n        }\r\n        this._doc.notifier.changed();\r\n    }\r\n\r\n    private _whenSetVibrato = (): void => {\r\n        this._doc.record(new ChangeVibrato(this._doc, this._vibratoSelect.selectedIndex));\r\n    }\r\n\r\n    private _whenSetVibratoType = (): void => {\r\n        this._doc.record(new ChangeVibratoType(this._doc, this._vibratoTypeSelect.selectedIndex));\r\n    }\r\n\r\n    private _whenSetUnison = (): void => {\r\n        this._doc.record(new ChangeUnison(this._doc, this._unisonSelect.selectedIndex));\r\n    }\r\n\r\n    private _whenSetChord = (): void => {\r\n        this._doc.record(new ChangeChord(this._doc, this._chordSelect.selectedIndex));\r\n    }\r\n\r\n    private _addNewEnvelope = (): void => {\r\n        this._doc.record(new ChangeAddEnvelope(this._doc));\r\n        this.refocusStage();\r\n        this._doc.addedEnvelope = true;\r\n    }\r\n\r\n    private _zoomIn = (): void => {\r\n        this._doc.prefs.visibleOctaves = Math.max(1, this._doc.prefs.visibleOctaves - 1);\r\n        this._doc.prefs.save();\r\n        this._doc.notifier.changed();\r\n        this.refocusStage();\r\n    }\r\n\r\n    private _zoomOut = (): void => {\r\n        this._doc.prefs.visibleOctaves = Math.min(Config.pitchOctaves, this._doc.prefs.visibleOctaves + 1);\r\n        this._doc.prefs.save();\r\n        this._doc.notifier.changed();\r\n        this.refocusStage();\r\n    }\r\n\r\n    private _fileMenuHandler = (event: Event): void => {\r\n        switch (this._fileMenu.value) {\r\n            case \"new\":\r\n                this._doc.goBackToStart();\r\n                this._doc.song.restoreLimiterDefaults();\r\n                for (const channel of this._doc.song.channels) {\r\n                    channel.muted = false;\r\n                    channel.name = \"\";\r\n                }\r\n                this._doc.record(new ChangeSong(this._doc, \"\"), false, true);\r\n                break;\r\n            case \"export\":\r\n                this._openPrompt(\"export\");\r\n                break;\r\n            case \"import\":\r\n                this._openPrompt(\"import\");\r\n                break;\r\n            case \"copyUrl\":\r\n                this._copyTextToClipboard(new URL(\"#\" + this._doc.song.toBase64String(), location.href).href);\r\n                break;\r\n            case \"shareUrl\":\r\n                (<any>navigator).share({ url: new URL(\"#\" + this._doc.song.toBase64String(), location.href).href });\r\n                break;\r\n            case \"shortenUrl\":\r\n                window.open(\"https://tinyurl.com/api-create.php?url=\" + encodeURIComponent(new URL(\"#\" + this._doc.song.toBase64String(), location.href).href));\r\n                break;\r\n            case \"viewPlayer\":\r\n                location.href = \"player/#song=\" + this._doc.song.toBase64String();\r\n                break;\r\n            case \"copyEmbed\":\r\n                this._copyTextToClipboard(`<iframe width=\"384\" height=\"60\" style=\"border: none;\" src=\"${new URL(\"player/#song=\" + this._doc.song.toBase64String(), location.href).href}\"></iframe>`);\r\n                break;\r\n            case \"songRecovery\":\r\n                this._openPrompt(\"songRecovery\");\r\n                break;\r\n        }\r\n        this._fileMenu.selectedIndex = 0;\r\n    }\r\n\r\n    private _editMenuHandler = (event: Event): void => {\r\n        switch (this._editMenu.value) {\r\n            case \"undo\":\r\n                this._doc.undo();\r\n                break;\r\n            case \"redo\":\r\n                this._doc.redo();\r\n                break;\r\n            case \"copy\":\r\n                this._doc.selection.copy();\r\n                break;\r\n            case \"insertBars\":\r\n                this._doc.selection.insertBars();\r\n                break;\r\n            case \"deleteBars\":\r\n                this._doc.selection.deleteBars();\r\n                break;\r\n            case \"insertChannel\":\r\n                this._doc.selection.insertChannel();\r\n                break;\r\n            case \"deleteChannel\":\r\n                this._doc.selection.deleteChannel();\r\n                break;\r\n            case \"pasteNotes\":\r\n                this._doc.selection.pasteNotes();\r\n                break;\r\n            case \"pasteNumbers\":\r\n                this._doc.selection.pasteNumbers();\r\n                break;\r\n            case \"transposeUp\":\r\n                this._doc.selection.transpose(true, false);\r\n                break;\r\n            case \"transposeDown\":\r\n                this._doc.selection.transpose(false, false);\r\n                break;\r\n            case \"selectAll\":\r\n                this._doc.selection.selectAll();\r\n                break;\r\n            case \"selectChannel\":\r\n                this._doc.selection.selectChannel();\r\n                break;\r\n            case \"duplicatePatterns\":\r\n                this._doc.selection.duplicatePatterns();\r\n                break;\r\n            case \"barCount\":\r\n                this._openPrompt(\"barCount\");\r\n                break;\r\n            case \"beatsPerBar\":\r\n                this._openPrompt(\"beatsPerBar\");\r\n                break;\r\n            case \"moveNotesSideways\":\r\n                this._openPrompt(\"moveNotesSideways\");\r\n                break;\r\n            case \"channelSettings\":\r\n                this._openPrompt(\"channelSettings\");\r\n                break;\r\n            case \"limiterSettings\":\r\n                this._openPrompt(\"limiterSettings\");\r\n                break;\r\n        }\r\n        this._editMenu.selectedIndex = 0;\r\n    }\r\n\r\n    private _optionsMenuHandler = (event: Event): void => {\r\n        switch (this._optionsMenu.value) {\r\n            case \"autoPlay\":\r\n                this._doc.prefs.autoPlay = !this._doc.prefs.autoPlay;\r\n                break;\r\n            case \"autoFollow\":\r\n                this._doc.prefs.autoFollow = !this._doc.prefs.autoFollow;\r\n                break;\r\n            case \"enableNotePreview\":\r\n                this._doc.prefs.enableNotePreview = !this._doc.prefs.enableNotePreview;\r\n                break;\r\n            case \"showLetters\":\r\n                this._doc.prefs.showLetters = !this._doc.prefs.showLetters;\r\n                break;\r\n            case \"showFifth\":\r\n                this._doc.prefs.showFifth = !this._doc.prefs.showFifth;\r\n                break;\r\n            case \"notesOutsideScale\":\r\n                this._doc.prefs.notesOutsideScale = !this._doc.prefs.notesOutsideScale;\r\n                break;\r\n            case \"setDefaultScale\":\r\n                this._doc.prefs.defaultScale = this._doc.song.scale;\r\n                break;\r\n            case \"showChannels\":\r\n                this._doc.prefs.showChannels = !this._doc.prefs.showChannels;\r\n                break;\r\n            case \"showScrollBar\":\r\n                this._doc.prefs.showScrollBar = !this._doc.prefs.showScrollBar;\r\n                break;\r\n            case \"alwaysFineNoteVol\":\r\n                this._doc.prefs.alwaysFineNoteVol = !this._doc.prefs.alwaysFineNoteVol;\r\n                break;\r\n            case \"enableChannelMuting\":\r\n                this._doc.prefs.enableChannelMuting = !this._doc.prefs.enableChannelMuting;\r\n                for (const channel of this._doc.song.channels) channel.muted = false;\r\n                break;\r\n            case \"displayBrowserUrl\":\r\n                this._doc.toggleDisplayBrowserUrl();\r\n                break;\r\n            case \"displayVolumeBar\":\r\n                this._doc.prefs.displayVolumeBar = !this._doc.prefs.displayVolumeBar;\r\n                break;\r\n            case \"layout\":\r\n                this._openPrompt(\"layout\");\r\n                break;\r\n            case \"colorTheme\":\r\n                this._openPrompt(\"theme\");\r\n                break;\r\n            case \"recordingSetup\":\r\n                this._openPrompt(\"recordingSetup\");\r\n                break;\r\n        }\r\n        this._optionsMenu.selectedIndex = 0;\r\n        this._doc.notifier.changed();\r\n        this._doc.prefs.save();\r\n    }\r\n\r\n    private _customWavePresetHandler = (event: Event): void => {\r\n\r\n        // Update custom wave value\r\n        let customWaveArray: Float32Array = new Float32Array(64);\r\n        let index: number = this._customWavePresetDrop.selectedIndex - 1;\r\n        let maxValue: number = Number.MIN_VALUE;\r\n        let minValue: number = Number.MAX_VALUE;\r\n        let arrayPoint: number = 0;\r\n        let arrayStep: number = (Config.chipWaves[index].samples.length - 1) / 64.0;\r\n\r\n        for (let i: number = 0; i < 64; i++) {\r\n            // Compute derivative to get original wave.\r\n            customWaveArray[i] = (Config.chipWaves[index].samples[Math.floor(arrayPoint)] - Config.chipWaves[index].samples[(Math.floor(arrayPoint) + 1)]) / arrayStep;\r\n\r\n            if (customWaveArray[i] < minValue)\r\n                minValue = customWaveArray[i];\r\n\r\n            if (customWaveArray[i] > maxValue)\r\n                maxValue = customWaveArray[i];\r\n\r\n            // Scale an any-size array to 64 elements\r\n            arrayPoint += arrayStep;\r\n        }\r\n\r\n        for (let i: number = 0; i < 64; i++) {\r\n            // Change array range from Min~Max to 0~(Max-Min)\r\n            customWaveArray[i] -= minValue;\r\n            // Divide by (Max-Min) to get a range of 0~1,\r\n            customWaveArray[i] /= (maxValue - minValue);\r\n            //then multiply by 48 to get 0~48,\r\n            customWaveArray[i] *= 48.0;\r\n            //then subtract 24 to get - 24~24\r\n            customWaveArray[i] -= 24.0;\r\n            //need to force integers\r\n            customWaveArray[i] = Math.ceil(customWaveArray[i]);\r\n\r\n            // Copy back data to canvas\r\n            this._customWaveDrawCanvas.newArray[i] = customWaveArray[i];\r\n        }\r\n\r\n        //this._instrumentVolumeSlider.input.value = \"\" + Math.round(Config.waveVolumes[index] * 50.0 - 50.0);\r\n\r\n        this._doc.record(new ChangeCustomWave(this._doc, customWaveArray))\r\n        this._doc.record(new ChangeVolume(this._doc, +this._instrumentVolumeSlider.input.value, -Config.volumeRange / 2 + Math.round(Math.sqrt(Config.chipWaves[index].expression) * Config.volumeRange / 2)));\r\n\r\n        this._customWavePresetDrop.selectedIndex = 0;\r\n        this._doc.notifier.changed();\r\n        this._doc.prefs.save();\r\n    }\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Config} from \"../synth/SynthConfig\";\r\nimport {Note, Pattern} from \"../synth/synth\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {ChangeGroup} from \"./Change\";\r\nimport {ChangeChannelBar, ChangePinTime, ChangeEnsurePatternExists, ChangeNoteAdded, ChangeInsertBars, ChangeDeleteBars, ChangeNoteLength} from \"./changes\";\r\n\r\nexport class SongPerformance {\r\n\tprivate _channelIsDrum: boolean = false;\r\n\tprivate _channelOctave: number = -1;\r\n\tprivate _songKey: number = -1;\r\n\tprivate _pitchesAreTemporary: boolean = false;\r\n\tprivate readonly _recentlyAddedPitches: number[] = []; // Pitches that are rapidly added then removed within a minimum rhythm duration wouldn't get recorded until I explicitly track recently added notes and check if any are no longer held.\r\n\t\r\n\tprivate _songLengthWhenRecordingStarted: number = -1;\r\n\tprivate _playheadPart: number = -1;\r\n\tprivate _playheadPattern: Pattern | null = null;\r\n\tprivate _pitchesChanged: boolean = false;\r\n\tprivate _lastNote: Note | null = null;\r\n\tprivate _recordingChange: ChangeGroup | null = null;\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis._doc.notifier.watch(this._documentChanged);\r\n\t\tthis._documentChanged();\r\n\t\twindow.requestAnimationFrame(this._onAnimationFrame);\r\n\t}\r\n\t\r\n\tpublic play(): void {\r\n\t\tthis._doc.synth.play();\r\n\t\tthis._doc.synth.enableMetronome = false;\r\n\t\tthis._doc.synth.countInMetronome = false\r\n\t\tthis._doc.synth.maintainLiveInput();\r\n\t}\r\n\t\r\n\tpublic pause(): void {\r\n\t\tthis.clearAllPitches();\r\n\t\tif (this._recordingChange != null) {\r\n\t\t\tif (this._doc.song.barCount > this._songLengthWhenRecordingStarted && !this._lastBarHasPatterns()) {\r\n\t\t\t\t// If an extra empty bar was added in case it was needed for recording, but it didn't end up getting used, delete it now.\r\n\t\t\t\tnew ChangeDeleteBars(this._doc, this._doc.song.barCount - 1, 1);\r\n\t\t\t\tnew ChangeChannelBar(this._doc, this._doc.channel, this._doc.song.barCount - 1);\r\n\t\t\t}\r\n\t\t\tif (!this._recordingChange.isNoop()) {\r\n\t\t\t\tthis._doc.record(this._recordingChange);\r\n\t\t\t\tthis._recordingChange = null;\r\n\t\t\t}\r\n\t\t\tthis._lastNote = null;\r\n\t\t}\r\n\t\tthis._doc.synth.pause();\r\n\t\tthis._doc.synth.resetEffects();\r\n\t\tthis._doc.synth.enableMetronome = false;\r\n\t\tthis._doc.synth.countInMetronome = false\r\n\t\tif (this._doc.prefs.autoFollow) {\r\n\t\t\tthis._doc.synth.goToBar(this._doc.bar);\r\n\t\t}\r\n\t\tthis._doc.synth.snapToBar();\r\n\t}\r\n\t\r\n\tpublic record(): void {\r\n\t\tthis._doc.synth.snapToBar();\r\n\t\tconst playheadBar: number = Math.floor(this._doc.synth.playhead);\r\n\t\tif (playheadBar != this._doc.bar) {\r\n\t\t\tnew ChangeChannelBar(this._doc, this._doc.channel, playheadBar);\r\n\t\t}\r\n\t\tif (this._pitchesAreTemporary) {\r\n\t\t\tthis.clearAllPitches();\r\n\t\t\tthis._pitchesAreTemporary = false;\r\n\t\t}\r\n\t\tthis._doc.synth.enableMetronome = this._doc.prefs.metronomeWhileRecording;\r\n\t\tthis._doc.synth.countInMetronome = this._doc.prefs.metronomeCountIn;\r\n\t\tthis._doc.synth.startRecording();\r\n\t\tthis._doc.synth.maintainLiveInput();\r\n\t\tthis._songLengthWhenRecordingStarted = this._doc.song.barCount;\r\n\t\tthis._playheadPart = this._getCurrentPlayheadPart();\r\n\t\tthis._playheadPattern = null;\r\n\t\tthis._pitchesChanged = false;\r\n\t\tthis._lastNote = null;\r\n\t\tthis._recentlyAddedPitches.length = 0;\r\n\t\tthis._recordingChange = new ChangeGroup();\r\n\t\tthis._doc.setProspectiveChange(this._recordingChange);\r\n\t}\r\n\t\r\n\tpublic abortRecording(): void {\r\n\t\tthis._recordingChange = null;\r\n\t\tthis.pause();\r\n\t}\r\n\t\r\n\tpublic pitchesAreTemporary(): boolean {\r\n\t\treturn this._pitchesAreTemporary;\r\n\t}\r\n\t\r\n\tprivate _getMinDivision(): number {\r\n\t\tif (this._doc.prefs.snapRecordedNotesToRhythm) {\r\n\t\t\treturn Config.partsPerBeat / Config.rhythms[this._doc.song.rhythm].stepsPerBeat;\r\n\t\t} else {\r\n\t\t\treturn 1;\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _getCurrentPlayheadPart(): number {\r\n\t\tconst currentPart: number = this._doc.synth.playhead * this._doc.song.beatsPerBar * Config.partsPerBeat;\r\n\t\tif (this._doc.prefs.snapRecordedNotesToRhythm) {\r\n\t\t\tconst minDivision: number = this._getMinDivision();\r\n\t\t\treturn Math.round(currentPart / minDivision) * minDivision;\r\n\t\t}\r\n\t\treturn Math.round(currentPart);\r\n\t}\r\n\t\r\n\tprivate _lastBarHasPatterns(): boolean {\r\n\t\tfor (let channelIndex: number = 0; channelIndex < this._doc.song.getChannelCount(); channelIndex++) {\r\n\t\t\tif (this._doc.song.channels[channelIndex].bars[this._doc.song.barCount - 1] != 0) return true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\t\r\n\tprivate _onAnimationFrame = (): void => {\r\n\t\twindow.requestAnimationFrame(this._onAnimationFrame);\r\n\t\tif (this._doc.synth.recording) {\r\n\t\t\tconst dirty = this._updateRecordedNotes();\r\n\t\t\tif (dirty) {\r\n\t\t\t\t// The full interface is usually only rerendered in response to user input events, not animation events, but in this case go ahead and rerender everything.\r\n\t\t\t\tthis._doc.notifier.notifyWatchers();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\t// Returns true if the full interface needs to be rerendered.\r\n\tprivate _updateRecordedNotes(): boolean {\r\n\t\tif (this._recordingChange == null) return false;\r\n\t\tif (!this._doc.lastChangeWas(this._recordingChange)) {\r\n\t\t\tthis.abortRecording();\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tif (this._doc.synth.countInMetronome) {\r\n\t\t\t// If the synth is still counting in before recording, discard any recently added pitches.\r\n\t\t\tthis._recentlyAddedPitches.length = 0;\r\n\t\t\tthis._pitchesChanged = false;\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\t\r\n\t\tconst partsPerBar: number = this._doc.song.beatsPerBar * Config.partsPerBeat;\r\n\t\tconst oldPart: number = this._playheadPart % partsPerBar;\r\n\t\tconst oldBar: number = Math.floor(this._playheadPart / partsPerBar);\r\n\t\tconst oldPlayheadPart: number = this._playheadPart;\r\n\t\tthis._playheadPart = this._getCurrentPlayheadPart();\r\n\t\tconst newPart: number = this._playheadPart % partsPerBar;\r\n\t\tconst newBar: number = Math.floor(this._playheadPart / partsPerBar);\r\n\t\tif (oldPart == newPart && oldBar == newBar) return false;\r\n\t\tif (this._playheadPart < oldPlayheadPart) {\r\n\t\t\tthis._lastNote = null;\r\n\t\t\tthis._playheadPattern = null;\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\t\r\n\t\tlet dirty = false;\r\n\t\tfor (let bar: number = oldBar; bar <= newBar; bar++) {\r\n\t\t\tif (bar != oldBar) this._playheadPattern = null;\r\n\t\t\tconst startPart: number = (bar == oldBar) ? oldPart : 0;\r\n\t\t\tconst endPart: number = (bar == newBar) ? newPart : partsPerBar;\r\n\t\t\tif (startPart == endPart) break;\r\n\t\t\tif (this._lastNote != null && !this._pitchesChanged && startPart > 0 && this._doc.synth.liveInputPitches.length > 0) {\r\n\t\t\t\tthis._recordingChange.append(new ChangePinTime(this._doc, this._lastNote, 1, endPart, this._lastNote.continuesLastPattern));\r\n\t\t\t\t// Instead of updating the entire interface when extending the last note, just update the current pattern as a special case to avoid doing too much work every frame since performance is important while recording.\r\n\t\t\t\tthis._doc.currentPatternIsDirty = true;\r\n\t\t\t} else {\r\n\t\t\t\tif (this._lastNote != null) {\r\n\t\t\t\t\t// End the last note.\r\n\t\t\t\t\tthis._lastNote = null;\r\n\t\t\t\t}\r\n\t\t\t\t// All current pitches will usually fill the time span from startPart to endPart, but\r\n\t\t\t\t// if any recent pitches were released before being recorded, they'll get recorded here\r\n\t\t\t\t// as short as possible and then any remaining time will be dedicated to pitches that\r\n\t\t\t\t// haven't been released yet.\r\n\t\t\t\tlet noteStartPart: number = startPart;\r\n\t\t\t\tlet noteEndPart: number = endPart;\r\n\t\t\t\twhile (noteStartPart < endPart) {\r\n\t\t\t\t\tlet addedAlreadyReleasedPitch: boolean = false;\r\n\t\t\t\t\tif (this._recentlyAddedPitches.length > 0 || this._doc.synth.liveInputPitches.length > 0) {\r\n\t\t\t\t\t\tif (this._playheadPattern == null) {\r\n\t\t\t\t\t\t\tthis._doc.selection.erasePatternInBar(this._recordingChange, this._doc.synth.liveInputChannel, bar);\r\n\t\t\t\t\t\t\tthis._recordingChange.append(new ChangeEnsurePatternExists(this._doc, this._doc.synth.liveInputChannel, bar));\r\n\t\t\t\t\t\t\tthis._playheadPattern = this._doc.song.getPattern(this._doc.synth.liveInputChannel, bar);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (this._playheadPattern == null) throw new Error();\r\n\t\t\t\t\t\tthis._lastNote = new Note(-1, noteStartPart, noteEndPart, Config.noteSizeMax, this._doc.song.getChannelIsNoise(this._doc.synth.liveInputChannel));\r\n\t\t\t\t\t\tthis._lastNote.continuesLastPattern = (noteStartPart == 0 && !this._pitchesChanged);\r\n\t\t\t\t\t\tthis._lastNote.pitches.length = 0;\r\n\t\t\t\t\t\twhile (this._recentlyAddedPitches.length > 0) {\r\n\t\t\t\t\t\t\tif (this._lastNote.pitches.length >= Config.maxChordSize) break;\r\n\t\t\t\t\t\t\tconst recentPitch: number = this._recentlyAddedPitches.shift()!;\r\n\t\t\t\t\t\t\tif (this._doc.synth.liveInputPitches.indexOf(recentPitch) == -1) {\r\n\t\t\t\t\t\t\t\tthis._lastNote.pitches.push(recentPitch);\r\n\t\t\t\t\t\t\t\taddedAlreadyReleasedPitch = true;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tfor (let i: number = 0; i < this._doc.synth.liveInputPitches.length; i++) {\r\n\t\t\t\t\t\t\tif (this._lastNote.pitches.length >= Config.maxChordSize) break;\r\n\t\t\t\t\t\t\tthis._lastNote.pitches.push(this._doc.synth.liveInputPitches[i]);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis._recordingChange.append(new ChangeNoteAdded(this._doc, this._playheadPattern, this._lastNote, this._playheadPattern.notes.length));\r\n\t\t\t\t\t\tif (addedAlreadyReleasedPitch) {\r\n\t\t\t\t\t\t\t// If this note contains pitches that were already released, shorten it and start a new note.\r\n\t\t\t\t\t\t\tnoteEndPart = noteStartPart + this._getMinDivision();\r\n\t\t\t\t\t\t\tnew ChangeNoteLength(this._doc, this._lastNote, this._lastNote.start, noteEndPart);\r\n\t\t\t\t\t\t\tthis._lastNote = null;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tdirty = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis._pitchesChanged = addedAlreadyReleasedPitch;\r\n\t\t\t\t\tnoteStartPart = noteEndPart;\r\n\t\t\t\t\tnoteEndPart = endPart;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (bar == this._doc.song.barCount - 1) {\r\n\t\t\t\tif (this._lastBarHasPatterns()) {\r\n\t\t\t\t\tnew ChangeInsertBars(this._doc, this._doc.song.barCount, 1);\r\n\t\t\t\t\tthis._doc.bar--; // To counteract it increasing in ChangeInsertBars.\r\n\t\t\t\t\tdirty = true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn dirty;\r\n\t}\r\n\t\r\n\tpublic setTemporaryPitches(pitches: number[], duration: number): void {\r\n\t\tthis._updateRecordedNotes();\r\n\t\tfor (let i: number = 0; i < pitches.length; i++) {\r\n\t\t\tthis._doc.synth.liveInputPitches[i] = pitches[i];\r\n\t\t}\r\n\t\tthis._doc.synth.liveInputPitches.length = Math.min(pitches.length, Config.maxChordSize);\r\n\t\tthis._doc.synth.liveInputDuration = duration;\r\n\t\tthis._doc.synth.liveInputStarted = true;\r\n\t\tthis._pitchesAreTemporary = true;\r\n\t\tthis._pitchesChanged = true;\r\n\t}\r\n\t\r\n\tpublic addPerformedPitch(pitch: number): void {\r\n\t\tthis._doc.synth.maintainLiveInput();\r\n\t\tthis._updateRecordedNotes();\r\n\t\tif (this._pitchesAreTemporary) {\r\n\t\t\tthis.clearAllPitches();\r\n\t\t\tthis._pitchesAreTemporary = false;\r\n\t\t}\r\n\t\tif (this._doc.prefs.ignorePerformedNotesNotInScale && !Config.scales[this._doc.song.scale].flags[pitch % Config.pitchesPerOctave]) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (this._doc.synth.liveInputPitches.indexOf(pitch) == -1) {\r\n\t\t\tthis._doc.synth.liveInputPitches.push(pitch);\r\n\t\t\tthis._pitchesChanged = true;\r\n\t\t\twhile (this._doc.synth.liveInputPitches.length > Config.maxChordSize) {\r\n\t\t\t\tthis._doc.synth.liveInputPitches.shift();\r\n\t\t\t}\r\n\t\t\tthis._doc.synth.liveInputDuration = Number.MAX_SAFE_INTEGER;\r\n\t\t\t\r\n\t\t\tif (this._recordingChange != null) {\r\n\t\t\t\tconst recentIndex: number = this._recentlyAddedPitches.indexOf(pitch);\r\n\t\t\t\tif (recentIndex != -1) {\r\n\t\t\t\t\t// If the latest pitch is already in _recentlyAddedPitches, remove it before adding it back at the end.\r\n\t\t\t\t\tthis._recentlyAddedPitches.splice(recentIndex, 1);\r\n\t\t\t\t}\r\n\t\t\t\tthis._recentlyAddedPitches.push(pitch);\r\n\t\t\t\twhile (this._recentlyAddedPitches.length > Config.maxChordSize * 4) {\r\n\t\t\t\t\tthis._recentlyAddedPitches.shift();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic removePerformedPitch(pitch: number): void {\r\n\t\tthis._updateRecordedNotes();\r\n\t\tfor (let i: number = 0; i < this._doc.synth.liveInputPitches.length; i++) {\r\n\t\t\tif (this._doc.synth.liveInputPitches[i] == pitch) {\r\n\t\t\t\tthis._doc.synth.liveInputPitches.splice(i, 1);\r\n\t\t\t\tthis._pitchesChanged = true;\r\n\t\t\t\ti--;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic clearAllPitches(): void {\r\n\t\tthis._updateRecordedNotes();\r\n\t\tthis._doc.synth.liveInputPitches.length = 0;\r\n\t\tthis._pitchesChanged = true;\r\n\t}\r\n\t\r\n\tprivate _documentChanged = (): void => {\r\n\t\tconst isDrum: boolean = this._doc.song.getChannelIsNoise(this._doc.channel);\r\n\t\tconst octave: number = this._doc.song.channels[this._doc.channel].octave;\r\n\t\tif (this._doc.synth.liveInputChannel != this._doc.channel || this._channelIsDrum != isDrum || this._channelOctave != octave || this._songKey != this._doc.song.key) {\r\n\t\t\tthis._doc.synth.liveInputChannel = this._doc.channel;\r\n\t\t\tthis._channelIsDrum = isDrum;\r\n\t\t\tthis._channelOctave = octave;\r\n\t\t\tthis._songKey = this._doc.song.key;\r\n\t\t\tthis.clearAllPitches();\r\n\t\t}\r\n\t\tthis._doc.synth.liveInputInstruments = this._doc.recentPatternInstruments[this._doc.channel];\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { Dictionary, Config } from \"../synth/SynthConfig\";\r\nimport { Note, Pattern } from \"../synth/synth\";\r\nimport { SongDocument } from \"./SongDocument\";\r\nimport { ChangeGroup } from \"./Change\";\r\nimport { ColorConfig } from \"./ColorConfig\";\r\nimport { ChangeTrackSelection, ChangeChannelBar, ChangeAddChannel, ChangeRemoveChannel, ChangeChannelOrder, ChangeDuplicateSelectedReusedPatterns, ChangeNoteAdded, ChangeNoteTruncate, ChangePatternNumbers, ChangePatternSelection, ChangeInsertBars, ChangeDeleteBars, ChangeEnsurePatternExists, ChangeNoteLength, ChangePaste, ChangeSetPatternInstruments, ChangeViewInstrument, ChangeModChannel, ChangeModInstrument, ChangeModSetting, ChangeModFilter, ChangePatternsPerChannel, ChangePatternRhythm, ChangePatternScale, ChangeTranspose, ChangeRhythm, comparePatternNotes, unionOfUsedNotes, generateScaleMap, discardInvalidPatternInstruments, patternsContainSameInstruments } from \"./changes\";\r\n\r\ninterface PatternCopy {\r\n    instruments: number[];\r\n    notes: any[];\r\n}\r\n\r\ninterface ChannelCopy {\r\n    isNoise: boolean;\r\n    isMod: boolean;\r\n    patterns: Dictionary<PatternCopy>;\r\n    bars: number[];\r\n}\r\n\r\ninterface SelectionCopy {\r\n    partDuration: number;\r\n    channels: ChannelCopy[];\r\n}\r\n\r\nexport class Selection {\r\n    public boxSelectionX0: number = 0;\r\n    public boxSelectionY0: number = 0;\r\n    public boxSelectionX1: number = 0;\r\n    public boxSelectionY1: number = 0;\r\n    public digits: string = \"\";\r\n    public instrumentDigits: string = \"\";\r\n    public patternSelectionStart: number = 0;\r\n    public patternSelectionEnd: number = 0;\r\n    public patternSelectionActive: boolean = false;\r\n\r\n    private _changeTranspose: ChangeGroup | null = null;\r\n    private _changeTrack: ChangeGroup | null = null;\r\n    private _changeInstrument: ChangeGroup | null = null;\r\n    private _changeReorder: ChangeGroup | null = null;\r\n\r\n    constructor(private _doc: SongDocument) { }\r\n\r\n    public toJSON(): { x0: number, x1: number, y0: number, y1: number, start: number, end: number } {\r\n        return {\r\n            \"x0\": this.boxSelectionX0,\r\n            \"x1\": this.boxSelectionX1,\r\n            \"y0\": this.boxSelectionY0,\r\n            \"y1\": this.boxSelectionY1,\r\n            \"start\": this.patternSelectionStart,\r\n            \"end\": this.patternSelectionEnd,\r\n        };\r\n    }\r\n\r\n    public fromJSON(json: { x0: number, x1: number, y0: number, y1: number, start: number, end: number }): void {\r\n        if (json == null) return;\r\n        this.boxSelectionX0 = +json[\"x0\"];\r\n        this.boxSelectionX1 = +json[\"x1\"];\r\n        this.boxSelectionY0 = +json[\"y0\"];\r\n        this.boxSelectionY1 = +json[\"y1\"];\r\n        this.patternSelectionStart = +json[\"start\"];\r\n        this.patternSelectionEnd = +json[\"end\"];\r\n        this.digits = \"\";\r\n        this.instrumentDigits = \"\";\r\n        this.patternSelectionActive = this.patternSelectionStart < this.patternSelectionEnd;\r\n    }\r\n\r\n    public selectionUpdated(): void {\r\n        this._doc.notifier.changed();\r\n        this.digits = \"\";\r\n        this.instrumentDigits = \"\";\r\n    }\r\n\r\n    public get boxSelectionBar(): number {\r\n        return Math.min(this.boxSelectionX0, this.boxSelectionX1);\r\n    }\r\n    public get boxSelectionChannel(): number {\r\n        return Math.min(this.boxSelectionY0, this.boxSelectionY1);\r\n    }\r\n    public get boxSelectionWidth(): number {\r\n        return Math.abs(this.boxSelectionX0 - this.boxSelectionX1) + 1;\r\n    }\r\n    public get boxSelectionHeight(): number {\r\n        return Math.abs(this.boxSelectionY0 - this.boxSelectionY1) + 1;\r\n    }\r\n    public get boxSelectionActive(): boolean {\r\n        return this.boxSelectionWidth > 1 || this.boxSelectionHeight > 1;\r\n    }\r\n    public scrollToSelectedPattern(): void {\r\n        this._doc.barScrollPos = Math.min(this._doc.bar, Math.max(this._doc.bar - (this._doc.trackVisibleBars - 1), this._doc.barScrollPos));\r\n        this._doc.channelScrollPos = Math.min(this._doc.channel, Math.max(this._doc.channel - (this._doc.trackVisibleChannels - 1), this._doc.channelScrollPos));\r\n    }\r\n    public scrollToEndOfSelection(): void {\r\n        this._doc.barScrollPos = Math.min(this.boxSelectionX1, Math.max(this.boxSelectionX1 - (this._doc.trackVisibleBars - 1), this._doc.barScrollPos));\r\n        this._doc.channelScrollPos = Math.min(this.boxSelectionY1, Math.max(this.boxSelectionY1 - (this._doc.trackVisibleChannels - 1), this._doc.channelScrollPos));\r\n    }\r\n\r\n    public setChannelBar(channelIndex: number, bar: number): void {\r\n        if (channelIndex == this._doc.channel && bar == this._doc.bar) return;\r\n        const canReplaceLastChange: boolean = this._doc.lastChangeWas(this._changeTrack);\r\n        this._changeTrack = new ChangeGroup();\r\n        this._changeTrack.append(new ChangeChannelBar(this._doc, channelIndex, bar));\r\n        // @jummbus - changing current viewed instrument to the first for the current pattern if the viewedInstrument is not in the pattern\r\n        const pattern: Pattern | null = this._doc.getCurrentPattern(0);\r\n        if (pattern != null) {\r\n            if (pattern.instruments.indexOf(this._doc.viewedInstrument[this._doc.channel]) < 0) {\r\n                this._doc.viewedInstrument[this._doc.channel] = pattern.instruments[0];\r\n            }\r\n        }\r\n        // Don't erase existing redo history just to look at highlighted pattern.\r\n        if (!this._doc.hasRedoHistory()) {\r\n            this._doc.record(this._changeTrack, canReplaceLastChange);\r\n        }\r\n        this.selectionUpdated();\r\n\r\n    }\r\n\r\n    public setPattern(pattern: number): void {\r\n        this._doc.record(new ChangePatternNumbers(this._doc, pattern, this.boxSelectionBar, this.boxSelectionChannel, this.boxSelectionWidth, this.boxSelectionHeight));\r\n    }\r\n\r\n    public nextDigit(digit: string, forInstrument: boolean, forRhythms: boolean): void {\r\n        if (forRhythms) {\r\n            if (digit == \"3\") {\r\n                this._doc.record(new ChangeRhythm(this._doc, 0));\r\n            }\r\n            else if (digit == \"4\") {\r\n                this._doc.record(new ChangeRhythm(this._doc, 1));\r\n            }\r\n            else if (digit == \"6\") {\r\n                this._doc.record(new ChangeRhythm(this._doc, 2));\r\n            }\r\n            else if (digit == \"8\") {\r\n                this._doc.record(new ChangeRhythm(this._doc, 3));\r\n            }\r\n            else if (digit == \"0\" || digit == \"1\") {\r\n                this._doc.record(new ChangeRhythm(this._doc, 4));\r\n            }\r\n        } else if (forInstrument) {\r\n            // Treat \"0\" as meaning instrument 10\r\n            if (digit == \"0\") digit = \"10\";\r\n            this.instrumentDigits += digit;\r\n            var parsed = parseInt(this.instrumentDigits);\r\n            //var pattern: Pattern | null = this._doc.getCurrentPattern();\r\n            if (parsed != 0 && parsed <= this._doc.song.channels[this._doc.channel].instruments.length) {\r\n                this.selectInstrument(parsed - 1);\r\n                return;\r\n            }\r\n            this.instrumentDigits = digit;\r\n            parsed = parseInt(this.instrumentDigits);\r\n            if (parsed != 0 && parsed <= this._doc.song.channels[this._doc.channel].instruments.length) {\r\n                this.selectInstrument(parsed - 1);\r\n                return;\r\n            }\r\n            this.instrumentDigits = \"\";\r\n        }\r\n        else {\r\n            this.digits += digit;\r\n            let parsed: number = parseInt(this.digits);\r\n            if (parsed <= this._doc.song.patternsPerChannel) {\r\n\r\n                this.setPattern(parsed);\r\n\r\n                return;\r\n            }\r\n\r\n            this.digits = digit;\r\n            parsed = parseInt(this.digits);\r\n            if (parsed <= this._doc.song.patternsPerChannel) {\r\n\r\n                this.setPattern(parsed);\r\n\r\n                return;\r\n            }\r\n\r\n            this.digits = \"\";\r\n        }\r\n    }\r\n\r\n    public setModChannel(mod: number, index: number): void {\r\n        this._doc.record(new ChangeModChannel(this._doc, mod, index));\r\n    }\r\n\r\n    public setModInstrument(mod: number, instrument: number): void {\r\n        this._doc.record(new ChangeModInstrument(this._doc, mod, instrument));\r\n    }\r\n\r\n    public setModSetting(mod: number, text: string): void {\r\n        this._doc.record(new ChangeModSetting(this._doc, mod, text));\r\n    }\r\n\r\n    public setModFilter(mod: number, type: number): void {\r\n        this._doc.record(new ChangeModFilter(this._doc, mod, type));\r\n    }\r\n\r\n    public insertBars(): void {\r\n        this._doc.record(new ChangeInsertBars(this._doc, this.boxSelectionBar + this.boxSelectionWidth, this.boxSelectionWidth));\r\n        const width: number = this.boxSelectionWidth;\r\n        this.boxSelectionX0 += width;\r\n        this.boxSelectionX1 += width;\r\n    }\r\n\r\n    public insertChannel(): void {\r\n        const group: ChangeGroup = new ChangeGroup();\r\n        const insertIndex: number = this.boxSelectionChannel + this.boxSelectionHeight;\r\n        const isNoise: boolean = this._doc.song.getChannelIsNoise(insertIndex - 1);\r\n        const isMod: boolean = this._doc.song.getChannelIsMod(insertIndex - 1)\r\n        group.append(new ChangeAddChannel(this._doc, insertIndex, isNoise, isMod));\r\n        if (!group.isNoop()) {\r\n            this.boxSelectionY0 = this.boxSelectionY1 = insertIndex;\r\n            group.append(new ChangeChannelBar(this._doc, insertIndex, this._doc.bar));\r\n            this._doc.record(group);\r\n        }\r\n    }\r\n\r\n    public deleteBars(): void {\r\n        const group: ChangeGroup = new ChangeGroup();\r\n        if (this._doc.selection.patternSelectionActive) {\r\n\r\n            if (this.boxSelectionActive) {\r\n                group.append(new ChangeDuplicateSelectedReusedPatterns(this._doc, this.boxSelectionBar, this.boxSelectionWidth, this.boxSelectionChannel, this.boxSelectionHeight));\r\n            }\r\n\r\n            for (const channelIndex of this._eachSelectedChannel()) {\r\n                for (const pattern of this._eachSelectedPattern(channelIndex)) {\r\n                    group.append(new ChangeNoteTruncate(this._doc, pattern, this._doc.selection.patternSelectionStart, this._doc.selection.patternSelectionEnd));\r\n                }\r\n            }\r\n            group.append(new ChangePatternSelection(this._doc, 0, 0));\r\n        } else {\r\n            group.append(new ChangeDeleteBars(this._doc, this.boxSelectionBar, this.boxSelectionWidth));\r\n            const width: number = this.boxSelectionWidth;\r\n            this.boxSelectionX0 = Math.max(0, this.boxSelectionX0 - width);\r\n            this.boxSelectionX1 = Math.max(0, this.boxSelectionX1 - width);\r\n        }\r\n        this._doc.record(group);\r\n    }\r\n\r\n    public deleteChannel(): void {\r\n        this._doc.record(new ChangeRemoveChannel(this._doc, this.boxSelectionChannel, this.boxSelectionChannel + this.boxSelectionHeight - 1));\r\n        this.boxSelectionY0 = this.boxSelectionY1 = this._doc.channel;\r\n        ColorConfig.resetColors();\r\n    }\r\n\r\n    private * _eachSelectedChannel(): IterableIterator<number> {\r\n        for (let channelIndex: number = this.boxSelectionChannel; channelIndex < this.boxSelectionChannel + this.boxSelectionHeight; channelIndex++) {\r\n            yield channelIndex;\r\n        }\r\n    }\r\n\r\n    private * _eachSelectedBar(): IterableIterator<number> {\r\n        for (let bar: number = this.boxSelectionBar; bar < this.boxSelectionBar + this.boxSelectionWidth; bar++) {\r\n            yield bar;\r\n        }\r\n    }\r\n\r\n    private *_eachSelectedPattern(channelIndex: number): IterableIterator<Pattern> {\r\n        const handledPatterns: Dictionary<boolean> = {};\r\n        for (const bar of this._eachSelectedBar()) {\r\n            const currentPatternIndex: number = this._doc.song.channels[channelIndex].bars[bar];\r\n            if (currentPatternIndex == 0) continue;\r\n            if (handledPatterns[String(currentPatternIndex)]) continue;\r\n            handledPatterns[String(currentPatternIndex)] = true;\r\n            const pattern: Pattern | null = this._doc.song.getPattern(channelIndex, bar);\r\n            if (pattern == null) throw new Error();\r\n            yield pattern;\r\n        }\r\n    }\r\n\r\n    private _parseCopiedInstrumentArray(patternCopy: any, channelIndex: number): number[] {\r\n        const instruments: number[] = Array.from(patternCopy[\"instruments\"]).map(i => (<any>i) >>> 0);\r\n        discardInvalidPatternInstruments(instruments, this._doc.song, channelIndex);\r\n        return instruments;\r\n    }\r\n\r\n    private _patternIndexIsUnused(channelIndex: number, patternIndex: number): boolean {\r\n        for (let i: number = 0; i < this._doc.song.barCount; i++) {\r\n            if (this._doc.song.channels[channelIndex].bars[i] == patternIndex) {\r\n                return false;\r\n            }\r\n        }\r\n        return true;\r\n    }\r\n\r\n    public copy(): void {\r\n        const channels: ChannelCopy[] = [];\r\n\r\n        for (const channelIndex of this._eachSelectedChannel()) {\r\n            const patterns: Dictionary<PatternCopy> = {};\r\n            const bars: number[] = [];\r\n\r\n            for (const bar of this._eachSelectedBar()) {\r\n                const patternNumber: number = this._doc.song.channels[channelIndex].bars[bar];\r\n                bars.push(patternNumber);\r\n                if (patterns[String(patternNumber)] == undefined) {\r\n                    const pattern: Pattern | null = this._doc.song.getPattern(channelIndex, bar);\r\n                    let instruments: number[] = this._doc.recentPatternInstruments[channelIndex];\r\n                    let notes: Note[] = [];\r\n                    if (pattern != null) {\r\n                        instruments = pattern.instruments.concat();\r\n\r\n                        if (this.patternSelectionActive) {\r\n                            for (const note of pattern.cloneNotes()) {\r\n                                if (note.end <= this.patternSelectionStart) continue;\r\n                                if (note.start >= this.patternSelectionEnd) continue;\r\n                                note.start -= this.patternSelectionStart;\r\n                                note.end -= this.patternSelectionStart;\r\n                                if (note.start < 0 || note.end > this.patternSelectionEnd - this.patternSelectionStart) {\r\n                                    new ChangeNoteLength(null, note, Math.max(note.start, 0), Math.min(this.patternSelectionEnd - this.patternSelectionStart, note.end));\r\n                                }\r\n                                notes.push(note);\r\n                            }\r\n                        } else {\r\n                            notes = pattern.notes;\r\n                        }\r\n                    }\r\n                    patterns[String(patternNumber)] = { \"instruments\": instruments, \"notes\": notes };\r\n                }\r\n            }\r\n\r\n            const channelCopy: ChannelCopy = {\r\n                \"isNoise\": this._doc.song.getChannelIsNoise(channelIndex),\r\n                \"isMod\": this._doc.song.getChannelIsMod(channelIndex),\r\n                \"patterns\": patterns,\r\n                \"bars\": bars,\r\n            };\r\n            channels.push(channelCopy);\r\n        }\r\n\r\n        const selectionCopy: SelectionCopy = {\r\n            \"partDuration\": this.patternSelectionActive ? this.patternSelectionEnd - this.patternSelectionStart : this._doc.song.beatsPerBar * Config.partsPerBeat,\r\n            \"channels\": channels,\r\n        };\r\n        window.localStorage.setItem(\"selectionCopy\", JSON.stringify(selectionCopy));\r\n        // Clear selection after copy\r\n        new ChangePatternSelection(this._doc, 0, 0);\r\n    }\r\n\r\n    // I'm sorry this function is so complicated!\r\n    // Basically I'm trying to avoid accidentally modifying patterns that are used\r\n    // elsewhere in the song (unless we're just pasting a single pattern) but I'm\r\n    // also trying to reuse patterns where it makes sense to do so, especially \r\n    // in the same channel it was copied from.\r\n    public pasteNotes(): void {\r\n        const selectionCopy: SelectionCopy | null = JSON.parse(String(window.localStorage.getItem(\"selectionCopy\")));\r\n        if (selectionCopy == null) return;\r\n        const channelCopies: ChannelCopy[] = selectionCopy[\"channels\"] || [];\r\n        const copiedPartDuration: number = selectionCopy[\"partDuration\"] >>> 0;\r\n\r\n        const group: ChangeGroup = new ChangeGroup();\r\n        const fillSelection: boolean = (this.boxSelectionWidth > 1 || this.boxSelectionHeight > 1);\r\n\r\n        const pasteHeight: number = fillSelection ? this.boxSelectionHeight : Math.min(channelCopies.length, this._doc.song.getChannelCount() - this.boxSelectionChannel);\r\n        for (let pasteChannel: number = 0; pasteChannel < pasteHeight; pasteChannel++) {\r\n            const channelCopy: ChannelCopy = channelCopies[pasteChannel % channelCopies.length];\r\n            const channelIndex: number = this.boxSelectionChannel + pasteChannel;\r\n\r\n            const isNoise: boolean = !!channelCopy[\"isNoise\"];\r\n            const isMod: boolean = !!channelCopy[\"isMod\"];\r\n            const patternCopies: Dictionary<PatternCopy> = channelCopy[\"patterns\"] || {};\r\n            const copiedBars: number[] = channelCopy[\"bars\"] || [];\r\n            if (copiedBars.length == 0) continue;\r\n            if (isNoise != this._doc.song.getChannelIsNoise(channelIndex)) continue;\r\n            if (isMod != this._doc.song.getChannelIsMod(channelIndex)) continue;\r\n\r\n            const pasteWidth: number = fillSelection ? this.boxSelectionWidth : Math.min(copiedBars.length, this._doc.song.barCount - this.boxSelectionBar);\r\n            if (!fillSelection && copiedBars.length == 1 && channelCopies.length == 1) {\r\n                // Special case: if there's just one pattern being copied, try to insert it\r\n                // into whatever pattern is already selected.\r\n                const copiedPatternIndex: number = copiedBars[0] >>> 0;\r\n                const bar: number = this.boxSelectionBar;\r\n                const currentPatternIndex: number = this._doc.song.channels[channelIndex].bars[bar];\r\n                if (copiedPatternIndex == 0 && currentPatternIndex == 0) continue;\r\n\r\n                const patternCopy: PatternCopy = patternCopies[String(copiedPatternIndex)];\r\n\r\n                const instrumentsCopy: number[] = this._parseCopiedInstrumentArray(patternCopy, channelIndex);\r\n\r\n                if (currentPatternIndex == 0) {\r\n                    const existingPattern: Pattern | undefined = this._doc.song.channels[channelIndex].patterns[copiedPatternIndex - 1];\r\n                    if (existingPattern != undefined &&\r\n                        !this.patternSelectionActive &&\r\n                        ((comparePatternNotes(patternCopy[\"notes\"], existingPattern.notes) && patternsContainSameInstruments(instrumentsCopy, existingPattern.instruments)) ||\r\n                            this._patternIndexIsUnused(channelIndex, copiedPatternIndex))) {\r\n                        group.append(new ChangePatternNumbers(this._doc, copiedPatternIndex, bar, channelIndex, 1, 1));\r\n                    } else {\r\n                        group.append(new ChangeEnsurePatternExists(this._doc, channelIndex, bar));\r\n                    }\r\n                }\r\n\r\n                const pattern: Pattern | null = this._doc.song.getPattern(channelIndex, bar);\r\n                if (pattern == null) throw new Error();\r\n                group.append(new ChangePaste(this._doc, pattern, patternCopy[\"notes\"], this.patternSelectionActive ? this.patternSelectionStart : 0, this.patternSelectionActive ? this.patternSelectionEnd : Config.partsPerBeat * this._doc.song.beatsPerBar, copiedPartDuration));\r\n                // @jummbus - I actually like it better if instruments copy over, unless it's not a mod and there are notes in the pattern.\r\n                if (currentPatternIndex == 0 || patternCopy.notes.length == 0 || channelIndex >= this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount) {\r\n                    this.selectInstrument(instrumentsCopy[0]);\r\n                    group.append(new ChangeSetPatternInstruments(this._doc, channelIndex, instrumentsCopy, pattern));\r\n                }\r\n            } else if (this.patternSelectionActive) {\r\n                const reusablePatterns: Dictionary<number> = {};\r\n                const usedPatterns: Dictionary<boolean> = {};\r\n\r\n                group.append(new ChangeDuplicateSelectedReusedPatterns(this._doc, this.boxSelectionBar, pasteWidth, this.boxSelectionChannel, pasteHeight));\r\n\r\n                for (let pasteBar: number = 0; pasteBar < pasteWidth; pasteBar++) {\r\n                    const bar: number = this.boxSelectionBar + pasteBar;\r\n                    const copiedPatternIndex: number = copiedBars[pasteBar % copiedBars.length] >>> 0;\r\n                    const currentPatternIndex: number = this._doc.song.channels[channelIndex].bars[bar];\r\n                    const reusedIndex: string = [copiedPatternIndex, currentPatternIndex].join(\",\");\r\n                    if (copiedPatternIndex == 0 && currentPatternIndex == 0) continue;\r\n                    if (reusablePatterns[reusedIndex] != undefined) {\r\n                        group.append(new ChangePatternNumbers(this._doc, reusablePatterns[reusedIndex], bar, channelIndex, 1, 1));\r\n                        continue;\r\n                    }\r\n\r\n                    if (currentPatternIndex == 0) {\r\n                        group.append(new ChangeEnsurePatternExists(this._doc, channelIndex, bar));\r\n                        const patternCopy: PatternCopy = patternCopies[String(copiedPatternIndex)];\r\n                        const instrumentsCopy: number[] = this._parseCopiedInstrumentArray(patternCopy, channelIndex);\r\n                        const pattern: Pattern = this._doc.song.getPattern(channelIndex, bar)!;\r\n                        group.append(new ChangeSetPatternInstruments(this._doc, channelIndex, instrumentsCopy, pattern));\r\n                    } else {\r\n                        const pattern: Pattern | null = this._doc.song.getPattern(channelIndex, bar);\r\n                        if (pattern == null) throw new Error();\r\n\r\n                        if (!usedPatterns[String(currentPatternIndex)]) {\r\n                            usedPatterns[String(currentPatternIndex)] = true;\r\n                        } else {\r\n                            // If this pattern is used here and elsewhere, it's not safe to modify it directly, so\r\n                            // make a duplicate of it and modify that instead.\r\n                            group.append(new ChangePatternNumbers(this._doc, 0, bar, channelIndex, 1, 1));\r\n                            group.append(new ChangeEnsurePatternExists(this._doc, channelIndex, bar));\r\n                            const newPattern: Pattern | null = this._doc.song.getPattern(channelIndex, bar);\r\n                            if (newPattern == null) throw new Error();\r\n                            for (const note of pattern.cloneNotes()) {\r\n                                group.append(new ChangeNoteAdded(this._doc, newPattern, note, newPattern.notes.length, false));\r\n                            }\r\n                            // Don't overwrite the existing pattern's instruments if only part of the pattern content is being replaced.\r\n                            //group.append(new ChangeSetPatternInstruments(this._doc, channelIndex, pattern.instruments, newPattern));\r\n                        }\r\n                    }\r\n\r\n                    const pattern: Pattern | null = this._doc.song.getPattern(channelIndex, bar);\r\n                    if (pattern == null) throw new Error();\r\n                    if (copiedPatternIndex == 0) {\r\n                        group.append(new ChangeNoteTruncate(this._doc, pattern, this.patternSelectionStart, this.patternSelectionEnd));\r\n                    } else {\r\n                        const patternCopy: PatternCopy = patternCopies[String(copiedPatternIndex)];\r\n                        group.append(new ChangePaste(this._doc, pattern, patternCopy[\"notes\"], this.patternSelectionStart, this.patternSelectionEnd, copiedPartDuration));\r\n                    }\r\n\r\n                    reusablePatterns[reusedIndex] = this._doc.song.channels[channelIndex].bars[bar];\r\n                }\r\n            } else {\r\n                for (let pasteBar: number = 0; pasteBar < pasteWidth; pasteBar++) {\r\n                    // When a pattern becomes unused when replaced by rectangular selection pasting,\r\n                    // remove all the notes from the pattern so that it may be reused.\r\n                    this.erasePatternInBar(group, channelIndex, this.boxSelectionBar + pasteBar);\r\n                }\r\n\r\n                const reusablePatterns: Dictionary<number> = {};\r\n                for (let pasteBar: number = 0; pasteBar < pasteWidth; pasteBar++) {\r\n                    const bar: number = this.boxSelectionBar + pasteBar;\r\n                    const copiedPatternIndex: number = copiedBars[pasteBar % copiedBars.length] >>> 0;\r\n                    const reusedIndex: string = String(copiedPatternIndex);\r\n                    if (copiedPatternIndex == 0) continue;\r\n                    if (reusablePatterns[reusedIndex] != undefined) {\r\n                        group.append(new ChangePatternNumbers(this._doc, reusablePatterns[reusedIndex], bar, channelIndex, 1, 1));\r\n                        continue;\r\n                    }\r\n                    const patternCopy: PatternCopy = patternCopies[String(copiedPatternIndex)];\r\n                    const instrumentsCopy: number[] = this._parseCopiedInstrumentArray(patternCopy, channelIndex);\r\n                    const existingPattern: Pattern | undefined = this._doc.song.channels[channelIndex].patterns[copiedPatternIndex - 1];\r\n\r\n                    if (existingPattern != undefined &&\r\n                        copiedPartDuration == Config.partsPerBeat * this._doc.song.beatsPerBar &&\r\n                        comparePatternNotes(patternCopy[\"notes\"], existingPattern.notes) &&\r\n                        patternsContainSameInstruments(instrumentsCopy, existingPattern.instruments)) {\r\n                        group.append(new ChangePatternNumbers(this._doc, copiedPatternIndex, bar, channelIndex, 1, 1));\r\n                    } else {\r\n                        if (existingPattern != undefined && this._patternIndexIsUnused(channelIndex, copiedPatternIndex)) {\r\n                            group.append(new ChangePatternNumbers(this._doc, copiedPatternIndex, bar, channelIndex, 1, 1));\r\n                        } else {\r\n                            group.append(new ChangeEnsurePatternExists(this._doc, channelIndex, bar));\r\n                        }\r\n                        const pattern: Pattern | null = this._doc.song.getPattern(channelIndex, bar);\r\n                        if (pattern == null) throw new Error();\r\n                        group.append(new ChangePaste(this._doc, pattern, patternCopy[\"notes\"], this.patternSelectionActive ? this.patternSelectionStart : 0, this.patternSelectionActive ? this.patternSelectionEnd : Config.partsPerBeat * this._doc.song.beatsPerBar, copiedPartDuration));\r\n                        group.append(new ChangeSetPatternInstruments(this._doc, channelIndex, instrumentsCopy, pattern));\r\n                    }\r\n\r\n                    reusablePatterns[reusedIndex] = this._doc.song.channels[channelIndex].bars[bar];\r\n\r\n                }\r\n            }\r\n        }\r\n\r\n        this._doc.record(group);\r\n    }\r\n\r\n    // Set a bar's pattern number to zero, and if that pattern was not used\r\n    // elsewhere in the channel, erase all notes in it as well.\r\n    public erasePatternInBar(group: ChangeGroup, channelIndex: number, bar: number): void {\r\n        const removedPattern: number = this._doc.song.channels[channelIndex].bars[bar];\r\n        if (removedPattern != 0) {\r\n            group.append(new ChangePatternNumbers(this._doc, 0, bar, channelIndex, 1, 1));\r\n            if (this._patternIndexIsUnused(channelIndex, removedPattern)) {\r\n                // When a pattern becomes unused when replaced by rectangular selection pasting,\r\n                // remove all the notes from the pattern so that it may be reused.\r\n                this._doc.song.channels[channelIndex].patterns[removedPattern - 1].notes.length = 0;\r\n            }\r\n        }\r\n    }\r\n\r\n    public pasteNumbers(): void {\r\n        const selectionCopy: SelectionCopy | null = JSON.parse(String(window.localStorage.getItem(\"selectionCopy\")));\r\n        if (selectionCopy == null) return;\r\n        const channelCopies: ChannelCopy[] = selectionCopy[\"channels\"] || [];\r\n\r\n        const group: ChangeGroup = new ChangeGroup();\r\n        const fillSelection: boolean = this.boxSelectionActive;\r\n\r\n        const pasteHeight: number = fillSelection ? this.boxSelectionHeight : Math.min(channelCopies.length, this._doc.song.getChannelCount() - this.boxSelectionChannel);\r\n        for (let pasteChannel: number = 0; pasteChannel < pasteHeight; pasteChannel++) {\r\n            const channelCopy: ChannelCopy = channelCopies[pasteChannel % channelCopies.length];\r\n            const channelIndex: number = this.boxSelectionChannel + pasteChannel;\r\n\r\n            const copiedBars: number[] = channelCopy[\"bars\"] || [];\r\n            if (copiedBars.length == 0) continue;\r\n\r\n            const pasteWidth: number = fillSelection ? this.boxSelectionWidth : Math.min(copiedBars.length, this._doc.song.barCount - this.boxSelectionBar);\r\n            for (let pasteBar: number = 0; pasteBar < pasteWidth; pasteBar++) {\r\n                const copiedPatternIndex: number = copiedBars[pasteBar % copiedBars.length] >>> 0;\r\n                const bar: number = this.boxSelectionBar + pasteBar;\r\n\r\n                if (copiedPatternIndex > this._doc.song.patternsPerChannel) {\r\n                    group.append(new ChangePatternsPerChannel(this._doc, copiedPatternIndex));\r\n                }\r\n\r\n                group.append(new ChangePatternNumbers(this._doc, copiedPatternIndex, bar, channelIndex, 1, 1));\r\n            }\r\n        }\r\n\r\n        this._doc.record(group);\r\n    }\r\n\r\n    public selectAll(): void {\r\n        new ChangePatternSelection(this._doc, 0, 0);\r\n        if (this.boxSelectionBar == 0 &&\r\n            this.boxSelectionChannel == 0 &&\r\n            this.boxSelectionWidth == this._doc.song.barCount &&\r\n            this.boxSelectionHeight == this._doc.song.getChannelCount()) {\r\n            this.setTrackSelection(this._doc.bar, this._doc.bar, this._doc.channel, this._doc.channel);\r\n        } else {\r\n            this.setTrackSelection(0, this._doc.song.barCount - 1, 0, this._doc.song.getChannelCount() - 1);\r\n        }\r\n        this.selectionUpdated();\r\n    }\r\n\r\n    public selectChannel(): void {\r\n        new ChangePatternSelection(this._doc, 0, 0);\r\n        if (this.boxSelectionBar == 0 && this.boxSelectionWidth == this._doc.song.barCount) {\r\n            this.setTrackSelection(this._doc.bar, this._doc.bar, this.boxSelectionY0, this.boxSelectionY1);\r\n        } else {\r\n            this.setTrackSelection(0, this._doc.song.barCount - 1, this.boxSelectionY0, this.boxSelectionY1);\r\n        }\r\n        this.selectionUpdated();\r\n    }\r\n\r\n    public duplicatePatterns(): void {\r\n        this._doc.record(new ChangeDuplicateSelectedReusedPatterns(this._doc, this.boxSelectionBar, this.boxSelectionWidth, this.boxSelectionChannel, this.boxSelectionHeight));\r\n    }\r\n\r\n    public muteChannels(allChannels: boolean): void {\r\n        if (allChannels) {\r\n            let anyMuted: boolean = false;\r\n            for (let channelIndex: number = 0; channelIndex < this._doc.song.channels.length; channelIndex++) {\r\n                if (this._doc.song.channels[channelIndex].muted) {\r\n                    anyMuted = true;\r\n                    break;\r\n                }\r\n            }\r\n            for (let channelIndex: number = 0; channelIndex < this._doc.song.channels.length; channelIndex++) {\r\n                this._doc.song.channels[channelIndex].muted = !anyMuted;\r\n            }\r\n        } else {\r\n            let anyUnmuted: boolean = false;\r\n            for (const channelIndex of this._eachSelectedChannel()) {\r\n                if (!this._doc.song.channels[channelIndex].muted) {\r\n                    anyUnmuted = true;\r\n                    break;\r\n                }\r\n            }\r\n            for (const channelIndex of this._eachSelectedChannel()) {\r\n                this._doc.song.channels[channelIndex].muted = anyUnmuted;\r\n            }\r\n        }\r\n\r\n        this._doc.notifier.changed();\r\n    }\r\n\r\n    public soloChannels(invert: boolean): void {\r\n        let alreadySoloed: boolean = true;\r\n\r\n        // Soloing mod channels - solo all channels affected by the mod, instead\r\n        if (this.boxSelectionChannel >= this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount) {\r\n\r\n            const currentChannel = this._doc.song.channels[this.boxSelectionChannel];\r\n            const bar: number = currentChannel.bars[this._doc.bar] - 1;\r\n            const modInstrument = (bar >= 0) ? currentChannel.instruments[currentChannel.patterns[bar].instruments[0]] : currentChannel.instruments[this._doc.viewedInstrument[this.boxSelectionChannel]];\r\n            const soloPattern: boolean[] = [];\r\n            let matchesSoloPattern: boolean = !invert;\r\n\r\n            // First pass: determine solo pattern\r\n            for (let channelIndex: number = 0; channelIndex < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount; channelIndex++) {\r\n                soloPattern[channelIndex] = false;\r\n                for (let mod: number = 0; mod < Config.modCount; mod++) {\r\n                    if (modInstrument.modChannels[mod] == channelIndex) {\r\n                        soloPattern[channelIndex] = true;\r\n                    }\r\n                }\r\n            }\r\n\r\n            // Second pass: determine if channels match solo pattern, overall\r\n            for (let channelIndex: number = 0; channelIndex < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount; channelIndex++) {\r\n                if (this._doc.song.channels[channelIndex].muted == soloPattern[channelIndex]) {\r\n                    matchesSoloPattern = invert;\r\n                    break;\r\n                }\r\n            }\r\n\r\n            // Third pass: Actually apply solo pattern or unmute all\r\n            for (let channelIndex: number = 0; channelIndex < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount; channelIndex++) {\r\n                if (matchesSoloPattern) {\r\n                    this._doc.song.channels[channelIndex].muted = false;\r\n                }\r\n                else {\r\n                    this._doc.song.channels[channelIndex].muted = !soloPattern[channelIndex];\r\n                }\r\n            }\r\n\r\n        }\r\n        else {\r\n\r\n            for (let channelIndex: number = 0; channelIndex < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount; channelIndex++) {\r\n                const shouldBeMuted: boolean = (channelIndex < this.boxSelectionChannel || channelIndex >= this.boxSelectionChannel + this.boxSelectionHeight) ? !invert : invert;\r\n                if (this._doc.song.channels[channelIndex].muted != shouldBeMuted) {\r\n                    alreadySoloed = false;\r\n                    break;\r\n                }\r\n            }\r\n\r\n            if (alreadySoloed) {\r\n                for (let channelIndex: number = 0; channelIndex < this._doc.song.channels.length; channelIndex++) {\r\n                    this._doc.song.channels[channelIndex].muted = false;\r\n                }\r\n            } else {\r\n                for (let channelIndex: number = 0; channelIndex < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount; channelIndex++) {\r\n                    this._doc.song.channels[channelIndex].muted = (channelIndex < this.boxSelectionChannel || channelIndex >= this.boxSelectionChannel + this.boxSelectionHeight) ? !invert : invert;\r\n                }\r\n            }\r\n\r\n        }\r\n\r\n        this._doc.notifier.changed();\r\n    }\r\n\r\n    public forceRhythm(): void {\r\n        const group: ChangeGroup = new ChangeGroup();\r\n\r\n        if (this.boxSelectionActive) {\r\n\t\t    group.append(new ChangeDuplicateSelectedReusedPatterns(this._doc, this.boxSelectionBar, this.boxSelectionWidth, this.boxSelectionChannel, this.boxSelectionHeight));\r\n        }\r\n\r\n        for (const channelIndex of this._eachSelectedChannel()) {\r\n            for (const pattern of this._eachSelectedPattern(channelIndex)) {\r\n                group.append(new ChangePatternRhythm(this._doc, pattern));\r\n            }\r\n        }\r\n\r\n        this._doc.record(group);\r\n    }\r\n\r\n    public forceScale(): void {\r\n        const group: ChangeGroup = new ChangeGroup();\r\n\r\n        if (this.boxSelectionActive) {\r\n\t\t    group.append(new ChangeDuplicateSelectedReusedPatterns(this._doc, this.boxSelectionBar, this.boxSelectionWidth, this.boxSelectionChannel, this.boxSelectionHeight));\r\n        }\r\n\r\n        const scaleFlags: boolean[] = [true, false, false, false, false, false, false, false, false, false, false, false];\r\n        for (const channelIndex of this._eachSelectedChannel()) {\r\n            if (this._doc.song.getChannelIsNoise(channelIndex) || this._doc.song.getChannelIsMod(channelIndex)) continue;\r\n            for (const pattern of this._eachSelectedPattern(channelIndex)) {\r\n                unionOfUsedNotes(pattern, scaleFlags);\r\n            }\r\n        }\r\n\r\n        const scaleMap: number[] = generateScaleMap(scaleFlags, this._doc.song.scale);\r\n\r\n        for (const channelIndex of this._eachSelectedChannel()) {\r\n            if (this._doc.song.getChannelIsNoise(channelIndex) || this._doc.song.getChannelIsMod(channelIndex)) continue;\r\n            for (const pattern of this._eachSelectedPattern(channelIndex)) {\r\n                group.append(new ChangePatternScale(this._doc, pattern, scaleMap));\r\n            }\r\n        }\r\n\r\n        this._doc.record(group);\r\n    }\r\n\r\n    public setTrackSelection(newX0: number, newX1: number, newY0: number, newY1: number): void {\r\n        const canReplaceLastChange: boolean = true;//this._doc.lastChangeWas(this._changeTrack);\r\n        this._changeTrack = new ChangeGroup();\r\n        this._changeTrack.append(new ChangeTrackSelection(this._doc, newX0, newX1, newY0, newY1));\r\n        this._doc.record(this._changeTrack, canReplaceLastChange);\r\n    }\r\n\r\n    public transpose(upward: boolean, octave: boolean): void {\r\n        const canReplaceLastChange: boolean = this._doc.lastChangeWas(this._changeTranspose);\r\n        this._changeTranspose = new ChangeGroup();\r\n\r\n        if (this.boxSelectionActive) {\r\n\t\t    this._changeTranspose.append(new ChangeDuplicateSelectedReusedPatterns(this._doc, this.boxSelectionBar, this.boxSelectionWidth, this.boxSelectionChannel, this.boxSelectionHeight));\r\n        }\r\n\r\n        for (const channelIndex of this._eachSelectedChannel()) {\r\n            // Can't transpose mod channels.\r\n            if (channelIndex >= this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount)\r\n                continue;\r\n            for (const pattern of this._eachSelectedPattern(channelIndex)) {\r\n                this._changeTranspose.append(new ChangeTranspose(this._doc, channelIndex, pattern, upward, this._doc.prefs.notesOutsideScale, octave));\r\n\t\t\t}\r\n        }\r\n\r\n        this._doc.record(this._changeTranspose, canReplaceLastChange);\r\n    }\r\n\r\n    public swapChannels(offset: number): void {\r\n        const possibleSectionBoundaries: number[] = [\r\n            this._doc.song.pitchChannelCount,\r\n            this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount,\r\n            this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount + this._doc.song.modChannelCount,\r\n            this._doc.song.getChannelCount(),\r\n        ];\r\n        let channelSectionMin: number = 0;\r\n        let channelSectionMax: number = 0;\r\n        for (const nextBoundary of possibleSectionBoundaries) {\r\n            if ((this.boxSelectionChannel < nextBoundary && offset < 0) || (this.boxSelectionChannel + this.boxSelectionHeight <= nextBoundary)) {\r\n                channelSectionMax = nextBoundary - 1;\r\n                break;\r\n            }\r\n            channelSectionMin = nextBoundary;\r\n        }\r\n        const newSelectionMin: number = Math.max(this.boxSelectionChannel, channelSectionMin);\r\n        const newSelectionMax: number = Math.min(this.boxSelectionChannel + this.boxSelectionHeight - 1, channelSectionMax);\r\n        offset = Math.max(offset, channelSectionMin - newSelectionMin);\r\n        offset = Math.min(offset, channelSectionMax - newSelectionMax);\r\n\r\n        if (offset != 0) {\r\n            const canReplaceLastChange: boolean = this._doc.lastChangeWas(this._changeReorder);\r\n            this._changeReorder = new ChangeGroup();\r\n            this.boxSelectionY0 = newSelectionMin + offset;\r\n            this.boxSelectionY1 = newSelectionMax + offset;\r\n            this._changeReorder.append(new ChangeChannelOrder(this._doc, newSelectionMin, newSelectionMax, offset));\r\n            this._changeReorder.append(new ChangeChannelBar(this._doc, Math.max(this.boxSelectionY0, Math.min(this.boxSelectionY1, this._doc.channel + offset)), this._doc.bar));\r\n            this.selectionUpdated();\r\n            this._doc.record(this._changeReorder, canReplaceLastChange);\r\n        }\r\n    }\r\n\r\n    public selectInstrument(instrument: number): void {\r\n        if (this._doc.viewedInstrument[this._doc.channel] == instrument) {\r\n            // Multi-selection is not possible for mods... that would not make much sense.\r\n            if (this._doc.song.layeredInstruments && this._doc.song.patternInstruments && this._doc.channel < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount) {\r\n                const canReplaceLastChange: boolean = this._doc.lastChangeWas(this._changeInstrument);\r\n                this._changeInstrument = new ChangeGroup();\r\n                const instruments: number[] = this._doc.recentPatternInstruments[this._doc.channel];\r\n                if (instruments.indexOf(instrument) == -1) {\r\n                    instruments.push(instrument);\r\n                    const maxLayers: number = this._doc.song.getMaxInstrumentsPerPattern(this._doc.channel);\r\n                    if (instruments.length > maxLayers) {\r\n                        instruments.splice(0, instruments.length - maxLayers);\r\n                    }\r\n                } else {\r\n                    instruments.splice(instruments.indexOf(instrument), 1);\r\n                    if (instruments.length == 0) instruments[0] = 0;\r\n                }\r\n\r\n                if (this.boxSelectionActive) {\r\n                    this._changeInstrument.append(new ChangeDuplicateSelectedReusedPatterns(this._doc, this.boxSelectionBar, this.boxSelectionWidth, this.boxSelectionChannel, this.boxSelectionHeight));\r\n                }\r\n                for (const channelIndex of this._eachSelectedChannel()) {\r\n                    for (const pattern of this._eachSelectedPattern(channelIndex)) {\r\n                        this._changeInstrument.append(new ChangeSetPatternInstruments(this._doc, channelIndex, instruments, pattern));\r\n                    }\r\n                }\r\n                if (!this._changeInstrument.isNoop())\r\n                    this._doc.record(this._changeInstrument, canReplaceLastChange);\r\n            }\r\n        } else {\r\n            const canReplaceLastChange: boolean = this._doc.lastChangeWas(this._changeInstrument);\r\n            this._changeInstrument = new ChangeGroup();\r\n            this._changeInstrument.append(new ChangeViewInstrument(this._doc, instrument));\r\n\r\n            if (!(this._doc.song.layeredInstruments && this._doc.channel < this._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount) && this._doc.song.patternInstruments) {\r\n                if (this.boxSelectionActive) {\r\n                    this._changeInstrument.append(new ChangeDuplicateSelectedReusedPatterns(this._doc, this.boxSelectionBar, this.boxSelectionWidth, this.boxSelectionChannel, this.boxSelectionHeight));\r\n                }\r\n                const instruments: number[] = [instrument];\r\n                for (const channelIndex of this._eachSelectedChannel()) {\r\n                    for (const pattern of this._eachSelectedPattern(channelIndex)) {\r\n                        this._changeInstrument.append(new ChangeSetPatternInstruments(this._doc, channelIndex, instruments, pattern));\r\n                    }\r\n                }\r\n                this._doc.record(this._changeInstrument, canReplaceLastChange);\r\n            } else if (!this._doc.hasRedoHistory()) {\r\n                // Don't erase existing redo history just to look at highlighted pattern.\r\n                this._doc.record(this._changeInstrument, canReplaceLastChange);\r\n            }\r\n        }\r\n    }\r\n\r\n    public resetBoxSelection(): void {\r\n        this.boxSelectionX0 = this.boxSelectionX1 = this._doc.bar;\r\n        this.boxSelectionY0 = this.boxSelectionY1 = this._doc.channel;\r\n    }\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Scale, Config} from \"../synth/SynthConfig\";\r\n\r\nexport class Preferences {\r\n\tpublic static readonly defaultVisibleOctaves: number = 3;\r\n\t\r\n\tpublic autoPlay: boolean;\r\n\tpublic autoFollow: boolean;\r\n\tpublic enableNotePreview: boolean;\r\n\tpublic showFifth: boolean;\r\n\tpublic notesOutsideScale: boolean;\r\n\tpublic defaultScale: number;\r\n\tpublic showLetters: boolean;\r\n\tpublic showChannels: boolean;\r\n\tpublic showScrollBar: boolean;\r\n\tpublic alwaysFineNoteVol: boolean;\r\n\tpublic displayVolumeBar: boolean;\r\n\tpublic instrumentCopyPaste: boolean;\r\n\tpublic enableChannelMuting: boolean;\r\n\tpublic colorTheme: string;\r\n\tpublic layout: string;\r\n\tpublic displayBrowserUrl: boolean;\r\n\tpublic volume: number = 75;\r\n\tpublic visibleOctaves: number = Preferences.defaultVisibleOctaves;\r\n\tpublic pressControlForShortcuts: boolean;\r\n\tpublic keyboardLayout: string;\r\n\tpublic enableMidi: boolean;\r\n\tpublic showRecordButton: boolean;\r\n\tpublic snapRecordedNotesToRhythm: boolean;\r\n\tpublic ignorePerformedNotesNotInScale: boolean;\r\n\tpublic metronomeCountIn: boolean;\r\n\tpublic metronomeWhileRecording: boolean;\r\n\t\r\n\tconstructor() {\r\n\t\tthis.reload();\r\n\t}\r\n\t\r\n\tpublic reload(): void {\r\n\t\tthis.autoPlay = window.localStorage.getItem(\"autoPlay\") == \"true\";\r\n\t\tthis.autoFollow = window.localStorage.getItem(\"autoFollow\") != \"false\";\r\n\t\tthis.enableNotePreview = window.localStorage.getItem(\"enableNotePreview\") != \"false\";\r\n\t\tthis.showFifth = window.localStorage.getItem(\"showFifth\") == \"true\";\r\n\t\tthis.notesOutsideScale = window.localStorage.getItem(\"notesOutsideScale\") == \"true\";\r\n\t\tthis.showLetters = window.localStorage.getItem(\"showLetters\") == \"true\";\r\n\t\tthis.showChannels = window.localStorage.getItem(\"showChannels\") == \"true\";\r\n\t\tthis.showScrollBar = window.localStorage.getItem(\"showScrollBar\") == \"true\";\r\n\t\tthis.alwaysFineNoteVol = window.localStorage.getItem(\"alwaysFineNoteVol\") == \"true\";\r\n\t\tthis.displayVolumeBar = window.localStorage.getItem(\"displayVolumeBar\") == \"true\";\r\n\t\tthis.instrumentCopyPaste = window.localStorage.getItem(\"instrumentCopyPaste\") == \"true\";\r\n\t\tthis.enableChannelMuting = window.localStorage.getItem(\"enableChannelMuting\") == \"true\";\r\n\t\tthis.displayBrowserUrl = window.localStorage.getItem(\"displayBrowserUrl\") != \"false\";\r\n\t\tthis.pressControlForShortcuts = window.localStorage.getItem(\"pressControlForShortcuts\") == \"true\";\r\n\t\tthis.enableMidi = window.localStorage.getItem(\"enableMidi\") != \"false\";\r\n\t\tthis.showRecordButton = window.localStorage.getItem(\"showRecordButton\") == \"true\";\r\n\t\tthis.snapRecordedNotesToRhythm = window.localStorage.getItem(\"snapRecordedNotesToRhythm\") == \"true\";\r\n\t\tthis.ignorePerformedNotesNotInScale = window.localStorage.getItem(\"ignorePerformedNotesNotInScale\") == \"true\";\r\n\t\tthis.metronomeCountIn = window.localStorage.getItem(\"metronomeCountIn\") != \"false\";\r\n\t\tthis.metronomeWhileRecording = window.localStorage.getItem(\"metronomeWhileRecording\") != \"false\";\r\n\t\tthis.keyboardLayout = window.localStorage.getItem(\"keyboardLayout\") || \"wickiHayden\";\r\n\t\tthis.layout = window.localStorage.getItem(\"layout\") || \"small\";\r\n\t\tthis.colorTheme = window.localStorage.getItem(\"colorTheme\") || \"dark classic\";\r\n\t\tthis.visibleOctaves = ((<any>window.localStorage.getItem(\"visibleOctaves\")) >>> 0) || Preferences.defaultVisibleOctaves;\r\n\t\t\r\n\t\tconst defaultScale: Scale | undefined = Config.scales.dictionary[window.localStorage.getItem(\"defaultScale\")!];\r\n\t\tthis.defaultScale = (defaultScale != undefined) ? defaultScale.index : 0;\r\n\t\t\r\n\t\tif (window.localStorage.getItem(\"volume\") != null) {\r\n\t\t\tthis.volume = Math.min(<any>window.localStorage.getItem(\"volume\") >>> 0, 75);\r\n\t\t}\r\n\t\t\r\n\t\tif (window.localStorage.getItem(\"fullScreen\") != null) {\r\n\t\t\tif (window.localStorage.getItem(\"fullScreen\") == \"true\") this.layout = \"long\";\r\n\t\t\twindow.localStorage.removeItem(\"fullScreen\");\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic save(): void {\r\n\t\twindow.localStorage.setItem(\"autoPlay\", this.autoPlay ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"autoFollow\", this.autoFollow ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"enableNotePreview\", this.enableNotePreview ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"showFifth\", this.showFifth ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"notesOutsideScale\", this.notesOutsideScale ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"defaultScale\", Config.scales[this.defaultScale].name);\r\n\t\twindow.localStorage.setItem(\"showLetters\", this.showLetters ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"showChannels\", this.showChannels ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"showScrollBar\", this.showScrollBar ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"alwaysFineNoteVol\", this.alwaysFineNoteVol ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"displayVolumeBar\", this.displayVolumeBar ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"enableChannelMuting\", this.enableChannelMuting ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"instrumentCopyPaste\", this.instrumentCopyPaste ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"displayBrowserUrl\", this.displayBrowserUrl ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"pressControlForShortcuts\", this.pressControlForShortcuts ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"enableMidi\", this.enableMidi ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"showRecordButton\", this.showRecordButton ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"snapRecordedNotesToRhythm\", this.snapRecordedNotesToRhythm ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"ignorePerformedNotesNotInScale\", this.ignorePerformedNotesNotInScale ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"metronomeCountIn\", this.metronomeCountIn ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"metronomeWhileRecording\", this.metronomeWhileRecording ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"keyboardLayout\", this.keyboardLayout);\r\n\t\twindow.localStorage.setItem(\"layout\", this.layout);\r\n\t\twindow.localStorage.setItem(\"colorTheme\", this.colorTheme);\r\n\t\twindow.localStorage.setItem(\"volume\", String(this.volume));\r\n\t\twindow.localStorage.setItem(\"visibleOctaves\", String(this.visibleOctaves));\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nexport class ChangeNotifier {\r\n\tprivate _watchers: (() => void)[] = [];\r\n\tprivate _dirty: boolean = false;\r\n\r\n\tpublic watch(watcher: () => void): void {\r\n\t\tif (this._watchers.indexOf(watcher) == -1) {\r\n\t\t\tthis._watchers.push(watcher);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic unwatch(watcher: () => void): void {\r\n\t\tconst index: number = this._watchers.indexOf(watcher);\r\n\t\tif (index != -1) {\r\n\t\t\tthis._watchers.splice(index, 1);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic changed(): void {\r\n\t\tthis._dirty = true;\r\n\t}\r\n\r\n\tpublic notifyWatchers(): void {\r\n\t\tif (!this._dirty) return;\r\n\t\tthis._dirty = false;\r\n\t\tfor (const watcher of this._watchers.concat()) {\r\n\t\t\twatcher();\r\n\t\t}\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Config} from \"../synth/SynthConfig\";\r\nimport {isMobile} from \"./EditorConfig\";\r\nimport {Pattern, Channel, Song, Synth} from \"../synth/synth\";\r\nimport { SongRecovery, generateUid } from \"./SongRecovery\";\r\nimport { ColorConfig } from \"./ColorConfig\";\r\nimport { Layout } from \"./Layout\";\r\nimport { SongPerformance } from \"./SongPerformance\";\r\nimport { Selection } from \"./Selection\";\r\nimport { Preferences } from \"./Preferences\";\r\nimport { Change } from \"./Change\";\r\nimport { ChangeNotifier } from \"./ChangeNotifier\";\r\nimport {ChangeSong, setDefaultInstruments, discardInvalidPatternInstruments} from \"./changes\";\r\n\r\n// Copied\r\nimport { InstrumentType } from \"../synth/SynthConfig\";\r\nimport { NotePin, Note, makeNotePin, Instrument } from \"../synth/synth\";\r\nimport { Preset, EditorConfig } from \"./EditorConfig\";\r\nimport { ChangeGroup } from \"./Change\";\r\nimport { removeDuplicatePatterns, ChangeReplacePatterns } from \"./changes\";\r\nimport { AnalogousDrum, analogousDrumMap, MidiChunkType, MidiFileFormat, MidiEventType, MidiControlEventMessage, MidiMetaEventMessage, MidiRegisteredParameterNumberMSB, MidiRegisteredParameterNumberLSB, midiVolumeToVolumeMult, midiExpressionToVolumeMult } from \"./Midi\";\r\nimport { ArrayBufferReader } from \"./ArrayBufferReader\";\r\n\r\ninterface HistoryState {\r\n\tcanUndo: boolean;\r\n\tsequenceNumber: number;\r\n\tbar: number;\r\n\tchannel: number;\r\n\tinstrument: number;\r\n\trecoveryUid: string;\r\n\tprompt: string | null;\r\n\t\tselection: {x0: number, x1: number, y0: number, y1: number, start: number, end: number};\r\n}\r\n\r\nexport class SongDocument {\r\n\tpublic song: Song;\r\n\tpublic synth: Synth;\r\n\tpublic performance: SongPerformance;\r\n\tpublic readonly notifier: ChangeNotifier = new ChangeNotifier();\r\n\tpublic readonly selection: Selection = new Selection(this);\r\n\tpublic readonly prefs: Preferences = new Preferences();\r\n\tpublic channel: number = 0;\r\n\tpublic muteEditorChannel: number = 0;\r\n\tpublic bar: number = 0;\r\n\tpublic recalcChannelNames: boolean;\r\n\tpublic recentPatternInstruments: number[][] = [];\r\n\tpublic viewedInstrument: number[] = [];\r\n\t\r\n\tpublic trackVisibleBars: number = 16;\r\n\tpublic trackVisibleChannels: number = 4;\r\n\tpublic barScrollPos: number = 0;\r\n\tpublic channelScrollPos: number = 0;\r\n\tpublic prompt: string | null = null;\r\n\t\r\n\tpublic addedEffect: boolean = false;\r\n\tpublic addedEnvelope: boolean = false;\r\n\tpublic currentPatternIsDirty: boolean = false;\r\n\t\r\n\tprivate static readonly _maximumUndoHistory: number = 300;\r\n\tprivate _recovery: SongRecovery = new SongRecovery();\r\n\tprivate _recoveryUid: string;\r\n\tprivate _recentChange: Change | null = null;\r\n\tprivate _sequenceNumber: number = 0;\r\n\tprivate _lastSequenceNumber: number = 0;\r\n\tprivate _stateShouldBePushed: boolean = false;\r\n\tprivate _recordedNewSong: boolean = false;\r\n\tpublic _waitingToUpdateState: boolean = false;\r\n\t\r\n\tpublic static get observedAttributes() { return ['src']; }\r\n\r\n\tconstructor() {\r\n\t\tthis.notifier.watch(this._validateDocState);\r\n\t\t\r\n\t\tColorConfig.setTheme(this.prefs.colorTheme);\r\n\t\tLayout.setLayout(this.prefs.layout);\r\n\t\t\r\n\t\tif (window.sessionStorage.getItem(\"currentUndoIndex\") == null) {\r\n\t\t\twindow.sessionStorage.setItem(\"currentUndoIndex\", \"0\");\r\n\t\t\twindow.sessionStorage.setItem(\"oldestUndoIndex\", \"0\");\r\n\t\t\twindow.sessionStorage.setItem(\"newestUndoIndex\", \"0\");\r\n\t\t}\r\n\t\t\t\r\n\t\tlet songString: string = window.location.hash;\r\n\t\tif (songString == \"\") {\r\n\t\t\tsongString = this._getHash();\r\n\t\t}\r\n\t\tthis.song = new Song(songString);\r\n\t\tif (songString == \"\" || songString == undefined) {\r\n\t\t\tsetDefaultInstruments(this.song);\r\n\t\t\tthis.song.scale = this.prefs.defaultScale;\r\n\t\t}\r\n\t\tsongString = this.song.toBase64String();\r\n\t\tthis.synth = new Synth(this.song);\r\n\t\tthis.synth.volume = this._calcVolume();\r\n\t\tthis.synth.anticipatePoorPerformance = isMobile;\r\n\t\t\r\n\t\tlet state: HistoryState | null = this._getHistoryState();\r\n\t\tif (state == null) {\r\n\t\t\t// When the page is first loaded, indicate that undo is NOT possible.\r\n\t\t\tstate = {canUndo: false, sequenceNumber: 0, bar: 0, channel: 0, instrument: 0, recoveryUid: generateUid(), prompt: null, selection: this.selection.toJSON()};\r\n\t\t}\r\n\t\tif (state.recoveryUid == undefined) state.recoveryUid = generateUid();\r\n\t\tthis._replaceState(state, songString);\r\n\t\twindow.addEventListener(\"hashchange\", this._whenHistoryStateChanged);\r\n\t\twindow.addEventListener(\"popstate\", this._whenHistoryStateChanged);\r\n\t\t\t\r\n\t\tthis.bar = state.bar | 0;\r\n\t\tthis.channel = state.channel | 0;\r\n\t\tfor (let i: number = 0; i <= this.channel; i++) this.viewedInstrument[i] = 0;\r\n\t\tthis.viewedInstrument[this.channel] = state.instrument | 0;\r\n\t\tthis._recoveryUid = state.recoveryUid;\r\n\t\t//this.barScrollPos = Math.max(0, this.bar - (this.trackVisibleBars - 6));\r\n\t\tthis.prompt = state.prompt;\r\n\t\tthis.selection.fromJSON(state.selection);\r\n\t\t\t\r\n\t\t// For all input events, catch them when they are about to finish bubbling,\r\n\t\t// presumably after all handlers are done updating the model, then update the\r\n\t\t// view before the screen renders. mouseenter and mouseleave do not bubble,\r\n\t\t// but they are immediately followed by mousemove which does. \r\n\t\tfor (const eventName of [\"input\", \"change\", \"click\", \"keyup\", \"keydown\", \"mousedown\", \"mousemove\", \"mouseup\", \"touchstart\", \"touchmove\", \"touchend\", \"touchcancel\"]) {\r\n\t\t\twindow.addEventListener(eventName, this._cleanDocument);\r\n\t\t}\r\n\t\t\r\n\t\tthis._validateDocState();\r\n\t\tthis.performance = new SongPerformance(this);\r\n\t}\r\n\r\n\tpublic _parseMidiFile(buffer: ArrayBuffer): void {\r\n\t\t\t\r\n\t\t// First, split the file into separate buffer readers for each chunk. There should be one header chunk and one or more track chunks.\r\n\t\tconst reader = new ArrayBufferReader(new DataView(buffer));\r\n\t\tlet headerReader: ArrayBufferReader | null = null;\r\n\t\tinterface Track {\r\n\t\t\treader: ArrayBufferReader;\r\n\t\t\tnextEventMidiTick: number;\r\n\t\t\tended: boolean;\r\n\t\t\trunningStatus: number;\r\n\t\t}\r\n\t\tconst tracks: Track[] = [];\r\n\t\t\twhile(reader.hasMore()) {\r\n\t\t\tconst chunkType: number = reader.readUint32();\r\n\t\t\tconst chunkLength: number = reader.readUint32();\r\n\t\t\tif (chunkType == MidiChunkType.header) {\r\n\t\t\t\tif (headerReader == null) {\r\n\t\t\t\t\theaderReader = reader.getReaderForNextBytes(chunkLength);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconsole.error(\"This MIDI file has more than one header chunk.\");\r\n\t\t\t\t}\r\n\t\t\t} else if (chunkType == MidiChunkType.track) {\r\n\t\t\t\tconst trackReader: ArrayBufferReader = reader.getReaderForNextBytes(chunkLength);\r\n\t\t\t\tif (trackReader.hasMore()) {\r\n\t\t\t\t\ttracks.push({\r\n\t\t\t\t\t\treader: trackReader,\r\n\t\t\t\t\t\tnextEventMidiTick: trackReader.readMidiVariableLength(),\r\n\t\t\t\t\t\tended: false,\r\n\t\t\t\t\t\trunningStatus: -1,\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t// Unknown chunk type. Skip it.\r\n\t\t\t\treader.skipBytes(chunkLength);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\t\r\n\t\tif (headerReader == null) {\r\n\t\t\tconsole.error(\"No header chunk found in this MIDI file.\");\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst fileFormat: number = headerReader.readUint16();\r\n\t\t/*const trackCount: number =*/ headerReader.readUint16();\r\n\t\tconst midiTicksPerBeat: number = headerReader.readUint16();\r\n\t\t\t\r\n\t\t// Midi tracks are generally intended to be played in parallel, but in the format\r\n\t\t// MidiFileFormat.independentTracks, they are played in sequence. Make a list of all\r\n\t\t// of the track indices that should be played in parallel (one or all of the tracks).\r\n\t\tlet currentIndependentTrackIndex: number = 0;\r\n\t\tconst currentTrackIndices: number[] = [];\r\n\t\tconst independentTracks: boolean = (fileFormat == MidiFileFormat.independentTracks);\r\n\t\tif (independentTracks) {\r\n\t\t\tcurrentTrackIndices.push(currentIndependentTrackIndex);\r\n\t\t} else {\r\n\t\t\tfor (let trackIndex: number = 0; trackIndex < tracks.length; trackIndex++) {\r\n\t\t\t\tcurrentTrackIndices.push(trackIndex);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\t\r\n\t\tinterface NoteEvent {\r\n\t\t\tmidiTick: number;\r\n\t\t\tpitch: number;\r\n\t\t\tvelocity: number;\r\n\t\t\tprogram: number;\r\n\t\t\tinstrumentVolume: number;\r\n\t\t\tinstrumentPan: number;\r\n\t\t\ton: boolean;\r\n\t\t}\r\n\t\tinterface PitchBendEvent {\r\n\t\t\tmidiTick: number;\r\n\t\t\tinterval: number;\r\n\t\t}\r\n\t\tinterface NoteSizeEvent {\r\n\t\t\tmidiTick: number;\r\n\t\t\tsize: number;\r\n\t\t}\r\n\t\t\t\r\n\t\t// To read a MIDI file we have to simulate state changing over time.\r\n\t\t// Keep a record of various parameters for each channel that may\r\n\t\t// change over time, initialized to default values.\r\n\t\t// Consider making a MidiChannel class and single array of midiChannels.\r\n\t\t\tconst channelRPNMSB: number[] = [0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff];\r\n\t\t\tconst channelRPNLSB: number[] = [0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff];\r\n\t\t\tconst pitchBendRangeMSB: number[] = [2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2]; // pitch bend range defaults to 2 semitones.\r\n\t\t\tconst pitchBendRangeLSB: number[] = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]; // and 0 cents.\r\n\t\t\tconst currentInstrumentProgram: number[] = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];\r\n\t\t\tconst currentInstrumentVolumes: number[] = [100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100];\r\n\t\t\tconst currentInstrumentPans: number[] = [64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64];\r\n\t\t\tconst noteEvents: NoteEvent[][] = [[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]];\r\n\t\t\tconst pitchBendEvents: PitchBendEvent[][] = [[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]];\r\n\t\tconst noteSizeEvents: NoteSizeEvent[][] = [[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]];\r\n\t\tlet microsecondsPerBeat: number = 500000; // Tempo in microseconds per \"quarter\" note, commonly known as a \"beat\", default is equivalent to 120 beats per minute.\r\n\t\tlet beatsPerBar: number = 8;\r\n\t\tlet numSharps: number = 0;\r\n\t\tlet isMinor: boolean = false;\r\n\t\t\t\r\n\t\t// Progress in time through all tracks (in parallel or in sequence) recording state changes and events until all tracks have ended.\r\n\t\tlet currentMidiTick: number = 0;\r\n\t\twhile (true) {\r\n\t\t\tlet nextEventMidiTick: number = Number.MAX_VALUE;\r\n\t\t\tlet anyTrackHasMore: boolean = false;\r\n\t\t\tfor (const trackIndex of currentTrackIndices) {\r\n\t\t\t\t\t\r\n\t\t\t\t// Parse any events in this track that occur at the currentMidiTick.\r\n\t\t\t\tconst track: Track = tracks[trackIndex];\r\n\t\t\t\twhile (!track.ended && track.nextEventMidiTick == currentMidiTick) {\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t// If the most significant bit is set in the first byte\r\n\t\t\t\t\t// of the event, it's a new event status, otherwise\r\n\t\t\t\t\t// reuse the running status and save the next byte for\r\n\t\t\t\t\t// the content of the event. I'm assuming running status\r\n\t\t\t\t\t// is separate for each track.\r\n\t\t\t\t\tconst peakStatus: number = track.reader.peakUint8();\r\n\t\t\t\t\tconst eventStatus: number = (peakStatus & 0x80) ? track.reader.readUint8() : track.runningStatus;\r\n\t\t\t\t\tconst eventType: number = eventStatus & 0xF0;\r\n\t\t\t\t\tconst eventChannel: number = eventStatus & 0x0F;\r\n\t\t\t\t\tif (eventType != MidiEventType.metaAndSysex) {\r\n\t\t\t\t\t\ttrack.runningStatus = eventStatus;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tlet foundTrackEndEvent: boolean = false;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tswitch (eventType) {\r\n\t\t\t\t\t\tcase MidiEventType.noteOff: {\r\n\t\t\t\t\t\t\tconst pitch: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\t/*const velocity: number =*/ track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\t\tnoteEvents[eventChannel].push({midiTick: currentMidiTick, pitch: pitch, velocity: 0.0, program: -1, instrumentVolume: -1, instrumentPan: -1, on: false});\r\n\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\tcase MidiEventType.noteOn: {\r\n\t\t\t\t\t\t\tconst pitch: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\tconst velocity: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\tif (velocity == 0) {\r\n\t\t\t\t\t\t\t\t\tnoteEvents[eventChannel].push({midiTick: currentMidiTick, pitch: pitch, velocity: 0.0, program: -1, instrumentVolume: -1, instrumentPan: -1, on: false});\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tconst volume: number = Math.max(0, Math.min(Config.volumeRange - 1, Math.round(\r\n\t\t\t\t\t\t\t\t\tSynth.volumeMultToInstrumentVolume(midiVolumeToVolumeMult(currentInstrumentVolumes[eventChannel]))\r\n\t\t\t\t\t\t\t\t)));\r\n\t\t\t\t\t\t\t\tconst pan: number = Math.max(0, Math.min(Config.panMax, Math.round(\r\n\t\t\t\t\t\t\t\t\t((currentInstrumentPans[eventChannel] - 64) / 63 + 1) * Config.panCenter\r\n\t\t\t\t\t\t\t\t)));\r\n\t\t\t\t\t\t\t\tnoteEvents[eventChannel].push({\r\n\t\t\t\t\t\t\t\t\tmidiTick: currentMidiTick,\r\n\t\t\t\t\t\t\t\t\tpitch: pitch,\r\n\t\t\t\t\t\t\t\t\tvelocity: Math.max(0.0, Math.min(1.0, (velocity + 14) / 90.0)),\r\n\t\t\t\t\t\t\t\t\tprogram: currentInstrumentProgram[eventChannel],\r\n\t\t\t\t\t\t\t\t\tinstrumentVolume: volume,\r\n\t\t\t\t\t\t\t\t\tinstrumentPan: pan,\r\n\t\t\t\t\t\t\t\t\ton: true,\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\tcase MidiEventType.keyPressure: {\r\n\t\t\t\t\t\t\t/*const pitch: number =*/ track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\t/*const pressure: number =*/ track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\tcase MidiEventType.controlChange: {\r\n\t\t\t\t\t\t\tconst message: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\tconst value: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\t//console.log(\"Control change, message:\", message, \"value:\", value);\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tswitch (message) {\r\n\t\t\t\t\t\t\t\tcase MidiControlEventMessage.setParameterMSB: {\r\n\t\t\t\t\t\t\t\t\tif (channelRPNMSB[eventChannel] == MidiRegisteredParameterNumberMSB.pitchBendRange && channelRPNLSB[eventChannel] == MidiRegisteredParameterNumberLSB.pitchBendRange) {\r\n\t\t\t\t\t\t\t\t\t\tpitchBendRangeMSB[eventChannel] = value;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\t\t\tcase MidiControlEventMessage.volumeMSB: {\r\n\t\t\t\t\t\t\t\t\tcurrentInstrumentVolumes[eventChannel] = value;\r\n\t\t\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\t\t\tcase MidiControlEventMessage.panMSB: {\r\n\t\t\t\t\t\t\t\t\tcurrentInstrumentPans[eventChannel] = value;\r\n\t\t\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\t\t\tcase MidiControlEventMessage.expressionMSB: {\r\n\t\t\t\t\t\t\t\t\tnoteSizeEvents[eventChannel].push({midiTick: currentMidiTick, size: Synth.volumeMultToNoteSize(midiExpressionToVolumeMult(value))});\r\n\t\t\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\t\t\tcase MidiControlEventMessage.setParameterLSB: {\r\n\t\t\t\t\t\t\t\t\tif (channelRPNMSB[eventChannel] == MidiRegisteredParameterNumberMSB.pitchBendRange && channelRPNLSB[eventChannel] == MidiRegisteredParameterNumberLSB.pitchBendRange) {\r\n\t\t\t\t\t\t\t\t\t\tpitchBendRangeLSB[eventChannel] = value;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\t\t\tcase MidiControlEventMessage.registeredParameterNumberLSB: {\r\n\t\t\t\t\t\t\t\t\tchannelRPNLSB[eventChannel] = value;\r\n\t\t\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\t\t\tcase MidiControlEventMessage.registeredParameterNumberMSB: {\r\n\t\t\t\t\t\t\t\t\tchannelRPNMSB[eventChannel] = value;\r\n\t\t\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\tcase MidiEventType.programChange: {\r\n\t\t\t\t\t\t\tconst program: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\tcurrentInstrumentProgram[eventChannel] = program;\r\n\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\tcase MidiEventType.channelPressure: {\r\n\t\t\t\t\t\t\t/*const pressure: number =*/ track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\tcase MidiEventType.pitchBend: {\r\n\t\t\t\t\t\t\tconst lsb: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\tconst msb: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tconst pitchBend: number = (((msb << 7) | lsb) / 0x2000) - 1.0;\r\n\t\t\t\t\t\t\tconst pitchBendRange: number = pitchBendRangeMSB[eventChannel] + pitchBendRangeLSB[eventChannel] * 0.01;\r\n\t\t\t\t\t\t\tconst interval: number = pitchBend * pitchBendRange;\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tpitchBendEvents[eventChannel].push({midiTick: currentMidiTick, interval: interval});\r\n\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\tcase MidiEventType.metaAndSysex: {\r\n\t\t\t\t\t\t\tif (eventStatus == MidiEventType.meta) {\r\n\t\t\t\t\t\t\t\tconst message: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\t\tconst length: number = track.reader.readMidiVariableLength();\r\n\t\t\t\t\t\t\t\t//console.log(\"Meta, message:\", message, \"length:\", length);\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tif (message == MidiMetaEventMessage.endOfTrack) {\r\n\t\t\t\t\t\t\t\t\tfoundTrackEndEvent = true;\r\n\t\t\t\t\t\t\t\t\ttrack.reader.skipBytes(length);\r\n\t\t\t\t\t\t\t\t} else if (message == MidiMetaEventMessage.tempo) {\r\n\t\t\t\t\t\t\t\t\tmicrosecondsPerBeat = track.reader.readUint24();\r\n\t\t\t\t\t\t\t\t\ttrack.reader.skipBytes(length - 3);\r\n\t\t\t\t\t\t\t\t} else if (message == MidiMetaEventMessage.timeSignature) {\r\n\t\t\t\t\t\t\t\t\tconst numerator: number = track.reader.readUint8();\r\n\t\t\t\t\t\t\t\t\tlet denominatorExponent: number = track.reader.readUint8();\r\n\t\t\t\t\t\t\t\t\t/*const midiClocksPerMetronome: number =*/ track.reader.readUint8();\r\n\t\t\t\t\t\t\t\t\t/*const thirtySecondNotesPer24MidiClocks: number =*/ track.reader.readUint8();\r\n\t\t\t\t\t\t\t\t\ttrack.reader.skipBytes(length - 4);\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t// A beat is a quarter note. \r\n\t\t\t\t\t\t\t\t\t// A ratio of 4/4, or 1/1, corresponds to 4 beats per bar.\r\n\t\t\t\t\t\t\t\t\t// Apply the numerator first.\r\n\t\t\t\t\t\t\t\t\tbeatsPerBar = numerator * 4;\r\n\t\t\t\t\t\t\t\t\t// Then apply the denominator, dividing by two until either\r\n\t\t\t\t\t\t\t\t\t// the denominator is satisfied or there's an odd number of\r\n\t\t\t\t\t\t\t\t\t// beats. BeepBox doesn't support fractional beats in a bar.\r\n\t\t\t\t\t\t\t\t\twhile ((beatsPerBar & 1) == 0 && (denominatorExponent > 0 || beatsPerBar > Config.beatsPerBarMax) && beatsPerBar >= Config.beatsPerBarMin * 2) {\r\n\t\t\t\t\t\t\t\t\t\tbeatsPerBar = beatsPerBar >> 1;\r\n\t\t\t\t\t\t\t\t\t\tdenominatorExponent = denominatorExponent - 1;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tbeatsPerBar = Math.max(Config.beatsPerBarMin, Math.min(Config.beatsPerBarMax, beatsPerBar));\r\n\t\t\t\t\t\t\t\t} else if (message == MidiMetaEventMessage.keySignature) {\r\n\t\t\t\t\t\t\t\t\tnumSharps = track.reader.readInt8(); // Note: can be negative for flats.\r\n\t\t\t\t\t\t\t\t\tisMinor = track.reader.readUint8() == 1; // 0: major, 1: minor\r\n\t\t\t\t\t\t\t\t\ttrack.reader.skipBytes(length - 2);\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\t// Ignore other meta event message types.\r\n\t\t\t\t\t\t\t\t\ttrack.reader.skipBytes(length);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t} else if (eventStatus == 0xF0 || eventStatus == 0xF7) {\r\n\t\t\t\t\t\t\t\t// Sysex events, just skip the data.\r\n\t\t\t\t\t\t\t\tconst length: number = track.reader.readMidiVariableLength();\r\n\t\t\t\t\t\t\t\ttrack.reader.skipBytes(length);\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tconsole.error(\"Unrecognized event status: \" + eventStatus);\r\n\t\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\tdefault: {\r\n\t\t\t\t\t\t\tconsole.error(\"Unrecognized event type: \" + eventType);\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tif (!foundTrackEndEvent && track.reader.hasMore()) {\r\n\t\t\t\t\t\ttrack.nextEventMidiTick = currentMidiTick + track.reader.readMidiVariableLength();\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\ttrack.ended = true;\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t// If the tracks are sequential, start the next track when this one ends.\r\n\t\t\t\t\t\tif (independentTracks) {\r\n\t\t\t\t\t\t\tcurrentIndependentTrackIndex++;\r\n\t\t\t\t\t\t\tif (currentIndependentTrackIndex < tracks.length) {\r\n\t\t\t\t\t\t\t\tcurrentTrackIndices[0] = currentIndependentTrackIndex;\r\n\t\t\t\t\t\t\t\ttracks[currentIndependentTrackIndex].nextEventMidiTick += currentMidiTick;\r\n\t\t\t\t\t\t\t\tnextEventMidiTick = Math.min(nextEventMidiTick, tracks[currentIndependentTrackIndex].nextEventMidiTick);\r\n\t\t\t\t\t\t\t\tanyTrackHasMore = true;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\tif (!track.ended) {\r\n\t\t\t\t\tanyTrackHasMore = true;\r\n\t\t\t\t\tnextEventMidiTick = Math.min(nextEventMidiTick, track.nextEventMidiTick);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\t\r\n\t\t\tif (anyTrackHasMore) {\r\n\t\t\t\tcurrentMidiTick = nextEventMidiTick;\r\n\t\t\t} else {\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\t\r\n\t\t// Now the MIDI file is fully parsed. Next, constuct BeepBox channels out of the data.\r\n\t\tconst microsecondsPerMinute: number = 60 * 1000 * 1000;\r\n\t\tconst beatsPerMinute: number = Math.max(Config.tempoMin, Math.min(Config.tempoMax, Math.round(microsecondsPerMinute / microsecondsPerBeat)));\r\n\t\tconst midiTicksPerPart: number = midiTicksPerBeat / Config.partsPerBeat;\r\n\t\tconst partsPerBar: number = Config.partsPerBeat * beatsPerBar;\r\n\t\tconst songTotalBars: number = Math.ceil(currentMidiTick / midiTicksPerPart / partsPerBar);\r\n\t\t\t\r\n\t\tfunction quantizeMidiTickToPart(midiTick: number): number {\r\n\t\t\treturn Math.round(midiTick / midiTicksPerPart);\r\n\t\t}\r\n\r\n\t\tlet key: number = numSharps;\r\n\t\tif (isMinor) key += 3; // Diatonic C Major has the same sharps/flats as A Minor, and these keys are 3 semitones apart.\r\n\t\tif ((key & 1) == 1) key += 6; // If the number of sharps/flats is odd, rotate it halfway around the circle of fifths. The key of C# has little in common with the key of C.\r\n\t\twhile (key < 0) key += 12; // Wrap around to a range from 0 to 11.\r\n\t\tkey = key % 12; // Wrap around to a range from 0 to 11.\r\n\t\t\t\r\n\t\t// Convert each midi channel into a BeepBox channel.\r\n\t\tconst pitchChannels: Channel[] = [];\r\n\t\tconst noiseChannels: Channel[] = [];\r\n\t\tconst modChannels: Channel[] = [];\r\n\t\tfor (let midiChannel: number = 0; midiChannel < 16; midiChannel++) {\r\n\t\t\tif (noteEvents[midiChannel].length == 0) continue;\r\n\t\t\t\t\r\n\t\t\tconst channel: Channel = new Channel();\r\n\t\t\t\t\r\n\t\t\tconst channelPresetValue: number | null = EditorConfig.midiProgramToPresetValue(noteEvents[midiChannel][0].program);\r\n\t\t\tconst channelPreset: Preset | null = (channelPresetValue == null) ? null : EditorConfig.valueToPreset(channelPresetValue);\r\n\t\t\t\t\r\n\t\t\tconst isDrumsetChannel: boolean = (midiChannel == 9);\r\n\t\t\tconst isNoiseChannel: boolean = isDrumsetChannel || (channelPreset != null && channelPreset.isNoise == true);\r\n\t\t\tconst isModChannel: boolean = (channelPreset != null && channelPreset.isMod == true);\r\n\t\t\tconst channelBasePitch: number = isNoiseChannel ? Config.spectrumBasePitch : Config.keys[key].basePitch;\r\n\t\t\tconst intervalScale: number = isNoiseChannel ? Config.noiseInterval : 1;\r\n\t\t\tconst midiIntervalScale: number = isNoiseChannel ? 0.5 : 1;\r\n\t\t\tconst channelMaxPitch: number = isNoiseChannel ? Config.drumCount - 1 : Config.maxPitch;\r\n\t\t\t\t\r\n\t\t\tif (isNoiseChannel) {\r\n\t\t\t\tif (isDrumsetChannel) {\r\n\t\t\t\t\tnoiseChannels.unshift(channel);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tnoiseChannels.push(channel);\r\n\t\t\t\t}\r\n\t\t\t} else if (isModChannel) {\r\n\t\t\t\tmodChannels.push(channel);\r\n\t\t\t} else {\r\n\t\t\t\tpitchChannels.push(channel);\r\n\t\t\t}\r\n\t\t\t\t\r\n\t\t\tlet currentVelocity: number = 1.0;\r\n\t\t\tlet currentProgram: number = 0;\r\n\t\t\tlet currentInstrumentVolume: number = 0;\r\n\t\t\tlet currentInstrumentPan: number = Config.panCenter;\r\n\t\t\t\t\r\n\t\t\tif (isDrumsetChannel) {\r\n\t\t\t\tconst heldPitches: number[] = [];\r\n\t\t\t\tlet currentBar: number = -1;\r\n\t\t\t\tlet pattern: Pattern | null = null;\r\n\t\t\t\tlet prevEventPart: number = 0;\r\n\t\t\t\tlet setInstrumentVolume: boolean = false;\r\n\t\t\t\t\t\r\n\t\t\t\tconst presetValue: number = EditorConfig.nameToPresetValue(\"standard drumset\")!;\r\n\t\t\t\tconst preset: Preset = EditorConfig.valueToPreset(presetValue)!;\r\n\t\t\t\tconst instrument: Instrument = new Instrument(false, false);\r\n\t\t\t\t\tinstrument.fromJsonObject(preset.settings, false, false, false, false, 1);\r\n\t\t\t\t\t\r\n\t\t\t\tinstrument.preset = presetValue;\r\n\t\t\t\tchannel.instruments.push(instrument);\r\n\r\n\t\t\t\tfor (let noteEventIndex: number = 0; noteEventIndex <= noteEvents[midiChannel].length; noteEventIndex++) {\r\n\t\t\t\t\tconst noMoreNotes: boolean = noteEventIndex == noteEvents[midiChannel].length;\r\n\t\t\t\t\tconst noteEvent: NoteEvent | null = noMoreNotes ? null : noteEvents[midiChannel][noteEventIndex];\r\n\t\t\t\t\tconst nextEventPart: number = noteEvent == null ? Number.MAX_SAFE_INTEGER : quantizeMidiTickToPart(noteEvent.midiTick);\r\n\t\t\t\t\tif (heldPitches.length > 0 && nextEventPart > prevEventPart && (noteEvent == null || noteEvent.on)) {\r\n\t\t\t\t\t\tconst bar: number = Math.floor(prevEventPart / partsPerBar);\r\n\t\t\t\t\t\tconst barStartPart: number = bar * partsPerBar;\r\n\t\t\t\t\t\t// Ensure a pattern exists for the current bar before inserting notes into it.\r\n\t\t\t\t\t\tif (currentBar != bar || pattern == null) {\r\n\t\t\t\t\t\t\tcurrentBar++;\r\n\t\t\t\t\t\t\twhile (currentBar < bar) {\r\n\t\t\t\t\t\t\t\tchannel.bars[currentBar] = 0;\r\n\t\t\t\t\t\t\t\tcurrentBar++;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tpattern = new Pattern();\r\n\t\t\t\t\t\t\tchannel.patterns.push(pattern);\r\n\t\t\t\t\t\t\tchannel.bars[currentBar] = channel.patterns.length;\r\n\t\t\t\t\t\t\tpattern.instruments[0] = 0;\r\n\t\t\t\t\t\t\tpattern.instruments.length = 1;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t// Use the loudest volume setting for the instrument, since \r\n\t\t\t\t\t\t// many midis unfortunately use the instrument volume control to fade\r\n\t\t\t\t\t\t// in at the beginning and we don't want to get stuck with the initial\r\n\t\t\t\t\t\t// zero volume.\r\n\t\t\t\t\t\tif (!setInstrumentVolume || instrument.volume > currentInstrumentVolume) {\r\n\t\t\t\t\t\t\tinstrument.volume = currentInstrumentVolume;\r\n\t\t\t\t\t\t\tinstrument.pan = currentInstrumentPan;\r\n\t\t\t\t\t\t\tinstrument.panDelay = 0;\r\n\t\t\t\t\t\t\tsetInstrumentVolume = true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tconst drumFreqs: number[] = [];\r\n\t\t\t\t\t\tlet minDuration: number = channelMaxPitch;\r\n\t\t\t\t\t\tlet maxDuration: number = 0;\r\n\t\t\t\t\t\tlet noteSize: number = 1; // the minimum non-zero note size.\r\n\t\t\t\t\t\tfor (const pitch of heldPitches) {\r\n\t\t\t\t\t\t\tconst drum: AnalogousDrum | undefined = analogousDrumMap[pitch];\r\n\t\t\t\t\t\t\tif (drumFreqs.indexOf(drum.frequency) == -1) {\r\n\t\t\t\t\t\t\t\tdrumFreqs.push(drum.frequency);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tnoteSize = Math.max(noteSize, Math.round(drum.volume * currentVelocity));\r\n\t\t\t\t\t\t\tminDuration = Math.min(minDuration, drum.duration);\r\n\t\t\t\t\t\t\tmaxDuration = Math.max(maxDuration, drum.duration);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tconst duration: number = Math.min(maxDuration, Math.max(minDuration, 2));\r\n\t\t\t\t\t\tconst noteStartPart: number = prevEventPart - barStartPart;\r\n\t\t\t\t\t\tconst noteEndPart: number = Math.min(partsPerBar, Math.min(nextEventPart - barStartPart, noteStartPart + duration * 6));\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tconst note: Note = new Note(-1, noteStartPart, noteEndPart, noteSize, true);\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tnote.pitches.length = 0;\r\n\t\t\t\t\t\tfor (let pitchIndex: number = 0; pitchIndex < Math.min(Config.maxChordSize, drumFreqs.length); pitchIndex++) {\r\n\t\t\t\t\t\t\tconst heldPitch: number = drumFreqs[pitchIndex + Math.max(0, drumFreqs.length - Config.maxChordSize)];\r\n\t\t\t\t\t\t\tif (note.pitches.indexOf(heldPitch) == -1) {\r\n\t\t\t\t\t\t\t\tnote.pitches.push(heldPitch);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tpattern.notes.push(note);\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\theldPitches.length = 0;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t// Process the next midi note event before continuing, updating the list of currently held pitches.\r\n\t\t\t\t\tif (noteEvent != null && noteEvent.on && analogousDrumMap[noteEvent.pitch] != undefined) {\r\n\t\t\t\t\t\theldPitches.push(noteEvent.pitch);\r\n\t\t\t\t\t\tprevEventPart = nextEventPart;\r\n\t\t\t\t\t\tcurrentVelocity = noteEvent.velocity;\r\n\t\t\t\t\t\tcurrentInstrumentVolume = noteEvent.instrumentVolume;\r\n\t\t\t\t\t\tcurrentInstrumentPan = noteEvent.instrumentPan;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t// If not a drumset, handle as a tonal instrument.\r\n\t\t\t\t\t\r\n\t\t\t\t// Advance the pitch bend and note size timelines to the given midiTick, \r\n\t\t\t\t// changing the value of currentMidiInterval or currentMidiNoteSize.\r\n\t\t\t\t// IMPORTANT: These functions can't rewind!\r\n\t\t\t\tlet currentMidiInterval: number = 0.0;\r\n\t\t\t\tlet currentMidiNoteSize: number = Config.noteSizeMax;\r\n\t\t\t\tlet pitchBendEventIndex: number = 0;\r\n\t\t\t\tlet noteSizeEventIndex: number = 0;\r\n\t\t\t\tfunction updateCurrentMidiInterval(midiTick: number) {\r\n\t\t\t\t\twhile (pitchBendEventIndex < pitchBendEvents[midiChannel].length && pitchBendEvents[midiChannel][pitchBendEventIndex].midiTick <= midiTick) {\r\n\t\t\t\t\t\tcurrentMidiInterval = pitchBendEvents[midiChannel][pitchBendEventIndex].interval;\r\n\t\t\t\t\t\tpitchBendEventIndex++;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tfunction updateCurrentMidiNoteSize(midiTick: number) {\r\n\t\t\t\t\twhile (noteSizeEventIndex < noteSizeEvents[midiChannel].length && noteSizeEvents[midiChannel][noteSizeEventIndex].midiTick <= midiTick) {\r\n\t\t\t\t\t\tcurrentMidiNoteSize = noteSizeEvents[midiChannel][noteSizeEventIndex].size;\r\n\t\t\t\t\t\tnoteSizeEventIndex++;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\tconst instrumentByProgram: Instrument[] = [];\r\n\t\t\t\tconst heldPitches: number[] = [];\r\n\t\t\t\tlet currentBar: number = -1;\r\n\t\t\t\tlet pattern: Pattern | null = null;\r\n\t\t\t\tlet prevEventMidiTick: number = 0;\r\n\t\t\t\tlet prevEventPart: number = 0;\r\n\t\t\t\tlet pitchSum: number = 0;\r\n\t\t\t\tlet pitchCount: number = 0;\r\n\t\t\t\t\t\r\n\t\t\t\tfor (let noteEvent of noteEvents[midiChannel]) {\r\n\t\t\t\t\tconst nextEventMidiTick: number = noteEvent.midiTick;\r\n\t\t\t\t\tconst nextEventPart: number = quantizeMidiTickToPart(nextEventMidiTick);\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tif (heldPitches.length > 0 && nextEventPart > prevEventPart) {\r\n\t\t\t\t\t\t// If there are any pitches held between the previous event and the next\r\n\t\t\t\t\t\t// event, iterate over all bars covered by this time period, ensure they\r\n\t\t\t\t\t\t// have a pattern instantiated, and insert notes for these pitches.\r\n\t\t\t\t\t\tconst startBar: number = Math.floor(prevEventPart / partsPerBar);\r\n\t\t\t\t\t\tconst endBar: number = Math.ceil(nextEventPart / partsPerBar);\r\n\t\t\t\t\t\tlet createdNote: boolean = false;\r\n\t\t\t\t\t\tfor (let bar: number = startBar; bar < endBar; bar++) {\r\n\t\t\t\t\t\t\tconst barStartPart: number = bar * partsPerBar;\r\n\t\t\t\t\t\t\tconst barStartMidiTick: number = bar * beatsPerBar * midiTicksPerBeat;\r\n\t\t\t\t\t\t\tconst barEndMidiTick: number = (bar + 1) * beatsPerBar * midiTicksPerBeat;\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tconst noteStartPart: number = Math.max(0, prevEventPart - barStartPart);\r\n\t\t\t\t\t\t\tconst noteEndPart: number = Math.min(partsPerBar, nextEventPart - barStartPart);\r\n\t\t\t\t\t\t\tconst noteStartMidiTick: number = Math.max(barStartMidiTick, prevEventMidiTick);\r\n\t\t\t\t\t\t\tconst noteEndMidiTick: number = Math.min(barEndMidiTick, nextEventMidiTick);\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif (noteStartPart < noteEndPart) {\r\n\t\t\t\t\t\t\t\tconst presetValue: number | null = EditorConfig.midiProgramToPresetValue(currentProgram);\r\n\t\t\t\t\t\t\t\tconst preset: Preset | null = (presetValue == null) ? null : EditorConfig.valueToPreset(presetValue);\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// Ensure a pattern exists for the current bar before inserting notes into it.\r\n\t\t\t\t\t\t\t\tif (currentBar != bar || pattern == null) {\r\n\t\t\t\t\t\t\t\t\tcurrentBar++;\r\n\t\t\t\t\t\t\t\t\twhile (currentBar < bar) {\r\n\t\t\t\t\t\t\t\t\t\tchannel.bars[currentBar] = 0;\r\n\t\t\t\t\t\t\t\t\t\tcurrentBar++;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tpattern = new Pattern();\r\n\t\t\t\t\t\t\t\t\tchannel.patterns.push(pattern);\r\n\t\t\t\t\t\t\t\t\tchannel.bars[currentBar] = channel.patterns.length;\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t// If this is the first time a note is trying to use a specific instrument\r\n\t\t\t\t\t\t\t\t\t// program in this channel, create a new BeepBox instrument for it.\r\n\t\t\t\t\t\t\t\t\tif (instrumentByProgram[currentProgram] == undefined) {\r\n\t\t\t\t\t\t\t\t\t\tconst instrument: Instrument = new Instrument(isNoiseChannel, isModChannel);\r\n\t\t\t\t\t\t\t\t\t\tinstrumentByProgram[currentProgram] = instrument;\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tif (presetValue != null && preset != null && (preset.isNoise == true) == isNoiseChannel) {\r\n\t\t\t\t\t\t\t\t\t\t\t\tinstrument.fromJsonObject(preset.settings, isNoiseChannel, isModChannel, false, false, 1);\r\n\t\t\t\t\t\t\t\t\t\t\tinstrument.preset = presetValue;\r\n\t\t\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\t\t\tinstrument.setTypeAndReset(isModChannel ? InstrumentType.mod : (isNoiseChannel ? InstrumentType.noise : InstrumentType.chip), isNoiseChannel, isModChannel);\r\n\t\t\t\t\t\t\t\t\t\t\tinstrument.chord = 0; // Midi instruments use polyphonic harmony by default.\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tinstrument.volume = currentInstrumentVolume;\r\n\t\t\t\t\t\t\t\t\t\tinstrument.pan = currentInstrumentPan;\r\n\t\t\t\t\t\t\t\t\t\tinstrument.panDelay = 0;\r\n\r\n\t\t\t\t\t\t\t\t\t\tchannel.instruments.push(instrument);\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tpattern.instruments[0] = channel.instruments.indexOf(instrumentByProgram[currentProgram]);\r\n\t\t\t\t\t\t\t\t\tpattern.instruments.length = 1;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// Use the loudest volume setting for the instrument, since \r\n\t\t\t\t\t\t\t\t// many midis unfortunately use the instrument volume control to fade\r\n\t\t\t\t\t\t\t\t// in at the beginning and we don't want to get stuck with the initial\r\n\t\t\t\t\t\t\t\t// zero volume.\r\n\t\t\t\t\t\t\t\tif (instrumentByProgram[currentProgram] != undefined) {\r\n\t\t\t\t\t\t\t\t\tinstrumentByProgram[currentProgram].volume = Math.min(instrumentByProgram[currentProgram].volume, currentInstrumentVolume);\r\n\t\t\t\t\t\t\t\t\tinstrumentByProgram[currentProgram].pan = Math.min(instrumentByProgram[currentProgram].pan, currentInstrumentPan);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// Create a new note, and interpret the pitch bend and note size events\r\n\t\t\t\t\t\t\t\t// to determine where we need to insert pins to control interval and size.\r\n\t\t\t\t\t\t\t\tconst note: Note = new Note(-1, noteStartPart, noteEndPart, Config.noteSizeMax, false);\r\n\t\t\t\t\t\t\t\tnote.pins.length = 0;\r\n\t\t\t\t\t\t\t\tnote.continuesLastPattern = (createdNote && noteStartPart == 0);\r\n\t\t\t\t\t\t\t\tcreatedNote = true;\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tupdateCurrentMidiInterval(noteStartMidiTick);\r\n\t\t\t\t\t\t\t\tupdateCurrentMidiNoteSize(noteStartMidiTick);\r\n\t\t\t\t\t\t\t\tconst shiftedHeldPitch: number = heldPitches[0] * midiIntervalScale - channelBasePitch;\r\n\t\t\t\t\t\t\t\tconst initialBeepBoxPitch: number = Math.round((shiftedHeldPitch + currentMidiInterval) / intervalScale);\r\n\t\t\t\t\t\t\t\tconst heldPitchOffset: number = Math.round(currentMidiInterval - channelBasePitch);\r\n\t\t\t\t\t\t\t\tlet firstPin: NotePin = makeNotePin(0, 0, Math.round(currentVelocity * currentMidiNoteSize));\r\n\t\t\t\t\t\t\t\tnote.pins.push(firstPin);\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tinterface PotentialPin {\r\n\t\t\t\t\t\t\t\t\tpart: number;\r\n\t\t\t\t\t\t\t\t\tpitch: number;\r\n\t\t\t\t\t\t\t\t\tsize: number;\r\n\t\t\t\t\t\t\t\t\tkeyPitch: boolean;\r\n\t\t\t\t\t\t\t\t\tkeySize: boolean;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tconst potentialPins: PotentialPin[] = [\r\n\t\t\t\t\t\t\t\t\t{part: 0, pitch: initialBeepBoxPitch, size: firstPin.size, keyPitch: false, keySize: false}\r\n\t\t\t\t\t\t\t\t];\r\n\t\t\t\t\t\t\t\tlet prevPinIndex: number = 0;\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tlet prevPartPitch: number = (shiftedHeldPitch + currentMidiInterval) / intervalScale;\r\n\t\t\t\t\t\t\t\tlet prevPartSize: number = currentVelocity * currentMidiNoteSize;\r\n\t\t\t\t\t\t\t\tfor (let part: number = noteStartPart + 1; part <= noteEndPart; part++) {\r\n\t\t\t\t\t\t\t\t\tconst midiTick: number = Math.max(noteStartMidiTick, Math.min(noteEndMidiTick - 1, Math.round(midiTicksPerPart * (part + barStartPart))));\r\n\t\t\t\t\t\t\t\t\tconst noteRelativePart: number = part - noteStartPart;\r\n\t\t\t\t\t\t\t\t\tconst lastPart: boolean = (part == noteEndPart);\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t// BeepBox can only add pins at whole number intervals and sizes. Detect places where\r\n\t\t\t\t\t\t\t\t\t// the interval or size are at or cross whole numbers, and add these to the list of\r\n\t\t\t\t\t\t\t\t\t// potential places to insert pins.\r\n\t\t\t\t\t\t\t\t\tupdateCurrentMidiInterval(midiTick);\r\n\t\t\t\t\t\t\t\t\tupdateCurrentMidiNoteSize(midiTick);\r\n\t\t\t\t\t\t\t\t\tconst partPitch: number = (currentMidiInterval + shiftedHeldPitch) / intervalScale;\r\n\t\t\t\t\t\t\t\t\tconst partSize: number = currentVelocity * currentMidiNoteSize;\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tconst nearestPitch: number = Math.round(partPitch);\r\n\t\t\t\t\t\t\t\t\tconst pitchIsNearInteger: boolean = Math.abs(partPitch - nearestPitch) < 0.01;\r\n\t\t\t\t\t\t\t\t\tconst pitchCrossedInteger: boolean = (Math.abs(prevPartPitch - Math.round(prevPartPitch)) < 0.01)\r\n\t\t\t\t\t\t\t\t\t\t? Math.abs(partPitch - prevPartPitch) >= 1.0\r\n\t\t\t\t\t\t\t\t\t\t: Math.floor(partPitch) != Math.floor(prevPartPitch);\r\n\t\t\t\t\t\t\t\t\tconst keyPitch: boolean = pitchIsNearInteger || pitchCrossedInteger;\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tconst nearestSize: number = Math.round(partSize);\r\n\t\t\t\t\t\t\t\t\tconst sizeIsNearInteger: boolean = Math.abs(partSize - nearestSize) < 0.01;\r\n\t\t\t\t\t\t\t\t\tconst sizeCrossedInteger: boolean = (Math.abs(prevPartSize - Math.round(prevPartSize)))\r\n\t\t\t\t\t\t\t\t\t\t? Math.abs(partSize - prevPartSize) >= 1.0\r\n\t\t\t\t\t\t\t\t\t\t: Math.floor(partSize) != Math.floor(prevPartSize);\r\n\t\t\t\t\t\t\t\t\tconst keySize: boolean = sizeIsNearInteger || sizeCrossedInteger;\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tprevPartPitch = partPitch;\r\n\t\t\t\t\t\t\t\t\tprevPartSize = partSize;\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tif (keyPitch || keySize || lastPart) {\r\n\t\t\t\t\t\t\t\t\t\tconst currentPin: PotentialPin = {part: noteRelativePart, pitch: nearestPitch, size: nearestSize, keyPitch: keyPitch || lastPart, keySize: keySize || lastPart};\r\n\t\t\t\t\t\t\t\t\t\tconst prevPin: PotentialPin = potentialPins[prevPinIndex];\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t// At all key points in the list of potential pins, check to see if they\r\n\t\t\t\t\t\t\t\t\t\t// continue the recent slope. If not, insert a pin at the corner, where\r\n\t\t\t\t\t\t\t\t\t\t// the recent recorded values deviate the furthest from the slope.\r\n\t\t\t\t\t\t\t\t\t\tlet addPin: boolean = false;\r\n\t\t\t\t\t\t\t\t\t\tlet addPinAtIndex: number = Number.MAX_VALUE;\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tif (currentPin.keyPitch) {\r\n\t\t\t\t\t\t\t\t\t\t\tconst slope: number = (currentPin.pitch - prevPin.pitch) / (currentPin.part - prevPin.part);\r\n\t\t\t\t\t\t\t\t\t\t\tlet furthestIntervalDistance: number = Math.abs(slope); // minimum distance to make a new pin.\r\n\t\t\t\t\t\t\t\t\t\t\tlet addIntervalPin: boolean = false;\r\n\t\t\t\t\t\t\t\t\t\t\tlet addIntervalPinAtIndex: number = Number.MAX_VALUE;\r\n\t\t\t\t\t\t\t\t\t\t\tfor (let potentialIndex: number = prevPinIndex + 1; potentialIndex < potentialPins.length; potentialIndex++) {\r\n\t\t\t\t\t\t\t\t\t\t\t\tconst potentialPin: PotentialPin = potentialPins[potentialIndex];\r\n\t\t\t\t\t\t\t\t\t\t\t\tif (potentialPin.keyPitch) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tconst interpolatedInterval: number = prevPin.pitch + slope * (potentialPin.part - prevPin.part);\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tconst distance: number = Math.abs(interpolatedInterval - potentialPin.pitch);\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tif (furthestIntervalDistance < distance) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfurthestIntervalDistance = distance;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\taddIntervalPin = true;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\taddIntervalPinAtIndex = potentialIndex;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\tif (addIntervalPin) {\r\n\t\t\t\t\t\t\t\t\t\t\t\taddPin = true;\r\n\t\t\t\t\t\t\t\t\t\t\t\taddPinAtIndex = Math.min(addPinAtIndex, addIntervalPinAtIndex);\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tif (currentPin.keySize) {\r\n\t\t\t\t\t\t\t\t\t\t\tconst slope: number = (currentPin.size - prevPin.size) / (currentPin.part - prevPin.part);\r\n\t\t\t\t\t\t\t\t\t\t\tlet furthestSizeDistance: number = Math.abs(slope); // minimum distance to make a new pin.\r\n\t\t\t\t\t\t\t\t\t\t\tlet addSizePin: boolean = false;\r\n\t\t\t\t\t\t\t\t\t\t\tlet addSizePinAtIndex: number = Number.MAX_VALUE;\r\n\t\t\t\t\t\t\t\t\t\t\tfor (let potentialIndex: number = prevPinIndex + 1; potentialIndex < potentialPins.length; potentialIndex++) {\r\n\t\t\t\t\t\t\t\t\t\t\t\tconst potentialPin: PotentialPin = potentialPins[potentialIndex];\r\n\t\t\t\t\t\t\t\t\t\t\t\tif (potentialPin.keySize) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tconst interpolatedSize: number = prevPin.size + slope * (potentialPin.part - prevPin.part);\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tconst distance: number = Math.abs(interpolatedSize - potentialPin.size);\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tif (furthestSizeDistance < distance) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfurthestSizeDistance = distance;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\taddSizePin = true;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\taddSizePinAtIndex = potentialIndex;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\tif (addSizePin) {\r\n\t\t\t\t\t\t\t\t\t\t\t\taddPin = true;\r\n\t\t\t\t\t\t\t\t\t\t\t\taddPinAtIndex = Math.min(addPinAtIndex, addSizePinAtIndex);\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tif (addPin) {\r\n\t\t\t\t\t\t\t\t\t\t\tconst toBePinned: PotentialPin = potentialPins[addPinAtIndex];\r\n\t\t\t\t\t\t\t\t\t\t\tnote.pins.push(makeNotePin(toBePinned.pitch - initialBeepBoxPitch, toBePinned.part, toBePinned.size));\r\n\t\t\t\t\t\t\t\t\t\t\tprevPinIndex = addPinAtIndex;\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tpotentialPins.push(currentPin);\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// And always add a pin at the end of the note.\r\n\t\t\t\t\t\t\t\tconst lastToBePinned: PotentialPin = potentialPins[potentialPins.length - 1];\r\n\t\t\t\t\t\t\t\tnote.pins.push(makeNotePin(lastToBePinned.pitch - initialBeepBoxPitch, lastToBePinned.part, lastToBePinned.size));\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// Use interval range to constrain min/max pitches so no pin is out of bounds.\r\n\t\t\t\t\t\t\t\tlet maxPitch: number = channelMaxPitch;\r\n\t\t\t\t\t\t\t\tlet minPitch: number = 0;\r\n\t\t\t\t\t\t\t\tfor (const notePin of note.pins) {\r\n\t\t\t\t\t\t\t\t\tmaxPitch = Math.min(maxPitch, channelMaxPitch - notePin.interval);\r\n\t\t\t\t\t\t\t\t\tminPitch = Math.min(minPitch, -notePin.interval);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// Build the note chord out of the current pitches, shifted into BeepBox channelBasePitch relative values.\r\n\t\t\t\t\t\t\t\tnote.pitches.length = 0;\r\n\t\t\t\t\t\t\t\tfor (let pitchIndex: number = 0; pitchIndex < Math.min(Config.maxChordSize, heldPitches.length); pitchIndex++) {\r\n\t\t\t\t\t\t\t\t\tlet heldPitch: number = heldPitches[pitchIndex + Math.max(0, heldPitches.length - Config.maxChordSize)] * midiIntervalScale;\r\n\t\t\t\t\t\t\t\t\tif (preset != null && preset.midiSubharmonicOctaves != undefined) {\r\n\t\t\t\t\t\t\t\t\t\theldPitch -= 12 * preset.midiSubharmonicOctaves;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tconst shiftedPitch: number = Math.max(minPitch, Math.min(maxPitch, Math.round((heldPitch + heldPitchOffset) / intervalScale)));\r\n\t\t\t\t\t\t\t\t\tif (note.pitches.indexOf(shiftedPitch) == -1) {\r\n\t\t\t\t\t\t\t\t\t\tnote.pitches.push(shiftedPitch);\r\n\t\t\t\t\t\t\t\t\t\tconst weight: number = note.end - note.start;\r\n\t\t\t\t\t\t\t\t\t\tpitchSum += shiftedPitch * weight;\r\n\t\t\t\t\t\t\t\t\t\tpitchCount += weight;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tpattern.notes.push(note);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t// Process the next midi note event before continuing, updating the list of currently held pitches.\r\n\t\t\t\t\tif (heldPitches.indexOf(noteEvent.pitch) != -1) {\r\n\t\t\t\t\t\theldPitches.splice(heldPitches.indexOf(noteEvent.pitch), 1);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (noteEvent.on) {\r\n\t\t\t\t\t\theldPitches.push(noteEvent.pitch);\r\n\t\t\t\t\t\tcurrentVelocity = noteEvent.velocity;\r\n\t\t\t\t\t\tcurrentProgram = noteEvent.program;\r\n\t\t\t\t\t\tcurrentInstrumentVolume = noteEvent.instrumentVolume;\r\n\t\t\t\t\t\tcurrentInstrumentPan = noteEvent.instrumentPan;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tprevEventMidiTick = nextEventMidiTick;\r\n\t\t\t\t\tprevEventPart = nextEventPart;\r\n\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\tconst averagePitch: number = pitchSum / pitchCount;\r\n\t\t\t\t\tchannel.octave = (isNoiseChannel || isModChannel) ? 0 : Math.max(0, Math.min(Config.pitchOctaves - 1, Math.floor((averagePitch / 12))));\r\n\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\twhile (channel.bars.length < songTotalBars) {\r\n\t\t\t\tchannel.bars.push(0);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\t\r\n\t\t// For better or for worse, BeepBox has a more limited number of channels than Midi.\r\n\t\t// To compensate, try to merge non-overlapping channels.\r\n\t\tfunction compactChannels(channels: Channel[], maxLength: number): void {\r\n\t\t\twhile (channels.length > maxLength) {\r\n\t\t\t\tlet bestChannelIndexA: number = channels.length - 2;\r\n\t\t\t\tlet bestChannelIndexB: number = channels.length - 1;\r\n\t\t\t\tlet fewestConflicts: number = Number.MAX_VALUE;\r\n\t\t\t\tlet fewestGaps: number = Number.MAX_VALUE;\r\n\t\t\t\tfor (let channelIndexA: number = 0; channelIndexA < channels.length - 1; channelIndexA++) {\r\n\t\t\t\t\tfor (let channelIndexB: number = channelIndexA + 1; channelIndexB < channels.length; channelIndexB++) {\r\n\t\t\t\t\t\tconst channelA: Channel = channels[channelIndexA];\r\n\t\t\t\t\t\tconst channelB: Channel = channels[channelIndexB];\r\n\t\t\t\t\t\tlet conflicts: number = 0;\r\n\t\t\t\t\t\tlet gaps: number = 0;\r\n\t\t\t\t\t\tfor (let barIndex: number = 0; barIndex < channelA.bars.length && barIndex < channelB.bars.length; barIndex++) {\r\n\t\t\t\t\t\t\tif (channelA.bars[barIndex] != 0 && channelB.bars[barIndex] != 0) conflicts++;\r\n\t\t\t\t\t\t\tif (channelA.bars[barIndex] == 0 && channelB.bars[barIndex] == 0) gaps++;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (conflicts <= fewestConflicts) {\r\n\t\t\t\t\t\t\tif (conflicts < fewestConflicts || gaps < fewestGaps) {\r\n\t\t\t\t\t\t\t\tbestChannelIndexA = channelIndexA;\r\n\t\t\t\t\t\t\t\tbestChannelIndexB = channelIndexB;\r\n\t\t\t\t\t\t\t\tfewestConflicts = conflicts;\r\n\t\t\t\t\t\t\t\tfewestGaps = gaps;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t// Merge channelB's patterns, instruments, and bars into channelA.\r\n\t\t\t\tconst channelA: Channel = channels[bestChannelIndexA];\r\n\t\t\t\tconst channelB: Channel = channels[bestChannelIndexB];\r\n\t\t\t\tconst channelAInstrumentCount: number = channelA.instruments.length;\r\n\t\t\t\tconst channelAPatternCount: number = channelA.patterns.length;\r\n\t\t\t\tfor (const instrument of channelB.instruments) {\r\n\t\t\t\t\tchannelA.instruments.push(instrument);\r\n\t\t\t\t}\r\n\t\t\t\tfor (const pattern of channelB.patterns) {\r\n\t\t\t\t\tpattern.instruments[0] += channelAInstrumentCount;\r\n\t\t\t\t\tchannelA.patterns.push(pattern);\r\n\t\t\t\t}\r\n\t\t\t\tfor (let barIndex: number = 0; barIndex < channelA.bars.length && barIndex < channelB.bars.length; barIndex++) {\r\n\t\t\t\t\tif (channelA.bars[barIndex] == 0 && channelB.bars[barIndex] != 0) {\r\n\t\t\t\t\t\tchannelA.bars[barIndex] = channelB.bars[barIndex] + channelAPatternCount;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t// Remove channelB.\r\n\t\t\t\tchannels.splice(bestChannelIndexB, 1);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\t\r\n\t\tcompactChannels(pitchChannels, Config.pitchChannelCountMax);\r\n\t\tcompactChannels(noiseChannels, Config.noiseChannelCountMax);\r\n\t\tcompactChannels(modChannels, Config.modChannelCountMax);\r\n\t\t\t\r\n\t\tclass ChangeImportMidi extends ChangeGroup {\r\n\t\t\tconstructor(doc: SongDocument) {\r\n\t\t\t\tsuper();\r\n\t\t\t\tconst song: Song = doc.song;\r\n\t\t\t\tsong.tempo = beatsPerMinute;\r\n\t\t\t\tsong.beatsPerBar = beatsPerBar;\r\n\t\t\t\tsong.key = key;\r\n\t\t\t\tsong.scale = 11;\r\n\t\t\t\tsong.rhythm = 1;\r\n\t\t\t\tsong.layeredInstruments = false;\r\n\t\t\t\tsong.patternInstruments = pitchChannels.some(channel => channel.instruments.length > 1) || noiseChannels.some(channel => channel.instruments.length > 1);\r\n\t\t\t\t\t\r\n\t\t\t\tremoveDuplicatePatterns(pitchChannels);\r\n\t\t\t\tremoveDuplicatePatterns(noiseChannels);\r\n\t\t\t\tremoveDuplicatePatterns(modChannels);\r\n\t\t\t\t\t\r\n\t\t\t\tthis.append(new ChangeReplacePatterns(doc, pitchChannels, noiseChannels, modChannels));\r\n\t\t\t\tsong.loopStart = 0;\r\n\t\t\t\tsong.loopLength = song.barCount;\r\n\t\t\t\tthis._didSomething();\r\n\t\t\t\tdoc.notifier.changed();\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.goBackToStart();\r\n\t\tfor (const channel of this.song.channels) channel.muted = false;\r\n\t\tthis.prompt = null;\r\n\t\tthis.record(new ChangeImportMidi(this), true, true);\r\n\t}\r\n\t\r\n\tpublic toggleDisplayBrowserUrl() {\r\n\t\tconst state: HistoryState = this._getHistoryState()!;\r\n\t\tthis.prefs.displayBrowserUrl = false;\r\n\t\tthis._replaceState(state, this.song.toBase64String());\r\n\t}\r\n\t\t\r\n\tprivate _getHistoryState(): HistoryState | null {\r\n\t\tif (this.prefs.displayBrowserUrl) {\r\n\t\t\treturn window.history.state;\r\n\t\t} else {\r\n\t\t\tconst json: any = JSON.parse(window.sessionStorage.getItem(window.sessionStorage.getItem(\"currentUndoIndex\")!)!);\r\n\t\t\treturn json == null ? null : json.state;\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tprivate _getHash(): string {\r\n\t\tif (this.prefs.displayBrowserUrl) {\r\n\t\t\treturn window.location.hash;\r\n\t\t} else {\r\n\t\t\tconst json: any = JSON.parse(window.sessionStorage.getItem(window.sessionStorage.getItem(\"currentUndoIndex\")!)!);\r\n\t\t\treturn json == null ? \"\" : json.hash;\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tprivate _replaceState(state: HistoryState, hash: string): void {\r\n\t\tif (this.prefs.displayBrowserUrl) {\r\n\t\t\t// window.history.replaceState(state, \"\", \"#\" + hash);\r\n\t\t} else {\r\n\t\t\t// window.sessionStorage.setItem(window.sessionStorage.getItem(\"currentUndoIndex\") || \"0\", JSON.stringify({state, hash}));\r\n\t\t\t// window.history.replaceState(null, \"\", location.pathname);\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tprivate _pushState(state: HistoryState, hash: string): void {\r\n\t\tif (this.prefs.displayBrowserUrl) {\r\n\t\t\t// window.history.pushState(state, \"\", \"#\" + hash);\r\n\t\t} else {\r\n\t\t\tlet currentIndex: number = Number(window.sessionStorage.getItem(\"currentUndoIndex\"));\r\n\t\t\tlet oldestIndex: number = Number(window.sessionStorage.getItem(\"oldestUndoIndex\"));\r\n\t\t\tcurrentIndex = (currentIndex + 1) % SongDocument._maximumUndoHistory;\r\n\t\t\twindow.sessionStorage.setItem(\"currentUndoIndex\", String(currentIndex));\r\n\t\t\twindow.sessionStorage.setItem(\"newestUndoIndex\", String(currentIndex));\r\n\t\t\tif (currentIndex == oldestIndex) {\r\n\t\t\t\toldestIndex = (oldestIndex + 1) % SongDocument._maximumUndoHistory;\r\n\t\t\t\twindow.sessionStorage.setItem(\"oldestUndoIndex\", String(oldestIndex));\r\n\t\t\t}\r\n\t\t\t\twindow.sessionStorage.setItem(String(currentIndex), JSON.stringify({state, hash}));\r\n\t\t\t// window.history.replaceState(null, \"\", location.pathname);\r\n\t\t}\r\n\t\tthis._lastSequenceNumber = state.sequenceNumber;\r\n\t}\r\n\r\n\tpublic hasRedoHistory(): boolean {\r\n\t\treturn this._lastSequenceNumber > this._sequenceNumber;\r\n\t}\t\r\n\t\t\r\n\tprivate _forward(): void {\r\n\t\tif (this.prefs.displayBrowserUrl) {\r\n\t\t\t// window.history.forward();\r\n\t\t} else {\r\n\t\t\tlet currentIndex: number = Number(window.sessionStorage.getItem(\"currentUndoIndex\"));\r\n\t\t\tlet newestIndex: number = Number(window.sessionStorage.getItem(\"newestUndoIndex\"));\r\n\t\t\tif (currentIndex != newestIndex) {\r\n\t\t\t\tcurrentIndex = (currentIndex + 1) % SongDocument._maximumUndoHistory;\r\n\t\t\t\twindow.sessionStorage.setItem(\"currentUndoIndex\", String(currentIndex));\r\n\t\t\t\tsetTimeout(this._whenHistoryStateChanged);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tprivate _back(): void {\r\n\t\tif (this.prefs.displayBrowserUrl) {\r\n\t\t\t// window.history.back();\r\n\t\t} else {\r\n\t\t\tlet currentIndex: number = Number(window.sessionStorage.getItem(\"currentUndoIndex\"));\r\n\t\t\tlet oldestIndex: number = Number(window.sessionStorage.getItem(\"oldestUndoIndex\"));\r\n\t\t\tif (currentIndex != oldestIndex) {\r\n\t\t\t\tcurrentIndex = (currentIndex + SongDocument._maximumUndoHistory - 1) % SongDocument._maximumUndoHistory;\r\n\t\t\t\twindow.sessionStorage.setItem(\"currentUndoIndex\", String(currentIndex));\r\n\t\t\t\tsetTimeout(this._whenHistoryStateChanged);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tprivate _whenHistoryStateChanged = (): void => {\r\n\t\tif (this.synth.recording) {\r\n\t\t\t// Changes to the song while it's recording to could mess up the recording so just abort the recording.\r\n\t\t\tthis.performance.abortRecording();\r\n\t\t}\r\n\t\t\r\n\t\tif (window.history.state == null && window.location.hash != \"\") {\r\n\t\t\t// The user changed the hash directly.\r\n\t\t\tthis._sequenceNumber++;\r\n\t\t\tthis._resetSongRecoveryUid();\r\n\t\t\tconst state: HistoryState = {canUndo: true, sequenceNumber: this._sequenceNumber, bar: this.bar, channel: this.channel, instrument: this.viewedInstrument[this.channel], recoveryUid: this._recoveryUid, prompt: null, selection: this.selection.toJSON()};\r\n\t\t\tnew ChangeSong(this, window.location.hash);\r\n\t\t\tthis.prompt = state.prompt;\r\n\t\t\tif (this.prefs.displayBrowserUrl) {\r\n\t\t\t\tthis._replaceState(state, this.song.toBase64String());\r\n\t\t\t} else {\r\n\t\t\t\tthis._pushState(state, this.song.toBase64String());\r\n\t\t\t}\r\n\t\t\tthis.forgetLastChange();\r\n\t\t\tthis.notifier.notifyWatchers();\r\n\t\t\t// Stop playing, and go to start when pasting new song in.\r\n\t\t\tthis.synth.pause();\r\n\t\t\tthis.synth.goToBar(0);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\t\r\n\t\tconst state: HistoryState | null = this._getHistoryState();\r\n\t\tif (state == null) throw new Error(\"History state is null.\");\r\n\t\t\t\r\n\t\t// Abort if we've already handled the current state. \r\n\t\tif (state.sequenceNumber == this._sequenceNumber) return;\r\n\t\t\t\r\n\t\tthis.bar = state.bar;\r\n\t\tthis.channel = state.channel;\r\n\t\tthis.viewedInstrument[this.channel] = state.instrument;\r\n\t\tthis._sequenceNumber = state.sequenceNumber;\r\n\t\tthis.prompt = state.prompt;\r\n\t\tnew ChangeSong(this, this._getHash());\r\n\t\t\t\r\n\t\tthis._recoveryUid = state.recoveryUid;\r\n\t\tthis.selection.fromJSON(state.selection);\r\n\t\t\t\r\n\t\t//this.barScrollPos = Math.min(this.bar, Math.max(this.bar - (this.trackVisibleBars - 1), this.barScrollPos));\r\n\t\t\t\r\n\t\tthis.forgetLastChange();\r\n\t\tthis.notifier.notifyWatchers();\r\n\t}\r\n\t\t\r\n\tprivate _cleanDocument = (): void => {\r\n\t\tthis.notifier.notifyWatchers();\r\n\t}\r\n\t\r\n\tprivate _validateDocState = (): void => {\r\n\t\tconst channelCount: number = this.song.getChannelCount();\r\n\t\tfor (let i: number = this.recentPatternInstruments.length; i < channelCount; i++) {\r\n\t\t\tthis.recentPatternInstruments[i] = [0];\r\n\t}\r\n\t\tthis.recentPatternInstruments.length = channelCount;\r\n\t\tfor (let i: number = 0; i < channelCount; i++) {\r\n\t\t\tif (i == this.channel) {\r\n\t\t\t\tif (this.song.patternInstruments) {\r\n\t\t\t\t\tconst pattern: Pattern | null = this.song.getPattern(this.channel, this.bar);\r\n\t\t\t\t\tif (pattern != null) {\r\n\t\t\t\t\t\tthis.recentPatternInstruments[i] = pattern.instruments.concat();\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst channel: Channel = this.song.channels[this.channel];\r\n\t\t\t\t\tfor (let j: number = 0; j < channel.instruments.length; j++) {\r\n\t\t\t\t\t\tthis.recentPatternInstruments[i][j] = j;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.recentPatternInstruments[i].length = channel.instruments.length;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tdiscardInvalidPatternInstruments(this.recentPatternInstruments[i], this.song, i);\r\n\t\t}\r\n\r\n\t\tfor (let i: number = this.viewedInstrument.length; i < channelCount; i++) {\r\n\t\t\tthis.viewedInstrument[i] = 0;\r\n\t\t}\r\n\t\tthis.viewedInstrument.length = channelCount;\r\n\t\tfor (let i: number = 0; i < channelCount; i++) {\r\n\t\t\tif (this.song.patternInstruments && !this.song.layeredInstruments && i == this.channel) {\r\n\t\t\t\tconst pattern: Pattern | null = this.song.getPattern(this.channel, this.bar);\r\n\t\t\t\tif (pattern != null) {\r\n\t\t\t\t\tthis.viewedInstrument[i] = pattern.instruments[0];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.viewedInstrument[i] = Math.min(this.viewedInstrument[i] | 0, this.song.channels[i].instruments.length - 1);\r\n\t\t}\r\n\t\t\r\n\t\tconst highlightedPattern: Pattern | null = this.getCurrentPattern();\r\n\t\tif (highlightedPattern != null && this.song.patternInstruments) {\r\n\t\t\tthis.recentPatternInstruments[this.channel] = highlightedPattern.instruments.concat();\r\n\t\t}\r\n\t\t\r\n\t\t// Normalize selection.\r\n\t\t// I'm allowing the doc.bar to drift outside the box selection while playing\r\n\t\t// because it may auto-follow the playhead outside the selection but it would\r\n\t\t// be annoying to lose your selection just because the song is playing.\r\n\t\tif ((!this.synth.playing && (this.bar < this.selection.boxSelectionBar || this.selection.boxSelectionBar + this.selection.boxSelectionWidth <= this.bar)) ||\r\n\t\t\tthis.channel < this.selection.boxSelectionChannel ||\r\n\t\t\tthis.selection.boxSelectionChannel + this.selection.boxSelectionHeight <= this.channel ||\r\n\t\t\tthis.song.barCount < this.selection.boxSelectionBar + this.selection.boxSelectionWidth ||\r\n\t\t\tchannelCount < this.selection.boxSelectionChannel + this.selection.boxSelectionHeight ||\r\n\t\t\t(this.selection.boxSelectionWidth == 1 && this.selection.boxSelectionHeight == 1)) {\r\n\t\t\tthis.selection.resetBoxSelection();\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tprivate _updateHistoryState = (): void => {\r\n\t\tthis._waitingToUpdateState = false;\r\n\t\tlet hash: string;\r\n\t\ttry {\r\n\t\t\t// Ensure that the song is not corrupted before saving it.\r\n\t\t\thash = this.song.toBase64String();\r\n\t\t} catch (error) {\r\n\t\t\twindow.alert(\"Whoops, the song data appears to have been corrupted! Please try to recover the last working version of the song from the \\\"Recover Recent Song...\\\" option in BeepBox's \\\"File\\\" menu.\");\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (this._stateShouldBePushed) this._sequenceNumber++;\r\n\t\tif (this._recordedNewSong) {\r\n\t\t\tthis._resetSongRecoveryUid();\r\n\t\t} else {\r\n\t\t\tthis._recovery.saveVersion(this._recoveryUid, this.song.title, hash);\r\n\t\t}\r\n\t\tlet state: HistoryState = {canUndo: true, sequenceNumber: this._sequenceNumber, bar: this.bar, channel: this.channel, instrument: this.viewedInstrument[this.channel], recoveryUid: this._recoveryUid, prompt: this.prompt, selection: this.selection.toJSON()};\r\n\t\tif (this._stateShouldBePushed) {\r\n\t\t\tthis._pushState(state, hash);\r\n\t\t} else {\r\n\t\t\tthis._replaceState(state, hash);\r\n\t\t}\r\n\t\tthis._stateShouldBePushed = false;\r\n\t\tthis._recordedNewSong = false;\r\n\t}\r\n\t\t\r\n\tpublic record(change: Change, replace: boolean = false, newSong: boolean = false): void {\r\n\t\tif (change.isNoop()) {\r\n\t\t\tthis._recentChange = null;\r\n\t\t\tif (replace) this._back();\r\n\t\t} else {\r\n\t\t\tchange.commit();\r\n\t\t\tthis._recentChange = change;\r\n\t\t\tthis._stateShouldBePushed = this._stateShouldBePushed || !replace;\r\n\t\t\tthis._recordedNewSong = this._recordedNewSong || newSong;\r\n\t\t\tif (!this._waitingToUpdateState) {\r\n\t\t\t\t// Defer updating the url/history until all sequenced changes have\r\n\t\t\t\t// committed and the interface has rendered the latest changes to\r\n\t\t\t\t// improve perceived responsiveness.\r\n\t\t\t\twindow.requestAnimationFrame(this._updateHistoryState);\r\n\t\t\t\tthis._waitingToUpdateState = true;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\t\r\n\tprivate _resetSongRecoveryUid(): void {\r\n\t\tthis._recoveryUid = generateUid();\r\n\t}\r\n\t\t\r\n\tpublic openPrompt(prompt: string): void {\r\n\t\tthis.prompt = prompt;\r\n\t\tconst hash: string = this.song.toBase64String();\r\n\t\tthis._sequenceNumber++;\r\n\t\tconst state = {canUndo: true, sequenceNumber: this._sequenceNumber, bar: this.bar, channel: this.channel, instrument: this.viewedInstrument[this.channel], recoveryUid: this._recoveryUid, prompt: this.prompt, selection: this.selection.toJSON()};\r\n\t\tthis._pushState(state, hash);\r\n\t}\r\n\t\t\r\n\tpublic undo(): void {\r\n\t\tconst state: HistoryState = this._getHistoryState()!;\r\n\t\tif (state.canUndo) this._back();\r\n\t}\r\n\t\t\r\n\tpublic redo(): void {\r\n\t\tthis._forward();\r\n\t}\r\n\t\t\r\n\tpublic setProspectiveChange(change: Change | null): void {\r\n\t\tthis._recentChange = change;\r\n\t}\r\n\t\t\r\n\tpublic forgetLastChange(): void {\r\n\t\tthis._recentChange = null;\r\n\t}\r\n\t\t\r\n\tpublic lastChangeWas(change: Change | null): boolean {\r\n\t\treturn change != null && change == this._recentChange;\r\n\t}\r\n\t\t\r\n\tpublic goBackToStart(): void {\r\n\t\tthis.bar = 0;\r\n\t\tthis.channel = 0;\r\n\t\tthis.barScrollPos = 0;\r\n\t\tthis.channelScrollPos = 0;\r\n\t\tthis.synth.snapToStart();\r\n\t\tthis.notifier.changed();\r\n\t}\r\n\t\r\n\tpublic setVolume(val: number): void {\r\n\t\tthis.prefs.volume = val;\r\n\t\tthis.prefs.save();\r\n\t\tthis.synth.volume = this._calcVolume();\r\n\t}\r\n\t\t\r\n\tprivate _calcVolume(): number {\r\n\t\treturn Math.min(1.0, Math.pow(this.prefs.volume / 50.0, 0.5)) * Math.pow(2.0, (this.prefs.volume - 75.0) / 25.0);\r\n\t}\r\n\t\t\r\n\tpublic getCurrentPattern(barOffset: number = 0): Pattern | null {\r\n\t\treturn this.song.getPattern(this.channel, this.bar + barOffset);\r\n\t}\r\n\t\t\r\n\tpublic getCurrentInstrument(barOffset: number = 0): number {\r\n\t\tif (barOffset == 0) {\r\n\t\t\treturn this.viewedInstrument[this.channel];\r\n\t\t} else {\r\n\t\t\tconst pattern: Pattern | null = this.getCurrentPattern(barOffset);\r\n\t\t\treturn pattern == null ? 0 : pattern.instruments[0];\r\n        }\r\n\t}\r\n\t\t\r\n\tpublic getMobileLayout(): boolean {\r\n\t\treturn (this.prefs.layout == \"wide\") ? window.innerWidth <= 1000 : window.innerWidth <= 710;\r\n\t}\r\n\t\t\r\n\tpublic getBarWidth(): number {\r\n\t\t// Bugfix: In wide fullscreen, the 32 pixel display doesn't work as the trackEditor is still horizontally constrained\r\n\t\treturn (!this.getMobileLayout() && this.prefs.enableChannelMuting && (!this.getFullScreen() || this.prefs.layout == \"wide\")) ? 30 : 32;\r\n\t}\r\n\t\t\r\n\tpublic getChannelHeight(): number {\r\n\t\tconst squashed: boolean = this.getMobileLayout() || this.song.getChannelCount() > 4 || (this.song.barCount > this.trackVisibleBars && this.song.getChannelCount() > 3);\r\n\t\t// TODO: Jummbox widescreen should allow more channels before squashing or megasquashing\r\n\t\tconst megaSquashed: boolean = !this.getMobileLayout() && (((this.prefs.layout != \"wide\") && this.song.getChannelCount() > 11) || this.song.getChannelCount() > 22);\r\n\t\treturn megaSquashed ? 23 : (squashed ? 27 : 32);\r\n\t}\r\n\t\t\r\n\tpublic getFullScreen(): boolean {\r\n\t\treturn !this.getMobileLayout() && (this.prefs.layout != \"small\");\r\n\t}\r\n\t\r\n\tpublic getVisibleOctaveCount(): number {\r\n\t\treturn this.getFullScreen() ? this.prefs.visibleOctaves : Preferences.defaultVisibleOctaves;\r\n}\r\n\t\r\n\tpublic getVisiblePitchCount(): number {\r\n\t\t return this.getVisibleOctaveCount() * Config.pitchesPerOctave + 1;\r\n\t}\r\n\t\r\n\tpublic getBaseVisibleOctave(channel: number): number {\r\n\t\tconst visibleOctaveCount: number = this.getVisibleOctaveCount();\r\n\t\treturn Math.max(0, Math.min(Config.pitchOctaves - visibleOctaveCount, Math.ceil(this.song.channels[channel].octave - visibleOctaveCount * 0.5)));\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport { Dictionary, DictionaryArray, EnvelopeType, InstrumentType, Transition, Chord, Envelope, Config } from \"../synth/SynthConfig\";\r\nimport { isMobile, EditorConfig } from \"./EditorConfig\";\r\nimport { ColorConfig } from \"./ColorConfig\";\r\nimport \"./style\"; // Import for the side effects, there's no exports.\r\nimport {SongEditor} from \"./SongEditor\";\r\nimport {NotePin, Note, Pattern, Instrument, Channel, Song, Synth} from \"../synth/synth\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {ExportPrompt} from \"./ExportPrompt\";\r\nimport {ChangePreset} from \"./changes\";\r\n\r\nconst doc: SongDocument = new SongDocument();\r\nconst editor: SongEditor = new SongEditor(doc);\r\nconst beepboxEditorContainer: HTMLElement = document.getElementById(\"beepboxEditorContainer\")!;\r\nbeepboxEditorContainer.appendChild(editor.mainLayer);\r\neditor.whenUpdated();\r\n\r\n// Fade-in transitions\r\neditor.mainLayer.className += \" load\";\r\neditor.mainLayer.getElementsByClassName(\"pattern-area\")[0].className += \" load\";\r\neditor.mainLayer.getElementsByClassName(\"settings-area\")[0].className += \" load\";\r\neditor.mainLayer.getElementsByClassName(\"editor-song-settings\")[0].className += \" load\";\r\neditor.mainLayer.getElementsByClassName(\"instrument-settings-area\")[0].className += \" load\";\r\neditor.mainLayer.getElementsByClassName(\"trackAndMuteContainer\")[0].className += \" load\";\r\neditor.mainLayer.getElementsByClassName(\"barScrollBar\")[0].className += \" load\";\r\n\r\n// Give select2 class to these\r\n$('#pitchPresetSelect').select2({ dropdownAutoWidth: true });\r\n$('#drumPresetSelect').select2({ dropdownAutoWidth: true });\r\n\r\n// Onclick event to expand/collapse optgroups\r\n$(\"body\").on('click', '.select2-container--open .select2-results__group', function () {\r\n\t$(this).siblings().toggle();\r\n});\r\n\r\n// Open event to collapse all optgroups by default\r\n$(\"#pitchPresetSelect\").on('select2:open', function () {\r\n\t$('.select2-dropdown--below').css('opacity', 0);\r\n\t$('.select2-dropdown').css('opacity', 1);\r\n\t$('#pitchPresetSelect')\r\n\tsetTimeout(() => {\r\n\t\tlet groups = $('.select2-container--open .select2-results__group');\r\n\t\tlet options = $('.select2-container--open .select2-results__option');\r\n\r\n\t\t$.each(groups, (index, v) => {\r\n\t\t\t$(v).siblings().hide();\r\n\t\t\t$(v)[0].setAttribute(\"style\", \"color: \" + ColorConfig.getChannelColor(doc.song, doc.channel).primaryNote + \";\");\r\n\t\t})\r\n\t\t$.each(options, (index, v) => {\r\n\t\t\t$(v)[0].setAttribute(\"style\", \"color: \" + ColorConfig.getChannelColor(doc.song, doc.channel).primaryNote + \";\");\r\n\t\t})\r\n\r\n\t\t$('.select2-dropdown--below').css('opacity', 1);\r\n\t}, 0);\r\n});\r\n\r\n// Open event to collapse all optgroups by default\r\n$(\"#drumPresetSelect\").on('select2:open', function () {\r\n\t$('.select2-dropdown--below').css('opacity', 0);\r\n\t$('.select2-dropdown').css('opacity', 1);\r\n\t$('#drumPresetSelect')\r\n\tsetTimeout(() => {\r\n\t\tlet groups = $('.select2-container--open .select2-results__group');\r\n\t\tlet options = $('.select2-container--open .select2-results__option');\r\n\r\n\t\t$.each(groups, (index, v) => {\r\n\t\t\t$(v).siblings().hide();\r\n\t\t\t$(v)[0].setAttribute(\"style\", \"color: \" + ColorConfig.getChannelColor(doc.song, doc.channel).primaryNote + \";\");\r\n\t\t})\r\n\t\t$.each(options, (index, v) => {\r\n\t\t\t$(v)[0].setAttribute(\"style\", \"color: \" + ColorConfig.getChannelColor(doc.song, doc.channel).primaryNote + \";\");\r\n\t\t})\r\n\r\n\t\t$('.select2-dropdown--below').css('opacity', 1);\r\n\t}, 0);\r\n});\r\n\r\n// Select2 events\r\n// The latter is to ensure select2 doesn't keep focus after the select2 is closed without making a selection.\r\n$('#pitchPresetSelect').on(\"change\", editor._whenSetPitchedPreset);\r\n$('#pitchPresetSelect').on(\"select2:close\", editor._refocus);\r\n\r\n$('#drumPresetSelect').on(\"change\", editor._whenSetDrumPreset);\r\n$('#drumPresetSelect').on(\"select2:close\", editor._refocus);\r\n\r\n\r\neditor.mainLayer.focus();\r\n\r\n// don't autoplay on mobile devices, wait for input.\r\nif (!isMobile && doc.prefs.autoPlay) {\r\n\tfunction autoplay(): void {\r\n\t\tif (!document.hidden) {\r\n\t\t\tdoc.synth.play();\r\n\t\t\teditor.updatePlayButton();\r\n\t\t\twindow.removeEventListener(\"visibilitychange\", autoplay);\r\n\t\t}\r\n\t}\r\n\tif (document.hidden) {\r\n\t\t// Wait until the tab is visible to autoplay:\r\n\t\twindow.addEventListener(\"visibilitychange\", autoplay);\r\n\t} else {\r\n\t\t// Can't call this immediately, as main.ts needs to finish executing for the beepbox namespace to finish being declared.\r\n\t\twindow.setTimeout(autoplay);\r\n\t}\r\n}\r\n\r\n// BeepBox uses browser history state as its own undo history. Browsers typically\r\n// remember scroll position for each history state, but BeepBox users would prefer not \r\n// auto scrolling when undoing. Sadly this tweak doesn't work on Edge or IE.\r\nif (\"scrollRestoration\" in history) history.scrollRestoration = \"manual\";\r\n\r\neditor.updatePlayButton();\r\n\r\nif (\"serviceWorker\" in navigator) {\r\n\t\tnavigator.serviceWorker.register(\"/service_worker.js\", {updateViaCache: \"all\", scope: \"/\"}).catch(() => {});\r\n}\r\n\r\n// When compiling synth.ts as a standalone module named \"beepbox\", expose these classes as members to JavaScript:\r\n\texport {Dictionary, DictionaryArray, EnvelopeType, InstrumentType, Transition, Chord, Envelope, Config, NotePin, Note, Pattern, Instrument, Channel, Song, Synth, ColorConfig, EditorConfig, SongDocument, SongEditor, ExportPrompt, ChangePreset};\r\n"]}